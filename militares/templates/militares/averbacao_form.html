{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Averbação{% endblock %}

{% block extra_css %}
<style>
.select2-container {
    width: 100% !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-file-signature me-2 text-primary"></i>
                        {% if object %}Editar Averbação{% else %}Nova Averbação{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando averbação de {{ object.militar.nome_guerra }}{% else %}Registrar nova averbação{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:averbacao_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar para Lista
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados da Averbação
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.militar.id_for_label }}" class="form-label">
                                            Militar <span class="text-danger">*</span>
                                        </label>
                                        {{ form.militar }}
                                        {% if form.militar.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.militar.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_averbacao.id_for_label }}" class="form-label">
                                            Data da Averbação <span class="text-danger">*</span>
                                        </label>
                                        {{ form.data_averbacao }}
                                        {% if form.data_averbacao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.data_averbacao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="mb-3"><i class="fas fa-clock me-2"></i>Tempo de Contribuição</h6>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tempo_contribuicao_dias.id_for_label }}" class="form-label">
                                            Tempo de Contribuição (TC) em Dias <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tempo_contribuicao_dias }}
                                        {% if form.tempo_contribuicao_dias.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.tempo_contribuicao_dias.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">Digite a quantidade de dias de tempo de contribuição</div>
                                        <div id="tempo-contribuicao-formatado" class="mt-2 p-2 bg-light rounded">
                                            <small><strong>Formatado:</strong> <span id="tc-formatado">-</span></small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.aproveitamento_dias.id_for_label }}" class="form-label">
                                            Aproveitamento do Tempo em Dias <span class="text-danger">*</span>
                                        </label>
                                        {{ form.aproveitamento_dias }}
                                        {% if form.aproveitamento_dias.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.aproveitamento_dias.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">Geralmente igual ao tempo de contribuição</div>
                                        <div id="aproveitamento-formatado" class="mt-2 p-2 bg-light rounded">
                                            <small><strong>Formatado:</strong> <span id="aprov-formatado">-</span></small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="mb-3"><i class="fas fa-file-invoice me-2"></i>Documento CTC/INSS</h6>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_ctc_inss.id_for_label }}" class="form-label">
                                            Número da CTC/INSS <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_ctc_inss }}
                                        {% if form.numero_ctc_inss.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.numero_ctc_inss.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.documento_publicacao.id_for_label }}" class="form-label">
                                            Documento que Publicou a Averbação
                                        </label>
                                        {{ form.documento_publicacao }}
                                        {% if form.documento_publicacao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.documento_publicacao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">Ex: Portaria Nº 123/2024, Boletim Especial Nº 456/2024</div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="mb-3"><i class="fas fa-signature me-2"></i>Assinatura</h6>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.assinado_por_nome.id_for_label }}" class="form-label">
                                            Assinado por (Nome) <span class="text-danger">*</span>
                                        </label>
                                        {{ form.assinado_por_nome }}
                                        {% if form.assinado_por_nome.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.assinado_por_nome.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.assinado_por_cargo.id_for_label }}" class="form-label">
                                            Cargo/Função <span class="text-danger">*</span>
                                        </label>
                                        {{ form.assinado_por_cargo }}
                                        {% if form.assinado_por_cargo.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.assinado_por_cargo.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="mb-3"><i class="fas fa-building me-2"></i>Órgão Local</h6>
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.orgao_local.id_for_label }}" class="form-label">
                                            Órgão Local <span class="text-danger">*</span>
                                        </label>
                                        {{ form.orgao_local }}
                                        {% if form.orgao_local.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.orgao_local.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-8 mb-3">
                                        <label for="{{ form.endereco_orgao.id_for_label }}" class="form-label">
                                            Endereço do Órgão <span class="text-danger">*</span>
                                        </label>
                                        {{ form.endereco_orgao }}
                                        {% if form.endereco_orgao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.endereco_orgao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.cep_orgao.id_for_label }}" class="form-label">
                                            CEP
                                        </label>
                                        {{ form.cep_orgao }}
                                        {% if form.cep_orgao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.cep_orgao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.cidade_estado_orgao.id_for_label }}" class="form-label">
                                            Cidade/Estado <span class="text-danger">*</span>
                                        </label>
                                        {{ form.cidade_estado_orgao }}
                                        {% if form.cidade_estado_orgao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.cidade_estado_orgao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <a href="{% url 'militares:averbacao_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function calcularTempoFormatado() {
    const tcDias = parseInt(document.getElementById('id_tempo_contribuicao_dias').value) || 0;
    const aprovDias = parseInt(document.getElementById('id_aproveitamento_dias').value) || 0;
    
    function formatarTempo(dias) {
        if (dias === 0) return '0 dias';
        
        const anos = Math.floor(dias / 365);
        const diasResto = dias % 365;
        const meses = Math.floor(diasResto / 30);
        const diasFinais = diasResto % 30;
        
        const partes = [];
        if (anos > 0) partes.push(`${anos} ${anos === 1 ? 'ano' : 'anos'}`);
        if (meses > 0) partes.push(`${meses} ${meses === 1 ? 'mês' : 'meses'}`);
        if (diasFinais > 0) partes.push(`${diasFinais} ${diasFinais === 1 ? 'dia' : 'dias'}`);
        
        return partes.length > 0 ? partes.join(', ') : '0 dias';
    }
    
    if (tcDias > 0) {
        document.getElementById('tc-formatado').textContent = formatarTempo(tcDias);
        document.getElementById('tempo-contribuicao-formatado').style.display = 'block';
    } else {
        document.getElementById('tempo-contribuicao-formatado').style.display = 'none';
    }
    
    if (aprovDias > 0) {
        document.getElementById('aprov-formatado').textContent = formatarTempo(aprovDias);
        document.getElementById('aproveitamento-formatado').style.display = 'block';
    } else {
        document.getElementById('aproveitamento-formatado').style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    calcularTempoFormatado();
    
    document.getElementById('id_tempo_contribuicao_dias').addEventListener('input', calcularTempoFormatado);
    document.getElementById('id_aproveitamento_dias').addEventListener('input', calcularTempoFormatado);
    
    // Inicializar Select2 para o campo de militar
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um militar já selecionado (na edição), carregar os dados
        {% if object and object.militar %}
        const militarId = {{ object.militar.id }};
        const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
        if (militarId) {
            const option = new Option(militarText, militarId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
        
        // Se há um militar pré-selecionado via GET (na criação)
        const urlParams = new URLSearchParams(window.location.search);
        const militarIdGet = urlParams.get('militar');
        if (militarIdGet) {
            // Buscar dados do militar via AJAX usando o ID
            $.ajax({
                url: '{% url "militares:militar-autocomplete" %}',
                data: { q: '' },
                dataType: 'json',
                success: function(data) {
                    // Se não encontrou, buscar pelo ID diretamente
                    const militar = data.results.find(m => String(m.id) === String(militarIdGet));
                    if (militar) {
                        const option = new Option(militar.text, militar.id, true, true);
                        $('.militar-select2').append(option).trigger('change');
                    } else {
                        // Tentar buscar pelo ID fazendo uma requisição específica
                        // Isso pode não funcionar se o militar não estiver na lista inicial
                        // Mas o Select2 permitirá selecionar depois
                        $.ajax({
                            url: '{% url "militares:militar-autocomplete" %}',
                            data: { q: militarIdGet },
                            dataType: 'json',
                            success: function(data2) {
                                const militar2 = data2.results.find(m => String(m.id) === String(militarIdGet));
                                if (militar2) {
                                    const option = new Option(militar2.text, militar2.id, true, true);
                                    $('.militar-select2').append(option).trigger('change');
                                }
                            }
                        });
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}

