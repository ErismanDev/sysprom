<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarBemMovelModalLabel">
        <i class="fas fa-box me-2"></i>{{ title|default:"Criar Bem Móvel" }}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formBemMovel" method="post" action="{{ action_url }}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_tombamento.id_for_label }}" class="form-label">
                    {{ form.numero_tombamento.label }} <span class="text-danger">*</span>
                </label>
                {{ form.numero_tombamento }}
                {% if form.numero_tombamento.errors %}
                    <div class="text-danger small">{{ form.numero_tombamento.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.categoria.id_for_label }}" class="form-label">
                    {{ form.categoria.label }} <span class="text-danger">*</span>
                </label>
                {{ form.categoria }}
                {% if form.categoria.errors %}
                    <div class="text-danger small">{{ form.categoria.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.descricao.id_for_label }}" class="form-label">
                {{ form.descricao.label }} <span class="text-danger">*</span>
            </label>
            {{ form.descricao }}
            {% if form.descricao.errors %}
                <div class="text-danger small">{{ form.descricao.errors }}</div>
            {% endif %}
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.marca.id_for_label }}" class="form-label">
                    {{ form.marca.label }}
                </label>
                {{ form.marca }}
                {% if form.marca.errors %}
                    <div class="text-danger small">{{ form.marca.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.modelo.id_for_label }}" class="form-label">
                    {{ form.modelo.label }}
                </label>
                {{ form.modelo }}
                {% if form.modelo.errors %}
                    <div class="text-danger small">{{ form.modelo.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                    {{ form.numero_serie.label }}
                </label>
                {{ form.numero_serie }}
                {% if form.numero_serie.errors %}
                    <div class="text-danger small">{{ form.numero_serie.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.patrimonio.id_for_label }}" class="form-label">
                    {{ form.patrimonio.label }}
                </label>
                {{ form.patrimonio }}
                {% if form.patrimonio.errors %}
                    <div class="text-danger small">{{ form.patrimonio.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.situacao.id_for_label }}" class="form-label">
                    {{ form.situacao.label }}
                </label>
                {{ form.situacao }}
                {% if form.situacao.errors %}
                    <div class="text-danger small">{{ form.situacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.localizacao_detalhada.id_for_label }}" class="form-label">
                {{ form.localizacao_detalhada.label }}
            </label>
            {{ form.localizacao_detalhada }}
            {% if form.localizacao_detalhada.errors %}
                <div class="text-danger small">{{ form.localizacao_detalhada.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Organograma (OM) - Campo único -->
        <div class="mb-3">
            <label for="organograma-select" class="form-label">
                Organização Militar (OM)
            </label>
            <select id="organograma-select" class="form-select" style="width: 100%;">
                <option value="">Selecione uma opção do organograma...</option>
            </select>
            <!-- Campos ocultos para armazenar os valores do organograma -->
            {{ form.orgao.as_hidden }}
            {{ form.grande_comando.as_hidden }}
            {{ form.unidade.as_hidden }}
            {{ form.sub_unidade.as_hidden }}
            <small class="form-text text-muted">Selecione a organização militar</small>
            {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
                <div class="text-danger small">
                    {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
                    {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
                    {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
                    {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.data_aquisicao.id_for_label }}" class="form-label">
                    {{ form.data_aquisicao.label }}
                </label>
                {{ form.data_aquisicao }}
                {% if form.data_aquisicao.errors %}
                    <div class="text-danger small">{{ form.data_aquisicao.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_aquisicao.id_for_label }}" class="form-label">
                    {{ form.valor_aquisicao.label }}
                </label>
                {{ form.valor_aquisicao }}
                {% if form.valor_aquisicao.errors %}
                    <div class="text-danger small">{{ form.valor_aquisicao.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.fornecedor.id_for_label }}" class="form-label">
                    {{ form.fornecedor.label }}
                </label>
                {{ form.fornecedor }}
                {% if form.fornecedor.errors %}
                    <div class="text-danger small">{{ form.fornecedor.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.nota_fiscal.id_for_label }}" class="form-label">
                {{ form.nota_fiscal.label }}
            </label>
            {{ form.nota_fiscal }}
            {% if form.nota_fiscal.errors %}
                <div class="text-danger small">{{ form.nota_fiscal.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                {{ form.observacoes.label }}
            </label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="text-danger small">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-check mb-3">
            {{ form.ativo }}
            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                {{ form.ativo.label }}
            </label>
            {% if form.ativo.errors %}
                <div class="text-danger small">{{ form.ativo.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Funcionalidade de seleção hierárquica única do organograma
    let organogramaSelect = document.getElementById('organograma-select');
    let orgaoHidden = document.getElementById('id_orgao');
    let grandeComandoHidden = document.getElementById('id_grande_comando');
    let unidadeHidden = document.getElementById('id_unidade');
    let subUnidadeHidden = document.getElementById('id_sub_unidade');
    
    // Função para carregar toda a hierarquia do organograma
    async function carregarOrganogramaCompleto() {
        if (!organogramaSelect) return;
        
        try {
            const response = await fetch('{% url "militares:ajax_organograma_completo" %}');
            const data = await response.json();
            
            organogramaSelect.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                organogramaSelect.appendChild(option);
            });
            
            // Selecionar opção atual se estiver editando
            {% if form.instance.pk %}
            selecionarOpcaoAtual();
            {% endif %}
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
        }
    }
    
    // Função para selecionar a opção atual baseada nos valores do objeto
    function selecionarOpcaoAtual() {
        {% if form.instance.pk %}
        const orgaoId = {% if form.instance.orgao %}{{ form.instance.orgao.id }}{% else %}null{% endif %};
        const grandeComandoId = {% if form.instance.grande_comando %}{{ form.instance.grande_comando.id }}{% else %}null{% endif %};
        const unidadeId = {% if form.instance.unidade %}{{ form.instance.unidade.id }}{% else %}null{% endif %};
        const subUnidadeId = {% if form.instance.sub_unidade %}{{ form.instance.sub_unidade.id }}{% else %}null{% endif %};
        
        // Encontrar a opção correspondente
        for (let option of organogramaSelect.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                if (subUnidadeId && valor.sub_unidade_id === subUnidadeId) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (unidadeId && !subUnidadeId && valor.unidade_id === unidadeId && !valor.sub_unidade_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (grandeComandoId && !unidadeId && valor.grande_comando_id === grandeComandoId && !valor.unidade_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (orgaoId && !grandeComandoId && valor.orgao_id === orgaoId && !valor.grande_comando_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                }
            }
        }
        {% endif %}
    }
    
    // Função para atualizar campos ocultos
    function atualizarCamposOcultos() {
        if (!organogramaSelect) return;
        
        const selectedOption = organogramaSelect.options[organogramaSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    // Função para inicializar organograma
    function inicializarOrganograma() {
        organogramaSelect = document.getElementById('organograma-select');
        orgaoHidden = document.getElementById('id_orgao');
        grandeComandoHidden = document.getElementById('id_grande_comando');
        unidadeHidden = document.getElementById('id_unidade');
        subUnidadeHidden = document.getElementById('id_sub_unidade');
        
        if (organogramaSelect && orgaoHidden) {
            organogramaSelect.addEventListener('change', atualizarCamposOcultos);
            carregarOrganogramaCompleto();
            return true;
        }
        return false;
    }
    
    // Tentar inicializar imediatamente
    if (!inicializarOrganograma()) {
        // Se não encontrou, tentar após um pequeno delay (para modais carregados via AJAX)
        setTimeout(() => {
            if (!inicializarOrganograma()) {
                // Última tentativa após mais um delay
                setTimeout(inicializarOrganograma, 200);
            }
        }, 50);
    }
    
    const form = document.getElementById('formBemMovel');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.insertBefore(alertDiv, document.body.firstChild);
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('criarBemMovelModal') || document.getElementById('editarBemMovelModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Recarregar página após 1 segundo
                    setTimeout(() => {
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        } else {
                            window.location.reload();
                        }
                    }, 1000);
                } else {
                    // Atualizar formulário com erros
                    if (data.html) {
                        const modalContent = document.getElementById('criarBemMovelModalContent') || document.getElementById('editarBemMovelModalContent');
                        if (modalContent) {
                            modalContent.innerHTML = data.html;
                        }
                    }
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Erro ao salvar. Tente novamente.');
            });
        });
    }
    
    // Máscara para valor monetário
    const valorInput = document.getElementById('id_valor_aquisicao');
    if (valorInput) {
        valorInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            e.target.value = value;
        });
    }
})();
</script>

