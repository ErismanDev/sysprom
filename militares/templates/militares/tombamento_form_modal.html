<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarTombamentoModalLabel">
        <i class="fas fa-file-alt me-2"></i>{{ title|default:"Registrar Tombamento" }}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formTombamento" method="post" action="{{ action_url }}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.bem_movel.id_for_label }}" class="form-label">
                    {{ form.bem_movel.label }} <span class="text-danger">*</span>
                </label>
                {{ form.bem_movel }}
                {% if form.bem_movel.errors %}
                    <div class="text-danger small">{{ form.bem_movel.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.tipo_tombamento.id_for_label }}" class="form-label">
                    {{ form.tipo_tombamento.label }} <span class="text-danger">*</span>
                </label>
                {{ form.tipo_tombamento }}
                {% if form.tipo_tombamento.errors %}
                    <div class="text-danger small">{{ form.tipo_tombamento.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_tombamento.id_for_label }}" class="form-label">
                    {{ form.data_tombamento.label }} <span class="text-danger">*</span>
                </label>
                {{ form.data_tombamento }}
                {% if form.data_tombamento.errors %}
                    <div class="text-danger small">{{ form.data_tombamento.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <hr>
        <h6 class="mb-3"><i class="fas fa-arrow-left me-2"></i>Origem</h6>
        
        <!-- Organograma Origem (OM) - Campo único -->
        <div class="mb-3">
            <label for="organograma-origem-select" class="form-label">
                Organização Militar (OM) de Origem
            </label>
            <select id="organograma-origem-select" class="form-select" style="width: 100%;">
                <option value="">Selecione uma opção do organograma...</option>
            </select>
            <!-- Campos ocultos para armazenar os valores do organograma -->
            {{ form.orgao_origem.as_hidden }}
            {{ form.grande_comando_origem.as_hidden }}
            {{ form.unidade_origem.as_hidden }}
            {{ form.sub_unidade_origem.as_hidden }}
            <small class="form-text text-muted">Selecione a organização militar de origem</small>
            {% if form.orgao_origem.errors or form.grande_comando_origem.errors or form.unidade_origem.errors or form.sub_unidade_origem.errors %}
                <div class="text-danger small">
                    {% if form.orgao_origem.errors %}{{ form.orgao_origem.errors }}{% endif %}
                    {% if form.grande_comando_origem.errors %}{{ form.grande_comando_origem.errors }}{% endif %}
                    {% if form.unidade_origem.errors %}{{ form.unidade_origem.errors }}{% endif %}
                    {% if form.sub_unidade_origem.errors %}{{ form.sub_unidade_origem.errors }}{% endif %}
                </div>
            {% endif %}
        </div>
        
        <hr>
        <h6 class="mb-3"><i class="fas fa-arrow-right me-2"></i>Destino</h6>
        
        <!-- Organograma Destino (OM) - Campo único -->
        <div class="mb-3">
            <label for="organograma-destino-select" class="form-label">
                Organização Militar (OM) de Destino
            </label>
            <select id="organograma-destino-select" class="form-select" style="width: 100%;">
                <option value="">Selecione uma opção do organograma...</option>
            </select>
            <!-- Campos ocultos para armazenar os valores do organograma -->
            {{ form.orgao_destino.as_hidden }}
            {{ form.grande_comando_destino.as_hidden }}
            {{ form.unidade_destino.as_hidden }}
            {{ form.sub_unidade_destino.as_hidden }}
            <small class="form-text text-muted">Selecione a organização militar de destino</small>
            {% if form.orgao_destino.errors or form.grande_comando_destino.errors or form.unidade_destino.errors or form.sub_unidade_destino.errors %}
                <div class="text-danger small">
                    {% if form.orgao_destino.errors %}{{ form.orgao_destino.errors }}{% endif %}
                    {% if form.grande_comando_destino.errors %}{{ form.grande_comando_destino.errors }}{% endif %}
                    {% if form.unidade_destino.errors %}{{ form.unidade_destino.errors }}{% endif %}
                    {% if form.sub_unidade_destino.errors %}{{ form.sub_unidade_destino.errors }}{% endif %}
                </div>
            {% endif %}
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.valor_atual.id_for_label }}" class="form-label">
                    {{ form.valor_atual.label }}
                </label>
                {{ form.valor_atual }}
                {% if form.valor_atual.errors %}
                    <div class="text-danger small">{{ form.valor_atual.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Para reavaliações</small>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                {{ form.observacoes.label }}
            </label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="text-danger small">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-check mb-3">
            {{ form.ativo }}
            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                {{ form.ativo.label }}
            </label>
            {% if form.ativo.errors %}
                <div class="text-danger small">{{ form.ativo.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Funcionalidade de seleção hierárquica única do organograma - ORIGEM
    let organogramaOrigemSelect = document.getElementById('organograma-origem-select');
    let orgaoOrigemHidden = document.getElementById('id_orgao_origem');
    let grandeComandoOrigemHidden = document.getElementById('id_grande_comando_origem');
    let unidadeOrigemHidden = document.getElementById('id_unidade_origem');
    let subUnidadeOrigemHidden = document.getElementById('id_sub_unidade_origem');
    
    // Funcionalidade de seleção hierárquica única do organograma - DESTINO
    let organogramaDestinoSelect = document.getElementById('organograma-destino-select');
    let orgaoDestinoHidden = document.getElementById('id_orgao_destino');
    let grandeComandoDestinoHidden = document.getElementById('id_grande_comando_destino');
    let unidadeDestinoHidden = document.getElementById('id_unidade_destino');
    let subUnidadeDestinoHidden = document.getElementById('id_sub_unidade_destino');
    
    // Função para carregar toda a hierarquia do organograma
    async function carregarOrganogramaCompleto(selectElement) {
        if (!selectElement) return;
        
        try {
            const response = await fetch('{% url "militares:ajax_organograma_completo" %}');
            const data = await response.json();
            
            selectElement.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                selectElement.appendChild(option);
            });
            
            // Selecionar opção atual se estiver editando (após carregar)
            setTimeout(() => {
                selecionarOpcaoAtual(organogramaOrigemSelect, orgaoOrigemHidden, grandeComandoOrigemHidden, unidadeOrigemHidden, subUnidadeOrigemHidden);
                selecionarOpcaoAtual(organogramaDestinoSelect, orgaoDestinoHidden, grandeComandoDestinoHidden, unidadeDestinoHidden, subUnidadeDestinoHidden);
            }, 100);
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
        }
    }
    
    // Função para selecionar a opção atual baseada nos valores dos campos ocultos
    function selecionarOpcaoAtual(selectElement, orgaoHidden, grandeComandoHidden, unidadeHidden, subUnidadeHidden) {
        if (!selectElement || !orgaoHidden) return;
        
        const orgaoId = orgaoHidden.value ? parseInt(orgaoHidden.value) : null;
        const grandeComandoId = grandeComandoHidden && grandeComandoHidden.value ? parseInt(grandeComandoHidden.value) : null;
        const unidadeId = unidadeHidden && unidadeHidden.value ? parseInt(unidadeHidden.value) : null;
        const subUnidadeId = subUnidadeHidden && subUnidadeHidden.value ? parseInt(subUnidadeHidden.value) : null;
        
        // Encontrar a opção correspondente
        for (let option of selectElement.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                if (subUnidadeId && valor.sub_unidade_id === subUnidadeId) {
                    selectElement.value = option.value;
                    return;
                } else if (unidadeId && !subUnidadeId && valor.unidade_id === unidadeId && !valor.sub_unidade_id) {
                    selectElement.value = option.value;
                    return;
                } else if (grandeComandoId && !unidadeId && valor.grande_comando_id === grandeComandoId && !valor.unidade_id) {
                    selectElement.value = option.value;
                    return;
                } else if (orgaoId && !grandeComandoId && valor.orgao_id === orgaoId && !valor.grande_comando_id) {
                    selectElement.value = option.value;
                    return;
                }
            }
        }
    }
    
    // Função para atualizar campos ocultos
    function atualizarCamposOcultos(selectElement, orgaoHidden, grandeComandoHidden, unidadeHidden, subUnidadeHidden) {
        if (!selectElement) return;
        
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    // Função para inicializar organograma de origem
    function inicializarOrganogramaOrigem() {
        organogramaOrigemSelect = document.getElementById('organograma-origem-select');
        orgaoOrigemHidden = document.getElementById('id_orgao_origem');
        grandeComandoOrigemHidden = document.getElementById('id_grande_comando_origem');
        unidadeOrigemHidden = document.getElementById('id_unidade_origem');
        subUnidadeOrigemHidden = document.getElementById('id_sub_unidade_origem');
        
        if (organogramaOrigemSelect && orgaoOrigemHidden) {
            organogramaOrigemSelect.addEventListener('change', function() {
                atualizarCamposOcultos(organogramaOrigemSelect, orgaoOrigemHidden, grandeComandoOrigemHidden, unidadeOrigemHidden, subUnidadeOrigemHidden);
            });
            carregarOrganogramaCompleto(organogramaOrigemSelect);
            return true;
        }
        return false;
    }
    
    // Função para inicializar organograma de destino
    function inicializarOrganogramaDestino() {
        organogramaDestinoSelect = document.getElementById('organograma-destino-select');
        orgaoDestinoHidden = document.getElementById('id_orgao_destino');
        grandeComandoDestinoHidden = document.getElementById('id_grande_comando_destino');
        unidadeDestinoHidden = document.getElementById('id_unidade_destino');
        subUnidadeDestinoHidden = document.getElementById('id_sub_unidade_destino');
        
        if (organogramaDestinoSelect && orgaoDestinoHidden) {
            organogramaDestinoSelect.addEventListener('change', function() {
                atualizarCamposOcultos(organogramaDestinoSelect, orgaoDestinoHidden, grandeComandoDestinoHidden, unidadeDestinoHidden, subUnidadeDestinoHidden);
            });
            carregarOrganogramaCompleto(organogramaDestinoSelect);
            return true;
        }
        return false;
    }
    
    // Tentar inicializar imediatamente
    if (!inicializarOrganogramaOrigem()) {
        setTimeout(() => {
            if (!inicializarOrganogramaOrigem()) {
                setTimeout(inicializarOrganogramaOrigem, 200);
            }
        }, 50);
    }
    
    if (!inicializarOrganogramaDestino()) {
        setTimeout(() => {
            if (!inicializarOrganogramaDestino()) {
                setTimeout(inicializarOrganogramaDestino, 200);
            }
        }, 50);
    }
    
    const form = document.getElementById('formTombamento');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.insertBefore(alertDiv, document.body.firstChild);
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('criarTombamentoModal') || document.getElementById('editarTombamentoModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    setTimeout(() => {
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        } else {
                            window.location.reload();
                        }
                    }, 1000);
                } else {
                    if (data.html) {
                        const modalContent = document.getElementById('criarTombamentoModalContent') || document.getElementById('editarTombamentoModalContent');
                        if (modalContent) {
                            modalContent.innerHTML = data.html;
                        }
                    }
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Erro ao salvar. Tente novamente.');
            });
        });
    }
    
    // Máscara para valor monetário
    const valorInput = document.getElementById('id_valor_atual');
    if (valorInput) {
        valorInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            e.target.value = value;
        });
    }
})();
</script>

