{% load static %}

<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="{% if curso.pk %}editarCursoModalLabel{{ curso.pk }}{% else %}criarCursoModalLabel{% endif %}">
        <i class="fas fa-{% if curso.pk %}edit{% else %}book-plus{% endif %} me-2"></i>
        {% if curso.pk %}Editar Curso{% else %}Criar Novo Curso{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" enctype="multipart/form-data" id="formCriarCurso" action="{% if curso.pk %}{% url 'militares:ensino_curso_editar' pk=curso.pk %}{% else %}{% url 'militares:ensino_curso_criar' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Identificação Geral -->
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>1. Identificação Geral</h5>
        <div class="row">
            <div class="col-md-8 mb-3">
                <label for="{{ form.nome.id_for_label }}" class="form-label">
                    Nome do Curso <span class="text-danger">*</span>
                </label>
                {{ form.nome }}
                {% if form.nome.errors %}
                    <div class="invalid-feedback d-block">{{ form.nome.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.codigo.id_for_label }}" class="form-label">
                    Código do Curso <span class="text-danger">*</span>
                </label>
                {{ form.codigo }}
                {% if form.codigo.help_text %}
                    <small class="form-text text-muted">{{ form.codigo.help_text }}</small>
                {% endif %}
                {% if form.codigo.errors %}
                    <div class="invalid-feedback d-block">{{ form.codigo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.tipo_curso.id_for_label }}" class="form-label">
                    Tipo de Curso
                </label>
                {{ form.tipo_curso }}
                {% if form.tipo_curso.errors %}
                    <div class="invalid-feedback d-block">{{ form.tipo_curso.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.modalidade.id_for_label }}" class="form-label">
                    Modalidade
                </label>
                {{ form.modalidade }}
                {% if form.modalidade.errors %}
                    <div class="invalid-feedback d-block">{{ form.modalidade.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Descrição e Objetivos -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-bullseye me-2"></i>2. Descrição e Objetivos</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.descricao_resumida.id_for_label }}" class="form-label">
                    Descrição Resumida
                </label>
                {{ form.descricao_resumida }}
                {% if form.descricao_resumida.errors %}
                    <div class="invalid-feedback d-block">{{ form.descricao_resumida.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.finalidade.id_for_label }}" class="form-label">
                    Objetivo Geral / Finalidade <span class="text-danger">*</span>
                </label>
                {{ form.finalidade }}
                {% if form.finalidade.errors %}
                    <div class="invalid-feedback d-block">{{ form.finalidade.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.objetivos_especificos.id_for_label }}" class="form-label">
                    Objetivos Específicos
                </label>
                {{ form.objetivos_especificos }}
                {% if form.objetivos_especificos.errors %}
                    <div class="invalid-feedback d-block">{{ form.objetivos_especificos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.competencias_habilidades.id_for_label }}" class="form-label">
                    Competências e Habilidades Desenvolvidas
                </label>
                {{ form.competencias_habilidades }}
                {% if form.competencias_habilidades.errors %}
                    <div class="invalid-feedback d-block">{{ form.competencias_habilidades.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.publico_alvo.id_for_label }}" class="form-label">
                    Público-Alvo <span class="text-danger">*</span>
                </label>
                {{ form.publico_alvo }}
                {% if form.publico_alvo.help_text %}
                    <small class="form-text text-muted">{{ form.publico_alvo.help_text }}</small>
                {% endif %}
                {% if form.publico_alvo.errors %}
                    <div class="invalid-feedback d-block">{{ form.publico_alvo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Carga Horária -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-clock me-2"></i>3. Carga Horária</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.carga_horaria.id_for_label }}" class="form-label">
                    Carga Horária Total (horas) <span class="text-danger">*</span>
                </label>
                {{ form.carga_horaria }}
                {% if form.carga_horaria.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.carga_horaria_minima_aprovacao.id_for_label }}" class="form-label">
                    Carga Horária Mínima para Aprovação
                </label>
                {{ form.carga_horaria_minima_aprovacao }}
                {% if form.carga_horaria_minima_aprovacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_minima_aprovacao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-2 mb-3">
                <label for="{{ form.horas_teoricas.id_for_label }}" class="form-label">
                    Horas Teóricas
                </label>
                {{ form.horas_teoricas }}
                {% if form.horas_teoricas.errors %}
                    <div class="invalid-feedback d-block">{{ form.horas_teoricas.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-2 mb-3">
                <label for="{{ form.horas_praticas.id_for_label }}" class="form-label">
                    Horas Práticas
                </label>
                {{ form.horas_praticas }}
                {% if form.horas_praticas.errors %}
                    <div class="invalid-feedback d-block">{{ form.horas_praticas.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-2 mb-3">
                <label for="{{ form.horas_complementares.id_for_label }}" class="form-label">
                    Horas Complementares
                </label>
                {{ form.horas_complementares }}
                {% if form.horas_complementares.errors %}
                    <div class="invalid-feedback d-block">{{ form.horas_complementares.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.duracao_prevista_dias.id_for_label }}" class="form-label">
                    Duração Prevista (dias)
                </label>
                {{ form.duracao_prevista_dias }}
                {% if form.duracao_prevista_dias.errors %}
                    <div class="invalid-feedback d-block">{{ form.duracao_prevista_dias.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.duracao_prevista_semanas.id_for_label }}" class="form-label">
                    Duração Prevista (semanas)
                </label>
                {{ form.duracao_prevista_semanas }}
                {% if form.duracao_prevista_semanas.errors %}
                    <div class="invalid-feedback d-block">{{ form.duracao_prevista_semanas.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.duracao_prevista_meses.id_for_label }}" class="form-label">
                    Duração Prevista (meses)
                </label>
                {{ form.duracao_prevista_meses }}
                {% if form.duracao_prevista_meses.errors %}
                    <div class="invalid-feedback d-block">{{ form.duracao_prevista_meses.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Estrutura Curricular -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-list-ul me-2"></i>4. Estrutura Curricular</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    <i class="fas fa-list me-1"></i>Disciplinas Disponíveis
                </label>
                <div class="border rounded p-2 bg-light" style="max-height: 400px; overflow-y: auto;">
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasDisciplinas()">
                            <i class="fas fa-check-double me-1"></i>Selecionar Todas
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodasDisciplinas()">
                            <i class="fas fa-times me-1"></i>Desmarcar Todas
                        </button>
                    </div>
                    <div id="disciplinas-disponiveis">
                        {% for disciplina in form.disciplinas.field.queryset %}
                        <div class="form-check">
                            <input class="form-check-input disciplina-checkbox" type="checkbox" 
                                   value="{{ disciplina.pk }}" id="disc_{{ disciplina.pk }}"
                                   data-disciplina-id="{{ disciplina.pk }}" data-disciplina-nome="{{ disciplina.nome }}">
                            <label class="form-check-label" for="disc_{{ disciplina.pk }}">
                                <strong>{{ disciplina.nome }}</strong>
                                {% if disciplina.codigo %}
                                    <small class="text-muted">({{ disciplina.codigo }})</small>
                                {% endif %}
                            </label>
                        </div>
                        {% empty %}
                        <p class="text-muted mb-0">Nenhuma disciplina cadastrada.</p>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="adicionarDisciplinasSelecionadas()">
                    <i class="fas fa-arrow-right me-1"></i>Adicionar ao Curso
                </button>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    <i class="fas fa-check-square me-1"></i>Disciplinas do Curso
                </label>
                <div class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                    <div id="disciplinas-curso">
                        {% if curso.pk %}
                            {% for disc_curso in curso.disciplinas.all %}
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded disciplina-item-curso" data-disciplina-id="{{ disc_curso.pk }}">
                                <div>
                                    <strong>{{ disc_curso.nome }}</strong>
                                    {% if disc_curso.codigo %}
                                        <small class="text-muted">({{ disc_curso.codigo }})</small>
                                    {% endif %}
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDisciplinaCurso({{ disc_curso.pk }}, this)">
                                    <i class="fas fa-times"></i>
                                </button>
                                <input type="hidden" name="disciplinas" value="{{ disc_curso.pk }}">
                            </div>
                            {% empty %}
                            <p class="text-muted mb-0">Nenhuma disciplina vinculada.</p>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">Nenhuma disciplina vinculada. Selecione disciplinas à esquerda e clique em "Adicionar ao Curso".</p>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Total: <span id="total-disciplinas-curso">{{ curso.disciplinas.count|default:0 }}</span> disciplina(s)
                    </small>
                </div>
            </div>
        </div>
        <!-- Campo hidden para manter compatibilidade com o formulário -->
        <!-- Removido o campo disciplinas do form, pois usamos interface customizada com inputs hidden -->
        {% if form.disciplinas.errors %}
            <div class="invalid-feedback d-block">{{ form.disciplinas.errors }}</div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.matriz_curricular.id_for_label }}" class="form-label">
                    Matriz Curricular (Upload PDF)
                </label>
                {{ form.matriz_curricular }}
                {% if form.matriz_curricular.errors %}
                    <div class="invalid-feedback d-block">{{ form.matriz_curricular.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.sequencia_recomendada.id_for_label }}" class="form-label">
                    Sequência Recomendada das Disciplinas
                </label>
                {{ form.sequencia_recomendada }}
                {% if form.sequencia_recomendada.errors %}
                    <div class="invalid-feedback d-block">{{ form.sequencia_recomendada.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.possibilidade_equivalencia }}
                    <label class="form-check-label" for="{{ form.possibilidade_equivalencia.id_for_label }}">
                        {{ form.possibilidade_equivalencia.label }}
                    </label>
                </div>
                {% if form.possibilidade_equivalencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.possibilidade_equivalencia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Requisitos do Curso -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-clipboard-list me-2"></i>5. Requisitos do Curso</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.requisitos_ingresso.id_for_label }}" class="form-label">
                    Requisitos de Ingresso
                </label>
                {{ form.requisitos_ingresso }}
                {% if form.requisitos_ingresso.errors %}
                    <div class="invalid-feedback d-block">{{ form.requisitos_ingresso.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.idade_minima.id_for_label }}" class="form-label">
                    Idade Mínima
                </label>
                {{ form.idade_minima }}
                {% if form.idade_minima.errors %}
                    <div class="invalid-feedback d-block">{{ form.idade_minima.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.escolaridade_requerida.id_for_label }}" class="form-label">
                    Escolaridade Requerida
                </label>
                {{ form.escolaridade_requerida }}
                {% if form.escolaridade_requerida.errors %}
                    <div class="invalid-feedback d-block">{{ form.escolaridade_requerida.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.posto_graduacao_requerido.id_for_label }}" class="form-label">
                    Posto/Graduação Requerido
                </label>
                {{ form.posto_graduacao_requerido }}
                {% if form.posto_graduacao_requerido.errors %}
                    <div class="invalid-feedback d-block">{{ form.posto_graduacao_requerido.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="form-check">
                    {{ form.atestado_medico_obrigatorio }}
                    <label class="form-check-label" for="{{ form.atestado_medico_obrigatorio.id_for_label }}">
                        Inspeção de Saúde Obrigatória
                    </label>
                </div>
                {% if form.atestado_medico_obrigatorio.errors %}
                    <div class="invalid-feedback d-block">{{ form.atestado_medico_obrigatorio.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-check">
                    {{ form.teste_fisico_obrigatorio }}
                    <label class="form-check-label" for="{{ form.teste_fisico_obrigatorio.id_for_label }}">
                        {{ form.teste_fisico_obrigatorio.label }}
                    </label>
                </div>
                {% if form.teste_fisico_obrigatorio.errors %}
                    <div class="invalid-feedback d-block">{{ form.teste_fisico_obrigatorio.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.documentos_obrigatorios.id_for_label }}" class="form-label">
                    Documentos Obrigatórios
                </label>
                {{ form.documentos_obrigatorios }}
                {% if form.documentos_obrigatorios.errors %}
                    <div class="invalid-feedback d-block">{{ form.documentos_obrigatorios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.uniformes_equipamentos.id_for_label }}" class="form-label">
                    Uniformes e Equipamentos Necessários
                </label>
                {{ form.uniformes_equipamentos }}
                {% if form.uniformes_equipamentos.errors %}
                    <div class="invalid-feedback d-block">{{ form.uniformes_equipamentos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Avaliação do Curso -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-clipboard-check me-2"></i>6. Avaliação do Curso</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.criterios_gerais_avaliacao.id_for_label }}" class="form-label">
                    Critérios Gerais de Avaliação
                </label>
                {{ form.criterios_gerais_avaliacao }}
                {% if form.criterios_gerais_avaliacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.criterios_gerais_avaliacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.formas_avaliacao.id_for_label }}" class="form-label">
                    Formas de Avaliação
                </label>
                {{ form.formas_avaliacao }}
                {% if form.formas_avaliacao.help_text %}
                    <small class="form-text text-muted">{{ form.formas_avaliacao.help_text }}</small>
                {% endif %}
                {% if form.formas_avaliacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.formas_avaliacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.media_minima_aprovacao.id_for_label }}" class="form-label">
                    Média Mínima para Aprovação
                </label>
                {{ form.media_minima_aprovacao }}
                {% if form.media_minima_aprovacao.help_text %}
                    <small class="form-text text-muted">{{ form.media_minima_aprovacao.help_text }}</small>
                {% endif %}
                {% if form.media_minima_aprovacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.media_minima_aprovacao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.percentual_frequencia_minima.id_for_label }}" class="form-label">
                    Percentual Mínimo de Frequência
                </label>
                {{ form.percentual_frequencia_minima }}
                {% if form.percentual_frequencia_minima.help_text %}
                    <small class="form-text text-muted">{{ form.percentual_frequencia_minima.help_text }}</small>
                {% endif %}
                {% if form.percentual_frequencia_minima.errors %}
                    <div class="invalid-feedback d-block">{{ form.percentual_frequencia_minima.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.formacao_notas.id_for_label }}" class="form-label">
                    Formação de Notas (peso por disciplina ou atividades)
                </label>
                {{ form.formacao_notas }}
                {% if form.formacao_notas.errors %}
                    <div class="invalid-feedback d-block">{{ form.formacao_notas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Certificação -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-certificate me-2"></i>7. Certificação</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.tipo_certificado.id_for_label }}" class="form-label">
                    Tipo de Certificado
                </label>
                {{ form.tipo_certificado }}
                {% if form.tipo_certificado.errors %}
                    <div class="invalid-feedback d-block">{{ form.tipo_certificado.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.carga_horaria_certificada.id_for_label }}" class="form-label">
                    Carga Horária Certificada
                </label>
                {{ form.carga_horaria_certificada }}
                {% if form.carga_horaria_certificada.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_certificada.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Materiais e Recursos -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-toolbox me-2"></i>8. Materiais e Recursos</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.apostilas_pdfs.id_for_label }}" class="form-label">
                    Apostilas / PDFs
                </label>
                {{ form.apostilas_pdfs }}
                {% if form.apostilas_pdfs.errors %}
                    <div class="invalid-feedback d-block">{{ form.apostilas_pdfs.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.manuais.id_for_label }}" class="form-label">
                    Manuais
                </label>
                {{ form.manuais }}
                {% if form.manuais.errors %}
                    <div class="invalid-feedback d-block">{{ form.manuais.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.equipamentos_necessarios.id_for_label }}" class="form-label">
                    Equipamentos Necessários
                </label>
                {{ form.equipamentos_necessarios }}
                {% if form.equipamentos_necessarios.errors %}
                    <div class="invalid-feedback d-block">{{ form.equipamentos_necessarios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.local_realizacao.id_for_label }}" class="form-label">
                    Local de Realização
                </label>
                {{ form.local_realizacao }}
                {% if form.local_realizacao.help_text %}
                    <small class="form-text text-muted">{{ form.local_realizacao.help_text }}</small>
                {% endif %}
                {% if form.local_realizacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.local_realizacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Segurança e Procedimentos Operacionais -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-shield-alt me-2"></i>9. Segurança e Procedimentos Operacionais</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.normas_seguranca.id_for_label }}" class="form-label">
                    Normas de Segurança Aplicáveis ao Curso
                </label>
                {{ form.normas_seguranca }}
                {% if form.normas_seguranca.errors %}
                    <div class="invalid-feedback d-block">{{ form.normas_seguranca.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.riscos_envolvidos.id_for_label }}" class="form-label">
                    Riscos Envolvidos
                </label>
                {{ form.riscos_envolvidos }}
                {% if form.riscos_envolvidos.errors %}
                    <div class="invalid-feedback d-block">{{ form.riscos_envolvidos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.procedimentos_emergencia.id_for_label }}" class="form-label">
                    Procedimentos de Emergência
                </label>
                {{ form.procedimentos_emergencia }}
                {% if form.procedimentos_emergencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.procedimentos_emergencia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.epis_necessarios.id_for_label }}" class="form-label">
                    EPIs Necessários
                </label>
                {{ form.epis_necessarios }}
                {% if form.epis_necessarios.errors %}
                    <div class="invalid-feedback d-block">{{ form.epis_necessarios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.planos_contingencia.id_for_label }}" class="form-label">
                    Planos de Contingência
                </label>
                {{ form.planos_contingencia }}
                {% if form.planos_contingencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.planos_contingencia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Informações Administrativas Extras -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-cog me-2"></i>10. Informações Administrativas Extras</h5>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Status do Curso
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.historico_versoes.id_for_label }}" class="form-label">
                    Histórico de Versões
                </label>
                {{ form.historico_versoes }}
                {% if form.historico_versoes.errors %}
                    <div class="invalid-feedback d-block">{{ form.historico_versoes.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes_internas.id_for_label }}" class="form-label">
                    Observações Internas
                </label>
                {{ form.observacoes_internas }}
                {% if form.observacoes_internas.errors %}
                    <div class="invalid-feedback d-block">{{ form.observacoes_internas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.legislacao.id_for_label }}" class="form-label">
                    Legislação e Normas Internas
                </label>
                {{ form.legislacao }}
                {% if form.legislacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.legislacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    Ementa (Upload Múltiplos Arquivos)
                </label>
                <div id="ementa-container">
                    <div class="documento-item mb-2">
                        <input type="file" name="ementa[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarEmenta()">
                    <i class="fas fa-plus me-1"></i>Adicionar Arquivo
                </button>
                {% if curso.pk %}
                <div class="mt-2">
                    {% if ementas_existentes %}
                    <small class="text-muted d-block mb-1">Ementas existentes:</small>
                    <ul class="list-unstyled mb-0">
                        {% for doc in ementas_existentes %}
                        <li class="mb-1">
                            <a href="{{ doc.arquivo.url }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-file-pdf text-danger me-1"></i>{{ doc.titulo }}
                            </a>
                            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="removerDocumentoCurso({{ doc.id }}, this)" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% elif curso.ementa %}
                    <small class="text-muted">Arquivo atual: <a href="{{ curso.ementa.url }}" target="_blank">{{ curso.ementa.name }}</a></small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    Plano de Curso (Upload Múltiplos Arquivos)
                </label>
                <div id="plano-container">
                    <div class="documento-item mb-2">
                        <input type="file" name="plano_curso[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarPlano()">
                    <i class="fas fa-plus me-1"></i>Adicionar Arquivo
                </button>
                {% if curso.pk %}
                <div class="mt-2">
                    {% if planos_existentes %}
                    <small class="text-muted d-block mb-1">Planos de curso existentes:</small>
                    <ul class="list-unstyled mb-0">
                        {% for doc in planos_existentes %}
                        <li class="mb-1">
                            <a href="{{ doc.arquivo.url }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-file-pdf text-danger me-1"></i>{{ doc.titulo }}
                            </a>
                            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="removerDocumentoCurso({{ doc.id }}, this)" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% elif curso.plano_curso %}
                    <small class="text-muted">Arquivo atual: <a href="{{ curso.plano_curso.url }}" target="_blank">{{ curso.plano_curso.name }}</a></small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3 form-check">
            {{ form.ativo }}
            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                Curso ativo
            </label>
        </div>
        
        <!-- Extras Avançados -->
        <hr class="my-4">
        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-star me-2"></i>11. Extras Avançados</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">
                    Plano Pedagógico Completo (Upload Múltiplos Arquivos)
                </label>
                <div id="plano-pedagogico-container">
                    <div class="documento-item mb-2">
                        <input type="file" name="plano_pedagogico[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarPlanoPedagogico()">
                    <i class="fas fa-plus me-1"></i>Adicionar Arquivo
                </button>
                {% if curso.pk %}
                <div class="mt-2">
                    {% if planos_pedagogicos_existentes %}
                    <small class="text-muted d-block mb-1">Planos pedagógicos existentes:</small>
                    <ul class="list-unstyled mb-0">
                        {% for doc in planos_pedagogicos_existentes %}
                        <li class="mb-1">
                            <a href="{{ doc.arquivo.url }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-file-pdf text-danger me-1"></i>{{ doc.titulo }}
                            </a>
                            <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="removerDocumentoCurso({{ doc.id }}, this)" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% elif curso.plano_pedagogico %}
                    <small class="text-muted">Arquivo atual: <a href="{{ curso.plano_pedagogico.url }}" target="_blank">{{ curso.plano_pedagogico.name }}</a></small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.carga_horaria_por_instrutor.id_for_label }}" class="form-label">
                    Carga Horária por Instrutor
                </label>
                {{ form.carga_horaria_por_instrutor }}
                {% if form.carga_horaria_por_instrutor.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_por_instrutor.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.checklist_equipamentos_aluno.id_for_label }}" class="form-label">
                    Checklist de Equipamentos por Aluno
                </label>
                {{ form.checklist_equipamentos_aluno }}
                {% if form.checklist_equipamentos_aluno.errors %}
                    <div class="invalid-feedback d-block">{{ form.checklist_equipamentos_aluno.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Documentos -->
        <hr>
        <h5 class="mb-3 border-bottom pb-2 mt-4">
            <i class="fas fa-file-alt me-2"></i>Documentos
        </h5>
        <div class="mb-3">
            <label class="form-label">Upload de Documentos</label>
            <div id="documentos-container-curso">
                <div class="documento-item mb-2">
                    <div class="row">
                        <div class="col-md-3">
                            <select name="tipos_documentos[]" class="form-control form-control-sm">
                                <option value="CERTIFICADO">Certificado</option>
                                <option value="DIPLOMA">Diploma</option>
                                <option value="HABILITACAO">Habilitação</option>
                                <option value="COMPROVANTE">Comprovante</option>
                                <option value="CONTRATO">Contrato</option>
                                <option value="PORTARIA">Portaria</option>
                                <option value="DECRETO">Decreto</option>
                                <option value="LEGISLACAO">Legislação</option>
                                <option value="PLANO_CURSO">Plano de Curso</option>
                                <option value="MATERIAL_DIDATICO">Material Didático</option>
                                <option value="OUTROS" selected>Outros</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <input type="text" name="titulos_documentos[]" class="form-control form-control-sm" placeholder="Título do documento">
                        </div>
                        <div class="col-md-4">
                            <input type="file" name="documentos[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarDocumentoCurso()">
                <i class="fas fa-plus me-1"></i>Adicionar Documento
            </button>
        </div>
        
        {% if curso.pk %}
        <div class="mb-3">
            <label class="form-label">Documentos Existentes</label>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Título</th>
                            <th>Data Upload</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in curso.documentos.all %}
                        <tr>
                            <td>{{ doc.get_tipo_display }}</td>
                            <td>{{ doc.titulo }}</td>
                            <td>{{ doc.data_upload|date:"d/m/Y H:i" }}</td>
                            <td>
                                <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-info" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removerDocumentoCurso({{ doc.pk }}, this)" title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">Nenhum documento cadastrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <div id="criarCursoErrors" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="criarCursoErrorMessage"></span>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>{% if curso.pk %}Atualizar Curso{% else %}Salvar Curso{% endif %}
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Variáveis globais para URLs e estado
    var isEditing = {% if curso.pk %}true{% else %}false{% endif %};
    var urlCursosListar = '{% url "militares:ensino_cursos_listar" %}';
    
    // Cálculo automático de semanas e meses baseado em dias
    const diasInput = document.getElementById('id_duracao_prevista_dias');
    const semanasInput = document.getElementById('id_duracao_prevista_semanas');
    const mesesInput = document.getElementById('id_duracao_prevista_meses');
    
    if (diasInput && semanasInput && mesesInput) {
        diasInput.addEventListener('input', function() {
            const dias = parseFloat(this.value) || 0;
            if (dias > 0) {
                // Calcular semanas (7 dias por semana) - apenas 2 dígitos antes da vírgula
                const semanas = (dias / 7);
                const semanasFormatado = Math.round(semanas * 100) / 100;
                semanasInput.value = semanasFormatado.toFixed(2);
                
                // Calcular meses (30 dias por mês) - apenas 2 dígitos antes da vírgula
                const meses = (dias / 30);
                const mesesFormatado = Math.round(meses * 100) / 100;
                mesesInput.value = mesesFormatado.toFixed(2);
            } else {
                semanasInput.value = '';
                mesesInput.value = '';
            }
        });
    }
    
    // Submissão do formulário via AJAX
    const form = document.getElementById('formCriarCurso');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validar e garantir inputs hidden de disciplinas
            validarDisciplinasAntesSubmit();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            // Limpar mensagens de erro anteriores
            const errorDiv = document.getElementById('criarCursoErrors');
            const errorMessage = document.getElementById('criarCursoErrorMessage');
            if (errorDiv) errorDiv.classList.add('d-none');
            
            // Usar o action do formulário diretamente
            const formAction = form.getAttribute('action');
            if (!formAction) {
                console.error('Formulário sem action definido');
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                if (errorDiv && errorMessage) {
                    errorMessage.textContent = 'Erro: URL do formulário não definida.';
                    errorDiv.classList.remove('d-none');
                }
                return;
            }
            
            fetch(formAction, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(function(response) {
                // Verificar se a resposta é JSON
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    if (!response.ok) {
                        // Tentar parsear JSON mesmo em caso de erro
                        return response.json().then(function(data) {
                            throw new Error(data.error || data.message || 'Erro ao processar requisição');
                        }).catch(function(err) {
                            if (err.message && err.message !== 'Unexpected end of JSON input') {
                                throw err;
                            }
                            throw new Error('Erro ao processar requisição');
                        });
                    }
                    return response.json();
                } else {
                    // Se não for JSON, pode ser HTML (formulário com erros ou erro do servidor)
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            throw new Error('Erro no servidor. Verifique os logs.');
                        });
                    }
                    // Se for HTML e OK, é o formulário com erros de validação
                    // Atualizar o modal com o formulário retornado
                    return response.text().then(function(html) {
                        // Substituir o conteúdo do modal com o novo HTML
                        const modalBody = document.querySelector('.modal-body');
                        if (modalBody) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const newBody = doc.querySelector('.modal-body');
                            if (newBody) {
                                modalBody.innerHTML = newBody.innerHTML;
                                // Re-executar scripts se necessário
                                const scripts = newBody.querySelectorAll('script');
                                scripts.forEach(function(oldScript) {
                                    const newScript = document.createElement('script');
                                    Array.from(oldScript.attributes).forEach(function(attr) {
                                        newScript.setAttribute(attr.name, attr.value);
                                    });
                                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                                    if (oldScript.parentNode) {
                                        oldScript.parentNode.replaceChild(newScript, oldScript);
                                    }
                                });
                            }
                        }
                        // Retornar um objeto que indica que não é sucesso
                        return { success: false, isHtml: true };
                    });
                }
            })
            .then(function(data) {
                if (data && data.success) {
                    // Sucesso - redirecionar ou recarregar página
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        // Se estiver editando, recarregar a página atual
                        if (isEditing) {
                            window.location.reload();
                        } else {
                            window.location.href = urlCursosListar;
                        }
                    }
                } else if (data && data.isHtml) {
                    // Formulário com erros foi atualizado no DOM
                    // Apenas reabilitar o botão
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    // Scroll para o topo do formulário para ver os erros
                    const modalBody = document.querySelector('.modal-body');
                    if (modalBody) {
                        modalBody.scrollTop = 0;
                    }
                } else {
                    // Erro - mostrar mensagens
                    var errorMsg = (data && (data.error || data.message)) || 'Erro ao salvar curso';
                    
                    // Se houver erros de validação, adicionar detalhes
                    if (data && data.errors) {
                        var errorsList = [];
                        for (var field in data.errors) {
                            if (data.errors.hasOwnProperty(field)) {
                                var fieldErrors = Array.isArray(data.errors[field]) 
                                    ? data.errors[field].join(', ') 
                                    : String(data.errors[field]);
                                errorsList.push(field + ': ' + fieldErrors);
                            }
                        }
                        if (errorsList.length > 0) {
                            errorMsg += '\n' + errorsList.join('\n');
                        }
                    }
                    
                    if (errorDiv && errorMessage) {
                        errorMessage.textContent = errorMsg;
                        errorDiv.classList.remove('d-none');
                        // Scroll para o erro
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            })
            .catch(function(error) {
                console.error('Erro completo:', error);
                var errorMsg = 'Erro ao processar formulário.';
                
                if (error.message) {
                    if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                        errorMsg = 'Erro de conexão. Verifique sua internet e tente novamente.';
                    } else {
                        errorMsg = error.message;
                    }
                } else {
                    errorMsg = 'Erro ao processar formulário. Verifique os campos obrigatórios.';
                }
                
                if (errorDiv && errorMessage) {
                    errorMessage.textContent = errorMsg;
                    errorDiv.classList.remove('d-none');
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert(errorMsg);
                }
                
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        });
    }
    
    // Função para adicionar novo campo de documento
    window.adicionarDocumentoCurso = function() {
        const container = document.getElementById('documentos-container-curso');
        const novoItem = document.createElement('div');
        novoItem.className = 'documento-item mb-2';
        novoItem.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <select name="tipos_documentos[]" class="form-control form-control-sm">
                        <option value="CERTIFICADO">Certificado</option>
                        <option value="DIPLOMA">Diploma</option>
                        <option value="HABILITACAO">Habilitação</option>
                        <option value="COMPROVANTE">Comprovante</option>
                        <option value="CONTRATO">Contrato</option>
                        <option value="PORTARIA">Portaria</option>
                        <option value="DECRETO">Decreto</option>
                        <option value="LEGISLACAO">Legislação</option>
                        <option value="PLANO_CURSO">Plano de Curso</option>
                        <option value="MATERIAL_DIDATICO">Material Didático</option>
                        <option value="OUTROS" selected>Outros</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <input type="text" name="titulos_documentos[]" class="form-control form-control-sm" placeholder="Título do documento">
                </div>
                <div class="col-md-3">
                    <input type="file" name="documentos[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.documento-item').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    // Função para remover documento existente
    window.removerDocumentoCurso = function(docId, elementoBtn) {
        if (confirm('Tem certeza que deseja remover este documento?')) {
            const form = document.getElementById('formCriarCurso');
            if (form) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'documentos_remover[]';
                input.value = docId;
                form.appendChild(input);
                // Remover visualmente (pode ser li ou tr)
                const elemento = elementoBtn.closest('li') || elementoBtn.closest('tr');
                if (elemento) {
                    elemento.remove();
                }
            }
        }
    };
    
    // Função para adicionar novo campo de ementa
    window.adicionarEmenta = function() {
        const container = document.getElementById('ementa-container');
        const novoItem = document.createElement('div');
        novoItem.className = 'documento-item mb-2';
        novoItem.innerHTML = `
            <div class="input-group">
                <input type="file" name="ementa[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.documento-item').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    // Função para adicionar novo campo de plano
    window.adicionarPlano = function() {
        const container = document.getElementById('plano-container');
        const novoItem = document.createElement('div');
        novoItem.className = 'documento-item mb-2';
        novoItem.innerHTML = `
            <div class="input-group">
                <input type="file" name="plano_curso[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.documento-item').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    // Função para adicionar novo campo de plano pedagógico
    window.adicionarPlanoPedagogico = function() {
        const container = document.getElementById('plano-pedagogico-container');
        const novoItem = document.createElement('div');
        novoItem.className = 'documento-item mb-2';
        novoItem.innerHTML = `
            <div class="input-group">
                <input type="file" name="plano_pedagogico[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.documento-item').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    // Funções para gerenciar disciplinas
    window.selecionarTodasDisciplinas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox');
        checkboxes.forEach(function(checkbox) {
            // Só marcar se a disciplina não estiver já no curso
            const disciplinaId = checkbox.getAttribute('data-disciplina-id');
            const jaNoCurso = document.querySelector('.disciplina-item-curso[data-disciplina-id="' + disciplinaId + '"]');
            if (!jaNoCurso) {
                checkbox.checked = true;
            }
        });
    };
    
    window.desmarcarTodasDisciplinas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    };
    
    window.adicionarDisciplinasSelecionadas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox:checked');
        const containerCurso = document.getElementById('disciplinas-curso');
        
        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos uma disciplina.');
            return;
        }
        
        checkboxes.forEach(function(checkbox) {
            const disciplinaId = checkbox.getAttribute('data-disciplina-id');
            const disciplinaNome = checkbox.getAttribute('data-disciplina-nome');
            const disciplinaCodigo = checkbox.closest('.form-check').querySelector('small') ? 
                checkbox.closest('.form-check').querySelector('small').textContent : '';
            
            // Verificar se já não está no curso
            const jaExiste = containerCurso.querySelector('.disciplina-item-curso[data-disciplina-id="' + disciplinaId + '"]');
            if (jaExiste) {
                return; // Pular se já existe
            }
            
            // Remover mensagem de vazio se existir
            const msgVazio = containerCurso.querySelector('p.text-muted');
            if (msgVazio && msgVazio.textContent.includes('Nenhuma disciplina')) {
                msgVazio.remove();
            }
            
            // Criar item no curso
            const novoItem = document.createElement('div');
            novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded disciplina-item-curso';
            novoItem.setAttribute('data-disciplina-id', disciplinaId);
            novoItem.innerHTML = `
                <div>
                    <strong>${disciplinaNome}</strong>
                    ${disciplinaCodigo ? '<small class="text-muted">' + disciplinaCodigo + '</small>' : ''}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDisciplinaCurso(${disciplinaId}, this)">
                    <i class="fas fa-times"></i>
                </button>
                <input type="hidden" name="disciplinas" value="${disciplinaId}">
            `;
            containerCurso.appendChild(novoItem);
            
            // Desmarcar e desabilitar checkbox
            checkbox.checked = false;
            checkbox.disabled = true;
            checkbox.closest('.form-check').style.opacity = '0.5';
        });
        
        // Atualizar contador
        atualizarContadorDisciplinas();
    };
    
    // Garantir que todas as disciplinas do curso tenham inputs hidden antes do submit
    window.validarDisciplinasAntesSubmit = function() {
        const containerCurso = document.getElementById('disciplinas-curso');
        const itemsDisciplinas = containerCurso.querySelectorAll('.disciplina-item-curso');
        
        // Verificar se cada item tem um input hidden
        itemsDisciplinas.forEach(function(item) {
            const disciplinaId = item.getAttribute('data-disciplina-id');
            let inputHidden = item.querySelector('input[name="disciplinas"]');
            
            if (!inputHidden) {
                // Criar input hidden se não existir
                inputHidden = document.createElement('input');
                inputHidden.type = 'hidden';
                inputHidden.name = 'disciplinas';
                inputHidden.value = disciplinaId;
                item.appendChild(inputHidden);
            }
        });
        
        return true;
    };
    
    window.removerDisciplinaCurso = function(disciplinaId, botao) {
        if (confirm('Tem certeza que deseja remover esta disciplina do curso?')) {
            const item = botao.closest('.disciplina-item-curso');
            if (item) {
                item.remove();
                
                // Reabilitar checkbox correspondente
                const checkbox = document.querySelector('.disciplina-checkbox[data-disciplina-id="' + disciplinaId + '"]');
                if (checkbox) {
                    checkbox.disabled = false;
                    checkbox.checked = false;
                    checkbox.closest('.form-check').style.opacity = '1';
                }
                
                // Se não houver mais disciplinas, mostrar mensagem
                const containerCurso = document.getElementById('disciplinas-curso');
                if (containerCurso.querySelectorAll('.disciplina-item-curso').length === 0) {
                    containerCurso.innerHTML = '<p class="text-muted mb-0">Nenhuma disciplina vinculada. Selecione disciplinas à esquerda e clique em "Adicionar ao Curso".</p>';
                }
                
                // Atualizar contador
                atualizarContadorDisciplinas();
            }
        }
    };
    
    function atualizarContadorDisciplinas() {
        const total = document.querySelectorAll('.disciplina-item-curso').length;
        const contador = document.getElementById('total-disciplinas-curso');
        if (contador) {
            contador.textContent = total;
        }
    }
    
    // Inicializar ao carregar (se o DOM já estiver pronto)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarDisciplinas);
    } else {
        inicializarDisciplinas();
    }
    
    function inicializarDisciplinas() {
        atualizarContadorDisciplinas();
        
        // Marcar checkboxes das disciplinas que já estão no curso (se estiver editando)
        const disciplinasNoCurso = document.querySelectorAll('.disciplina-item-curso');
        disciplinasNoCurso.forEach(function(item) {
            const disciplinaId = item.getAttribute('data-disciplina-id');
            const checkbox = document.querySelector('.disciplina-checkbox[data-disciplina-id="' + disciplinaId + '"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.closest('.form-check').style.opacity = '0.5';
            }
        });
    }
    
    // Adicionar classes Bootstrap aos campos do formulário
    function adicionarClassesBootstrap() {
        // Adicionar form-control aos inputs de texto, email, number, etc.
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="url"]');
        inputs.forEach(input => {
            if (!input.classList.contains('form-control')) {
                input.classList.add('form-control');
            }
        });
        
        // Adicionar form-select aos selects
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            if (!select.classList.contains('form-select') && !select.classList.contains('form-control')) {
                select.classList.add('form-select');
            }
        });
        
        // Adicionar form-control aos textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            if (!textarea.classList.contains('form-control')) {
                textarea.classList.add('form-control');
            }
        });
        
        // Adicionar form-check-input aos checkboxes e radios
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:not(.form-check-input)');
        checkboxes.forEach(checkbox => {
            checkbox.classList.add('form-check-input');
        });
        
        const radios = document.querySelectorAll('input[type="radio"]:not(.form-check-input)');
        radios.forEach(radio => {
            radio.classList.add('form-check-input');
        });
    }
    
    // Executar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', adicionarClassesBootstrap);
    } else {
        adicionarClassesBootstrap();
    }
    
    // Executar após um pequeno delay para garantir que todos os campos foram renderizados
    setTimeout(adicionarClassesBootstrap, 100);
})();
</script>
