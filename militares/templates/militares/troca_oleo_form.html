{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Troca de Óleo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-oil-can me-2 text-primary"></i>
                        {% if object %}Editar Troca de Óleo{% else %}Nova Troca de Óleo{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando troca de óleo da viatura {{ object.viatura.placa }}{% else %}Registrar nova troca de óleo{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:troca_oleo_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Informações da Troca de Óleo
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" id="trocaOleoForm">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.viatura.id_for_label }}" class="form-label">
                                            Viatura <span class="text-danger">*</span>
                                        </label>
                                        {{ form.viatura }}
                                        {% if form.viatura.errors %}
                                            <div class="invalid-feedback d-block">{{ form.viatura.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_troca.id_for_label }}" class="form-label">
                                            Data e Hora da Troca <span class="text-danger">*</span>
                                        </label>
                                        <input type="datetime-local" 
                                               name="data_troca" 
                                               id="id_data_troca" 
                                               class="form-control"
                                               value="{% if object and object.data_troca %}{{ object.data_troca|date:'Y-m-d\TH:i' }}{% endif %}"
                                               required>
                                        {% if form.data_troca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_troca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.tipo_oleo.id_for_label }}" class="form-label">
                                            Tipo de Óleo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo_oleo }}
                                        {% if form.tipo_oleo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.tipo_oleo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.nome_oleo.id_for_label }}" class="form-label">
                                            Nome do Óleo
                                        </label>
                                        {{ form.nome_oleo }}
                                        {% if form.nome_oleo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.nome_oleo.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Nome/comercial do óleo utilizado</small>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.km_troca.id_for_label }}" class="form-label">
                                            KM na Troca <span class="text-danger">*</span>
                                        </label>
                                        {{ form.km_troca }}
                                        {% if form.km_troca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.km_troca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.quantidade_litros.id_for_label }}" class="form-label">
                                            Quantidade (Litros) <span class="text-danger">*</span>
                                        </label>
                                        {{ form.quantidade_litros }}
                                        {% if form.quantidade_litros.errors %}
                                            <div class="invalid-feedback d-block">{{ form.quantidade_litros.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.valor_litro.id_for_label }}" class="form-label">
                                            Valor por Litro (R$)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" 
                                                   name="valor_litro" 
                                                   id="id_valor_litro" 
                                                   class="form-control" 
                                                   value=""
                                                   placeholder="0,00"
                                                   autocomplete="off">
                                        </div>
                                        {% if form.valor_litro.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_litro.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Digite o valor - formatação automática em R$</small>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.valor_total.id_for_label }}" class="form-label">
                                            Valor Total (R$)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" 
                                                   name="valor_total" 
                                                   id="id_valor_total" 
                                                   class="form-control" 
                                                   readonly
                                                   value=""
                                                   placeholder="Calculado automaticamente">
                                        </div>
                                        {% if form.valor_total.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_total.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Valor do óleo calculado automaticamente</small>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.fornecedor_oficina.id_for_label }}" class="form-label">
                                            Oficina/Fornecedor
                                        </label>
                                        {{ form.fornecedor_oficina }}
                                        {% if form.fornecedor_oficina.errors %}
                                            <div class="invalid-feedback d-block">{{ form.fornecedor_oficina.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Filtros e Outras Peças -->
                                    <div class="col-12 mb-3">
                                        <div class="card border-info">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-filter me-2"></i>Filtros e Outras Peças
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Filtro de Óleo -->
                                                    <div class="col-md-6 mb-3">
                                                        <div class="form-check">
                                                            {{ form.trocou_filtro_oleo }}
                                                            <label class="form-check-label" for="{{ form.trocou_filtro_oleo.id_for_label }}">
                                                                <i class="fas fa-filter me-1 text-info"></i>Trocou Filtro de Óleo
                                                            </label>
                                                        </div>
                                                        <div id="campoValorFiltroOleo" style="display: none;" class="mt-2">
                                                            <label for="{{ form.valor_filtro_oleo.id_for_label }}" class="form-label">
                                                                Valor do Filtro de Óleo (R$)
                                                            </label>
                                                            <div class="input-group">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" 
                                                                       name="valor_filtro_oleo" 
                                                                       id="id_valor_filtro_oleo" 
                                                                       class="form-control" 
                                                                       value=""
                                                                       placeholder="0,00"
                                                                       autocomplete="off">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Filtro de Combustível -->
                                                    <div class="col-md-6 mb-3">
                                                        <div class="form-check">
                                                            {{ form.trocou_filtro_combustivel }}
                                                            <label class="form-check-label" for="{{ form.trocou_filtro_combustivel.id_for_label }}">
                                                                <i class="fas fa-gas-pump me-1 text-warning"></i>Trocou Filtro de Combustível
                                                            </label>
                                                        </div>
                                                        <div id="campoValorFiltroCombustivel" style="display: none;" class="mt-2">
                                                            <label for="{{ form.valor_filtro_combustivel.id_for_label }}" class="form-label">
                                                                Valor do Filtro de Combustível (R$)
                                                            </label>
                                                            <div class="input-group">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" 
                                                                       name="valor_filtro_combustivel" 
                                                                       id="id_valor_filtro_combustivel" 
                                                                       class="form-control" 
                                                                       value=""
                                                                       placeholder="0,00"
                                                                       autocomplete="off">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Filtro de Ar Condicionado -->
                                                    <div class="col-md-6 mb-3">
                                                        <div class="form-check">
                                                            {{ form.trocou_filtro_ar }}
                                                            <label class="form-check-label" for="{{ form.trocou_filtro_ar.id_for_label }}">
                                                                <i class="fas fa-snowflake me-1 text-primary"></i>Trocou Filtro de Ar Condicionado
                                                            </label>
                                                        </div>
                                                        <div id="campoValorFiltroAr" style="display: none;" class="mt-2">
                                                            <label for="{{ form.valor_filtro_ar.id_for_label }}" class="form-label">
                                                                Valor do Filtro de Ar Condicionado (R$)
                                                            </label>
                                                            <div class="input-group">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" 
                                                                       name="valor_filtro_ar" 
                                                                       id="id_valor_filtro_ar" 
                                                                       class="form-control" 
                                                                       value=""
                                                                       placeholder="0,00"
                                                                       autocomplete="off">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Aditivo de Arrefecimento -->
                                                    <div class="col-md-6 mb-3">
                                                        <div class="form-check">
                                                            {{ form.adicionou_aditivo_arrefecimento }}
                                                            <label class="form-check-label" for="{{ form.adicionou_aditivo_arrefecimento.id_for_label }}">
                                                                <i class="fas fa-thermometer-half me-1 text-danger"></i>Adicionou Aditivo de Arrefecimento
                                                            </label>
                                                        </div>
                                                        <div id="campoAditivoArrefecimento" style="display: none;" class="mt-2">
                                                            <div class="row">
                                                                <div class="col-md-6 mb-2">
                                                                    <label for="{{ form.quantidade_aditivo_arrefecimento.id_for_label }}" class="form-label">
                                                                        Quantidade (L)
                                                                    </label>
                                                                    {{ form.quantidade_aditivo_arrefecimento }}
                                                                </div>
                                                                <div class="col-md-6 mb-2">
                                                                    <label for="{{ form.valor_aditivo_arrefecimento.id_for_label }}" class="form-label">
                                                                        Valor (R$)
                                                                    </label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">R$</span>
                                                                        <input type="text" 
                                                                               name="valor_aditivo_arrefecimento" 
                                                                               id="id_valor_aditivo_arrefecimento" 
                                                                               class="form-control" 
                                                                               value=""
                                                                               placeholder="0,00"
                                                                               autocomplete="off">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Outras Peças -->
                                                    <div class="col-md-12 mb-3">
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <label class="form-label mb-0">
                                                                <i class="fas fa-cogs me-1"></i>Outras Peças Trocadas
                                                            </label>
                                                            <button type="button" class="btn btn-sm btn-success" id="btnAdicionarPeca">
                                                                <i class="fas fa-plus me-1"></i>Adicionar Peça
                                                            </button>
                                                        </div>
                                                        
                                                        <!-- Tabela de Peças -->
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered table-sm" id="tabelaOutrasPecas">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th style="width: 35%;">Nome da Peça</th>
                                                                        <th style="width: 15%;">Quantidade</th>
                                                                        <th style="width: 20%;">Valor Unitário (R$)</th>
                                                                        <th style="width: 20%;">Total (R$)</th>
                                                                        <th style="width: 10%;">Ações</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="tbodyOutrasPecas">
                                                                    <!-- Linhas serão adicionadas dinamicamente aqui -->
                                                                </tbody>
                                                                <tfoot>
                                                                    <tr class="table-info fw-bold">
                                                                        <td colspan="3" class="text-end">Total das Outras Peças:</td>
                                                                        <td>
                                                                            <span id="totalOutrasPecas" class="text-success">R$ 0,00</span>
                                                                        </td>
                                                                        <td></td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                        
                                                        <!-- Campos ocultos para salvar no formulário -->
                                                        <input type="hidden" name="outras_pecas" id="id_outras_pecas" value="">
                                                        <input type="hidden" name="valor_outras_pecas" id="id_valor_outras_pecas" value="">
                                                        
                                                        {% if form.outras_pecas.errors %}
                                                            <div class="invalid-feedback d-block">{{ form.outras_pecas.errors }}</div>
                                                        {% endif %}
                                                        {% if form.valor_outras_pecas.errors %}
                                                            <div class="invalid-feedback d-block">{{ form.valor_outras_pecas.errors }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Valor Total da Nota -->
                                    <div class="col-12 mb-3">
                                        <div class="card border-success">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-calculator me-2"></i>Valor Total da Nota
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label for="{{ form.valor_total_nota.id_for_label }}" class="form-label">
                                                            <strong>Valor Total da Nota (R$)</strong>
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">R$</span>
                                                            <input type="text" 
                                                                   name="valor_total_nota" 
                                                                   id="id_valor_total_nota" 
                                                                   class="form-control fw-bold text-success fs-5" 
                                                                   readonly
                                                                   value=""
                                                                   placeholder="Será calculado automaticamente">
                                                        </div>
                                                        {% if form.valor_total_nota.errors %}
                                                            <div class="invalid-feedback d-block">{{ form.valor_total_nota.errors }}</div>
                                                        {% endif %}
                                                        <small class="form-text text-muted"><strong>Total da nota fiscal (óleo + filtros + aditivo de arrefecimento + outras peças)</strong></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.proximo_km_troca.id_for_label }}" class="form-label">
                                            KM para Próxima Troca
                                        </label>
                                        {{ form.proximo_km_troca }}
                                        {% if form.proximo_km_troca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.proximo_km_troca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                                            Responsável pela Troca
                                        </label>
                                        {{ form.responsavel }}
                                        {% if form.responsavel.errors %}
                                            <div class="invalid-feedback d-block">{{ form.responsavel.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check mt-4">
                                            {{ form.ativo }}
                                            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                                Ativo
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <a href="{% url 'militares:troca_oleo_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar número como moeda BRL (preserva a vírgula decimal)
    function formatarMoedaBRL(valor) {
        if (!valor || valor === '') return '';
        
        let numeroString = valor.toString().trim();
        
        if (numeroString.includes(',')) {
            let partes = numeroString.split(',');
            let parteInteira = partes[0].replace(/\./g, '').replace(/[^\d]/g, '') || '0';
            let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
            
            while (parteDecimal.length < 2) {
                parteDecimal += '0';
            }
            
            parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return parteInteira + ',' + parteDecimal;
        } else {
            numeroString = numeroString.replace(/[^\d]/g, '');
            if (numeroString === '') return '';
            numeroString = numeroString.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return numeroString;
        }
    }
    
    // Função para obter valor numérico limpo
    function obterValorNumerico(valor) {
        if (!valor || valor === '') return '';
        let numero = valor.toString().replace(/\./g, '').replace(',', '.');
        numero = numero.replace(/[^\d.]/g, '');
        return numero;
    }
    
    // Calcular valor total automaticamente
    function calcularValorTotal() {
        const quantidadeInput = document.getElementById('id_quantidade_litros');
        const valorLitroInput = document.getElementById('id_valor_litro');
        const valorFiltroOleoInput = document.getElementById('id_valor_filtro_oleo');
        const valorFiltroCombustivelInput = document.getElementById('id_valor_filtro_combustivel');
        const valorFiltroArInput = document.getElementById('id_valor_filtro_ar');
        const valorAditivoArrefecimentoInput = document.getElementById('id_valor_aditivo_arrefecimento');
        const valorOutrasPecasInput = document.getElementById('id_valor_outras_pecas');
        const valorTotalInput = document.getElementById('id_valor_total');
        const valorTotalNotaInput = document.getElementById('id_valor_total_nota');
        
        // Calcular valores de filtros e aditivos (mesmo sem óleo)
        const valorFiltroOleo = valorFiltroOleoInput ? (parseFloat(obterValorNumerico(valorFiltroOleoInput.value)) || 0) : 0;
        const valorFiltroCombustivel = valorFiltroCombustivelInput ? (parseFloat(obterValorNumerico(valorFiltroCombustivelInput.value)) || 0) : 0;
        const valorFiltroAr = valorFiltroArInput ? (parseFloat(obterValorNumerico(valorFiltroArInput.value)) || 0) : 0;
        const valorAditivoArrefecimento = valorAditivoArrefecimentoInput ? (parseFloat(obterValorNumerico(valorAditivoArrefecimentoInput.value)) || 0) : 0;
        
        // Ler valor de outras peças corretamente
        let valorOutrasPecas = 0;
        if (valorOutrasPecasInput && valorOutrasPecasInput.value) {
            const valorOutrasPecasStr = valorOutrasPecasInput.value.toString();
            if (valorOutrasPecasStr.includes(',')) {
                const valorLimpo = obterValorNumerico(valorOutrasPecasStr);
                valorOutrasPecas = parseFloat(valorLimpo) || 0;
            } else {
                valorOutrasPecas = parseFloat(valorOutrasPecasStr) || 0;
            }
        }
        
        // Função para formatar valor
        function formatarValor(valor) {
            if (valor > 0) {
                let valorStr = valor.toFixed(2);
                let partes = valorStr.split('.');
                let parteInteira = partes[0];
                let parteDecimal = partes[1] || '00';
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return parteInteira + ',' + parteDecimal;
            }
            return '';
        }
        
        // Valor do óleo (se tiver quantidade e valor por litro)
        let valorOleo = 0;
        if (quantidadeInput && valorLitroInput) {
            const quantidade = parseFloat(quantidadeInput.value) || 0;
            const valorLitro = parseFloat(obterValorNumerico(valorLitroInput.value)) || 0;
            valorOleo = quantidade * valorLitro;
        }
        
        // Garantir que todos os valores sejam números válidos
        const valorOleoFinal = isNaN(valorOleo) ? 0 : valorOleo;
        const valorFiltroOleoFinal = isNaN(valorFiltroOleo) ? 0 : valorFiltroOleo;
        const valorFiltroCombustivelFinal = isNaN(valorFiltroCombustivel) ? 0 : valorFiltroCombustivel;
        const valorFiltroArFinal = isNaN(valorFiltroAr) ? 0 : valorFiltroAr;
        const valorAditivoArrefecimentoFinal = isNaN(valorAditivoArrefecimento) ? 0 : valorAditivoArrefecimento;
        const valorOutrasPecasFinal = isNaN(valorOutrasPecas) ? 0 : valorOutrasPecas;
        
        // Valor total da nota (tudo somado)
        const valorTotalNota = valorOleoFinal + valorFiltroOleoFinal + valorFiltroCombustivelFinal + valorFiltroArFinal + valorAditivoArrefecimentoFinal + valorOutrasPecasFinal;
        
        // Atualizar valor do óleo (no topo)
        if (valorTotalInput) {
            valorTotalInput.value = formatarValor(valorOleo);
        }
        
        // Atualizar valor total da nota (card após filtros)
        if (valorTotalNotaInput) {
            valorTotalNotaInput.value = formatarValor(valorTotalNota);
        }
    }
    
    // Função para mostrar/ocultar campos de filtros
    function toggleCampoFiltro(filtroId, campoId, valorInputId) {
        const checkbox = document.getElementById(filtroId);
        const campo = document.getElementById(campoId);
        const valorInput = document.getElementById(valorInputId);
        
        if (checkbox && campo) {
            if (checkbox.checked) {
                campo.style.display = 'block';
            } else {
                campo.style.display = 'none';
                if (valorInput) {
                    valorInput.value = '';
                }
                calcularValorTotal();
            }
        }
    }
    
    // Event listeners para campos que afetam o cálculo
    const quantidadeInput = document.getElementById('id_quantidade_litros');
    if (quantidadeInput) {
        quantidadeInput.addEventListener('input', calcularValorTotal);
        quantidadeInput.addEventListener('change', calcularValorTotal);
        quantidadeInput.addEventListener('blur', calcularValorTotal);
    }
    
    const valorLitroInput = document.getElementById('id_valor_litro');
    if (valorLitroInput) {
        {% if object and object.valor_litro %}
        const valorInicial = parseFloat('{{ object.valor_litro }}');
        if (!isNaN(valorInicial) && valorInicial > 0) {
            valorLitroInput.value = formatarMoedaBRL(valorInicial.toString());
        }
        {% else %}
        valorLitroInput.value = '';
        {% endif %}
        
        valorLitroInput.addEventListener('input', function(e) {
            let valor = e.target.value;
            let valorLimpo = valor.replace(/[^\d,]/g, '');
            let partes = valorLimpo.split(',');
            if (partes.length > 2) {
                valorLimpo = partes[0] + ',' + partes.slice(1).join('');
            }
            if (partes.length === 2 && partes[1].length > 2) {
                valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
            }
            if (valorLimpo !== valor) {
                let cursorPos = e.target.selectionStart;
                e.target.value = valorLimpo;
                setTimeout(() => {
                    let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
            calcularValorTotal();
        });
        
        valorLitroInput.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor || valor === '') {
                e.target.value = '';
                calcularValorTotal();
                return;
            }
            
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                
                while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                    parteDecimal += '0';
                }
                if (parteDecimal === '') {
                    parteDecimal = '00';
                }
                
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = parteInteira + ',' + parteDecimal;
            } else {
                let numeroLimpo = valor.replace(/[^\d]/g, '');
                if (numeroLimpo !== '') {
                    numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = numeroLimpo + ',00';
                } else {
                    e.target.value = '';
                }
            }
            
            calcularValorTotal();
        });
        
        valorLitroInput.addEventListener('change', calcularValorTotal);
    }
    
    // Função auxiliar para configurar campo de valor monetário
    function configurarCampoMonetario(inputId, valorInicial) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        if (valorInicial && !isNaN(valorInicial) && valorInicial > 0) {
            input.value = formatarMoedaBRL(valorInicial.toString());
        } else {
            input.value = '';
        }
        
        input.addEventListener('input', function(e) {
            let valor = e.target.value;
            let valorLimpo = valor.replace(/[^\d,]/g, '');
            let partes = valorLimpo.split(',');
            if (partes.length > 2) {
                valorLimpo = partes[0] + ',' + partes.slice(1).join('');
            }
            if (partes.length === 2 && partes[1].length > 2) {
                valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
            }
            if (valorLimpo !== valor) {
                let cursorPos = e.target.selectionStart;
                e.target.value = valorLimpo;
                setTimeout(() => {
                    let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
            calcularValorTotal();
        });
        
        input.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor || valor === '') {
                e.target.value = '';
                calcularValorTotal();
                return;
            }
            
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                
                while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                    parteDecimal += '0';
                }
                if (parteDecimal === '') {
                    parteDecimal = '00';
                }
                
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = parteInteira + ',' + parteDecimal;
            } else {
                let numeroLimpo = valor.replace(/[^\d]/g, '');
                if (numeroLimpo !== '') {
                    numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = numeroLimpo + ',00';
                } else {
                    e.target.value = '';
                }
            }
            
            calcularValorTotal();
        });
        
        input.addEventListener('change', calcularValorTotal);
    }
    
    // Configurar campos de valores dos filtros
    configurarCampoMonetario('id_valor_filtro_oleo', {% if object and object.valor_filtro_oleo %}{{ object.valor_filtro_oleo }}{% else %}null{% endif %});
    configurarCampoMonetario('id_valor_filtro_combustivel', {% if object and object.valor_filtro_combustivel %}{{ object.valor_filtro_combustivel }}{% else %}null{% endif %});
    configurarCampoMonetario('id_valor_filtro_ar', {% if object and object.valor_filtro_ar %}{{ object.valor_filtro_ar }}{% else %}null{% endif %});
    configurarCampoMonetario('id_valor_aditivo_arrefecimento', {% if object and object.valor_aditivo_arrefecimento %}{{ object.valor_aditivo_arrefecimento }}{% else %}null{% endif %});
    
    // ==================== GERENCIAMENTO DE OUTRAS PEÇAS ====================
    let contadorPecas = 0;
    
    // Função auxiliar formatarValor (usada na tabela)
    function formatarValorPecas(valor) {
        if (valor > 0) {
            let valorStr = valor.toFixed(2);
            let partes = valorStr.split('.');
            let parteInteira = partes[0];
            let parteDecimal = partes[1] || '00';
            parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return parteInteira + ',' + parteDecimal;
        }
        return '';
    }
    
    // Função para calcular o total de uma peça
    function calcularTotalPeca(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay) {
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const valorUnitario = parseFloat(obterValorNumerico(valorUnitarioInput.value)) || 0;
        const total = quantidade * valorUnitario;
        
        const valorFormatado = formatarValorPecas(total);
        
        if (totalInput) {
            totalInput.value = valorFormatado;
        }
        
        if (totalDisplay) {
            totalDisplay.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
        }
        
        atualizarTotalOutrasPecas();
    }
    
    // Função para atualizar o total geral das outras peças
    function atualizarTotalOutrasPecas() {
        let totalGeral = 0;
        const tbody = document.getElementById('tbodyOutrasPecas');
        const linhas = tbody.querySelectorAll('tr');
        
        linhas.forEach(linha => {
            const totalInput = linha.querySelector('input[name="total_peca[]"]');
            if (totalInput && totalInput.value) {
                const valorLimpo = obterValorNumerico(totalInput.value);
                totalGeral += parseFloat(valorLimpo) || 0;
            }
        });
        
        // Atualizar exibição
        const totalSpan = document.getElementById('totalOutrasPecas');
        if (totalSpan) {
            const valorFormatado = formatarValorPecas(totalGeral);
            totalSpan.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
        }
        
        // Atualizar campo oculto (salvar como número puro com ponto decimal para o backend)
        const valorOutrasPecasHidden = document.getElementById('id_valor_outras_pecas');
        if (valorOutrasPecasHidden) {
            if (totalGeral > 0) {
                valorOutrasPecasHidden.value = totalGeral.toFixed(2);
            } else {
                valorOutrasPecasHidden.value = '';
            }
        }
        
        // Atualizar campo de texto com nomes das peças
        atualizarTextoOutrasPecas();
        
        // Recalcular valor total da nota
        calcularValorTotal();
    }
    
    // Função para atualizar o texto das outras peças
    function atualizarTextoOutrasPecas() {
        const linhas = document.querySelectorAll('#tbodyOutrasPecas tr');
        const listaPecas = [];
        
        linhas.forEach(linha => {
            const nomeInput = linha.querySelector('input[name="nome_peca[]"]');
            const quantidadeInput = linha.querySelector('input[name="quantidade_peca[]"]');
            const valorUnitarioInput = linha.querySelector('input[name="valor_unitario_peca[]"]');
            const totalInput = linha.querySelector('input[name="total_peca[]"]');
            
            if (nomeInput && nomeInput.value) {
                const nome = nomeInput.value.trim();
                const quantidade = quantidadeInput ? (quantidadeInput.value || '1') : '1';
                const valorUnitario = valorUnitarioInput ? obterValorNumerico(valorUnitarioInput.value) : '0';
                const total = totalInput ? obterValorNumerico(totalInput.value) : '0';
                
                if (nome) {
                    listaPecas.push(`${nome} - Qtd: ${quantidade} - Unit: R$ ${parseFloat(valorUnitario).toFixed(2).replace('.', ',')} - Total: R$ ${parseFloat(total).toFixed(2).replace('.', ',')}`);
                }
            }
        });
        
        const outrasPecasHidden = document.getElementById('id_outras_pecas');
        if (outrasPecasHidden) {
            outrasPecasHidden.value = listaPecas.join('\n');
        }
    }
    
    // Função para adicionar nova linha de peça
    function adicionarLinhaPeca(nome = '', quantidade = '', valorUnitario = '', total = '') {
        contadorPecas++;
        const tbody = document.getElementById('tbodyOutrasPecas');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input type="text" 
                       name="nome_peca[]" 
                       class="form-control form-control-sm" 
                       placeholder="Nome da peça"
                       value="${nome}"
                       autocomplete="off">
            </td>
            <td>
                <input type="number" 
                       name="quantidade_peca[]" 
                       class="form-control form-control-sm quantidade-peca" 
                       placeholder="1"
                       min="0.01"
                       step="0.01"
                       value="${quantidade}"
                       autocomplete="off">
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">R$</span>
                    <input type="text" 
                           name="valor_unitario_peca[]" 
                           class="form-control valor-unitario-peca" 
                           placeholder="0,00"
                           value="${valorUnitario}"
                           autocomplete="off">
                </div>
            </td>
            <td>
                <input type="hidden" name="total_peca[]" value="${total}">
                <span class="fw-bold text-success total-peca-display">${total ? 'R$ ' + total : 'R$ 0,00'}</span>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remover-peca" title="Remover peça">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
        
        // Configurar event listeners para os novos campos
        const quantidadeInput = tr.querySelector('.quantidade-peca');
        const valorUnitarioInput = tr.querySelector('.valor-unitario-peca');
        const totalInput = tr.querySelector('input[name="total_peca[]"]');
        const totalDisplay = tr.querySelector('.total-peca-display');
        
        // Formatar campo monetário
        if (valorUnitarioInput && valorUnitarioInput.value) {
            valorUnitarioInput.value = formatarMoedaBRL(valorUnitarioInput.value);
        }
        
        // Event listeners para calcular total
        quantidadeInput.addEventListener('input', function() {
            calcularTotalPeca(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
        });
        
        quantidadeInput.addEventListener('change', function() {
            calcularTotalPeca(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
        });
        
        valorUnitarioInput.addEventListener('input', function() {
            this.value = formatarMoedaBRL(this.value);
            calcularTotalPeca(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
        });
        
        valorUnitarioInput.addEventListener('blur', function() {
            this.value = formatarMoedaBRL(this.value);
            calcularTotalPeca(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
        });
        
        // Event listener para atualizar texto ao mudar nome
        const nomeInput = tr.querySelector('input[name="nome_peca[]"]');
        nomeInput.addEventListener('blur', atualizarTextoOutrasPecas);
        
        // Botão remover
        const btnRemover = tr.querySelector('.btn-remover-peca');
        btnRemover.addEventListener('click', function() {
            tr.remove();
            atualizarTotalOutrasPecas();
        });
    }
    
    // Botão adicionar peça
    const btnAdicionarPeca = document.getElementById('btnAdicionarPeca');
    if (btnAdicionarPeca) {
        btnAdicionarPeca.addEventListener('click', function() {
            adicionarLinhaPeca();
        });
    }
    
    // Carregar peças existentes se estiver editando
    {% if object and object.outras_pecas %}
        const outrasPecasTexto = `{{ object.outras_pecas|escapejs }}`;
        if (outrasPecasTexto && outrasPecasTexto.trim()) {
            const linhas = outrasPecasTexto.split('\n');
            linhas.forEach(linha => {
                if (linha.trim()) {
                    // Tentar extrair informações da linha
                    // Formato esperado: "Nome - Qtd: X - Unit: R$ Y - Total: R$ Z"
                    const partes = linha.split(' - ');
                    if (partes.length >= 4) {
                        const nome = partes[0].trim();
                        const qtdMatch = partes[1].match(/Qtd:\s*([\d,\.]+)/);
                        const unitMatch = partes[2].match(/Unit:\s*R\$\s*([\d,\.]+)/);
                        const totalMatch = partes[3].match(/Total:\s*R\$\s*([\d,\.]+)/);
                        
                        const quantidade = qtdMatch ? qtdMatch[1].replace(',', '.') : '';
                        const valorUnitario = unitMatch ? unitMatch[1].replace(',', '.') : '';
                        const total = totalMatch ? totalMatch[1].replace(',', '.') : '';
                        
                        if (nome) {
                            adicionarLinhaPeca(nome, quantidade, formatarMoedaBRL(valorUnitario), formatarMoedaBRL(total));
                        }
                    }
                }
            });
        }
    {% endif %}
    
    // ==================== FIM GERENCIAMENTO DE OUTRAS PEÇAS ====================
    
    // Configurar campos readonly (valor_total e valor_total_nota) com valores iniciais
    {% if object and object.valor_total %}
        const valorTotalInputInit = document.getElementById('id_valor_total');
        if (valorTotalInputInit) {
            const valorTotalInicial = parseFloat('{{ object.valor_total }}');
            if (!isNaN(valorTotalInicial) && valorTotalInicial > 0) {
                valorTotalInputInit.value = formatarMoedaBRL(valorTotalInicial.toString());
            }
        }
        const valorTotalNotaInputInit = document.getElementById('id_valor_total_nota');
        if (valorTotalNotaInputInit) {
            const valorTotalNotaInicial = parseFloat('{{ object.valor_total_nota|default:object.valor_total }}');
            if (!isNaN(valorTotalNotaInicial) && valorTotalNotaInicial > 0) {
                valorTotalNotaInputInit.value = formatarMoedaBRL(valorTotalNotaInicial.toString());
            }
        }
    {% endif %}
    
    // Configurar checkboxes dos filtros
    const trocouFiltroOleoCheckbox = document.getElementById('id_trocou_filtro_oleo');
    if (trocouFiltroOleoCheckbox) {
        trocouFiltroOleoCheckbox.addEventListener('change', function() {
            toggleCampoFiltro('id_trocou_filtro_oleo', 'campoValorFiltroOleo', 'id_valor_filtro_oleo');
        });
        toggleCampoFiltro('id_trocou_filtro_oleo', 'campoValorFiltroOleo', 'id_valor_filtro_oleo');
    }
    
    const trocouFiltroCombustivelCheckbox = document.getElementById('id_trocou_filtro_combustivel');
    if (trocouFiltroCombustivelCheckbox) {
        trocouFiltroCombustivelCheckbox.addEventListener('change', function() {
            toggleCampoFiltro('id_trocou_filtro_combustivel', 'campoValorFiltroCombustivel', 'id_valor_filtro_combustivel');
        });
        toggleCampoFiltro('id_trocou_filtro_combustivel', 'campoValorFiltroCombustivel', 'id_valor_filtro_combustivel');
    }
    
    const trocouFiltroArCheckbox = document.getElementById('id_trocou_filtro_ar');
    if (trocouFiltroArCheckbox) {
        trocouFiltroArCheckbox.addEventListener('change', function() {
            toggleCampoFiltro('id_trocou_filtro_ar', 'campoValorFiltroAr', 'id_valor_filtro_ar');
        });
        toggleCampoFiltro('id_trocou_filtro_ar', 'campoValorFiltroAr', 'id_valor_filtro_ar');
    }
    
    // Configurar aditivo de arrefecimento
    const adicionouAditivoCheckbox = document.getElementById('id_adicionou_aditivo_arrefecimento');
    if (adicionouAditivoCheckbox) {
        adicionouAditivoCheckbox.addEventListener('change', function() {
            const campoAditivo = document.getElementById('campoAditivoArrefecimento');
            const quantidadeInput = document.getElementById('id_quantidade_aditivo_arrefecimento');
            const valorInput = document.getElementById('id_valor_aditivo_arrefecimento');
            
            if (adicionouAditivoCheckbox.checked) {
                campoAditivo.style.display = 'block';
            } else {
                campoAditivo.style.display = 'none';
                if (quantidadeInput) quantidadeInput.value = '';
                if (valorInput) valorInput.value = '';
                calcularValorTotal();
            }
        });
        // Inicializar estado
        if (adicionouAditivoCheckbox.checked) {
            document.getElementById('campoAditivoArrefecimento').style.display = 'block';
        } else {
            document.getElementById('campoAditivoArrefecimento').style.display = 'none';
        }
    }
    
    // Event listener para quantidade de aditivo
    const quantidadeAditivoInput = document.getElementById('id_quantidade_aditivo_arrefecimento');
    if (quantidadeAditivoInput) {
        quantidadeAditivoInput.addEventListener('input', calcularValorTotal);
        quantidadeAditivoInput.addEventListener('change', calcularValorTotal);
        quantidadeAditivoInput.addEventListener('blur', calcularValorTotal);
    }
    
    // Event listeners para valor do aditivo
    const valorAditivoInput = document.getElementById('id_valor_aditivo_arrefecimento');
    if (valorAditivoInput) {
        valorAditivoInput.addEventListener('input', function() {
            this.value = formatarMoedaBRL(this.value);
            calcularValorTotal();
        });
        valorAditivoInput.addEventListener('change', calcularValorTotal);
        valorAditivoInput.addEventListener('blur', calcularValorTotal);
    }
    
    // Preencher data e hora automaticamente se não estiver editando
    const dataTrocaInput = document.getElementById('id_data_troca');
    if (dataTrocaInput) {
        {% if object and object.data_troca %}
        const dataObj = '{{ object.data_troca|date:"Y-m-d\TH:i" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataTrocaInput.value = dataObj;
        }
        {% else %}
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const datetimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
        dataTrocaInput.value = datetimeLocal;
        {% endif %}
    }
    
    // Formatar valor total inicial se houver (na edição)
    const valorTotalInput = document.getElementById('id_valor_total');
    if (valorTotalInput) {
        {% if object and object.valor_total %}
        const valorTotalInicial = parseFloat('{{ object.valor_total }}');
        if (!isNaN(valorTotalInicial) && valorTotalInicial > 0) {
            let valorTotalStr = valorTotalInicial.toFixed(2);
            let partes = valorTotalStr.split('.');
            let parteInteira = partes[0];
            let parteDecimal = partes[1] || '00';
            parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            valorTotalInput.value = parteInteira + ',' + parteDecimal;
        }
        {% endif %}
    }
    
    // Preparar valores para envio
    const form = document.getElementById('trocaOleoForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (valorLitroInput && valorLitroInput.value) {
                valorLitroInput.value = obterValorNumerico(valorLitroInput.value);
            }
            
            const valorFiltroOleoInput = document.getElementById('id_valor_filtro_oleo');
            if (valorFiltroOleoInput && valorFiltroOleoInput.value) {
                valorFiltroOleoInput.value = obterValorNumerico(valorFiltroOleoInput.value);
            }
            
            const valorFiltroCombustivelInput = document.getElementById('id_valor_filtro_combustivel');
            if (valorFiltroCombustivelInput && valorFiltroCombustivelInput.value) {
                valorFiltroCombustivelInput.value = obterValorNumerico(valorFiltroCombustivelInput.value);
            }
            
            const valorFiltroArInput = document.getElementById('id_valor_filtro_ar');
            if (valorFiltroArInput && valorFiltroArInput.value) {
                valorFiltroArInput.value = obterValorNumerico(valorFiltroArInput.value);
            }
            
            const valorAditivoArrefecimentoInput = document.getElementById('id_valor_aditivo_arrefecimento');
            if (valorAditivoArrefecimentoInput && valorAditivoArrefecimentoInput.value) {
                valorAditivoArrefecimentoInput.value = obterValorNumerico(valorAditivoArrefecimentoInput.value);
            }
            
            // valor_outras_pecas já está no formato correto (número puro) no campo oculto
            // Não precisa converter novamente
            
            if (valorTotalInput && valorTotalInput.value) {
                valorTotalInput.value = obterValorNumerico(valorTotalInput.value);
            }
            
            const valorTotalNotaInput = document.getElementById('id_valor_total_nota');
            if (valorTotalNotaInput && valorTotalNotaInput.value) {
                valorTotalNotaInput.value = obterValorNumerico(valorTotalNotaInput.value);
            }
        });
    }
    
    // Inicializar cálculos
    calcularValorTotal();
    
    // Inicializar Select2 para o campo de responsável (militar)
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um responsável já selecionado (na edição), carregar os dados
        {% if object and object.responsavel %}
        const responsavelId = {{ object.responsavel.id }};
        const responsavelText = "{{ object.responsavel.get_posto_graduacao_display }} {{ object.responsavel.nome_completo }} - Mat: {{ object.responsavel.matricula }}";
        if (responsavelId) {
            const option = new Option(responsavelText, responsavelId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
    }
});
</script>
{% endblock %}

