{% extends 'base.html' %}
{% load static %}
{% load militares_extras %}

{% block title %}Lançar Notas - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Lançar Notas
                </h1>
                <a href="{% url 'militares:ensino_avaliacoes_listar' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Informações Básicas -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-info-circle me-2"></i>Informações Básicas
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.turma.id_for_label }}" class="form-label">
                                    Turma <span class="text-danger">*</span>
                                </label>
                                {{ form.turma }}
                                {% if form.turma.errors %}
                                    <div class="text-danger">{{ form.turma.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.disciplina.id_for_label }}" class="form-label">
                                    Disciplina <span class="text-danger">*</span>
                                </label>
                                {{ form.disciplina }}
                                {% if form.disciplina.errors %}
                                    <div class="text-danger">{{ form.disciplina.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Disciplinas disponíveis na turma selecionada</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                    Tipo de Avaliação <span class="text-danger">*</span>
                                </label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                    <div class="text-danger">{{ form.tipo.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.tipo_verificacao.id_for_label }}" class="form-label">
                                    Tipo de Verificação
                                </label>
                                {{ form.tipo_verificacao }}
                                {% if form.tipo_verificacao.errors %}
                                    <div class="text-danger">{{ form.tipo_verificacao.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">VI, VE, VC, VEsp conforme ITE 15.15</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.posicao_avaliacao.id_for_label }}" class="form-label">
                                    Posição da Avaliação <span class="text-danger">*</span>
                                </label>
                                {{ form.posicao_avaliacao }}
                                {% if form.posicao_avaliacao.errors %}
                                    <div class="text-danger">{{ form.posicao_avaliacao.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Selecione se é a 1ª, 2ª, 3ª, 4ª avaliação ou Recuperação</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.data_avaliacao.id_for_label }}" class="form-label">
                                    Data da Avaliação <span class="text-danger">*</span>
                                </label>
                                {{ form.data_avaliacao }}
                                {% if form.data_avaliacao.errors %}
                                    <div class="text-danger">{{ form.data_avaliacao.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.peso.id_for_label }}" class="form-label">
                                    Peso <span class="text-danger">*</span>
                                </label>
                                {{ form.peso }}
                                {% if form.peso.errors %}
                                    <div class="text-danger">{{ form.peso.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Peso da avaliação no cálculo da nota final</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.nota_maxima.id_for_label }}" class="form-label">
                                    Nota Máxima <span class="text-danger">*</span>
                                </label>
                                {{ form.nota_maxima }}
                                {% if form.nota_maxima.errors %}
                                    <div class="text-danger">{{ form.nota_maxima.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                Descrição
                            </label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                                <div class="text-danger">{{ form.descricao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.criterios_aprovacao.id_for_label }}" class="form-label">
                                Critérios de Aprovação
                            </label>
                            {{ form.criterios_aprovacao }}
                            {% if form.criterios_aprovacao.errors %}
                                <div class="text-danger">{{ form.criterios_aprovacao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <strong>Erros no formulário:</strong>
                                <ul class="mb-0">
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        {% if messages %}
                            <div class="mt-3">
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        <strong>
                                            {% if message.tags == 'error' %}
                                                <i class="fas fa-exclamation-circle me-2"></i>Erro:
                                            {% elif message.tags == 'warning' %}
                                                <i class="fas fa-exclamation-triangle me-2"></i>Aviso:
                                            {% elif message.tags == 'success' %}
                                                <i class="fas fa-check-circle me-2"></i>Sucesso:
                                            {% else %}
                                                <i class="fas fa-info-circle me-2"></i>Info:
                                            {% endif %}
                                        </strong>
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Seção de Notas (apenas se turma e alunos estiverem disponíveis) -->
                        <div id="alunos-section" style="display: {% if turma and alunos %}block{% else %}none{% endif %};">
                            <h5 class="mb-3 mt-4 border-bottom pb-2">
                                <i class="fas fa-users me-2"></i>
                                Lançar Notas dos Alunos
                                <span class="badge bg-secondary ms-2" id="alunos-count">{% if alunos %}{{ alunos|length }}{% else %}0{% endif %} aluno(s)</span>
                            </h5>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered{% if is_apk or request.GET.apk %} table-sm{% endif %}">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Matrícula</th>
                                            <th>Aluno</th>
                                            <th class="text-center" style="width: 150px;">Nota</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alunos-table-body">
                                        {% if turma and alunos %}
                                            {% for aluno in alunos %}
                                            <tr>
                                                <td><strong>{{ aluno.matricula|default:"-" }}</strong></td>
                                                <td>
                                                    {% if aluno.militar %}
                                                        {{ aluno.militar.get_posto_graduacao_display }} {{ aluno.militar.nome_completo }}
                                                    {% elif aluno.pessoa_externa %}
                                                        {{ aluno.pessoa_externa.get_nome_completo }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <input 
                                                        type="number" 
                                                        name="nota_{{ aluno.pk }}" 
                                                        class="form-control form-control-sm text-center nota-input mx-auto" 
                                                        step="0.01" 
                                                        min="0" 
                                                        id="nota_{{ aluno.pk }}"
                                                        {% if notas_preenchidas and aluno.pk in notas_preenchidas %}value="{{ notas_preenchidas|lookup:aluno.pk }}"{% endif %}
                                                        placeholder="0.00"
                                                        inputmode="decimal"
                                                        style="max-width: 110px;"
                                                        data-aluno-id="{{ aluno.pk }}"
                                                    >
                                                    <small class="text-muted d-block mt-1">Máx: <span id="max_nota_{{ aluno.pk }}">-</span></small>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota:</strong> Você pode preencher as notas agora ou deixar em branco e lançá-las depois. 
                                A nota máxima será definida após selecionar a disciplina.
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'militares:ensino_avaliacoes_listar' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Voltar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-save me-2"></i>
                                Salvar Avaliação{% if turma and alunos %} e Notas{% endif %}
                            </button>
                        </div>
                    </form>
                    
                    <script>
                    // Garantir que os campos de nota sejam incluídos no submit
                    (function() {
                        const form = document.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                // Debug: verificar quais campos de nota estão presentes
                                // Excluir nota_maxima do seletor
                                const todosNotaInputs = document.querySelectorAll('input[name^="nota_"]');
                                const notaInputs = Array.from(todosNotaInputs).filter(input => input.name !== 'nota_maxima');
                                
                                console.log('=== DEBUG SUBMIT ===');
                                console.log('Total de campos de nota encontrados:', notaInputs.length);
                                
                                // Verificar todos os campos do formulário
                                const formData = new FormData(form);
                                console.log('=== DADOS DO FORMULÁRIO ===');
                                for (let [key, value] of formData.entries()) {
                                    if (key.startsWith('nota_') && key !== 'nota_maxima') {
                                        console.log(`${key}: ${value}`);
                                    }
                                }
                                
                                const notasComValor = [];
                                notaInputs.forEach(function(input) {
                                    const valor = input.value.trim();
                                    console.log('Campo: ' + input.name + ', Valor: "' + valor + '", ID: ' + input.id);
                                    if (valor) {
                                        notasComValor.push({
                                            campo: input.name,
                                            valor: valor
                                        });
                                    }
                                });
                                console.log('Notas com valor preenchido: ' + notasComValor.length);
                                console.log(notasComValor);
                                console.log('===================');
                                
                                // Verificar campos obrigatórios
                                const turma = form.querySelector('[name="turma"]');
                                const disciplina = form.querySelector('[name="disciplina"]');
                                const nome = form.querySelector('[name="nome"]');
                                const data = form.querySelector('[name="data_avaliacao"]');
                                
                                console.log('=== VALIDAÇÃO DE CAMPOS ===');
                                console.log('Turma:', turma ? turma.value : 'NÃO ENCONTRADO');
                                console.log('Disciplina:', disciplina ? disciplina.value : 'NÃO ENCONTRADO');
                                console.log('Nome:', nome ? nome.value : 'NÃO ENCONTRADO');
                                console.log('Data:', data ? data.value : 'NÃO ENCONTRADO');
                                console.log('===========================');
                                
                                // NÃO prevenir o submit - deixar o formulário ser enviado normalmente
                                // O formulário será validado no servidor
                            });
                        }
                    })();
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const turmaSelect = document.getElementById('id_turma');
    const disciplinaSelect = document.getElementById('id_disciplina');
    
    if (!turmaSelect || !disciplinaSelect) {
        console.error('Elementos do formulário não encontrados');
        return;
    }
    
    // URL base para obter dados da turma
    const urlBase = '{% url "militares:ensino_turma_dados" turma_id=999999 %}';
    
    // Função para carregar disciplinas da turma
    function carregarDisciplinasTurma(turmaId) {
        if (!turmaId) {
            // Limpar disciplinas se nenhuma turma selecionada
            disciplinaSelect.innerHTML = '<option value="">---------</option>';
            return;
        }
        
        console.log('Carregando disciplinas para turma:', turmaId);
        
        // Salvar valor selecionado atual (se houver)
        const valorSelecionado = disciplinaSelect.value;
        
        // Construir URL corretamente - substituir o ID placeholder
        const url = urlBase.replace('999999', turmaId);
        console.log('URL da requisição:', url);
        
        // Fazer requisição AJAX para obter disciplinas da turma
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Resposta recebida:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            console.log('Disciplinas recebidas:', data.disciplinas);
            
            // Filtrar disciplinas baseado na turma
            if (data.disciplinas && data.disciplinas.length > 0) {
                // Limpar e recarregar todas as disciplinas
                disciplinaSelect.innerHTML = '<option value="">---------</option>';
                
                // Adicionar disciplinas da turma
                data.disciplinas.forEach(disc => {
                    const option = document.createElement('option');
                    option.value = disc.id;
                    option.textContent = `${disc.codigo ? disc.codigo + ' - ' : ''}${disc.nome}`;
                    disciplinaSelect.appendChild(option);
                });
                
                console.log('Disciplinas carregadas:', disciplinaSelect.options.length - 1);
                
                // Restaurar valor selecionado se ainda existir
                if (valorSelecionado) {
                    const optionExiste = Array.from(disciplinaSelect.options).some(opt => opt.value === valorSelecionado);
                    if (optionExiste) {
                        disciplinaSelect.value = valorSelecionado;
                    }
                }
            } else {
                // Se não houver disciplinas, limpar
                disciplinaSelect.innerHTML = '<option value="">---------</option>';
                console.warn('Nenhuma disciplina encontrada para a turma:', turmaId);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar disciplinas:', error);
            console.error('Detalhes do erro:', error.message);
            // Em caso de erro, limpar e mostrar mensagem
            disciplinaSelect.innerHTML = '<option value="">---------</option>';
            alert('Erro ao carregar disciplinas. Verifique o console para mais detalhes.');
        });
    }
    
    // Flag para evitar carregamentos duplicados
    let carregandoAlunos = false;
    let ultimaRequisicao = null;
    
    // Função para carregar alunos da turma
    function carregarAlunosTurma(turmaId, disciplinaId = null, apenasRecuperacao = false) {
        if (!turmaId) {
            // Ocultar seção de alunos se nenhuma turma selecionada
            const alunosSection = document.getElementById('alunos-section');
            if (alunosSection) {
                alunosSection.style.display = 'none';
            }
            return;
        }
        
        // Verificar se já está carregando a mesma requisição
        const chaveRequisicao = `${turmaId}_${disciplinaId}_${apenasRecuperacao}`;
        if (carregandoAlunos && ultimaRequisicao === chaveRequisicao) {
            console.log('Carregamento de alunos já em andamento, ignorando...');
            return;
        }
        
        carregandoAlunos = true;
        ultimaRequisicao = chaveRequisicao;
        
        // Construir URL com parâmetros
        let url = `{% url 'militares:ensino_turma_alunos' turma_id=999999 %}`.replace('999999', turmaId);
        const params = new URLSearchParams();
        if (disciplinaId) {
            params.append('disciplina_id', disciplinaId);
        }
        if (apenasRecuperacao) {
            params.append('apenas_recuperacao', 'true');
        }
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        console.log('=== CARREGANDO ALUNOS ===');
        console.log('URL:', url);
        console.log('Turma ID:', turmaId);
        console.log('Disciplina ID:', disciplinaId);
        console.log('Apenas recuperação:', apenasRecuperacao);
        console.log('Parâmetros:', params.toString());
        console.log('========================');
        
        // Buscar alunos via AJAX
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('=== RESPOSTA RECEBIDA ===');
            console.log('Total de alunos recebidos:', data.alunos ? data.alunos.length : 0);
            console.log('Alunos:', data.alunos);
            console.log('Apenas recuperação solicitado:', apenasRecuperacao);
            console.log('========================');
            
            const alunosSection = document.getElementById('alunos-section');
            const alunosTableBody = document.getElementById('alunos-table-body');
            
            if (data.alunos && data.alunos.length > 0 && alunosTableBody) {
                // Salvar valores das notas existentes antes de limpar
                const valoresNotas = {};
                const camposNotaExistentes = document.querySelectorAll('input[name^="nota_"]');
                camposNotaExistentes.forEach(input => {
                    if (input.name !== 'nota_maxima' && input.value) {
                        valoresNotas[input.name] = input.value;
                    }
                });
                
                // Limpar tabela
                alunosTableBody.innerHTML = '';
                
                // Adicionar alunos
                data.alunos.forEach(aluno => {
                    const row = document.createElement('tr');
                    // Usar aluno.id (que é o pk) para garantir compatibilidade
                    const alunoId = aluno.id || aluno.pk;
                    const notaName = `nota_${alunoId}`;
                    const valorSalvo = valoresNotas[notaName] || '';
                    
                    console.log(`Criando campo de nota para aluno ID: ${alunoId}, Nome: ${aluno.nome}, Valor salvo: ${valorSalvo}`);
                    row.innerHTML = `
                        <td><strong>${aluno.matricula || '-'}</strong></td>
                        <td>${aluno.nome || 'N/A'}</td>
                        <td class="text-center">
                            <input 
                                type="number" 
                                name="${notaName}" 
                                class="form-control form-control-sm text-center nota-input mx-auto" 
                                step="0.01" 
                                min="0" 
                                id="${notaName}"
                                value="${valorSalvo}"
                                placeholder="0.00"
                                inputmode="decimal"
                                style="max-width: 110px;"
                                data-aluno-id="${alunoId}"
                            >
                            <small class="text-muted d-block mt-1">Máx: <span id="max_nota_${alunoId}">-</span></small>
                        </td>
                    `;
                    alunosTableBody.appendChild(row);
                });
                
                console.log(`Total de campos de nota criados: ${data.alunos.length}`);
                // Verificar se os campos foram criados corretamente
                setTimeout(() => {
                    const todosNotaInputs = document.querySelectorAll('input[name^="nota_"]');
                    const notaInputs = Array.from(todosNotaInputs).filter(input => input.name !== 'nota_maxima');
                    console.log(`Verificação: ${notaInputs.length} campos de nota encontrados no DOM após criação`);
                    notaInputs.forEach(input => {
                        console.log(`  - Campo: ${input.name}, ID: ${input.id}, Valor: ${input.value}`);
                    });
                }, 100);
                
                // Atualizar contador
                const alunosCount = document.getElementById('alunos-count');
                if (alunosCount) {
                    alunosCount.textContent = data.alunos.length;
                }
                
                // Mostrar seção
                if (alunosSection) {
                    alunosSection.style.display = 'block';
                }
                
                // Atualizar nota máxima
                atualizarNotaMaxima();
            } else {
                // Ocultar seção se não houver alunos
                if (alunosSection) {
                    alunosSection.style.display = 'none';
                }
            }
            
            // Liberar flag após carregamento
            carregandoAlunos = false;
        })
        .catch(error => {
            console.error('Erro ao carregar alunos:', error);
            // Liberar flag em caso de erro
            carregandoAlunos = false;
        });
    }
    
    // Função para atualizar lista de alunos baseado na posição da avaliação
    function atualizarListaAlunos() {
        const turmaId = turmaSelect ? turmaSelect.value : null;
        const disciplinaId = disciplinaSelect ? disciplinaSelect.value : null;
        const posicaoSelect = document.getElementById('id_posicao_avaliacao');
        const posicao = posicaoSelect ? posicaoSelect.value : null;
        
        console.log('=== atualizarListaAlunos() CHAMADA ===');
        console.log('Turma ID:', turmaId);
        console.log('Disciplina ID:', disciplinaId);
        console.log('Posição:', posicao);
        console.log('É recuperação?', posicao === 'RECUPERACAO');
        console.log('======================================');
        
        if (turmaId) {
            const apenasRecuperacao = posicao === 'RECUPERACAO';
            
            // Se for recuperação, é obrigatório ter disciplina selecionada
            if (apenasRecuperacao && !disciplinaId) {
                console.warn('Recuperação selecionada, mas nenhuma disciplina foi selecionada. Aguardando seleção da disciplina...');
                // Não fazer nada, aguardar que a disciplina seja selecionada
                return;
            }
            
            console.log('Chamando carregarAlunosTurma com:', {
                turmaId: turmaId,
                disciplinaId: disciplinaId,
                apenasRecuperacao: apenasRecuperacao
            });
            
            carregarAlunosTurma(turmaId, disciplinaId, apenasRecuperacao);
        }
    }
    
    // Adicionar listener para mudança de turma
    if (turmaSelect) {
        turmaSelect.addEventListener('change', function() {
            const turmaId = this.value;
            console.log('Turma selecionada:', turmaId);
            carregarDisciplinasTurma(turmaId);
            atualizarListaAlunos();
        });
    }
    
    // Função para atualizar opções de posição da avaliação baseado na carga horária
    function atualizarOpcoesPosicaoAvaliacao(disciplinaId, turmaId = null) {
        if (!disciplinaId) {
            // Se não houver disciplina, mostrar todas as opções
            const posicaoSelect = document.getElementById('id_posicao_avaliacao');
            if (posicaoSelect) {
                posicaoSelect.innerHTML = `
                    <option value="">---------</option>
                    <option value="1">1ª Avaliação</option>
                    <option value="2">2ª Avaliação</option>
                    <option value="3">3ª Avaliação</option>
                    <option value="4">4ª Avaliação</option>
                    <option value="RECUPERACAO">Recuperação</option>
                `;
            }
            return;
        }
        
        // Buscar dados da disciplina via AJAX
        let url = `{% url 'militares:ensino_disciplina_dados' disciplina_id=999999 %}`.replace('999999', disciplinaId);
        
        // Adicionar turma_id se disponível
        if (turmaId) {
            url += (url.includes('?') ? '&' : '?') + `turma_id=${turmaId}`;
        }
        
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const posicaoSelect = document.getElementById('id_posicao_avaliacao');
            if (!posicaoSelect) return;
            
            // Salvar valor selecionado atual
            const valorSelecionado = posicaoSelect.value;
            
            // Limpar opções
            posicaoSelect.innerHTML = '<option value="">---------</option>';
            
            // Obter número de avaliações permitidas
            const numeroAvaliacoes = data.numero_avaliacoes_permitidas || 4;
            
            // Obter avaliações que já foram criadas (mesmo sem notas)
            const avaliacoesCriadas = data.avaliacoes_criadas || [];
            
            // Adicionar opções baseado no número permitido, excluindo as que já foram criadas
            for (let i = 1; i <= numeroAvaliacoes; i++) {
                // Só adicionar se ainda não foi criada
                if (!avaliacoesCriadas.includes(i)) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.textContent = `${i}ª Avaliação`;
                    posicaoSelect.appendChild(option);
                }
            }
            
            // Sempre adicionar opção de recuperação
            const optionRecuperacao = document.createElement('option');
            optionRecuperacao.value = 'RECUPERACAO';
            optionRecuperacao.textContent = 'Recuperação';
            posicaoSelect.appendChild(optionRecuperacao);
            
            // Restaurar valor selecionado se ainda for válido
            if (valorSelecionado) {
                const opcaoValida = Array.from(posicaoSelect.options).some(
                    opt => opt.value === valorSelecionado && 
                    (valorSelecionado === 'RECUPERACAO' || 
                     (parseInt(valorSelecionado) <= numeroAvaliacoes && !avaliacoesCriadas.includes(parseInt(valorSelecionado))))
                );
                if (opcaoValida) {
                    posicaoSelect.value = valorSelecionado;
                    // Disparar evento change manualmente para atualizar lista de alunos
                    posicaoSelect.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    // Se o valor anterior não for mais válido, selecionar primeira opção disponível
                    if (posicaoSelect.options.length > 1) {
                        posicaoSelect.value = posicaoSelect.options[1].value;
                        // Disparar evento change manualmente
                        posicaoSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
            
            console.log(`Opções de posição atualizadas: ${numeroAvaliacoes} avaliação(ões) permitida(s) para disciplina com ${data.carga_horaria || 'N/A'} horas`);
            if (avaliacoesCriadas.length > 0) {
                console.log(`Avaliações já criadas (excluídas): ${avaliacoesCriadas.join(', ')}`);
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar opções de posição:', error);
        });
    }
    
    // Adicionar listener para mudança de disciplina
    if (disciplinaSelect) {
        disciplinaSelect.addEventListener('change', function() {
            const disciplinaId = this.value;
            const turmaId = turmaSelect ? turmaSelect.value : null;
            
            // Atualizar opções de posição da avaliação (passar turma_id para verificar notas)
            atualizarOpcoesPosicaoAvaliacao(disciplinaId, turmaId);
            
            // Verificar se já há alunos na página antes de recarregar
            const alunosTableBody = document.getElementById('alunos-table-body');
            const jaTemAlunos = alunosTableBody && alunosTableBody.querySelectorAll('tr').length > 0;
            let temValoresPreenchidos = false;
            if (alunosTableBody) {
                const inputsNota = alunosTableBody.querySelectorAll('input[type="number"][name^="nota_"]');
                for (let i = 0; i < inputsNota.length; i++) {
                    if (inputsNota[i].name !== 'nota_maxima' && inputsNota[i].value && inputsNota[i].value.trim() !== '') {
                        temValoresPreenchidos = true;
                        break;
                    }
                }
            }
            
            // Sempre atualizar lista quando disciplina mudar (especialmente se recuperação estiver selecionada)
            const posicaoSelect = document.getElementById('id_posicao_avaliacao');
            const posicao = posicaoSelect ? posicaoSelect.value : null;
            const eRecuperacao = posicao === 'RECUPERACAO';
            
            // Se for recuperação ou não houver valores preenchidos, recarregar
            if (eRecuperacao || !jaTemAlunos || !temValoresPreenchidos) {
                atualizarListaAlunos();
            } else {
                console.log('Disciplina mudou, mas há valores preenchidos, não recarregando alunos');
            }
        });
    }
    
    // Adicionar listener para mudança de posição da avaliação
    const posicaoSelect = document.getElementById('id_posicao_avaliacao');
    if (posicaoSelect) {
        posicaoSelect.addEventListener('change', function() {
            const posicao = this.value;
            console.log('=== POSIÇÃO DA AVALIAÇÃO MUDOU ===');
            console.log('Nova posição:', posicao);
            console.log('É recuperação?', posicao === 'RECUPERACAO');
            console.log('Disciplina selecionada:', disciplinaSelect ? disciplinaSelect.value : 'N/A');
            console.log('==================================');
            atualizarListaAlunos();
        });
    }
    
    // Verificar se há uma turma pré-selecionada e carregar disciplinas automaticamente
    // Mas só se não houver alunos já carregados (evitar recarregar após erro de validação)
    if (turmaSelect && turmaSelect.value) {
        const alunosTableBody = document.getElementById('alunos-table-body');
        const jaTemAlunos = alunosTableBody && alunosTableBody.querySelectorAll('tr').length > 0;
        
        // Verificar se há valores preenchidos nos campos de nota (indicando erro de validação)
        let temValoresPreenchidos = false;
        if (alunosTableBody) {
            const inputsNota = alunosTableBody.querySelectorAll('input[type="number"][name^="nota_"]');
            for (let i = 0; i < inputsNota.length; i++) {
                if (inputsNota[i].name !== 'nota_maxima' && inputsNota[i].value && inputsNota[i].value.trim() !== '') {
                    temValoresPreenchidos = true;
                    break;
                }
            }
        }
        
        if (!jaTemAlunos) {
            console.log('Turma pré-selecionada encontrada:', turmaSelect.value);
            // Sempre carregar via AJAX para garantir que as disciplinas estejam atualizadas
            setTimeout(() => {
                carregarDisciplinasTurma(turmaSelect.value);
                atualizarListaAlunos();
                
                // Se houver disciplina pré-selecionada, atualizar posição após carregar
                setTimeout(() => {
                    if (disciplinaSelect && disciplinaSelect.value) {
                        // Atualizar opções de posição antes de disparar o evento change
                        atualizarOpcoesPosicaoAvaliacao(disciplinaSelect.value, turmaSelect.value);
                        disciplinaSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }, 500);
            }, 300);
        } else {
            if (temValoresPreenchidos) {
                console.log('Alunos já carregados com valores preenchidos (erro de validação), não recarregando');
            } else {
                console.log('Alunos já carregados na página, não recarregando automaticamente');
            }
            // Atualizar opções de posição se houver disciplina selecionada
            if (disciplinaSelect && disciplinaSelect.value) {
                atualizarOpcoesPosicaoAvaliacao(disciplinaSelect.value, turmaSelect.value);
            }
            // Apenas atualizar nota máxima se necessário
            setTimeout(() => {
                atualizarNotaMaxima();
            }, 100);
        }
    }
    
    // Atualizar nota máxima quando a disciplina for selecionada
    const notaMaximaField = document.getElementById('id_nota_maxima');
    
    function atualizarNotaMaxima() {
        const notaMaxima = notaMaximaField ? notaMaximaField.value : null;
        if (notaMaxima) {
            // Atualizar todos os campos de nota (excluir nota_maxima)
            const todosNotaInputs = document.querySelectorAll('input[name^="nota_"], input.nota-input');
            const notaInputs = Array.from(todosNotaInputs).filter(input => input.name !== 'nota_maxima');
            notaInputs.forEach(input => {
                input.setAttribute('max', notaMaxima);
                const alunoId = input.getAttribute('data-aluno-id') || input.name.replace('nota_', '');
                const maxSpan = document.getElementById('max_nota_' + alunoId);
                if (maxSpan) {
                    maxSpan.textContent = notaMaxima;
                }
            });
        }
    }
    
    if (notaMaximaField) {
        notaMaximaField.addEventListener('change', atualizarNotaMaxima);
        notaMaximaField.addEventListener('input', atualizarNotaMaxima);
    }
    
    // Atualizar quando a disciplina mudar
    if (disciplinaSelect) {
        disciplinaSelect.addEventListener('change', function() {
            setTimeout(atualizarNotaMaxima, 500);
        });
    }
    
    // Atualizar inicialmente se já houver valor
    setTimeout(atualizarNotaMaxima, 1000);
    
    // Se já houver disciplina selecionada, disparar o evento
    if (disciplinaSelect && disciplinaSelect.value) {
        disciplinaSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }
});
</script>
{% endblock %}

