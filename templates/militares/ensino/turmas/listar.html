{% extends 'base.html' %}
{% load static %}

{% block title %}Turmas - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Turmas
                </h1>
                {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                <button type="button" class="btn btn-primary" id="btnCriarTurma">
                    <i class="fas fa-plus me-2"></i>
                    Nova Turma
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            {% if is_apk or request.GET.apk %}
            <div class="d-grid gap-3">
                {% for turma in turmas %}
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">{{ turma.curso.nome }}</div>
                                {% if turma.curso.codigo %}
                                <div class="text-muted">{{ turma.curso.codigo }}</div>
                                {% endif %}
                                <div class="mt-1">
                                    {% if turma.edicao %}
                                    <span class="badge bg-info">{{ turma.edicao.nome }}</span>
                                    {% endif %}
                                    <span class="badge bg-secondary">{{ turma.identificacao }}</span>
                                    <span class="badge bg-dark">{{ turma.total_alunos|default:0 }} alunos</span>
                                </div>
                                <div class="mt-2 text-muted">
                                    Início: {{ turma.data_inicio|date:"d/m/Y"|default:"-" }} • Fim: {{ turma.data_fim|date:"d/m/Y"|default:"-" }}
                                </div>
                            </div>
                            <div>
                                {% if turma.ativa %}
                                <span class="badge bg-success">Ativa</span>
                                {% else %}
                                <span class="badge bg-secondary">Inativa</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            {% if menu_permissions.ENSINO_VISUALIZAR or user.is_superuser %}
                            <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}?apk=1" class="btn btn-outline-info">
                                <i class="fas fa-eye me-1"></i>Ver detalhes
                            </a>
                            {% endif %}
                            {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                            <button type="button" class="btn btn-outline-warning btn-editar-turma-lista" data-turma-id="{{ turma.pk }}">
                                <i class="fas fa-edit me-1"></i>Editar turma
                            </button>
                            {% endif %}
                            {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                            <a href="{% url 'militares:ensino_aula_criar' %}?turma_id={{ turma.pk }}&apk=1" class="btn btn-outline-success">
                                <i class="fas fa-chalkboard-teacher me-1"></i>Nova aula
                            </a>
                            {% endif %}
                            {% if menu_permissions.ENSINO_EXCLUIR or user.is_superuser %}
                            <button type="button" class="btn btn-outline-danger btn-excluir-turma-lista" data-turma-id="{{ turma.pk }}" data-turma-nome="{{ turma.identificacao }}">
                                <i class="fas fa-trash me-1"></i>Excluir
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted">
                    Nenhuma turma cadastrada.
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Curso</th>
                            <th>Edição</th>
                            <th>Turma</th>
                            <th>Alunos</th>
                            <th>Data Início</th>
                            <th>Data Fim</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for turma in turmas %}
                        <tr>
                            <td>
                                <strong>{{ turma.curso.nome }}</strong>
                                {% if turma.curso.codigo %}
                                    <br><small class="text-muted">{{ turma.curso.codigo }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if turma.edicao %}
                                    <span class="badge bg-info">{{ turma.edicao.nome }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ turma.identificacao }}</strong></td>
                            <td class="text-center">
                                <span class="badge bg-secondary">{{ turma.total_alunos|default:0 }}</span>
                            </td>
                            <td>{{ turma.data_inicio|date:"d/m/Y"|default:"-" }}</td>
                            <td>{{ turma.data_fim|date:"d/m/Y"|default:"-" }}</td>
                            <td>
                                {% if turma.ativa %}
                                    <span class="badge bg-success">Ativa</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inativa</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    {% if menu_permissions.ENSINO_VISUALIZAR or user.is_superuser %}
                                    <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="btn btn-sm btn-info" title="Ver detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                    {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                    <button type="button" class="btn btn-sm btn-warning btn-editar-turma-lista" data-turma-id="{{ turma.pk }}" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                    {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                                    <a href="{% url 'militares:ensino_aula_criar' %}?turma_id={{ turma.pk }}" class="btn btn-sm btn-success" title="Nova Aula">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                    </a>
                                    {% endif %}
                                    {% if menu_permissions.ENSINO_EXCLUIR or user.is_superuser %}
                                    <button type="button" class="btn btn-sm btn-danger btn-excluir-turma-lista" data-turma-id="{{ turma.pk }}" data-turma-nome="{{ turma.identificacao }}" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhuma turma cadastrada.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Criar Turma -->
<div class="modal fade" id="criarTurmaModal" tabindex="-1" aria-labelledby="criarTurmaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" id="criarTurmaModalContent">
            <!-- Conteúdo será carregado via AJAX -->
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando formulário...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Turma (da lista) -->
<div class="modal fade" id="editarTurmaModalLista" tabindex="-1" aria-labelledby="editarTurmaModalListaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" id="editarTurmaModalListaContent">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando formulário...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Desligar Aluno -->
<div class="modal fade" id="desligarAlunoModalDetalhes" tabindex="-1" aria-labelledby="desligarAlunoModalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="desligarAlunoModalDetalhesLabel">
                    <i class="fas fa-user-times me-2"></i>
                    Desligar Aluno
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="post" id="formDesligarAlunoDetalhes" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Tem certeza que deseja desligar o aluno <strong id="aluno-nome-desligar-detalhes"></strong> (Matrícula: <strong id="aluno-matricula-desligar-detalhes"></strong>)?
                    </div>
                    
                    <div class="mb-3">
                        <label for="data_desligamento_detalhes" class="form-label">
                            Data de Desligamento <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="data_desligamento_detalhes" name="data_desligamento" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivo_desligamento_detalhes" class="form-label">
                            Motivo/Justificativa do Desligamento <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="motivo_desligamento_detalhes" name="motivo_desligamento" rows="5" required placeholder="Descreva o motivo e a justificativa do desligamento do aluno..."></textarea>
                        <small class="form-text text-muted">Campo obrigatório. Descreva detalhadamente o motivo do desligamento.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            Documentos Anexos (Processos Disciplinares, Atestados, etc.)
                        </label>
                        <div id="documentos-container">
                            <div class="documento-item mb-2">
                                <div class="row">
                                    <div class="col-md-4">
                                        <select class="form-select form-select-sm tipo-documento" name="tipo_documento[]">
                                            <option value="PROCESSO_DISCIPLINAR">Processo Disciplinar</option>
                                            <option value="TERMO_DESLIGAMENTO">Termo de Desligamento</option>
                                            <option value="NOTIFICACAO">Notificação</option>
                                            <option value="ADVERTENCIA">Advertência</option>
                                            <option value="SUSPENSAO">Suspensão</option>
                                            <option value="RELATORIO">Relatório</option>
                                            <option value="PARECER">Parecer</option>
                                            <option value="DECISAO">Decisão</option>
                                            <option value="PORTARIA">Portaria</option>
                                            <option value="OFICIO">Ofício</option>
                                            <option value="ATA">Ata</option>
                                            <option value="ATESTADO">Atestado Médico</option>
                                            <option value="LAUDO">Laudo</option>
                                            <option value="AUTORIZACAO">Autorização</option>
                                            <option value="DECLARACAO">Declaração</option>
                                            <option value="HISTORICO">Histórico Escolar</option>
                                            <option value="OUTROS">Outros</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control form-control-sm nome-documento" name="nome_documento[]" placeholder="Nome do documento (ex: Processo Disciplinar)">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="file" class="form-control form-control-sm arquivo-documento" name="arquivo_documento[]" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="adicionar-documento">
                            <i class="fas fa-plus me-1"></i> Adicionar Mais Documentos
                        </button>
                        <small class="form-text text-muted d-block mt-2">
                            Você pode anexar múltiplos documentos (PDF, DOC, DOCX, JPG, PNG). Máximo 10MB por arquivo.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-user-times me-2"></i>
                        Confirmar Desligamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Excluir Turma -->
<div class="modal fade" id="excluirTurmaModal" tabindex="-1" aria-labelledby="excluirTurmaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="excluirTurmaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a turma <strong id="turmaExcluirNome"></strong>?</p>
                <p class="text-danger"><small>Esta ação não pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formExcluirTurma" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
        const criarTurmaBtn = document.getElementById('btnCriarTurma');
        const criarTurmaModal = document.getElementById('criarTurmaModal');
        const criarTurmaModalContent = document.getElementById('criarTurmaModalContent');
        
        if (!criarTurmaBtn || !criarTurmaModal || !criarTurmaModalContent) {
            console.error('Elementos não encontrados');
            return;
        }
        
        function carregarFormularioCriacao() {
            criarTurmaModalContent.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            `;
            
            const url = '{% url "militares:ensino_turma_criar" %}';
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Erro HTTP: ' + response.status);
                }
                return response.text();
            })
            .then(function(html) {
                criarTurmaModalContent.innerHTML = html;
                
                setTimeout(function() {
                    // Adicionar listener para filtrar edições quando curso for selecionado
                    const cursoSelect = criarTurmaModalContent.querySelector('#id_curso');
                    const edicaoSelect = criarTurmaModalContent.querySelector('#id_edicao');
                    
                    if (cursoSelect && edicaoSelect) {
                        cursoSelect.addEventListener('change', function() {
                            const cursoId = this.value;
                            
                            if (!cursoId) {
                                edicaoSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                                edicaoSelect.disabled = true;
                                return;
                            }
                            
                            // Buscar edições do curso
                            fetch(`{% url 'militares:ensino_edicoes_por_curso_json' curso_id=0 %}`.replace('0', cursoId), {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                edicaoSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                                
                                if (data.edicoes && data.edicoes.length > 0) {
                                    edicaoSelect.disabled = false;
                                    data.edicoes.forEach(edicao => {
                                        const option = document.createElement('option');
                                        option.value = edicao.id;
                                        option.textContent = edicao.nome;
                                        edicaoSelect.appendChild(option);
                                    });
                                } else {
                                    edicaoSelect.disabled = false;
                                    const option = document.createElement('option');
                                    option.value = '';
                                    option.textContent = 'Nenhuma edição disponível';
                                    edicaoSelect.appendChild(option);
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao carregar edições:', error);
                                edicaoSelect.innerHTML = '<option value="">Erro ao carregar edições</option>';
                            });
                        });
                    }
                    
                    // Executar scripts existentes
                    const scripts = criarTurmaModalContent.querySelectorAll('script');
                    scripts.forEach(function(oldScript) {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(function(attr) {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        if (oldScript.parentNode) {
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        }
                    });
                }, 100);
            })
            .catch(function(error) {
                console.error('Erro ao carregar formulário:', error);
                criarTurmaModalContent.innerHTML = `
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Erro
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5>Erro ao Carregar</h5>
                        <p class="text-muted">Não foi possível carregar o formulário. Tente novamente.</p>
                        <p class="text-muted"><small>Erro: ${error.message}</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                `;
            });
        }
        
        criarTurmaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    var modalInstance = bootstrap.Modal.getInstance(criarTurmaModal);
                    if (!modalInstance) {
                        modalInstance = new bootstrap.Modal(criarTurmaModal);
                    }
                    modalInstance.show();
                } catch (err) {
                    console.error('Erro ao abrir modal:', err);
                }
            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                $(criarTurmaModal).modal('show');
            }
        });
        
        criarTurmaModal.addEventListener('show.bs.modal', function(event) {
            carregarFormularioCriacao();
        });
        
        criarTurmaModal.addEventListener('hidden.bs.modal', function() {
            criarTurmaModalContent.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            `;
        });
        
        // Botões de ação da lista
        // Editar
        document.querySelectorAll('.btn-editar-turma-lista').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const turmaId = this.getAttribute('data-turma-id');
                const editarModal = document.getElementById('editarTurmaModalLista');
                const editarModalContent = document.getElementById('editarTurmaModalListaContent');
                
                if (!editarModal || !editarModalContent) return;
                
                editarModalContent.innerHTML = `
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3 text-muted">Carregando formulário...</p>
                    </div>
                `;
                
                fetch('/militares/ensino/turmas/' + turmaId + '/editar/', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Erro HTTP: ' + response.status);
                    }
                    return response.text();
                })
                .then(function(html) {
                    editarModalContent.innerHTML = html;
                    
                    setTimeout(function() {
                        const scripts = editarModalContent.querySelectorAll('script');
                        scripts.forEach(function(oldScript) {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(function(attr) {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            if (oldScript.parentNode) {
                                oldScript.parentNode.replaceChild(newScript, oldScript);
                            }
                        });
                        
                        // Inicializar Select2 após carregar o formulário
                        setTimeout(function() {
                            if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
                                $('.militar-select2').select2({
                                    placeholder: 'Digite o nome, matrícula ou posto do militar...',
                                    allowClear: true,
                                    minimumInputLength: 2,
                                    dropdownParent: $('#editarTurmaModalLista'),
                                    ajax: {
                                        url: '/militares/militar-autocomplete/',
                                        dataType: 'json',
                                        delay: 250,
                                        data: function (params) {
                                            return {
                                                q: params.term
                                            };
                                        },
                                        processResults: function (data) {
                                            return {
                                                results: data.results
                                            };
                                        },
                                        cache: true
                                    },
                                    language: {
                                        inputTooShort: function () {
                                            return 'Digite pelo menos 2 caracteres...';
                                        },
                                        noResults: function () {
                                            return 'Nenhum militar encontrado';
                                        },
                                        searching: function () {
                                            return 'Buscando...';
                                        }
                                    }
                                });
                            }
                        }, 200);
                        
                        // Corrigir valores de data após carregar o formulário
                        var dataInicioField = document.getElementById('id_data_inicio');
                        var dataFimField = document.getElementById('id_data_fim');
                        
                        if (dataInicioField && dataInicioField.value) {
                            var dataInicio = dataInicioField.value;
                            if (dataInicio && dataInicio.indexOf('/') !== -1) {
                                var partes = dataInicio.split('/');
                                if (partes.length === 3) {
                                    dataInicioField.value = partes[2] + '-' + partes[1] + '-' + partes[0];
                                }
                            }
                        }
                        
                        if (dataFimField && dataFimField.value) {
                            var dataFim = dataFimField.value;
                            if (dataFim && dataFim.indexOf('/') !== -1) {
                                var partes = dataFim.split('/');
                                if (partes.length === 3) {
                                    dataFimField.value = partes[2] + '-' + partes[1] + '-' + partes[0];
                                }
                            }
                        }
                        
                        // Carregar alunos existentes após o modal ser carregado
                        setTimeout(function() {
                            console.log('Tentando carregar alunos existentes...');
                            if (typeof window.carregarAlunosExistentes === 'function') {
                                console.log('Função encontrada, executando...');
                                window.carregarAlunosExistentes();
                            } else {
                                console.log('Função carregarAlunosExistentes não encontrada');
                            }
                        }, 500);
                    }, 100);
                })
                .catch(function(error) {
                    console.error('Erro ao carregar formulário:', error);
                    editarModalContent.innerHTML = `
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>Erro
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h5>Erro ao Carregar</h5>
                            <p class="text-muted">Não foi possível carregar o formulário. Tente novamente.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    `;
                });
                
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modalInstance = new bootstrap.Modal(editarModal);
                    modalInstance.show();
                }
            });
        });
        
        // Excluir
        document.querySelectorAll('.btn-excluir-turma-lista').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const turmaId = this.getAttribute('data-turma-id');
                const turmaNome = this.getAttribute('data-turma-nome');
                const excluirModal = document.getElementById('excluirTurmaModal');
                const formExcluir = document.getElementById('formExcluirTurma');
                const turmaNomeSpan = document.getElementById('turmaExcluirNome');
                
                if (turmaNomeSpan) {
                    turmaNomeSpan.textContent = turmaNome;
                }
                
                if (formExcluir) {
                    formExcluir.action = '/militares/ensino/turmas/' + turmaId + '/excluir/';
                }
                
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modalInstance = new bootstrap.Modal(excluirModal);
                    modalInstance.show();
                }
            });
        });
        
        // Botão Desligar Aluno - usando event delegation no documento
        // Funciona mesmo quando o conteúdo é carregado dinamicamente
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-desligar-aluno-modal');
            if (!btn) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const alunoId = btn.getAttribute('data-aluno-id');
            const alunoNome = btn.getAttribute('data-aluno-nome');
            const alunoMatricula = btn.getAttribute('data-aluno-matricula');
            
            const nomeElement = document.getElementById('aluno-nome-desligar-detalhes');
            const matriculaElement = document.getElementById('aluno-matricula-desligar-detalhes');
            const formElement = document.getElementById('formDesligarAlunoDetalhes');
            
            if (nomeElement) nomeElement.textContent = alunoNome || 'N/A';
            if (matriculaElement) matriculaElement.textContent = alunoMatricula || 'N/A';
            if (formElement) formElement.action = '/militares/ensino/alunos/' + alunoId + '/desligar/';
            
            // Definir data atual como padrão
            const hoje = new Date().toISOString().split('T')[0];
            const dataElement = document.getElementById('data_desligamento_detalhes');
            if (dataElement) dataElement.value = hoje;
            
            // Limpar documentos anteriores
            const container = document.getElementById('documentos-container');
            if (container) {
                container.innerHTML = `
                    <div class="documento-item mb-2">
                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-select form-select-sm tipo-documento" name="tipo_documento[]">
                                    <option value="PROCESSO_DISCIPLINAR">Processo Disciplinar</option>
                                    <option value="TERMO_DESLIGAMENTO">Termo de Desligamento</option>
                                    <option value="NOTIFICACAO">Notificação</option>
                                    <option value="ADVERTENCIA">Advertência</option>
                                    <option value="SUSPENSAO">Suspensão</option>
                                    <option value="RELATORIO">Relatório</option>
                                    <option value="PARECER">Parecer</option>
                                    <option value="DECISAO">Decisão</option>
                                    <option value="PORTARIA">Portaria</option>
                                    <option value="OFICIO">Ofício</option>
                                    <option value="ATA">Ata</option>
                                    <option value="ATESTADO">Atestado Médico</option>
                                    <option value="LAUDO">Laudo</option>
                                    <option value="AUTORIZACAO">Autorização</option>
                                    <option value="DECLARACAO">Declaração</option>
                                    <option value="HISTORICO">Histórico Escolar</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm nome-documento" name="nome_documento[]" placeholder="Nome do documento">
                            </div>
                            <div class="col-md-3">
                                <input type="file" class="form-control form-control-sm arquivo-documento" name="arquivo_documento[]" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const desligarModal = document.getElementById('desligarAlunoModalDetalhes');
            if (desligarModal && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = new bootstrap.Modal(desligarModal);
                modal.show();
            }
        });
        
        // Adicionar mais documentos - usando event delegation
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('#adicionar-documento');
            if (!btn) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const container = document.getElementById('documentos-container');
            if (!container) return;
            
            const novoItem = document.createElement('div');
            novoItem.className = 'documento-item mb-2';
            novoItem.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <select class="form-select form-select-sm tipo-documento" name="tipo_documento[]">
                            <option value="PROCESSO_DISCIPLINAR">Processo Disciplinar</option>
                            <option value="TERMO_DESLIGAMENTO">Termo de Desligamento</option>
                            <option value="NOTIFICACAO">Notificação</option>
                            <option value="ADVERTENCIA">Advertência</option>
                            <option value="SUSPENSAO">Suspensão</option>
                            <option value="RELATORIO">Relatório</option>
                            <option value="PARECER">Parecer</option>
                            <option value="DECISAO">Decisão</option>
                            <option value="PORTARIA">Portaria</option>
                            <option value="OFICIO">Ofício</option>
                            <option value="ATA">Ata</option>
                            <option value="ATESTADO">Atestado Médico</option>
                            <option value="LAUDO">Laudo</option>
                            <option value="AUTORIZACAO">Autorização</option>
                            <option value="DECLARACAO">Declaração</option>
                            <option value="HISTORICO">Histórico Escolar</option>
                            <option value="OUTROS">Outros</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control form-control-sm nome-documento" name="nome_documento[]" placeholder="Nome do documento">
                    </div>
                    <div class="col-md-2">
                        <input type="file" class="form-control form-control-sm arquivo-documento" name="arquivo_documento[]" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger remover-documento" title="Remover">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(novoItem);
        });
        
        // Remover documento (delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remover-documento')) {
                e.target.closest('.documento-item').remove();
            }
        });
        
        // Submissão do formulário de desligamento
        const formDesligar = document.getElementById('formDesligarAlunoDetalhes');
        if (formDesligar) {
            formDesligar.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    }
                    return response.json().then(function(data) {
                        throw new Error(data.error || 'Erro ao desligar aluno');
                    });
                })
                .then(function(data) {
                    if (data.success) {
                        // Fechar modal e recarregar
                        const desligarModal = bootstrap.Modal.getInstance(document.getElementById('desligarAlunoModalDetalhes'));
                        if (desligarModal) {
                            desligarModal.hide();
                        }
                        // Recarregar a página para atualizar a lista
                        location.reload();
                    } else {
                        throw new Error(data.error || 'Erro ao desligar aluno');
                    }
                })
                .catch(function(error) {
                    console.error('Erro:', error);
                    alert('Erro ao desligar aluno: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        }
    });
})();
</script>
{% endblock %}

