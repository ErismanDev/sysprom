{% extends 'base.html' %}
{% load static %}

{% block title %}Quadros de Trabalho Semanal - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-calendar-week me-2"></i>
                    Quadros de Trabalho Semanal
                </h1>
                <div>
                    {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                    <a href="{% url 'militares:ensino_quadro_trabalho_semanal_criar' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Novo Quadro
                    </a>
                    {% endif %}
                    <a href="{% url 'militares:ensino_turmas_listar' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="turma" class="form-label">Turma</label>
                            <select name="turma" id="turma" class="form-select">
                                <option value="">Todas as turmas</option>
                                {% for turma in turmas %}
                                <option value="{{ turma.pk }}" {% if turma_filtro == turma.pk %}selected{% endif %}>
                                    {{ turma.identificacao }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="data_inicio" class="form-label">Data de Início</label>
                            <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio_filtro }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-2"></i>
                                Filtrar
                            </button>
                            <a href="{% url 'militares:ensino_quadros_trabalho_semanal_listar' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Quadros -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if quadros %}
                        {% if is_apk or request.GET.apk %}
                        <div class="d-grid gap-3">
                            {% for quadro in quadros %}
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-bold">Nº {{ quadro.get_numero_completo }}</div>
                                            <div class="text-muted">{{ quadro.turma.identificacao }} • {{ quadro.turma.curso.nome }}</div>
                                            <div class="mt-1">{{ quadro.data_inicio_semana|date:"d/m/Y" }} a {{ quadro.data_fim_semana|date:"d/m/Y" }}</div>
                                            <div class="mt-1 text-muted">Local: {{ quadro.local|default:"-" }}</div>
                                            <div class="mt-1"><span class="badge bg-primary">{{ quadro.aulas.count }} aula(s)</span></div>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2 mt-3">
                                        {% if menu_permissions.ENSINO_VISUALIZAR or user.is_superuser %}
                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_visualizar' pk=quadro.pk %}?apk=1" class="btn btn-outline-info">
                                            <i class="fas fa-eye me-1"></i>Visualizar
                                        </a>
                                        {% endif %}
                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_pdf' pk=quadro.pk %}" class="btn btn-outline-success" target="_blank">
                                            <i class="fas fa-file-pdf me-1"></i>PDF
                                        </a>
                                        {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_editar' pk=quadro.pk %}?apk=1" class="btn btn-outline-warning">
                                            <i class="fas fa-edit me-1"></i>Editar
                                        </a>
                                        {% endif %}
                                        {% if user.is_superuser %}
                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_deletar' pk=quadro.pk %}" class="btn btn-outline-danger">
                                            <i class="fas fa-trash me-1"></i>Deletar
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nº</th>
                                        <th>Turma</th>
                                        <th>Curso</th>
                                        <th>Período</th>
                                        <th>Local</th>
                                        <th>Total de Aulas</th>
                                        <th>Revisão</th>
                                        <th>Aprovação</th>
                                        <th>Data/Hora Criação Aditamento</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for quadro in quadros %}
                                    <tr>
                                        <td><strong>Nº {{ quadro.get_numero_completo }}</strong></td>
                                        <td>
                                            <a href="{% url 'militares:ensino_turma_detalhes' pk=quadro.turma.pk %}" class="text-decoration-none">
                                                {{ quadro.turma.identificacao }}
                                            </a>
                                        </td>
                                        <td>{{ quadro.turma.curso.nome }}</td>
                                        <td>
                                            {{ quadro.data_inicio_semana|date:"d/m/Y" }} a {{ quadro.data_fim_semana|date:"d/m/Y" }}
                                        </td>
                                        <td>{{ quadro.local|default:"-" }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ quadro.aulas.count }} aula(s)</span>
                                        </td>
                                        <td>
                                            {% if quadro.tem_revisao %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="assinarRevisaoQTS({{ quadro.pk }})"
                                                        title="Assinar como Revisor">
                                                    <i class="fas fa-signature"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if quadro.tem_aprovacao %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% elif quadro.tem_revisao %}
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="assinarAprovacaoQTS({{ quadro.pk }})"
                                                        title="Assinar como Aprovador">
                                                    <i class="fas fa-signature"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-secondary" disabled
                                                        title="O QTS precisa ser revisado antes de ser aprovado">
                                                    <i class="fas fa-signature"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ quadro.data_criacao|date:"d/m/Y H:i" }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if menu_permissions.ENSINO_VISUALIZAR or user.is_superuser %}
                                                <a href="{% url 'militares:ensino_quadro_trabalho_semanal_visualizar' pk=quadro.pk %}?next={{ request.get_full_path }}" class="btn btn-sm btn-info" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                                <a href="{% url 'militares:ensino_quadro_trabalho_semanal_pdf' pk=quadro.pk %}" class="btn btn-sm btn-success" title="Gerar PDF" target="_blank">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                                {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                                    {% if quadro.tem_aprovacao %}
                                                        {% for assinatura in quadro.assinaturas.all %}
                                                            {% if assinatura.tipo_assinatura == 'APROVACAO' %}
                                                                {% if user.is_superuser or assinatura.assinado_por == user %}
                                                                    <a href="{% url 'militares:ensino_quadro_trabalho_semanal_editar' pk=quadro.pk %}" class="btn btn-sm btn-warning" title="Editar">
                                                                        <i class="fas fa-edit"></i>
                                                                    </a>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_editar' pk=quadro.pk %}" class="btn btn-sm btn-warning" title="Editar">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                                {% if user.is_superuser %}
                                                <a href="{% url 'militares:ensino_quadro_trabalho_semanal_deletar' pk=quadro.pk %}" class="btn btn-sm btn-danger" title="Deletar">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhum quadro de trabalho semanal encontrado.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
  try{
    if(window.matchMedia && window.matchMedia('(max-width: 768px)').matches){
      var url = new URL(window.location.href);
      if(!url.searchParams.has('apk')){
        url.searchParams.set('apk','1');
        window.location.replace(url.toString());
      }
    }
  }catch(e){}
})();
</script>
<script>
// Funções para assinaturas do QTS
function assinarRevisaoQTS(quadroId) {
    // Buscar dados do QTS via AJAX
    fetch(`/militares/ensino/quadros-trabalho-semanal/${quadroId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informações do QTS no modal
                document.getElementById('qtsId').value = quadroId;
                document.getElementById('qtsNumero').textContent = data.quadro.numero || '-';
                document.getElementById('qtsTurma').textContent = data.quadro.turma || '-';
                
                // Preencher opções de função
                const funcaoSelect = document.getElementById('funcao_assinatura_modal_qts');
                funcaoSelect.innerHTML = '<option value="">Selecione uma função...</option>';
                data.funcoes_usuario.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.nome;
                    option.textContent = funcao.nome;
                    if (funcao.ativo) {
                        option.selected = true;
                    }
                    funcaoSelect.appendChild(option);
                });
                
                // Limpar campos do formulário
                document.getElementById('observacoes_modal_qts').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAssinarRevisaoQTS'));
                modal.show();
            } else {
                alert('Erro ao carregar dados do QTS: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados do QTS. Tente novamente.');
        });
}

function assinarAprovacaoQTS(quadroId) {
    // Buscar dados do QTS via AJAX
    fetch(`/militares/ensino/quadros-trabalho-semanal/${quadroId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informações do QTS no modal
                document.getElementById('qtsIdAprovacao').value = quadroId;
                document.getElementById('qtsNumeroAprovacao').textContent = data.quadro.numero || '-';
                document.getElementById('qtsTurmaAprovacao').textContent = data.quadro.turma || '-';
                
                // Preencher opções de função
                const funcaoSelect = document.getElementById('funcao_assinatura_modal_qts_aprovacao');
                funcaoSelect.innerHTML = '<option value="">Selecione uma função...</option>';
                data.funcoes_usuario.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.nome;
                    option.textContent = funcao.nome;
                    if (funcao.ativo) {
                        option.selected = true;
                    }
                    funcaoSelect.appendChild(option);
                });
                
                // Limpar campos do formulário
                document.getElementById('observacoes_modal_qts_aprovacao').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAssinarAprovacaoQTS'));
                modal.show();
            } else {
                alert('Erro ao carregar dados do QTS: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados do QTS. Tente novamente.');
        });
}

// Event listeners para os botões de confirmação
document.addEventListener('DOMContentLoaded', function() {
    const btnConfirmarRevisao = document.getElementById('btnConfirmarAssinaturaRevisaoQTS');
    if (btnConfirmarRevisao) {
        btnConfirmarRevisao.addEventListener('click', function() {
            const form = document.getElementById('formAssinaturaRevisaoQTS');
            const formData = new FormData(form);
            const quadroId = document.getElementById('qtsId').value;
            
            fetch(`/militares/ensino/quadros-trabalho-semanal/${quadroId}/assinar-revisao/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'QTS assinado como Revisor com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao assinar QTS. Tente novamente.');
            });
        });
    }
    
    const btnConfirmarAprovacao = document.getElementById('btnConfirmarAssinaturaAprovacaoQTS');
    if (btnConfirmarAprovacao) {
        btnConfirmarAprovacao.addEventListener('click', function() {
            const form = document.getElementById('formAssinaturaAprovacaoQTS');
            const formData = new FormData(form);
            const quadroId = document.getElementById('qtsIdAprovacao').value;
            
            fetch(`/militares/ensino/quadros-trabalho-semanal/${quadroId}/assinar-aprovacao/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'QTS assinado como Aprovador com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao assinar QTS. Tente novamente.');
            });
        });
    }
});
</script>

<!-- Modal de Assinatura de Revisão QTS -->
<div class="modal fade" id="modalAssinarRevisaoQTS" tabindex="-1" aria-labelledby="modalAssinarRevisaoQTSLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white border-0">
                <h5 class="modal-title" id="modalAssinarRevisaoQTSLabel">
                    <i class="fas fa-signature me-2"></i>
                    Assinar QTS como Revisor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informações do QTS -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informações do Quadro de Trabalho Semanal</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Número:</strong> <span id="qtsNumero">-</span></p>
                                        <p class="mb-2"><strong>Turma:</strong> <span id="qtsTurma">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Assinatura -->
                <form id="formAssinaturaRevisaoQTS">
                    {% csrf_token %}
                    <input type="hidden" id="qtsId" name="quadro_id">
                    
                    <!-- Campo para selecionar função -->
                    <div class="mb-3">
                        <label for="funcao_assinatura_modal_qts" class="form-label"><strong>Função para Assinatura *</strong></label>
                        <select class="form-select" id="funcao_assinatura_modal_qts" name="funcao_assinatura" required>
                            <option value="">Selecione uma função...</option>
                        </select>
                        <div class="form-text">Selecione a função que será exibida na assinatura do QTS.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_modal_qts" class="form-label">Observações (opcional)</label>
                        <textarea name="observacoes" id="observacoes_modal_qts" class="form-control" rows="3" placeholder="Observações sobre a assinatura..."></textarea>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> A assinatura eletrônica tem a mesma validade de uma assinatura física. 
                        Certifique-se de que todas as informações estão corretas antes de assinar.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-info" id="btnConfirmarAssinaturaRevisaoQTS">
                    <i class="fas fa-signature me-1"></i>
                    Assinar como Revisor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Assinatura de Aprovação QTS -->
<div class="modal fade" id="modalAssinarAprovacaoQTS" tabindex="-1" aria-labelledby="modalAssinarAprovacaoQTSLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title" id="modalAssinarAprovacaoQTSLabel">
                    <i class="fas fa-signature me-2"></i>
                    Assinar QTS como Aprovador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informações do QTS -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informações do Quadro de Trabalho Semanal</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Número:</strong> <span id="qtsNumeroAprovacao">-</span></p>
                                        <p class="mb-2"><strong>Turma:</strong> <span id="qtsTurmaAprovacao">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Assinatura -->
                <form id="formAssinaturaAprovacaoQTS">
                    {% csrf_token %}
                    <input type="hidden" id="qtsIdAprovacao" name="quadro_id">
                    
                    <!-- Campo para selecionar função -->
                    <div class="mb-3">
                        <label for="funcao_assinatura_modal_qts_aprovacao" class="form-label"><strong>Função para Assinatura *</strong></label>
                        <select class="form-select" id="funcao_assinatura_modal_qts_aprovacao" name="funcao_assinatura" required>
                            <option value="">Selecione uma função...</option>
                        </select>
                        <div class="form-text">Selecione a função que será exibida na assinatura do QTS.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_modal_qts_aprovacao" class="form-label">Observações (opcional)</label>
                        <textarea name="observacoes" id="observacoes_modal_qts_aprovacao" class="form-control" rows="3" placeholder="Observações sobre a assinatura..."></textarea>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> A assinatura eletrônica tem a mesma validade de uma assinatura física. 
                        Certifique-se de que todas as informações estão corretas antes de assinar.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAssinaturaAprovacaoQTS">
                    <i class="fas fa-signature me-1"></i>
                    Assinar como Aprovador
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


