{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Arma Particular{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-user-shield me-2 text-primary"></i>
                        {% if object %}Editar Arma Particular{% else %}Nova Arma Particular{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando arma {{ object.numero_serie }}{% else %}Cadastrar nova arma particular{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:arma_particular_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados da Arma Particular
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}
                                
                                <!-- Militar e Arma -->
                                <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Militar e Arma</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.militar.id_for_label }}" class="form-label">
                                            Militar <span class="text-danger">*</span>
                                        </label>
                                        {{ form.militar }}
                                        {% if form.militar.errors %}
                                            <div class="invalid-feedback d-block">{{ form.militar.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                                            Número de Série <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_serie }}
                                        {% if form.numero_serie.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_serie.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                            Tipo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.tipo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.calibre.id_for_label }}" class="form-label">
                                            Calibre <span class="text-danger">*</span>
                                        </label>
                                        {{ form.calibre }}
                                        {% if form.calibre.errors %}
                                            <div class="invalid-feedback d-block">{{ form.calibre.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            Status <span class="text-danger">*</span>
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.capacidade_carregador.id_for_label }}" class="form-label">
                                            Capacidade
                                        </label>
                                        {{ form.capacidade_carregador }}
                                        {% if form.capacidade_carregador.errors %}
                                            <div class="invalid-feedback d-block">{{ form.capacidade_carregador.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.marca.id_for_label }}" class="form-label">
                                            Marca <span class="text-danger">*</span>
                                        </label>
                                        {{ form.marca }}
                                        {% if form.marca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.marca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.modelo.id_for_label }}" class="form-label">
                                            Modelo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.modelo }}
                                        {% if form.modelo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.modelo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.numero_canhao.id_for_label }}" class="form-label">
                                            Nº Canhão
                                        </label>
                                        {{ form.numero_canhao }}
                                        {% if form.numero_canhao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_canhao.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Alma Raiada -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check">
                                            {{ form.alma_raiada }}
                                            <label class="form-check-label" for="{{ form.alma_raiada.id_for_label }}">
                                                {{ form.alma_raiada.label }}
                                            </label>
                                            {% if form.alma_raiada.help_text %}
                                                <small class="form-text text-muted d-block">{{ form.alma_raiada.help_text }}</small>
                                            {% endif %}
                                        </div>
                                        {% if form.alma_raiada.errors %}
                                            <div class="invalid-feedback d-block">{{ form.alma_raiada.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Campos de Raias -->
                                <div class="row" id="raias-campos" style="display: none;">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.quantidade_raias.id_for_label }}" class="form-label">
                                            Quantidade de Raias
                                        </label>
                                        {{ form.quantidade_raias }}
                                        {% if form.quantidade_raias.help_text %}
                                            <small class="form-text text-muted">{{ form.quantidade_raias.help_text }}</small>
                                        {% endif %}
                                        {% if form.quantidade_raias.errors %}
                                            <div class="invalid-feedback d-block">{{ form.quantidade_raias.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.direcao_raias.id_for_label }}" class="form-label">
                                            Direção das Raias
                                        </label>
                                        {{ form.direcao_raias }}
                                        {% if form.direcao_raias.help_text %}
                                            <small class="form-text text-muted">{{ form.direcao_raias.help_text }}</small>
                                        {% endif %}
                                        {% if form.direcao_raias.errors %}
                                            <div class="invalid-feedback d-block">{{ form.direcao_raias.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Documentação -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Documentação</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_registro_policia.id_for_label }}" class="form-label">
                                            Nº Registro SIGMA <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_registro_policia }}
                                        {% if form.numero_registro_policia.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_registro_policia.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_validade_registro.id_for_label }}" class="form-label">
                                            Data de Validade do Registro
                                        </label>
                                        {{ form.data_validade_registro }}
                                        {% if form.data_validade_registro.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_validade_registro.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_guia_transito.id_for_label }}" class="form-label">
                                            Nº Guia de Trânsito
                                        </label>
                                        {{ form.numero_guia_transito }}
                                        {% if form.numero_guia_transito.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_guia_transito.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_validade_guia.id_for_label }}" class="form-label">
                                            Data de Validade da Guia
                                        </label>
                                        {{ form.data_validade_guia }}
                                        {% if form.data_validade_guia.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_validade_guia.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Autorização para Uso no Serviço -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-shield-check me-2"></i>Autorização para Uso no Serviço</h5>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check">
                                            {{ form.autorizado_uso_servico }}
                                            <label class="form-check-label" for="{{ form.autorizado_uso_servico.id_for_label }}">
                                                Autorizado para uso no serviço
                                            </label>
                                        </div>
                                    </div>
                                    {% if form.autorizado_uso_servico.value %}
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_autorizacao.id_for_label }}" class="form-label">
                                            Data de Autorização
                                        </label>
                                        {{ form.data_autorizacao }}
                                        {% if form.data_autorizacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_autorizacao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_vencimento_autorizacao.id_for_label }}" class="form-label">
                                            Data de Vencimento da Autorização
                                        </label>
                                        {{ form.data_vencimento_autorizacao }}
                                        {% if form.data_vencimento_autorizacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_vencimento_autorizacao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Observações -->
                                <hr>
                                <div class="mb-3">
                                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
                                    {{ form.observacoes }}
                                    {% if form.observacoes.errors %}
                                        <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Ativo -->
                                <div class="mb-3 form-check">
                                    {{ form.ativo }}
                                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                        Arma ativa
                                    </label>
                                </div>
                                
                                <!-- Informações do Sistema (apenas na edição) -->
                                {% if object %}
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações do Sistema</h5>
                                <div class="row">
                                    {% if object.criado_por %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Criado por</label>
                                        <input type="text" class="form-control" value="{{ object.criado_por.get_full_name|default:object.criado_por.username }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_criacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Data de Criação</label>
                                        <input type="text" class="form-control" value="{{ object.data_criacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_atualizacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Última Atualização</label>
                                        <input type="text" class="form-control" value="{{ object.data_atualizacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                    <a href="{% url 'militares:arma_particular_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar campos de autorização baseado no checkbox
    const autorizadoCheckbox = document.getElementById('{{ form.autorizado_uso_servico.id_for_label }}');
    const dataAutorizacaoDiv = document.querySelector('[for="{{ form.data_autorizacao.id_for_label }}"]')?.closest('.col-md-4');
    const dataVencimentoDiv = document.querySelector('[for="{{ form.data_vencimento_autorizacao.id_for_label }}"]')?.closest('.col-md-4');
    
    function toggleAutorizacaoFields() {
        if (autorizadoCheckbox && autorizadoCheckbox.checked) {
            if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'block';
            if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'block';
        } else {
            if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'none';
            if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'none';
        }
    }
    
    if (autorizadoCheckbox) {
        autorizadoCheckbox.addEventListener('change', toggleAutorizacaoFields);
        toggleAutorizacaoFields();
    }
    
    // Garantir que as datas sejam carregadas corretamente na edição
    {% if object %}
    {% if object.data_validade_registro %}
    const dataValidadeRegistroInput = document.getElementById('{{ form.data_validade_registro.id_for_label }}');
    if (dataValidadeRegistroInput) {
        const dataObj = '{{ object.data_validade_registro|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataValidadeRegistroInput.value = dataObj;
        }
    }
    {% endif %}
    
    {% if object.data_validade_guia %}
    const dataValidadeGuiaInput = document.getElementById('{{ form.data_validade_guia.id_for_label }}');
    if (dataValidadeGuiaInput) {
        const dataObj = '{{ object.data_validade_guia|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataValidadeGuiaInput.value = dataObj;
        }
    }
    {% endif %}
    
    {% if object.data_autorizacao %}
    const dataAutorizacaoInput = document.getElementById('{{ form.data_autorizacao.id_for_label }}');
    if (dataAutorizacaoInput) {
        const dataObj = '{{ object.data_autorizacao|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataAutorizacaoInput.value = dataObj;
        }
    }
    {% endif %}
    
    {% if object.data_vencimento_autorizacao %}
    const dataVencimentoInput = document.getElementById('{{ form.data_vencimento_autorizacao.id_for_label }}');
    if (dataVencimentoInput) {
        const dataObj = '{{ object.data_vencimento_autorizacao|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataVencimentoInput.value = dataObj;
        }
    }
    {% endif %}
    {% endif %}
    
    // Mostrar/ocultar campos de raias baseado no checkbox
    const almaRaiadaCheckbox = document.getElementById('id_alma_raiada');
    const raiasCampos = document.getElementById('raias-campos');
    const quantidadeRaiasInput = document.getElementById('id_quantidade_raias');
    const direcaoRaiasSelect = document.getElementById('id_direcao_raias');
    
    function toggleRaiasCampos() {
        if (almaRaiadaCheckbox && raiasCampos) {
            if (almaRaiadaCheckbox.checked) {
                raiasCampos.style.display = 'block';
                if (quantidadeRaiasInput) {
                    quantidadeRaiasInput.required = true;
                }
                if (direcaoRaiasSelect) {
                    direcaoRaiasSelect.required = true;
                }
            } else {
                raiasCampos.style.display = 'none';
                if (quantidadeRaiasInput) {
                    quantidadeRaiasInput.required = false;
                    quantidadeRaiasInput.value = '';
                }
                if (direcaoRaiasSelect) {
                    direcaoRaiasSelect.required = false;
                    direcaoRaiasSelect.value = '';
                }
            }
        }
    }
    
    if (almaRaiadaCheckbox) {
        almaRaiadaCheckbox.addEventListener('change', toggleRaiasCampos);
        // Verificar estado inicial (útil quando editando uma arma existente)
        toggleRaiasCampos();
        
        // Se estiver editando e já houver valores, mostrar os campos
        {% if object and object.alma_raiada %}
        if (almaRaiadaCheckbox.checked) {
            raiasCampos.style.display = 'block';
        }
        {% endif %}
    }
    
    // Inicializar Select2 para o campo de militar
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term || ''
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results || []
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um militar já selecionado (na edição), carregar os dados
        {% if object and object.militar %}
        const militarId = {{ object.militar.id }};
        const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
        if (militarId) {
            const option = new Option(militarText, militarId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
    }
});
</script>
{% endblock %}


