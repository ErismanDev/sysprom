{% load static %}
{% load money_filters %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registrar Abastecimento / Manuten√ß√£o - {{ viatura.placa }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #e55a2b 30%, #ff6b35 70%, #ff8c42 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px 0;
        }
        
        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .mobile-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .viatura-header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }
        
        .viatura-header h4 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #dee2e6;
            font-size: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #ff6b35;
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .input-group-text {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-right: none;
            border-radius: 10px 0 0 10px;
        }
        
        .input-group .form-control {
            border-left: none;
            border-radius: 0 10px 10px 0;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff6b35;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff6b35;
        }
        
        .alert {
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .invalid-feedback {
            display: block;
            font-size: 0.875rem;
            margin-top: 5px;
        }
        
        .password-field-wrapper {
            position: relative;
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 16px;
            padding: 8px 10px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
        }
        
        .password-toggle-btn:hover {
            color: #495057;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .password-toggle-btn.active {
            color: #ff6b35;
        }
        
        .password-toggle-btn.active:hover {
            color: #e55a2b;
        }
        
        .password-toggle-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.25);
            border-radius: 4px;
        }
        
        .form-select-lg {
            font-size: 1.1rem;
            padding: 12px 15px;
            font-weight: 600;
        }
        
        .formulario-tipo {
            transition: opacity 0.3s ease-in-out;
        }
        
        .btn-submit-manutencao {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            color: white;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .btn-submit-manutencao:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
            color: white;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="mobile-card">
            <div class="viatura-header">
                <i class="fas fa-car fa-2x mb-2"></i>
                <h4>{{ viatura.placa }}</h4>
                {% if viatura.prefixo %}
                    <p class="mb-0"><small>Prefixo: {{ viatura.prefixo }}</small></p>
                {% endif %}
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Dropdown para sele√ß√£o do tipo de registro -->
            <div class="mb-4">
                <label for="tipoRegistro" class="form-label fw-bold">
                    <i class="fas fa-list me-2"></i>Tipo de Registro <span class="text-danger">*</span>
                </label>
                <select class="form-select form-select-lg" id="tipoRegistro" onchange="trocarTipoRegistro()">
                    <option value="rodagem" selected>üöó Rodagem</option>
                    <option value="abastecimento">‚õΩ Abastecimento</option>
                    <option value="manutencao">üîß Manuten√ß√£o</option>
                    <option value="troca_oleo">üõ¢Ô∏è Troca de √ìleo</option>
                </select>
            </div>
            
            <!-- Formul√°rio de Abastecimento -->
            <div id="formAbastecimento" class="formulario-tipo" style="display: none;">
                <form method="post" id="abastecimentoFormMobile">
                {% csrf_token %}
                
                {% if show_login or not user.is_authenticated %}
                <div class="section-title">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </div>
                
                <div class="mb-3">
                    <label for="login_username" class="form-label">
                        Usu√°rio <span class="text-danger">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="login_username" 
                           name="login_username" 
                           placeholder="Digite seu usu√°rio"
                           required
                           autocomplete="username">
                </div>
                
                <div class="mb-3">
                    <label for="login_password" class="form-label">
                        Senha <span class="text-danger">*</span>
                    </label>
                    <div class="password-field-wrapper" style="position: relative;">
                        <input type="password" 
                               class="form-control" 
                               id="login_password" 
                               name="login_password" 
                               placeholder="Digite sua senha"
                               required
                               autocomplete="current-password"
                               style="padding-right: 45px;">
                        <button type="button" 
                                class="password-toggle-btn" 
                                onclick="togglePasswordVisibility('login_password', this)"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #6c757d; font-size: 14px; padding: 6px 8px; cursor: pointer; z-index: 10;">
                            <i class="fas fa-eye" id="login_password_icon"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Campos ocultos -->
                <input type="hidden" name="viatura" value="{{ viatura.pk }}">
                
                <div class="section-title">
                    <i class="fas fa-calendar-alt me-2"></i>Data e Hora
                </div>
                
                <div class="mb-3">
                    <label for="id_data_abastecimento" class="form-label">
                        Data e Hora do Abastecimento <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" 
                           name="data_abastecimento" 
                           id="id_data_abastecimento" 
                           class="form-control"
                           value=""
                           required>
                    {% if form.data_abastecimento.errors %}
                        <div class="invalid-feedback d-block">{{ form.data_abastecimento.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="section-title">
                    <i class="fas fa-tachometer-alt me-2"></i>Informa√ß√µes do Abastecimento
                </div>
                
                <div class="mb-3">
                    <label for="id_km_abastecimento" class="form-label">
                        KM no Abastecimento <span class="text-danger">*</span>
                    </label>
                    {% if ultimo_abastecimento %}
                        <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>√öltimo KM registrado:</strong> {{ ultimo_abastecimento.km_abastecimento|floatformat:0 }} km
                            {% if ultimo_abastecimento.data_abastecimento %}
                                <br><small>({{ ultimo_abastecimento.data_abastecimento|date:"d/m/Y H:i" }})</small>
                            {% endif %}
                        </div>
                    {% elif viatura.km_atual %}
                        <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>KM atual da viatura:</strong> {{ viatura.km_atual|floatformat:0 }} km
                        </div>
                    {% endif %}
                    <input type="number" 
                           name="km_abastecimento" 
                           id="id_km_abastecimento" 
                           class="form-control"
                           value="{% if ultimo_abastecimento %}{{ ultimo_abastecimento.km_abastecimento }}{% else %}{{ viatura.km_atual }}{% endif %}"
                           min="{% if ultimo_abastecimento %}{{ ultimo_abastecimento.km_abastecimento }}{% else %}{{ viatura.km_atual|default:0 }}{% endif %}"
                           required>
                    {% if form.km_abastecimento.errors %}
                        <div class="invalid-feedback d-block">{{ form.km_abastecimento.errors }}</div>
                    {% endif %}
                    <div id="km_validation_message" class="text-danger d-none mt-2" style="font-size: 0.875rem;">
                        <i class="fas fa-times-circle me-1"></i>
                        <span id="km_validation_text"></span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                        O novo KM deve ser maior ou igual ao √∫ltimo KM registrado
                    </small>
                </div>
                
                <div class="mb-3">
                    <label for="id_tipo_combustivel" class="form-label">
                        Tipo de Combust√≠vel <span class="text-danger">*</span>
                    </label>
                    {{ form.tipo_combustivel }}
                    {% if form.tipo_combustivel.errors %}
                        <div class="invalid-feedback d-block">{{ form.tipo_combustivel.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="section-title">
                    <i class="fas fa-dollar-sign me-2"></i>Valores
                </div>
                
                <div class="mb-3">
                    <label for="id_quantidade_litros" class="form-label">
                        Quantidade (Litros) <span class="text-danger">*</span>
                    </label>
                    <input type="number" 
                           name="quantidade_litros" 
                           id="id_quantidade_litros" 
                           class="form-control"
                           step="0.01"
                           min="0.01"
                           placeholder="Ex: 50.00"
                           required>
                    {% if form.quantidade_litros.errors %}
                        <div class="invalid-feedback d-block">{{ form.quantidade_litros.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="id_valor_litro" class="form-label">
                        Valor por Litro (R$) <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="text" 
                               name="valor_litro" 
                               id="id_valor_litro" 
                               class="form-control" 
                               value=""
                               placeholder="0,00"
                               autocomplete="off"
                               required>
                    </div>
                    {% if form.valor_litro.errors %}
                        <div class="invalid-feedback d-block">{{ form.valor_litro.errors }}</div>
                    {% endif %}
                    <small class="text-muted">Digite o valor - formata√ß√£o autom√°tica em R$</small>
                </div>
                
                <div class="mb-3">
                    <label for="id_valor_total" class="form-label">
                        Valor Total (R$)
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="text" 
                               name="valor_total" 
                               id="id_valor_total" 
                               class="form-control" 
                               readonly
                               value=""
                               placeholder="Calculado automaticamente">
                    </div>
                    {% if form.valor_total.errors %}
                        <div class="invalid-feedback d-block">{{ form.valor_total.errors }}</div>
                    {% endif %}
                    <small class="text-muted">Calculado automaticamente</small>
                </div>
                
                <div class="section-title">
                    <i class="fas fa-info-circle me-2"></i>Informa√ß√µes Adicionais
                </div>
                
                <div class="mb-3">
                    <label for="id_posto_fornecedor" class="form-label">
                        Posto/Fornecedor
                    </label>
                    <input type="text" 
                           name="posto_fornecedor" 
                           id="id_posto_fornecedor" 
                           class="form-control"
                           placeholder="Nome do posto ou fornecedor">
                    {% if form.posto_fornecedor.errors %}
                        <div class="invalid-feedback d-block">{{ form.posto_fornecedor.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               name="com_aditivos" 
                               id="id_com_aditivos">
                        <label class="form-check-label" for="id_com_aditivos">
                            <i class="fas fa-flask me-1 text-info"></i>Com Aditivos
                        </label>
                    </div>
                    <small class="text-muted">Marque se foram comprados tamb√©m aditivos para o combust√≠vel</small>
                </div>
                
                <!-- Campos de Aditivo (aparecem quando "Com Aditivos" est√° marcado) -->
                <div id="camposAditivo" style="display: none;" class="mb-3">
                    <div class="section-title" style="border-color: #17a2b8;">
                        <i class="fas fa-flask me-2"></i>Informa√ß√µes do Aditivo
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_tipo_aditivo" class="form-label">
                            Tipo de Aditivo
                        </label>
                        {{ form.tipo_aditivo }}
                        {% if form.tipo_aditivo.errors %}
                            <div class="invalid-feedback d-block">{{ form.tipo_aditivo.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_quantidade_aditivo" class="form-label">
                            Quantidade
                        </label>
                        <input type="number" 
                               name="quantidade_aditivo" 
                               id="id_quantidade_aditivo" 
                               class="form-control"
                               step="0.01"
                               min="0"
                               placeholder="Ex: 1.00">
                        {% if form.quantidade_aditivo.errors %}
                            <div class="invalid-feedback d-block">{{ form.quantidade_aditivo.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_unitario_aditivo" class="form-label">
                            Valor Unit√°rio (R$)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_unitario_aditivo" 
                                   id="id_valor_unitario_aditivo" 
                                   class="form-control"
                                   placeholder="0,00"
                                   autocomplete="off">
                        </div>
                        {% if form.valor_unitario_aditivo.errors %}
                            <div class="invalid-feedback d-block">{{ form.valor_unitario_aditivo.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Digite o valor - formata√ß√£o autom√°tica em R$</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_total_aditivo" class="form-label">
                            Valor Total do Aditivo (R$)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_total_aditivo" 
                                   id="id_valor_total_aditivo" 
                                   class="form-control"
                                   readonly
                                   value=""
                                   placeholder="Calculado automaticamente">
                        </div>
                        {% if form.valor_total_aditivo.errors %}
                            <div class="invalid-feedback d-block">{{ form.valor_total_aditivo.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Calculado automaticamente</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_total_nota" class="form-label">
                            <strong>Valor Total da Nota (R$)</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_total_nota" 
                                   id="id_valor_total_nota" 
                                   class="form-control"
                                   readonly
                                   value=""
                                   placeholder="Combust√≠vel + Aditivos">
                        </div>
                        {% if form.valor_total_nota.errors %}
                            <div class="invalid-feedback d-block">{{ form.valor_total_nota.errors }}</div>
                        {% endif %}
                        <small class="text-muted"><strong>Combust√≠vel + Aditivos</strong></small>
                    </div>
                </div>
                
                <!-- Respons√°vel (oculto, sempre ser√° o militar do usu√°rio logado) -->
                {% if form.responsavel %}
                    {{ form.responsavel }}
                {% endif %}
                
                <div class="mb-3">
                    <label class="form-label">
                        Respons√°vel pelo Abastecimento
                    </label>
                    {% if responsavel_usuario %}
                        <div class="form-control bg-light" style="border: 2px solid #dee2e6;">
                            <i class="fas fa-user-shield me-2 text-primary"></i>
                            <strong>{{ responsavel_usuario.get_posto_graduacao_display }} {{ responsavel_usuario.nome_completo }}</strong>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>O respons√°vel √© definido automaticamente pelo seu login
                        </small>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Voc√™ n√£o est√° vinculado a um militar. Entre em contato com o administrador.
                        </div>
                    {% endif %}
                </div>
                
                <div class="section-title">
                    <i class="fas fa-receipt me-2"></i>Cupom Fiscal
                </div>
                
                <div class="mb-3">
                    <label for="cupom_fiscal" class="form-label">
                        Capturar Cupom Fiscal
                    </label>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="btnCamera">
                            <i class="fas fa-camera me-2"></i>Capturar via C√¢mera
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('cupom_fiscal_input').click()" id="btnGaleria">
                            <i class="fas fa-image me-2"></i>Escolher da Galeria
                        </button>
                    </div>
                    <input type="file" 
                           id="cupom_fiscal_input" 
                           name="cupom_fiscal" 
                           accept="image/*" 
                           capture="environment"
                           style="display: none;"
                           onchange="previewImagem(this)">
                    <div id="preview_cupom" class="mt-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Cupom Fiscal Capturado</strong>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="window.removerImagem && window.removerImagem(); return false;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <img id="preview_img" src="" alt="Preview do cupom fiscal" class="img-fluid rounded" style="max-height: 300px; width: 100%; object-fit: contain;">
                                <canvas id="canvas_cupom" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="id_observacoes" class="form-label">
                        Observa√ß√µes
                    </label>
                    <textarea name="observacoes" 
                              id="id_observacoes" 
                              class="form-control" 
                              rows="3"
                              placeholder="Observa√ß√µes sobre o abastecimento..."></textarea>
                    {% if form.observacoes.errors %}
                        <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                    {% endif %}
                </div>
                
                <button type="submit" class="btn btn-submit">
                    <i class="fas fa-save me-2"></i>Registrar Abastecimento
                </button>
                </form>
            </div>
            
            <!-- Formul√°rio de Manuten√ß√£o -->
            <div id="formManutencao" class="formulario-tipo" style="display: none;">
                {% if form_manutencao %}
                <form method="post" id="manutencaoFormMobile">
                        {% csrf_token %}
                        
                        {% if show_login or not user.is_authenticated %}
                        <div class="section-title">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_username_manutencao" class="form-label">
                                Usu√°rio <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="login_username_manutencao" 
                                   name="login_username" 
                                   placeholder="Digite seu usu√°rio"
                                   required
                                   autocomplete="username">
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_password_manutencao" class="form-label">
                                Senha <span class="text-danger">*</span>
                            </label>
                            <div class="password-field-wrapper" style="position: relative;">
                                <input type="password" 
                                       class="form-control" 
                                       id="login_password_manutencao" 
                                       name="login_password" 
                                       placeholder="Digite sua senha"
                                       required
                                       autocomplete="current-password"
                                       style="padding-right: 45px;">
                                <button type="button" 
                                        class="password-toggle-btn" 
                                        onclick="togglePasswordVisibility('login_password_manutencao', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #6c757d; font-size: 14px; padding: 6px 8px; cursor: pointer; z-index: 10;">
                                    <i class="fas fa-eye" id="login_password_manutencao_icon"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Campos ocultos -->
                        <input type="hidden" name="viatura" value="{{ viatura.pk }}">
                        
                        <div class="section-title">
                            <i class="fas fa-calendar-alt me-2"></i>Data e Hora
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_data_manutencao" class="form-label">
                                Data e Hora da Manuten√ß√£o <span class="text-danger">*</span>
                            </label>
                            {{ form_manutencao.data_manutencao }}
                            {% if form_manutencao.data_manutencao.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.data_manutencao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="section-title">
                            <i class="fas fa-tools me-2"></i>Informa√ß√µes da Manuten√ß√£o
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_tipo_manutencao" class="form-label">
                                Tipo de Manuten√ß√£o <span class="text-danger">*</span>
                            </label>
                            {{ form_manutencao.tipo_manutencao }}
                            {% if form_manutencao.tipo_manutencao.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.tipo_manutencao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_km_manutencao" class="form-label">
                                KM na Manuten√ß√£o <span class="text-danger">*</span>
                            </label>
                            {% if ultima_manutencao %}
                                <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>√öltimo KM registrado:</strong> {{ ultima_manutencao.km_manutencao|floatformat:0 }} km
                                    {% if ultima_manutencao.data_manutencao %}
                                        <br><small>({{ ultima_manutencao.data_manutencao|date:"d/m/Y H:i" }})</small>
                                    {% endif %}
                                </div>
                            {% elif viatura.km_atual %}
                                <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>KM atual da viatura:</strong> {{ viatura.km_atual|floatformat:0 }} km
                                </div>
                            {% endif %}
                            {{ form_manutencao.km_manutencao }}
                            {% if form_manutencao.km_manutencao.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.km_manutencao.errors }}</div>
                            {% endif %}
                            <div id="km_manutencao_validation_message" class="text-danger d-none mt-2" style="font-size: 0.875rem;">
                                <i class="fas fa-times-circle me-1"></i>
                                <span id="km_manutencao_validation_text"></span>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                O novo KM deve ser maior ou igual ao √∫ltimo KM registrado
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_descricao_servico" class="form-label">
                                Descri√ß√£o do Servi√ßo <span class="text-danger">*</span>
                            </label>
                            {{ form_manutencao.descricao_servico }}
                            {% if form_manutencao.descricao_servico.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.descricao_servico.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="section-title">
                            <i class="fas fa-dollar-sign me-2"></i>Valores e Fornecedor
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_fornecedor_oficina" class="form-label">
                                Oficina
                            </label>
                            {{ form_manutencao.fornecedor_oficina }}
                            {% if form_manutencao.fornecedor_oficina.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.fornecedor_oficina.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_valor_manutencao" class="form-label">
                                Valor da Manuten√ß√£o (R$) <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form_manutencao.valor_manutencao }}
                            </div>
                            {% if form_manutencao.valor_manutencao.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.valor_manutencao.errors }}</div>
                            {% endif %}
                            <small class="text-muted">Digite o valor - formata√ß√£o autom√°tica em R$</small>
                        </div>
                        
                        <div class="section-title">
                            <i class="fas fa-info-circle me-2"></i>Informa√ß√µes Adicionais
                        </div>
                        
                        <!-- Pe√ßas Trocadas -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">
                                    <i class="fas fa-cogs me-1"></i>Pe√ßas Trocadas
                                </label>
                                <button type="button" class="btn btn-sm btn-success" id="btnAdicionarPecaManutencaoMobile">
                                    <i class="fas fa-plus me-1"></i>Adicionar Pe√ßa
                                </button>
                            </div>
                            
                            <!-- Tabela de Pe√ßas -->
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="tabelaPecasManutencaoMobile">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 35%;">Nome da Pe√ßa</th>
                                            <th style="width: 15%;">Quantidade</th>
                                            <th style="width: 20%;">Valor Unit√°rio (R$)</th>
                                            <th style="width: 20%;">Total (R$)</th>
                                            <th style="width: 10%;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyPecasManutencaoMobile">
                                        <!-- Linhas ser√£o adicionadas dinamicamente aqui -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info fw-bold">
                                            <td colspan="3" class="text-end">Total das Pe√ßas:</td>
                                            <td>
                                                <span id="totalPecasManutencaoMobile" class="text-success">R$ 0,00</span>
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Campo oculto para salvar no formul√°rio -->
                            <input type="hidden" name="pecas_trocadas" id="id_pecas_trocadas_mobile" value="">
                            
                            {% if form_manutencao.pecas_trocadas.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.pecas_trocadas.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_proximo_km_revisao" class="form-label">
                                KM para Pr√≥xima Revis√£o
                            </label>
                            {{ form_manutencao.proximo_km_revisao }}
                            {% if form_manutencao.proximo_km_revisao.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.proximo_km_revisao.errors }}</div>
                            {% endif %}
                            <small class="text-muted">Apenas para tipo Revis√£o</small>
                        </div>
                        
                        <!-- Respons√°vel (oculto) -->
                        {% if form_manutencao.responsavel %}
                            {{ form_manutencao.responsavel }}
                        {% endif %}
                        
                        <div class="mb-3">
                            <label class="form-label">
                                Respons√°vel pela Manuten√ß√£o
                            </label>
                            {% if responsavel_usuario %}
                                <div class="form-control bg-light" style="border: 2px solid #dee2e6;">
                                    <i class="fas fa-user-shield me-2 text-primary"></i>
                                    <strong>{{ responsavel_usuario.get_posto_graduacao_display }} {{ responsavel_usuario.nome_completo }}</strong>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>O respons√°vel √© definido automaticamente pelo seu login
                                </small>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Voc√™ n√£o est√° vinculado a um militar. Entre em contato com o administrador.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_observacoes_manutencao" class="form-label">
                                Observa√ß√µes
                            </label>
                            {{ form_manutencao.observacoes }}
                            {% if form_manutencao.observacoes.errors %}
                                <div class="invalid-feedback d-block">{{ form_manutencao.observacoes.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <button type="submit" class="btn btn-submit-manutencao">
                            <i class="fas fa-save me-2"></i>Registrar Manuten√ß√£o
                        </button>
                </form>
                {% endif %}
            </div>
            
            <!-- Formul√°rio de Troca de √ìleo -->
            <div id="formTrocaOleo" class="formulario-tipo" style="display: none;">
                {% if form_troca_oleo %}
                <form method="post" id="trocaOleoFormMobile">
                    {% csrf_token %}
                    
                    {% if show_login or not user.is_authenticated %}
                    <div class="section-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </div>
                    
                    <div class="mb-3">
                        <label for="login_username_troca_oleo" class="form-label">
                            Usu√°rio <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="login_username_troca_oleo" 
                               name="login_username" 
                               placeholder="Digite seu usu√°rio"
                               required
                               autocomplete="username">
                    </div>
                    
                    <div class="mb-3">
                        <label for="login_password_troca_oleo" class="form-label">
                            Senha <span class="text-danger">*</span>
                        </label>
                        <div class="password-field-wrapper" style="position: relative;">
                            <input type="password" 
                                   class="form-control" 
                                   id="login_password_troca_oleo" 
                                   name="login_password" 
                                   placeholder="Digite sua senha"
                                   required
                                   autocomplete="current-password"
                                   style="padding-right: 45px;">
                            <button type="button" 
                                    class="password-toggle-btn" 
                                    onclick="togglePasswordVisibility('login_password_troca_oleo', this)"
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #6c757d; font-size: 14px; padding: 6px 8px; cursor: pointer; z-index: 10;">
                                <i class="fas fa-eye" id="login_password_troca_oleo_icon"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Campos ocultos -->
                    <input type="hidden" name="viatura" value="{{ viatura.pk }}">
                    
                    <div class="section-title">
                        <i class="fas fa-calendar-alt me-2"></i>Data e Hora
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_data_troca" class="form-label">
                            Data e Hora da Troca <span class="text-danger">*</span>
                        </label>
                        <input type="datetime-local" 
                               name="data_troca" 
                               id="id_data_troca" 
                               class="form-control"
                               value=""
                               required>
                        {% if form_troca_oleo.data_troca.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.data_troca.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="section-title">
                        <i class="fas fa-oil-can me-2"></i>Informa√ß√µes do √ìleo
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_tipo_oleo" class="form-label">
                            Tipo de √ìleo <span class="text-danger">*</span>
                        </label>
                        {{ form_troca_oleo.tipo_oleo }}
                        {% if form_troca_oleo.tipo_oleo.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.tipo_oleo.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_nome_oleo" class="form-label">
                            Nome do √ìleo
                        </label>
                        {{ form_troca_oleo.nome_oleo }}
                        {% if form_troca_oleo.nome_oleo.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.nome_oleo.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Nome/comercial do √≥leo utilizado</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_km_troca" class="form-label">
                            KM na Troca <span class="text-danger">*</span>
                        </label>
                        {% if ultima_troca_oleo %}
                            <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>√öltimo KM registrado:</strong> {{ ultima_troca_oleo.km_troca|floatformat:0 }} km
                                {% if ultima_troca_oleo.data_troca %}
                                    <br><small>({{ ultima_troca_oleo.data_troca|date:"d/m/Y H:i" }})</small>
                                {% endif %}
                            </div>
                        {% elif viatura.km_atual %}
                            <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 0.9rem; border-radius: 8px;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>KM atual da viatura:</strong> {{ viatura.km_atual|floatformat:0 }} km
                            </div>
                        {% endif %}
                        {{ form_troca_oleo.km_troca }}
                        {% if form_troca_oleo.km_troca.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.km_troca.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="section-title">
                        <i class="fas fa-dollar-sign me-2"></i>Valores
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_quantidade_litros_troca" class="form-label">
                            Quantidade (Litros) <span class="text-danger">*</span>
                        </label>
                        <input type="number" 
                               name="quantidade_litros" 
                               id="id_quantidade_litros_troca" 
                               class="form-control"
                               step="0.01"
                               min="0.01"
                               placeholder="Ex: 5.00"
                               required>
                        {% if form_troca_oleo.quantidade_litros.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.quantidade_litros.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_litro_troca" class="form-label">
                            Valor por Litro (R$)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_litro" 
                                   id="id_valor_litro_troca" 
                                   class="form-control" 
                                   value=""
                                   placeholder="0,00"
                                   autocomplete="off">
                        </div>
                        {% if form_troca_oleo.valor_litro.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.valor_litro.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Digite o valor - formata√ß√£o autom√°tica em R$</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_total_troca" class="form-label">
                            Valor Total (R$)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_total" 
                                   id="id_valor_total_troca" 
                                   class="form-control" 
                                   readonly
                                   value=""
                                   placeholder="Calculado automaticamente">
                        </div>
                        {% if form_troca_oleo.valor_total.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.valor_total.errors }}</div>
                        {% endif %}
                        <small class="text-muted">Valor do √≥leo calculado automaticamente</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_fornecedor_oficina_troca" class="form-label">
                            Oficina/Fornecedor
                        </label>
                        {{ form_troca_oleo.fornecedor_oficina }}
                        {% if form_troca_oleo.fornecedor_oficina.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.fornecedor_oficina.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="section-title" style="border-color: #17a2b8;">
                        <i class="fas fa-filter me-2"></i>Filtros e Outras Pe√ßas
                    </div>
                    
                    <!-- Filtro de √ìleo -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_troca_oleo.trocou_filtro_oleo }}
                            <label class="form-check-label" for="{{ form_troca_oleo.trocou_filtro_oleo.id_for_label }}">
                                <i class="fas fa-filter me-1 text-info"></i>Trocou Filtro de √ìleo
                            </label>
                        </div>
                        <div id="campoValorFiltroOleoMobile" style="display: none;" class="mt-2">
                            <label for="id_valor_filtro_oleo_mobile" class="form-label">
                                Valor do Filtro de √ìleo (R$)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" 
                                       name="valor_filtro_oleo" 
                                       id="id_valor_filtro_oleo_mobile" 
                                       class="form-control" 
                                       placeholder="0,00"
                                       autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Combust√≠vel -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_troca_oleo.trocou_filtro_combustivel }}
                            <label class="form-check-label" for="{{ form_troca_oleo.trocou_filtro_combustivel.id_for_label }}">
                                <i class="fas fa-gas-pump me-1 text-warning"></i>Trocou Filtro de Combust√≠vel
                            </label>
                        </div>
                        <div id="campoValorFiltroCombustivelMobile" style="display: none;" class="mt-2">
                            <label for="id_valor_filtro_combustivel_mobile" class="form-label">
                                Valor do Filtro de Combust√≠vel (R$)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" 
                                       name="valor_filtro_combustivel" 
                                       id="id_valor_filtro_combustivel_mobile" 
                                       class="form-control" 
                                       placeholder="0,00"
                                       autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Ar -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_troca_oleo.trocou_filtro_ar }}
                            <label class="form-check-label" for="{{ form_troca_oleo.trocou_filtro_ar.id_for_label }}">
                                <i class="fas fa-snowflake me-1 text-primary"></i>Trocou Filtro de Ar Condicionado
                            </label>
                        </div>
                        <div id="campoValorFiltroArMobile" style="display: none;" class="mt-2">
                            <label for="id_valor_filtro_ar_mobile" class="form-label">
                                Valor do Filtro de Ar Condicionado (R$)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" 
                                       name="valor_filtro_ar" 
                                       id="id_valor_filtro_ar_mobile" 
                                       class="form-control" 
                                       placeholder="0,00"
                                       autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aditivo de Arrefecimento -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_troca_oleo.adicionou_aditivo_arrefecimento }}
                            <label class="form-check-label" for="{{ form_troca_oleo.adicionou_aditivo_arrefecimento.id_for_label }}">
                                <i class="fas fa-thermometer-half me-1 text-danger"></i>Adicionou Aditivo de Arrefecimento
                            </label>
                        </div>
                        <div id="campoAditivoArrefecimentoMobile" style="display: none;" class="mt-2">
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label for="id_quantidade_aditivo_arrefecimento_mobile" class="form-label">
                                        Quantidade (L)
                                    </label>
                                    <input type="number" 
                                           name="quantidade_aditivo_arrefecimento" 
                                           id="id_quantidade_aditivo_arrefecimento_mobile" 
                                           class="form-control"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00">
                                </div>
                                <div class="col-6 mb-2">
                                    <label for="id_valor_aditivo_arrefecimento_mobile" class="form-label">
                                        Valor (R$)
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="text" 
                                               name="valor_aditivo_arrefecimento" 
                                               id="id_valor_aditivo_arrefecimento_mobile" 
                                               class="form-control" 
                                               placeholder="0,00"
                                               autocomplete="off">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outras Pe√ßas -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">
                                <i class="fas fa-cogs me-1"></i>Outras Pe√ßas Trocadas
                            </label>
                            <button type="button" class="btn btn-sm btn-success" id="btnAdicionarPecaMobile">
                                <i class="fas fa-plus me-1"></i>Adicionar Pe√ßa
                            </button>
                        </div>
                        
                        <!-- Tabela de Pe√ßas -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm" id="tabelaOutrasPecasMobile">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 35%;">Nome da Pe√ßa</th>
                                        <th style="width: 15%;">Quantidade</th>
                                        <th style="width: 20%;">Valor Unit√°rio (R$)</th>
                                        <th style="width: 20%;">Total (R$)</th>
                                        <th style="width: 10%;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyOutrasPecasMobile">
                                    <!-- Linhas ser√£o adicionadas dinamicamente aqui -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-info fw-bold">
                                        <td colspan="3" class="text-end">Total das Outras Pe√ßas:</td>
                                        <td>
                                            <span id="totalOutrasPecasMobile" class="text-success">R$ 0,00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Campos ocultos para salvar no formul√°rio -->
                        <input type="hidden" name="outras_pecas" id="id_outras_pecas_mobile" value="">
                        <input type="hidden" name="valor_outras_pecas" id="id_valor_outras_pecas_mobile" value="">
                        
                        {% if form_troca_oleo.outras_pecas.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.outras_pecas.errors }}</div>
                        {% endif %}
                        {% if form_troca_oleo.valor_outras_pecas.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.valor_outras_pecas.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_proximo_km_troca" class="form-label">
                            KM para Pr√≥xima Troca
                        </label>
                        {{ form_troca_oleo.proximo_km_troca }}
                        {% if form_troca_oleo.proximo_km_troca.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.proximo_km_troca.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="section-title" style="border-color: #28a745;">
                        <i class="fas fa-calculator me-2"></i>Valor Total da Nota
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_valor_total_nota_troca" class="form-label">
                            <strong>Valor Total da Nota (R$)</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" 
                                   name="valor_total_nota" 
                                   id="id_valor_total_nota_troca" 
                                   class="form-control fw-bold" 
                                   readonly
                                   value=""
                                   placeholder="Ser√° calculado automaticamente">
                        </div>
                        {% if form_troca_oleo.valor_total_nota.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.valor_total_nota.errors }}</div>
                        {% endif %}
                        <small class="text-muted"><strong>Total da nota (√≥leo + filtros + aditivo + outras pe√ßas)</strong></small>
                    </div>
                    
                    <!-- Respons√°vel (oculto) -->
                    {% if form_troca_oleo.responsavel %}
                        {{ form_troca_oleo.responsavel }}
                    {% endif %}
                    
                    <div class="mb-3">
                        <label class="form-label">
                            Respons√°vel pela Troca
                        </label>
                        {% if responsavel_usuario %}
                            <div class="form-control bg-light" style="border: 2px solid #dee2e6;">
                                <i class="fas fa-user-shield me-2 text-primary"></i>
                                <strong>{{ responsavel_usuario.get_posto_graduacao_display }} {{ responsavel_usuario.nome_completo }}</strong>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>O respons√°vel √© definido automaticamente pelo seu login
                            </small>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Voc√™ n√£o est√° vinculado a um militar. Entre em contato com o administrador.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_observacoes_troca" class="form-label">
                            Observa√ß√µes
                        </label>
                        {{ form_troca_oleo.observacoes }}
                        {% if form_troca_oleo.observacoes.errors %}
                            <div class="invalid-feedback d-block">{{ form_troca_oleo.observacoes.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-submit-manutencao" style="background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%);">
                        <i class="fas fa-save me-2"></i>Registrar Troca de √ìleo
                    </button>
                </form>
                {% endif %}
            </div>
            
            <!-- Formul√°rio de Rodagem -->
            <div id="formRodagem" class="formulario-tipo">
                {% if rodagem_em_andamento %}
                    <!-- Se h√° rodagem em andamento, mostrar formul√°rio de retorno -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Rodagem em Andamento</strong><br>
                        Sa√≠da: {{ rodagem_em_andamento.data_saida|date:"d/m/Y" }} √†s {{ rodagem_em_andamento.hora_saida|time:"H:i" }}<br>
                        KM Inicial: {{ rodagem_em_andamento.km_inicial }}
                    </div>
                    
                    <form method="post" id="rodagemRetornoFormMobile">
                        {% csrf_token %}
                        <input type="hidden" name="tipo_rodagem" value="retorno">
                        <input type="hidden" name="rodagem_id" value="{{ rodagem_em_andamento.pk }}">
                        
                        {% if show_login or not user.is_authenticated %}
                        <div class="section-title">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_username_rodagem" class="form-label">
                                Usu√°rio <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="login_username_rodagem" 
                                   name="login_username" 
                                   placeholder="Digite seu usu√°rio"
                                   required
                                   autocomplete="username">
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_password_rodagem" class="form-label">
                                Senha <span class="text-danger">*</span>
                            </label>
                            <div class="password-field-wrapper" style="position: relative;">
                                <input type="password" 
                                       class="form-control" 
                                       id="login_password_rodagem" 
                                       name="login_password" 
                                       placeholder="Digite sua senha"
                                       required
                                       autocomplete="current-password"
                                       style="padding-right: 45px;">
                                <button type="button" 
                                        class="password-toggle-btn" 
                                        onclick="togglePasswordVisibility('login_password_rodagem', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #6c757d; font-size: 14px; padding: 6px 8px; cursor: pointer; z-index: 10;">
                                    <i class="fas fa-eye" id="login_password_rodagem_icon"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="section-title" style="border-color: #28a745;">
                            <i class="fas fa-calendar-check me-2"></i>Registrar Retorno
                        </div>
                        
                        <div class="mb-3">
                            <label for="data_retorno_mobile" class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>Data de Retorno <span class="text-danger">*</span>
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   id="data_retorno_mobile" 
                                   name="data_retorno" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="hora_retorno_mobile" class="form-label">
                                <i class="fas fa-clock me-2"></i>Hora de Retorno <span class="text-danger">*</span>
                            </label>
                            <input type="time" 
                                   class="form-control" 
                                   id="hora_retorno_mobile" 
                                   name="hora_retorno" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="km_final_mobile" class="form-label">
                                <i class="fas fa-tachometer-alt me-2"></i>KM Final <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="km_final_mobile" 
                                   name="km_final" 
                                   min="{{ rodagem_em_andamento.km_inicial }}" 
                                   placeholder="KM no momento do retorno" 
                                   required>
                            <small class="text-muted">KM no momento do retorno da viatura</small>
                        </div>
                        
                        <button type="submit" class="btn btn-submit-manutencao" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <i class="fas fa-check-circle me-2"></i>Encerrar Rodagem
                        </button>
                    </form>
                {% else %}
                    <!-- Se n√£o h√° rodagem em andamento, mostrar formul√°rio de sa√≠da -->
                    <form method="post" id="rodagemSaidaFormMobile">
                        {% csrf_token %}
                        <input type="hidden" name="tipo_rodagem" value="saida">
                        <input type="hidden" name="viatura" value="{{ viatura.pk }}">
                        
                        {% if show_login or not user.is_authenticated %}
                        <div class="section-title">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_username_rodagem" class="form-label">
                                Usu√°rio <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="login_username_rodagem" 
                                   name="login_username" 
                                   placeholder="Digite seu usu√°rio"
                                   required
                                   autocomplete="username">
                        </div>
                        
                        <div class="mb-3">
                            <label for="login_password_rodagem" class="form-label">
                                Senha <span class="text-danger">*</span>
                            </label>
                            <div class="password-field-wrapper" style="position: relative;">
                                <input type="password" 
                                       class="form-control" 
                                       id="login_password_rodagem" 
                                       name="login_password" 
                                       placeholder="Digite sua senha"
                                       required
                                       autocomplete="current-password"
                                       style="padding-right: 45px;">
                                <button type="button" 
                                        class="password-toggle-btn" 
                                        onclick="togglePasswordVisibility('login_password_rodagem', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #6c757d; font-size: 14px; padding: 6px 8px; cursor: pointer; z-index: 10;">
                                    <i class="fas fa-eye" id="login_password_rodagem_icon"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="section-title" style="border-color: #17a2b8;">
                            <i class="fas fa-route me-2"></i>Registrar Sa√≠da
                        </div>
                        
                        <div class="mb-3">
                            <label for="data_saida_mobile" class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>Data de Sa√≠da <span class="text-danger">*</span>
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   id="data_saida_mobile" 
                                   name="data_saida" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="hora_saida_mobile" class="form-label">
                                <i class="fas fa-clock me-2"></i>Hora de Sa√≠da <span class="text-danger">*</span>
                            </label>
                            <input type="time" 
                                   class="form-control" 
                                   id="hora_saida_mobile" 
                                   name="hora_saida" 
                                   required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="km_inicial_mobile" class="form-label">
                                <i class="fas fa-tachometer-alt me-2"></i>KM Inicial <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="km_inicial_mobile" 
                                   name="km_inicial" 
                                   min="0" 
                                   placeholder="KM no momento da sa√≠da" 
                                   value="{% if ultima_rodagem_finalizada and ultima_rodagem_finalizada.km_final %}{{ ultima_rodagem_finalizada.km_final }}{% endif %}"
                                   required>
                            {% if ultima_rodagem_finalizada %}
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Preenchido automaticamente com o KM final da √∫ltima rodagem: {{ ultima_rodagem_finalizada.km_final }} km ({{ ultima_rodagem_finalizada.data_retorno|date:"d/m/Y" }})
                                </small>
                            {% else %}
                                <small class="text-muted">Primeira rodagem desta viatura - preencha manualmente</small>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="objetivo_mobile" class="form-label">
                                <i class="fas fa-bullseye me-2"></i>Objetivo <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="objetivo_mobile" name="objetivo" required>
                                <option value="">Selecione...</option>
                                <option value="OPERACAO">Opera√ß√£o</option>
                                <option value="TREINAMENTO">Treinamento</option>
                                <option value="MANUTENCAO">Manuten√ß√£o</option>
                                <option value="ADMINISTRATIVO">Administrativo</option>
                                <option value="TRANSPORTE">Transporte</option>
                                <option value="OUTROS">Outros</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="destino_mobile" class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Destino
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="destino_mobile" 
                                   name="destino" 
                                   placeholder="Local de destino da viatura">
                        </div>
                        
                        <div class="mb-3">
                            <label for="observacoes_rodagem_mobile" class="form-label">
                                <i class="fas fa-comment-dots me-2"></i>Observa√ß√µes
                            </label>
                            <textarea class="form-control" 
                                      id="observacoes_rodagem_mobile" 
                                      name="observacoes" 
                                      rows="3" 
                                      placeholder="Observa√ß√µes sobre a rodagem..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-submit-manutencao" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            <i class="fas fa-route me-2"></i>Registrar Sa√≠da
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Executar ao carregar a p√°gina para mostrar rodagem inicialmente
    document.addEventListener('DOMContentLoaded', function() {
        trocarTipoRegistro();
    });
    
    // Fun√ß√£o para trocar entre formul√°rios
    function trocarTipoRegistro() {
        const tipoRegistro = document.getElementById('tipoRegistro').value;
        const formAbastecimento = document.getElementById('formAbastecimento');
        const formManutencao = document.getElementById('formManutencao');
        const formTrocaOleo = document.getElementById('formTrocaOleo');
        const formRodagem = document.getElementById('formRodagem');
        
        if (tipoRegistro === 'rodagem') {
            formAbastecimento.style.display = 'none';
            formManutencao.style.display = 'none';
            if (formTrocaOleo) formTrocaOleo.style.display = 'none';
            if (formRodagem) formRodagem.style.display = 'block';
            
            // Preencher data e hora de sa√≠da automaticamente (se for formul√°rio de sa√≠da)
            const dataSaida = document.getElementById('data_saida_mobile');
            const horaSaida = document.getElementById('hora_saida_mobile');
            const dataRetorno = document.getElementById('data_retorno_mobile');
            const horaRetorno = document.getElementById('hora_retorno_mobile');
            
            if (dataSaida && !dataSaida.value) {
                const now = new Date();
                const brasiliaDate = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Sao_Paulo',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).formatToParts(now);
                
                const year = brasiliaDate.find(part => part.type === 'year').value;
                const month = brasiliaDate.find(part => part.type === 'month').value;
                const day = brasiliaDate.find(part => part.type === 'day').value;
                dataSaida.value = `${year}-${month}-${day}`;
            }
            
            if (horaSaida && !horaSaida.value) {
                const now = new Date();
                const brasiliaTime = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Sao_Paulo',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).formatToParts(now);
                
                const hours = brasiliaTime.find(part => part.type === 'hour').value;
                const minutes = brasiliaTime.find(part => part.type === 'minute').value;
                horaSaida.value = `${hours}:${minutes}`;
            }
            
            if (dataRetorno && !dataRetorno.value) {
                const now = new Date();
                const brasiliaDate = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Sao_Paulo',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).formatToParts(now);
                
                const year = brasiliaDate.find(part => part.type === 'year').value;
                const month = brasiliaDate.find(part => part.type === 'month').value;
                const day = brasiliaDate.find(part => part.type === 'day').value;
                dataRetorno.value = `${year}-${month}-${day}`;
            }
            
            if (horaRetorno && !horaRetorno.value) {
                const now = new Date();
                const brasiliaTime = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Sao_Paulo',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).formatToParts(now);
                
                const hours = brasiliaTime.find(part => part.type === 'hour').value;
                const minutes = brasiliaTime.find(part => part.type === 'minute').value;
                horaRetorno.value = `${hours}:${minutes}`;
            }
        } else if (tipoRegistro === 'abastecimento') {
            formAbastecimento.style.display = 'block';
            formManutencao.style.display = 'none';
            if (formTrocaOleo) formTrocaOleo.style.display = 'none';
            if (formRodagem) formRodagem.style.display = 'none';
        } else if (tipoRegistro === 'manutencao') {
            formAbastecimento.style.display = 'none';
            formManutencao.style.display = 'block';
            if (formTrocaOleo) formTrocaOleo.style.display = 'none';
            if (formRodagem) formRodagem.style.display = 'none';
        } else if (tipoRegistro === 'troca_oleo') {
            formAbastecimento.style.display = 'none';
            formManutencao.style.display = 'none';
            if (formTrocaOleo) formTrocaOleo.style.display = 'block';
            if (formRodagem) formRodagem.style.display = 'none';
        }
    }
    
    // Fun√ß√£o para mostrar/ocultar senha
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            button.classList.add('active');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
            button.classList.remove('active');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar data/hora atual como padr√£o
        const dataInput = document.getElementById('id_data_abastecimento');
        if (dataInput && !dataInput.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            dataInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Fun√ß√£o para formatar n√∫mero como moeda BRL
        function formatarMoedaBRL(valor) {
            if (!valor || valor === '') return '';
            
            let numeroString = valor.toString().trim();
            
            if (numeroString.includes(',')) {
                let partes = numeroString.split(',');
                let parteInteira = partes[0].replace(/\./g, '').replace(/[^\d]/g, '') || '0';
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                while (parteDecimal.length < 2) {
                    parteDecimal += '0';
                }
                if (parteDecimal === '') {
                    parteDecimal = '00';
                }
                
                return parteInteira + ',' + parteDecimal;
            } else {
                numeroString = numeroString.replace(/[^\d]/g, '');
                if (numeroString === '') return '';
                
                numeroString = numeroString.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return numeroString;
            }
        }
        
        function obterValorNumerico(valor) {
            if (!valor || valor === '') return '';
            let numero = valor.toString().replace(/\./g, '').replace(',', '.');
            numero = numero.replace(/[^\d.]/g, '');
            return numero;
        }
        
        // Calcular valor total automaticamente
        function calcularValorTotal() {
            const quantidadeInput = document.getElementById('id_quantidade_litros');
            const valorLitroInput = document.getElementById('id_valor_litro');
            const valorTotalInput = document.getElementById('id_valor_total');
            
            if (quantidadeInput && valorLitroInput && valorTotalInput) {
                const quantidade = parseFloat(quantidadeInput.value) || 0;
                const valorLitro = parseFloat(obterValorNumerico(valorLitroInput.value)) || 0;
                
                if (quantidade > 0 && valorLitro > 0) {
                    const valorTotal = quantidade * valorLitro;
                    let valorTotalStr = valorTotal.toFixed(2);
                    let partes = valorTotalStr.split('.');
                    let parteInteira = partes[0];
                    let parteDecimal = partes[1] || '00';
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    valorTotalInput.value = parteInteira + ',' + parteDecimal;
                } else {
                    valorTotalInput.value = '';
                }
            }
        }
        
        // Event listeners
        const quantidadeInput = document.getElementById('id_quantidade_litros');
        const valorLitroInput = document.getElementById('id_valor_litro');
        
        if (quantidadeInput) {
            quantidadeInput.addEventListener('input', calcularValorTotal);
            quantidadeInput.addEventListener('change', calcularValorTotal);
        }
        
        if (valorLitroInput) {
            valorLitroInput.addEventListener('input', function(e) {
                let valor = e.target.value;
                let valorLimpo = valor.replace(/[^\d,]/g, '');
                let partes = valorLimpo.split(',');
                if (partes.length > 2) {
                    valorLimpo = partes[0] + ',' + partes.slice(1).join('');
                }
                if (partes.length === 2 && partes[1].length > 2) {
                    valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
                }
                if (valorLimpo !== valor) {
                    let cursorPos = e.target.selectionStart;
                    e.target.value = valorLimpo;
                    setTimeout(() => {
                        let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                        e.target.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                }
            });
            
            valorLitroInput.addEventListener('blur', function(e) {
                let valor = e.target.value.trim();
                if (!valor || valor === '') {
                    e.target.value = '';
                    calcularValorTotal();
                    return;
                }
                
                if (valor.includes(',')) {
                    let partes = valor.split(',');
                    let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                    let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                    
                    while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                        parteDecimal += '0';
                    }
                    if (parteDecimal === '') {
                        parteDecimal = '00';
                    }
                    
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = parteInteira + ',' + parteDecimal;
                } else {
                    let numeroLimpo = valor.replace(/[^\d]/g, '');
                    if (numeroLimpo !== '') {
                        numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = numeroLimpo + ',00';
                    } else {
                        e.target.value = '';
                    }
                }
                calcularValorTotal();
            });
            
            valorLitroInput.addEventListener('change', calcularValorTotal);
        }
        
        // Valida√ß√£o de KM - n√£o permitir valor menor que o √∫ltimo registrado
        const kmInput = document.getElementById('id_km_abastecimento');
        const kmValidationMessage = document.getElementById('km_validation_message');
        const kmValidationText = document.getElementById('km_validation_text');
        
        {% if ultimo_abastecimento %}
        const ultimoKm = {{ ultimo_abastecimento.km_abastecimento }};
        {% else %}
        const ultimoKm = {{ viatura.km_atual|default:0 }};
        {% endif %}
        
        if (kmInput) {
            kmInput.addEventListener('input', function(e) {
                const valorDigitado = parseFloat(e.target.value);
                
                if (valorDigitado && valorDigitado < ultimoKm) {
                    e.target.classList.add('is-invalid');
                    kmValidationMessage.classList.remove('d-none');
                    kmValidationText.textContent = `O KM informado (${valorDigitado}) √© menor que o √∫ltimo KM registrado (${ultimoKm}). Digite um valor maior ou igual.`;
                } else {
                    e.target.classList.remove('is-invalid');
                    kmValidationMessage.classList.add('d-none');
                }
            });
            
            kmInput.addEventListener('blur', function(e) {
                const valorDigitado = parseFloat(e.target.value);
                
                if (valorDigitado && valorDigitado < ultimoKm) {
                    e.target.classList.add('is-invalid');
                    kmValidationMessage.classList.remove('d-none');
                    kmValidationText.textContent = `O KM informado (${valorDigitado}) √© menor que o √∫ltimo KM registrado (${ultimoKm}). Digite um valor maior ou igual.`;
                    e.target.focus();
                } else {
                    e.target.classList.remove('is-invalid');
                    kmValidationMessage.classList.add('d-none');
                }
            });
            
            // Validar antes de submeter
            kmInput.addEventListener('change', function(e) {
                const valorDigitado = parseFloat(e.target.value);
                
                if (valorDigitado && valorDigitado < ultimoKm) {
                    e.target.classList.add('is-invalid');
                    kmValidationMessage.classList.remove('d-none');
                    kmValidationText.textContent = `O KM informado (${valorDigitado}) √© menor que o √∫ltimo KM registrado (${ultimoKm}). Digite um valor maior ou igual.`;
                }
            });
        }
        
        // === FUNCIONALIDADES DE ADITIVOS ===
        
        // Fun√ß√£o para mostrar/ocultar campos de aditivo
        function toggleCamposAditivo() {
            const comAditivosCheckbox = document.getElementById('id_com_aditivos');
            const camposAditivo = document.getElementById('camposAditivo');
            
            if (comAditivosCheckbox && camposAditivo) {
                if (comAditivosCheckbox.checked) {
                    camposAditivo.style.display = 'block';
                } else {
                    camposAditivo.style.display = 'none';
                    // Limpar campos quando desmarcar
                    const tipoAditivo = document.getElementById('id_tipo_aditivo');
                    const quantidadeAditivo = document.getElementById('id_quantidade_aditivo');
                    const valorUnitarioAditivo = document.getElementById('id_valor_unitario_aditivo');
                    const valorTotalAditivo = document.getElementById('id_valor_total_aditivo');
                    const valorTotalNota = document.getElementById('id_valor_total_nota');
                    
                    if (tipoAditivo) tipoAditivo.value = '';
                    if (quantidadeAditivo) quantidadeAditivo.value = '';
                    if (valorUnitarioAditivo) valorUnitarioAditivo.value = '';
                    if (valorTotalAditivo) valorTotalAditivo.value = '';
                    if (valorTotalNota) calcularValorTotalNota();
                }
            }
        }
        
        // Fun√ß√£o para calcular valor total do aditivo
        function calcularValorTotalAditivo() {
            const quantidadeInput = document.getElementById('id_quantidade_aditivo');
            const valorUnitarioInput = document.getElementById('id_valor_unitario_aditivo');
            const valorTotalAditivoInput = document.getElementById('id_valor_total_aditivo');
            
            if (quantidadeInput && valorUnitarioInput && valorTotalAditivoInput) {
                const quantidade = parseFloat(quantidadeInput.value) || 0;
                const valorUnitario = parseFloat(obterValorNumerico(valorUnitarioInput.value)) || 0;
                
                if (quantidade > 0 && valorUnitario > 0) {
                    const valorTotal = quantidade * valorUnitario;
                    let valorTotalStr = valorTotal.toFixed(2);
                    let partes = valorTotalStr.split('.');
                    let parteInteira = partes[0];
                    let parteDecimal = partes[1] || '00';
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    valorTotalAditivoInput.value = parteInteira + ',' + parteDecimal;
                } else {
                    valorTotalAditivoInput.value = '';
                }
                
                calcularValorTotalNota();
            }
        }
        
        // Fun√ß√£o para calcular valor total da nota (combust√≠vel + aditivos)
        function calcularValorTotalNota() {
            const valorTotalCombustivelInput = document.getElementById('id_valor_total');
            const valorTotalAditivoInput = document.getElementById('id_valor_total_aditivo');
            const valorTotalNotaInput = document.getElementById('id_valor_total_nota');
            
            if (valorTotalCombustivelInput && valorTotalNotaInput) {
                const valorCombustivel = parseFloat(obterValorNumerico(valorTotalCombustivelInput.value)) || 0;
                const valorAditivo = valorTotalAditivoInput ? (parseFloat(obterValorNumerico(valorTotalAditivoInput.value)) || 0) : 0;
                
                const valorTotal = valorCombustivel + valorAditivo;
                
                if (valorTotal > 0) {
                    let valorTotalStr = valorTotal.toFixed(2);
                    let partes = valorTotalStr.split('.');
                    let parteInteira = partes[0];
                    let parteDecimal = partes[1] || '00';
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    valorTotalNotaInput.value = parteInteira + ',' + parteDecimal;
                } else {
                    valorTotalNotaInput.value = '';
                }
            }
        }
        
        // Event listeners para aditivos
        const comAditivosCheckbox = document.getElementById('id_com_aditivos');
        if (comAditivosCheckbox) {
            comAditivosCheckbox.addEventListener('change', toggleCamposAditivo);
            toggleCamposAditivo(); // Inicializar estado
        }
        
        const quantidadeAditivoInput = document.getElementById('id_quantidade_aditivo');
        if (quantidadeAditivoInput) {
            quantidadeAditivoInput.addEventListener('input', calcularValorTotalAditivo);
            quantidadeAditivoInput.addEventListener('change', calcularValorTotalAditivo);
        }
        
        const valorUnitarioAditivoInput = document.getElementById('id_valor_unitario_aditivo');
        if (valorUnitarioAditivoInput) {
            valorUnitarioAditivoInput.addEventListener('input', function(e) {
                let valor = e.target.value;
                let valorLimpo = valor.replace(/[^\d,]/g, '');
                let partes = valorLimpo.split(',');
                if (partes.length > 2) {
                    valorLimpo = partes[0] + ',' + partes.slice(1).join('');
                }
                if (partes.length === 2 && partes[1].length > 2) {
                    valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
                }
                if (valorLimpo !== valor) {
                    let cursorPos = e.target.selectionStart;
                    e.target.value = valorLimpo;
                    setTimeout(() => {
                        let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                        e.target.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                }
                calcularValorTotalAditivo();
            });
            
            valorUnitarioAditivoInput.addEventListener('blur', function(e) {
                let valor = e.target.value.trim();
                if (!valor || valor === '') {
                    e.target.value = '';
                    calcularValorTotalAditivo();
                    return;
                }
                
                if (valor.includes(',')) {
                    let partes = valor.split(',');
                    let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                    let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                    
                    while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                        parteDecimal += '0';
                    }
                    if (parteDecimal === '') {
                        parteDecimal = '00';
                    }
                    
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = parteInteira + ',' + parteDecimal;
                } else {
                    let numeroLimpo = valor.replace(/[^\d]/g, '');
                    if (numeroLimpo !== '') {
                        numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = numeroLimpo + ',00';
                    } else {
                        e.target.value = '';
                    }
                }
                
                calcularValorTotalAditivo();
            });
            
            valorUnitarioAditivoInput.addEventListener('change', calcularValorTotalAditivo);
        }
        
        // Recalcular valor total da nota quando valor total do combust√≠vel mudar
        const valorTotalCombustivelInput = document.getElementById('id_valor_total');
        if (valorTotalCombustivelInput) {
            valorTotalCombustivelInput.addEventListener('input', calcularValorTotalNota);
            valorTotalCombustivelInput.addEventListener('change', calcularValorTotalNota);
        }
        
        // Preparar valores para envio
        const form = document.getElementById('abastecimentoFormMobile');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Validar KM antes de submeter
                if (kmInput) {
                    const valorKm = parseFloat(kmInput.value);
                    if (valorKm && valorKm < ultimoKm) {
                        e.preventDefault();
                        kmInput.classList.add('is-invalid');
                        kmValidationMessage.classList.remove('d-none');
                        kmValidationText.textContent = `N√£o √© poss√≠vel registrar um KM menor que o √∫ltimo registrado (${ultimoKm}). Por favor, corrija o valor.`;
                        kmInput.focus();
                        return false;
                    }
                }
                
                const valorLitro = document.getElementById('id_valor_litro');
                const valorTotal = document.getElementById('id_valor_total');
                const valorUnitarioAditivo = document.getElementById('id_valor_unitario_aditivo');
                const valorTotalAditivo = document.getElementById('id_valor_total_aditivo');
                const valorTotalNota = document.getElementById('id_valor_total_nota');
                
                if (valorLitro && valorLitro.value) {
                    valorLitro.value = obterValorNumerico(valorLitro.value);
                }
                
                if (valorTotal && valorTotal.value) {
                    valorTotal.value = obterValorNumerico(valorTotal.value);
                }
                
                if (valorUnitarioAditivo && valorUnitarioAditivo.value) {
                    valorUnitarioAditivo.value = obterValorNumerico(valorUnitarioAditivo.value);
                }
                
                if (valorTotalAditivo && valorTotalAditivo.value) {
                    valorTotalAditivo.value = obterValorNumerico(valorTotalAditivo.value);
                }
                
                if (valorTotalNota && valorTotalNota.value) {
                    valorTotalNota.value = obterValorNumerico(valorTotalNota.value);
                }
            });
        }
        
        // Inicializar c√°lculos
        calcularValorTotalAditivo();
        calcularValorTotalNota();
        
        // ========== SCRIPTS PARA TROCA DE √ìLEO ==========
        // Configurar data/hora atual como padr√£o para troca de √≥leo
        const dataTrocaOleoInput = document.getElementById('id_data_troca');
        if (dataTrocaOleoInput && !dataTrocaOleoInput.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            dataTrocaOleoInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Fun√ß√£o para calcular valor total do √≥leo
        function calcularValorTotalTrocaOleo() {
            const quantidadeInput = document.getElementById('id_quantidade_litros_troca');
            const valorLitroInput = document.getElementById('id_valor_litro_troca');
            const valorTotalInput = document.getElementById('id_valor_total_troca');
            
            if (quantidadeInput && valorLitroInput && valorTotalInput) {
                const quantidade = parseFloat(quantidadeInput.value) || 0;
                const valorLitro = parseFloat(obterValorNumerico(valorLitroInput.value)) || 0;
                
                if (quantidade > 0 && valorLitro > 0) {
                    const valorTotal = quantidade * valorLitro;
                    let valorTotalStr = valorTotal.toFixed(2);
                    let partes = valorTotalStr.split('.');
                    let parteInteira = partes[0];
                    let parteDecimal = partes[1] || '00';
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    valorTotalInput.value = parteInteira + ',' + parteDecimal;
                } else {
                    valorTotalInput.value = '';
                }
                
                calcularValorTotalNotaTrocaOleo();
            }
        }
        
        // ==================== GERENCIAMENTO DE OUTRAS PE√áAS ====================
        let contadorPecasMobile = 0;
        
        // Fun√ß√£o auxiliar formatarValor (usada na tabela)
        function formatarValorPecasMobile(valor) {
            if (valor > 0) {
                let valorStr = valor.toFixed(2);
                let partes = valorStr.split('.');
                let parteInteira = partes[0];
                let parteDecimal = partes[1] || '00';
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return parteInteira + ',' + parteDecimal;
            }
            return '';
        }
        
        // Fun√ß√£o para calcular o total de uma pe√ßa
        function calcularTotalPecaMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay) {
            const quantidade = parseFloat(quantidadeInput.value) || 0;
            const valorUnitario = parseFloat(obterValorNumerico(valorUnitarioInput.value)) || 0;
            const total = quantidade * valorUnitario;
            
            const valorFormatado = formatarValorPecasMobile(total);
            
            if (totalInput) {
                totalInput.value = valorFormatado;
            }
            
            if (totalDisplay) {
                totalDisplay.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
            }
            
            atualizarTotalOutrasPecasMobile();
        }
        
        // Fun√ß√£o para atualizar o total geral das outras pe√ßas
        function atualizarTotalOutrasPecasMobile() {
            let totalGeral = 0;
            const tbody = document.getElementById('tbodyOutrasPecasMobile');
            if (!tbody) return;
            
            const linhas = tbody.querySelectorAll('tr');
            
            linhas.forEach(linha => {
                const totalInput = linha.querySelector('input[name="total_peca[]"]');
                if (totalInput && totalInput.value) {
                    const valorLimpo = obterValorNumerico(totalInput.value);
                    totalGeral += parseFloat(valorLimpo) || 0;
                }
            });
            
            // Atualizar exibi√ß√£o
            const totalSpan = document.getElementById('totalOutrasPecasMobile');
            if (totalSpan) {
                const valorFormatado = formatarValorPecasMobile(totalGeral);
                totalSpan.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
            }
            
            // Atualizar campo oculto (salvar como n√∫mero puro com ponto decimal para o backend)
            const valorOutrasPecasHidden = document.getElementById('id_valor_outras_pecas_mobile');
            if (valorOutrasPecasHidden) {
                if (totalGeral > 0) {
                    valorOutrasPecasHidden.value = totalGeral.toFixed(2);
                } else {
                    valorOutrasPecasHidden.value = '';
                }
            }
            
            // Atualizar campo de texto com nomes das pe√ßas
            atualizarTextoOutrasPecasMobile();
            
            // Recalcular valor total da nota
            calcularValorTotalNotaTrocaOleo();
        }
        
        // Fun√ß√£o para atualizar o texto das outras pe√ßas
        function atualizarTextoOutrasPecasMobile() {
            const tbody = document.getElementById('tbodyOutrasPecasMobile');
            if (!tbody) return;
            
            const linhas = tbody.querySelectorAll('tr');
            const listaPecas = [];
            
            linhas.forEach(linha => {
                const nomeInput = linha.querySelector('input[name="nome_peca[]"]');
                const quantidadeInput = linha.querySelector('input[name="quantidade_peca[]"]');
                const valorUnitarioInput = linha.querySelector('input[name="valor_unitario_peca[]"]');
                const totalInput = linha.querySelector('input[name="total_peca[]"]');
                
                if (nomeInput && nomeInput.value) {
                    const nome = nomeInput.value.trim();
                    const quantidade = quantidadeInput ? (quantidadeInput.value || '1') : '1';
                    const valorUnitario = valorUnitarioInput ? obterValorNumerico(valorUnitarioInput.value) : '0';
                    const total = totalInput ? obterValorNumerico(totalInput.value) : '0';
                    
                    if (nome) {
                        listaPecas.push(`${nome} - Qtd: ${quantidade} - Unit: R$ ${parseFloat(valorUnitario).toFixed(2).replace('.', ',')} - Total: R$ ${parseFloat(total).toFixed(2).replace('.', ',')}`);
                    }
                }
            });
            
            const outrasPecasHidden = document.getElementById('id_outras_pecas_mobile');
            if (outrasPecasHidden) {
                outrasPecasHidden.value = listaPecas.join('\n');
            }
        }
        
        // Fun√ß√£o para adicionar nova linha de pe√ßa
        function adicionarLinhaPecaMobile(nome = '', quantidade = '', valorUnitario = '', total = '') {
            contadorPecasMobile++;
            const tbody = document.getElementById('tbodyOutrasPecasMobile');
            if (!tbody) return;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input type="text" 
                           name="nome_peca[]" 
                           class="form-control form-control-sm" 
                           placeholder="Nome da pe√ßa"
                           value="${nome}"
                           autocomplete="off">
                </td>
                <td>
                    <input type="number" 
                           name="quantidade_peca[]" 
                           class="form-control form-control-sm quantidade-peca-mobile" 
                           placeholder="1"
                           min="0.01"
                           step="0.01"
                           value="${quantidade}"
                           autocomplete="off">
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">R$</span>
                        <input type="text" 
                               name="valor_unitario_peca[]" 
                               class="form-control valor-unitario-peca-mobile" 
                               placeholder="0,00"
                               value="${valorUnitario}"
                               autocomplete="off">
                    </div>
                </td>
                <td>
                    <input type="hidden" name="total_peca[]" value="${total}">
                    <span class="fw-bold text-success total-peca-display-mobile">${total ? 'R$ ' + total : 'R$ 0,00'}</span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btn-remover-peca-mobile" title="Remover pe√ßa">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
            
            // Configurar event listeners para os novos campos
            const quantidadeInput = tr.querySelector('.quantidade-peca-mobile');
            const valorUnitarioInput = tr.querySelector('.valor-unitario-peca-mobile');
            const totalInput = tr.querySelector('input[name="total_peca[]"]');
            const totalDisplay = tr.querySelector('.total-peca-display-mobile');
            
            // Formatar campo monet√°rio
            if (valorUnitarioInput && valorUnitarioInput.value) {
                valorUnitarioInput.value = formatarMoedaBRL(valorUnitarioInput.value);
            }
            
            // Event listeners para calcular total
            quantidadeInput.addEventListener('input', function() {
                calcularTotalPecaMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            quantidadeInput.addEventListener('change', function() {
                calcularTotalPecaMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            valorUnitarioInput.addEventListener('input', function() {
                this.value = formatarMoedaBRL(this.value);
                calcularTotalPecaMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            valorUnitarioInput.addEventListener('blur', function() {
                this.value = formatarMoedaBRL(this.value);
                calcularTotalPecaMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            // Event listener para atualizar texto ao mudar nome
            const nomeInput = tr.querySelector('input[name="nome_peca[]"]');
            nomeInput.addEventListener('blur', atualizarTextoOutrasPecasMobile);
            
            // Bot√£o remover
            const btnRemover = tr.querySelector('.btn-remover-peca-mobile');
            btnRemover.addEventListener('click', function() {
                tr.remove();
                atualizarTotalOutrasPecasMobile();
            });
        }
        
        // Bot√£o adicionar pe√ßa
        const btnAdicionarPecaMobile = document.getElementById('btnAdicionarPecaMobile');
        if (btnAdicionarPecaMobile) {
            btnAdicionarPecaMobile.addEventListener('click', function() {
                adicionarLinhaPecaMobile();
            });
        }
        
        // Carregar pe√ßas existentes se estiver editando (n√£o aplic√°vel neste formul√°rio mobile, mas mantido para compatibilidade)
        // Este formul√°rio √© sempre de cria√ß√£o, n√£o edi√ß√£o
        
        // ==================== FIM GERENCIAMENTO DE OUTRAS PE√áAS ====================
        
        // Fun√ß√£o para calcular valor total da nota (√≥leo + filtros + aditivo + outras pe√ßas)
        function calcularValorTotalNotaTrocaOleo() {
            const valorTotalOleoInput = document.getElementById('id_valor_total_troca');
            const valorFiltroOleoInput = document.getElementById('id_valor_filtro_oleo_mobile');
            const valorFiltroCombustivelInput = document.getElementById('id_valor_filtro_combustivel_mobile');
            const valorFiltroArInput = document.getElementById('id_valor_filtro_ar_mobile');
            const valorAditivoArrefecimentoInput = document.getElementById('id_valor_aditivo_arrefecimento_mobile');
            const valorOutrasPecasInput = document.getElementById('id_valor_outras_pecas_mobile');
            const valorTotalNotaInput = document.getElementById('id_valor_total_nota_troca');
            
            if (valorTotalOleoInput && valorTotalNotaInput) {
                const valorOleo = parseFloat(obterValorNumerico(valorTotalOleoInput.value)) || 0;
                const valorFiltroOleo = valorFiltroOleoInput ? (parseFloat(obterValorNumerico(valorFiltroOleoInput.value)) || 0) : 0;
                const valorFiltroCombustivel = valorFiltroCombustivelInput ? (parseFloat(obterValorNumerico(valorFiltroCombustivelInput.value)) || 0) : 0;
                const valorFiltroAr = valorFiltroArInput ? (parseFloat(obterValorNumerico(valorFiltroArInput.value)) || 0) : 0;
                const valorAditivo = valorAditivoArrefecimentoInput ? (parseFloat(obterValorNumerico(valorAditivoArrefecimentoInput.value)) || 0) : 0;
                const valorOutrasPecas = valorOutrasPecasInput && valorOutrasPecasInput.value ? (parseFloat(valorOutrasPecasInput.value) || 0) : 0;
                
                const valorTotal = valorOleo + valorFiltroOleo + valorFiltroCombustivel + valorFiltroAr + valorAditivo + valorOutrasPecas;
                
                if (valorTotal > 0) {
                    let valorTotalStr = valorTotal.toFixed(2);
                    let partes = valorTotalStr.split('.');
                    let parteInteira = partes[0];
                    let parteDecimal = partes[1] || '00';
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    valorTotalNotaInput.value = parteInteira + ',' + parteDecimal;
                } else {
                    valorTotalNotaInput.value = '';
                }
            }
        }
        
        // Event listeners para troca de √≥leo
        const quantidadeTrocaOleoInput = document.getElementById('id_quantidade_litros_troca');
        if (quantidadeTrocaOleoInput) {
            quantidadeTrocaOleoInput.addEventListener('input', calcularValorTotalTrocaOleo);
            quantidadeTrocaOleoInput.addEventListener('change', calcularValorTotalTrocaOleo);
        }
        
        const valorLitroTrocaOleoInput = document.getElementById('id_valor_litro_troca');
        if (valorLitroTrocaOleoInput) {
            valorLitroTrocaOleoInput.addEventListener('input', function(e) {
                let valor = e.target.value;
                let valorLimpo = valor.replace(/[^\d,]/g, '');
                let partes = valorLimpo.split(',');
                if (partes.length > 2) {
                    valorLimpo = partes[0] + ',' + partes.slice(1).join('');
                }
                if (partes.length === 2 && partes[1].length > 2) {
                    valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
                }
                if (valorLimpo !== valor) {
                    let cursorPos = e.target.selectionStart;
                    e.target.value = valorLimpo;
                    setTimeout(() => {
                        let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                        e.target.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                }
                calcularValorTotalTrocaOleo();
            });
            
            valorLitroTrocaOleoInput.addEventListener('blur', function(e) {
                let valor = e.target.value.trim();
                if (!valor || valor === '') {
                    e.target.value = '';
                    calcularValorTotalTrocaOleo();
                    return;
                }
                
                if (valor.includes(',')) {
                    let partes = valor.split(',');
                    let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                    let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                    
                    while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                        parteDecimal += '0';
                    }
                    if (parteDecimal === '') {
                        parteDecimal = '00';
                    }
                    
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = parteInteira + ',' + parteDecimal;
                } else {
                    let numeroLimpo = valor.replace(/[^\d]/g, '');
                    if (numeroLimpo !== '') {
                        numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = numeroLimpo + ',00';
                    } else {
                        e.target.value = '';
                    }
                }
                
                calcularValorTotalTrocaOleo();
            });
            
            valorLitroTrocaOleoInput.addEventListener('change', calcularValorTotalTrocaOleo);
        }
        
        // Mostrar/ocultar campos de filtros e aditivo
        function toggleCamposTrocaOleo() {
            // Filtro de √ìleo
            const trocouFiltroOleo = document.querySelector('input[name="trocou_filtro_oleo"]');
            const campoValorFiltroOleo = document.getElementById('campoValorFiltroOleoMobile');
            if (trocouFiltroOleo && campoValorFiltroOleo) {
                campoValorFiltroOleo.style.display = trocouFiltroOleo.checked ? 'block' : 'none';
                if (!trocouFiltroOleo.checked) {
                    const valorInput = document.getElementById('id_valor_filtro_oleo_mobile');
                    if (valorInput) valorInput.value = '';
                }
                calcularValorTotalNotaTrocaOleo();
            }
            
            // Filtro de Combust√≠vel
            const trocouFiltroCombustivel = document.querySelector('input[name="trocou_filtro_combustivel"]');
            const campoValorFiltroCombustivel = document.getElementById('campoValorFiltroCombustivelMobile');
            if (trocouFiltroCombustivel && campoValorFiltroCombustivel) {
                campoValorFiltroCombustivel.style.display = trocouFiltroCombustivel.checked ? 'block' : 'none';
                if (!trocouFiltroCombustivel.checked) {
                    const valorInput = document.getElementById('id_valor_filtro_combustivel_mobile');
                    if (valorInput) valorInput.value = '';
                }
                calcularValorTotalNotaTrocaOleo();
            }
            
            // Filtro de Ar
            const trocouFiltroAr = document.querySelector('input[name="trocou_filtro_ar"]');
            const campoValorFiltroAr = document.getElementById('campoValorFiltroArMobile');
            if (trocouFiltroAr && campoValorFiltroAr) {
                campoValorFiltroAr.style.display = trocouFiltroAr.checked ? 'block' : 'none';
                if (!trocouFiltroAr.checked) {
                    const valorInput = document.getElementById('id_valor_filtro_ar_mobile');
                    if (valorInput) valorInput.value = '';
                }
                calcularValorTotalNotaTrocaOleo();
            }
            
            // Aditivo de Arrefecimento
            const adicionouAditivo = document.querySelector('input[name="adicionou_aditivo_arrefecimento"]');
            const campoAditivoArrefecimento = document.getElementById('campoAditivoArrefecimentoMobile');
            if (adicionouAditivo && campoAditivoArrefecimento) {
                campoAditivoArrefecimento.style.display = adicionouAditivo.checked ? 'block' : 'none';
                if (!adicionouAditivo.checked) {
                    const qtdInput = document.getElementById('id_quantidade_aditivo_arrefecimento_mobile');
                    const valorInput = document.getElementById('id_valor_aditivo_arrefecimento_mobile');
                    if (qtdInput) qtdInput.value = '';
                    if (valorInput) valorInput.value = '';
                }
                calcularValorTotalNotaTrocaOleo();
            }
        }
        
        // Event listeners para checkboxes de troca de √≥leo
        const trocouFiltroOleoCheckbox = document.querySelector('input[name="trocou_filtro_oleo"]');
        if (trocouFiltroOleoCheckbox) {
            trocouFiltroOleoCheckbox.addEventListener('change', toggleCamposTrocaOleo);
        }
        
        const trocouFiltroCombustivelCheckbox = document.querySelector('input[name="trocou_filtro_combustivel"]');
        if (trocouFiltroCombustivelCheckbox) {
            trocouFiltroCombustivelCheckbox.addEventListener('change', toggleCamposTrocaOleo);
        }
        
        const trocouFiltroArCheckbox = document.querySelector('input[name="trocou_filtro_ar"]');
        if (trocouFiltroArCheckbox) {
            trocouFiltroArCheckbox.addEventListener('change', toggleCamposTrocaOleo);
        }
        
        const adicionouAditivoCheckbox = document.querySelector('input[name="adicionou_aditivo_arrefecimento"]');
        if (adicionouAditivoCheckbox) {
            adicionouAditivoCheckbox.addEventListener('change', toggleCamposTrocaOleo);
        }
        
        // Formata√ß√£o de moeda para valores de filtros e aditivo
        const camposValorTrocaOleo = [
            'id_valor_filtro_oleo_mobile',
            'id_valor_filtro_combustivel_mobile',
            'id_valor_filtro_ar_mobile',
            'id_valor_aditivo_arrefecimento_mobile'
        ];
        
        camposValorTrocaOleo.forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('input', function(e) {
                    let valor = e.target.value;
                    let valorLimpo = valor.replace(/[^\d,]/g, '');
                    let partes = valorLimpo.split(',');
                    if (partes.length > 2) {
                        valorLimpo = partes[0] + ',' + partes.slice(1).join('');
                    }
                    if (partes.length === 2 && partes[1].length > 2) {
                        valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
                    }
                    if (valorLimpo !== valor) {
                        let cursorPos = e.target.selectionStart;
                        e.target.value = valorLimpo;
                        setTimeout(() => {
                            let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                            e.target.setSelectionRange(newCursorPos, newCursorPos);
                        }, 0);
                    }
                    calcularValorTotalNotaTrocaOleo();
                });
                
                campo.addEventListener('blur', function(e) {
                    let valor = e.target.value.trim();
                    if (!valor || valor === '') {
                        e.target.value = '';
                        calcularValorTotalNotaTrocaOleo();
                        return;
                    }
                    
                    if (valor.includes(',')) {
                        let partes = valor.split(',');
                        let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                        let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                        
                        while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                            parteDecimal += '0';
                        }
                        if (parteDecimal === '') {
                            parteDecimal = '00';
                        }
                        
                        parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = parteInteira + ',' + parteDecimal;
                    } else {
                        let numeroLimpo = valor.replace(/[^\d]/g, '');
                        if (numeroLimpo !== '') {
                            numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                            e.target.value = numeroLimpo + ',00';
                        } else {
                            e.target.value = '';
                        }
                    }
                    
                    calcularValorTotalNotaTrocaOleo();
                });
            }
        });
        
        // Preparar valores para envio do formul√°rio de troca de √≥leo
        const formTrocaOleo = document.getElementById('trocaOleoFormMobile');
        if (formTrocaOleo) {
            formTrocaOleo.addEventListener('submit', function(e) {
                const valorLitro = document.getElementById('id_valor_litro_troca');
                const valorTotal = document.getElementById('id_valor_total_troca');
                const valorTotalNota = document.getElementById('id_valor_total_nota_troca');
                const valorFiltroOleo = document.getElementById('id_valor_filtro_oleo_mobile');
                const valorFiltroCombustivel = document.getElementById('id_valor_filtro_combustivel_mobile');
                const valorFiltroAr = document.getElementById('id_valor_filtro_ar_mobile');
                const valorAditivoArrefecimento = document.getElementById('id_valor_aditivo_arrefecimento_mobile');
                
                // Garantir que o total de outras pe√ßas est√° atualizado antes do submit
                atualizarTotalOutrasPecasMobile();
                
                if (valorLitro && valorLitro.value) {
                    valorLitro.value = obterValorNumerico(valorLitro.value);
                }
                
                if (valorTotal && valorTotal.value) {
                    valorTotal.value = obterValorNumerico(valorTotal.value);
                }
                
                if (valorTotalNota && valorTotalNota.value) {
                    valorTotalNota.value = obterValorNumerico(valorTotalNota.value);
                }
                
                if (valorFiltroOleo && valorFiltroOleo.value) {
                    valorFiltroOleo.value = obterValorNumerico(valorFiltroOleo.value);
                }
                
                if (valorFiltroCombustivel && valorFiltroCombustivel.value) {
                    valorFiltroCombustivel.value = obterValorNumerico(valorFiltroCombustivel.value);
                }
                
                if (valorFiltroAr && valorFiltroAr.value) {
                    valorFiltroAr.value = obterValorNumerico(valorFiltroAr.value);
                }
                
                if (valorAditivoArrefecimento && valorAditivoArrefecimento.value) {
                    valorAditivoArrefecimento.value = obterValorNumerico(valorAditivoArrefecimento.value);
                }
                
                // valor_outras_pecas j√° est√° atualizado como n√∫mero no campo hidden pela fun√ß√£o atualizarTotalOutrasPecasMobile()
            });
        }
        
        // Inicializar campos de troca de √≥leo
        toggleCamposTrocaOleo();
        calcularValorTotalTrocaOleo();
        calcularValorTotalNotaTrocaOleo();
        
        // ========== SCRIPTS PARA MANUTEN√á√ÉO ==========
        // Configurar data/hora atual como padr√£o para manuten√ß√£o
        const dataManutencaoInput = document.getElementById('id_data_manutencao');
        if (dataManutencaoInput && !dataManutencaoInput.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            dataManutencaoInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Valida√ß√£o de KM para manuten√ß√£o
        const kmManutencaoInput = document.getElementById('id_km_manutencao');
        const kmManutencaoValidationMessage = document.getElementById('km_manutencao_validation_message');
        const kmManutencaoValidationText = document.getElementById('km_manutencao_validation_text');
        
        {% if ultima_manutencao %}
        const ultimoKmManutencao = {{ ultima_manutencao.km_manutencao }};
        {% else %}
        const ultimoKmManutencao = {{ viatura.km_atual|default:0 }};
        {% endif %}
        
        if (kmManutencaoInput) {
            kmManutencaoInput.addEventListener('input', function(e) {
                const valorDigitado = parseFloat(e.target.value);
                
                if (valorDigitado && valorDigitado < ultimoKmManutencao) {
                    e.target.classList.add('is-invalid');
                    kmManutencaoValidationMessage.classList.remove('d-none');
                    kmManutencaoValidationText.textContent = `O KM informado (${valorDigitado}) √© menor que o √∫ltimo KM registrado (${ultimoKmManutencao}). Digite um valor maior ou igual.`;
                } else {
                    e.target.classList.remove('is-invalid');
                    kmManutencaoValidationMessage.classList.add('d-none');
                }
            });
            
            kmManutencaoInput.addEventListener('blur', function(e) {
                const valorDigitado = parseFloat(e.target.value);
                
                if (valorDigitado && valorDigitado < ultimoKmManutencao) {
                    e.target.classList.add('is-invalid');
                    kmManutencaoValidationMessage.classList.remove('d-none');
                    kmManutencaoValidationText.textContent = `O KM informado (${valorDigitado}) √© menor que o √∫ltimo KM registrado (${ultimoKmManutencao}). Digite um valor maior ou igual.`;
                    e.target.focus();
                } else {
                    e.target.classList.remove('is-invalid');
                    kmManutencaoValidationMessage.classList.add('d-none');
                }
            });
        }
        
        // ==================== GERENCIAMENTO DE PE√áAS NA MANUTEN√á√ÉO ====================
        let contadorPecasManutencaoMobile = 0;
        
        // Fun√ß√£o auxiliar formatarValor (usada na tabela)
        function formatarValorPecasManutencaoMobile(valor) {
            if (valor > 0) {
                let valorStr = valor.toFixed(2);
                let partes = valorStr.split('.');
                let parteInteira = partes[0];
                let parteDecimal = partes[1] || '00';
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return parteInteira + ',' + parteDecimal;
            }
            return '';
        }
        
        // Fun√ß√£o para calcular o total de uma pe√ßa
        function calcularTotalPecaManutencaoMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay) {
            const quantidade = parseFloat(quantidadeInput.value) || 0;
            const valorUnitario = parseFloat(obterValorNumerico(valorUnitarioInput.value)) || 0;
            const total = quantidade * valorUnitario;
            
            const valorFormatado = formatarValorPecasManutencaoMobile(total);
            
            if (totalInput) {
                totalInput.value = valorFormatado;
            }
            
            if (totalDisplay) {
                totalDisplay.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
            }
            
            atualizarTotalPecasManutencaoMobile();
        }
        
        // Fun√ß√£o para atualizar o total geral das pe√ßas
        function atualizarTotalPecasManutencaoMobile() {
            let totalGeral = 0;
            const tbody = document.getElementById('tbodyPecasManutencaoMobile');
            if (!tbody) return;
            
            const linhas = tbody.querySelectorAll('tr');
            
            linhas.forEach(linha => {
                const totalInput = linha.querySelector('input[name="total_peca_manutencao[]"]');
                if (totalInput && totalInput.value) {
                    const valorLimpo = obterValorNumerico(totalInput.value);
                    totalGeral += parseFloat(valorLimpo) || 0;
                }
            });
            
            // Atualizar exibi√ß√£o
            const totalSpan = document.getElementById('totalPecasManutencaoMobile');
            if (totalSpan) {
                const valorFormatado = formatarValorPecasManutencaoMobile(totalGeral);
                totalSpan.textContent = valorFormatado ? 'R$ ' + valorFormatado : 'R$ 0,00';
            }
            
            // Atualizar campo de texto com nomes das pe√ßas
            atualizarTextoPecasManutencaoMobile();
        }
        
        // Fun√ß√£o para atualizar o texto das pe√ßas
        function atualizarTextoPecasManutencaoMobile() {
            const tbody = document.getElementById('tbodyPecasManutencaoMobile');
            if (!tbody) return;
            
            const linhas = tbody.querySelectorAll('tr');
            const listaPecas = [];
            
            linhas.forEach(linha => {
                const nomeInput = linha.querySelector('input[name="nome_peca_manutencao[]"]');
                const quantidadeInput = linha.querySelector('input[name="quantidade_peca_manutencao[]"]');
                const valorUnitarioInput = linha.querySelector('input[name="valor_unitario_peca_manutencao[]"]');
                const totalInput = linha.querySelector('input[name="total_peca_manutencao[]"]');
                
                if (nomeInput && nomeInput.value) {
                    const nome = nomeInput.value.trim();
                    const quantidade = quantidadeInput ? (quantidadeInput.value || '1') : '1';
                    const valorUnitario = valorUnitarioInput ? obterValorNumerico(valorUnitarioInput.value) : '0';
                    const total = totalInput ? obterValorNumerico(totalInput.value) : '0';
                    
                    if (nome) {
                        listaPecas.push(`${nome} - Qtd: ${quantidade} - Unit: R$ ${parseFloat(valorUnitario).toFixed(2).replace('.', ',')} - Total: R$ ${parseFloat(total).toFixed(2).replace('.', ',')}`);
                    }
                }
            });
            
            const pecasTrocadasHidden = document.getElementById('id_pecas_trocadas_mobile');
            if (pecasTrocadasHidden) {
                pecasTrocadasHidden.value = listaPecas.join('\n');
            }
        }
        
        // Fun√ß√£o para adicionar nova linha de pe√ßa
        function adicionarLinhaPecaManutencaoMobile(nome = '', quantidade = '', valorUnitario = '', total = '') {
            contadorPecasManutencaoMobile++;
            const tbody = document.getElementById('tbodyPecasManutencaoMobile');
            if (!tbody) return;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input type="text" 
                           name="nome_peca_manutencao[]" 
                           class="form-control form-control-sm" 
                           placeholder="Nome da pe√ßa"
                           value="${nome}"
                           autocomplete="off">
                </td>
                <td>
                    <input type="number" 
                           name="quantidade_peca_manutencao[]" 
                           class="form-control form-control-sm quantidade-peca-manutencao-mobile" 
                           placeholder="1"
                           min="0.01"
                           step="0.01"
                           value="${quantidade}"
                           autocomplete="off">
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">R$</span>
                        <input type="text" 
                               name="valor_unitario_peca_manutencao[]" 
                               class="form-control valor-unitario-peca-manutencao-mobile" 
                               placeholder="0,00"
                               value="${valorUnitario}"
                               autocomplete="off">
                    </div>
                </td>
                <td>
                    <input type="hidden" name="total_peca_manutencao[]" value="${total}">
                    <span class="fw-bold text-success total-peca-display-manutencao-mobile">${total ? 'R$ ' + total : 'R$ 0,00'}</span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btn-remover-peca-manutencao-mobile" title="Remover pe√ßa">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
            
            // Configurar event listeners para os novos campos
            const quantidadeInput = tr.querySelector('.quantidade-peca-manutencao-mobile');
            const valorUnitarioInput = tr.querySelector('.valor-unitario-peca-manutencao-mobile');
            const totalInput = tr.querySelector('input[name="total_peca_manutencao[]"]');
            const totalDisplay = tr.querySelector('.total-peca-display-manutencao-mobile');
            
            // Formatar campo monet√°rio
            if (valorUnitarioInput && valorUnitarioInput.value) {
                valorUnitarioInput.value = formatarMoedaBRL(valorUnitarioInput.value);
            }
            
            // Event listeners para calcular total
            quantidadeInput.addEventListener('input', function() {
                calcularTotalPecaManutencaoMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            quantidadeInput.addEventListener('change', function() {
                calcularTotalPecaManutencaoMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            valorUnitarioInput.addEventListener('input', function() {
                this.value = formatarMoedaBRL(this.value);
                calcularTotalPecaManutencaoMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            valorUnitarioInput.addEventListener('blur', function() {
                this.value = formatarMoedaBRL(this.value);
                calcularTotalPecaManutencaoMobile(quantidadeInput, valorUnitarioInput, totalInput, totalDisplay);
            });
            
            // Event listener para atualizar texto ao mudar nome
            const nomeInput = tr.querySelector('input[name="nome_peca_manutencao[]"]');
            nomeInput.addEventListener('blur', atualizarTextoPecasManutencaoMobile);
            
            // Bot√£o remover
            const btnRemover = tr.querySelector('.btn-remover-peca-manutencao-mobile');
            btnRemover.addEventListener('click', function() {
                tr.remove();
                atualizarTotalPecasManutencaoMobile();
            });
        }
        
        // Bot√£o adicionar pe√ßa
        const btnAdicionarPecaManutencaoMobile = document.getElementById('btnAdicionarPecaManutencaoMobile');
        if (btnAdicionarPecaManutencaoMobile) {
            btnAdicionarPecaManutencaoMobile.addEventListener('click', function() {
                adicionarLinhaPecaManutencaoMobile();
            });
        }
        
        // Carregar pe√ßas existentes se estiver editando (n√£o aplic√°vel neste formul√°rio mobile, mas mantido para compatibilidade)
        // Este formul√°rio √© sempre de cria√ß√£o, n√£o edi√ß√£o
        
        // ==================== FIM GERENCIAMENTO DE PE√áAS NA MANUTEN√á√ÉO ====================
        
        // Formata√ß√£o de moeda para valor da manuten√ß√£o
        const valorManutencaoInput = document.getElementById('id_valor_manutencao');
        if (valorManutencaoInput) {
            valorManutencaoInput.addEventListener('input', function(e) {
                let valor = e.target.value;
                let valorLimpo = valor.replace(/[^\d,]/g, '');
                let partes = valorLimpo.split(',');
                if (partes.length > 2) {
                    valorLimpo = partes[0] + ',' + partes.slice(1).join('');
                }
                if (partes.length === 2 && partes[1].length > 2) {
                    valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
                }
                if (valorLimpo !== valor) {
                    let cursorPos = e.target.selectionStart;
                    e.target.value = valorLimpo;
                    setTimeout(() => {
                        let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                        e.target.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                }
            });
            
            valorManutencaoInput.addEventListener('blur', function(e) {
                let valor = e.target.value.trim();
                if (!valor || valor === '') {
                    e.target.value = '';
                    return;
                }
                
                if (valor.includes(',')) {
                    let partes = valor.split(',');
                    let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                    let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                    
                    while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                        parteDecimal += '0';
                    }
                    if (parteDecimal === '') {
                        parteDecimal = '00';
                    }
                    
                    parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = parteInteira + ',' + parteDecimal;
                } else {
                    let numeroLimpo = valor.replace(/[^\d]/g, '');
                    if (numeroLimpo !== '') {
                        numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = numeroLimpo + ',00';
                    } else {
                        e.target.value = '';
                    }
                }
            });
        }
        
        // Preparar valores para envio do formul√°rio de manuten√ß√£o
        const formManutencao = document.getElementById('manutencaoFormMobile');
        if (formManutencao) {
            formManutencao.addEventListener('submit', function(e) {
                // Garantir que o total de pe√ßas est√° atualizado antes do submit
                atualizarTotalPecasManutencaoMobile();
                
                // Validar KM antes de submeter
                if (kmManutencaoInput) {
                    const valorKm = parseFloat(kmManutencaoInput.value);
                    if (valorKm && valorKm < ultimoKmManutencao) {
                        e.preventDefault();
                        kmManutencaoInput.classList.add('is-invalid');
                        kmManutencaoValidationMessage.classList.remove('d-none');
                        kmManutencaoValidationText.textContent = `N√£o √© poss√≠vel registrar um KM menor que o √∫ltimo registrado (${ultimoKmManutencao}). Por favor, corrija o valor.`;
                        kmManutencaoInput.focus();
                        return false;
                    }
                }
                
                // Converter valor formatado para num√©rico
                if (valorManutencaoInput && valorManutencaoInput.value) {
                    valorManutencaoInput.value = obterValorNumerico(valorManutencaoInput.value);
                }
            });
        }
        
        // ==================== FUN√á√ïES PARA CAPTURA DE CUPOM FISCAL ====================
        
        let streamCamera = null;
        let videoElement = null;
        
        // Definir fecharCamera primeiro para ser usada em abrirCamera
        function fecharCamera() {
            console.log('fecharCamera chamada');
            
            try {
                // Parar o stream da c√¢mera
                if (streamCamera) {
                    streamCamera.getTracks().forEach(function(track) {
                        track.stop();
                        console.log('Track da c√¢mera parado');
                    });
                    streamCamera = null;
                }
                
                // Limpar refer√™ncia do v√≠deo
                if (videoElement) {
                    videoElement.srcObject = null;
                    videoElement.pause();
                    videoElement = null;
                    console.log('V√≠deo limpo');
                } else {
                    // Tentar buscar o elemento novamente
                    const videoEl = document.getElementById('videoCamera');
                    if (videoEl) {
                        videoEl.srcObject = null;
                        videoEl.pause();
                        console.log('V√≠deo limpo (busca direta)');
                    }
                }
                
                // Remover modal
                const modal = document.getElementById('modalCamera');
                if (modal) {
                    modal.remove();
                    console.log('Modal removido');
                } else {
                    console.error('Modal n√£o encontrado');
                }
            } catch (error) {
                console.error('Erro ao fechar c√¢mera:', error);
            }
        }
        
        // Definir capturarFoto antes de abrirCamera
        function capturarFoto() {
            console.log('capturarFoto chamada');
            
            try {
                // Buscar o elemento de v√≠deo novamente (caso tenha sido perdido)
                if (!videoElement) {
                    videoElement = document.getElementById('videoCamera');
                }
                
                if (!videoElement) {
                    alert('Erro: Elemento de v√≠deo n√£o encontrado.');
                    console.error('videoElement n√£o encontrado');
                    return;
                }
                
                const canvas = document.getElementById('canvasCamera');
                if (!canvas) {
                    alert('Erro: Canvas n√£o encontrado.');
                    console.error('Canvas n√£o encontrado');
                    return;
                }
                
                const video = videoElement;
                console.log('Video element encontrado:', video);
                console.log('Video readyState:', video.readyState);
                console.log('Video videoWidth:', video.videoWidth);
                console.log('Video videoHeight:', video.videoHeight);
                
                // Verificar se o v√≠deo est√° pronto
                if (video.readyState < video.HAVE_METADATA) {
                    alert('Aguarde a c√¢mera carregar completamente.');
                    console.log('Video ainda n√£o est√° pronto, readyState:', video.readyState);
                    return;
                }
                
                // Obter dimens√µes reais do v√≠deo
                const videoWidth = video.videoWidth || video.clientWidth || 640;
                const videoHeight = video.videoHeight || video.clientHeight || 480;
                
                console.log('Dimens√µes do v√≠deo:', videoWidth, 'x', videoHeight);
                
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                console.log('Imagem desenhada no canvas');
                
                // Converter canvas para blob e criar File
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        alert('Erro ao capturar a imagem. Tente novamente.');
                        console.error('Blob n√£o foi criado');
                        return;
                    }
                    
                    console.log('Blob criado com sucesso, tamanho:', blob.size);
                    
                    const file = new File([blob], 'cupom_fiscal_' + Date.now() + '.jpg', { type: 'image/jpeg' });
                    
                    // Criar DataTransfer para simular input file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    
                    const input = document.getElementById('cupom_fiscal_input');
                    if (input) {
                        input.files = dataTransfer.files;
                        console.log('Arquivo adicionado ao input:', input.files.length);
                        
                        // Mostrar preview
                        previewImagem(input);
                        
                        // Fechar c√¢mera
                        fecharCamera();
                        
                        console.log('Foto capturada com sucesso!');
                    } else {
                        alert('Erro: Campo de input n√£o encontrado.');
                        console.error('Input cupom_fiscal_input n√£o encontrado');
                    }
                }, 'image/jpeg', 0.9);
                
            } catch (error) {
                console.error('Erro ao capturar foto:', error);
                alert('Erro ao capturar a foto: ' + error.message);
            }
        }
        
        // Adicionar event listener ao bot√£o da c√¢mera
        const btnCamera = document.getElementById('btnCamera');
        if (btnCamera) {
            btnCamera.addEventListener('click', function(e) {
                e.preventDefault();
                abrirCamera();
            });
        }
        
        // Tornar fun√ß√µes globais para acesso via onclick
        window.abrirCamera = abrirCamera;
        window.fecharCamera = fecharCamera;
        window.capturarFoto = capturarFoto;
        window.removerImagem = removerImagem;
        
        function abrirCamera() {
            console.log('Abrindo c√¢mera...');
            
            try {
            
            // Verificar se o navegador suporta getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                // Fallback para API antiga
                navigator.getUserMedia = navigator.getUserMedia || 
                                        navigator.webkitGetUserMedia || 
                                        navigator.mozGetUserMedia || 
                                        navigator.msGetUserMedia;
                
                if (!navigator.getUserMedia) {
                    alert('Seu navegador n√£o suporta captura de c√¢mera. Por favor, use a op√ß√£o de escolher da galeria.');
                    document.getElementById('cupom_fiscal_input').click();
                    return;
                }
            }
            
            // Fechar qualquer modal existente
            fecharCamera();
            
            // Criar modal para a c√¢mera
            const modalHTML = `
                <div class="modal fade show" id="modalCamera" tabindex="-1" style="display: block; background: rgba(0,0,0,0.9); z-index: 9999;" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
                        <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-camera me-2"></i>Capturar Cupom Fiscal
                                </h5>
                                <button type="button" class="btn-close btn-close-white" onclick="window.fecharCamera && window.fecharCamera();"></button>
                            </div>
                            <div class="modal-body p-0" style="background: #000;">
                                <div style="position: relative; width: 100%; padding-top: 75%;">
                                    <video id="videoCamera" autoplay playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"></video>
                                </div>
                                <canvas id="canvasCamera" style="display: none;"></canvas>
                            </div>
                            <div class="modal-footer bg-dark d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-secondary" onclick="window.fecharCamera && window.fecharCamera();">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-success" id="btnCapturarFoto" onclick="window.capturarFoto && window.capturarFoto();" style="border-radius: 50%; width: 70px; height: 70px; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                                    <i class="fas fa-camera fa-2x"></i>
                                </button>
                                <div style="width: 70px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            videoElement = document.getElementById('videoCamera');
            
            // Verificar suporte do navegador
            if (!navigator.mediaDevices && !navigator.getUserMedia && !navigator.webkitGetUserMedia && !navigator.mozGetUserMedia) {
                alert('Seu navegador n√£o suporta acesso √† c√¢mera. Por favor, use um navegador moderno (Chrome, Firefox, Edge, Safari).');
                return;
            }
            
            // Solicitar acesso √† c√¢mera - tentar primeiro qualquer c√¢mera dispon√≠vel (funciona melhor em notebooks)
            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            
            // Fun√ß√£o para tentar abrir c√¢mera
            function tentarAbrirCamera(constraints) {
                let getUserMediaFn;
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    getUserMediaFn = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
                } else {
                    // Fallback para APIs antigas
                    getUserMediaFn = function(constraints) {
                        return new Promise(function(resolve, reject) {
                            const getUserMedia = navigator.getUserMedia || 
                                                 navigator.webkitGetUserMedia || 
                                                 navigator.mozGetUserMedia ||
                                                 navigator.msGetUserMedia;
                            if (getUserMedia) {
                                getUserMedia.call(navigator, constraints, resolve, reject);
                            } else {
                                reject(new Error('getUserMedia n√£o suportado'));
                            }
                        });
                    };
                }
                
                console.log('Tentando acessar c√¢mera com constraints:', constraints);
                
                getUserMediaFn(constraints)
                .then(function(stream) {
                    console.log('C√¢mera acessada com sucesso!');
                    streamCamera = stream;
                    
                    if (videoElement) {
                        videoElement.srcObject = stream;
                        videoElement.play()
                            .then(function() {
                                console.log('V√≠deo iniciado com sucesso');
                            })
                            .catch(function(err) {
                                console.error('Erro ao reproduzir v√≠deo:', err);
                                alert('Erro ao iniciar o v√≠deo. Verifique se a c√¢mera est√° funcionando.');
                                fecharCamera();
                            });
                    } else {
                        console.error('Elemento de v√≠deo n√£o encontrado');
                        alert('Erro: elemento de v√≠deo n√£o encontrado.');
                        fecharCamera();
                    }
                })
                .catch(function(error) {
                    console.error('Erro ao acessar c√¢mera:', error);
                    console.error('Nome do erro:', error.name);
                    console.error('Mensagem do erro:', error.message);
                    
                    let errorMsg = 'N√£o foi poss√≠vel acessar a c√¢mera.';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMsg = 'Permiss√£o de c√¢mera negada. Por favor:\n\n1. Clique no √≠cone de cadeado na barra de endere√ßo\n2. Permita o acesso √† c√¢mera\n3. Recarregue a p√°gina e tente novamente';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMsg = 'Nenhuma c√¢mera encontrada no dispositivo. Verifique se h√° uma c√¢mera conectada.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMsg = 'A c√¢mera est√° sendo usada por outro aplicativo. Feche outros aplicativos que possam estar usando a c√¢mera.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMsg = 'A c√¢mera n√£o suporta as configura√ß√µes solicitadas. Tentando configura√ß√µes mais simples...';
                        // Tentar com configura√ß√µes mais simples
                        const constraintsSimples = { video: true };
                        tentarAbrirCamera(constraintsSimples);
                        return;
                    } else {
                        errorMsg = 'Erro desconhecido: ' + (error.message || error.name);
                    }
                    
                    alert(errorMsg);
                    fecharCamera();
                });
            }
            
            // Iniciar tentativa de acessar c√¢mera
            tentarAbrirCamera(constraints);
            
            // Adicionar event listeners aos bot√µes ap√≥s o modal ser criado
            setTimeout(function() {
                // Bot√£o de captura
                const btnCapturar = document.getElementById('btnCapturarFoto');
                if (btnCapturar) {
                    // Remover listeners anteriores
                    const newBtnCapturar = btnCapturar.cloneNode(true);
                    btnCapturar.parentNode.replaceChild(newBtnCapturar, btnCapturar);
                    
                    newBtnCapturar.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Bot√£o de captura clicado');
                        capturarFoto();
                    });
                    console.log('Event listener adicionado ao bot√£o de captura');
                } else {
                    console.error('Bot√£o de captura n√£o encontrado');
                }
                
                // Bot√£o de cancelar
                const btnCancelar = document.getElementById('btnCancelarCamera');
                if (btnCancelar) {
                    // Remover listeners anteriores
                    const newBtnCancelar = btnCancelar.cloneNode(true);
                    btnCancelar.parentNode.replaceChild(newBtnCancelar, btnCancelar);
                    
                    newBtnCancelar.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Bot√£o cancelar clicado');
                        fecharCamera();
                    });
                    console.log('Event listener adicionado ao bot√£o cancelar');
                } else {
                    console.error('Bot√£o cancelar n√£o encontrado');
                }
                
                // Bot√£o X (fechar)
                const btnFecharX = document.getElementById('btnFecharCameraX');
                if (btnFecharX) {
                    // Remover listeners anteriores
                    const newBtnFecharX = btnFecharX.cloneNode(true);
                    btnFecharX.parentNode.replaceChild(newBtnFecharX, btnFecharX);
                    
                    newBtnFecharX.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Bot√£o X clicado');
                        fecharCamera();
                    });
                    console.log('Event listener adicionado ao bot√£o X');
                } else {
                    console.error('Bot√£o X n√£o encontrado');
                }
            }, 200);
            
            } catch (error) {
                console.error('Erro geral ao abrir c√¢mera:', error);
                alert('Erro ao tentar abrir a c√¢mera. Verifique o console do navegador para mais detalhes.');
                fecharCamera();
            }
        }
        
        function previewImagem(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('preview_cupom');
                    const previewImg = document.getElementById('preview_img');
                    
                    if (previewImg) {
                        previewImg.src = e.target.result;
                    }
                    if (preview) {
                        preview.style.display = 'block';
                        
                        // Adicionar event listener ao bot√£o de remover ap√≥s mostrar preview
                        setTimeout(function() {
                            const btnRemover = document.getElementById('btnRemoverImagem');
                            if (btnRemover) {
                                // Limpar qualquer listener anterior
                                const newBtn = btnRemover.cloneNode(true);
                                btnRemover.parentNode.replaceChild(newBtn, btnRemover);
                                
                                // Adicionar novo listener
                                newBtn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('Bot√£o remover imagem clicado');
                                    removerImagem();
                                    return false;
                                });
                                
                                // Tamb√©m adicionar onclick diretamente como fallback
                                newBtn.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('Bot√£o remover imagem clicado (onclick)');
                                    removerImagem();
                                    return false;
                                };
                                
                                console.log('Event listener adicionado ao bot√£o remover imagem');
                            } else {
                                console.error('Bot√£o remover imagem n√£o encontrado');
                            }
                        }, 200);
                    }
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function removerImagem() {
            console.log('removerImagem chamada');
            const input = document.getElementById('cupom_fiscal_input');
            const preview = document.getElementById('preview_cupom');
            
            if (input) {
                input.value = '';
                console.log('Input limpo');
            } else {
                console.error('Input n√£o encontrado');
            }
            
            if (preview) {
                preview.style.display = 'none';
                console.log('Preview ocultado');
            } else {
                console.error('Preview n√£o encontrado');
            }
        }
        
        // ==================== FIM FUN√á√ïES PARA CAPTURA DE CUPOM FISCAL ====================
    });
    </script>
</body>
</html>

