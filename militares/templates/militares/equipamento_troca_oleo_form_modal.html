<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-oil-can me-2"></i>{% if troca %}Editar Troca de Óleo{% else %}Nova Troca de Óleo{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formTrocaOleoEquipamento" method="post" action="{% if troca %}{% url 'militares:equipamento_troca_oleo_update' troca.pk %}{% else %}{% url 'militares:equipamento_troca_oleo_create' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.equipamento.id_for_label }}" class="form-label">
                    Equipamento <span class="text-danger">*</span>
                </label>
                {{ form.equipamento }}
                {% if form.equipamento.errors %}
                    <div class="text-danger small">{{ form.equipamento.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.data_troca.id_for_label }}" class="form-label">
                    Data e Hora da Troca <span class="text-danger">*</span>
                </label>
                {{ form.data_troca }}
                {% if form.data_troca.errors %}
                    <div class="text-danger small">{{ form.data_troca.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_uso_troca.id_for_label }}" class="form-label">
                    Horas de Uso na Troca <span class="text-danger">*</span>
                </label>
                {{ form.horas_uso_troca }}
                {% if form.horas_uso_troca.errors %}
                    <div class="text-danger small">{{ form.horas_uso_troca.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Horas de uso do equipamento no momento da troca
                </small>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.tipo_oleo.id_for_label }}" class="form-label">
                    Tipo de Óleo <span class="text-danger">*</span>
                </label>
                {{ form.tipo_oleo }}
                {% if form.tipo_oleo.errors %}
                    <div class="text-danger small">{{ form.tipo_oleo.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.nome_oleo.id_for_label }}" class="form-label">
                    Nome do Óleo
                </label>
                {{ form.nome_oleo }}
                {% if form.nome_oleo.errors %}
                    <div class="text-danger small">{{ form.nome_oleo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.quantidade_litros.id_for_label }}" class="form-label">
                    Quantidade (Litros) <span class="text-danger">*</span>
                </label>
                {{ form.quantidade_litros }}
                {% if form.quantidade_litros.errors %}
                    <div class="text-danger small">{{ form.quantidade_litros.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_litro.id_for_label }}" class="form-label">
                    Valor por Litro (R$)
                </label>
                {{ form.valor_litro }}
                {% if form.valor_litro.errors %}
                    <div class="text-danger small">{{ form.valor_litro.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_total.id_for_label }}" class="form-label">
                    Valor Total (R$) <span class="text-danger">*</span>
                </label>
                {{ form.valor_total }}
                {% if form.valor_total.errors %}
                    <div class="text-danger small">{{ form.valor_total.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.fornecedor_oficina.id_for_label }}" class="form-label">
                    Oficina/Fornecedor
                </label>
                {{ form.fornecedor_oficina }}
                {% if form.fornecedor_oficina.errors %}
                    <div class="text-danger small">{{ form.fornecedor_oficina.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.proximas_horas_troca.id_for_label }}" class="form-label">
                    Horas para Próxima Troca
                </label>
                {{ form.proximas_horas_troca }}
                {% if form.proximas_horas_troca.errors %}
                    <div class="text-danger small">{{ form.proximas_horas_troca.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.trocou_filtro_oleo }}
                    <label class="form-check-label" for="{{ form.trocou_filtro_oleo.id_for_label }}">
                        Trocou Filtro de Óleo
                    </label>
                </div>
            </div>
        </div>
        
        <div id="filtroOleoSection" style="display: none;">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.valor_filtro_oleo.id_for_label }}" class="form-label">
                        Valor do Filtro de Óleo (R$)
                    </label>
                    {{ form.valor_filtro_oleo }}
                    {% if form.valor_filtro_oleo.errors %}
                        <div class="text-danger small">{{ form.valor_filtro_oleo.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.outras_pecas.id_for_label }}" class="form-label">
                    Outras Peças
                </label>
                {{ form.outras_pecas }}
                {% if form.outras_pecas.errors %}
                    <div class="text-danger small">{{ form.outras_pecas.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.valor_outras_pecas.id_for_label }}" class="form-label">
                    Valor das Outras Peças (R$)
                </label>
                {{ form.valor_outras_pecas }}
                {% if form.valor_outras_pecas.errors %}
                    <div class="text-danger small">{{ form.valor_outras_pecas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                    Responsável pela Troca
                </label>
                {{ form.responsavel }}
                {% if form.responsavel.errors %}
                    <div class="text-danger small">{{ form.responsavel.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                    {{ form.ativo }}
                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                        Ativo
                    </label>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    Observações
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="text-danger small">{{ form.observacoes.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Mostrar/ocultar seção de filtro de óleo
    $('#{{ form.trocou_filtro_oleo.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#filtroOleoSection').show();
        } else {
            $('#filtroOleoSection').hide();
        }
    });
    
    // Inicializar visibilidade da seção de filtro
    if ($('#{{ form.trocou_filtro_oleo.id_for_label }}').is(':checked')) {
        $('#filtroOleoSection').show();
    }
    
    // Calcular valor total automaticamente
    $('#{{ form.quantidade_litros.id_for_label }}, #{{ form.valor_litro.id_for_label }}, #{{ form.valor_filtro_oleo.id_for_label }}, #{{ form.valor_outras_pecas.id_for_label }}').on('input', function() {
        calcularValorTotal();
    });
    
    // Formatação de valores monetários
    $('#{{ form.valor_litro.id_for_label }}, #{{ form.valor_filtro_oleo.id_for_label }}, #{{ form.valor_outras_pecas.id_for_label }}').on('blur', function() {
        formatarMoeda($(this));
    });
    
    // Submissão do formulário via AJAX
    $('#formTrocaOleoEquipamento').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var formData = form.serialize();
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (typeof response === 'object' && response.success) {
                    $('#trocaOleoModal').modal('hide');
                    location.reload();
                } else {
                    $('#trocaOleoModalBody').html(response);
                }
            },
            error: function(xhr) {
                if (xhr.status === 200) {
                    $('#trocaOleoModalBody').html(xhr.responseText);
                } else {
                    alert('Erro ao salvar troca de óleo. Por favor, tente novamente.');
                }
            }
        });
    });
});

function calcularValorTotal() {
    var quantidade = parseFloat($('#{{ form.quantidade_litros.id_for_label }}').val()) || 0;
    var valorLitro = parseFloat($('#{{ form.valor_litro.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorFiltro = parseFloat($('#{{ form.valor_filtro_oleo.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorOutrasPecas = parseFloat($('#{{ form.valor_outras_pecas.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    
    var valorTotal = (quantidade * valorLitro) + valorFiltro + valorOutrasPecas;
    
    if (valorTotal > 0) {
        $('#{{ form.valor_total.id_for_label }}').val(valorTotal.toFixed(2).replace('.', ','));
        $('#{{ form.valor_total_nota.id_for_label }}').val(valorTotal.toFixed(2).replace('.', ','));
    }
}

function formatarMoeda(input) {
    var valor = input.val().replace(/[^\d,]/g, '');
    if (valor) {
        valor = valor.replace(',', '.');
        input.val(parseFloat(valor).toFixed(2).replace('.', ','));
    }
}
</script>

