{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Licenciamento{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-id-card me-2 text-primary"></i>
                        {% if object %}Editar Licenciamento{% else %}Novo Licenciamento{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando licenciamento da viatura {{ object.viatura.placa }}{% else %}Registrar novo licenciamento{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:licenciamento_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Informações do Licenciamento
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" id="licenciamentoForm">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.viatura.id_for_label }}" class="form-label">
                                            Viatura <span class="text-danger">*</span>
                                        </label>
                                        {{ form.viatura }}
                                        {% if form.viatura.errors %}
                                            <div class="invalid-feedback d-block">{{ form.viatura.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.ano_licenciamento.id_for_label }}" class="form-label">
                                            Ano de Licenciamento <span class="text-danger">*</span>
                                        </label>
                                        {{ form.ano_licenciamento }}
                                        {% if form.ano_licenciamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.ano_licenciamento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.data_vencimento.id_for_label }}" class="form-label">
                                            Data de Vencimento <span class="text-danger">*</span>
                                        </label>
                                        {{ form.data_vencimento }}
                                        {% if form.data_vencimento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_vencimento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.valor_licenciamento.id_for_label }}" class="form-label">
                                            Valor do Licenciamento (R$) <span class="text-danger">*</span>
                                        </label>
                                        {{ form.valor_licenciamento }}
                                        {% if form.valor_licenciamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_licenciamento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_pagamento.id_for_label }}" class="form-label">
                                            Data de Pagamento
                                        </label>
                                        {{ form.data_pagamento }}
                                        {% if form.data_pagamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_pagamento.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Deixe em branco se ainda não foi pago</small>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            Status
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Atualizado automaticamente conforme datas</small>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.proximo_vencimento.id_for_label }}" class="form-label">
                                            Próximo Vencimento
                                        </label>
                                        {{ form.proximo_vencimento }}
                                        {% if form.proximo_vencimento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.proximo_vencimento.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Data prevista para o próximo vencimento</small>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                                            Responsável
                                        </label>
                                        {{ form.responsavel }}
                                        {% if form.responsavel.errors %}
                                            <div class="invalid-feedback d-block">{{ form.responsavel.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check">
                                            {{ form.ativo }}
                                            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                                Ativo
                                            </label>
                                        </div>
                                        {% if form.ativo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.ativo.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{% url 'militares:licenciamento_list' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar número como moeda BRL
    function formatarMoedaBRL(valor) {
        if (!valor || valor === '') return '';
        
        let numeroString = valor.toString().trim();
        numeroString = numeroString.replace(/[^\d,]/g, '');
        let partes = numeroString.split(',');
        
        let parteInteira = partes[0].replace(/\./g, '') || '0';
        let parteDecimal = partes[1] ? partes[1].substring(0, 2) : '';
        
        while (parteDecimal.length < 2) {
            parteDecimal += '0';
        }
        
        parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return parteInteira + ',' + parteDecimal;
    }
    
    // Função para obter valor numérico limpo
    function obterValorNumerico(valor) {
        if (!valor || valor === '') return '';
        return valor.toString().replace(/\./g, '').replace(',', '.');
    }
    
    // Atualizar status automaticamente
    function atualizarStatus() {
        const dataVencimentoInput = document.getElementById('id_data_vencimento');
        const dataPagamentoInput = document.getElementById('id_data_pagamento');
        const statusSelect = document.getElementById('id_status');
        
        if (!dataVencimentoInput || !statusSelect) return;
        
        const dataVencimento = dataVencimentoInput.value;
        const dataPagamento = dataPagamentoInput ? dataPagamentoInput.value : '';
        
        if (!dataVencimento) return;
        
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        
        const vencimento = new Date(dataVencimento);
        vencimento.setHours(0, 0, 0, 0);
        
        if (dataPagamento) {
            statusSelect.value = 'PAGO';
        } else if (vencimento < hoje) {
            statusSelect.value = 'VENCIDO';
        } else {
            statusSelect.value = 'PENDENTE';
        }
    }
    
    // Configurar campo de valor monetário
    const valorLicenciamentoInput = document.getElementById('id_valor_licenciamento');
    if (valorLicenciamentoInput) {
        // Primeiro, verificar se já existe valor no campo (vindo do Django)
        let valorParaFormatar = null;
        
        // Tentar obter do objeto se estiver editando
        {% if object and object.valor_licenciamento %}
        try {
            // Converter o valor Decimal do Django para número
            const valorInicialStr = '{{ object.valor_licenciamento }}'.replace(',', '.');
            const valorInicial = parseFloat(valorInicialStr);
            if (!isNaN(valorInicial) && valorInicial > 0) {
                valorParaFormatar = valorInicial;
            }
        } catch (e) {
            console.log('Erro ao parsear valor inicial:', e);
        }
        {% endif %}
        
        // Se não conseguiu do objeto, pegar do campo HTML (que já vem preenchido pelo Django)
        if (!valorParaFormatar || valorParaFormatar === 0) {
            const valorAtual = valorLicenciamentoInput.value;
            if (valorAtual && valorAtual.trim() !== '') {
                // Tentar converter para número
                const valorLimpo = obterValorNumerico(valorAtual);
                const valorNum = parseFloat(valorLimpo);
                if (!isNaN(valorNum) && valorNum > 0) {
                    valorParaFormatar = valorNum;
                }
            }
        }
        
        // Formatar o valor encontrado (sempre formatar para garantir consistência)
        if (valorParaFormatar && valorParaFormatar > 0) {
            // Sempre formatar, mesmo que já tenha valor (garante formatação consistente)
            valorLicenciamentoInput.value = formatarMoedaBRL(valorParaFormatar.toString());
        } else if (valorLicenciamentoInput.value) {
            // Se houver valor mas não foi convertido corretamente, tentar converter novamente
            const valorLimpo = obterValorNumerico(valorLicenciamentoInput.value);
            const valorNum = parseFloat(valorLimpo);
            if (!isNaN(valorNum) && valorNum > 0) {
                valorLicenciamentoInput.value = formatarMoedaBRL(valorNum.toString());
            }
        }
        
        valorLicenciamentoInput.addEventListener('input', function(e) {
            let valor = e.target.value;
            let valorLimpo = valor.replace(/[^\d,]/g, '');
            let partes = valorLimpo.split(',');
            
            if (partes.length > 2) {
                valorLimpo = partes[0] + ',' + partes.slice(1).join('');
            }
            
            if (partes.length === 2 && partes[1].length > 2) {
                valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
            }
            
            if (valorLimpo !== valor) {
                let cursorPos = e.target.selectionStart;
                e.target.value = valorLimpo;
                setTimeout(() => {
                    let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
        });
        
        valorLicenciamentoInput.addEventListener('blur', function(e) {
            if (e.target.value) {
                let valorLimpo = obterValorNumerico(e.target.value);
                let valorNum = parseFloat(valorLimpo);
                if (!isNaN(valorNum) && valorNum > 0) {
                    e.target.value = formatarMoedaBRL(valorNum.toString());
                }
            }
        });
    }
    
    // Calcular próximo vencimento automaticamente (1 ano após a data de vencimento)
    function calcularProximoVencimento(sobrescrever = false) {
        const dataVencimentoInput = document.getElementById('id_data_vencimento');
        const proximoVencimentoInput = document.getElementById('id_proximo_vencimento');
        
        if (!dataVencimentoInput || !proximoVencimentoInput) return;
        
        const dataVencimento = dataVencimentoInput.value;
        if (!dataVencimento) {
            if (sobrescrever) {
                proximoVencimentoInput.value = '';
            }
            return;
        }
        
        // Se já houver um valor preenchido e não for para sobrescrever, não fazer nada
        if (proximoVencimentoInput.value && !sobrescrever && !proximoVencimentoInput.dataset.autoCalculado) {
            return;
        }
        
        // Calcular 1 ano após a data de vencimento
        const vencimento = new Date(dataVencimento);
        vencimento.setFullYear(vencimento.getFullYear() + 1);
        
        // Formatar para YYYY-MM-DD
        const ano = vencimento.getFullYear();
        const mes = String(vencimento.getMonth() + 1).padStart(2, '0');
        const dia = String(vencimento.getDate()).padStart(2, '0');
        const proximoVencimento = `${ano}-${mes}-${dia}`;
        
        proximoVencimentoInput.value = proximoVencimento;
        proximoVencimentoInput.dataset.autoCalculado = 'true';
    }
    
    // Configurar atualização automática de status
    const dataVencimentoInput = document.getElementById('id_data_vencimento');
    const dataPagamentoInput = document.getElementById('id_data_pagamento');
    const proximoVencimentoInput = document.getElementById('id_proximo_vencimento');
    
    if (dataVencimentoInput) {
        // Apenas adicionar event listener se não estiver em modo de edição com dados já preenchidos
        dataVencimentoInput.addEventListener('change', function() {
            atualizarStatus();
            // Apenas calcular próximo vencimento se o usuário mudar a data manualmente
            // Não recalcular se já houver valor salvo
            {% if not object or not object.proximo_vencimento %}
            calcularProximoVencimento(true);
            {% else %}
            // Se já tiver próximo vencimento salvo, não recalcular automaticamente
            // Apenas recalcular se o usuário editar manualmente
            {% endif %}
        });
    }
    
    if (dataPagamentoInput) {
        dataPagamentoInput.addEventListener('change', atualizarStatus);
    }
    
    // Permitir que o usuário edite manualmente o próximo vencimento
    if (proximoVencimentoInput) {
        // Marcar como não auto-calculado se já tiver valor (vindo do banco de dados)
        {% if object and object.proximo_vencimento %}
        // Se for edição e já tiver próximo vencimento, não calcular automaticamente
        if (proximoVencimentoInput.value) {
            proximoVencimentoInput.dataset.autoCalculado = 'false';
        }
        {% endif %}
        
        proximoVencimentoInput.addEventListener('input', function() {
            // Se o usuário editar manualmente, remover a flag de auto-calculado
            delete proximoVencimentoInput.dataset.autoCalculado;
        });
        
        // Calcular apenas se não houver valor preenchido
        {% if not object or not object.proximo_vencimento %}
        // Apenas calcular se for criação OU se for edição mas não tiver próximo vencimento
        if (!proximoVencimentoInput.value) {
            calcularProximoVencimento(true);
        }
        {% endif %}
    }
    
    // Atualizar status ao carregar
    atualizarStatus();
    
    // Preparar valor monetário para envio
    const form = document.getElementById('licenciamentoForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (valorLicenciamentoInput && valorLicenciamentoInput.value) {
                valorLicenciamentoInput.value = obterValorNumerico(valorLicenciamentoInput.value);
            }
        });
    }
});
</script>
{% endblock %}

