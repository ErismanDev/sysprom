{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Módulo de Ensino{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .dashboard-card.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .dashboard-card.warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    
    .dashboard-card.info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    }
    
    .dashboard-card.danger {
        background: linear-gradient(135deg, var(--secondary-color) 0%, #e74c3c 100%);
    }
    
    .card-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .card-label {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }
    
    .card-icon {
        font-size: 3rem;
        opacity: 0.8;
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .content-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    
    .content-card h5 {
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .quick-link {
        display: block;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        text-decoration: none;
        color: #333;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }
    
    .quick-link:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        color: var(--primary-color);
        text-decoration: none;
    }
    
    .quick-link i {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="fas fa-graduation-cap me-2"></i>
                Dashboard - Módulo de Ensino
            </h1>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-book fa-2x text-primary mb-2"></i>
                    <h3>{{ total_cursos }}</h3>
                    <p class="text-muted mb-0">Cursos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-success mb-2"></i>
                    <h3>{{ total_turmas }}</h3>
                    <p class="text-muted mb-0">Turmas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-user-graduate fa-2x text-info mb-2"></i>
                    <h3>{{ total_alunos }}</h3>
                    <p class="text-muted mb-0">Alunos Ativos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-chalkboard-teacher fa-2x text-warning mb-2"></i>
                    <h3>{{ total_instrutores }}</h3>
                    <p class="text-muted mb-0">Instrutores</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12">
            <div class="content-card">
                <h5>
                    <i class="fas fa-flag me-2"></i>
                    Solicitações de Revisão
                </h5>
                <div class="mb-3">
                    <span class="badge bg-secondary me-1">Solicitadas: {{ revisoes_contagem.ALUNO_SOLICITOU }}</span>
                    <span class="badge bg-info me-1">Despachadas: {{ revisoes_contagem.DESPACHADA_INSTRUTOR }}</span>
                    <span class="badge bg-warning text-dark me-1">Instrutor: {{ revisoes_contagem.PARECER_INSTRUTOR }}</span>
                    <span class="badge bg-primary me-1">Recurso: {{ revisoes_contagem.RECURSO_DIRETORIA }}</span>
                    <span class="badge bg-dark me-1">Comissão: {{ revisoes_contagem.COMISSAO_NOMEADA }}</span>
                    <span class="badge bg-success">Finalizadas: {{ revisoes_contagem.PARECER_FINAL }}</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Aluno</th>
                                <th>Disciplina</th>
                                <th>Avaliação</th>
                                <th>Instrutor</th>
                                <th>Status</th>
                                <th>Etapa</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in pedidos_solicitados %}
                            <tr>
                                <td>
                                    {% if p.aluno.militar %}
                                        {{ p.aluno.militar.get_posto_graduacao_display }} {{ p.aluno.militar.nome_completo }}
                                    {% elif p.aluno.pessoa_externa %}
                                        {{ p.aluno.pessoa_externa.get_nome_completo }}
                                    {% else %}Aluno{% endif %}
                                </td>
                                <td>{{ p.nota_avaliacao.avaliacao.disciplina.nome }}</td>
                                <td>{{ p.nota_avaliacao.avaliacao.nome }}</td>
                                <td>
                                    {% if p.instrutor_responsavel %}
                                        {% if p.instrutor_responsavel.militar %}
                                            {{ p.instrutor_responsavel.militar.get_posto_graduacao_display }} {{ p.instrutor_responsavel.militar.nome_completo }}
                                        {% else %}Instrutor{% endif %}
                                    {% else %}Não designado{% endif %}
                                </td>
                                <td title="Fundamentação: {{ p.fundamentacao|default:'-' }}&#10;Solicitado: {{ p.data_solicitacao|date:'d/m/Y H:i' }}&#10;Atualizado: {{ p.data_atualizacao|date:'d/m/Y H:i' }}">{{ p.get_status_display }}</td>
                                <td>{{ p.get_etapa_display }}</td>
                                <td>
                                    <a href="{% url 'militares:ensino_pedido_revisao_detalhes' pedido_id=p.id %}" class="btn btn-sm btn-outline-secondary me-1">Visualizar</a>
                                    <a href="{% url 'militares:ensino_despachar_revisao_instrutor' pedido_id=p.id %}?next={{ request.get_full_path }}" class="btn btn-sm btn-primary js-open-despacho-modal">Despachar ao Instrutor</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-muted">Sem solicitações recentes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Aluno</th>
                                <th>Disciplina</th>
                                <th>Avaliação</th>
                                <th>Instrutor</th>
                                <th>Status</th>
                                <th>Etapa</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in pedidos_recurso %}
                            <tr>
                                <td>
                                    {% if p.aluno.militar %}
                                        {{ p.aluno.militar.get_posto_graduacao_display }} {{ p.aluno.militar.nome_completo }}
                                    {% elif p.aluno.pessoa_externa %}
                                        {{ p.aluno.pessoa_externa.get_nome_completo }}
                                    {% else %}Aluno{% endif %}
                                </td>
                                <td>{{ p.nota_avaliacao.avaliacao.disciplina.nome }}</td>
                                <td>{{ p.nota_avaliacao.avaliacao.nome }}</td>
                                <td>
                                    {% if p.instrutor_responsavel %}
                                        {% if p.instrutor_responsavel.militar %}
                                            {{ p.instrutor_responsavel.militar.get_posto_graduacao_display }} {{ p.instrutor_responsavel.militar.nome_completo }}
                                        {% else %}Instrutor{% endif %}
                                    {% else %}Não designado{% endif %}
                                </td>
                                <td>{{ p.get_status_display }}</td>
                                <td>{{ p.get_etapa_display }}</td>
                                <td>
                                    <a href="{% url 'militares:ensino_pedido_revisao_detalhes' pedido_id=p.id %}" class="btn btn-sm btn-outline-secondary me-1">Visualizar</a>
                                    {% if not p.comissao %}
                                        <a href="{% url 'militares:ensino_nomear_comissao_revisao' pedido_id=p.id %}?next={{ request.get_full_path }}" class="btn btn-sm btn-primary">Nomear Comissão</a>
                                    {% else %}
                                        <span class="badge bg-info">Comissão: {{ p.comissao.nome }}</span>
                                        <a href="{% url 'militares:ensino_comissao_parecer_final' pedido_id=p.id %}?decisao=DEFERIDA&next={{ request.get_full_path }}" class="btn btn-sm btn-success me-1">Deferir (Comissão)</a>
                                        <a href="{% url 'militares:ensino_comissao_parecer_final' pedido_id=p.id %}?decisao=INDEFERIDA&next={{ request.get_full_path }}" class="btn btn-sm btn-danger">Indeferir (Comissão)</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-muted">Sem recursos recentes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <div class="row">
        <!-- Turmas Recentes -->
        <div class="col-md-6">
            <div class="content-card">
                <h5>
                    <i class="fas fa-users me-2"></i>
                    Turmas Recentes
                </h5>
                {% if turmas_recentes %}
                    <div class="list-group">
                        {% for turma in turmas_recentes %}
                        <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ turma.identificacao }}</h6>
                                <small>{{ turma.curso.nome }}</small>
                            </div>
                            <p class="mb-1">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ turma.data_inicio|date:"d/m/Y" }} - {{ turma.data_fim|date:"d/m/Y" }}
                                </small>
                            </p>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nenhuma turma encontrada.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Alunos por Situação -->
        <div class="col-md-6">
            <div class="content-card">
                <h5>
                    <i class="fas fa-chart-pie me-2"></i>
                    Alunos por Situação
                </h5>
                {% if alunos_por_situacao %}
                    <div class="list-group">
                        {% for item in alunos_por_situacao %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <span>
                                    {% if item.situacao == 'ATIVO' %}
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Ativo
                                    {% elif item.situacao == 'CONCLUIDO' %}
                                        <i class="fas fa-graduation-cap text-primary me-2"></i>
                                        Concluído
                                    {% elif item.situacao == 'DESLIGADO' %}
                                        <i class="fas fa-times-circle text-danger me-2"></i>
                                        Desligado
                                    {% elif item.situacao == 'TRANSFERIDO' %}
                                        <i class="fas fa-exchange-alt text-warning me-2"></i>
                                        Transferido
                                    {% elif item.situacao == 'JUBILADO' %}
                                        <i class="fas fa-user-slash text-danger me-2"></i>
                                        Jubilado
                                    {% else %}
                                        <i class="fas fa-info-circle text-warning me-2"></i>
                                        {{ item.situacao }}
                                    {% endif %}
                                </span>
                                <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nenhum dado disponível.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <!-- Disciplinas Mais Cursadas -->
        <div class="col-md-6">
            <div class="content-card">
                <h5>
                    <i class="fas fa-book-open me-2"></i>
                    Disciplinas Mais Cursadas
                </h5>
                {% if disciplinas_mais_cursadas %}
                    <div class="list-group">
                        {% for disciplina in disciplinas_mais_cursadas %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ disciplina.nome }}</h6>
                                    <small class="text-muted">{{ disciplina.codigo }}</small>
                                </div>
                                <span class="badge bg-info rounded-pill">{{ disciplina.total_turmas }} turmas</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nenhuma disciplina encontrada.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Acesso Rápido -->
        <div class="col-md-6">
            <div class="content-card">
                <h5>
                    <i class="fas fa-bolt me-2"></i>
                    Acesso Rápido
                </h5>
                <a href="{% url 'militares:ensino_alunos_listar' %}" class="quick-link">
                    <i class="fas fa-user-graduate"></i>
                    Gerenciar Alunos
                </a>
                <a href="{% url 'militares:ensino_cursos_listar' %}" class="quick-link">
                    <i class="fas fa-book"></i>
                    Gerenciar Cursos
                </a>
                <a href="{% url 'militares:ensino_turmas_listar' %}" class="quick-link">
                    <i class="fas fa-users"></i>
                    Gerenciar Turmas
                </a>
                <a href="{% url 'militares:ensino_aulas_listar' %}" class="quick-link">
                    <i class="fas fa-chalkboard"></i>
                    Gerenciar Aulas
                </a>
                <a href="{% url 'militares:ensino_avaliacoes_listar' %}" class="quick-link">
                    <i class="fas fa-clipboard-check"></i>
                    Gerenciar Avaliações
                </a>
                <a href="{% url 'militares:ensino_certificados_listar' %}" class="quick-link">
                    <i class="fas fa-certificate"></i>
                    Gerenciar Certificados
                </a>
                {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                <a href="{% url 'militares:ensino_usuarios_listar' %}" class="quick-link">
                    <i class="fas fa-users-cog"></i>
                    Controle de Usuários
                </a>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  function initEditors(root){
    try {
      if (typeof ClassicEditor === 'undefined') return;
      window._despachoEditors = window._despachoEditors || [];
      var areas = root.querySelectorAll('textarea');
      areas.forEach(function(el){
        if (el.dataset.ckInitialized === '1') return;
        ClassicEditor.create(el).then(function(editor){
          el.dataset.ckInitialized = '1';
          window._despachoEditors.push({el: el, editor: editor});
        }).catch(function(err){ console.error('CKEditor init error:', err); });
      });
      var forms = root.querySelectorAll('form');
      forms.forEach(function(f){
        if (f.dataset.ckHooked === '1') return;
        f.addEventListener('submit', function(){
          (window._despachoEditors || []).forEach(function(pair){ try { pair.el.value = pair.editor.getData(); } catch(e){} });
        });
        f.dataset.ckHooked = '1';
      });
    } catch(e){ console.error(e); }
  }
  function openDespachoModal(url){
    var modalEl = document.getElementById('despachoInstrutorModal');
    var contentEl = document.getElementById('modalDespachoContent');
    if (!modalEl || !contentEl) return window.location.href = url;
    contentEl.innerHTML = '<div class="py-5 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3 text-muted">Carregando formulário...</p></div>';
    try { if (typeof bootstrap !== 'undefined' && bootstrap.Modal) { bootstrap.Modal.getOrCreateInstance(modalEl).show(); } } catch(e) {}
    fetch(url, {credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'}})
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(function(html){ contentEl.innerHTML = html; initEditors(contentEl); attachAjaxSubmit(); })
      .catch(function(err){ contentEl.innerHTML = '<div class="alert alert-danger m-3">Erro ao carregar formulário: '+err.message+'</div>'; });
  }
  function attachAjaxSubmit(){
    var contentEl = document.getElementById('modalDespachoContent');
    var form = contentEl ? contentEl.querySelector('form') : null;
    if (!form) return;
    if (form.dataset.ajaxBound === '1') return;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      (window._despachoEditors || []).forEach(function(pair){ try { pair.el.value = pair.editor.getData(); } catch(e){} });
      var fd = new FormData(form);
      var action = form.getAttribute('action') || window.location.href;
      fetch(action, {method:'POST', body: fd, credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(function(r){
          var ct = r.headers.get('content-type')||'';
          if (ct.indexOf('application/json')>=0) return r.json();
          return r.text().then(function(t){ return {html:t}; });
        })
        .then(function(data){
          if (data && data.success){
            var modalEl = document.getElementById('despachoInstrutorModal');
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal){
              var instance = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);
              instance.hide();
            }
            window.location.href = data.redirect || window.location.href;
          } else if (data && data.html){
            var contentEl = document.getElementById('modalDespachoContent');
            contentEl.innerHTML = data.html;
            initEditors(contentEl);
            attachAjaxSubmit();
          }
        })
        .catch(function(err){
          var contentEl = document.getElementById('modalDespachoContent');
          contentEl.innerHTML = '<div class="alert alert-danger m-3">Erro ao enviar: '+err.message+'</div>';
        });
    });
    form.dataset.ajaxBound = '1';
  }
  document.addEventListener('click', function(e){
    var a = e.target.closest('a.js-open-despacho-modal');
    if (a){
      e.preventDefault();
      var url = a.getAttribute('href');
      openDespachoModal(url);
    }
  });
})();
</script>

<!-- Modal para Despacho ao Instrutor -->
<div class="modal fade" id="despachoInstrutorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-share-square me-2"></i>Despachar ao Instrutor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalDespachoContent"></div>
    </div>
  </div>
</div>
{% endblock %}

