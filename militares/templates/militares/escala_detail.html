{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .escala-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .escala-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .info-item i {
        color: #6c757d;
        width: 20px;
        margin-right: 15px;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        min-width: 150px;
    }
    
    .info-value {
        color: #6c757d;
    }
    
    .militares-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .militar-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .militar-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .militar-info {
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }
    
    .militar-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .militar-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }
    
    .militar-details {
        flex: 1;
    }
    
    .militar-secao {
        margin-top: 5px;
        font-size: 0.9em;
        color: #6c757d;
        display: flex;
        align-items: center;
    }
    
    .militar-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .militar-posto {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .militar-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 10px;
    }
    
    .field-item {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .field-item i {
        width: 16px;
        margin-right: 6px;
        color: #007bff;
    }
    
    .field-label {
        font-weight: 500;
        margin-right: 4px;
    }
    
    .observacoes {
        margin-top: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-left: 3px solid #007bff;
        border-radius: 0 4px 4px 0;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .militar-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }
    
    
    .btn-remove-militar {
        background: #dc3545;
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 5px;
    }
    
    .btn-remove-militar:hover {
        background: #c82333;
        transform: scale(1.1);
        color: white;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-ativa {
        background: #d4edda;
        color: #155724;
    }
    
    .status-pendente {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-concluida {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-cancelada {
        background: #f8d7da;
        color: #721c24;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    /* Estilos para a tabela de militares */
    .table-militares {
        font-size: 0.9rem;
    }
    
    .table-militares th {
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table-militares td {
        vertical-align: middle;
        padding: 12px 8px;
    }
    
    .militar-row:hover {
        background-color: #f8f9fa !important;
    }
    
    .militar-row.table-warning {
        background-color: #fff3cd !important;
    }
    
    .militar-row.table-warning:hover {
        background-color: #ffeaa7 !important;
    }
    
    .badge.fs-6 {
        font-size: 0.8rem !important;
        padding: 0.4em 0.6em;
    }
    
    /* Estilos para organização por equipes */
    .equipe-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fff;
        overflow: hidden;
    }
    
    .equipe-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .equipe-title {
        margin: 0;
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
    }
    
    .equipe-viatura {
        display: flex;
        align-items: center;
        color: #6c757d;
    }
    
    .equipe-militares {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    
    .militar-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        transition: all 0.2s ease;
    }
    
    .militar-item:hover {
        background: #e9ecef;
        border-color: #dee2e6;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .militar-info {
        display: flex;
        align-items: flex-start;
        flex: 1;
    }
    
    .militar-avatar {
        width: 40px;
        height: 40px;
        background: #007bff;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .militar-details {
        flex: 1;
    }
    
    .militar-nome {
        display: block;
        font-weight: 600;
        color: #212529;
        margin: 0 0 8px 0;
        font-size: 0.95rem;
        width: 100%;
    }
    
    .militar-meta {
        display: flex;
        flex-wrap: nowrap;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
    }
    
    .militar-meta .posto {
        background: #6c757d;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .militar-meta .funcao {
        background: #17a2b8;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .militar-meta .secao {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .militar-horario {
        color: #6c757d;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }
    
    .multiple-turns {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .turno-item {
        background: rgba(0, 123, 255, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 3px solid #007bff;
        font-size: 0.8rem;
    }
    
    .turno-item .turno {
        font-weight: 600;
        color: #007bff;
    }
    
    .turno-grupo {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 20px;
    }
    
    .turno-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px 16px;
        border-radius: 8px 8px 0 0;
    }
    
    .turno-titulo {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .turno-nome {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-left: 8px;
    }
    
    .militares-turno {
        padding: 16px;
        background: white;
        border-radius: 0 0 8px 8px;
    }
    
    .militar-operacional {
        border-left: 3px solid #007bff;
    }
    
    .militar-observacoes {
        color: #6c757d;
        font-size: 0.8rem;
        margin-top: 8px;
        font-style: italic;
    }
    
    .militar-actions {
        margin-left: 10px;
    }
    
    /* Estilos para Assinaturas Eletrônicas - Padrão Quadros de Acesso */
    .assinatura-status {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .btn-remove-militar {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    
    .btn-remove-militar:hover {
        background: #c82333;
        transform: scale(1.1);
    }
    
    /* Estilos para botões de documento */
    .documento-buttons .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .documento-buttons .btn-outline-success:hover {
        background-color: #198754;
        border-color: #198754;
        color: white;
        transform: translateY(-1px);
    }
    
    .documento-buttons .btn-success:hover {
        background-color: #157347;
        border-color: #146c43;
        transform: translateY(-1px);
    }
    
    .documento-buttons .btn:active {
        transform: translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho da Escala -->
    <div class="escala-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Escala de Serviço - {{ escala.data|date:"d/m/Y" }}
                </h1>
                <p class="mb-0 opacity-75">
                    <i class="fas fa-building me-1"></i>
                    {{ escala.organizacao }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <span class="status-badge status-{{ escala.status }}">
                    {{ escala.get_status_display }}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Informações da Escala -->
    <div class="escala-info">
        <h4 class="mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Informações da Escala
        </h4>
        
        <div class="row">
            <div class="col-md-6">
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span class="info-label">Data:</span>
                    <span class="info-value">{{ escala.data|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-building"></i>
                    <span class="info-label">Organização:</span>
                    <span class="info-value">{{ escala.organizacao }}</span>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="info-item">
                    <i class="fas fa-info-circle"></i>
                    <span class="info-label">Status:</span>
                    <span class="info-value">
                        <span class="status-badge status-{{ escala.status }}">
                            {{ escala.get_status_display }}
                        </span>
                    </span>
                </div>
            </div>
        </div>
        
        {% if escala.observacoes %}
        <div class="info-item">
            <i class="fas fa-sticky-note"></i>
            <span class="info-label">Observações:</span>
            <span class="info-value">{{ escala.observacoes }}</span>
        </div>
        {% endif %}
        
        <div class="info-item">
            <i class="fas fa-user"></i>
            <span class="info-label">Criado por:</span>
            <span class="info-value">{{ escala.criado_por.get_full_name|default:"Sistema" }}</span>
        </div>
        
        <div class="info-item">
            <i class="fas fa-calendar-plus"></i>
            <span class="info-label">Data de Criação:</span>
            <span class="info-value">{{ escala.data_criacao|date:"d/m/Y H:i" }}</span>
        </div>
    </div>
    
    <!-- Militares Escalados -->
    <div class="militares-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
                <i class="fas fa-users me-2"></i>
                Escalados
                <span class="badge bg-primary ms-2">{{ militares_escalados.count }}</span>
            </h4>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGerenciarMilitares">
                <i class="fas fa-users me-1"></i>
                Adicionar Bombeiros
            </button>
        </div>
        
        <div id="militaresEscaladosContainer">
        {% if escala_info.militares_administrativos or escala_info.equipes %}
            <!-- 1. Militares Administrativos -->
            {% if escala_info.militares_administrativos %}
            <div class="equipe-section mb-4">
                <div class="equipe-header">
                    <h6 class="equipe-title">
                        <i class="fas fa-briefcase text-success me-2"></i>
                        SERVIÇO ADMINISTRATIVO
                        <span class="badge bg-success ms-2">{{ escala_info.militares_administrativos|length }}</span>
                    </h6>
                </div>
                <div class="equipe-militares">
                    {% if escala_info.escala.data|date:"w" == "2" or escala_info.escala.data|date:"w" == "4" %}
                        <div class="alert alert-info mb-3" style="font-size: 0.9rem; padding: 8px 12px;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>EDUCAÇÃO FÍSICA DE 07:30 ÀS 08:45, SERVIÇO ADMINISTRATIVO 09:00 ÀS 13:30</strong>
                        </div>
                    {% endif %}
                    
                    <!-- Agrupar militares administrativos por horário -->
                    {% regroup escala_info.militares_administrativos by hora_inicio as militares_por_horario %}
                    {% for grupo in militares_por_horario %}
                        <div class="turno-grupo mb-4">
                            <div class="turno-header">
                                <h6 class="turno-titulo">
                                    <i class="fas fa-clock me-2"></i>
                                    Turno: {{ grupo.grouper }} - {{ grupo.list.0.hora_fim }}
                                    <span class="turno-nome">({{ grupo.list.0.turno_display }})</span>
                                </h6>
                            </div>
                            <div class="militares-turno">
                                {% for militar in grupo.list %}
                                <div class="militar-item">
                                    <div class="militar-info">
                                        <div class="militar-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="militar-details">
                                            <h6 class="militar-nome">{{ militar.nome_completo }}</h6>
                                            <div class="militar-meta">
                                                <span class="posto">{{ militar.posto_graduacao }}</span>
                                            </div>
                                            {% if militar.secao %}
                                            <div class="militar-secao">
                                                <i class="fas fa-building me-1"></i>
                                                {{ militar.secao }}
                                            </div>
                                            {% endif %}
                                            
                                            {% if militar.observacoes and militar.observacoes != "Adicionado via seleção múltipla" %}
                                            <div class="militar-observacoes">
                                                <i class="fas fa-sticky-note me-1"></i>
                                                <small class="text-muted">{{ militar.observacoes }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="militar-actions">
                                        {% if escala_info.escala.status != 'aprovada' or escala_info.pode_alterar %}
                                        <button type="button" class="btn-remove-militar" 
                                                onclick="removerMilitarEscala({{ militar.id }}, '{{ militar.nome_completo }}')" 
                                                title="Remover militar">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn-remove-militar" disabled
                                                title="Alterações não permitidas em escalas aprovadas">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- 2. SERVIÇO OPERACIONAL -->
            {% if escala_info.equipes %}
            <div class="equipe-section mb-4">
                <div class="equipe-header">
                    <h6 class="equipe-title">
                        <i class="fas fa-shield-alt text-primary me-2"></i>
                        SERVIÇO OPERACIONAL
                    </h6>
                </div>
            </div>
            {% endif %}
            {% for equipe in escala_info.equipes %}
            <div class="equipe-section mb-4">
                <div class="equipe-header">
                    <h6 class="equipe-title">
                        <i class="fas fa-users text-primary me-2"></i>
                        {{ equipe.nome }}
                        <span class="badge bg-primary ms-2">{{ equipe.total_militares }}</span>
                    </h6>
                    {% if equipe.viatura %}
                    <div class="equipe-viatura">
                        <i class="fas fa-truck text-info me-1"></i>
                        <small class="text-muted">{{ equipe.viatura }}</small>
                    </div>
                    {% endif %}
                </div>
                <div class="equipe-militares">
                    {% for militar in equipe.militares %}
                    <div class="militar-item">
                        <div class="militar-info">
                            <div class="militar-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                            <div class="militar-details">
                                <h6 class="militar-nome">{{ militar.nome_completo }}</h6>
                                <div class="militar-meta">
                                    <span class="posto">{{ militar.posto_graduacao }}</span>
                                </div>
                                <div class="militar-horario">
                                    <i class="fas fa-clock me-1"></i>
                                    {% if militar.total_turnos > 1 %}
                                        <div class="multiple-turns">
                                            {% for turno in militar.turnos %}
                                            <div class="turno-item">
                                                {{ turno.hora_inicio }} - {{ turno.hora_fim }}
                                                <span class="turno">({{ turno.turno_display }})</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ militar.hora_inicio }} - {{ militar.hora_fim }}
                                        <span class="turno">({{ militar.turno_display }})</span>
                                    {% endif %}
                                </div>
                            
                                <!-- Campos operacionais -->
                                {% if militar.funcao_operacional %}
                                <div class="militar-operacional mt-2 p-2 bg-primary bg-opacity-10 rounded">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-tie text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Função Operacional</small>
                                            <strong class="text-dark small">{{ militar.funcao_operacional }}</strong>
                                    </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Campo de seção para escalas administrativas -->
                                {% if militar.secao %}
                                <div class="militar-operacional mt-2 p-2 bg-info bg-opacity-10 rounded">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-building text-info me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Seção</small>
                                            <strong class="text-dark small">{{ militar.secao }}</strong>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if militar.observacoes and militar.observacoes != "Adicionado via seleção múltipla" %}
                                <div class="militar-observacoes">
                                    <i class="fas fa-sticky-note me-1"></i>
                                    <small class="text-muted">{{ militar.observacoes }}</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="militar-actions">
                            {% if escala_info.escala.status != 'aprovada' or escala_info.pode_alterar %}
                            <button type="button" class="btn-remove-militar" 
                                    onclick="removerMilitarEscala({{ militar.id }}, '{{ militar.nome_completo }}')" 
                                    title="Remover militar">
                                <i class="fas fa-times"></i>
                            </button>
                            {% else %}
                            <button type="button" class="btn-remove-militar" disabled
                                    title="Alterações não permitidas em escalas aprovadas">
                                <i class="fas fa-lock"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            
        {% else %}
            <div class="empty-state">
                <i class="fas fa-user-slash fa-3x mb-3"></i>
                <h5>Nenhum escalado</h5>
                <p class="text-muted">Esta escala ainda não possui escalados.</p>
                <div id="avisoPermissao"></div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGerenciarMilitares" data-action="adicionar-militar">
                    <i class="fas fa-plus me-1"></i>
                    Adicionar Militares
                </button>
            </div>
        {% endif %}
        </div>
    </div>

    <!-- Assinaturas Eletrônicas - Padrão Quadros de Acesso -->
    {% if escala_info.assinaturas %}
        <div class="militares-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="assinatura-status">
                    {% if escala_info.tem_revisao %}
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check-circle me-1"></i>
                        Revisada
                    </span>
                    {% endif %}
                    {% if escala_info.tem_aprovacao %}
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Aprovada
                    </span>
                    {% endif %}
                </div>
            </div>
            
            {% for assinatura in escala_info.assinaturas %}
            <div style="display: flex; align-items: flex-start; border: 1px solid #888; border-radius: 6px; margin-bottom: 10px; background: #fafafa;">
                <div style="padding: 8px;">
                    <img src="{% static 'assinasyspro.png' %}" width="100" height="70" alt="Logo AssinaSysPro" style="background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                </div>
                <div style="flex-grow: 1;">
                    <div style="padding: 8px; font-size: 15px; text-align: justify; display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex-grow: 1;">
                            Documento assinado eletronicamente por <b>{{ assinatura.assinado_por.get_full_name|default:assinatura.assinado_por.username }}</b> <b>- {{ assinatura.funcao_assinatura|default:"Função não registrada" }}</b>, em {{ assinatura.data_assinatura|date:"d/m/Y" }}, às {{ assinatura.data_assinatura|date:"H:i" }}, conforme horário oficial de Brasília, com fundamento na Portaria XXX/2025 Gab. Cmdo. Geral/CBMEPI de XX de XXXXX de 2025.
                        </div>
                        <div style="margin-left: 10px;">
                            <span class="badge bg-{{ assinatura.tipo_assinatura|yesno:'info,primary' }}">
                                {{ assinatura.get_tipo_assinatura_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Informações de Validação -->
            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-info-circle me-2"></i>Validação de Assinaturas Eletrônicas</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Protocolo:</strong> {{ escala.pk }}/{{ escala.data|date:"Y" }}</p>
                        <p class="mb-1"><strong>Documento:</strong> Escala de Serviço</p>
                        <p class="mb-0"><strong>Data de Geração:</strong> {{ escala.data|date:"d/m/Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Total de Assinaturas:</strong> {{ escala_info.total_assinaturas }}</p>
                        <p class="mb-1"><strong>Status:</strong> 
                            {% if escala_info.tem_aprovacao %}
                                <span class="badge bg-success">Aprovada</span>
                            {% elif escala_info.tem_revisao %}
                                <span class="badge bg-warning">Em Revisão</span>
                            {% else %}
                                <span class="badge bg-secondary">Pendente</span>
                            {% endif %}
                        </p>
                        <p class="mb-0"><strong>Validade:</strong> Assinaturas eletrônicas têm validade legal</p>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="militares-section mt-4">
            <div class="text-center">
                <i class="fas fa-file-signature fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhuma assinatura eletrônica registrada</h5>
                <p class="text-muted">Esta escala ainda não possui assinaturas eletrônicas.</p>
            </div>
        </div>
    {% endif %}

    <!-- Seção de Alterações (apenas para escalas aprovadas) -->
    {% if escala_info.escala.status == 'aprovada' %}
        <div class="militares-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Alterações na Escala
                    <span class="badge bg-warning ms-2">{{ escala_info.alteracoes|length }}</span>
                </h4>
                {% if escala_info.pode_alterar %}
                <span class="badge bg-success">
                    <i class="fas fa-check-circle me-1"></i>
                    Alterações Permitidas
                </span>
                {% else %}
                <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>
                    Alterações Bloqueadas
                </span>
                {% endif %}
            </div>
            
            {% if escala_info.motivo_restricao %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Restrição:</strong> {{ escala_info.motivo_restricao }}
            </div>
            {% endif %}
            
            {% if escala_info.alteracoes %}
                {% for alteracao in escala_info.alteracoes %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-edit me-1"></i>
                                {{ alteracao.get_tipo_alteracao_display }}
                            </h6>
                            <small class="text-muted">
                                Por {{ alteracao.alterado_por.get_full_name|default:alteracao.alterado_por.username }} 
                                em {{ alteracao.data_alteracao|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div>
                            {% if alteracao.is_valida %}
                                <span class="badge bg-success">Válida</span>
                            {% else %}
                                <span class="badge bg-secondary">Expirada</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <p><strong>Justificativa:</strong> {{ alteracao.justificativa }}</p>
                        
                        {% if alteracao.dados_anteriores %}
                        <div class="bg-light p-3 rounded">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-user me-2"></i>
                                Dados do Militar
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <strong>Nome:</strong> 
                                        <span class="text-muted">{{ alteracao.dados_anteriores.militar_nome|default:"-" }}</span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Função:</strong> 
                                        <span class="text-muted">{{ alteracao.dados_anteriores.funcao|default:"-" }}</span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Turno:</strong> 
                                        <span class="text-muted">{{ alteracao.dados_anteriores.turno|default:"-" }}</span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2">
                                        <strong>Horário:</strong> 
                                        <span class="text-muted">
                                            {{ alteracao.dados_anteriores.hora_inicio|default:"-" }} às 
                                            {{ alteracao.dados_anteriores.hora_fim|default:"-" }}
                                        </span>
                                    </p>
                                    {% if alteracao.dados_anteriores.funcao_operacional %}
                                    <p class="mb-2">
                                        <strong>Função Operacional:</strong> 
                                        <span class="text-muted">{{ alteracao.dados_anteriores.funcao_operacional }}</span>
                                    </p>
                                    {% endif %}
                                    {% if alteracao.dados_anteriores.equipe %}
                                    <p class="mb-2">
                                        <strong>Equipe:</strong> 
                                        <span class="text-muted">{{ alteracao.dados_anteriores.equipe }}</span>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if alteracao.dados_anteriores.arquivo_anexo %}
                        <div class="mt-3">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-paperclip me-2"></i>
                                Documento Anexado
                            </h6>
                            <div class="card bg-success bg-opacity-10">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-alt text-success me-3 fs-4"></i>
                                            <div>
                                                <p class="mb-1">
                                                    <strong>Arquivo:</strong> 
                                                    <span class="text-muted">{{ alteracao.dados_anteriores.nome_arquivo_original|default:"Documento anexado" }}</span>
                                                </p>
                                                <small class="text-muted">
                                                    <i class="fas fa-save me-1"></i>
                                                    Documento salvo com a alteração
                                                </small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 documento-buttons">
                                            <a href="{% url 'militares:visualizar_documento_alteracao' alteracao.id %}" 
                                               target="_blank" 
                                               class="btn btn-sm btn-outline-success"
                                               data-bs-toggle="tooltip" 
                                               title="Visualizar documento">
                                                <i class="fas fa-eye me-1"></i>
                                                Visualizar
                                            </a>
                                            <a href="{% url 'militares:visualizar_documento_alteracao' alteracao.id %}" 
                                               download="{{ alteracao.dados_anteriores.nome_arquivo_original|default:'documento' }}"
                                               class="btn btn-sm btn-success"
                                               data-bs-toggle="tooltip" 
                                               title="Baixar documento">
                                                <i class="fas fa-download me-1"></i>
                                                Baixar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center">
                    <i class="fas fa-edit fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma alteração registrada</h5>
                    <p class="text-muted">Esta escala não possui alterações registradas.</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
    
    <!-- Ações -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'militares:escala_pdf' escala.pk %}" class="btn btn-outline-success" target="_blank">
                    <i class="fas fa-file-pdf me-1"></i>
                    Escala
                </a>
                
                <button type="button" class="btn btn-outline-info" onclick="sincronizarEscalaAbonar()" id="btnSincronizarAbonar">
                    <i class="fas fa-sync-alt me-1"></i>
                    Sincronizar Abonar
                </button>
                
                <a href="{% url 'militares:escalas_list' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Voltar à Lista
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gerenciar Militares -->
<div class="modal fade" id="modalGerenciarMilitares" tabindex="-1" aria-labelledby="modalGerenciarMilitaresLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGerenciarMilitaresLabel">
                    <i class="fas fa-users me-2"></i>
                    Adicionar Bombeiros - {{ escala.data|date:"d/m/Y" }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Conteúdo Principal -->
                <div class="content-main">
                    <!-- Militares da Organização -->
                    <div id="content-organizacao">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-building me-2"></i>
                                    Militares da Organização: <strong>{{ escala.organizacao }}</strong>
                                </h6>
                                
                                <!-- Configurações da Escala -->
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cog me-2"></i>
                                            Configurações da Escala
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Tipo de Serviço</label>
                                                <select class="form-select" id="configTipoServico" onchange="controlarCamposOperacionais()">
                                                    <option value="operacional">Operacional</option>
                                                    <option value="administrativo">Administrativo</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Turno</label>
                                                <select class="form-select" id="configTurno" onchange="calcularHorarios()">
                                                    <option value="">Selecione o turno</option>
                                                    <option value="2h">2 horas</option>
                                                    <option value="4h">4 horas</option>
                                                    <option value="6h">6 horas</option>
                                                    <option value="8h">8 horas</option>
                                                    <option value="12h">12 horas</option>
                                                    <option value="18h">18 horas</option>
                                                    <option value="24h">24 horas</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Hora Início</label>
                                                <input type="time" class="form-control" id="configHoraInicio" value="" onchange="calcularHorarios()">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Hora Término</label>
                                                <input type="time" class="form-control" id="configHoraFim" value="" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                
                                
                                <!-- Seleção de Militares -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-users me-2"></i>
                                            Selecionar Militares
                                        </h6>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodos()">
                                                <i class="fas fa-check-square me-1"></i>Selecionar Todos
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodos()">
                                                <i class="fas fa-square me-1"></i>Desmarcar Todos
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Campo de Pesquisa -->
                                        <div class="mb-3">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input 
                                                    type="text" 
                                                    class="form-control" 
                                                    id="campoPesquisaMilitar" 
                                                    placeholder="Digite nome, nome de guerra ou matrícula para buscar em todos os militares..." 
                                                    onkeyup="pesquisarMilitares()"
                                                />
                                                <button class="btn btn-outline-secondary" type="button" onclick="limparPesquisa()">
                                                    <i class="fas fa-times"></i> Limpar
                                                </button>
                                            </div>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Sem pesquisa: lista militares da organização. Com pesquisa: busca em todos os militares ativos.
                                            </small>
                                        </div>
                                        
                                        <div id="militaresOrganizacaoContainer">
                                            <!-- Será carregado via AJAX -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botão de Ação -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-success btn-lg" onclick="adicionarMilitaresSelecionados()">
                                        <i class="fas fa-plus me-2"></i>
                                        Adicionar na Escala
                                    </button>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="atualizarMilitaresEscalados()">
                    <i class="fas fa-sync me-1"></i>
                    Atualizar Lista
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variáveis globais
const escalaId = {{ escala.pk }};
let militaresDisponiveis = [];

// Função para carregar militares disponíveis
async function carregarMilitaresDisponiveis(termoPesquisa = '') {
    try {
        let url = `/militares/escalas/${escalaId}/api/militares-disponiveis/`;
        if (termoPesquisa) {
            url += `?q=${encodeURIComponent(termoPesquisa)}`;
        }
        const response = await fetch(url);
        const data = await response.json();
        militaresDisponiveis = data.militares;
        
        // Verificar se é permitido adicionar militares
        if (!data.pode_adicionar_militares) {
            // Desabilitar todos os controles de adição de militares
            const botoesAdicionar = document.querySelectorAll('[data-action="adicionar-militar"]');
            botoesAdicionar.forEach(botao => {
                botao.disabled = true;
                botao.title = data.mensagem_permissao;
            });
            
            // Mostrar mensagem de aviso
            const avisoContainer = document.getElementById('avisoPermissao');
            if (avisoContainer) {
                avisoContainer.innerHTML = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> ${data.mensagem_permissao}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        }
        
        // Atualizar contador de militares disponíveis
        const totalDisponiveis = document.getElementById('totalDisponiveis');
        if (totalDisponiveis) {
            totalDisponiveis.textContent = data.total_disponiveis || data.militares.length;
        }
        
        // Preencher select individual
        const selectIndividual = document.getElementById('militar_id');
        selectIndividual.innerHTML = '<option value="">Selecione um</option>';
        data.militares.forEach(militar => {
            const option = document.createElement('option');
            option.value = militar.id;
            option.textContent = `${militar.nome_completo} - ${militar.posto_graduacao}`;
            selectIndividual.appendChild(option);
        });
        
        // Preencher select coletivo
        const selectColetivo = document.getElementById('militares_coletivo');
        selectColetivo.innerHTML = '';
        data.militares.forEach(militar => {
            const option = document.createElement('option');
            option.value = militar.id;
            option.textContent = `${militar.nome_completo} - ${militar.posto_graduacao}`;
            selectColetivo.appendChild(option);
        });
        
        // Mostrar mensagem se não há militares disponíveis
        if (data.militares.length === 0) {
            const selectIndividual = document.getElementById('militar_id');
            const selectColetivo = document.getElementById('militares_coletivo');
            
            selectIndividual.innerHTML = '<option value="">Nenhum disponível</option>';
            selectColetivo.innerHTML = '<option value="">Nenhum disponível</option>';
            
            if (data.acesso_total) {
                mostrarAlerta('Nenhum militar ativo encontrado no sistema', 'warning');
            } else {
                mostrarAlerta(`Nenhum disponível na organização "${data.organizacao}"`, 'warning');
            }
        } else if (data.acesso_total) {
            // Mostrar aviso de acesso total
            mostrarAlerta(`Acesso Total: Visualizando todos os ${data.total_militares} militares ativos do sistema`, 'info');
        }
        
    } catch (error) {
        console.error('Erro ao carregar militares:', error);
        mostrarAlerta('Erro ao carregar lista de militares', 'danger');
    }
}

// Função para carregar militares escalados
async function carregarMilitaresEscalados() {
    try {
        const response = await fetch(`/militares/escalas/${escalaId}/api/militares-escalados/`);
        const data = await response.json();
        
        const container = document.getElementById('militaresEscaladosContainer');
        if (data.militares.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum escalado</h5>
                    <p class="text-muted">Esta escala ainda não possui escalados.</p>
                </div>
            `;
        } else {
            container.innerHTML = data.militares.map(militar => {
                // Debug: Log dos dados do militar
                console.log('🔍 DEBUG Militar:', {
                    nome: militar.nome_completo,
                    tipo_servico: militar.tipo_servico,
                    secao: militar.secao,
                    funcao_operacional: militar.funcao_operacional,
                    equipe: militar.equipe,
                    viatura: militar.viatura
                });
                
                // Determinar se tem campos operacionais
                const temCamposOperacionais = militar.tipo_servico === 'operacional' && 
                    (militar.funcao_operacional || militar.equipe || militar.viatura);
                
                // Determinar se tem campo de seção administrativa
                const temSecaoAdmin = militar.tipo_servico === 'administrativo' && militar.secao && militar.secao.trim() !== '';
                
                console.log('🔍 DEBUG Flags:', {
                    temCamposOperacionais,
                    temSecaoAdmin,
                    secaoValue: militar.secao
                });
                
                return `
                <div class="card mb-3 ${temCamposOperacionais ? 'border-primary' : ''}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <div>
                                        <h6 class="militar-nome mb-0">${militar.nome_completo}</h6>
                                        <p class="mb-0 text-muted small">${militar.posto_graduacao}</p>
                                    </div>
                                    ${militar.tipo_servico === 'operacional' ? `
                                        <span class="badge bg-warning text-dark ms-2">
                                            <i class="fas fa-tools me-1"></i>
                                            Operacional
                                        </span>
                                    ` : `
                                        <span class="badge bg-info text-white ms-2">
                                            <i class="fas fa-briefcase me-1"></i>
                                            Administrativo
                                        </span>
                                    `}
                                    </div>
                                
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-briefcase text-primary me-2"></i>
                                        <small class="text-muted">
                                                <strong>Função:</strong> ${militar.funcao_display}
                                        </small>
                                    </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-success me-2"></i>
                                        <small class="text-muted">
                                            <strong>Turno:</strong> ${militar.turno_display}
                                        </small>
                                    </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-info me-2"></i>
                                        <small class="text-muted">
                                            <strong>Horário:</strong> ${militar.hora_inicio} - ${militar.hora_fim}
                                        </small>
                                    </div>
                                </div>
                                
                                ${temSecaoAdmin ? `
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-building text-info me-2"></i>
                                        <small class="text-muted">
                                            <strong>Seção Administrativa:</strong> ${militar.secao}
                                        </small>
                                            </div>
                                        </div>
                                    ` : ''}
                                
                                ${militar.observacoes ? `
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-sticky-note text-warning me-2"></i>
                                        <small class="text-muted">
                                            <strong>Obs:</strong> ${militar.observacoes}
                                        </small>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${temCamposOperacionais ? `
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-tools me-2"></i>
                                            Configurações Operacionais
                                        </h6>
                                        <div class="row g-2">
                                            ${militar.funcao_operacional ? `
                                                <div class="col-md-4">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user-tie text-primary me-2"></i>
                                                        <div>
                                                            <small class="text-muted d-block">Função Operacional</small>
                                                            <strong class="text-dark">${militar.funcao_operacional}</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${militar.equipe ? `
                                                <div class="col-md-4">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-users text-success me-2"></i>
                                                        <div>
                                                            <small class="text-muted d-block">Equipe</small>
                                                            <strong class="text-dark">${militar.equipe}</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${militar.viatura ? `
                                                <div class="col-md-4">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-truck text-info me-2"></i>
                                                        <div>
                                                            <small class="text-muted d-block">Viatura</small>
                                                            <strong class="text-dark">${militar.viatura}</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${temSecaoAdmin ? `
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-building me-2"></i>
                                            Configurações Administrativas
                                        </h6>
                                        <div class="row g-2">
                                            <div class="col-md-12">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-building text-info me-2"></i>
                                                    <div>
                                                        <small class="text-muted d-block">Seção Administrativa</small>
                                                        <strong class="text-dark">${militar.secao}</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Debug temporário -->
                                ${militar.tipo_servico === 'administrativo' ? `
                                    <div class="mt-2 p-2 bg-warning rounded">
                                        <small class="text-dark">
                                            <strong>DEBUG:</strong> Tipo: ${militar.tipo_servico}, Seção: "${militar.secao}", TemSeção: ${temSecaoAdmin}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removerMilitarEscala(${militar.id})">
                                    <i class="fas fa-times"></i> Remover
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar militares escalados:', error);
        mostrarAlerta('Erro ao carregar militares escalados', 'danger');
    }
}

// Função para carregar militares da organização
async function carregarMilitaresOrganizacao(termoPesquisa = '') {
    try {
        let url = `/militares/escalas/${escalaId}/api/militares-disponiveis/`;
        if (termoPesquisa) {
            url += `?q=${encodeURIComponent(termoPesquisa)}`;
        }
        const response = await fetch(url);
        const data = await response.json();
        
        const container = document.getElementById('militaresOrganizacaoContainer');
        if (data.militares.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum encontrado</h5>
                    <p class="text-muted">Não há na organização "${data.organizacao}".</p>
                </div>
            `;
        } else {
            // Mostrar aviso de acesso total se aplicável
            let acessoTotalAlert = '';
            if (data.acesso_total) {
                acessoTotalAlert = `
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-crown me-2"></i>
                        <strong>Acesso Total:</strong> Você está visualizando TODOS os militares ativos do sistema, não apenas os da organização "${data.organizacao}".
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
            }
            
            // Mostrar estatísticas
            const stats = `
                ${acessoTotalAlert}
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_militares}</h5>
                                <p class="card-text mb-0">Total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_disponiveis}</h5>
                                <p class="card-text mb-0">Disponíveis</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_escalados}</h5>
                                <p class="card-text mb-0">Já Escalados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_indisponiveis_24h || 0}</h5>
                                <p class="card-text mb-0">Indisponíveis (24h)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
                    // Lista de militares com checkboxes
                    const militaresList = data.militares.map((militar, index) => {
                        // Determinar status baseado nas novas informações de disponibilidade
                        let statusClass = '';
                        let statusIcon = '';
                        let statusText = '';
                        let isDisabled = false;
                        
                        if (militar.status_disponibilidade === 'indisponivel_24h') {
                            statusClass = 'table-danger';
                            statusIcon = 'fas fa-times-circle text-danger';
                            statusText = `Indisponível (${militar.horas_atuais}h)`;
                            isDisabled = true;
                        } else if (militar.ja_escalado) {
                            statusClass = 'table-warning';
                            statusIcon = 'fas fa-check-circle text-warning';
                            statusText = `Já Escalado (${militar.horas_restantes}h restantes)`;
                            isDisabled = false; // Permitir seleção para múltiplos turnos
                        } else {
                            statusClass = 'table-success';
                            statusIcon = 'fas fa-circle text-success';
                            statusText = `Disponível (${militar.horas_restantes}h restantes)`;
                            isDisabled = false;
                        }
                        
                        return `
                            <tr class="militar-row ${statusClass}" data-posto="${militar.posto_graduacao.toLowerCase()}" data-nome="${militar.nome_completo.toLowerCase()}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input militar-checkbox" type="checkbox" 
                                               value="${militar.id}" id="militar_${militar.id}"
                                               ${isDisabled ? 'disabled' : ''}
                                               onchange="toggleCamposOperacionais(${militar.id})">
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">${index + 1}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="militar-nome mb-0">${militar.nome_completo}</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary fs-6">${militar.posto_graduacao_display || militar.posto_graduacao}</span>
                                </td>
                                <td>
                                    <span class="badge bg-${militar.ja_escalado ? 'warning' : (militar.status_disponibilidade === 'indisponivel_24h' ? 'danger' : 'success')}">
                                        <i class="${statusIcon} me-1"></i>
                                        ${statusText}
                                    </span>
                                </td>
                            </tr>
                            <tr id="campos_operacionais_${militar.id}" class="campos-operacionais-row" style="display: none;">
                                <td colspan="5">
                                    <div class="card border-primary bg-light">
                                        <div class="card-body py-3">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-tools text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 text-primary">Configurações Operacionais</h6>
                                                    <small class="text-muted">${militar.nome_completo}</small>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control funcao-autocomplete" 
                                                               id="funcao_operacional_${militar.id}" 
                                                               placeholder="Ex: Comandante de Viatura"
                                                               list="funcoes_disponiveis"
                                                               autocomplete="off">
                                                        <label for="funcao_operacional_${militar.id}">
                                                            <i class="fas fa-user-tie me-1"></i>
                                                            Função Operacional
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control equipe-autocomplete" 
                                                               id="equipe_${militar.id}" 
                                                               placeholder="Ex: Equipe Alpha"
                                                               list="equipes_disponiveis"
                                                               autocomplete="off">
                                                        <label for="equipe_${militar.id}">
                                                            <i class="fas fa-users me-1"></i>
                                                            Equipe
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control viatura-autocomplete" 
                                                               id="viatura_${militar.id}" 
                                                               placeholder="Ex: Viatura 01"
                                                               list="viaturas_disponiveis"
                                                               autocomplete="off">
                                                        <label for="viatura_${militar.id}">
                                                            <i class="fas fa-truck me-1"></i>
                                                            Viatura
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr id="campos_administrativos_${militar.id}" class="campos-administrativos-row" style="display: none;">
                                <td colspan="5">
                                    <div class="card border-info bg-light">
                                        <div class="card-body py-3">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-building text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 text-info">Configurações Administrativas</h6>
                                                    <small class="text-muted">${militar.nome_completo}</small>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-12">
                                                    <div class="form-floating">
                                                        <input type="text" class="form-control secao-admin-autocomplete" 
                                                               id="secao_administrativa_${militar.id}" 
                                                               placeholder="Ex: Seção Administrativa"
                                                               list="secoes_admin_disponiveis"
                                                               autocomplete="off">
                                                        <label for="secao_administrativa_${militar.id}">
                                                            <i class="fas fa-building me-1"></i>
                                                            Seção Administrativa
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    container.innerHTML = stats + `
                        <div class="table-responsive">
                            <table class="table table-hover table-striped table-militares">
                                <thead class="table-primary">
                                    <tr>
                                        <th width="50">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                                            </div>
                                        </th>
                                        <th width="60">#</th>
                                        <th>Nome Completo</th>
                                        <th width="150">Posto/Graduação</th>
                                        <th width="120">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${militaresList}
                                </tbody>
                            </table>
                        </div>
                    `;
        }
    } catch (error) {
        console.error('Erro ao carregar militares da organização:', error);
        mostrarAlerta('Erro ao carregar militares da organização', 'danger');
    }
}

// Função para calcular horários baseado no turno
function calcularHorarios() {
    const turno = document.getElementById('configTurno').value;
    const horaInicio = document.getElementById('configHoraInicio').value;
    const horaFim = document.getElementById('configHoraFim');
    
    // Só calcular se ambos os campos estiverem preenchidos
    if (!turno || !horaInicio) {
        horaFim.value = '';
        return;
    }
    
    const [hora, minuto] = horaInicio.split(':').map(Number);
    const inicioMinutos = hora * 60 + minuto;
    
    // Calcular duração em minutos baseado no turno
    let duracaoMinutos;
    switch(turno) {
        case '2h': duracaoMinutos = 120; break;
        case '4h': duracaoMinutos = 240; break;
        case '6h': duracaoMinutos = 360; break;
        case '8h': duracaoMinutos = 480; break;
        case '12h': duracaoMinutos = 720; break;
        case '18h': duracaoMinutos = 1080; break;
        case '24h': duracaoMinutos = 1440; break;
        default: return; // Não calcular se turno não selecionado
    }
    
    const fimMinutos = inicioMinutos + duracaoMinutos;
    const fimHora = Math.floor(fimMinutos / 60) % 24;
    const fimMinuto = fimMinutos % 60;
    
    const horaFimFormatada = `${fimHora.toString().padStart(2, '0')}:${fimMinuto.toString().padStart(2, '0')}`;
    horaFim.value = horaFimFormatada;
}

        // Função para controlar visibilidade dos campos operacionais e administrativos individuais
        function toggleCamposOperacionais(militarId) {
            const checkbox = document.getElementById(`militar_${militarId}`);
            const camposOperacionaisRow = document.getElementById(`campos_operacionais_${militarId}`);
            const camposAdministrativosRow = document.getElementById(`campos_administrativos_${militarId}`);
            const tipoServico = document.getElementById('configTipoServico').value;
            
            if (checkbox.checked) {
                if (tipoServico === 'operacional') {
                    // Mostrar apenas campos operacionais
                    if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'table-row';
                    if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
                } else if (tipoServico === 'administrativo') {
                    // Mostrar apenas campos administrativos
                    if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
                    if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'table-row';
                }
            } else {
                // Ocultar todos os campos
                if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
                if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
                
                // Limpar campos quando ocultar
                const funcaoField = document.getElementById(`funcao_operacional_${militarId}`);
                const equipeField = document.getElementById(`equipe_${militarId}`);
                const viaturaField = document.getElementById(`viatura_${militarId}`);
                const secaoAdminField = document.getElementById(`secao_administrativa_${militarId}`);
                
                if (funcaoField) funcaoField.value = '';
                if (equipeField) equipeField.value = '';
                if (viaturaField) viaturaField.value = '';
                if (secaoAdminField) secaoAdminField.value = '';
            }
        }

// Função para controlar visibilidade dos campos operacionais e administrativos baseado no tipo de serviço
function controlarCamposOperacionais() {
    const tipoServico = document.getElementById('configTipoServico').value;
    const checkboxes = document.querySelectorAll('.militar-checkbox:checked');
    
    // Carregar seções disponíveis se for administrativo
    if (tipoServico === 'administrativo') {
        carregarSecoesDisponiveis();
    }
    
    checkboxes.forEach(checkbox => {
        const militarId = checkbox.value;
        const camposOperacionaisRow = document.getElementById(`campos_operacionais_${militarId}`);
        const camposAdministrativosRow = document.getElementById(`campos_administrativos_${militarId}`);
        
        if (tipoServico === 'operacional') {
            // Mostrar apenas campos operacionais
            if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'table-row';
            if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
        } else if (tipoServico === 'administrativo') {
            // Mostrar apenas campos administrativos
            if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
            if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'table-row';
        } else {
            // Ocultar todos os campos
            if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
            if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
            
            // Limpar campos quando ocultar
            const funcaoField = document.getElementById(`funcao_operacional_${militarId}`);
            const equipeField = document.getElementById(`equipe_${militarId}`);
            const viaturaField = document.getElementById(`viatura_${militarId}`);
            const secaoAdminField = document.getElementById(`secao_administrativa_${militarId}`);
            
            if (funcaoField) funcaoField.value = '';
            if (equipeField) equipeField.value = '';
            if (viaturaField) viaturaField.value = '';
            if (secaoAdminField) secaoAdminField.value = '';
        }
    });
}

// Função para selecionar todos os militares disponíveis
function selecionarTodos() {
    const checkboxes = document.querySelectorAll('.militar-checkbox:not(:disabled)');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        // Mostrar campos operacionais se tipo for operacional
        const militarId = checkbox.value;
        toggleCamposOperacionais(militarId);
    });
    // Atualizar checkbox principal
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
    }
}

// Função para desmarcar todos os militares
function desmarcarTodos() {
    const checkboxes = document.querySelectorAll('.militar-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        // Ocultar campos operacionais
        const militarId = checkbox.value;
        const camposRow = document.getElementById(`campos_operacionais_${militarId}`);
        if (camposRow) {
            camposRow.style.display = 'none';
        }
    });
    // Atualizar checkbox principal
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
}

// Função para pesquisar militares
let timeoutPesquisa = null;
function pesquisarMilitares() {
    // Limpar timeout anterior
    if (timeoutPesquisa) {
        clearTimeout(timeoutPesquisa);
    }
    
    // Aguardar 500ms após parar de digitar para fazer a pesquisa
    timeoutPesquisa = setTimeout(() => {
        const termoPesquisa = document.getElementById('campoPesquisaMilitar').value.trim();
        carregarMilitaresOrganizacao(termoPesquisa);
    }, 500);
}

// Função para limpar pesquisa
function limparPesquisa() {
    document.getElementById('campoPesquisaMilitar').value = '';
    carregarMilitaresOrganizacao();
}

// Função para controlar o checkbox "Selecionar Todos"
function toggleAllCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.militar-checkbox:not(:disabled)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// Função para adicionar militares selecionados na escala
async function adicionarMilitaresSelecionados() {
    const checkboxes = document.querySelectorAll('.militar-checkbox:checked');
    
    if (checkboxes.length === 0) {
        mostrarAlerta('Selecione pelo menos um militar para adicionar à escala', 'warning');
        return;
    }
    
    const militaresIds = Array.from(checkboxes).map(cb => cb.value);
    const tipoServico = document.getElementById('configTipoServico').value;
    const turno = document.getElementById('configTurno').value;
    const horaInicio = document.getElementById('configHoraInicio').value;
    const horaFim = document.getElementById('configHoraFim').value;
    
    try {
        const formData = new FormData();
        formData.append('militares_coletivo', militaresIds.join(','));
        formData.append('funcao_coletivo', 'militar');
        formData.append('tipo_servico_coletivo', tipoServico);
        formData.append('turno_coletivo', turno);
        formData.append('hora_inicio_coletivo', horaInicio);
        formData.append('hora_fim_coletivo', horaFim);
        formData.append('observacoes_coletivo', 'Adicionado via seleção múltipla');
        
        // Coletar dados operacionais individuais para cada militar
        if (tipoServico === 'operacional') {
            const dadosOperacionais = [];
            militaresIds.forEach(militarId => {
                const funcaoOperacional = document.getElementById(`funcao_operacional_${militarId}`).value;
                const equipe = document.getElementById(`equipe_${militarId}`).value;
                const viatura = document.getElementById(`viatura_${militarId}`).value;
                
                dadosOperacionais.push({
                    militar_id: militarId,
                    funcao_operacional: funcaoOperacional,
                    equipe: equipe,
                    viatura: viatura
                });
            });
            
            formData.append('dados_operacionais', JSON.stringify(dadosOperacionais));
                        } else if (tipoServico === 'administrativo') {
                            const dadosAdministrativos = [];
                            militaresIds.forEach(militarId => {
                                const secaoAdministrativa = document.getElementById(`secao_administrativa_${militarId}`).value;
                                
                                // Validar seção administrativa obrigatória
                                if (!secaoAdministrativa.trim()) {
                                    mostrarAlerta(`Seção administrativa é obrigatória para o militar ${militarId}`, 'warning');
                                    return;
                                }
                                
                                dadosAdministrativos.push({
                                    militar_id: militarId,
                                    secao_administrativa: secaoAdministrativa
                                });
                            });
                            formData.append('dados_administrativos', JSON.stringify(dadosAdministrativos));
                        }
        
        const response = await fetch(`/militares/escalas/${escalaId}/api/adicionar-coletivo/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    // Desmarcar todos os checkboxes
                    desmarcarTodos();
                    // Recarregar a página para atualizar a lista
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarAlerta(data.message, 'danger');
                }
    } catch (error) {
        console.error('Erro ao adicionar militares:', error);
        mostrarAlerta('Erro ao adicionar militares à escala', 'danger');
    }
}

// Função para adicionar militar rapidamente
async function adicionarMilitarRapido(militarId, nomeMilitar) {
    // Preencher o formulário individual com dados padrão
    document.getElementById('militar_id').value = militarId;
    document.getElementById('funcao').value = 'militar';
    document.getElementById('tipo_servico').value = 'operacional';
    document.getElementById('turno').value = '8h';
    document.getElementById('hora_inicio').value = '08:00';
    document.getElementById('hora_fim').value = '16:00';
    
    // Submeter o formulário
    const formData = new FormData(document.getElementById('formAdicionarIndividual'));
    await adicionarMilitarIndividual(formData);
}


// Função para adicionar militar individual
async function adicionarMilitarIndividual(formData) {
    try {
        const response = await fetch(`/militares/escalas/${escalaId}/api/adicionar-militar/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            document.getElementById('formAdicionarIndividual').reset();
            // Recarregar a página para atualizar a lista
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao adicionar militar:', error);
        mostrarAlerta('Erro ao adicionar militar', 'danger');
    }
}

// Função para adicionar militares coletivamente
async function adicionarMilitaresColetivo(formData) {
    try {
        const response = await fetch(`/militares/escalas/${escalaId}/api/adicionar-coletivo/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            document.getElementById('formAdicionarColetivo').reset();
            // Recarregar a página para atualizar a lista
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao adicionar militares:', error);
        mostrarAlerta('Erro ao adicionar militares', 'danger');
    }
}

// Função para remover militar da escala
async function removerMilitarEscala(escalaMilitarId) {
    mostrarConfirmacao('Tem certeza que deseja remover este militar da escala?', async function() {
        await executarRemocaoMilitar(escalaMilitarId);
    });
}

// Função para mostrar alertas
function mostrarAlerta(mensagem, tipo = 'info') {
    const modal = document.getElementById('modalAlerta');
    const header = document.getElementById('modalAlertaHeader');
    const icon = document.getElementById('modalAlertaIcon');
    const titulo = document.getElementById('modalAlertaTitulo');
    const mensagemEl = document.getElementById('modalAlertaMensagem');
    const confirmarBtn = document.getElementById('modalAlertaConfirmar');
    
    // Configurar ícone e cores baseado no tipo
    const configs = {
        'success': {
            icon: 'fas fa-check-circle',
            titulo: 'Sucesso',
            headerClass: 'bg-success text-white',
            iconClass: 'text-success'
        },
        'error': {
            icon: 'fas fa-times-circle',
            titulo: 'Erro',
            headerClass: 'bg-danger text-white',
            iconClass: 'text-danger'
        },
        'warning': {
            icon: 'fas fa-exclamation-triangle',
            titulo: 'Atenção',
            headerClass: 'bg-warning text-dark',
            iconClass: 'text-warning'
        },
        'info': {
            icon: 'fas fa-info-circle',
            titulo: 'Informação',
            headerClass: 'bg-info text-white',
            iconClass: 'text-info'
        },
        'danger': {
            icon: 'fas fa-times-circle',
            titulo: 'Erro',
            headerClass: 'bg-danger text-white',
            iconClass: 'text-danger'
        }
    };
    
    const config = configs[tipo] || configs['info'];
    
    // Aplicar configurações
    header.className = `modal-header ${config.headerClass}`;
    icon.className = `${config.icon} me-2 ${config.iconClass}`;
    titulo.textContent = config.titulo;
    mensagemEl.textContent = mensagem;
    
    // Ocultar botão de confirmar por padrão
    confirmarBtn.style.display = 'none';
    
    // Mostrar modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Função para mostrar modal de confirmação
function mostrarConfirmacao(mensagem, callback) {
    const modal = document.getElementById('modalConfirmacao');
    const mensagemEl = document.getElementById('modalConfirmacaoMensagem');
    const confirmarBtn = document.getElementById('modalConfirmacaoConfirmar');
    
    // Configurar mensagem
    mensagemEl.textContent = mensagem;
    
    // Remover listeners anteriores
    const novoConfirmarBtn = confirmarBtn.cloneNode(true);
    confirmarBtn.parentNode.replaceChild(novoConfirmarBtn, confirmarBtn);
    
    // Adicionar listener para o botão confirmar
    novoConfirmarBtn.addEventListener('click', function() {
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        if (callback) callback();
    });
    
    // Mostrar modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}


// Função para remover militar da escala (da página de detalhes)
async function removerMilitarEscala(escalaMilitarId, nomeMilitar) {
    // Verificar se a escala está aprovada para solicitar justificativa
    const escalaStatus = '{{ escala_info.escala.status }}';
    const podeAlterar = {{ escala_info.pode_alterar|yesno:"true,false" }};
    
    if (escalaStatus === 'aprovada' && podeAlterar) {
        // Abrir modal de alteração para escalas aprovadas
        abrirModalAlteracaoEscala(escalaMilitarId, nomeMilitar, 'REMOVER_MILITAR');
    } else {
        mostrarConfirmacao(`Tem certeza que deseja remover ${nomeMilitar} desta escala?`, async function() {
            await executarRemocaoMilitar(escalaMilitarId);
        });
    }
}

// Variáveis globais para controle do modal de alteração
let escalaMilitarIdAtual = null;
let tipoAlteracaoAtual = null;

// Função para abrir modal de alteração de escala
function abrirModalAlteracaoEscala(escalaMilitarId, nomeMilitar, tipoAlteracao) {
    escalaMilitarIdAtual = escalaMilitarId;
    tipoAlteracaoAtual = tipoAlteracao;
    
    // Preencher informações da alteração
    document.getElementById('tipoAlteracao').textContent = tipoAlteracao === 'REMOVER_MILITAR' ? 'Remover Militar' : 'Alterar Dados';
    document.getElementById('militarAlteracao').textContent = nomeMilitar;
    
    // Limpar formulário
    document.getElementById('formAlteracaoEscala').reset();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalAlteracaoEscala'));
    modal.show();
}

// Função para confirmar alteração de escala
async function confirmarAlteracaoEscala() {
    const justificativa = document.getElementById('justificativaAlteracao').value.trim();
    const arquivo = document.getElementById('arquivoAlteracao').files[0];
    const observacoes = document.getElementById('observacoesAlteracao').value.trim();
    
    // Validar justificativa
    if (!justificativa) {
        mostrarAlerta('Justificativa é obrigatória para alterações em escalas aprovadas.', 'warning');
        return;
    }
    
    // Validar tamanho do arquivo (10MB)
    if (arquivo && arquivo.size > 10 * 1024 * 1024) {
        mostrarAlerta('Arquivo muito grande. Tamanho máximo permitido: 10MB.', 'warning');
        return;
    }
    
    try {
        // Preparar dados para envio
        const formData = new FormData();
        formData.append('escala_militar_id', escalaMilitarIdAtual);
        formData.append('justificativa', justificativa);
        formData.append('observacoes', observacoes);
        formData.append('tipo_alteracao', tipoAlteracaoAtual);
        
        if (arquivo) {
            formData.append('arquivo', arquivo);
        }
        
        // Enviar requisição
        const response = await fetch(`/militares/escalas/${escalaId}/api/remover-militar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAlteracaoEscala'));
            modal.hide();
            
            // Mostrar sucesso
            mostrarAlerta(data.message, 'success');
            
            // Recarregar página para atualizar dados
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            mostrarAlerta(data.message || 'Erro ao processar alteração.', 'danger');
        }
        
    } catch (error) {
        console.error('Erro ao processar alteração:', error);
        mostrarAlerta('Erro ao processar alteração. Tente novamente.', 'danger');
    }
}

// Função auxiliar para executar a remoção
async function executarRemocaoMilitar(escalaMilitarId, justificativa = '') {
    
    try {
        const response = await fetch(`/militares/escalas/${escalaId}/api/remover-militar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                escala_militar_id: escalaMilitarId,
                justificativa: justificativa
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            // Recarregar a página para atualizar a lista
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mostrarAlerta(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao remover militar:', error);
        mostrarAlerta('Erro ao remover militar', 'danger');
    }
}

// Função para atualizar militares escalados
function atualizarMilitaresEscalados() {
    // Atualizar apenas o conteúdo do modal sem fechar
    carregarMilitaresOrganizacao();
    carregarMilitaresEscalados();
    mostrarAlerta('Lista atualizada com sucesso!', 'success');
}


// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar efeitos visuais aos cards
    const cards = document.querySelectorAll('.militar-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Event listener para o modal
    const modal = document.getElementById('modalGerenciarMilitares');
    if (modal) {
        modal.addEventListener('show.bs.modal', function() {
            carregarMilitaresOrganizacao();
            controlarCamposOperacionais(); // Controlar visibilidade dos campos operacionais
        });
    }
    
    
    // Event listener para formulário individual
    const formIndividual = document.getElementById('formAdicionarIndividual');
    if (formIndividual) {
        formIndividual.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            adicionarMilitarIndividual(formData);
        });
    }
    
    // Event listener para formulário coletivo
    const formColetivo = document.getElementById('formAdicionarColetivo');
    if (formColetivo) {
        formColetivo.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            adicionarMilitaresColetivo(formData);
        });
    }
});

// Carregar seções administrativas disponíveis para autocomplete
async function carregarSecoesDisponiveis() {
    try {
        const response = await fetch('/militares/api/secoes-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            // Criar datalist se não existir
            let datalist = document.getElementById('secoes_admin_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'secoes_admin_disponiveis';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            
            data.secoes.forEach(secao => {
                const option = document.createElement('option');
                option.value = secao;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar seções administrativas:', error);
    }
}

// Carregar equipes disponíveis para autocomplete
async function carregarEquipesDisponiveis() {
    try {
        const response = await fetch('/militares/api/equipes-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            // Criar datalist se não existir
            let datalist = document.getElementById('equipes_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'equipes_disponiveis';
                document.body.appendChild(datalist);
            }
            
            // Limpar opções existentes
            datalist.innerHTML = '';
            
            // Adicionar opções
            data.equipes.forEach(equipe => {
                const option = document.createElement('option');
                option.value = equipe.nome;
                option.textContent = equipe.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar equipes:', error);
    }
}

// Carregar funções operacionais disponíveis para autocomplete
async function carregarFuncoesDisponiveis() {
    try {
        const response = await fetch('/militares/api/funcoes-operacionais-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            // Criar datalist se não existir
            let datalist = document.getElementById('funcoes_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'funcoes_disponiveis';
                document.body.appendChild(datalist);
            }
            
            // Limpar opções existentes
            datalist.innerHTML = '';
            
            // Adicionar opções
            data.funcoes.forEach(funcao => {
                const option = document.createElement('option');
                option.value = funcao.nome;
                option.textContent = funcao.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar funções:', error);
    }
}

// Carregar viaturas disponíveis para autocomplete
async function carregarViaturasDisponiveis() {
    try {
        const response = await fetch('/militares/api/viaturas-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            // Criar datalist se não existir
            let datalist = document.getElementById('viaturas_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'viaturas_disponiveis';
                document.body.appendChild(datalist);
            }
            
            // Limpar opções existentes
            datalist.innerHTML = '';
            
            // Adicionar opções
            data.viaturas.forEach(viatura => {
                const option = document.createElement('option');
                option.value = viatura.nome;
                option.textContent = viatura.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar viaturas:', error);
    }
}

// Carregar dados quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarEquipesDisponiveis();
    carregarFuncoesDisponiveis();
    carregarViaturasDisponiveis();
    
    // Listeners para campos de autocomplete já estão configurados via datalist
});



</script>

<!-- Modal de Alerta -->
<div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalAlertaHeader">
                <h5 class="modal-title" id="modalAlertaLabel">
                    <i id="modalAlertaIcon" class="fas fa-info-circle me-2"></i>
                    <span id="modalAlertaTitulo">Informação</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalAlertaMensagem" class="mb-0">Mensagem de alerta</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" id="modalAlertaConfirmar" style="display: none;">
                    <i class="fas fa-check me-1"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalConfirmacaoMensagem" class="mb-0">Tem certeza que deseja continuar?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="modalConfirmacaoConfirmar">
                    <i class="fas fa-check me-1"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alteração de Escala -->
<div class="modal fade" id="modalAlteracaoEscala" tabindex="-1" aria-labelledby="modalAlteracaoEscalaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalAlteracaoEscalaLabel">
                    <i class="fas fa-edit me-2"></i>
                    Alteração em Escala Aprovada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Atenção:</strong> Esta escala está aprovada. Todas as alterações devem ser justificadas e documentadas.
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Informações da Alteração</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-1"><strong>Tipo:</strong> <span id="tipoAlteracao"></span></p>
                            <p class="mb-0"><strong>Nome:</strong> <span id="militarAlteracao"></span></p>
                        </div>
                    </div>
                </div>
                
                <form id="formAlteracaoEscala" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="justificativaAlteracao" class="form-label">
                            <i class="fas fa-comment me-1"></i>
                            Justificativa <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="justificativaAlteracao" rows="4" 
                                placeholder="Descreva o motivo da alteração..." required></textarea>
                        <div class="form-text">Justificativa obrigatória para alterações em escalas aprovadas.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="arquivoAlteracao" class="form-label">
                            <i class="fas fa-paperclip me-1"></i>
                            Anexar Documento (Opcional)
                        </label>
                        <input type="file" class="form-control" id="arquivoAlteracao" 
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <div class="form-text">Formatos aceitos: PDF, DOC, DOCX, JPG, PNG (máx. 10MB)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesAlteracao" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>
                            Observações Adicionais
                        </label>
                        <textarea class="form-control" id="observacoesAlteracao" rows="2" 
                                placeholder="Observações complementares (opcional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="confirmarAlteracaoEscala">
                    <i class="fas fa-save me-1"></i>
                    Confirmar Alteração
                </button>
            </div>
        </div>
    </div>
</div>



<script>
// Função para sincronizar escala de abonar
async function sincronizarEscalaAbonar() {
    const btn = document.getElementById('btnSincronizarAbonar');
    const originalText = btn.innerHTML;
    
    // Desabilitar botão e mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sincronizando...';
    
    try {
        const response = await fetch(`/militares/escalas/{{ escala.pk }}/sincronizar-abonar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta(data.message, 'success');
        } else {
            mostrarAlerta(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao sincronizar escala de abonar:', error);
        mostrarAlerta('Erro ao sincronizar escala de abonar', 'danger');
    } finally {
        // Reabilitar botão
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Event listener para confirmar alteração de escala
document.addEventListener('DOMContentLoaded', function() {
    const confirmarBtn = document.getElementById('confirmarAlteracaoEscala');
    if (confirmarBtn) {
        confirmarBtn.addEventListener('click', confirmarAlteracaoEscala);
    }
});
</script>

{% endblock %}
