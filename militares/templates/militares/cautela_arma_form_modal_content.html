{% load static %}

<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarCautelaModalLabel">
        <i class="fas fa-shield-alt me-2"></i>
        Nova Cautela de Arma
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="formCriarCautela" method="post" action="{% url 'militares:cautela_arma_create' %}">
    {% csrf_token %}
    <div class="modal-body">
        <!-- Arma e Militar -->
        <h6 class="text-primary mb-3">
            <i class="fas fa-gun me-2"></i>Arma e Militar
        </h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.arma.id_for_label }}" class="form-label">
                    Arma <span class="text-danger">*</span>
                </label>
                {{ form.arma }}
                {% if form.arma.errors %}
                    <div class="invalid-feedback d-block">{{ form.arma.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Selecione a arma que será entregue em cautela</small>
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.militar.id_for_label }}" class="form-label">
                    Militar <span class="text-danger">*</span>
                </label>
                {{ form.militar }}
                {% if form.militar.errors %}
                    <div class="invalid-feedback d-block">{{ form.militar.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Militar que receberá a arma em cautela</small>
            </div>
        </div>
        
        <!-- Data e Hora da Cautela -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    Data e Hora da Cautela
                </label>
                <input type="text" class="form-control" value="{% now 'd/m/Y H:i' %}" readonly>
                <small class="form-text text-muted">Data e hora atual (preenchido automaticamente)</small>
            </div>
        </div>
        
        <!-- Organização -->
        <hr>
        <h6 class="text-primary mb-3">
            <i class="fas fa-building me-2"></i>Organização
        </h6>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="organizacao-display" class="form-label">
                    Organização (Onde a arma está carregada) <span class="text-danger">*</span>
                </label>
                <input type="text" id="organizacao-display" class="form-control" readonly placeholder="Selecione uma arma para carregar a organização automaticamente">
                <small class="form-text text-muted">
                    A organização será preenchida automaticamente com base no cadastro da arma selecionada e não pode ser editada.
                </small>
            </div>
        </div>
        
        <!-- Campos ocultos para armazenar os valores da organização -->
        {{ form.orgao.as_hidden }}
        {{ form.grande_comando.as_hidden }}
        {{ form.unidade.as_hidden }}
        {{ form.sub_unidade.as_hidden }}
        
        {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
        <div class="alert alert-danger">
            {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
            {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
            {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
            {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
        </div>
        {% endif %}
        
        <!-- Material Acompanhando -->
        <hr>
        <h6 class="text-primary mb-3">
            <i class="fas fa-box me-2"></i>Material Acompanhando
        </h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.quantidade_carregadores.id_for_label }}" class="form-label">
                    Quantidade de Carregadores
                </label>
                {{ form.quantidade_carregadores }}
                {% if form.quantidade_carregadores.errors %}
                    <div class="invalid-feedback d-block">{{ form.quantidade_carregadores.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.quantidade_municoes_catalogadas.id_for_label }}" class="form-label">
                    Quantidade de Munições Catalogadas
                </label>
                {{ form.quantidade_municoes_catalogadas }}
                {% if form.quantidade_municoes_catalogadas.errors %}
                    <div class="invalid-feedback d-block">{{ form.quantidade_municoes_catalogadas.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.numeracao_carregadores.id_for_label }}" class="form-label">
                    Numeração dos Carregadores
                </label>
                {{ form.numeracao_carregadores }}
                {% if form.numeracao_carregadores.errors %}
                    <div class="invalid-feedback d-block">{{ form.numeracao_carregadores.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Digite a numeração de cada carregador, separada por vírgula ou quebra de linha</small>
            </div>
        </div>
        
        <!-- Observações -->
        <hr>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    Observações
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div id="criarCautelaErrors" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="criarCautelaErrorMessage"></span>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar Cautela
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Função para carregar organização da arma
    async function carregarOrganizacaoArma(armaId) {
        if (!armaId) return;
        
        const orgaoHidden = document.getElementById('id_orgao_cautela');
        const grandeComandoHidden = document.getElementById('id_grande_comando_cautela');
        const unidadeHidden = document.getElementById('id_unidade_cautela');
        const subUnidadeHidden = document.getElementById('id_sub_unidade_cautela');
        const organizacaoDisplay = document.getElementById('organizacao-display');
        
        try {
            const url = '{% url "militares:arma_dados_organizacao" 0 %}'.replace('0', armaId);
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.organograma_id) {
                if (data.orgao_id && orgaoHidden) orgaoHidden.value = data.orgao_id;
                if (data.grande_comando_id && grandeComandoHidden) grandeComandoHidden.value = data.grande_comando_id;
                if (data.unidade_id && unidadeHidden) unidadeHidden.value = data.unidade_id;
                if (data.sub_unidade_id && subUnidadeHidden) subUnidadeHidden.value = data.sub_unidade_id;
                if (organizacaoDisplay) {
                    organizacaoDisplay.value = data.organizacao_texto || 'Organização carregada';
                }
            } else {
                if (orgaoHidden) orgaoHidden.value = '';
                if (grandeComandoHidden) grandeComandoHidden.value = '';
                if (unidadeHidden) unidadeHidden.value = '';
                if (subUnidadeHidden) subUnidadeHidden.value = '';
                if (organizacaoDisplay) organizacaoDisplay.value = 'Arma sem organização definida';
            }
        } catch (error) {
            console.error('Erro ao buscar dados da arma:', error);
            if (organizacaoDisplay) {
                organizacaoDisplay.value = 'Erro ao carregar organização';
            }
        }
    }
    
    // Inicializar organização quando arma for selecionada
    function inicializarOrganizacao() {
        const armaSelect = document.getElementById('id_arma_cautela');
        if (!armaSelect) return;
        
        // Carregar organização se houver arma pré-selecionada
        {% if arma_selecionada %}
        if (armaSelect.value) {
            carregarOrganizacaoArma(armaSelect.value);
        }
        {% endif %}
        
        // Listener para mudanças na seleção da arma
        armaSelect.addEventListener('change', function() {
            if (this.value) {
                carregarOrganizacaoArma(this.value);
            } else {
                const organizacaoDisplay = document.getElementById('organizacao-display');
                if (organizacaoDisplay) organizacaoDisplay.value = '';
            }
        });
    }
    
    // Inicializar Select2 no campo militar - versão simplificada e direta
    function inicializarSelect2Militar() {
        // Verificar se jQuery e Select2 estão disponíveis
        if (typeof jQuery === 'undefined' && typeof $ === 'undefined') {
            console.log('Aguardando jQuery...');
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        const $ = jQuery || window.$;
        
        if (typeof $.fn.select2 === 'undefined') {
            console.log('Aguardando Select2...');
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        // Tentar encontrar o campo de várias formas
        let militarSelect = $('#id_militar_cautela');
        
        // Se não encontrar pelo ID, tentar pelo name
        if (militarSelect.length === 0) {
            militarSelect = $('select[name="militar"]');
        }
        
        // Se ainda não encontrar, buscar no formulário
        if (militarSelect.length === 0) {
            const form = document.getElementById('formCriarCautela');
            if (form) {
                const selects = form.querySelectorAll('select');
                for (let i = 0; i < selects.length; i++) {
                    const select = selects[i];
                    if (select.id && select.id.includes('militar')) {
                        militarSelect = $(select);
                        break;
                    } else if (select.name && select.name.includes('militar')) {
                        militarSelect = $(select);
                        break;
                    }
                }
            }
        }
        
        // Se o campo não existe, tentar novamente
        if (militarSelect.length === 0) {
            console.log('Campo militar não encontrado, tentando novamente...');
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        console.log('Campo militar encontrado:', militarSelect.attr('id') || militarSelect.attr('name'));
        
        // Se já está inicializado, destruir e reinicializar
        if (militarSelect.hasClass('select2-hidden-accessible')) {
            try {
                militarSelect.select2('destroy');
            } catch (e) {
                // Ignorar erro
            }
        }
        
        // Inicializar Select2
        try {
            militarSelect.select2({
                placeholder: 'Digite o nome, matrícula ou posto do militar...',
                allowClear: true,
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: militarSelect.closest('.modal-body').length ? militarSelect.closest('.modal') : $(document.body),
                language: {
                    inputTooShort: function () {
                        return 'Digite pelo menos 2 caracteres...';
                    },
                    noResults: function () {
                        return 'Nenhum militar encontrado';
                    },
                    searching: function () {
                        return 'Buscando...';
                    }
                },
                ajax: {
                    url: '{% url "militares:militar-autocomplete" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term || ''
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results || []
                        };
                    },
                    cache: true
                }
            });
            console.log('✅ Select2 inicializado com sucesso no campo militar');
        } catch (e) {
            console.error('❌ Erro ao inicializar Select2:', e);
        }
    }
    
    // Função para inicializar tudo
    function inicializarTudo() {
        inicializarOrganizacao();
        inicializarSelect2Militar();
    }
    
    // Executar quando o script for carregado
    inicializarTudo();
    
    // Executar após delays para garantir que funcione com conteúdo dinâmico
    setTimeout(inicializarTudo, 50);
    setTimeout(inicializarTudo, 100);
    setTimeout(inicializarTudo, 200);
    setTimeout(inicializarTudo, 300);
    setTimeout(inicializarTudo, 500);
    setTimeout(inicializarTudo, 800);
    setTimeout(inicializarTudo, 1000);
    setTimeout(inicializarTudo, 1500);
    
    // Também executar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarTudo);
    } else {
        // DOM já está pronto, executar novamente
        setTimeout(inicializarTudo, 0);
    }
    
    // Executar quando o modal for mostrado (evento do Bootstrap)
    const modal = document.getElementById('criarCautelaModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            console.log('Modal mostrado, inicializando Select2...');
            setTimeout(inicializarTudo, 100);
        });
    }
})();
</script>
