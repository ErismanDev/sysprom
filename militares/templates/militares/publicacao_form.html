{% extends 'base.html' %}
{% load static %}

{% block title %}{{ publicacao.pk|yesno:"Editar,Novo" }} {{ tipo_display }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .form-header {
        {% if tipo == 'boletim-especial' %}
        background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
        {% elif tipo == 'boletim-reservado' %}
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        {% elif tipo == 'boletim-ostensivo' %}
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        {% else %}
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        {% endif %}
        color: white;
        padding: 30px;
        border-radius: 10px 10px 0 0;
        text-align: center;
    }
    
    .form-body {
        background: white;
        padding: 30px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-custom {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .help-text {
        font-size: 0.875em;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .status-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .status-info h6 {
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .status-info p {
        margin: 0;
        color: #1565c0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="form-container">
        <div class="form-header">
            <h2 class="mb-0">
                <i class="fas fa-{% if publicacao.pk %}edit{% elif tipo == 'boletim-especial' %}gem{% elif tipo == 'boletim-reservado' %}lock{% elif tipo == 'boletim-ostensivo' %}bullhorn{% else %}plus{% endif %} me-2"></i>
                {% if publicacao.pk %}Editar{% else %}Nova{% endif %} {{ tipo_display }}
            </h2>
            <p class="mb-0 mt-2">{% if publicacao.pk %}Atualize as informações da publicação{% else %}Preencha os dados da nova publicação{% endif %}</p>
        </div>
        
        <div class="form-body">
            {% if publicacao and publicacao.status == 'PUBLICADO' %}
            <div class="status-info">
                <h6><i class="fas fa-info-circle me-2"></i>Publicação Publicada</h6>
                <p>Esta publicação já foi publicada em {{ publicacao.data_publicacao|date:"d/m/Y H:i" }}. 
                   Apenas superusuários podem editá-la.</p>
            </div>
            {% endif %}
            
            <form method="post">
                {% csrf_token %}
                
                <!-- Campos número e tipo são gerados automaticamente na view -->
                
                <div class="form-group">
                    <label for="{{ form.titulo.id_for_label }}" class="form-label">
                        {{ form.titulo.label }}
                    </label>
                    {{ form.titulo }}
                    {% if form.titulo.help_text %}
                        <div class="help-text">{{ form.titulo.help_text }}</div>
                    {% endif %}
                    {% if form.titulo.errors %}
                        <div class="text-danger">{{ form.titulo.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="origem_publicacao" class="form-label">
                        {{ form.origem_publicacao.label }}
                    </label>
                    <select class="form-select" id="origem_publicacao" name="origem_publicacao" required>
                        <option value="">Selecione a origem da publicação</option>
                        
                        <!-- Órgãos -->
                        {% for orgao in orgaos %}
                        <option value="{{ orgao.nome }}" data-tipo="orgao" data-id="{{ orgao.id }}">
                            {{ orgao.nome }}
                        </option>
                        {% empty %}
                        <option value="">Nenhum órgão encontrado</option>
                        {% endfor %}
                        
                        <!-- Grandes Comandos -->
                        {% for gc in grandes_comandos %}
                        <option value="{{ gc.orgao.nome }} | {{ gc.nome }}" data-tipo="grande_comando" data-id="{{ gc.id }}">
                            {{ gc.orgao.nome }} | {{ gc.nome }}
                        </option>
                        {% empty %}
                        <option value="">Nenhum grande comando encontrado</option>
                        {% endfor %}
                        
                        <!-- Unidades -->
                        {% for unidade in unidades %}
                        <option value="{{ unidade.grande_comando.orgao.nome }} | {{ unidade.grande_comando.nome }} | {{ unidade.nome }}" data-tipo="unidade" data-id="{{ unidade.id }}">
                            {{ unidade.grande_comando.orgao.nome }} | {{ unidade.grande_comando.nome }} | {{ unidade.nome }}
                        </option>
                        {% empty %}
                        <option value="">Nenhuma unidade encontrada</option>
                        {% endfor %}
                        
                        <!-- Subunidades -->
                        {% for subunidade in subunidades %}
                        <option value="{{ subunidade.unidade.grande_comando.orgao.nome }} | {{ subunidade.unidade.grande_comando.nome }} | {{ subunidade.unidade.nome }} | {{ subunidade.nome }}" data-tipo="subunidade" data-id="{{ subunidade.id }}">
                            {{ subunidade.unidade.grande_comando.orgao.nome }} | {{ subunidade.unidade.grande_comando.nome }} | {{ subunidade.unidade.nome }} | {{ subunidade.nome }}
                        </option>
                        {% empty %}
                        <option value="">Nenhuma subunidade encontrada</option>
                        {% endfor %}
                    </select>
                    {% if form.origem_publicacao.help_text %}
                        <div class="help-text">{{ form.origem_publicacao.help_text }}</div>
                    {% endif %}
                    {% if form.origem_publicacao.errors %}
                        <div class="text-danger">{{ form.origem_publicacao.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.conteudo.id_for_label }}" class="form-label">
                        {{ form.conteudo.label }}
                    </label>
                    {{ form.conteudo }}
                    {% if form.conteudo.help_text %}
                        <div class="help-text">{{ form.conteudo.help_text }}</div>
                    {% endif %}
                    {% if form.conteudo.errors %}
                        <div class="text-danger">{{ form.conteudo.errors }}</div>
                    {% endif %}
                </div>
                
                <!-- Status é definido automaticamente como RASCUNHO -->
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'militares:notas_list' %}" class="btn btn-secondary btn-custom">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                    <div>
                        <button type="submit" class="btn btn-primary btn-custom">
                            <i class="fas fa-save me-2"></i>
                            {% if publicacao.pk %}Atualizar{% else %}Criar{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block ckeditor_media %}
    <!-- CKEditor 5 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
{% endblock %}

{% block extra_js %}
<script>
let editorInstance = null;

$(document).ready(function() {
    // Adicionar animação ao formulário
    $('.form-container').addClass('fade-in');
    
    // Inicializar CKEditor
    inicializarEditor();
    
    // Validação em tempo real
    $('form').on('submit', function(e) {
        var titulo = $('#{{ form.titulo.id_for_label }}').val().trim();
        let conteudo = '';
        
        // Obter conteúdo do editor
        if (editorInstance) {
            conteudo = editorInstance.getData().trim();
        } else {
            conteudo = $('#{{ form.conteudo.id_for_label }}').val().trim();
        }
        
        if (!titulo) {
            e.preventDefault();
            alert('Por favor, preencha o título da publicação.');
            $('#{{ form.titulo.id_for_label }}').focus();
            return false;
        }
        
        if (!conteudo) {
            e.preventDefault();
            alert('Por favor, preencha o conteúdo da publicação.');
            if (editorInstance) {
                editorInstance.focus();
            } else {
                $('#{{ form.conteudo.id_for_label }}').focus();
            }
            return false;
        }
        
        // Atualizar o textarea com o conteúdo do editor antes do envio
        if (editorInstance) {
            $('#{{ form.conteudo.id_for_label }}').val(conteudo);
        }
    });
    
    // Se estiver em um iframe (modal), enviar mensagem quando salvar
    if (window.parent !== window) {
        // Interceptar o envio do formulário
        $('form').on('submit', function(e) {
            // Aguardar um pouco para o formulário ser processado
            setTimeout(function() {
                // Verificar se houve redirecionamento (sucesso)
                if (window.location.href.includes('notas-reservadas/') && 
                    !window.location.href.includes('nova/')) {
                    // Enviar mensagem para o parent (página principal)
                    window.parent.postMessage('nota_salva', '*');
                }
            }, 1000);
        });
    }
});

// Configurar dropdown de origem da publicação
$(document).ready(function() {
    const origemSelect = $('#origem_publicacao');
    
    // Adicionar busca/filtro
    origemSelect.select2({
        placeholder: 'Selecione a origem da publicação',
        allowClear: true,
        width: '100%',
        language: 'pt-BR'
    });
    
    // Pré-selecionar origem baseada na lotação do usuário
    {% if form.origem_publicacao.initial %}
        const origemInicial = '{{ form.origem_publicacao.initial }}';
        console.log('Origem inicial do formulário:', origemInicial);
        
        // Procurar opção que corresponde à origem inicial
        origemSelect.find('option').each(function() {
            if ($(this).val() === origemInicial) {
                console.log('Selecionando origem:', origemInicial);
                origemSelect.val(origemInicial).trigger('change');
                return false; // Sair do loop
            }
        });
    {% endif %}
});

// Função para inicializar o CKEditor
function inicializarEditor() {
    if (editorInstance) {
        return; // Já inicializado
    }
    
    setTimeout(function() {
        if (typeof ClassicEditor !== 'undefined') {
            ClassicEditor
                .create(document.querySelector('#{{ form.conteudo.id_for_label }}'), {
                    toolbar: [
                        'undo', 'redo', '|',
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                        'alignment', '|',
                        'numberedList', 'bulletedList', '|',
                        'indent', 'outdent', '|',
                        'link', 'blockQuote', 'insertTable', '|',
                        'subscript', 'superscript', '|',
                        'code', '|',
                        'findAndReplace', '|',
                        'specialCharacters', '|',
                        'horizontalLine', '|',
                        'sourceEditing'
                    ],
                    language: 'pt-br',
                    height: 400
                })
                .then(editor => {
                    editorInstance = editor;
                    console.log('✅ CKEditor inicializado para edição de publicação');
                })
                .catch(error => {
                    console.error('❌ Erro ao inicializar CKEditor:', error);
                });
        } else {
            console.warn('⚠️ CKEditor não está disponível');
        }
    }, 200);
}
</script>

<style>
    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}
