{% extends 'base.html' %}
{% load static %}

{% block title %}Criar Turma - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Criar Nova Turma
                </h1>
                <a href="{% url 'militares:ensino_turmas_listar' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="post" id="formCriarTurma" action="{% url 'militares:ensino_turma_criar' %}">
                        {% csrf_token %}
                        
                        <!-- Informações Básicas -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-info-circle me-2"></i>Informações Básicas
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.curso.id_for_label }}" class="form-label">
                                    Curso <span class="text-danger">*</span>
                                </label>
                                {{ form.curso }}
                                {% if form.curso.errors %}
                                    <div class="invalid-feedback d-block">{{ form.curso.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.edicao.id_for_label }}" class="form-label">
                                    Edição <span class="text-danger">*</span>
                                </label>
                                {{ form.edicao }}
                                {% if form.edicao.errors %}
                                    <div class="invalid-feedback d-block">{{ form.edicao.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Todas as turmas devem estar dentro de uma edição. Selecione a edição do curso (ex: EDIÇÃO 2025)</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.identificacao.id_for_label }}" class="form-label">
                                    Identificação da Turma <span class="text-danger">*</span>
                                </label>
                                {{ form.identificacao }}
                                {% if form.identificacao.errors %}
                                    <div class="invalid-feedback d-block">{{ form.identificacao.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Ex: TURMA 1, TURMA 2, etc. (A edição será exibida automaticamente)</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                    Data de Início <span class="text-danger">*</span>
                                </label>
                                {{ form.data_inicio }}
                                {% if form.data_inicio.errors %}
                                    <div class="invalid-feedback d-block">{{ form.data_inicio.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                                    Data de Término <span class="text-danger">*</span>
                                </label>
                                {{ form.data_fim }}
                                {% if form.data_fim.errors %}
                                    <div class="invalid-feedback d-block">{{ form.data_fim.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.ativa }}
                                    <label class="form-check-label" for="{{ form.ativa.id_for_label }}">
                                        Turma Ativa
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                    Observações
                                </label>
                                {{ form.observacoes }}
                                {% if form.observacoes.errors %}
                                    <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Supervisor e Coordenador do Curso -->
                        <hr class="my-4">
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-user-tie me-2"></i>Supervisor e Coordenador do Curso
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.supervisor_curso.id_for_label }}" class="form-label">
                                    Supervisor do Curso
                                </label>
                                {{ form.supervisor_curso }}
                                {% if form.supervisor_curso.errors %}
                                    <div class="invalid-feedback d-block">{{ form.supervisor_curso.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.coordenador_curso.id_for_label }}" class="form-label">
                                    Coordenador do Curso
                                </label>
                                {{ form.coordenador_curso }}
                                {% if form.coordenador_curso.errors %}
                                    <div class="invalid-feedback d-block">{{ form.coordenador_curso.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Supervisor e Coordenador de Turma -->
                        <hr class="my-4">
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-users-cog me-2"></i>Supervisor e Coordenador de Turma
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.supervisor_turma.id_for_label }}" class="form-label">
                                    Supervisor de Turma
                                </label>
                                {{ form.supervisor_turma }}
                                {% if form.supervisor_turma.errors %}
                                    <div class="invalid-feedback d-block">{{ form.supervisor_turma.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.coordenador_turma.id_for_label }}" class="form-label">
                                    Coordenador de Turma
                                </label>
                                {{ form.coordenador_turma }}
                                {% if form.coordenador_turma.errors %}
                                    <div class="invalid-feedback d-block">{{ form.coordenador_turma.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Disciplinas do Curso (carregadas automaticamente) -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="mb-3 border-bottom pb-2">
                                    <i class="fas fa-list-ul me-2"></i>
                                    Disciplinas do Curso
                                </h5>
                                <div id="disciplinas-curso-container" class="border rounded p-3 bg-light">
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecione um curso acima para carregar as disciplinas.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seleção de Alunos -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="mb-3 border-bottom pb-2">
                                    <i class="fas fa-user-graduate me-2"></i>
                                    Selecionar Alunos
                                </h5>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-success" onclick="abrirModalCriarAluno()">
                                        <i class="fas fa-user-plus me-1"></i>Criar Novo Aluno (Outra Força/Civil)
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-list me-1"></i>Alunos Disponíveis
                                        </label>
                                        
                                        <!-- Filtros e Pesquisa -->
                                        <div class="mb-2">
                                            <div class="row g-2">
                                                <div class="col-12">
                                                    <input type="text" class="form-control form-control-sm" id="pesquisa-militar" 
                                                           placeholder="Pesquisar por nome, CPF ou matrícula..." 
                                                           onkeyup="filtrarMilitares()">
                                                </div>
                                                <div class="col-12">
                                                    <select class="form-select form-select-sm" id="filtro-tipo" onchange="filtrarMilitares()">
                                                        <option value="">Todos os Tipos</option>
                                                        <option value="BOMBEIRO">Bombeiro Militar</option>
                                                        <option value="OUTRA_FORCA">Militar de Outra Força</option>
                                                        <option value="CIVIL">Civil</option>
                                                    </select>
                                                </div>
                                                <div class="col-12">
                                                    <select class="form-select form-select-sm" id="filtro-posto" onchange="filtrarMilitares()">
                                                        <option value="">Todos os Postos</option>
                                                        {% for codigo, nome in postos_graduacao %}
                                                        <option value="{{ codigo }}">{{ nome }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="border rounded p-2 bg-light" style="max-height: 400px; overflow-y: auto;">
                                            <div class="mb-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosAlunos()">
                                                    <i class="fas fa-check-double me-1"></i>Selecionar Todos
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodosAlunos()">
                                                    <i class="fas fa-times me-1"></i>Desmarcar Todos
                                                </button>
                                                <small class="text-muted ms-2">
                                                    <span id="total-militares-filtrados">{{ alunos_disponiveis.count }}</span> aluno(s) disponível(is)
                                                </small>
                                            </div>
                                            <div id="militares-disponiveis">
                                                {% for aluno in alunos_disponiveis %}
                                                <div class="form-check militar-item" 
                                                     data-aluno-id="{{ aluno.pk }}"
                                                     data-aluno-nome="{% if aluno.militar %}{{ aluno.militar.nome_completo|lower }}{% elif aluno.nome_outra_forca %}{{ aluno.nome_outra_forca|lower }}{% elif aluno.nome_civil %}{{ aluno.nome_civil|lower }}{% endif %}"
                                                     data-aluno-tipo="{{ aluno.tipo_aluno }}"
                                                     {% if aluno.tipo_aluno == 'BOMBEIRO' and aluno.militar %}data-militar-posto="{{ aluno.militar.posto_graduacao }}"{% endif %}>
                                                    <input class="form-check-input aluno-checkbox" type="checkbox" 
                                                           value="{{ aluno.pk }}" id="aluno_{{ aluno.pk }}"
                                                           data-aluno-id="{{ aluno.pk }}" 
                                                           data-aluno-nome="{% if aluno.militar %}{{ aluno.militar.nome_completo }}{% elif aluno.nome_outra_forca %}{{ aluno.nome_outra_forca }}{% elif aluno.nome_civil %}{{ aluno.nome_civil }}{% endif %}">
                                                    <label class="form-check-label" for="aluno_{{ aluno.pk }}">
                                                        {% if aluno.tipo_aluno == 'BOMBEIRO' and aluno.militar %}
                                                            <strong>{{ aluno.militar.get_posto_graduacao_display }} {{ aluno.militar.nome_completo }}</strong>
                                                            <span class="badge bg-primary ms-1">Bombeiro</span>
                                                            {% if aluno.militar.cpf %}
                                                                <small class="text-muted">(CPF: {{ aluno.militar.cpf }})</small>
                                                            {% endif %}
                                                        {% elif aluno.tipo_aluno == 'OUTRA_FORCA' %}
                                                            <strong>{{ aluno.get_posto_outra_forca_display }} {{ aluno.nome_outra_forca }}</strong>
                                                            <span class="badge bg-info ms-1">{{ aluno.get_forca_armada_display }}</span>
                                                            {% if aluno.cpf_outra_forca %}
                                                                <small class="text-muted">(CPF: {{ aluno.cpf_outra_forca }})</small>
                                                            {% endif %}
                                                        {% elif aluno.tipo_aluno == 'CIVIL' %}
                                                            <strong>{{ aluno.nome_civil }}</strong>
                                                            <span class="badge bg-success ms-1">Civil</span>
                                                            {% if aluno.cpf_civil %}
                                                                <small class="text-muted">(CPF: {{ aluno.cpf_civil }})</small>
                                                            {% endif %}
                                                        {% endif %}
                                                    </label>
                                                </div>
                                                {% empty %}
                                                <p class="text-muted mb-0">Nenhum aluno cadastrado.</p>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-primary btn-sm mt-2" onclick="adicionarAlunosSelecionados()">
                                            <i class="fas fa-arrow-right me-1"></i>Adicionar à Turma
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-check-square me-1"></i>Alunos da Turma
                                        </label>
                                        <div class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                                            <div id="alunos-turma">
                                                <p class="text-muted mb-0">Nenhum aluno adicionado. Selecione militares à esquerda e clique em "Adicionar à Turma".</p>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Total: <span id="total-alunos-turma">0</span> aluno(s)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo hidden para manter compatibilidade com o formulário -->
                        <div style="display: none;">
                            {{ form.disciplinas }}
                            {{ form.monitores_militares }}
                            {{ form.monitores_externos }}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'militares:ensino_turmas_listar' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Salvar Turma
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Variáveis globais
    var disciplinasCurso = [];
    var instrutoresDisponiveis = [];
    var monitoresDisponiveis = [];
    
    // Função para carregar disciplinas do curso
    function carregarDisciplinasCurso(cursoId) {
        if (!cursoId) {
            document.getElementById('disciplinas-curso-container').innerHTML = `
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Selecione um curso acima para carregar as disciplinas.
                </p>
            `;
            return;
        }
        
        // Mostrar loading
        document.getElementById('disciplinas-curso-container').innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mb-0 mt-2">Carregando disciplinas...</p>
            </div>
        `;
        
        // Buscar disciplinas do curso via AJAX
        var urlBase = '/militares/ensino/cursos/';
        var url = urlBase + cursoId + '/disciplinas/';
        {% if turma and turma.pk %}
        url += '?turma_id={{ turma.pk }}';
        {% endif %}
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Erro HTTP: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            disciplinasCurso = data.disciplinas || [];
            instrutoresDisponiveis = data.instrutores || [];
            monitoresDisponiveis = data.monitores || [];
            console.log('Disciplinas carregadas:', disciplinasCurso.length);
            console.log('Instrutores disponíveis:', instrutoresDisponiveis.length);
            console.log('Monitores disponíveis:', monitoresDisponiveis.length);
            exibirDisciplinas(disciplinasCurso, instrutoresDisponiveis, monitoresDisponiveis);
        })
        .catch(function(error) {
            console.error('Erro ao carregar disciplinas:', error);
            document.getElementById('disciplinas-curso-container').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar disciplinas. Tente novamente.
                </div>
            `;
        });
    }
    
    // Função para exibir disciplinas com seleção de instrutores e monitores
    function exibirDisciplinas(disciplinas, instrutores, monitores) {
        if (disciplinas.length === 0) {
            document.getElementById('disciplinas-curso-container').innerHTML = `
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Este curso não possui disciplinas cadastradas.
                </p>
            `;
            return;
        }
        
        var html = '<div class="accordion" id="disciplinasAccordion">';
        
        disciplinas.forEach(function(disc, index) {
            var disciplinaId = disc.id;
            var accordionId = 'disc_' + disciplinaId;
            
            html += '<div class="accordion-item">';
            html += '<h2 class="accordion-header" id="heading' + accordionId + '">';
            html += '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse' + accordionId + '">';
            html += '<strong>' + (disc.ordem || '-') + '. ' + disc.nome;
            if (disc.codigo) {
                html += ' <small class="text-muted">(' + disc.codigo + ')</small>';
            }
            html += '</strong>';
            html += '</button>';
            html += '</h2>';
            html += '<div id="collapse' + accordionId + '" class="accordion-collapse collapse" data-bs-parent="#disciplinasAccordion">';
            html += '<div class="accordion-body">';
            
            // Instrutor Responsável (dual-column como alunos)
            html += '<div class="mb-4">';
            html += '<h6 class="mb-3"><i class="fas fa-chalkboard-teacher me-2"></i>Instrutor Responsável</h6>';
            html += '<div class="row">';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Instrutores Disponíveis</label>';
            html += '<div class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;">';
            html += '<div class="mb-2">';
            html += '<button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosInstrutores(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-check-double me-1"></i>Selecionar Todos';
            html += '</button>';
            html += '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodosInstrutores(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-times me-1"></i>Desmarcar Todos';
            html += '</button>';
            html += '</div>';
            html += '<div id="instrutores-disponiveis-' + disciplinaId + '">';
            instrutores.forEach(function(instr) {
                var jaSelecionado = (disc.instrutor_militar_id && instr.tipo === 'MILITAR' && String(instr.id) === String(disc.instrutor_militar_id)) ||
                                   (disc.instrutor_externo_id && instr.tipo === 'EXTERNO' && String(instr.id) === String(disc.instrutor_externo_id));
                if (!jaSelecionado) {
                    html += '<div class="form-check instrutor-item" data-instrutor-id="' + instr.id + '" data-instrutor-tipo="' + instr.tipo + '" data-instrutor-nome="' + instr.nome.toLowerCase() + '">';
                    html += '<input class="form-check-input instrutor-checkbox" type="checkbox" value="' + instr.id + '" data-instrutor-id="' + instr.id + '" data-instrutor-tipo="' + instr.tipo + '" data-instrutor-nome="' + instr.nome + '" id="instr_' + disciplinaId + '_' + instr.id + '">';
                    html += '<label class="form-check-label" for="instr_' + disciplinaId + '_' + instr.id + '">';
                    html += '<span class="badge bg-' + (instr.tipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (instr.tipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>';
                    html += instr.nome;
                    html += '</label>';
                    html += '</div>';
                }
            });
            html += '</div>';
            html += '</div>';
            html += '<button type="button" class="btn btn-primary btn-sm mt-2" onclick="adicionarInstrutorSelecionado(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-arrow-right me-1"></i>Adicionar Instrutor';
            html += '</button>';
            html += '</div>';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Instrutor Selecionado</label>';
            html += '<div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">';
            html += '<div id="instrutor-selecionado-' + disciplinaId + '">';
            if (disc.instrutor_militar_id || disc.instrutor_externo_id) {
                var instrutorSelecionado = null;
                if (disc.instrutor_militar_id) {
                    instrutores.forEach(function(instr) {
                        if (instr.tipo === 'MILITAR' && String(instr.id) === String(disc.instrutor_militar_id)) {
                            instrutorSelecionado = instr;
                        }
                    });
                } else if (disc.instrutor_externo_id) {
                    instrutores.forEach(function(instr) {
                        if (instr.tipo === 'EXTERNO' && String(instr.id) === String(disc.instrutor_externo_id)) {
                            instrutorSelecionado = instr;
                        }
                    });
                }
                if (instrutorSelecionado) {
                    html += '<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded instrutor-item-selecionado" data-instrutor-id="' + instrutorSelecionado.id + '" data-instrutor-tipo="' + instrutorSelecionado.tipo + '">';
                    html += '<div>';
                    html += '<span class="badge bg-' + (instrutorSelecionado.tipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (instrutorSelecionado.tipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>';
                    html += '<strong>' + instrutorSelecionado.nome + '</strong>';
                    html += '</div>';
                    html += '<button type="button" class="btn btn-sm btn-danger" onclick="removerInstrutor(\'' + disciplinaId + '\', \'' + instrutorSelecionado.id + '\', this)">';
                    html += '<i class="fas fa-times"></i>';
                    html += '</button>';
                    html += '</div>';
                    html += '<input type="hidden" name="disciplina_' + disciplinaId + '_instrutor" value="' + instrutorSelecionado.tipo + '_' + instrutorSelecionado.id + '">';
                }
            } else {
                html += '<p class="text-muted mb-0">Nenhum instrutor selecionado. Selecione um instrutor à esquerda e clique em "Adicionar Instrutor".</p>';
            }
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Monitores (dual-column como alunos)
            html += '<div class="mb-3">';
            html += '<h6 class="mb-3"><i class="fas fa-user-tie me-2"></i>Monitores</h6>';
            html += '<div class="row">';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Monitores Disponíveis</label>';
            html += '<div class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;">';
            html += '<div class="mb-2">';
            html += '<button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosMonitores(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-check-double me-1"></i>Selecionar Todos';
            html += '</button>';
            html += '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodosMonitores(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-times me-1"></i>Desmarcar Todos';
            html += '</button>';
            html += '</div>';
            html += '<div id="monitores-disponiveis-' + disciplinaId + '">';
            monitores.forEach(function(mon) {
                var jaSelecionado = false;
                if (mon.tipo === 'MILITAR' && disc.monitores_militares_ids && disc.monitores_militares_ids.length > 0) {
                    jaSelecionado = disc.monitores_militares_ids.some(function(id) {
                        return String(id) === String(mon.id);
                    });
                } else if (mon.tipo === 'EXTERNO' && disc.monitores_externos_ids && disc.monitores_externos_ids.length > 0) {
                    jaSelecionado = disc.monitores_externos_ids.some(function(id) {
                        return String(id) === String(mon.id);
                    });
                }
                if (!jaSelecionado) {
                    html += '<div class="form-check monitor-item" data-monitor-id="' + mon.id + '" data-monitor-tipo="' + mon.tipo + '" data-monitor-nome="' + mon.nome.toLowerCase() + '">';
                    html += '<input class="form-check-input monitor-checkbox" type="checkbox" value="' + mon.id + '" data-monitor-id="' + mon.id + '" data-monitor-tipo="' + mon.tipo + '" data-monitor-nome="' + mon.nome + '" id="mon_' + disciplinaId + '_' + mon.id + '">';
                    html += '<label class="form-check-label" for="mon_' + disciplinaId + '_' + mon.id + '">';
                    html += '<span class="badge bg-' + (mon.tipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (mon.tipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>';
                    html += mon.nome;
                    html += '</label>';
                    html += '</div>';
                }
            });
            html += '</div>';
            html += '</div>';
            html += '<button type="button" class="btn btn-primary btn-sm mt-2" onclick="adicionarMonitoresSelecionados(\'' + disciplinaId + '\')">';
            html += '<i class="fas fa-arrow-right me-1"></i>Adicionar à Disciplina';
            html += '</button>';
            html += '</div>';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Monitores Selecionados</label>';
            html += '<div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">';
            html += '<div id="monitores-selecionados-' + disciplinaId + '">';
            var temMonitores = false;
            if (disc.monitores_militares_ids && disc.monitores_militares_ids.length > 0) {
                disc.monitores_militares_ids.forEach(function(monId) {
                    monitores.forEach(function(mon) {
                        if (mon.tipo === 'MILITAR' && String(mon.id) === String(monId)) {
                            temMonitores = true;
                            html += '<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded monitor-item-selecionado" data-monitor-id="' + mon.id + '" data-monitor-tipo="' + mon.tipo + '">';
                            html += '<div>';
                            html += '<span class="badge bg-primary me-1">Militar</span>';
                            html += '<strong>' + mon.nome + '</strong>';
                            html += '</div>';
                            html += '<button type="button" class="btn btn-sm btn-danger" onclick="removerMonitor(\'' + disciplinaId + '\', \'' + mon.id + '\', this)">';
                            html += '<i class="fas fa-times"></i>';
                            html += '</button>';
                            html += '</div>';
                            html += '<input type="hidden" name="disciplina_' + disciplinaId + '_monitores_militares[]" value="' + mon.id + '">';
                        }
                    });
                });
            }
            if (disc.monitores_externos_ids && disc.monitores_externos_ids.length > 0) {
                disc.monitores_externos_ids.forEach(function(monId) {
                    monitores.forEach(function(mon) {
                        if (mon.tipo === 'EXTERNO' && String(mon.id) === String(monId)) {
                            temMonitores = true;
                            html += '<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded monitor-item-selecionado" data-monitor-id="' + mon.id + '" data-monitor-tipo="' + mon.tipo + '">';
                            html += '<div>';
                            html += '<span class="badge bg-info me-1">Externo</span>';
                            html += '<strong>' + mon.nome + '</strong>';
                            html += '</div>';
                            html += '<button type="button" class="btn btn-sm btn-danger" onclick="removerMonitor(\'' + disciplinaId + '\', \'' + mon.id + '\', this)">';
                            html += '<i class="fas fa-times"></i>';
                            html += '</button>';
                            html += '</div>';
                            html += '<input type="hidden" name="disciplina_' + disciplinaId + '_monitores_externos[]" value="' + mon.id + '">';
                        }
                    });
                });
            }
            if (!temMonitores) {
                html += '<p class="text-muted mb-0">Nenhum monitor selecionado. Selecione monitores à esquerda e clique em "Adicionar à Disciplina".</p>';
            }
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Bloco da Disciplina
            html += '<div class="mb-4">';
            html += '<h6 class="mb-3"><i class="fas fa-layer-group me-2"></i>Bloco da Disciplina</h6>';
            html += '<div class="row">';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Número do Bloco <span class="text-danger">*</span></label>';
            html += '<input type="number" class="form-control" name="disciplina_' + disciplinaId + '_bloco" value="' + (disc.numero_bloco || '1') + '" min="1" required>';
            html += '<small class="form-text text-muted">Alunos devem ser aprovados em todas as disciplinas de um bloco para avançar ao próximo.</small>';
            html += '</div>';
            html += '<div class="col-md-6 mb-3">';
            html += '<label class="form-label">Ordem no Bloco</label>';
            html += '<input type="number" class="form-control" name="disciplina_' + disciplinaId + '_ordem_bloco" value="' + (disc.ordem_bloco || '1') + '" min="1">';
            html += '<small class="form-text text-muted">Ordem da disciplina dentro do bloco (para organização visual).</small>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '<input type="hidden" name="disciplinas_ids" value="' + disciplinas.map(function(d) { return d.id; }).join(',') + '">';
        
        document.getElementById('disciplinas-curso-container').innerHTML = html;
        
        // Atualizar campo hidden do formulário
        var disciplinasField = document.querySelector('#id_disciplinas');
        if (disciplinasField) {
            disciplinas.forEach(function(disc) {
                var option = document.createElement('option');
                option.value = disc.id;
                option.selected = true;
                disciplinasField.appendChild(option);
            });
        }
    }
    
    // Listener para mudança no campo curso
    function inicializarCursoField() {
        var cursoField = document.getElementById('id_curso');
        if (cursoField) {
            cursoField.addEventListener('change', function() {
                var cursoId = this.value;
                carregarDisciplinasCurso(cursoId);
            });
            
            // Se já tiver um curso selecionado, carregar disciplinas
            if (cursoField.value) {
                carregarDisciplinasCurso(cursoField.value);
            }
        }
    }
    
    // Inicializar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarCursoField);
    } else {
        inicializarCursoField();
    }
    
    // Função para corrigir valores de data após carregamento
    function corrigirValoresData() {
        var dataInicioField = document.getElementById('id_data_inicio');
        var dataFimField = document.getElementById('id_data_fim');
        
        if (dataInicioField && dataInicioField.value) {
            var dataInicio = dataInicioField.value;
            if (dataInicio && dataInicio.indexOf('/') !== -1) {
                var partes = dataInicio.split('/');
                if (partes.length === 3) {
                    dataInicioField.value = partes[2] + '-' + partes[1] + '-' + partes[0];
                }
            }
        }
        
        if (dataFimField && dataFimField.value) {
            var dataFim = dataFimField.value;
            if (dataFim && dataFim.indexOf('/') !== -1) {
                var partes = dataFim.split('/');
                if (partes.length === 3) {
                    dataFimField.value = partes[2] + '-' + partes[1] + '-' + partes[0];
                }
            }
        }
    }
    
    setTimeout(corrigirValoresData, 100);
    
    // Função para filtrar militares
    window.filtrarMilitares = function() {
        const pesquisa = document.getElementById('pesquisa-militar').value.toLowerCase().trim();
        const filtroTipo = document.getElementById('filtro-tipo').value;
        const filtroPosto = document.getElementById('filtro-posto').value;
        const militaresItems = document.querySelectorAll('.militar-item');
        let totalVisiveis = 0;
        
        militaresItems.forEach(function(item) {
            const nome = item.getAttribute('data-aluno-nome') || item.getAttribute('data-militar-nome') || '';
            const cpf = item.getAttribute('data-militar-cpf') || '';
            const matricula = item.getAttribute('data-militar-matricula') || '';
            const posto = item.getAttribute('data-militar-posto') || '';
            const tipo = item.getAttribute('data-aluno-tipo') || '';
            
            let mostrar = true;
            
            // Filtro por tipo
            if (filtroTipo && tipo !== filtroTipo) {
                mostrar = false;
            }
            
            // Filtro por posto (apenas para bombeiros)
            if (mostrar && filtroPosto && tipo === 'BOMBEIRO' && posto !== filtroPosto) {
                mostrar = false;
            }
            
            // Pesquisa por texto
            if (mostrar && pesquisa) {
                const pesquisaLower = pesquisa.toLowerCase();
                const matchNome = nome.includes(pesquisaLower);
                const matchCpf = cpf.toLowerCase().includes(pesquisaLower);
                const matchMatricula = matricula.toLowerCase().includes(pesquisaLower);
                
                if (!matchNome && !matchCpf && !matchMatricula) {
                    mostrar = false;
                }
            }
            
            if (mostrar) {
                item.style.display = '';
                totalVisiveis++;
            } else {
                item.style.display = 'none';
                const checkbox = item.querySelector('.aluno-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });
        
        const contador = document.getElementById('total-militares-filtrados');
        if (contador) {
            contador.textContent = totalVisiveis;
        }
    };
    
    // Funções para gerenciar alunos
    window.selecionarTodosAlunos = function() {
        const checkboxes = document.querySelectorAll('.aluno-checkbox');
        checkboxes.forEach(function(checkbox) {
            const item = checkbox.closest('.militar-item');
            if (item && item.style.display !== 'none') {
                const alunoId = checkbox.getAttribute('data-aluno-id') || checkbox.value;
                const jaNaTurma = document.querySelector('.aluno-item-turma[data-aluno-id="' + alunoId + '"]');
                if (!jaNaTurma) {
                    checkbox.checked = true;
                }
            }
        });
    };
    
    window.desmarcarTodosAlunos = function() {
        const checkboxes = document.querySelectorAll('.aluno-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    };
    
    window.adicionarAlunosSelecionados = function() {
        const checkboxes = document.querySelectorAll('.aluno-checkbox:checked');
        const containerTurma = document.getElementById('alunos-turma');
        
        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos um aluno.');
            return;
        }
        
        checkboxes.forEach(function(checkbox) {
            const alunoId = checkbox.getAttribute('data-aluno-id') || checkbox.value;
            const alunoNome = checkbox.getAttribute('data-aluno-nome');
            const alunoItem = checkbox.closest('.militar-item');
            const alunoTipo = alunoItem ? alunoItem.getAttribute('data-aluno-tipo') : '';
            
            const jaExiste = containerTurma.querySelector('.aluno-item-turma[data-aluno-id="' + alunoId + '"]');
            if (jaExiste) {
                return;
            }
            
            const msgVazio = containerTurma.querySelector('p.text-muted');
            if (msgVazio && msgVazio.textContent.includes('Nenhum aluno')) {
                msgVazio.remove();
            }
            
            let badgeHtml = '';
            if (alunoTipo === 'BOMBEIRO') {
                badgeHtml = '<span class="badge bg-primary ms-1">Bombeiro</span>';
            } else if (alunoTipo === 'OUTRA_FORCA') {
                badgeHtml = '<span class="badge bg-info ms-1">Outra Força</span>';
            } else if (alunoTipo === 'CIVIL') {
                badgeHtml = '<span class="badge bg-success ms-1">Civil</span>';
            }
            
            const novoItem = document.createElement('div');
            novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded aluno-item-turma';
            novoItem.setAttribute('data-aluno-id', alunoId);
            novoItem.innerHTML = `
                <div>
                    <strong>${alunoNome}</strong> ${badgeHtml}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAlunoTurma(${alunoId}, this)">
                    <i class="fas fa-times"></i>
                </button>
                <input type="hidden" name="alunos_selecionados" value="${alunoId}">
            `;
            containerTurma.appendChild(novoItem);
            
            checkbox.checked = false;
        });
        
        atualizarContadorAlunos();
    };
    
    window.removerAlunoTurma = function(alunoId, botao) {
        if (confirm('Tem certeza que deseja remover este aluno da turma?')) {
            const item = botao.closest('.aluno-item-turma');
            if (item) {
                item.remove();
                
                const checkbox = document.querySelector('.aluno-checkbox[data-aluno-id="' + alunoId + '"]') || 
                                document.querySelector('.aluno-checkbox[value="' + alunoId + '"]');
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                const containerTurma = document.getElementById('alunos-turma');
                if (containerTurma.querySelectorAll('.aluno-item-turma').length === 0) {
                    containerTurma.innerHTML = '<p class="text-muted mb-0">Nenhum aluno adicionado. Selecione alunos à esquerda e clique em "Adicionar à Turma".</p>';
                }
                
                atualizarContadorAlunos();
            }
        }
    };
    
    // Funções para gerenciar instrutores
    window.selecionarTodosInstrutores = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#instrutores-disponiveis-' + disciplinaId + ' .instrutor-checkbox');
        checkboxes.forEach(function(checkbox) {
            const item = checkbox.closest('.instrutor-item');
            if (item && item.style.display !== 'none') {
                checkbox.checked = true;
            }
        });
    };
    
    window.desmarcarTodosInstrutores = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#instrutores-disponiveis-' + disciplinaId + ' .instrutor-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    };
    
    window.adicionarInstrutorSelecionado = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#instrutores-disponiveis-' + disciplinaId + ' .instrutor-checkbox:checked');
        const containerSelecionado = document.getElementById('instrutor-selecionado-' + disciplinaId);
        
        if (checkboxes.length === 0) {
            alert('Por favor, selecione um instrutor.');
            return;
        }
        
        if (checkboxes.length > 1) {
            alert('Apenas um instrutor pode ser selecionado por disciplina.');
            return;
        }
        
        const checkbox = checkboxes[0];
        const instrutorId = checkbox.getAttribute('data-instrutor-id');
        const instrutorTipo = checkbox.getAttribute('data-instrutor-tipo');
        const instrutorNome = checkbox.getAttribute('data-instrutor-nome');
        
        const instrutorAnterior = containerSelecionado.querySelector('.instrutor-item-selecionado');
        if (instrutorAnterior) {
            const idAnterior = instrutorAnterior.getAttribute('data-instrutor-id');
            const checkboxAnterior = document.querySelector('#instrutores-disponiveis-' + disciplinaId + ' .instrutor-checkbox[data-instrutor-id="' + idAnterior + '"]');
            if (checkboxAnterior) {
                checkboxAnterior.checked = false;
            }
            instrutorAnterior.remove();
        }
        
        const msgVazio = containerSelecionado.querySelector('p.text-muted');
        if (msgVazio && msgVazio.textContent.includes('Nenhum instrutor')) {
            msgVazio.remove();
        }
        
        const novoItem = document.createElement('div');
        novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded instrutor-item-selecionado';
        novoItem.setAttribute('data-instrutor-id', instrutorId);
        novoItem.setAttribute('data-instrutor-tipo', instrutorTipo);
        novoItem.innerHTML = '<div>' +
            '<span class="badge bg-' + (instrutorTipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (instrutorTipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>' +
            '<strong>' + instrutorNome + '</strong>' +
            '</div>' +
            '<button type="button" class="btn btn-sm btn-danger" onclick="removerInstrutor(\'' + disciplinaId + '\', \'' + instrutorId + '\', this)">' +
            '<i class="fas fa-times"></i>' +
            '</button>';
        
        containerSelecionado.appendChild(novoItem);
        
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'disciplina_' + disciplinaId + '_instrutor';
        hiddenInput.value = instrutorTipo + '_' + instrutorId;
        containerSelecionado.appendChild(hiddenInput);
        
        const itemDisponivel = checkbox.closest('.instrutor-item');
        if (itemDisponivel) {
            itemDisponivel.remove();
        }
        
        checkbox.checked = false;
    };
    
    window.removerInstrutor = function(disciplinaId, instrutorId, botao) {
        const item = botao.closest('.instrutor-item-selecionado');
        if (item) {
            const instrutorTipo = item.getAttribute('data-instrutor-tipo');
            const instrutorNome = item.querySelector('strong').textContent;
            
            item.remove();
            
            const hiddenInput = document.querySelector('input[name="disciplina_' + disciplinaId + '_instrutor"]');
            if (hiddenInput) {
                hiddenInput.remove();
            }
            
            const containerDisponiveis = document.getElementById('instrutores-disponiveis-' + disciplinaId);
            const novoItem = document.createElement('div');
            novoItem.className = 'form-check instrutor-item';
            novoItem.setAttribute('data-instrutor-id', instrutorId);
            novoItem.setAttribute('data-instrutor-tipo', instrutorTipo);
            novoItem.setAttribute('data-instrutor-nome', instrutorNome.toLowerCase());
            novoItem.innerHTML = '<input class="form-check-input instrutor-checkbox" type="checkbox" value="' + instrutorId + '" ' +
                'data-instrutor-id="' + instrutorId + '" data-instrutor-tipo="' + instrutorTipo + '" data-instrutor-nome="' + instrutorNome + '" ' +
                'id="instr_' + disciplinaId + '_' + instrutorId + '">' +
                '<label class="form-check-label" for="instr_' + disciplinaId + '_' + instrutorId + '">' +
                '<span class="badge bg-' + (instrutorTipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (instrutorTipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>' +
                instrutorNome +
                '</label>';
            containerDisponiveis.appendChild(novoItem);
            
            const containerSelecionado = document.getElementById('instrutor-selecionado-' + disciplinaId);
            if (containerSelecionado.querySelectorAll('.instrutor-item-selecionado').length === 0) {
                containerSelecionado.innerHTML = '<p class="text-muted mb-0">Nenhum instrutor selecionado. Selecione um instrutor à esquerda e clique em "Adicionar Instrutor".</p>';
            }
        }
    };
    
    // Funções para gerenciar monitores
    window.selecionarTodosMonitores = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#monitores-disponiveis-' + disciplinaId + ' .monitor-checkbox');
        checkboxes.forEach(function(checkbox) {
            const item = checkbox.closest('.monitor-item');
            if (item && item.style.display !== 'none') {
                checkbox.checked = true;
            }
        });
    };
    
    window.desmarcarTodosMonitores = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#monitores-disponiveis-' + disciplinaId + ' .monitor-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    };
    
    window.adicionarMonitoresSelecionados = function(disciplinaId) {
        const checkboxes = document.querySelectorAll('#monitores-disponiveis-' + disciplinaId + ' .monitor-checkbox:checked');
        const containerSelecionados = document.getElementById('monitores-selecionados-' + disciplinaId);
        
        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos um monitor.');
            return;
        }
        
        checkboxes.forEach(function(checkbox) {
            const monitorId = checkbox.getAttribute('data-monitor-id');
            const monitorTipo = checkbox.getAttribute('data-monitor-tipo');
            const monitorNome = checkbox.getAttribute('data-monitor-nome');
            
            const jaExiste = containerSelecionados.querySelector('.monitor-item-selecionado[data-monitor-id="' + monitorId + '"]');
            if (jaExiste) {
                return;
            }
            
            const msgVazio = containerSelecionados.querySelector('p.text-muted');
            if (msgVazio && msgVazio.textContent.includes('Nenhum monitor')) {
                msgVazio.remove();
            }
            
            const novoItem = document.createElement('div');
            novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded monitor-item-selecionado';
            novoItem.setAttribute('data-monitor-id', monitorId);
            novoItem.setAttribute('data-monitor-tipo', monitorTipo);
            novoItem.innerHTML = '<div>' +
                '<span class="badge bg-' + (monitorTipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (monitorTipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>' +
                '<strong>' + monitorNome + '</strong>' +
                '</div>' +
                '<button type="button" class="btn btn-sm btn-danger" onclick="removerMonitor(\'' + disciplinaId + '\', \'' + monitorId + '\', this)">' +
                '<i class="fas fa-times"></i>' +
                '</button>';
            
            containerSelecionados.appendChild(novoItem);
            
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'disciplina_' + disciplinaId + '_monitores_' + (monitorTipo === 'MILITAR' ? 'militares' : 'externos') + '[]';
            hiddenInput.value = monitorId;
            containerSelecionados.appendChild(hiddenInput);
            
            const itemDisponivel = checkbox.closest('.monitor-item');
            if (itemDisponivel) {
                itemDisponivel.remove();
            }
            
            checkbox.checked = false;
        });
    };
    
    window.removerMonitor = function(disciplinaId, monitorId, botao) {
        const item = botao.closest('.monitor-item-selecionado');
        if (item) {
            const monitorTipo = item.getAttribute('data-monitor-tipo');
            const monitorNome = item.querySelector('strong').textContent;
            
            item.remove();
            
            const hiddenInput = document.querySelector('input[name="disciplina_' + disciplinaId + '_monitores_' + (monitorTipo === 'MILITAR' ? 'militares' : 'externos') + '[]"][value="' + monitorId + '"]');
            if (hiddenInput) {
                hiddenInput.remove();
            }
            
            const containerDisponiveis = document.getElementById('monitores-disponiveis-' + disciplinaId);
            const novoItem = document.createElement('div');
            novoItem.className = 'form-check monitor-item';
            novoItem.setAttribute('data-monitor-id', monitorId);
            novoItem.setAttribute('data-monitor-tipo', monitorTipo);
            novoItem.setAttribute('data-monitor-nome', monitorNome.toLowerCase());
            novoItem.innerHTML = '<input class="form-check-input monitor-checkbox" type="checkbox" value="' + monitorId + '" ' +
                'data-monitor-id="' + monitorId + '" data-monitor-tipo="' + monitorTipo + '" data-monitor-nome="' + monitorNome + '" ' +
                'id="mon_' + disciplinaId + '_' + monitorId + '">' +
                '<label class="form-check-label" for="mon_' + disciplinaId + '_' + monitorId + '">' +
                '<span class="badge bg-' + (monitorTipo === 'MILITAR' ? 'primary' : 'info') + ' me-1">' + (monitorTipo === 'MILITAR' ? 'Militar' : 'Externo') + '</span>' +
                monitorNome +
                '</label>';
            containerDisponiveis.appendChild(novoItem);
            
            const containerSelecionados = document.getElementById('monitores-selecionados-' + disciplinaId);
            if (containerSelecionados.querySelectorAll('.monitor-item-selecionado').length === 0) {
                containerSelecionados.innerHTML = '<p class="text-muted mb-0">Nenhum monitor selecionado. Selecione monitores à esquerda e clique em "Adicionar à Disciplina".</p>';
            }
        }
    };
    
    function atualizarContadorAlunos() {
        const total = document.querySelectorAll('.aluno-item-turma').length;
        const contador = document.getElementById('total-alunos-turma');
        if (contador) {
            contador.textContent = total;
        }
    }
    
    // Função para carregar alunos já cadastrados na turma (ao editar)
    function carregarAlunosExistentes() {
        {% if turma and alunos_turma %}
        const containerTurma = document.getElementById('alunos-turma');
        const alunosExistentes = [
            {% for aluno in alunos_turma %}
            {
                id: {{ aluno.pk }},
                nome: '{% if aluno.militar %}{{ aluno.militar.nome_completo }}{% elif aluno.nome_outra_forca %}{{ aluno.nome_outra_forca }}{% elif aluno.nome_civil %}{{ aluno.nome_civil }}{% endif %}',
                tipo: '{{ aluno.tipo_aluno }}',
                posto: '{% if aluno.militar %}{{ aluno.militar.get_posto_graduacao_display }}{% elif aluno.posto_outra_forca %}{{ aluno.get_posto_outra_forca_display }}{% endif %}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        if (alunosExistentes.length > 0) {
            // Limpar mensagem de vazio
            const msgVazio = containerTurma.querySelector('p.text-muted');
            if (msgVazio && msgVazio.textContent.includes('Nenhum aluno')) {
                msgVazio.remove();
            }
            
            // Adicionar cada aluno existente
            alunosExistentes.forEach(function(aluno) {
                const jaExiste = containerTurma.querySelector('.aluno-item-turma[data-aluno-id="' + aluno.id + '"]');
                if (!jaExiste) {
                    let badgeHtml = '';
                    if (aluno.tipo === 'BOMBEIRO') {
                        badgeHtml = '<span class="badge bg-primary ms-1">Bombeiro</span>';
                    } else if (aluno.tipo === 'OUTRA_FORCA') {
                        badgeHtml = '<span class="badge bg-info ms-1">Outra Força</span>';
                    } else if (aluno.tipo === 'CIVIL') {
                        badgeHtml = '<span class="badge bg-success ms-1">Civil</span>';
                    }
                    
                    const displayNome = aluno.posto ? aluno.posto + ' ' + aluno.nome : aluno.nome;
                    
                    const novoItem = document.createElement('div');
                    novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded aluno-item-turma';
                    novoItem.setAttribute('data-aluno-id', aluno.id);
                    novoItem.innerHTML = `
                        <div>
                            <strong>${displayNome}</strong> ${badgeHtml}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAlunoTurma(${aluno.id}, this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <input type="hidden" name="alunos_selecionados" value="${aluno.id}">
                    `;
                    containerTurma.appendChild(novoItem);
                }
            });
            
            atualizarContadorAlunos();
        }
        {% endif %}
    }
    
    // Carregar alunos existentes quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', carregarAlunosExistentes);
    } else {
        carregarAlunosExistentes();
    }
})();

// Inicializar Select2 com busca AJAX para campos de supervisor e coordenador
$(document).ready(function() {
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
            }
        });
        
        // Filtrar edições quando curso for selecionado
        const cursoSelect = document.getElementById('id_curso');
        const edicaoSelect = document.getElementById('id_edicao');
        
        if (cursoSelect && edicaoSelect) {
            cursoSelect.addEventListener('change', function() {
                const cursoId = this.value;
                
                if (!cursoId) {
                    edicaoSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                    edicaoSelect.disabled = true;
                    return;
                }
                
                // Buscar edições do curso
                fetch(`{% url 'militares:ensino_edicoes_por_curso_json' curso_id=0 %}`.replace('0', cursoId), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    edicaoSelect.innerHTML = '<option value="">Selecione uma edição...</option>';
                    
                    if (data.edicoes && data.edicoes.length > 0) {
                        edicaoSelect.disabled = false;
                        data.edicoes.forEach(edicao => {
                            const option = document.createElement('option');
                            option.value = edicao.id;
                            option.textContent = edicao.nome;
                            edicaoSelect.appendChild(option);
                        });
                    } else {
                        edicaoSelect.disabled = false;
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Nenhuma edição disponível';
                        edicaoSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar edições:', error);
                    edicaoSelect.innerHTML = '<option value="">Erro ao carregar edições</option>';
                });
            });
        }
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
    }
});
</script>
{% endblock %}

