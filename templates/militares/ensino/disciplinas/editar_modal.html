{% load static %}

<div class="modal-header bg-warning text-dark">
    <h5 class="modal-title" id="editarDisciplinaModalLabel">
        <i class="fas fa-edit me-2"></i>
        Editar Disciplina: {{ disciplina.codigo }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" enctype="multipart/form-data" id="formEditarDisciplina">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Identificação Básica -->
        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Identificação Básica</h5>
        <div class="row">
            <div class="col-md-8 mb-3">
                <label for="{{ form.nome.id_for_label }}" class="form-label">
                    Nome da Disciplina
                </label>
                {{ form.nome }}
                {% if form.nome.errors %}
                    <div class="invalid-feedback d-block">{{ form.nome.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.codigo.id_for_label }}" class="form-label">
                    Código da Disciplina
                    <small class="text-muted">(não editável)</small>
                </label>
                {{ form.codigo }}
                {% if form.codigo.errors %}
                    <div class="invalid-feedback d-block">{{ form.codigo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.categoria.id_for_label }}" class="form-label">
                    Categoria / Área de Conhecimento
                </label>
                {{ form.categoria }}
                {% if form.categoria.errors %}
                    <div class="invalid-feedback d-block">{{ form.categoria.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.descricao_geral.id_for_label }}" class="form-label">
                    Descrição Geral
                </label>
                {{ form.descricao_geral }}
                {% if form.descricao_geral.errors %}
                    <div class="invalid-feedback d-block">{{ form.descricao_geral.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.objetivos.id_for_label }}" class="form-label">
                    Objetivos da Disciplina
                </label>
                {{ form.objetivos }}
                {% if form.objetivos.errors %}
                    <div class="invalid-feedback d-block">{{ form.objetivos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.competencias_desenvolvidas.id_for_label }}" class="form-label">
                    Competências Desenvolvidas
                </label>
                {{ form.competencias_desenvolvidas }}
                {% if form.competencias_desenvolvidas.errors %}
                    <div class="invalid-feedback d-block">{{ form.competencias_desenvolvidas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Carga Horária -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Carga Horária</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.carga_horaria.id_for_label }}" class="form-label">
                    Carga Horária Total (horas)
                </label>
                {{ form.carga_horaria }}
                {% if form.carga_horaria.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.carga_horaria_teorica.id_for_label }}" class="form-label">
                    Carga Horária Teórica (horas)
                </label>
                {{ form.carga_horaria_teorica }}
                {% if form.carga_horaria_teorica.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_teorica.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.carga_horaria_pratica.id_for_label }}" class="form-label">
                    Carga Horária Prática (horas)
                </label>
                {{ form.carga_horaria_pratica }}
                {% if form.carga_horaria_pratica.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_pratica.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.numero_encontros.id_for_label }}" class="form-label">
                    Número de Encontros/Aulas
                </label>
                {{ form.numero_encontros }}
                {% if form.numero_encontros.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_encontros.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.carga_horaria_maxima_dia.id_for_label }}" class="form-label">
                    Carga Horária Máxima Permitida por Dia
                </label>
                {{ form.carga_horaria_maxima_dia }}
                {% if form.carga_horaria_maxima_dia.errors %}
                    <div class="invalid-feedback d-block">{{ form.carga_horaria_maxima_dia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Requisitos -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Requisitos</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.requisitos_matricula.id_for_label }}" class="form-label">
                    Requisitos de Matrícula
                </label>
                {{ form.requisitos_matricula }}
                {% if form.requisitos_matricula.errors %}
                    <div class="invalid-feedback d-block">{{ form.requisitos_matricula.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.materiais_obrigatorios.id_for_label }}" class="form-label">
                    Materiais Obrigatórios
                </label>
                {{ form.materiais_obrigatorios }}
                {% if form.materiais_obrigatorios.errors %}
                    <div class="invalid-feedback d-block">{{ form.materiais_obrigatorios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.requisitos_infraestrutura.id_for_label }}" class="form-label">
                    Requisitos de Infraestrutura
                </label>
                {{ form.requisitos_infraestrutura }}
                {% if form.requisitos_infraestrutura.errors %}
                    <div class="invalid-feedback d-block">{{ form.requisitos_infraestrutura.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Estrutura Didática -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-book-reader me-2"></i>Estrutura Didática</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.ementa.id_for_label }}" class="form-label">
                    Ementa
                </label>
                {{ form.ementa }}
                {% if form.ementa.errors %}
                    <div class="invalid-feedback d-block">{{ form.ementa.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.conteudo_programatico.id_for_label }}" class="form-label">
                    Conteúdo Programático
                </label>
                {{ form.conteudo_programatico }}
                {% if form.conteudo_programatico.errors %}
                    <div class="invalid-feedback d-block">{{ form.conteudo_programatico.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.metodologia_ensino.id_for_label }}" class="form-label">
                    Metodologia de Ensino
                </label>
                {{ form.metodologia_ensino }}
                {% if form.metodologia_ensino.errors %}
                    <div class="invalid-feedback d-block">{{ form.metodologia_ensino.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.cronograma_sugerido.id_for_label }}" class="form-label">
                    Cronograma Sugerido
                </label>
                {{ form.cronograma_sugerido }}
                {% if form.cronograma_sugerido.errors %}
                    <div class="invalid-feedback d-block">{{ form.cronograma_sugerido.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.plano_ensino.id_for_label }}" class="form-label">
                    Plano de Ensino (Upload)
                </label>
                {{ form.plano_ensino }}
                {% if form.plano_ensino.errors %}
                    <div class="invalid-feedback d-block">{{ form.plano_ensino.errors }}</div>
                {% endif %}
                {% if disciplina.plano_ensino %}
                    <small class="form-text text-muted">Arquivo atual: <a href="{{ disciplina.plano_ensino.url }}" target="_blank">{{ disciplina.plano_ensino.name }}</a></small>
                {% endif %}
            </div>
        </div>
        
        <!-- Avaliação -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-clipboard-check me-2"></i>Avaliação</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.metodos_avaliacao.id_for_label }}" class="form-label">
                    Métodos de Avaliação
                </label>
                {{ form.metodos_avaliacao }}
                {% if form.metodos_avaliacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.metodos_avaliacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.criterios_avaliacao.id_for_label }}" class="form-label">
                    Critérios de Avaliação
                </label>
                {{ form.criterios_avaliacao }}
                {% if form.criterios_avaliacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.criterios_avaliacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.media_minima_aprovacao.id_for_label }}" class="form-label">
                    Média Mínima para Aprovação
                </label>
                {{ form.media_minima_aprovacao }}
                {% if form.media_minima_aprovacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.media_minima_aprovacao.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Nota mínima (0-10). Padrão: 7.0</small>
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.media_minima_recuperacao.id_for_label }}" class="form-label">
                    Média Mínima para Recuperação
                </label>
                {{ form.media_minima_recuperacao }}
                {% if form.media_minima_recuperacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.media_minima_recuperacao.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Nota mínima na recuperação (0-10). Padrão: 6.0</small>
            </div>
        </div>
        
        <!-- Frequência -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-calendar-check me-2"></i>Frequência</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.frequencia_minima.id_for_label }}" class="form-label">
                    Frequência Mínima para Aprovação (%)
                </label>
                {{ form.frequencia_minima }}
                {% if form.frequencia_minima.errors %}
                    <div class="invalid-feedback d-block">{{ form.frequencia_minima.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.forma_registro_frequencia.id_for_label }}" class="form-label">
                    Forma de Registro de Frequência
                </label>
                {{ form.forma_registro_frequencia }}
                {% if form.forma_registro_frequencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.forma_registro_frequencia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Administração -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Administração</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.versao.id_for_label }}" class="form-label">
                    Versão da Disciplina
                </label>
                {{ form.versao }}
                {% if form.versao.errors %}
                    <div class="invalid-feedback d-block">{{ form.versao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.ano_vigencia.id_for_label }}" class="form-label">
                    Ano de Vigência
                </label>
                {{ form.ano_vigencia }}
                {% if form.ano_vigencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.ano_vigencia.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.semestre_vigencia.id_for_label }}" class="form-label">
                    Semestre de Vigência
                </label>
                {{ form.semestre_vigencia }}
                {% if form.semestre_vigencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.semestre_vigencia.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <div class="form-check mt-4">
                    {{ form.ativo }}
                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                        Disciplina Ativa
                    </label>
                </div>
                {% if form.ativo.errors %}
                    <div class="invalid-feedback d-block">{{ form.ativo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes_administrativas.id_for_label }}" class="form-label">
                    Observações Administrativas
                </label>
                {{ form.observacoes_administrativas }}
                {% if form.observacoes_administrativas.errors %}
                    <div class="invalid-feedback d-block">{{ form.observacoes_administrativas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.disciplina_substituivel }}
                    <label class="form-check-label" for="{{ form.disciplina_substituivel.id_for_label }}">
                        {{ form.disciplina_substituivel.label }}
                    </label>
                </div>
                {% if form.disciplina_substituivel.errors %}
                    <div class="invalid-feedback d-block">{{ form.disciplina_substituivel.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Materiais e Recursos -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-toolbox me-2"></i>Materiais e Recursos</h5>
        
        <!-- Arquivos Complementares -->
        <div class="mb-3">
            <label class="form-label">
                <i class="fas fa-file-upload me-1"></i>Arquivos Complementares
            </label>
            <div id="arquivos-complementares-container-modal-edit">
                {% if disciplina.pk %}
                    {% for doc in disciplina.documentos.all %}
                        {% if doc.tipo == 'ARQUIVO_COMPLEMENTAR' %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded arquivo-complementar-item" data-doc-id="{{ doc.pk }}">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <strong>{{ doc.titulo }}</strong>
                                {% if doc.descricao %}
                                    <br><small class="text-muted">{{ doc.descricao|truncatewords:10 }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-info me-1" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerArquivoComplementarModal({{ doc.pk }}, this)" title="Remover">
                                    <i class="fas fa-times"></i>
                                </button>
                                <input type="hidden" name="arquivos_complementares_remover[]" value="{{ doc.pk }}">
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            <div id="novos-arquivos-complementares-modal-edit">
                <!-- Campo inicial para novos arquivos -->
                <div class="mb-3 p-3 border rounded" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Título do Arquivo</label>
                            <input type="text" name="arquivos_complementares_titulos[]" class="form-control form-control-sm" placeholder="Ex: Manual de Instruções">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Arquivo</label>
                            <input type="file" name="arquivos_complementares[]" class="form-control form-control-sm" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.mb-3').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <label class="form-label">Descrição (opcional)</label>
                            <textarea name="arquivos_complementares_descricoes[]" class="form-control form-control-sm" rows="2" placeholder="Descrição do arquivo..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-primary" onclick="adicionarCampoArquivoComplementarModalEdit()">
                    <i class="fas fa-plus me-1"></i>Adicionar Arquivo
                </button>
            </div>
        </div>
        
        <!-- Links Úteis -->
        <div class="mb-3">
            <label class="form-label">
                <i class="fas fa-link me-1"></i>Links Úteis
            </label>
            <div id="links-uteis-container-modal-edit">
                {% if disciplina.pk %}
                    {% for link in disciplina.links_uteis.all %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded link-util-item" data-link-id="{{ link.pk }}">
                        <div>
                            <i class="fas fa-external-link-alt me-2"></i>
                            <strong>{{ link.titulo }}</strong>
                            <br><small class="text-muted">{{ link.url }}</small>
                            {% if link.descricao %}
                                <br><small class="text-muted">{{ link.descricao|truncatewords:10 }}</small>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-info me-1" title="Abrir Link">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerLinkUtilModal({{ link.pk }}, this)" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                            <input type="hidden" name="links_uteis_remover[]" value="{{ link.pk }}">
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div id="novos-links-uteis-modal-edit">
                <!-- Campo inicial para novos links -->
                <div class="mb-3 p-3 border rounded" style="display: none;">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Título do Link</label>
                            <input type="text" name="links_uteis_titulos[]" class="form-control form-control-sm" placeholder="Ex: Site Oficial">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">URL</label>
                            <input type="url" name="links_uteis_urls[]" class="form-control form-control-sm" placeholder="https://exemplo.com">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.mb-3').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <label class="form-label">Descrição (opcional)</label>
                            <textarea name="links_uteis_descricoes[]" class="form-control form-control-sm" rows="2" placeholder="Descrição do link..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-primary" onclick="adicionarCampoLinkUtilModalEdit()">
                    <i class="fas fa-plus me-1"></i>Adicionar Link
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.materiais_utilizados.id_for_label }}" class="form-label">
                    Materiais Utilizados em Aula
                </label>
                {{ form.materiais_utilizados }}
                {% if form.materiais_utilizados.errors %}
                    <div class="invalid-feedback d-block">{{ form.materiais_utilizados.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.equipamentos_necessarios.id_for_label }}" class="form-label">
                    Equipamentos Necessários
                </label>
                {{ form.equipamentos_necessarios }}
                {% if form.equipamentos_necessarios.errors %}
                    <div class="invalid-feedback d-block">{{ form.equipamentos_necessarios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Segurança e Procedimentos Operacionais -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-shield-alt me-2"></i>Segurança e Procedimentos Operacionais</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.normas_seguranca.id_for_label }}" class="form-label">
                    Normas de Segurança Aplicáveis
                </label>
                {{ form.normas_seguranca }}
                {% if form.normas_seguranca.errors %}
                    <div class="invalid-feedback d-block">{{ form.normas_seguranca.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.riscos_envolvidos.id_for_label }}" class="form-label">
                    Riscos Envolvidos
                </label>
                {{ form.riscos_envolvidos }}
                {% if form.riscos_envolvidos.errors %}
                    <div class="invalid-feedback d-block">{{ form.riscos_envolvidos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.epis_obrigatorios.id_for_label }}" class="form-label">
                    EPIs Obrigatórios
                </label>
                {{ form.epis_obrigatorios }}
                {% if form.epis_obrigatorios.errors %}
                    <div class="invalid-feedback d-block">{{ form.epis_obrigatorios.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.procedimentos_emergencia.id_for_label }}" class="form-label">
                    Procedimentos em Caso de Incidente/Emergência
                </label>
                {{ form.procedimentos_emergencia }}
                {% if form.procedimentos_emergencia.errors %}
                    <div class="invalid-feedback d-block">{{ form.procedimentos_emergencia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div id="editarDisciplinaErrors" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="editarDisciplinaErrorMessage"></span>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-warning">
            <i class="fas fa-save me-2"></i>Salvar Alterações
        </button>
    </div>
</form>


