{% extends 'base.html' %}
{% load static %}
{% load militar_filters %}
{% load militar_permissions %}
{% load militares_extras %}
{% load permissoes_tags %}

{% block title %}{{ militar.nome_completo }} - Detalhes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Informações do Militar -->
        <div class="col-md-4">
            <div class="card" style="background: linear-gradient(180deg, #e53935 0%, #fff 100%); border-radius: 20px; box-shadow: 0 4px 12px rgba(229,57,53,0.15); position: relative; overflow: hidden; min-height: 520px;">
                <div class="d-flex flex-column align-items-center justify-content-center" style="margin-top: 40px;">
                    <div class="d-flex justify-content-center align-items-center mb-2" style="gap: 18px;">
                        <div style="width: 110px; height: 130px; background: #fff; border: 2px solid #e53935; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                            {% if militar.foto %}
                                <img src="{{ militar.foto.url }}" alt="Foto do Militar" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <span class="text-muted">Sem Foto</span>
                            {% endif %}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <img src="{% static 'logo_cbmepi.png' %}" alt="Brasão CBMEPI" style="width: 110px; height: 110px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.12); background: #fff;">
                        </div>
                    </div>
                </div>
                <div class="card-body pt-2">
                    <div class="row">
                        <div class="col-12 text-center">
                            <h6 class="text-primary mb-1" style="font-size: 1.1rem;">{{ militar.get_posto_graduacao_display }}</h6>
                            <h5 class="fw-bold text-danger mb-1" style="letter-spacing: 1px;">{{ militar.nome_completo }}</h5>
                            <p class="text-muted mb-1" style="font-size: 1.1rem;"><strong>{{ militar.nome_guerra }}</strong></p>
                            <p class="mb-2">
                                <strong>Situação:</strong><br>
                                <span class="badge bg-{% if militar.situacao == 'PRONTO' %}success{% elif 'AFASTAMENTO' in militar.situacao %}warning{% elif 'AGUARDANDO' in militar.situacao %}info{% elif 'DESLIGAMENTO' in militar.situacao or 'LICENCIADO' in militar.situacao %}danger{% else %}secondary{% endif %}" style="font-size: 0.9rem;">{{ militar.get_situacao_display }}</span>
                            </p>
                        </div>
                    </div>
                    <!-- Identificação e Documentos -->
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Matrícula:</strong><br>
                            <span class="text-muted">{{ militar.matricula }}</span>
                        </div>
                        <div class="col-4">
                            <strong>CPF:</strong><br>
                            <span class="text-muted">{{ militar.cpf }}</span>
                        </div>
                        <div class="col-4">
                            <strong>RG:</strong><br>
                            <span class="text-muted">{{ militar.rg }}</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>RGBM:</strong><br>
                            <span class="text-muted">{{ militar.rgbm|default:"Não informado" }}</span>
                        </div>
                        <div class="col-4">
                            <strong>Órgão Expedidor:</strong><br>
                            <span class="text-muted">{{ militar.orgao_expedidor }}</span>
                        </div>
                        <div class="col-4">
                            <strong>Gratificação:</strong><br>
                            <span class="text-muted">
                                {% if militar.gratificacao == 'SIM' %}
                                    <span class="badge bg-success">Sim</span>
                                {% elif militar.gratificacao == 'NAO' %}
                                    <span class="badge bg-secondary">Não</span>
                                {% else %}
                                    <span class="badge bg-warning">Não Informado</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% if militar.etnia or militar.grupo_sanguineo or militar.fator_rh %}
                    <div class="row mb-2">
                        {% if militar.etnia %}
                        <div class="col-4">
                            <strong>Etnia:</strong><br>
                            <span class="text-muted">{{ militar.get_etnia_display }}</span>
                        </div>
                        {% endif %}
                        {% if militar.grupo_sanguineo %}
                        <div class="col-4">
                            <strong>Grupo Sanguíneo:</strong><br>
                            <span class="text-muted">{{ militar.get_grupo_sanguineo_display }}</span>
                        </div>
                        {% endif %}
                        {% if militar.fator_rh %}
                        <div class="col-4">
                            <strong>Fator Rh:</strong><br>
                            <span class="text-muted">{{ militar.get_fator_rh_display }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if militar.altura or militar.peso %}
                    <div class="row mb-2">
                        {% if militar.altura %}
                        <div class="col-4">
                            <strong>Altura:</strong><br>
                            <span class="text-muted">{{ militar.altura }} cm</span>
                        </div>
                        {% endif %}
                        {% if militar.peso %}
                        <div class="col-4">
                            <strong>Peso:</strong><br>
                            <span class="text-muted">{{ militar.peso }} kg</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <!-- Status e Classificação -->
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Quadro:</strong><br>
                            <span class="badge bg-info">{{ militar.get_quadro_display }}</span>
                        </div>
                        {% if militar.classificacao %}
                        <div class="col-4">
                            <strong>Classificação:</strong><br>
                            <span class="badge bg-{% if militar.classificacao == 'ATIVO' %}success{% elif militar.classificacao == 'INATIVO' %}secondary{% elif militar.classificacao == 'FALECIDO' %}danger{% else %}warning{% endif %}">
                                {{ militar.get_classificacao_display }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% if militar.comportamento %}
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Comportamento:</strong><br>
                            <span class="badge bg-{% if militar.comportamento == 'EXCEPCIONAL' or militar.comportamento == 'OTIMO' %}success{% elif militar.comportamento == 'BOM' %}info{% elif militar.comportamento == 'INSUFICIENTE' %}warning{% elif militar.comportamento == 'MAU' %}danger{% else %}secondary{% endif %}">
                                {{ militar.get_comportamento_display }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Dados Pessoais -->
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Sexo:</strong><br>
                            <span class="text-muted">{{ militar.get_sexo_display }}</span>
                        </div>
                        <div class="col-4">
                            <strong>Idade:</strong><br>
                            <span class="text-muted">{{ militar.idade }} anos</span>
                        </div>
                    </div>
                    <!-- Datas -->
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Data de Nascimento:</strong><br>
                            <span class="text-muted">{{ militar.data_nascimento|date:"d/m/Y" }}</span>
                        </div>
                        {% if militar.classificacao != 'INATIVO' and militar.classificacao != 'TRANSFERIDO' and militar.classificacao != 'APOSENTADO' and militar.classificacao != 'EXONERADO' %}
                        <div class="col-4">
                            <strong>Data de Ingresso:</strong><br>
                            <span class="text-muted">{{ militar.data_ingresso|date:"d/m/Y" }}</span>
                        </div>
                        <div class="col-4">
                            <strong>Data de Promoção:</strong><br>
                            <span class="text-muted">{{ militar.data_promocao_atual|date:"d/m/Y" }}</span>
                        </div>
                        {% else %}
                        <div class="col-4">
                            <strong>Data de Transferência para Inativo:</strong><br>
                            {% if data_transferencia_inativo %}
                                <span class="text-muted">{{ data_transferencia_inativo|date:"d/m/Y" }}</span>
                            {% else %}
                                <span class="text-muted">Não informada</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <!-- Antiguidade e Tempo -->
                    <div class="row mb-2">
                        {% if militar.classificacao != 'INATIVO' and militar.classificacao != 'TRANSFERIDO' and militar.classificacao != 'APOSENTADO' and militar.classificacao != 'EXONERADO' and militar.quadro != 'NVRR' and militar.posto_graduacao != 'NVRR' %}
                        <div class="col-4">
                            <strong>Numeração de Antiguidade:</strong><br>
                            {% if militar.numeracao_antiguidade %}
                                <span class="badge bg-warning">{{ militar.numeracao_antiguidade }}º</span>
                            {% else %}
                                <span class="text-muted">Não informada</span>
                            {% endif %}
                        </div>
                        <div class="col-8">
                            <strong>Tempo de Serviço:</strong><br>
                        {% else %}
                        <div class="col-12">
                            <strong>Tempo de Serviço:</strong><br>
                        {% endif %}
                            <span class="text-muted">
                                {% if militar.data_ingresso %}
                                    {% if militar.classificacao == 'INATIVO' or militar.classificacao == 'TRANSFERIDO' or militar.classificacao == 'APOSENTADO' or militar.classificacao == 'EXONERADO' %}
                                        {# Se está inativo, mostrar apenas o tempo acumulado antes da transferência #}
                                        {% if militar.data_ultima_inativacao %}
                                            {# Tem data de inativação - mostrar tempo acumulado até essa data #}
                                            <div>
                                                <strong>Período Ativo (até {{ militar.data_ultima_inativacao|date:"d/m/Y" }}):</strong><br>
                                                {{ militar.tempo_servico_periodo_anterior.years }} ano{{ militar.tempo_servico_periodo_anterior.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.months }} mês{{ militar.tempo_servico_periodo_anterior.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.days }} dia{{ militar.tempo_servico_periodo_anterior.days|pluralize:"s" }}
                                            </div>
                                        {% elif militar.tempo_servico_acumulado_dias %}
                                            {# Tem tempo acumulado mas não tem data de inativação (caso antigo) #}
                                            <div>
                                                <strong>Período Ativo:</strong><br>
                                                {{ militar.tempo_servico_periodo_anterior.years }} ano{{ militar.tempo_servico_periodo_anterior.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.months }} mês{{ militar.tempo_servico_periodo_anterior.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.days }} dia{{ militar.tempo_servico_periodo_anterior.days|pluralize:"s" }}
                                            </div>
                                        {% else %}
                                            {# Não tem dados de inativação - calcular desde ingresso até hoje (para militares inativados antes da implementação) #}
                                            <div>
                                                <strong>Período Ativo:</strong><br>
                                                {{ militar.tempo_servico_detalhado.years }} ano{{ militar.tempo_servico_detalhado.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_detalhado.months }} mês{{ militar.tempo_servico_detalhado.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_detalhado.days }} dia{{ militar.tempo_servico_detalhado.days|pluralize:"s" }}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {# Se está ativo, verificar se foi reativado #}
                                        {% if militar.data_ultima_reativacao %}
                                            {# Foi reativado - mostrar ambos os períodos #}
                                            {% if militar.data_ultima_inativacao %}
                                            <div class="mb-2">
                                                <strong>Período Anterior (até {{ militar.data_ultima_inativacao|date:"d/m/Y" }}):</strong><br>
                                                {{ militar.tempo_servico_periodo_anterior.years }} ano{{ militar.tempo_servico_periodo_anterior.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.months }} mês{{ militar.tempo_servico_periodo_anterior.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.days }} dia{{ militar.tempo_servico_periodo_anterior.days|pluralize:"s" }}
                                            </div>
                                            {% else %}
                                            <div class="mb-2">
                                                <strong>Período Anterior:</strong><br>
                                                {{ militar.tempo_servico_periodo_anterior.years }} ano{{ militar.tempo_servico_periodo_anterior.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.months }} mês{{ militar.tempo_servico_periodo_anterior.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_periodo_anterior.days }} dia{{ militar.tempo_servico_periodo_anterior.days|pluralize:"s" }}
                                            </div>
                                            {% endif %}
                                            <div class="mb-2">
                                                <strong>Período Atual (desde {{ militar.data_ultima_reativacao|date:"d/m/Y" }}):</strong><br>
                                                {{ militar.tempo_servico_periodo_atual.years }} ano{{ militar.tempo_servico_periodo_atual.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_periodo_atual.months }} mês{{ militar.tempo_servico_periodo_atual.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_periodo_atual.days }} dia{{ militar.tempo_servico_periodo_atual.days|pluralize:"s" }}
                                            </div>
                                            <div class="mt-2 pt-2 border-top">
                                                <strong>Total:</strong> 
                                                {{ militar.tempo_servico_detalhado.years }} ano{{ militar.tempo_servico_detalhado.years|pluralize:"s" }}, 
                                                {{ militar.tempo_servico_detalhado.months }} mês{{ militar.tempo_servico_detalhado.months|pluralize:"es" }}, 
                                                {{ militar.tempo_servico_detalhado.days }} dia{{ militar.tempo_servico_detalhado.days|pluralize:"s" }}
                                            </div>
                                        {% else %}
                                            {# Nunca foi inativado - mostrar tempo normal #}
                                            {{ militar.tempo_servico_detalhado.years }} ano{{ militar.tempo_servico_detalhado.years|pluralize:"s" }}, 
                                            {{ militar.tempo_servico_detalhado.months }} mês{{ militar.tempo_servico_detalhado.months|pluralize:"es" }}, 
                                            {{ militar.tempo_servico_detalhado.days }} dia{{ militar.tempo_servico_detalhado.days|pluralize:"s" }}
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    Não informado
                                {% endif %}
                            </span>
                            {% if militar.data_ingresso and pode_crud_pdf %}
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalCertidaoTempoServico">
                                    <i class="fas fa-file-pdf me-1"></i>Gerar Certidão de Tempo de Serviço (PDF)
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if militar.classificacao != 'INATIVO' and militar.classificacao != 'TRANSFERIDO' and militar.classificacao != 'APOSENTADO' and militar.classificacao != 'EXONERADO' %}
                    <div class="row mb-2">
                        <div class="{% if militar.quadro == 'NVRR' or militar.posto_graduacao == 'NVRR' or militar.posto_graduacao == 'CB' %}col-12{% else %}col-4{% endif %}">
                            <strong>Tempo no Posto:</strong><br>
                            <span class="text-muted">{{ militar.tempo_posto_atual_detalhado.years }} anos, {{ militar.tempo_posto_atual_detalhado.months }} meses, {{ militar.tempo_posto_atual_detalhado.days }} dias</span>
                        </div>
                        {% if militar.quadro != 'NVRR' and militar.posto_graduacao != 'NVRR' and militar.posto_graduacao != 'CB' %}
                        <div class="col-4">
                            <strong>Interstício Mínimo:</strong><br>
                            <span class="text-muted">{{ militar.intersticio_formatado }}</span>
                        </div>
                        <div class="col-4">
                            <strong>Apto Interstício:</strong><br>
                            <span class="badge bg-{% if militar.apto_intersticio %}success{% else %}warning{% endif %}">{% if militar.apto_intersticio %}Apto{% else %}Não Apto{% endif %}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% if militar.quadro != 'NVRR' and militar.posto_graduacao != 'NVRR' and militar.posto_graduacao != 'CB' %}
                    <div class="row mb-2">
                        <div class="col-4">
                            <strong>Apto Promoção:</strong><br>
                            <span class="badge bg-{% if militar.apto_promocao_antiguidade %}success{% else %}warning{% endif %}">{% if militar.apto_promocao_antiguidade %}Apto{% else %}Não Apto{% endif %}</span>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <div class="row mb-2">
                        <div class="col-12 text-center">
                            <a href="{% url 'militares:qualificacoes_militar' militar.id %}" class="btn btn-success btn-lg">
                                <i class="fas fa-graduation-cap me-2"></i>Ver Qualificações
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informações de Contato -->
            {% if militar.user == user or permissoes_detalhes.detail_contato %}
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-address-book me-2 text-info"></i>Contato
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-envelope me-2 text-muted"></i>
                                <strong>E-mail:</strong><br>
                                <span class="text-muted">{{ militar.email|default:"Não informado" }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-phone me-2 text-muted"></i>
                                <strong>Telefone:</strong><br>
                                <span class="text-muted">{{ militar.telefone|default:"Não informado" }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-0">
                                <i class="fas fa-mobile-alt me-2 text-muted"></i>
                                <strong>Celular:</strong><br>
                                <span class="text-muted">{{ militar.celular|default:"Não informado" }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Medalhas Concedidas -->
            {% if militar.user == user or permissoes_detalhes.detail_medalhas %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-medal me-2 text-warning"></i>Medalhas Concedidas
                    </h6>
                </div>
                <div class="card-body">
                    {% if militar.medalhas_recebidas.all %}
                        <div class="row">
                            {% for concessao in militar.medalhas_recebidas.all|dictsort:"medalha.codigo" %}
                                <div class="col-12 mb-2">
                                    <div class="d-flex align-items-center p-2 border rounded" style="background-color: #f8f9fa;">
                                        <div class="me-3">
                                            {% if concessao.medalha.codigo == 'IDPII' %}
                                                <i class="fas fa-crown fa-2x text-primary"></i>
                                            {% elif concessao.medalha.codigo == 'TS_30' %}
                                                <i class="fas fa-medal fa-2x text-warning"></i>
                                            {% elif concessao.medalha.codigo == 'TS_20' %}
                                                <i class="fas fa-medal fa-2x text-secondary"></i>
                                            {% elif concessao.medalha.codigo == 'TS_10' %}
                                                <i class="fas fa-medal fa-2x" style="color: #CD7F32;"></i>
                                            {% else %}
                                                <i class="fas fa-medal fa-2x text-info"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ concessao.medalha.nome }}</h6>
                                            <small class="text-muted">
                                                Concedida em {{ concessao.data_concessao|date:"d/m/Y" }}
                                                {% if concessao.documento_tipo %}
                                                    <br>Documento: {{ concessao.get_documento_tipo_display }} {{ concessao.portaria_numero }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="ms-2">
                                            <span class="badge bg-success">✅ Concedida</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-medal fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-0">Nenhuma medalha concedida ainda</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-8">
            <!-- Cabeçalho com botão de editar -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>{{ militar.nome_completo }}
                        </h4>
                        {% if menu_permissions.MILITARES_EDITAR and pode_crud_pdf %}
                        <div class="btn-group" role="group">
                            <a href="{% url 'militares:militar_edit' militar.pk %}" class="btn btn-light" title="Editar Militar">
                                <i class="fas fa-edit me-1"></i>Editar
                            </a>
                            {% if menu_permissions.MILITARES_TRANSFERIR %}
                            <a href="{% url 'militares:militar_transferir_inativo' militar.pk %}" class="btn btn-warning" title="Transferir para Inativo">
                                <i class="fas fa-user-times me-1"></i>Transferir
                            </a>
                            {% endif %}
                            <a href="{% url 'militares:militar_list' %}" class="btn btn-outline-light" title="Voltar para Lista">
                                <i class="fas fa-arrow-left me-1"></i>Voltar
                            </a>
                        </div>
                        {% elif not pode_crud_pdf %}
                        <div class="btn-group" role="group">
                            <a href="{% url 'militares:militar_list' %}" class="btn btn-outline-light" title="Voltar para Lista">
                                <i class="fas fa-arrow-left me-1"></i>Voltar
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Acordeão Principal -->
            <div class="accordion" id="militarAccordion">
            
            <!-- Fichas de Conceito -->
            {% if militar.user == user or menu_permissions.DETAIL_FICHAS_CONCEITO %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="fichasConceitoHeader">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#fichasConceito" aria-expanded="true" aria-controls="fichasConceito">
                        <i class="fas fa-clipboard-list me-2"></i>Fichas de Conceito
                        {% if ficha_conceito %}
                        <span class="badge bg-primary ms-2">{{ ficha_conceito|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="fichasConceito" class="accordion-collapse collapse show" aria-labelledby="fichasConceitoHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                    {% if ficha_conceito %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Data Registro</th>
                                        <th>Tempo no Posto</th>
                                        <th>Pontos</th>
                                        <th>Observações</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ficha in ficha_conceito %}
                                    <tr>
                                        <td>{{ ficha.data_registro|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ ficha.tempo_posto_extenso }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ ficha.pontos }} pontos</span>
                                        </td>
                                        <td>
                                            {% if ficha.observacoes %}
                                                <small class="text-muted">{{ ficha.observacoes|truncatechars:50 }}</small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                {% if menu_permissions.is_consultor %}
                                                    {% if user.militar.fichaconceitooficiais_set.exists %}
                                                        <a href="{% url 'militares:ficha_conceito_detail' user.militar.fichaconceitooficiais_set.first.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    {% elif user.militar.fichaconceitopracas_set.exists %}
                                                        <a href="{% url 'militares:ficha_conceito_pracas_detail' user.militar.fichaconceitopracas_set.first.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    {% else %}
                                                        <a href="{% url 'militares:militar_detail' user.militar.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    {% endif %}
                                                {% else %}
                                                    <a href="{% url 'militares:ficha_conceito_detail' ficha.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_FICHA_CONCEITO and pode_crud_pdf %}
                                                <a href="{% url 'militares:ficha_conceito_edit' ficha.pk %}" class="btn btn-outline-primary" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_EDITAR and pode_crud_pdf %}
                                                <a href="{% url 'militares:documento_upload' ficha.pk %}" class="btn btn-outline-secondary" title="Upload Documento">
                                                    <i class="fas fa-upload"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clipboard fa-3x mb-3"></i>
                            <p>Nenhuma ficha de conceito registrada.</p>
                            {% if menu_permissions.MILITARES_FICHA_CONCEITO and pode_crud_pdf %}
                            <a href="{% url 'militares:ficha_conceito_create' %}" class="btn btn-primary">
                                Nova Ficha de Conceito
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Promoções -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="promocoesHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#promocoes" aria-expanded="false" aria-controls="promocoes">
                            <i class="fas fa-arrow-up me-2 text-success"></i>Histórico de Promoções
                        {% if promocoes %}
                        <span class="badge bg-success ms-2">{{ promocoes|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="promocoes" class="accordion-collapse collapse" aria-labelledby="promocoesHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-3">
                        {% if promocoes and pode_crud_pdf %}
                            <a href="{% url 'militares:militar_promocoes_pdf' militar.pk %}" class="btn btn-outline-primary btn-sm" title="Visualizar Histórico de Promoções de {{ militar.nome_guerra }} em Nova Guia" target="_blank">
                                <i class="fas fa-file-pdf me-1"></i>PDF
                            </a>
                        {% endif %}
                    </div>
                    {% if promocoes %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-success">
                                    <tr>
                                        <th><i class="fas fa-calendar me-1"></i>Data</th>
                                        <th><i class="fas fa-arrow-left me-1"></i>Posto Anterior</th>
                                        <th><i class="fas fa-arrow-right me-1"></i>Novo Posto</th>
                                        <th><i class="fas fa-star me-1"></i>Critério</th>
                                        <th><i class="fas fa-file-alt me-1"></i>Ato</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for promocao in promocoes|slice:":5" %}
                                    <tr class="table-success">
                                        <td>
                                            <span class="badge bg-success">
                                                {{ promocao.data_promocao|date:"d/m/Y" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-secondary">
                                                    {{ promocao.get_posto_anterior_display }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-success">
                                                    {{ promocao.get_posto_novo_display }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-info">
                                                    {{ promocao.get_criterio_display }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="fas fa-file-alt me-1"></i>{{ promocao.numero_ato }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if promocoes|length > 5 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Mostrando 5 de {{ promocoes|length }} promoção(ões) mais recentes
                            </small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-arrow-up fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhuma promoção registrada</p>
                            <small>O histórico de promoções do militar será exibido aqui</small>
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Férias -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="feriasHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ferias" aria-expanded="false" aria-controls="ferias">
                        <i class="fas fa-umbrella-beach me-2 text-info"></i>Histórico de Férias
                        {% if ferias %}
                        <span class="badge bg-info ms-2">{{ ferias|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="ferias" class="accordion-collapse collapse" aria-labelledby="feriasHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between mb-3">
                            {% if pode_crud_pdf %}
                            <div>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalCertidaoFerias">
                                    <i class="fas fa-file-pdf me-1"></i>Gerar Certidão de Férias (PDF)
                                </button>
                            </div>
                            <div>
                                <a href="{% url 'militares:ferias_create_militar' militar.pk %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i>Cadastrar Férias
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Modal para Gerar Certidão de Férias -->
                        <div class="modal fade" id="modalCertidaoFerias" tabindex="-1" aria-labelledby="modalCertidaoFeriasLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="formCertidaoFerias" method="get" action="{% url 'militares:ferias_certidao_pdf' militar.pk %}" target="_blank">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalCertidaoFeriasLabel">
                                                <i class="fas fa-file-pdf me-2"></i>Gerar Certidão de Férias
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p class="mb-3">Selecione a função que será exibida na assinatura do documento:</p>
                                            
                                            <div class="mb-3">
                                                <label for="funcao_assinatura_certidao" class="form-label"><strong>Função para Assinatura *</strong></label>
                                                <select class="form-select" id="funcao_assinatura_certidao" name="funcao" required>
                                                    <option value="">Selecione uma função...</option>
                                                    {% for funcao in funcoes_usuario %}
                                                        <option value="{{ funcao.funcao_militar.nome }}" {% if funcao_atual and funcao.funcao_militar.nome == funcao_atual.funcao_militar.nome %}selected{% endif %}>
                                                            {{ funcao.funcao_militar.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Selecione a função que será exibida na assinatura do documento.</div>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Atenção:</strong> O documento será gerado com a assinatura eletrônica e espaço para assinatura física.
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-danger" id="btnGerarCertidaoFerias">
                                                <i class="fas fa-file-pdf me-1"></i>Gerar PDF
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        {% if ferias %}
                            {% regroup ferias by ano_referencia as ferias_por_ano %}
                            {% for grupo_ano in ferias_por_ano %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>Ano {{ grupo_ano.grouper }}
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-info">
                                            <tr>
                                                <th><i class="fas fa-calendar me-1"></i>Período</th>
                                                <th><i class="fas fa-calendar-day me-1"></i>Tipo</th>
                                                <th><i class="fas fa-clock me-1"></i>Duração</th>
                                                <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                                <th><i class="fas fa-file-alt me-1"></i>Documento</th>
                                                <th><i class="fas fa-cog me-1"></i>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ferias_item in grupo_ano.list %}
                                            {% comment %}Verificar se foi reprogramada{% endcomment %}
                                            {% if ferias_item.foi_reprogramada %}
                                            <tr class="table-secondary" style="opacity: 0.8;">
                                                <td>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <small>
                                                            <strong>{{ ferias_item.data_inicio|date:"d/m/Y" }}</strong> a 
                                                            <strong>{{ ferias_item.data_fim|date:"d/m/Y" }}</strong>
                                                        </small>
                                                        <span class="badge bg-warning text-dark" title="Esta férias foi reprogramada">
                                                            <i class="fas fa-redo me-1"></i>Reprogramada
                                                        </span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        {{ ferias_item.get_tipo_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        {{ ferias_item.quantidade_dias }} dia{{ ferias_item.quantidade_dias|pluralize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ ferias_item.get_status_display }}</span>
                                                </td>
                                                <td>
                                                    {% if ferias_item.documento_referencia or ferias_item.numero_documento %}
                                                        <small>
                                                            {% if ferias_item.documento_referencia %}
                                                                <strong>{{ ferias_item.documento_referencia }}</strong>
                                                            {% endif %}
                                                            {% if ferias_item.numero_documento %}
                                                                {% if ferias_item.documento_referencia %}<br>{% endif %}{{ ferias_item.numero_documento }}
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        {% if pode_crud_pdf %}
                                                        <a href="{% url 'militares:ferias_detail' ferias_item.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td>
                                                    <small>
                                                        <strong>{{ ferias_item.data_inicio|date:"d/m/Y" }}</strong> a 
                                                        <strong>{{ ferias_item.data_fim|date:"d/m/Y" }}</strong>
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        {{ ferias_item.get_tipo_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        {{ ferias_item.quantidade_dias }} dia{{ ferias_item.quantidade_dias|pluralize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if ferias_item.status == 'PLANEJADA' %}
                                                        <span class="badge bg-info">{{ ferias_item.get_status_display }}</span>
                                                    {% elif ferias_item.status == 'GOZANDO' %}
                                                        <span class="badge bg-warning text-dark">{{ ferias_item.get_status_display }}</span>
                                                    {% elif ferias_item.status == 'GOZADA' %}
                                                        <span class="badge bg-success">{{ ferias_item.get_status_display }}</span>
                                                    {% elif ferias_item.status == 'CANCELADA' %}
                                                        <span class="badge bg-danger">{{ ferias_item.get_status_display }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ ferias_item.get_status_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if ferias_item.documento_referencia or ferias_item.numero_documento %}
                                                        <small>
                                                            {% if ferias_item.documento_referencia %}
                                                                <strong>{{ ferias_item.documento_referencia }}</strong>
                                                            {% endif %}
                                                            {% if ferias_item.numero_documento %}
                                                                {% if ferias_item.documento_referencia %}<br>{% endif %}{{ ferias_item.numero_documento }}
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        {% if pode_crud_pdf %}
                                                        <a href="{% url 'militares:ferias_detail' ferias_item.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% endif %}
                                                        {% if pode_crud_pdf %}
                                                            {% if not ferias_item.plano %}
                                                            <a href="{% url 'militares:ferias_update' ferias_item.pk %}" class="btn btn-outline-primary" title="Editar Férias">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            {% elif ferias_item.plano.status != 'APROVADO' and ferias_item.plano.status != 'PUBLICADO' %}
                                                            <a href="{% url 'militares:ferias_update' ferias_item.pk %}" class="btn btn-outline-primary" title="Editar Férias">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% if not forloop.last %}
                            <hr class="my-4">
                            {% endif %}
                            {% empty %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-umbrella-beach fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma férias registrada</p>
                                <small>O histórico de férias do militar será exibido aqui</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-umbrella-beach fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma férias registrada</p>
                                <small>O histórico de férias do militar será exibido aqui</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Lotação -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="lotacaoHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lotacao" aria-expanded="false" aria-controls="lotacao">
                        <i class="fas fa-building me-2 text-primary"></i>Histórico de Lotações
                        {% if lotacoes %}
                        <span class="badge bg-primary ms-2">{{ lotacoes|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="lotacao" class="accordion-collapse collapse" aria-labelledby="lotacaoHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-3">
                    {% if menu_permissions.LOTACOES_CRIAR %}
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'militares:lotacao_create' %}?militar={{ militar.pk }}" class="btn btn-primary btn-sm" title="Nova Lotação">
                            <i class="fas fa-plus me-1"></i>Nova
                        </a>
                        {% if pode_crud_pdf %}
                        <a href="{% url 'militares:lotacao_militar_list' militar.pk %}" class="btn btn-outline-primary btn-sm" title="Ver Todas as Lotações">
                            <i class="fas fa-list me-1"></i>Ver Todas
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                    {% if lotacoes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="fw-bold text-primary">Lotação</th>
                                        <th class="fw-bold text-primary">Status</th>
                                        <th class="fw-bold text-primary">Período</th>
                                        <th class="fw-bold text-primary">Duração</th>
                                        {% if not menu_permissions.is_consultor %}
                                        <th class="fw-bold text-primary">Ações</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lotacao in lotacoes %}
                                    <tr class="{% if lotacao.status == 'ATUAL' %}table-success{% elif lotacao.status == 'ANTERIOR' %}table-light{% endif %}">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="text-primary">{{ lotacao.lotacao }}</strong>
                                                {% if lotacao.observacoes %}
                                                    <small class="text-muted">{{ lotacao.observacoes|truncatechars:50 }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                {% if lotacao.status == 'ATUAL' %}
                                                    <span class="badge bg-success mb-1">{{ lotacao.status_display }}</span>
                                                {% elif lotacao.status == 'ANTERIOR' %}
                                                    <span class="badge bg-secondary mb-1">{{ lotacao.status_display }}</span>
                                                {% elif lotacao.status == 'TEMPORARIA' %}
                                                    <span class="badge bg-warning text-dark mb-1">{{ lotacao.status_display }}</span>
                                                {% elif lotacao.status == 'COMANDO' %}
                                                    <span class="badge bg-danger mb-1">{{ lotacao.status_display }}</span>
                                                {% elif lotacao.status == 'AFASTAMENTO' %}
                                                    <span class="badge bg-dark mb-1">{{ lotacao.status_display }}</span>
                                                {% endif %}
                                                <small class="text-muted">
                                                    {% if lotacao.status == 'ATUAL' %}
                                                        <i class="fas fa-clock me-1"></i>Em andamento
                                                    {% else %}
                                                        <i class="fas fa-calendar-check me-1"></i>Finalizada
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold">{{ lotacao.data_inicio|date:"d/m/Y" }}</span>
                                                <small class="text-muted">Data de início</small>
                                                {% if lotacao.data_fim %}
                                                    <span class="fw-bold text-success mt-1">{{ lotacao.data_fim|date:"d/m/Y" }}</span>
                                                    <small class="text-muted">Data de fim</small>
                                                {% else %}
                                                    <span class="fw-bold text-success mt-1">Atual</span>
                                                    <small class="text-muted">Lotação em andamento</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold text-primary">{{ lotacao.duracao_formatada }}</span>
                                                <small class="text-muted">
                                                    {% if lotacao.status == 'ATUAL' %}
                                                        <i class="fas fa-hourglass-half me-1"></i>Tempo atual
                                                    {% else %}
                                                        <i class="fas fa-history me-1"></i>Tempo total
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </td>
                                        {% if menu_permissions.LOTACOES_EDITAR or menu_permissions.LOTACOES_EXCLUIR %}
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:lotacao_detail' lotacao.pk %}" class="btn btn-outline-info btn-sm" title="Visualizar Detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.LOTACOES_EDITAR and pode_crud_pdf %}
                                                <a href="{% url 'militares:lotacao_update' lotacao.pk %}" class="btn btn-outline-primary btn-sm" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.LOTACOES_EXCLUIR and pode_crud_pdf %}
                                                <a href="{% url 'militares:lotacao_delete' lotacao.pk %}" class="btn btn-outline-danger btn-sm" title="Excluir" 
                                                   onclick="return confirm('Tem certeza que deseja excluir esta lotação?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Exibindo {{ lotacoes|length }} lotação(ões) do militar
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-building fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhuma lotação cadastrada</p>
                            <small>As informações de lotação serão exibidas aqui quando cadastradas</small>
                            {% if menu_permissions.LOTACOES_CRIAR %}
                            <div class="mt-3">
                                <a href="{% url 'militares:lotacao_create' %}?militar={{ militar.pk }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Cadastrar Primeira Lotação
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Modal para Gerar Certidão de Tempo de Serviço -->
            <div class="modal fade" id="modalCertidaoTempoServico" tabindex="-1" aria-labelledby="modalCertidaoTempoServicoLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="formCertidaoTempoServico" method="get" action="{% url 'militares:tempo_servico_certidao_pdf' militar.pk %}" target="_blank">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalCertidaoTempoServicoLabel">
                                    <i class="fas fa-file-pdf me-2"></i>Gerar Certidão de Tempo de Serviço
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Selecione a função que será exibida na assinatura do documento:</p>
                                
                                <div class="mb-3">
                                    <label for="funcao_assinatura_certidao_tempo_servico" class="form-label"><strong>Função para Assinatura *</strong></label>
                                    <select class="form-select" id="funcao_assinatura_certidao_tempo_servico" name="funcao" required>
                                        <option value="">Selecione uma função...</option>
                                        {% for funcao in funcoes_usuario %}
                                            <option value="{{ funcao.funcao_militar.nome }}" {% if funcao_atual and funcao.funcao_militar.nome == funcao_atual.funcao_militar.nome %}selected{% endif %}>
                                                {{ funcao.funcao_militar.nome }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Selecione a função que será exibida na assinatura do documento.</div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Atenção:</strong> O documento será gerado com a assinatura eletrônica e espaço para assinatura física.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                                <button type="submit" class="btn btn-danger" id="btnGerarCertidaoTempoServico">
                                    <i class="fas fa-file-pdf me-1"></i>Gerar PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Licenças Especiais -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="licencasEspeciaisHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#licencasEspeciais" aria-expanded="false" aria-controls="licencasEspeciais">
                        <i class="fas fa-certificate me-2 text-info"></i>Licenças Especiais
                        {% if licencas_especiais %}
                        <span class="badge bg-info ms-2">{{ licencas_especiais|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="licencasEspeciais" class="accordion-collapse collapse" aria-labelledby="licencasEspeciaisHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        {% if pode_crud_pdf %}
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            {% if licencas_especiais %}
                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalCertidaoLicencaEspecial">
                                <i class="fas fa-file-pdf me-1"></i>Gerar Certidão de Licenças Especiais (PDF)
                            </button>
                            {% endif %}
                            <a href="{% url 'militares:licenca_especial_create' %}?militar={{ militar.pk }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-1"></i>Cadastrar Licença Especial
                            </a>
                        </div>
                        {% endif %}
                        
                        <!-- Modal para Gerar Certidão de Licenças Especiais -->
                        <div class="modal fade" id="modalCertidaoLicencaEspecial" tabindex="-1" aria-labelledby="modalCertidaoLicencaEspecialLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="formCertidaoLicencaEspecial" method="get" action="{% url 'militares:licenca_especial_certidao_pdf' militar.pk %}" target="_blank">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalCertidaoLicencaEspecialLabel">
                                                <i class="fas fa-file-pdf me-2"></i>Gerar Certidão de Licenças Especiais
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p class="mb-3">Selecione a função que será exibida na assinatura do documento:</p>
                                            
                                            <div class="mb-3">
                                                <label for="funcao_assinatura_certidao_licenca" class="form-label"><strong>Função para Assinatura *</strong></label>
                                                <select class="form-select" id="funcao_assinatura_certidao_licenca" name="funcao" required>
                                                    <option value="">Selecione uma função...</option>
                                                    {% for funcao in funcoes_usuario %}
                                                        <option value="{{ funcao.funcao_militar.nome }}" {% if funcao_atual and funcao.funcao_militar.nome == funcao_atual.funcao_militar.nome %}selected{% endif %}>
                                                            {{ funcao.funcao_militar.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Selecione a função que será exibida na assinatura do documento.</div>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Atenção:</strong> O documento será gerado com a assinatura eletrônica e espaço para assinatura física.
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-danger" id="btnGerarCertidaoLicencaEspecial">
                                                <i class="fas fa-file-pdf me-1"></i>Gerar PDF
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% comment %}DEBUG: licencas_especiais existe? {{ licencas_especiais|yesno:"SIM,NÃO" }}, total: {{ licencas_especiais|length|default:0 }}{% endcomment %}
                        {% if licencas_especiais %}
                            {% regroup licencas_especiais by plano as licencas_por_plano %}
                            {% for grupo_plano in licencas_por_plano %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    {% if grupo_plano.grouper %}
                                        {{ grupo_plano.grouper.titulo }} ({{ grupo_plano.grouper.ano_plano }})
                                    {% else %}
                                        Licenças Sem Plano
                                    {% endif %}
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-info">
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i>Decênio</th>
                                                <th><i class="fas fa-calendar-check me-1"></i>Período do Decênio</th>
                                                <th><i class="fas fa-calendar me-1"></i>Período da Licença</th>
                                                <th><i class="fas fa-clock me-1"></i>Duração</th>
                                                <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                                <th><i class="fas fa-file-alt me-1"></i>Documento</th>
                                                <th><i class="fas fa-cog me-1"></i>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for licenca in grupo_plano.list %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        {{ licenca.decenio }}º Decênio
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if licenca.periodo_decenio != "-" %}
                                                    <small>
                                                        <strong>{{ licenca.periodo_decenio }}</strong>
                                                    </small>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <small>
                                                        <strong>{{ licenca.data_inicio|date:"d/m/Y" }}</strong> a 
                                                        <strong>{{ licenca.data_fim|date:"d/m/Y"|default:"-" }}</strong>
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        {{ licenca.quantidade_meses }} mês{{ licenca.quantidade_meses|pluralize:"es" }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if licenca.status == 'PLANEJADA' %}
                                                        <span class="badge bg-info">{{ licenca.get_status_display }}</span>
                                                    {% elif licenca.status == 'GOZANDO' %}
                                                        <span class="badge bg-warning text-dark">{{ licenca.get_status_display }}</span>
                                                    {% elif licenca.status == 'GOZADA' %}
                                                        <span class="badge bg-success">{{ licenca.get_status_display }}</span>
                                                    {% elif licenca.status == 'CANCELADA' %}
                                                        <span class="badge bg-danger">{{ licenca.get_status_display }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ licenca.get_status_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if licenca.documento_referencia or licenca.numero_documento %}
                                                        <small>
                                                            {% if licenca.documento_referencia %}
                                                                <strong>{{ licenca.documento_referencia }}</strong>
                                                            {% endif %}
                                                            {% if licenca.numero_documento %}
                                                                {% if licenca.documento_referencia %}<br>{% endif %}{{ licenca.numero_documento }}
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        {% if pode_crud_pdf %}
                                                        <a href="{% url 'militares:licenca_especial_detail' licenca.pk %}" class="btn btn-outline-info" title="Visualizar Detalhes">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% endif %}
                                                        {% if pode_crud_pdf and menu_permissions.BOTAO_LICENCA_ESPECIAL_EDITAR or pode_crud_pdf and user.is_superuser %}
                                                        {% if not licenca.plano %}
                                                        <a href="{% url 'militares:licenca_especial_update' licenca.pk %}" class="btn btn-outline-primary" title="Editar Licença">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        {% elif licenca.plano.status != 'APROVADO' and licenca.plano.status != 'PUBLICADO' %}
                                                        <a href="{% url 'militares:licenca_especial_update' licenca.pk %}" class="btn btn-outline-primary" title="Editar Licença">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% if not forloop.last %}
                            <hr class="my-4">
                            {% endif %}
                            {% empty %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-certificate fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma licença especial registrada</p>
                                <small>As licenças especiais decorrentes de decênios trabalhados serão exibidas aqui</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-certificate fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma licença especial registrada</p>
                                <small>As licenças especiais decorrentes de decênios trabalhados serão exibidas aqui</small>
                                <div class="mt-3">
                                    <a href="{% url 'militares:licenca_especial_create' %}?militar={{ militar.pk }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Adicionar Licença Especial
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Afastamentos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="afastamentosHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#afastamentos" aria-expanded="false" aria-controls="afastamentos">
                        <i class="fas fa-ban me-2 text-warning"></i>Afastamentos
                        {% if afastamentos %}
                        <span class="badge bg-warning ms-2">{{ afastamentos|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="afastamentos" class="accordion-collapse collapse" aria-labelledby="afastamentosHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        {% if pode_crud_pdf %}
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            {% if afastamentos %}
                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalCertidaoAfastamentos">
                                <i class="fas fa-file-pdf me-1"></i>Gerar Certidão de Afastamentos (PDF)
                            </button>
                            {% endif %}
                            {% if menu_permissions.show_afastamentos %}
                            {% if menu_permissions.BOTAO_AFASTAMENTO_NOVO %}
                            <a href="{% url 'militares:afastamento_create' %}?militar={{ militar.pk }}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-plus me-1"></i>Novo Afastamento
                            </a>
                            {% endif %}
                            {% if pode_crud_pdf %}
                            <a href="{% url 'militares:afastamento_list' %}?militar={{ militar.pk }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list me-1"></i>Ver Todos
                            </a>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Modal para Gerar Certidão de Afastamentos -->
                        <div class="modal fade" id="modalCertidaoAfastamentos" tabindex="-1" aria-labelledby="modalCertidaoAfastamentosLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="formCertidaoAfastamentos" method="get" action="{% url 'militares:afastamento_certidao_pdf' militar.pk %}" target="_blank">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalCertidaoAfastamentosLabel">
                                                <i class="fas fa-file-pdf me-2"></i>Gerar Certidão de Afastamentos
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p class="mb-3">Configure os filtros e selecione a função que será exibida na assinatura do documento:</p>
                                            
                                            <div class="mb-3">
                                                <label for="tipo_afastamento_filtro" class="form-label"><strong>Tipo de Afastamento</strong></label>
                                                <select class="form-select" id="tipo_afastamento_filtro" name="tipo_afastamento">
                                                    <option value="">Todos os tipos</option>
                                                    {% for value, label in tipos_afastamento %}
                                                        <option value="{{ value }}">{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Selecione um tipo específico ou deixe em branco para incluir todos.</div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="data_inicio_filtro" class="form-label"><strong>Período - Data Início</strong></label>
                                                    <input type="date" class="form-control" id="data_inicio_filtro" name="data_inicio">
                                                    <div class="form-text">Filtrar afastamentos a partir desta data.</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="data_fim_filtro" class="form-label"><strong>Período - Data Fim</strong></label>
                                                    <input type="date" class="form-control" id="data_fim_filtro" name="data_fim">
                                                    <div class="form-text">Filtrar afastamentos até esta data.</div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="funcao_assinatura_certidao_afastamento" class="form-label"><strong>Função para Assinatura *</strong></label>
                                                <select class="form-select" id="funcao_assinatura_certidao_afastamento" name="funcao" required>
                                                    <option value="">Selecione uma função...</option>
                                                    {% for funcao in funcoes_usuario %}
                                                        <option value="{{ funcao.funcao_militar.nome }}" {% if funcao_atual and funcao.funcao_militar.nome == funcao_atual.funcao_militar.nome %}selected{% endif %}>
                                                            {{ funcao.funcao_militar.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Selecione a função que será exibida na assinatura do documento.</div>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Atenção:</strong> O documento será gerado com a assinatura eletrônica e espaço para assinatura física. Os filtros são opcionais - se não preenchidos, todos os afastamentos serão incluídos.
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-danger" id="btnGerarCertidaoAfastamentos">
                                                <i class="fas fa-file-pdf me-1"></i>Gerar PDF
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        {% if afastamentos %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-warning">
                                        <tr>
                                            <th><i class="fas fa-list me-1"></i>Situação</th>
                                            <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                            <th><i class="fas fa-calendar me-1"></i>Período</th>
                                            <th><i class="fas fa-clock me-1"></i>Duração</th>
                                            <th><i class="fas fa-file-alt me-1"></i>Documento</th>
                                            <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for afastamento in afastamentos %}
                                        <tr class="{% if afastamento.status == 'ATIVO' %}table-warning{% elif afastamento.status == 'ENCERRADO' %}table-secondary{% else %}table-danger{% endif %}">
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong class="text-primary">
                                                        {{ afastamento.get_tipo_afastamento_display|after_slash }}
                                                    </strong>
                                                    {% if afastamento.motivo %}
                                                        <small class="text-muted" title="{{ afastamento.motivo }}">
                                                            {{ afastamento.motivo|truncatechars:40 }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if afastamento.status == 'ATIVO' %}
                                                    <span class="badge bg-success">{{ afastamento.status_display }}</span>
                                                {% elif afastamento.status == 'ENCERRADO' %}
                                                    <span class="badge bg-secondary">{{ afastamento.status_display }}</span>
                                                {% elif afastamento.status == 'CANCELADO' %}
                                                    <span class="badge bg-danger">{{ afastamento.status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        <strong>Início:</strong> {{ afastamento.data_inicio|date:"d/m/Y" }}
                                                    </small>
                                                    {% if afastamento.data_fim_real %}
                                                        <small class="text-success">
                                                            <i class="fas fa-calendar-check me-1"></i>
                                                            <strong>Fim:</strong> {{ afastamento.data_fim_real|date:"d/m/Y" }}
                                                        </small>
                                                    {% elif afastamento.data_fim_prevista %}
                                                        <small class="text-info">
                                                            <i class="fas fa-calendar-times me-1"></i>
                                                            <strong>Previsto:</strong> {{ afastamento.data_fim_prevista|date:"d/m/Y" }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-warning">
                                                            <i class="fas fa-infinity me-1"></i>
                                                            <strong>Fim:</strong> Indefinido
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-bold text-primary">{{ afastamento.duracao_formatada }}</span>
                                                    <small class="badge bg-info text-white">{{ afastamento.duracao_dias }} dias</small>
                                                </div>
                                            </td>
                                            <td>
                                                {% if afastamento.documento_referencia %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-file-alt me-1"></i>{{ afastamento.documento_referencia }}
                                                    </small>
                                                    {% if afastamento.numero_documento %}
                                                        <br><small class="text-muted">Nº {{ afastamento.numero_documento }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <small class="text-muted">-</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if menu_permissions.BOTAO_AFASTAMENTO_VISUALIZAR and pode_crud_pdf %}
                                                    <a href="{% url 'militares:afastamento_detail' afastamento.pk %}" class="btn btn-outline-info" title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if menu_permissions.show_afastamentos and menu_permissions.BOTAO_AFASTAMENTO_EDITAR and pode_crud_pdf %}
                                                    <a href="{% url 'militares:afastamento_update' afastamento.pk %}" class="btn btn-outline-primary" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-ban fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhum afastamento registrado</p>
                                <small>Os afastamentos do militar serão exibidos aqui</small>
                                {% if menu_permissions.show_afastamentos and menu_permissions.BOTAO_AFASTAMENTO_NOVO %}
                                <div class="mt-3">
                                    <a href="{% url 'militares:afastamento_create' %}?militar={{ militar.pk }}" class="btn btn-warning">
                                        <i class="fas fa-plus me-2"></i>Adicionar Afastamento
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Averbações -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="averbacoesHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#averbacoes" aria-expanded="false" aria-controls="averbacoes">
                        <i class="fas fa-file-signature me-2 text-info"></i>Averbações
                        {% if averbacoes %}
                        <span class="badge bg-info ms-2">{{ averbacoes|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="averbacoes" class="accordion-collapse collapse" aria-labelledby="averbacoesHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            {% if menu_permissions.show_averbacoes %}
                            <a href="{% url 'militares:averbacao_create' %}?militar={{ militar.pk }}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-plus me-1"></i>Nova Averbação
                            </a>
                            {% if pode_crud_pdf %}
                            <a href="{% url 'militares:averbacao_list' %}?militar={{ militar.pk }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list me-1"></i>Ver Todas
                            </a>
                            {% endif %}
                            {% endif %}
                        </div>
                        
                        {% if averbacoes %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-info">
                                        <tr>
                                            <th><i class="fas fa-calendar me-1"></i>Data Averbação</th>
                                            <th><i class="fas fa-clock me-1"></i>Tempo de Contribuição (TC)</th>
                                            <th><i class="fas fa-check-circle me-1"></i>Aproveitamento</th>
                                            <th><i class="fas fa-file-invoice me-1"></i>CTC/INSS</th>
                                            <th><i class="fas fa-building me-1"></i>Órgão</th>
                                            <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for averbacao in averbacoes %}
                                        <tr>
                                            <td>
                                                <strong>{{ averbacao.data_averbacao|date:"d/m/Y" }}</strong>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong class="text-primary">{{ averbacao.tempo_contribuicao_dias }} dias</strong>
                                                    <small class="text-muted">{{ averbacao.tempo_contribuicao_simples }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong class="text-success">{{ averbacao.aproveitamento_dias }} dias</strong>
                                                    <small class="text-muted">{{ averbacao.aproveitamento_simples }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <code>{{ averbacao.numero_ctc_inss }}</code>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong>{{ averbacao.orgao_local|truncatechars:30 }}</strong>
                                                    <small class="text-muted">{{ averbacao.cidade_estado_orgao }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if pode_crud_pdf %}
                                                    <a href="{% url 'militares:averbacao_detail' averbacao.pk %}" class="btn btn-info btn-sm" title="Ver Detalhes">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if menu_permissions.show_averbacoes %}
                                                    <a href="{% url 'militares:averbacao_update' averbacao.pk %}" class="btn btn-outline-primary btn-sm" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a href="{% url 'militares:averbacao_delete' averbacao.pk %}" class="btn btn-outline-danger btn-sm" title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-file-signature fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma averbação registrada</p>
                                <small>As averbações de tempo de contribuição do militar serão exibidas aqui</small>
                                {% if menu_permissions.show_averbacoes %}
                                <div class="mt-3">
                                    <a href="{% url 'militares:averbacao_create' %}?militar={{ militar.pk }}" class="btn btn-info">
                                        <i class="fas fa-plus me-2"></i>Adicionar Averbação
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Funções Exercidas -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="funcoesHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#funcoes" aria-expanded="false" aria-controls="funcoes">
                            <i class="fas fa-briefcase me-2"></i>Funções Exercidas
                        {% if todas_funcoes %}
                        <span class="badge bg-info ms-2">{{ todas_funcoes|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="funcoes" class="accordion-collapse collapse" aria-labelledby="funcoesHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-3">
                        {% if pode_crud_pdf %}
                        <a href="{% url 'militares:militar_funcao_list' militar.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Ver Todas
                        </a>
                        {% endif %}
                    </div>
                    {% if todas_funcoes %}
                        <div class="accordion" id="funcoesAccordion">
                            <!-- Funções Atuais -->
                            {% if funcoes_atuais %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="funcoesAtuais">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFuncoesAtuais" aria-expanded="true" aria-controls="collapseFuncoesAtuais">
                                        <i class="fas fa-star me-2 text-warning"></i>
                                        <strong>Funções Atuais</strong>
                                        <span class="badge bg-success ms-2">{{ funcoes_atuais|length }}</span>
                                    </button>
                                </h2>
                                <div id="collapseFuncoesAtuais" class="accordion-collapse collapse show" aria-labelledby="funcoesAtuais" data-bs-parent="#funcoesAccordion">
                                    <div class="accordion-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm">
                                                <thead>
                                                    <tr>
                                                        <th class="fw-bold text-primary">Função</th>
                                                        <th class="fw-bold text-primary">Tipo</th>
                                                        <th class="fw-bold text-primary">Período</th>
                                                        <th class="fw-bold text-primary">Postos</th>
                                                        <th class="fw-bold text-primary">Observações</th>
                                                        <th class="fw-bold text-primary">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for funcao in funcoes_atuais %}
                                                    <tr class="{% if funcao.tipo_funcao == 'PRINCIPAL' %}table-warning{% else %}table-success{% endif %}">
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <strong class="text-primary">
                                                                    {% if funcao.tipo_funcao == 'PRINCIPAL' %}
                                                                        <i class="fas fa-star me-1 text-warning"></i>
                                                                    {% endif %}
                                                                    {{ funcao.funcao_militar.nome }}
                                                                </strong>
                                                                <small class="text-muted">
                                                                    <i class="fas fa-tag me-1"></i>{{ funcao.funcao_militar.get_grupo_display }}
                                                                </small>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-{% if funcao.tipo_funcao == 'PRINCIPAL' %}warning{% elif funcao.tipo_funcao == 'ADICIONAL' %}info{% elif funcao.tipo_funcao == 'TEMPORARIA' %}secondary{% elif funcao.tipo_funcao == 'COMISSAO' %}danger{% else %}primary{% endif %}">
                                                                {{ funcao.get_tipo_funcao_display }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-calendar me-1"></i>{{ funcao.data_inicio|date:"d/m/Y" }}
                                                                </small>
                                                                {% if funcao.data_fim %}
                                                                    <small class="text-danger">
                                                                        <i class="fas fa-calendar-times me-1"></i>{{ funcao.data_fim|date:"d/m/Y" }}
                                                                    </small>
                                                                {% else %}
                                                                    <small class="text-success">
                                                                        <i class="fas fa-infinity me-1"></i>Em andamento
                                                                    </small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-star me-1"></i>Início: {{ funcao.get_posto_inicial_display }}
                                                                </small>
                                                                {% if funcao.posto_final %}
                                                                    <small class="text-info">
                                                                        <i class="fas fa-flag-checkered me-1"></i>Fim: {{ funcao.get_posto_final_display }}
                                                                    </small>
                                                                {% else %}
                                                                    <small class="text-success">
                                                                        <i class="fas fa-infinity me-1"></i>Atual: {{ militar.get_posto_graduacao_display }}
                                                                    </small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if funcao.observacoes %}
                                                                <small class="text-muted" title="{{ funcao.observacoes }}">
                                                                    <i class="fas fa-comment me-1"></i>{{ funcao.observacoes|truncatechars:30 }}
                                                                </small>
                                                            {% else %}
                                                                <small class="text-muted">-</small>
                                                            {% endif %}
                                                        </td>
                                                        {% if permissoes_funcoes.funcoes_editar and pode_crud_pdf %}
                                                        <td>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <a href="{% url 'militares:militar_funcao_update' militar.pk funcao.pk %}" class="btn btn-outline-primary" title="Editar">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                            </div>
                                                        </td>
                                                        {% endif %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Funções Históricas -->
                            {% if funcoes_historicas %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="funcoesHistoricas">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFuncoesHistoricas" aria-expanded="false" aria-controls="collapseFuncoesHistoricas">
                                        <i class="fas fa-history me-2 text-secondary"></i>
                                        <strong>Histórico de Funções</strong>
                                        <span class="badge bg-secondary ms-2">{{ funcoes_historicas|length }}</span>
                                    </button>
                                </h2>
                                <div id="collapseFuncoesHistoricas" class="accordion-collapse collapse" aria-labelledby="funcoesHistoricas" data-bs-parent="#funcoesAccordion">
                                    <div class="accordion-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm">
                                                <thead>
                                                    <tr>
                                                        <th class="fw-bold text-primary">Função</th>
                                                        <th class="fw-bold text-primary">Tipo</th>
                                                        <th class="fw-bold text-primary">Período</th>
                                                        <th class="fw-bold text-primary">Postos</th>
                                                        <th class="fw-bold text-primary">Observações</th>
                                                        <th class="fw-bold text-primary">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for funcao in funcoes_historicas %}
                                                    <tr class="table-light">
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <strong class="text-secondary">
                                                                    {% if funcao.tipo_funcao == 'PRINCIPAL' %}
                                                                        <i class="fas fa-star me-1 text-warning"></i>
                                                                    {% endif %}
                                                                    {{ funcao.funcao_militar.nome }}
                                                                </strong>
                                                                <small class="text-muted">
                                                                    <i class="fas fa-tag me-1"></i>{{ funcao.funcao_militar.get_grupo_display }}
                                                                </small>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-{% if funcao.tipo_funcao == 'PRINCIPAL' %}warning{% elif funcao.tipo_funcao == 'ADICIONAL' %}info{% elif funcao.tipo_funcao == 'TEMPORARIA' %}secondary{% elif funcao.tipo_funcao == 'COMISSAO' %}danger{% else %}primary{% endif %}">
                                                                {{ funcao.get_tipo_funcao_display }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-calendar me-1"></i>{{ funcao.data_inicio|date:"d/m/Y" }}
                                                                </small>
                                                                {% if funcao.data_fim %}
                                                                    <small class="text-danger">
                                                                        <i class="fas fa-calendar-times me-1"></i>{{ funcao.data_fim|date:"d/m/Y" }}
                                                                    </small>
                                                                {% else %}
                                                                    <small class="text-success">
                                                                        <i class="fas fa-infinity me-1"></i>Em andamento
                                                                    </small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-star me-1"></i>Início: {{ funcao.get_posto_inicial_display }}
                                                                </small>
                                                                {% if funcao.posto_final %}
                                                                    <small class="text-info">
                                                                        <i class="fas fa-flag-checkered me-1"></i>Fim: {{ funcao.get_posto_final_display }}
                                                                    </small>
                                                                {% else %}
                                                                    <small class="text-success">
                                                                        <i class="fas fa-infinity me-1"></i>Atual: {{ militar.get_posto_graduacao_display }}
                                                                    </small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if funcao.observacoes %}
                                                                <small class="text-muted" title="{{ funcao.observacoes }}">
                                                                    <i class="fas fa-comment me-1"></i>{{ funcao.observacoes|truncatechars:30 }}
                                                                </small>
                                                            {% else %}
                                                                <small class="text-muted">-</small>
                                                            {% endif %}
                                                        </td>
                                                        {% if permissoes_funcoes.funcoes_editar and pode_crud_pdf %}
                                                        <td>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <a href="{% url 'militares:militar_funcao_update' militar.pk funcao.pk %}" class="btn btn-outline-primary" title="Editar">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                            </div>
                                                        </td>
                                                        {% endif %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-briefcase fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhuma função cadastrada</p>
                            <small>As funções exercidas pelo militar serão exibidas aqui</small>
                            {% if permissoes_funcoes.funcoes_criar %}
                            <div class="mt-3">
                                <a href="{% url 'militares:militar_funcao_create' militar.pk %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Adicionar Função
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Elogios -->
            {% if pode_visualizar_punicoes_elogios %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="elogiosHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#elogios" aria-expanded="false" aria-controls="elogios">
                            <i class="fas fa-trophy me-2 text-warning"></i>Elogios
                        {% if elogios %}
                        <span class="badge bg-warning ms-2">{{ elogios|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="elogios" class="accordion-collapse collapse" aria-labelledby="elogiosHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                {% if pode_crud_pdf %}
                                <a href="{% url 'militares:elogio_list' %}?militar={{ militar.pk }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>Ver Todos os Elogios
                                </a>
                                {% endif %}
                            </div>
                            <div>
                                {% if pode_editar_punicoes_elogios or user.is_superuser %}
                                <a href="{% url 'militares:elogio_create' %}?militar={{ militar.pk }}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-plus me-1"></i>Novo Elogio
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    {% if elogios %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-warning">
                                    <tr>
                                        <th><i class="fas fa-trophy me-1"></i>Tipo</th>
                                        <th><i class="fas fa-calendar me-1"></i>Data</th>
                                        <th><i class="fas fa-user-tie me-1"></i>Autoridade</th>
                                        <th><i class="fas fa-file-alt me-1"></i>Documento</th>
                                        <th><i class="fas fa-comment me-1"></i>Observações</th>
                                        {% if pode_editar_punicoes_elogios %}
                                        <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for elogio in elogios|slice:":5" %}
                                    <tr class="table-warning">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="text-warning">
                                                    {{ elogio.tipo_icon }} {{ elogio.get_tipo_display }}
                                                </strong>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning text-dark">
                                                {{ elogio.data_elogio|date:"d/m/Y" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <small class="text-muted">
                                                    <i class="fas fa-user-tie me-1"></i>{{ elogio.autoridade_elogiou }}
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if elogio.numero_documento %}
                                                <small class="text-muted">
                                                    <i class="fas fa-file-alt me-1"></i>{{ elogio.numero_documento }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if elogio.observacoes %}
                                                <small class="text-muted" title="{{ elogio.observacoes }}">
                                                    <i class="fas fa-comment me-1"></i>{{ elogio.observacoes|truncatechars:30 }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        {% if pode_editar_punicoes_elogios or user.is_superuser %}
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:elogio_detail' elogio.pk %}" class="btn btn-outline-info btn-sm" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:elogio_update' elogio.pk %}" class="btn btn-outline-primary btn-sm" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if user.is_superuser %}
                                                <a href="{% url 'militares:elogio_delete' elogio.pk %}" class="btn btn-outline-danger btn-sm" title="Excluir" 
                                                   onclick="return confirm('Tem certeza que deseja excluir este elogio?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if elogios|length > 5 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Mostrando 5 de {{ elogios|length }} elogio(s) mais recentes. 
                                {% if pode_crud_pdf %}
                                <a href="{% url 'militares:elogio_list' %}?militar={{ militar.pk }}">Ver todos</a>
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-trophy fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhum elogio registrado</p>
                            <small>Os elogios recebidos pelo militar serão exibidos aqui</small>
                            {% if pode_editar_punicoes_elogios or user.is_superuser %}
                            <div class="mt-3">
                                <a href="{% url 'militares:elogio_create' %}?militar={{ militar.pk }}" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Adicionar Elogio
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="elogiosRestritoHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#elogiosRestrito" aria-expanded="false" aria-controls="elogiosRestrito">
                        <i class="fas fa-trophy me-2 text-warning"></i>Elogios
                        <span class="badge bg-secondary ms-2">Restrito</span>
                    </button>
                </h2>
                <div id="elogiosRestrito" class="accordion-collapse collapse" aria-labelledby="elogiosRestritoHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body text-center text-muted py-4">
                    <i class="fas fa-lock fa-3x mb-3"></i>
                    <p>Você não tem permissão para visualizar elogios de oficiais.</p>
                    <small>Apenas Comandante Geral, Subcomandante Geral, Chefe da Seção de Inteligência e Contrainteligência e Administradores podem visualizar elogios de oficiais.</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Punições -->
            {% if pode_visualizar_punicoes_elogios %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="punicoesHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#punicoes" aria-expanded="false" aria-controls="punicoes">
                            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Punições
                        {% if punicoes %}
                        <span class="badge bg-danger ms-2">{{ punicoes|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="punicoes" class="accordion-collapse collapse" aria-labelledby="punicoesHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                {% if pode_crud_pdf %}
                                <a href="{% url 'militares:punicao_list' %}?militar={{ militar.pk }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>Ver Todas as Punições
                                </a>
                                {% endif %}
                            </div>
                            <div>
                                {% if pode_editar_punicoes_elogios or user.is_superuser %}
                                <a href="{% url 'militares:punicao_create' %}?militar={{ militar.pk }}" class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-plus me-1"></i>Nova Punição
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    {% if punicoes %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-danger">
                                    <tr>
                                        <th><i class="fas fa-exclamation-triangle me-1"></i>Tipo</th>
                                        <th><i class="fas fa-calendar me-1"></i>Data</th>
                                        <th><i class="fas fa-user-tie me-1"></i>Autoridade</th>
                                        <th><i class="fas fa-clock me-1"></i>Período</th>
                                        <th><i class="fas fa-file-alt me-1"></i>Documento</th>
                                        <th><i class="fas fa-comment me-1"></i>Observações</th>
                                        {% if pode_editar_punicoes_elogios %}
                                        <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for punicao in punicoes|slice:":5" %}
                                    <tr class="table-danger">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="text-danger">
                                                    {{ punicao.tipo_icon }} {{ punicao.get_tipo_display }}
                                                </strong>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">
                                                {{ punicao.data_punicao|date:"d/m/Y" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <small class="text-muted">
                                                    <i class="fas fa-user-tie me-1"></i>{{ punicao.autoridade_puniu }}
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if punicao.periodo_punicao %}
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>{{ punicao.periodo_punicao }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if punicao.numero_documento %}
                                                <small class="text-muted">
                                                    <i class="fas fa-file-alt me-1"></i>{{ punicao.numero_documento }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if punicao.observacoes %}
                                                <small class="text-muted" title="{{ punicao.observacoes }}">
                                                    <i class="fas fa-comment me-1"></i>{{ punicao.observacoes|truncatechars:30 }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        {% if pode_editar_punicoes_elogios or user.is_superuser %}
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:punicao_detail' punicao.pk %}" class="btn btn-outline-info btn-sm" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:punicao_update' punicao.pk %}" class="btn btn-outline-primary btn-sm" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if user.is_superuser %}
                                                <a href="{% url 'militares:punicao_delete' punicao.pk %}" class="btn btn-outline-danger btn-sm" title="Excluir" 
                                                   onclick="return confirm('Tem certeza que deseja excluir esta punição?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if punicoes|length > 5 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Mostrando 5 de {{ punicoes|length }} punição(ões) mais recentes. 
                                {% if pode_crud_pdf %}
                                <a href="{% url 'militares:punicao_list' %}?militar={{ militar.pk }}">Ver todas</a>
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhuma punição registrada</p>
                            <small>As punições aplicadas ao militar serão exibidas aqui</small>
                            {% if pode_editar_punicoes_elogios or user.is_superuser %}
                            <div class="mt-3">
                                <a href="{% url 'militares:punicao_create' %}?militar={{ militar.pk }}" class="btn btn-danger">
                                    <i class="fas fa-plus me-2"></i>Adicionar Punição
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="punicoesRestritoHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#punicoesRestrito" aria-expanded="false" aria-controls="punicoesRestrito">
                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Punições
                        <span class="badge bg-secondary ms-2">Restrito</span>
                    </button>
                </h2>
                <div id="punicoesRestrito" class="accordion-collapse collapse" aria-labelledby="punicoesRestritoHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body text-center text-muted py-4">
                    <i class="fas fa-lock fa-3x mb-3"></i>
                        <p>Você não tem permissão para visualizar punições de oficiais.</p>
                        <small>Apenas Comandante Geral, Subcomandante Geral, Diretor de Gestão de Pessoas e Chefe da Seção de Inteligência e Contrainteligência podem visualizar.</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Documentos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="documentosHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#documentos" aria-expanded="false" aria-controls="documentos">
                        <i class="fas fa-file-alt me-2 text-info"></i>Documentos
                        {% if documentos %}
                        <span class="badge bg-info ms-2">{{ documentos|length }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="documentos" class="accordion-collapse collapse" aria-labelledby="documentosHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                    {% if documentos %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-info">
                                    <tr>
                                        <th><i class="fas fa-file-alt me-1"></i>Título</th>
                                        <th><i class="fas fa-tag me-1"></i>Tipo</th>
                                        <th><i class="fas fa-check-circle me-1"></i>Status</th>
                                        <th><i class="fas fa-upload me-1"></i>Upload</th>
                                        <th><i class="fas fa-signature me-1"></i>Assinatura</th>
                                        <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for documento in documentos|slice:":5" %}
                                    <tr class="table-info">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="text-info">
                                                    {{ documento.titulo }}
                                                </strong>
                                                {% if documento.observacoes %}
                                                    <small class="text-muted">{{ documento.observacoes|truncatechars:30 }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ documento.get_tipo_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if documento.status == 'APROVADO' %}success{% elif documento.status == 'REJEITADO' %}danger{% elif documento.status == 'ARQUIVADO' %}secondary{% elif documento.status == 'ASSINADO' %}primary{% else %}warning{% endif %}">
                                                {{ documento.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="fas fa-upload me-1"></i>{{ documento.data_upload|date:"d/m/Y H:i" }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if documento.status == 'ASSINADO' and documento.assinado_por %}
                                                <small class="text-muted">
                                                    <i class="fas fa-signature me-1"></i>{{ documento.assinado_por.get_full_name|default:documento.assinado_por.username }}
                                                    <br><small>{{ documento.data_assinatura|date:"d/m/Y H:i" }}</small>
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ documento.arquivo.url }}" class="btn btn-outline-primary btn-sm" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if not menu_permissions.is_consultor %}
                                                {% if documento.status != 'ASSINADO' and menu_permissions.MILITARES_EDITAR %}
                                                    <a href="{% url 'militares:assinar_documento' documento.pk %}" class="btn btn-success btn-sm" title="Assinar">
                                                        <i class="fas fa-file-signature"></i>
                                                    </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_EDITAR and pode_crud_pdf %}
                                                <a href="{% url 'militares:conferir_documento' documento.pk %}" class="btn btn-warning btn-sm" title="Conferir">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_EDITAR and pode_crud_pdf %}
                                                <a href="{% url 'militares:documento_delete' documento.pk %}" class="btn btn-outline-danger btn-sm" title="Excluir" 
                                                   onclick="return confirm('Tem certeza que deseja excluir este documento?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if documentos|length > 5 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Mostrando 5 de {{ documentos|length }} documento(s) mais recentes
                            </small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-file-alt fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p class="mb-2">Nenhum documento registrado</p>
                            <small>Os documentos do militar serão exibidos aqui</small>
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Minhas Publicações -->
            <div class="accordion-item" id="minhas-publicacoes">
                <h2 class="accordion-header" id="publicacoesHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#publicacoes" aria-expanded="false" aria-controls="publicacoes">
                        <i class="fas fa-newspaper me-2"></i>Publicações Indexadas
                        <span class="badge bg-info ms-2" id="contadorPublicacoes">Carregando...</span>
                    </button>
                </h2>
                <div id="publicacoes" class="accordion-collapse collapse" aria-labelledby="publicacoesHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between mb-3">
                            <button class="btn btn-sm btn-primary" onclick="carregarPublicacoes()">
                                <i class="fas fa-play me-1"></i>Carregar Todas as Publicações
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarPublicacoes()">
                                <i class="fas fa-sync-alt me-1"></i>Atualizar
                            </button>
                        </div>
                        <div id="loadingPublicacoes" class="text-center py-3" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-2"></i>Carregando publicações...
                        </div>
                        <div id="listaPublicacoes">
                            <div class="text-center py-3">
                                <i class="fas fa-newspaper fa-2x mb-2" style="opacity: 0.3;"></i>
                                <p class="mb-2">Clique em "Atualizar" para carregar as publicações</p>
                                <small class="text-muted">Publicações onde este militar está indexado</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cautelas de Armas -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="cautelasArmasHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cautelasArmas" aria-expanded="false" aria-controls="cautelasArmas">
                        <i class="fas fa-gun me-2 text-danger"></i>Cautelas de Armas
                        {% if total_cautelas > 0 %}
                        <span class="badge bg-danger ms-2">{{ total_cautelas }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="cautelasArmas" class="accordion-collapse collapse" aria-labelledby="cautelasArmasHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        {% if cautelas_individuais or cautelas_coletivas %}
                            <!-- Cautelas Individuais -->
                            {% if cautelas_individuais %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>Cautelas Individuais
                                    <span class="badge bg-primary ms-2">{{ cautelas_individuais|length }}</span>
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-danger">
                                            <tr>
                                                <th>Arma</th>
                                                <th>Data Entrega</th>
                                                <th>Data Devolução</th>
                                                <th>Status</th>
                                                <th>Organização</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cautela in cautelas_individuais %}
                                            <tr>
                                                <td>
                                                    <strong>{{ cautela.arma.numero_serie }}</strong><br>
                                                    <small class="text-muted">{{ cautela.arma.marca }} {{ cautela.arma.modelo }}</small>
                                                </td>
                                                <td>{{ cautela.data_entrega|date:"d/m/Y H:i" }}</td>
                                                <td>
                                                    {% if cautela.data_devolucao %}
                                                        {{ cautela.data_devolucao|date:"d/m/Y H:i" }}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if cautela.ativa %}
                                                        <span class="badge bg-success">Ativa</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Devolvida</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <small class="text-muted">{{ cautela.get_organizacao }}</small>
                                                </td>
                                                <td>
                                                    {% if pode_crud_pdf %}
                                                    <a href="{% url 'militares:cautela_arma_detail' cautela.pk %}" class="btn btn-sm btn-outline-danger" title="Ver Detalhes">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Cautelas Coletivas -->
                            {% if cautelas_coletivas %}
                            <div class="mb-4">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-users me-2"></i>Cautelas Coletivas (Responsável)
                                    <span class="badge bg-warning ms-2">{{ cautelas_coletivas|length }}</span>
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-warning">
                                            <tr>
                                                <th>Descrição/Finalidade</th>
                                                <th>Tipo</th>
                                                <th>Data Início</th>
                                                <th>Data Fim</th>
                                                <th>Total de Armas</th>
                                                <th>Status</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cautela in cautelas_coletivas %}
                                            <tr>
                                                <td>
                                                    <strong>{{ cautela.descricao }}</strong>
                                                    {% if cautela.documento_referencia %}
                                                        <br><small class="text-muted">Doc: {{ cautela.documento_referencia }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">{{ cautela.get_tipo_finalidade_display }}</span>
                                                </td>
                                                <td>{{ cautela.data_inicio|date:"d/m/Y H:i" }}</td>
                                                <td>
                                                    {% if cautela.data_fim %}
                                                        {{ cautela.data_fim|date:"d/m/Y H:i" }}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ cautela.get_total_armas }} arma(s)</span>
                                                </td>
                                                <td>
                                                    {% if cautela.ativa %}
                                                        <span class="badge bg-success">Ativa</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Finalizada</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if pode_crud_pdf %}
                                                    <a href="{% url 'militares:cautela_arma_coletiva_detail' cautela.pk %}" class="btn btn-sm btn-outline-warning" title="Ver Detalhes">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-gun fa-3x mb-3" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhuma cautela de arma registrada</p>
                                <small>O histórico de cautelas de armas do militar será exibido aqui</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Processos Administrativos -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="processosHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#processos" aria-expanded="false" aria-controls="processos">
                        <i class="fas fa-folder-open me-2 text-info"></i>Processos Administrativos
                        {% if total_processos > 0 %}
                        <span class="badge bg-info ms-2">{{ total_processos }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="processos" class="accordion-collapse collapse" aria-labelledby="processosHeader" data-bs-parent="#militarAccordion">
                    <div class="accordion-body">
                        {% if processos_todos %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Assunto</th>
                                            <th>Tipo</th>
                                            <th>Status</th>
                                            <th>Data Abertura</th>
                                            <th>Papel no Processo</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for papel, processo in processos_todos %}
                                        <tr>
                                            <td>
                                                <strong>{{ processo.numero }}</strong>
                                            </td>
                                            <td>
                                                {{ processo.assunto|truncatechars:50 }}
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ processo.get_tipo_display }}</span>
                                            </td>
                                            <td>
                                                {% if processo.status == 'EM_ABERTURA' %}
                                                    <span class="badge bg-warning">Em Abertura</span>
                                                {% elif processo.status == 'EM_ANDAMENTO' %}
                                                    <span class="badge bg-info">Em Andamento</span>
                                                {% elif processo.status == 'EM_ANALISE' %}
                                                    <span class="badge bg-primary">Em Análise</span>
                                                {% elif processo.status == 'AGUARDANDO_DECISAO' %}
                                                    <span class="badge bg-warning">Aguardando Decisão</span>
                                                {% elif processo.status == 'DECIDIDO' %}
                                                    <span class="badge bg-success">Decidido</span>
                                                {% elif processo.status == 'ARQUIVADO' %}
                                                    <span class="badge bg-secondary">Arquivado</span>
                                                {% elif processo.status == 'CANCELADO' %}
                                                    <span class="badge bg-dark">Cancelado</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">{{ processo.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if processo.data_abertura %}
                                                    {{ processo.data_abertura|date:"d/m/Y" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if papel == 'envolvido' %}
                                                    <span class="badge bg-danger">Envolvido</span>
                                                {% elif papel == 'encarregado' %}
                                                    <span class="badge bg-primary">Encarregado</span>
                                                {% elif papel == 'escriva' %}
                                                    <span class="badge bg-success">Escriba</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if pode_crud_pdf %}
                                                <a href="{% url 'militares:processo_administrativo_detail' processo.pk %}" 
                                                   class="btn btn-sm btn-outline-info" 
                                                   title="Ver Detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-folder-open fa-3x mb-3" style="opacity: 0.3;"></i>
                                <p class="mb-2">Nenhum processo administrativo encontrado</p>
                                <small>Este militar não está vinculado a nenhum processo administrativo</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            </div> <!-- Fechar acordeão principal -->
        </div> <!-- Fechar col-md-8 -->
    </div> <!-- Fechar row -->
</div> <!-- Fechar container-fluid -->
{% endblock %}

{% block extra_js %}
<script>
// Gerenciar geração de certidão de férias
document.addEventListener('DOMContentLoaded', function() {
    const formCertidaoFerias = document.getElementById('formCertidaoFerias');
    
    if (formCertidaoFerias) {
        formCertidaoFerias.addEventListener('submit', function(e) {
            const funcaoSelect = document.getElementById('funcao_assinatura_certidao');
            
            if (!funcaoSelect || !funcaoSelect.value) {
                e.preventDefault();
                alert('Por favor, selecione uma função para assinatura.');
                return false;
            }
        });
    }
    
    // Gerenciar geração de certidão de licenças especiais
    const formCertidaoLicencaEspecial = document.getElementById('formCertidaoLicencaEspecial');
    
    if (formCertidaoLicencaEspecial) {
        formCertidaoLicencaEspecial.addEventListener('submit', function(e) {
            const funcaoSelect = document.getElementById('funcao_assinatura_certidao_licenca');
            
            // Validar se a função foi selecionada
            if (!funcaoSelect || !funcaoSelect.value || funcaoSelect.value.trim() === '') {
                e.preventDefault();
                alert('Por favor, selecione uma função para assinatura.');
                if (funcaoSelect) {
                    funcaoSelect.focus();
                }
                return false;
            }
            
            // O formulário já tem target="_blank", então vai abrir em nova aba
            // Apenas fechar o modal
            const modalElement = document.getElementById('modalCertidaoLicencaEspecial');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    // Fechar modal após um pequeno delay para permitir que o formulário seja submetido
                    setTimeout(function() {
                        modal.hide();
                    }, 100);
                }
            }
        });
    }
    
    // Gerenciar geração de certidão de afastamentos
    const formCertidaoAfastamentos = document.getElementById('formCertidaoAfastamentos');
    
    if (formCertidaoAfastamentos) {
        formCertidaoAfastamentos.addEventListener('submit', function(e) {
            const funcaoSelect = document.getElementById('funcao_assinatura_certidao_afastamento');
            
            // Validar se a função foi selecionada
            if (!funcaoSelect || !funcaoSelect.value || funcaoSelect.value.trim() === '') {
                e.preventDefault();
                alert('Por favor, selecione uma função para assinatura.');
                if (funcaoSelect) {
                    funcaoSelect.focus();
                }
                return false;
            }
            
            // O formulário já tem target="_blank", então vai abrir em nova aba
            // Apenas fechar o modal
            const modalElement = document.getElementById('modalCertidaoAfastamentos');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    // Fechar modal após um pequeno delay para permitir que o formulário seja submetido
                    setTimeout(function() {
                        modal.hide();
                    }, 100);
                }
            }
        });
    }
    
    // Gerenciar geração de certidão de tempo de serviço
    const formCertidaoTempoServico = document.getElementById('formCertidaoTempoServico');
    
    if (formCertidaoTempoServico) {
        formCertidaoTempoServico.addEventListener('submit', function(e) {
            const funcaoSelect = document.getElementById('funcao_assinatura_certidao_tempo_servico');
            
            // Validar se a função foi selecionada
            if (!funcaoSelect || !funcaoSelect.value || funcaoSelect.value.trim() === '') {
                e.preventDefault();
                alert('Por favor, selecione uma função para assinatura.');
                if (funcaoSelect) {
                    funcaoSelect.focus();
                }
                return false;
            }
            
            // O formulário já tem target="_blank", então vai abrir em nova aba
            // Apenas fechar o modal
            const modalElement = document.getElementById('modalCertidaoTempoServico');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    // Fechar modal após um pequeno delay para permitir que o formulário seja submetido
                    setTimeout(function() {
                        modal.hide();
                    }, 100);
                }
            }
        });
    }
});

// Função para carregar publicações do militar
function carregarPublicacoes() {
    const militarId = {{ militar.pk }};
    
    // Mostrar loading
    document.getElementById('loadingPublicacoes').style.display = 'block';
    document.getElementById('listaPublicacoes').innerHTML = '';
    
    // Construir URL - buscar todas as publicações indexadas
    const url = `/militares/ajax/publicacoes-militar/${militarId}/`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingPublicacoes').style.display = 'none';
        
        if (data.success) {
            // Exibir todas as publicações indexadas
            exibirPublicacoes(data.publicacoes);
        } else {
            document.getElementById('listaPublicacoes').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar publicações: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('loadingPublicacoes').style.display = 'none';
        document.getElementById('listaPublicacoes').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erro ao carregar publicações: ${error.message}
            </div>
        `;
    });
}

// Função para exibir as publicações
function exibirPublicacoes(publicacoes) {
    const container = document.getElementById('listaPublicacoes');
    
    if (publicacoes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-newspaper fa-2x mb-2" style="opacity: 0.3;"></i>
                <p class="mb-2">Nenhuma publicação encontrada</p>
                <small class="text-muted">Este militar não está indexado em nenhuma publicação</small>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="row mb-3">
            <div class="col-12">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Encontradas ${publicacoes.length} publicação(ões)
                </small>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Número</th>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Boletim</th>
                        <th>Data Publicação</th>
                        <th>Origem</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    publicacoes.forEach(pub => {
        // Badge de status com cores
        let statusBadge = '';
        switch(pub.status_codigo) {
            case 'PUBLICADA':
                statusBadge = '<span class="badge bg-success">Publicada</span>';
                break;
            case 'APROVADA':
                statusBadge = '<span class="badge bg-primary">Aprovada</span>';
                break;
            case 'REVISADA':
                statusBadge = '<span class="badge bg-info">Revisada</span>';
                break;
            case 'RASCUNHO':
                statusBadge = '<span class="badge bg-warning">Rascunho</span>';
                break;
            case 'EDITADA':
                statusBadge = '<span class="badge bg-secondary">Editada</span>';
                break;
            case 'ARQUIVADA':
                statusBadge = '<span class="badge bg-dark">Arquivada</span>';
                break;
            default:
                statusBadge = `<span class="badge bg-light text-dark">${pub.status}</span>`;
        }
        
        // Badge de tipo
        let tipoBadge = '';
        switch(pub.tipo_codigo) {
            case 'NOTA':
                tipoBadge = '<span class="badge bg-primary">Nota</span>';
                break;
            case 'BOLETIM_OSTENSIVO':
                tipoBadge = '<span class="badge bg-success">Boletim Ostensivo</span>';
                break;
            case 'BOLETIM_RESERVADO':
                tipoBadge = '<span class="badge bg-warning">Boletim Reservado</span>';
                break;
            case 'BOLETIM_ESPECIAL':
                tipoBadge = '<span class="badge bg-danger">Boletim Especial</span>';
                break;
            case 'AVISO':
                tipoBadge = '<span class="badge bg-info">Aviso</span>';
                break;
            case 'ORDEM_SERVICO':
                tipoBadge = '<span class="badge bg-secondary">Ordem de Serviço</span>';
                break;
            default:
                tipoBadge = `<span class="badge bg-light text-dark">${pub.tipo}</span>`;
        }
        
        const dataPublicacao = pub.data_publicacao || 'Não publicada';
        
        html += `
            <tr>
                <td>
                    <strong class="text-primary">${pub.numero}</strong>
                </td>
                <td>
                    <div class="fw-bold">${pub.titulo}</div>
                    ${pub.topicos ? `<small class="text-muted">${pub.topicos}</small>` : ''}
                </td>
                <td>${tipoBadge}</td>
                <td>${statusBadge}</td>
                <td>
                    ${pub.status_codigo === 'PUBLICADA' && pub.url_boletim ? 
                        `<a href="${pub.url_boletim}" class="text-primary fw-bold" title="Abrir PDF do Boletim" target="_blank">
                            <i class="fas fa-file-pdf me-1"></i>${pub.numero_boletim}
                        </a>` : 
                        `<small class="text-muted">${pub.numero_boletim || 'Não publicado'}</small>`
                    }
                </td>
                <td>
                    <small class="text-muted">${dataPublicacao}</small>
                </td>
                <td>
                    <small class="text-muted">${pub.origem}</small>
                </td>
                <td>
                    <a href="${pub.url_detalhes}" class="btn btn-sm btn-outline-primary" title="Ver PDF" target="_blank">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se há âncora #minhas-publicacoes na URL
    if (window.location.hash === '#minhas-publicacoes') {
        // Aguardar um pouco para garantir que a página carregou completamente
        setTimeout(() => {
            const elemento = document.getElementById('minhas-publicacoes');
            if (elemento) {
                elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Carregar publicações automaticamente
                carregarPublicacoes();
            }
        }, 500);
    }
});
</script>
{% endblock %} 