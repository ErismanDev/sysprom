{% extends 'base.html' %}
{% load static %}

{% block title %}Detalhes da Disciplina - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-book-open me-2"></i>
                    Detalhes da Disciplina
                </h1>
                {% if is_apk or request.GET.apk %}
                <div class="d-grid gap-2 ms-3" style="max-width: 260px;">
                    {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                    <button type="button" class="btn btn-warning btn-editar-disciplina" id="btnEditarDisciplina{{ disciplina.pk }}" data-disciplina-id="{{ disciplina.pk }}">
                        <i class="fas fa-edit me-2"></i>
                        Editar
                    </button>
                    {% endif %}
                    <a href="{% url 'militares:ensino_disciplinas_listar' %}?apk=1" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% else %}
                <div>
                    {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                    <button type="button" class="btn btn-warning btn-editar-disciplina" id="btnEditarDisciplina{{ disciplina.pk }}" data-disciplina-id="{{ disciplina.pk }}">
                        <i class="fas fa-edit me-2"></i>
                        Editar
                    </button>
                    {% endif %}
                    <a href="{% url 'militares:ensino_disciplinas_listar' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Informações Básicas -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <dl class="row">
                                <dt class="col-sm-5">Código:</dt>
                                <dd class="col-sm-7"><strong>{{ disciplina.codigo|default:"Não informado" }}</strong></dd>
                                
                                <dt class="col-sm-5">Nome:</dt>
                                <dd class="col-sm-7">{{ disciplina.nome|default:"Não informado" }}</dd>
                                
                                <dt class="col-sm-5">Categoria:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.categoria %}
                                        <small>{{ disciplina.get_categoria_display }}</small>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                {% if disciplina.instrutor_responsavel_militar or disciplina.instrutor_responsavel_externo %}
                                <dt class="col-sm-5">Instrutor:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.instrutor_responsavel_militar %}
                                        <span class="badge bg-primary">Militar</span><br>
                                        <small>{{ disciplina.instrutor_responsavel_militar.get_posto_graduacao_display }} {{ disciplina.instrutor_responsavel_militar.nome_completo }}</small>
                                    {% elif disciplina.instrutor_responsavel_externo %}
                                        <span class="badge bg-info">Externo</span><br>
                                        <small>{{ disciplina.instrutor_responsavel_externo.get_nome_completo }}</small>
                                    {% endif %}
                                </dd>
                                {% endif %}
                                
                                <dt class="col-sm-5">Status:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.ativo %}
                                        <span class="badge bg-success">Ativa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inativa</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Versão:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.versao %}
                                        {{ disciplina.versao }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Ano de Vigência:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.ano_vigencia %}
                                        {{ disciplina.ano_vigencia }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Semestre:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.semestre_vigencia %}
                                        {{ disciplina.get_semestre_vigencia_display }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-4">
                            <dl class="row">
                                <dt class="col-sm-6">Carga Horária Total:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.carga_horaria %}
                                        <strong>{{ disciplina.carga_horaria }} horas</strong>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Carga Horária Teórica:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.carga_horaria_teorica %}
                                        {{ disciplina.carga_horaria_teorica }} horas
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Carga Horária Prática:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.carga_horaria_pratica %}
                                        {{ disciplina.carga_horaria_pratica }} horas
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Número de Encontros:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.numero_encontros %}
                                        {{ disciplina.numero_encontros }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Carga Máx./Dia:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.carga_horaria_maxima_dia %}
                                        {{ disciplina.carga_horaria_maxima_dia }} horas
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Média Mínima:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.media_minima_aprovacao %}
                                        <strong>{{ disciplina.media_minima_aprovacao }}</strong>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Frequência Mínima:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.frequencia_minima %}
                                        <strong>{{ disciplina.frequencia_minima }}%</strong>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-6">Registro Frequência:</dt>
                                <dd class="col-sm-6">
                                    {% if disciplina.forma_registro_frequencia %}
                                        <small>{{ disciplina.get_forma_registro_frequencia_display }}</small>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-4">
                            <dl class="row">
                                <dt class="col-sm-5">Substituível:</dt>
                                <dd class="col-sm-7">
                                    {% if disciplina.disciplina_substituivel %}
                                        <span class="badge bg-info">Sim</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Não</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Data de Criação:</dt>
                                <dd class="col-sm-7">
                                    <small>{{ disciplina.data_criacao|date:"d/m/Y H:i" }}</small>
                                </dd>
                                
                                <dt class="col-sm-5">Última Atualização:</dt>
                                <dd class="col-sm-7">
                                    <small>{{ disciplina.data_atualizacao|date:"d/m/Y H:i" }}</small>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Descrição e Objetivos -->
    {% if disciplina.descricao_geral or disciplina.objetivos or disciplina.competencias_desenvolvidas %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionDescricao">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDescricao">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDescricao" aria-expanded="false" aria-controls="collapseDescricao">
                            <i class="fas fa-bullseye me-2"></i>
                            Descrição e Objetivos
                        </button>
                    </h2>
                    <div id="collapseDescricao" class="accordion-collapse collapse" aria-labelledby="headingDescricao" data-bs-parent="#accordionDescricao">
                        <div class="accordion-body">
                    {% if disciplina.descricao_geral %}
                    <div class="mb-3">
                        <h6>Descrição Geral:</h6>
                        <p>{{ disciplina.descricao_geral|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.objetivos %}
                    <div class="mb-3">
                        <h6>Objetivos:</h6>
                        <p>{{ disciplina.objetivos|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.competencias_desenvolvidas %}
                    <div>
                        <h6>Competências Desenvolvidas:</h6>
                        <p>{{ disciplina.competencias_desenvolvidas|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Requisitos -->
    {% if disciplina.requisitos_matricula or disciplina.materiais_obrigatorios or disciplina.requisitos_infraestrutura %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionRequisitos">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingRequisitos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRequisitos" aria-expanded="false" aria-controls="collapseRequisitos">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Requisitos
                        </button>
                    </h2>
                    <div id="collapseRequisitos" class="accordion-collapse collapse" aria-labelledby="headingRequisitos" data-bs-parent="#accordionRequisitos">
                        <div class="accordion-body">
                    {% if disciplina.requisitos_matricula %}
                    <div class="mb-3">
                        <h6>Requisitos de Matrícula:</h6>
                        <p>{{ disciplina.requisitos_matricula|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.materiais_obrigatorios %}
                    <div class="mb-3">
                        <h6>Materiais Obrigatórios:</h6>
                        <p>{{ disciplina.materiais_obrigatorios|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.requisitos_infraestrutura %}
                    <div>
                        <h6>Requisitos de Infraestrutura:</h6>
                        <p>{{ disciplina.requisitos_infraestrutura|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Estrutura Didática -->
    {% if disciplina.ementa or disciplina.conteudo_programatico or disciplina.metodologia_ensino or disciplina.cronograma_sugerido %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionEstrutura">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEstrutura">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEstrutura" aria-expanded="false" aria-controls="collapseEstrutura">
                            <i class="fas fa-book-reader me-2"></i>
                            Estrutura Didática
                        </button>
                    </h2>
                    <div id="collapseEstrutura" class="accordion-collapse collapse" aria-labelledby="headingEstrutura" data-bs-parent="#accordionEstrutura">
                        <div class="accordion-body">
                    {% if disciplina.ementa %}
                    <div class="mb-3">
                        <h6>Ementa:</h6>
                        <p>{{ disciplina.ementa|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.conteudo_programatico %}
                    <div class="mb-3">
                        <h6>Conteúdo Programático:</h6>
                        <div>{{ disciplina.conteudo_programatico|linebreaks }}</div>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.metodologia_ensino %}
                    <div class="mb-3">
                        <h6>Metodologia de Ensino:</h6>
                        <p>{{ disciplina.metodologia_ensino|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.cronograma_sugerido %}
                    <div>
                        <h6>Cronograma Sugerido:</h6>
                        <p>{{ disciplina.cronograma_sugerido|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Avaliação -->
    {% if disciplina.metodos_avaliacao or disciplina.criterios_avaliacao %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionAvaliacao">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingAvaliacao">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvaliacao" aria-expanded="false" aria-controls="collapseAvaliacao">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Avaliação
                        </button>
                    </h2>
                    <div id="collapseAvaliacao" class="accordion-collapse collapse" aria-labelledby="headingAvaliacao" data-bs-parent="#accordionAvaliacao">
                        <div class="accordion-body">
                    {% if disciplina.metodos_avaliacao %}
                    <div class="mb-3">
                        <h6>Métodos de Avaliação:</h6>
                        <p>{{ disciplina.metodos_avaliacao|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.criterios_avaliacao %}
                    <div>
                        <h6>Critérios de Avaliação:</h6>
                        <p>{{ disciplina.criterios_avaliacao|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Monitores -->
    {% if disciplina.monitores_militares.all or disciplina.monitores_externos.all %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionMonitores">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMonitores">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMonitores" aria-expanded="false" aria-controls="collapseMonitores">
                            <i class="fas fa-users me-2"></i>
                            Monitores
                        </button>
                    </h2>
                    <div id="collapseMonitores" class="accordion-collapse collapse" aria-labelledby="headingMonitores" data-bs-parent="#accordionMonitores">
                        <div class="accordion-body">
                    {% if disciplina.monitores_militares.all %}
                    <div class="mb-3">
                        <h6>Monitores Militares:</h6>
                        <ul class="list-unstyled">
                            {% for monitor in disciplina.monitores_militares.all %}
                            <li>
                                <span class="badge bg-primary">Militar</span>
                                {{ monitor.get_posto_graduacao_display }} {{ monitor.nome_completo }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.monitores_externos.all %}
                    <div>
                        <h6>Monitores Externos:</h6>
                        <ul class="list-unstyled">
                            {% for monitor in disciplina.monitores_externos.all %}
                            <li>
                                <span class="badge bg-info">Externo</span>
                                {{ monitor.get_nome_completo }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Cursos que usam esta disciplina -->
    {% if cursos %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionCursos">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCursos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCursos" aria-expanded="false" aria-controls="collapseCursos">
                            <i class="fas fa-list-ul me-2"></i>
                            Cursos que utilizam esta Disciplina
                            <span class="badge bg-light text-dark ms-2">{{ cursos.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseCursos" class="accordion-collapse collapse" aria-labelledby="headingCursos" data-bs-parent="#accordionCursos">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome do Curso</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for curso in cursos %}
                                <tr>
                                    <td><strong>{{ curso.codigo }}</strong></td>
                                    <td>{{ curso.nome }}</td>
                                    <td>
                                        {% if curso.ativo %}
                                            <span class="badge bg-success">Ativo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inativo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'militares:ensino_curso_detalhes' pk=curso.pk %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Notas por Turma e Aluno -->
    {% if notas_por_turma %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionNotas">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNotas">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotas" aria-expanded="false" aria-controls="collapseNotas">
                            <i class="fas fa-chart-line me-2"></i>
                            Notas por Turma e Aluno
                        </button>
                    </h2>
                    <div id="collapseNotas" class="accordion-collapse collapse" aria-labelledby="headingNotas" data-bs-parent="#accordionNotas">
                        <div class="accordion-body">
                            <div class="accordion" id="turmasAccordion">
                                {% for turma_id, dados_turma in notas_por_turma.items %}
                                <div class="accordion-item mb-2">
                                    <h2 class="accordion-header" id="headingTurma{{ turma_id }}">
                                        <button class="accordion-button collapsed" style="background-color: #17a2b8; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTurma{{ turma_id }}" aria-expanded="false" aria-controls="collapseTurma{{ turma_id }}">
                                            <i class="fas fa-users me-2"></i>
                                            <strong>{{ dados_turma.turma.identificacao }}</strong>
                                            <span class="badge bg-light text-dark ms-2">{{ dados_turma.turma.curso.nome }}</span>
                                            <span class="badge bg-light text-dark ms-2">
                                                {{ dados_turma.alunos|length }} aluno(s)
                                            </span>
                                        </button>
                                    </h2>
                                    <div id="collapseTurma{{ turma_id }}" class="accordion-collapse collapse" aria-labelledby="headingTurma{{ turma_id }}" data-bs-parent="#turmasAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Matrícula</th>
                                                            <th>Aluno</th>
                                                            <th class="text-center">1ª</th>
                                                            <th class="text-center">2ª</th>
                                                            <th class="text-center">3ª</th>
                                                            <th class="text-center">4ª</th>
                                                            <th class="text-center"><strong>Média Final</strong></th>
                                                            <th class="text-center"><strong>Status</strong></th>
                                                            <th class="text-center"><strong>Nota Recuperação</strong></th>
                                                            <th class="text-center"><strong>Revisão</strong></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for aluno_id, dados_aluno in dados_turma.alunos.items %}
                                                        <tr>
                                                            <td><strong>{{ dados_aluno.aluno.matricula|default:"-" }}</strong></td>
                                                            <td>
                                                                {% if dados_aluno.aluno.militar %}
                                                                    {{ dados_aluno.aluno.militar.get_posto_graduacao_display }} {{ dados_aluno.aluno.militar.nome_completo }}
                                                                {% elif dados_aluno.aluno.pessoa_externa %}
                                                                    {{ dados_aluno.aluno.pessoa_externa.get_nome_completo }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.notas.0 is not None %}
                                                                    {{ dados_aluno.notas.0|floatformat:2 }}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.notas.1 is not None %}
                                                                    {{ dados_aluno.notas.1|floatformat:2 }}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.notas.2 is not None %}
                                                                    {{ dados_aluno.notas.2|floatformat:2 }}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.notas.3 is not None %}
                                                                    {{ dados_aluno.notas.3|floatformat:2 }}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.media_final is not None %}
                                                                    <strong class="{% if dados_aluno.status == 'APROVADO' %}text-success{% elif dados_aluno.status == 'RECUPERACAO' %}text-warning{% else %}text-danger{% endif %}">
                                                                        {{ dados_aluno.media_final|floatformat:2 }}
                                                                    </strong>
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.status %}
                                                                    {% if dados_aluno.status == 'APROVADO' %}
                                                                        <span class="badge bg-success">Aprovado</span>
                                                                    {% elif dados_aluno.status == 'RECUPERACAO' %}
                                                                        <span class="badge bg-warning text-dark">Recuperação</span>
                                                                    {% elif dados_aluno.status == 'REPROVADO' %}
                                                                        <span class="badge bg-danger">Reprovado</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if dados_aluno.status == 'RECUPERACAO' and dados_aluno.nota_recuperacao is not None %}
                                                                    <strong class="text-warning">
                                                                        {{ dados_aluno.nota_recuperacao|floatformat:2 }}
                                                                    </strong>
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="text-center">
                                                                {% if aluno_ensino and dados_aluno.aluno.pk == aluno_ensino.pk or request.session.ensino_tipo == 'aluno' and request.session.ensino_id == dados_aluno.aluno.pk %}
                                                                    {% if dados_aluno.nota_ids.0 %}
                                                                        {% if dados_aluno.revisao_status.0 %}
                                                                            <span class="badge bg-secondary" title="{{ dados_aluno.revisao_status.0 }}">1ª</span>
                                                                        {% else %}
                                                                            <a href="{% url 'militares:ensino_solicitar_revisao_prova' nota_id=dados_aluno.nota_ids.0 %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary me-1" title="Revisão 1ª">
                                                                                1ª
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if dados_aluno.nota_ids.1 %}
                                                                        {% if dados_aluno.revisao_status.1 %}
                                                                            <span class="badge bg-secondary" title="{{ dados_aluno.revisao_status.1 }}">2ª</span>
                                                                        {% else %}
                                                                            <a href="{% url 'militares:ensino_solicitar_revisao_prova' nota_id=dados_aluno.nota_ids.1 %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary me-1" title="Revisão 2ª">
                                                                                2ª
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if dados_aluno.nota_ids.2 %}
                                                                        {% if dados_aluno.revisao_status.2 %}
                                                                            <span class="badge bg-secondary" title="{{ dados_aluno.revisao_status.2 }}">3ª</span>
                                                                        {% else %}
                                                                            <a href="{% url 'militares:ensino_solicitar_revisao_prova' nota_id=dados_aluno.nota_ids.2 %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary me-1" title="Revisão 3ª">
                                                                                3ª
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if dados_aluno.nota_ids.3 %}
                                                                        {% if dados_aluno.revisao_status.3 %}
                                                                            <span class="badge bg-secondary" title="{{ dados_aluno.revisao_status.3 }}">4ª</span>
                                                                        {% else %}
                                                                            <a href="{% url 'militares:ensino_solicitar_revisao_prova' nota_id=dados_aluno.nota_ids.3 %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-primary me-1" title="Revisão 4ª">
                                                                                4ª
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if dados_aluno.nota_recuperacao_id %}
                                                                        {% if dados_aluno.revisao_status_rec %}
                                                                            <span class="badge bg-secondary" title="{{ dados_aluno.revisao_status_rec }}">Rec</span>
                                                                        {% else %}
                                                                            <a href="{% url 'militares:ensino_solicitar_revisao_prova' nota_id=dados_aluno.nota_recuperacao_id %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-warning" title="Revisão Recuperação">
                                                                                Rec
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if not dados_aluno.nota_ids.0 and not dados_aluno.nota_ids.1 and not dados_aluno.nota_ids.2 and not dados_aluno.nota_ids.3 and not dados_aluno.nota_recuperacao_id %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Pré-requisitos -->
    {% if disciplina.pre_requisitos_disciplinas.all %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionPreRequisitos">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPreRequisitos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreRequisitos" aria-expanded="false" aria-controls="collapsePreRequisitos">
                            <i class="fas fa-sitemap me-2"></i>
                            Pré-requisitos
                        </button>
                    </h2>
                    <div id="collapsePreRequisitos" class="accordion-collapse collapse" aria-labelledby="headingPreRequisitos" data-bs-parent="#accordionPreRequisitos">
                        <div class="accordion-body">
                    <ul class="list-unstyled">
                        {% for pre_req in disciplina.pre_requisitos_disciplinas.all %}
                        <li>
                            <a href="{% url 'militares:ensino_disciplina_detalhes' pk=pre_req.pk %}" class="text-decoration-none">
                                <i class="fas fa-book me-1"></i>{{ pre_req.codigo }} - {{ pre_req.nome }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Materiais e Equipamentos -->
    {% if disciplina.materiais_utilizados or disciplina.equipamentos_necessarios %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionMateriaisEquipamentos">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMateriaisEquipamentos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMateriaisEquipamentos" aria-expanded="false" aria-controls="collapseMateriaisEquipamentos">
                            <i class="fas fa-tools me-2"></i>
                            Materiais e Equipamentos
                        </button>
                    </h2>
                    <div id="collapseMateriaisEquipamentos" class="accordion-collapse collapse" aria-labelledby="headingMateriaisEquipamentos" data-bs-parent="#accordionMateriaisEquipamentos">
                        <div class="accordion-body">
                    {% if disciplina.materiais_utilizados %}
                    <div class="mb-3">
                        <h6>Materiais Utilizados em Aula:</h6>
                        <p>{{ disciplina.materiais_utilizados|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.equipamentos_necessarios %}
                    <div>
                        <h6>Equipamentos Necessários:</h6>
                        <p>{{ disciplina.equipamentos_necessarios|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Segurança e Procedimentos Operacionais -->
    {% if disciplina.normas_seguranca or disciplina.riscos_envolvidos or disciplina.epis_obrigatorios or disciplina.procedimentos_emergencia %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionSeguranca">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSeguranca">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeguranca" aria-expanded="false" aria-controls="collapseSeguranca">
                            <i class="fas fa-shield-alt me-2"></i>
                            Segurança e Procedimentos Operacionais
                        </button>
                    </h2>
                    <div id="collapseSeguranca" class="accordion-collapse collapse" aria-labelledby="headingSeguranca" data-bs-parent="#accordionSeguranca">
                        <div class="accordion-body">
                    {% if disciplina.normas_seguranca %}
                    <div class="mb-3">
                        <h6>Normas de Segurança Aplicáveis:</h6>
                        <p>{{ disciplina.normas_seguranca|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.riscos_envolvidos %}
                    <div class="mb-3">
                        <h6>Riscos Envolvidos:</h6>
                        <p>{{ disciplina.riscos_envolvidos|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.epis_obrigatorios %}
                    <div class="mb-3">
                        <h6>EPIs Obrigatórios:</h6>
                        <p>{{ disciplina.epis_obrigatorios|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if disciplina.procedimentos_emergencia %}
                    <div>
                        <h6>Procedimentos em Caso de Incidente/Emergência:</h6>
                        <p>{{ disciplina.procedimentos_emergencia|linebreaks }}</p>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Observações Administrativas -->
    {% if disciplina.observacoes_administrativas %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionObservacoes">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingObservacoes">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseObservacoes" aria-expanded="false" aria-controls="collapseObservacoes">
                            <i class="fas fa-sticky-note me-2"></i>
                            Observações Administrativas
                        </button>
                    </h2>
                    <div id="collapseObservacoes" class="accordion-collapse collapse" aria-labelledby="headingObservacoes" data-bs-parent="#accordionObservacoes">
                        <div class="accordion-body">
                    <p>{{ disciplina.observacoes_administrativas|linebreaks }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Materiais e Recursos -->
    {% if disciplina.plano_ensino or disciplina.documentos.all or disciplina.links_uteis.all %}
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-3" id="accordionMateriaisRecursos">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMateriaisRecursos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMateriaisRecursos" aria-expanded="false" aria-controls="collapseMateriaisRecursos">
                            <i class="fas fa-toolbox me-2"></i>
                            Materiais e Recursos
                        </button>
                    </h2>
                    <div id="collapseMateriaisRecursos" class="accordion-collapse collapse" aria-labelledby="headingMateriaisRecursos" data-bs-parent="#accordionMateriaisRecursos">
                        <div class="accordion-body">
                    <!-- Plano de Ensino -->
                    {% if disciplina.plano_ensino %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-file-alt me-2"></i>Plano de Ensino
                        </h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        <strong>Plano de Ensino</strong>
                                    </div>
                                    <a href="{{ disciplina.plano_ensino.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Arquivos Complementares -->
                    {% if disciplina.documentos.all %}
                        {% with arquivos_complementares=disciplina.documentos.all|dictsort:"tipo" %}
                            {% if arquivos_complementares %}
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-file-upload me-2"></i>Arquivos Complementares
                                    <span class="badge bg-secondary ms-2">{{ arquivos_complementares|length }}</span>
                                </h6>
                                <div class="row">
                                    {% for doc in arquivos_complementares %}
                                        {% if doc.tipo == 'ARQUIVO_COMPLEMENTAR' %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div class="flex-grow-1">
                                                            <h6 class="card-title mb-1">
                                                                <i class="fas fa-file me-2 text-primary"></i>
                                                                {{ doc.titulo }}
                                                            </h6>
                                                            {% if doc.descricao %}
                                                            <p class="text-muted small mb-2">{{ doc.descricao|truncatewords:15 }}</p>
                                                            {% endif %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-calendar me-1"></i>
                                                                {{ doc.data_upload|date:"d/m/Y H:i" }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye me-1"></i>Visualizar
                                                        </a>
                                                        <a href="{{ doc.arquivo.url }}" download class="btn btn-sm btn-outline-success">
                                                            <i class="fas fa-download me-1"></i>Download
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                    
                    <!-- Links Úteis -->
                    {% if disciplina.links_uteis.all %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-link me-2"></i>Links Úteis
                            <span class="badge bg-secondary ms-2">{{ disciplina.links_uteis.all|length }}</span>
                        </h6>
                        <div class="row">
                            {% for link in disciplina.links_uteis.all %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <i class="fas fa-external-link-alt me-2 text-info"></i>
                                                    {{ link.titulo }}
                                                </h6>
                                                {% if link.descricao %}
                                                <p class="text-muted small mb-2">{{ link.descricao|truncatewords:15 }}</p>
                                                {% endif %}
                                                <small class="text-muted d-block mb-2">
                                                    <i class="fas fa-globe me-1"></i>
                                                    <a href="{{ link.url }}" target="_blank" class="text-decoration-none" rel="noopener noreferrer">
                                                        {{ link.url|truncatechars:50 }}
                                                    </a>
                                                </small>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    {{ link.data_criacao|date:"d/m/Y H:i" }}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-info" rel="noopener noreferrer">
                                                <i class="fas fa-external-link-alt me-1"></i>Abrir Link
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Mensagem quando não há materiais -->
                    {% if not disciplina.plano_ensino and not disciplina.documentos.all and not disciplina.links_uteis.all %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhum material ou link cadastrado para esta disciplina.
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Editar Disciplina -->
<div class="modal fade" id="editarDisciplinaModal{{ disciplina.pk }}" tabindex="-1" aria-labelledby="editarDisciplinaModalLabel{{ disciplina.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" id="editarDisciplinaModalContent{{ disciplina.pk }}">
            <!-- Conteúdo será carregado via AJAX -->
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando formulário...</p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
        const disciplinaId = '{{ disciplina.pk }}';
        const editarDisciplinaBtn = document.getElementById('btnEditarDisciplina' + disciplinaId);
        const modalElement = document.getElementById('editarDisciplinaModal' + disciplinaId);
        const modalContent = document.getElementById('editarDisciplinaModalContent' + disciplinaId);
        
        // Verificar se todos os elementos existem
        if (!editarDisciplinaBtn || !modalElement || !modalContent) {
            console.error('Elementos não encontrados:', {
                botao: !!editarDisciplinaBtn,
                modal: !!modalElement,
                conteudo: !!modalContent,
                disciplinaId: disciplinaId
            });
            return;
        }
        
        // Função para mostrar loading
        function mostrarLoading() {
            modalContent.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            `;
        }
        
        // Função para carregar o formulário via AJAX
        function carregarFormularioEdicao() {
            mostrarLoading();
            
            const url = '{% url "militares:ensino_disciplina_editar" pk=disciplina.pk %}';
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Erro HTTP: ' + response.status);
                }
                return response.text();
            })
            .then(function(html) {
                modalContent.innerHTML = html;
                
                // Re-executar scripts do conteúdo carregado
                setTimeout(function() {
                    const scripts = modalContent.querySelectorAll('script');
                    scripts.forEach(function(oldScript) {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(function(attr) {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        if (oldScript.parentNode) {
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        }
                    });
                }, 100);
            })
            .catch(function(error) {
                console.error('Erro ao carregar formulário:', error);
                modalContent.innerHTML = `
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Erro
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5>Erro ao Carregar</h5>
                        <p class="text-muted">Não foi possível carregar o formulário. Tente novamente.</p>
                        <p class="text-muted"><small>Erro: ${error.message}</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                `;
            });
        }
        
        // Listener do botão para abrir o modal
        editarDisciplinaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log('Botão clicado. Abrindo modal...');
            console.log('Modal element:', modalElement);
            
            // Garantir que o modal seja aberto
            if (modalElement) {
                // Tentar usar Bootstrap primeiro
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        var modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (!modalInstance) {
                            modalInstance = new bootstrap.Modal(modalElement);
                        }
                        modalInstance.show();
                        console.log('Modal aberto via Bootstrap API');
                        return;
                    } catch (err) {
                        console.error('Erro ao abrir modal via Bootstrap:', err);
                    }
                }
                
                // Fallback para jQuery Bootstrap
                if (typeof $ !== 'undefined' && $.fn.modal) {
                    $(modalElement).modal('show');
                    console.log('Modal aberto via jQuery Bootstrap');
                    return;
                }
                
                // Último recurso: abrir manualmente
                console.log('Abrindo modal manualmente...');
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
                document.body.style.overflow = 'hidden';
                document.body.style.paddingRight = '0px';
                
                // Adicionar backdrop
                var backdrop = document.getElementById('modalBackdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'modalBackdrop';
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                }
                
                // Disparar evento show.bs.modal manualmente
                var showEvent = new Event('show.bs.modal', { bubbles: true });
                modalElement.dispatchEvent(showEvent);
            } else {
                console.error('Modal element não encontrado!');
            }
        });
        
        // Evento quando o modal está prestes a ser mostrado
        modalElement.addEventListener('show.bs.modal', function(event) {
            carregarFormularioEdicao();
        });
        
        // Limpar conteúdo quando fechar o modal
        modalElement.addEventListener('hidden.bs.modal', function() {
            mostrarLoading();
        });
    });
})();
</script>
{% endblock %}

