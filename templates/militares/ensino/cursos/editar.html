{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Curso - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="fas fa-edit me-2"></i>
                Editar Curso
            </h1>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Editar Curso
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- 1. Identificação Geral -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-info-circle me-2"></i>1. Identificação Geral
                        </h5>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.nome.id_for_label }}" class="form-label">
                                        Nome do Curso <span class="text-danger">*</span>
                                    </label>
                                    {{ form.nome }}
                                    {% if form.nome.errors %}
                                        <div class="text-danger">{{ form.nome.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.codigo.id_for_label }}" class="form-label">
                                        Código do Curso <span class="text-danger">*</span>
                                    </label>
                                    {{ form.codigo }}
                                    {% if form.codigo.errors %}
                                        <div class="text-danger">{{ form.codigo.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Ex: CBM-OP-2025</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.tipo_curso.id_for_label }}" class="form-label">
                                        Tipo de Curso
                                    </label>
                                    {{ form.tipo_curso }}
                                    {% if form.tipo_curso.errors %}
                                        <div class="text-danger">{{ form.tipo_curso.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.modalidade.id_for_label }}" class="form-label">
                                        Modalidade
                                    </label>
                                    {{ form.modalidade }}
                                    {% if form.modalidade.errors %}
                                        <div class="text-danger">{{ form.modalidade.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 2. Descrição e Objetivos -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-bullseye me-2"></i>2. Descrição e Objetivos
                        </h5>
                        <div class="mb-3">
                            <label for="{{ form.descricao_resumida.id_for_label }}" class="form-label">
                                Descrição Resumida
                            </label>
                            {{ form.descricao_resumida }}
                            {% if form.descricao_resumida.errors %}
                                <div class="text-danger">{{ form.descricao_resumida.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.finalidade.id_for_label }}" class="form-label">
                                Objetivo Geral / Finalidade <span class="text-danger">*</span>
                            </label>
                            {{ form.finalidade }}
                            {% if form.finalidade.errors %}
                                <div class="text-danger">{{ form.finalidade.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.objetivos_especificos.id_for_label }}" class="form-label">
                                Objetivos Específicos
                            </label>
                            {{ form.objetivos_especificos }}
                            {% if form.objetivos_especificos.errors %}
                                <div class="text-danger">{{ form.objetivos_especificos.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.competencias_habilidades.id_for_label }}" class="form-label">
                                Competências e Habilidades Desenvolvidas
                            </label>
                            {{ form.competencias_habilidades }}
                            {% if form.competencias_habilidades.errors %}
                                <div class="text-danger">{{ form.competencias_habilidades.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.publico_alvo.id_for_label }}" class="form-label">
                                        Público-Alvo <span class="text-danger">*</span>
                                    </label>
                                    {{ form.publico_alvo }}
                                    {% if form.publico_alvo.errors %}
                                        <div class="text-danger">{{ form.publico_alvo.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Ex: crianças, militares, praças, oficiais, comunidade, etc.</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 3. Carga Horária -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-clock me-2"></i>3. Carga Horária
                        </h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.carga_horaria.id_for_label }}" class="form-label">
                                        Carga Horária Total (horas) <span class="text-danger">*</span>
                                    </label>
                                    {{ form.carga_horaria }}
                                    {% if form.carga_horaria.errors %}
                                        <div class="text-danger">{{ form.carga_horaria.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.carga_horaria_minima_aprovacao.id_for_label }}" class="form-label">
                                        Carga Horária Mínima para Aprovação
                                    </label>
                                    {{ form.carga_horaria_minima_aprovacao }}
                                    {% if form.carga_horaria_minima_aprovacao.errors %}
                                        <div class="text-danger">{{ form.carga_horaria_minima_aprovacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.horas_teoricas.id_for_label }}" class="form-label">
                                        Horas Teóricas
                                    </label>
                                    {{ form.horas_teoricas }}
                                    {% if form.horas_teoricas.errors %}
                                        <div class="text-danger">{{ form.horas_teoricas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.horas_praticas.id_for_label }}" class="form-label">
                                        Horas Práticas
                                    </label>
                                    {{ form.horas_praticas }}
                                    {% if form.horas_praticas.errors %}
                                        <div class="text-danger">{{ form.horas_praticas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="{{ form.horas_complementares.id_for_label }}" class="form-label">
                                        Horas Complementares
                                    </label>
                                    {{ form.horas_complementares }}
                                    {% if form.horas_complementares.errors %}
                                        <div class="text-danger">{{ form.horas_complementares.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.duracao_prevista_dias.id_for_label }}" class="form-label">
                                        Duração Prevista (dias)
                                    </label>
                                    {{ form.duracao_prevista_dias }}
                                    {% if form.duracao_prevista_dias.errors %}
                                        <div class="text-danger">{{ form.duracao_prevista_dias.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.duracao_prevista_semanas.id_for_label }}" class="form-label">
                                        Duração Prevista (semanas)
                                    </label>
                                    {{ form.duracao_prevista_semanas }}
                                    {% if form.duracao_prevista_semanas.errors %}
                                        <div class="text-danger">{{ form.duracao_prevista_semanas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.duracao_prevista_meses.id_for_label }}" class="form-label">
                                        Duração Prevista (meses)
                                    </label>
                                    {{ form.duracao_prevista_meses }}
                                    {% if form.duracao_prevista_meses.errors %}
                                        <div class="text-danger">{{ form.duracao_prevista_meses.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 4. Estrutura Curricular -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-list-ul me-2"></i>4. Estrutura Curricular
                        </h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-list me-1"></i>Disciplinas Disponíveis
                                </label>
                                <div class="border rounded p-2 bg-light" style="max-height: 400px; overflow-y: auto;">
                                    <div class="mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasDisciplinas()">
                                            <i class="fas fa-check-double me-1"></i>Selecionar Todas
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodasDisciplinas()">
                                            <i class="fas fa-times me-1"></i>Desmarcar Todas
                                        </button>
                                    </div>
                                    <div id="disciplinas-disponiveis">
                                        {% for disciplina in form.disciplinas.field.queryset %}
                                        <div class="form-check">
                                            <input class="form-check-input disciplina-checkbox" type="checkbox" 
                                                   value="{{ disciplina.pk }}" id="disc_{{ disciplina.pk }}"
                                                   data-disciplina-id="{{ disciplina.pk }}" data-disciplina-nome="{{ disciplina.nome }}"
                                                   {% if disciplina in curso.disciplinas.all %}disabled{% endif %}>
                                            <label class="form-check-label" for="disc_{{ disciplina.pk }}">
                                                <strong>{{ disciplina.nome }}</strong>
                                                {% if disciplina.codigo %}
                                                    <small class="text-muted">({{ disciplina.codigo }})</small>
                                                {% endif %}
                                            </label>
                                        </div>
                                        {% empty %}
                                        <p class="text-muted mb-0">Nenhuma disciplina cadastrada.</p>
                                        {% endfor %}
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="adicionarDisciplinasSelecionadas()">
                                    <i class="fas fa-arrow-right me-1"></i>Adicionar ao Curso
                                </button>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-check-square me-1"></i>Disciplinas do Curso
                                </label>
                                <div class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                                    <div id="disciplinas-curso">
                                        {% if curso.pk %}
                                            {% for disc_curso in curso.disciplinas.all %}
                                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded disciplina-item-curso" data-disciplina-id="{{ disc_curso.pk }}">
                                                <div>
                                                    <strong>{{ disc_curso.nome }}</strong>
                                                    {% if disc_curso.codigo %}
                                                        <small class="text-muted">({{ disc_curso.codigo }})</small>
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDisciplinaCurso({{ disc_curso.pk }}, this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <input type="hidden" name="disciplinas" value="{{ disc_curso.pk }}">
                                            </div>
                                            {% empty %}
                                            <p class="text-muted mb-0">Nenhuma disciplina vinculada.</p>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted mb-0">Nenhuma disciplina vinculada. Selecione disciplinas à esquerda e clique em "Adicionar ao Curso".</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Total: <span id="total-disciplinas-curso">{{ curso.disciplinas.count|default:0 }}</span> disciplina(s)
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% if form.disciplinas.errors %}
                            <div class="text-danger">{{ form.disciplinas.errors }}</div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="{{ form.matriz_curricular.id_for_label }}" class="form-label">
                                Matriz Curricular (Upload PDF)
                            </label>
                            {{ form.matriz_curricular }}
                            {% if form.matriz_curricular.errors %}
                                <div class="text-danger">{{ form.matriz_curricular.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.sequencia_recomendada.id_for_label }}" class="form-label">
                                Sequência Recomendada das Disciplinas
                            </label>
                            {{ form.sequencia_recomendada }}
                            {% if form.sequencia_recomendada.errors %}
                                <div class="text-danger">{{ form.sequencia_recomendada.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.possibilidade_equivalencia }}
                                <label class="form-check-label" for="{{ form.possibilidade_equivalencia.id_for_label }}">
                                    Possibilidade de Equivalência entre Disciplinas
                                </label>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 5. Requisitos do Curso -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-clipboard-list me-2"></i>5. Requisitos do Curso
                        </h5>
                        <div class="mb-3">
                            <label for="{{ form.requisitos_ingresso.id_for_label }}" class="form-label">
                                Requisitos de Ingresso
                            </label>
                            {{ form.requisitos_ingresso }}
                            {% if form.requisitos_ingresso.errors %}
                                <div class="text-danger">{{ form.requisitos_ingresso.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.idade_minima.id_for_label }}" class="form-label">
                                        Idade Mínima
                                    </label>
                                    {{ form.idade_minima }}
                                    {% if form.idade_minima.errors %}
                                        <div class="text-danger">{{ form.idade_minima.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.escolaridade_requerida.id_for_label }}" class="form-label">
                                        Escolaridade Requerida
                                    </label>
                                    {{ form.escolaridade_requerida }}
                                    {% if form.escolaridade_requerida.errors %}
                                        <div class="text-danger">{{ form.escolaridade_requerida.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.posto_graduacao_requerido.id_for_label }}" class="form-label">
                                        Posto/Graduação Requerido
                                    </label>
                                    {{ form.posto_graduacao_requerido }}
                                    {% if form.posto_graduacao_requerido.errors %}
                                        <div class="text-danger">{{ form.posto_graduacao_requerido.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.atestado_medico_obrigatorio }}
                                        <label class="form-check-label" for="{{ form.atestado_medico_obrigatorio.id_for_label }}">
                                            Atestado Médico Obrigatório
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.autorizacao_responsaveis }}
                                        <label class="form-check-label" for="{{ form.autorizacao_responsaveis.id_for_label }}">
                                            Autorização dos Responsáveis (se menor)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.teste_fisico_obrigatorio }}
                                        <label class="form-check-label" for="{{ form.teste_fisico_obrigatorio.id_for_label }}">
                                            Teste Físico (TAF) Obrigatório
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.documentos_obrigatorios.id_for_label }}" class="form-label">
                                Documentos Obrigatórios
                            </label>
                            {{ form.documentos_obrigatorios }}
                            {% if form.documentos_obrigatorios.errors %}
                                <div class="text-danger">{{ form.documentos_obrigatorios.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.uniformes_equipamentos.id_for_label }}" class="form-label">
                                Uniformes e Equipamentos Necessários
                            </label>
                            {{ form.uniformes_equipamentos }}
                            {% if form.uniformes_equipamentos.errors %}
                                <div class="text-danger">{{ form.uniformes_equipamentos.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 6. Avaliação do Curso -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-clipboard-check me-2"></i>6. Avaliação do Curso
                        </h5>
                        <div class="mb-3">
                            <label for="{{ form.criterios_gerais_avaliacao.id_for_label }}" class="form-label">
                                Critérios Gerais de Avaliação
                            </label>
                            {{ form.criterios_gerais_avaliacao }}
                            {% if form.criterios_gerais_avaliacao.errors %}
                                <div class="text-danger">{{ form.criterios_gerais_avaliacao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.formas_avaliacao.id_for_label }}" class="form-label">
                                Formas de Avaliação
                            </label>
                            {{ form.formas_avaliacao }}
                            {% if form.formas_avaliacao.errors %}
                                <div class="text-danger">{{ form.formas_avaliacao.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Ex: Prova teórica, Prática, Teste físico, Frequência, Trabalhos</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.media_minima_aprovacao.id_for_label }}" class="form-label">
                                        Média Mínima para Aprovação
                                    </label>
                                    {{ form.media_minima_aprovacao }}
                                    {% if form.media_minima_aprovacao.errors %}
                                        <div class="text-danger">{{ form.media_minima_aprovacao.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Nota mínima (0-10). Padrão: 7.0</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.percentual_frequencia_minima.id_for_label }}" class="form-label">
                                        Percentual Mínimo de Frequência
                                    </label>
                                    {{ form.percentual_frequencia_minima }}
                                    {% if form.percentual_frequencia_minima.errors %}
                                        <div class="text-danger">{{ form.percentual_frequencia_minima.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Padrão: 75%</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.formacao_notas.id_for_label }}" class="form-label">
                                Formação de Notas (peso por disciplina ou atividades)
                            </label>
                            {{ form.formacao_notas }}
                            {% if form.formacao_notas.errors %}
                                <div class="text-danger">{{ form.formacao_notas.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 7. Certificação -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-certificate me-2"></i>7. Certificação
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.tipo_certificado.id_for_label }}" class="form-label">
                                        Tipo de Certificado
                                    </label>
                                    {{ form.tipo_certificado }}
                                    {% if form.tipo_certificado.errors %}
                                        <div class="text-danger">{{ form.tipo_certificado.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.carga_horaria_certificada.id_for_label }}" class="form-label">
                                        Carga Horária Certificada
                                    </label>
                                    {{ form.carga_horaria_certificada }}
                                    {% if form.carga_horaria_certificada.errors %}
                                        <div class="text-danger">{{ form.carga_horaria_certificada.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.modelo_certificado.id_for_label }}" class="form-label">
                                Modelo do Certificado (Upload ou Template)
                            </label>
                            {{ form.modelo_certificado }}
                            {% if form.modelo_certificado.errors %}
                                <div class="text-danger">{{ form.modelo_certificado.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 8. Materiais e Recursos -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-toolbox me-2"></i>8. Materiais e Recursos
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.apostilas_pdfs.id_for_label }}" class="form-label">
                                        Apostilas / PDFs
                                    </label>
                                    {{ form.apostilas_pdfs }}
                                    {% if form.apostilas_pdfs.errors %}
                                        <div class="text-danger">{{ form.apostilas_pdfs.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manuais.id_for_label }}" class="form-label">
                                        Manuais
                                    </label>
                                    {{ form.manuais }}
                                    {% if form.manuais.errors %}
                                        <div class="text-danger">{{ form.manuais.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.videos_instrucionais.id_for_label }}" class="form-label">
                                Vídeos Instrucionais (Link)
                            </label>
                            {{ form.videos_instrucionais }}
                            {% if form.videos_instrucionais.errors %}
                                <div class="text-danger">{{ form.videos_instrucionais.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.equipamentos_necessarios.id_for_label }}" class="form-label">
                                Equipamentos Necessários
                            </label>
                            {{ form.equipamentos_necessarios }}
                            {% if form.equipamentos_necessarios.errors %}
                                <div class="text-danger">{{ form.equipamentos_necessarios.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.local_realizacao.id_for_label }}" class="form-label">
                                Local de Realização
                            </label>
                            {{ form.local_realizacao }}
                            {% if form.local_realizacao.errors %}
                                <div class="text-danger">{{ form.local_realizacao.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Ex: salas, pista, campo, piscina, etc.</small>
                        </div>
                        
                        <!-- Arquivos Complementares -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-upload me-1"></i>Arquivos Complementares
                            </label>
                            <div id="arquivos-complementares-container">
                                {% if curso.pk %}
                                    {% for doc in curso.documentos.all %}
                                        {% if doc.tipo == 'ARQUIVO_COMPLEMENTAR' %}
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded arquivo-complementar-item" data-doc-id="{{ doc.pk }}">
                                            <div>
                                                <i class="fas fa-file me-2"></i>
                                                <strong>{{ doc.titulo }}</strong>
                                                {% if doc.descricao %}
                                                    <br><small class="text-muted">{{ doc.descricao|truncatewords:10 }}</small>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-info me-1" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerArquivoComplementar({{ doc.pk }}, this)" title="Remover">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <input type="hidden" name="arquivos_complementares_remover[]" value="{{ doc.pk }}">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-primary" onclick="adicionarCampoArquivoComplementar()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Arquivo
                                </button>
                            </div>
                            <div id="novos-arquivos-complementares"></div>
                        </div>
                        
                        <!-- Links Úteis -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-1"></i>Links Úteis
                            </label>
                            <div id="links-uteis-container">
                                {% if curso.pk %}
                                    {% for link in curso.links_uteis.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded link-util-item" data-link-id="{{ link.pk }}">
                                        <div>
                                            <i class="fas fa-external-link-alt me-2"></i>
                                            <strong>{{ link.titulo }}</strong>
                                            <br><small class="text-muted">{{ link.url }}</small>
                                            {% if link.descricao %}
                                                <br><small class="text-muted">{{ link.descricao|truncatewords:10 }}</small>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-info me-1" title="Abrir Link">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerLinkUtil({{ link.pk }}, this)" title="Remover">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <input type="hidden" name="links_uteis_remover[]" value="{{ link.pk }}">
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-primary" onclick="adicionarCampoLinkUtil()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Link
                                </button>
                            </div>
                            <div id="novos-links-uteis"></div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 9. Segurança e Procedimentos Operacionais -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-shield-alt me-2"></i>9. Segurança e Procedimentos Operacionais
                        </h5>
                        <div class="mb-3">
                            <label for="{{ form.normas_seguranca.id_for_label }}" class="form-label">
                                Normas de Segurança Aplicáveis ao Curso
                            </label>
                            {{ form.normas_seguranca }}
                            {% if form.normas_seguranca.errors %}
                                <div class="text-danger">{{ form.normas_seguranca.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.riscos_envolvidos.id_for_label }}" class="form-label">
                                Riscos Envolvidos
                            </label>
                            {{ form.riscos_envolvidos }}
                            {% if form.riscos_envolvidos.errors %}
                                <div class="text-danger">{{ form.riscos_envolvidos.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.procedimentos_emergencia.id_for_label }}" class="form-label">
                                Procedimentos de Emergência
                            </label>
                            {{ form.procedimentos_emergencia }}
                            {% if form.procedimentos_emergencia.errors %}
                                <div class="text-danger">{{ form.procedimentos_emergencia.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.epis_necessarios.id_for_label }}" class="form-label">
                                EPIs Necessários
                            </label>
                            {{ form.epis_necessarios }}
                            {% if form.epis_necessarios.errors %}
                                <div class="text-danger">{{ form.epis_necessarios.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.planos_contingencia.id_for_label }}" class="form-label">
                                Planos de Contingência
                            </label>
                            {{ form.planos_contingencia }}
                            {% if form.planos_contingencia.errors %}
                                <div class="text-danger">{{ form.planos_contingencia.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 10. Informações Administrativas Extras -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-cog me-2"></i>10. Informações Administrativas Extras
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">
                                        Status do Curso
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger">{{ form.status.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.versao.id_for_label }}" class="form-label">
                                        Versão / Ano Letivo
                                    </label>
                                    {{ form.versao }}
                                    {% if form.versao.errors %}
                                        <div class="text-danger">{{ form.versao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.historico_versoes.id_for_label }}" class="form-label">
                                Histórico de Versões
                            </label>
                            {{ form.historico_versoes }}
                            {% if form.historico_versoes.errors %}
                                <div class="text-danger">{{ form.historico_versoes.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.observacoes_internas.id_for_label }}" class="form-label">
                                Observações Internas
                            </label>
                            {{ form.observacoes_internas }}
                            {% if form.observacoes_internas.errors %}
                                <div class="text-danger">{{ form.observacoes_internas.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Campos legados -->
                        <div class="mb-3">
                            <label for="{{ form.pre_requisitos.id_for_label }}" class="form-label">
                                Pré-requisitos (Legado)
                            </label>
                            {{ form.pre_requisitos }}
                            {% if form.pre_requisitos.errors %}
                                <div class="text-danger">{{ form.pre_requisitos.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.legislacao.id_for_label }}" class="form-label">
                                Legislação e Normas Internas
                            </label>
                            {{ form.legislacao }}
                            {% if form.legislacao.errors %}
                                <div class="text-danger">{{ form.legislacao.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.ementa.id_for_label }}" class="form-label">
                                        Ementa (Upload)
                                    </label>
                                    {{ form.ementa }}
                                    {% if form.ementa.errors %}
                                        <div class="text-danger">{{ form.ementa.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.plano_curso.id_for_label }}" class="form-label">
                                        Plano de Curso (Upload)
                                    </label>
                                    {{ form.plano_curso }}
                                    {% if form.plano_curso.errors %}
                                        <div class="text-danger">{{ form.plano_curso.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.ativo }}
                                <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                    Curso Ativo
                                </label>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- 11. Extras Avançados -->
                        <h5 class="mb-3 border-bottom pb-2">
                            <i class="fas fa-star me-2"></i>11. Extras Avançados
                        </h5>
                        <div class="mb-3">
                            <label for="{{ form.plano_pedagogico.id_for_label }}" class="form-label">
                                Plano Pedagógico Completo
                            </label>
                            {{ form.plano_pedagogico }}
                            {% if form.plano_pedagogico.errors %}
                                <div class="text-danger">{{ form.plano_pedagogico.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.carga_horaria_por_instrutor.id_for_label }}" class="form-label">
                                Carga Horária por Instrutor
                            </label>
                            {{ form.carga_horaria_por_instrutor }}
                            {% if form.carga_horaria_por_instrutor.errors %}
                                <div class="text-danger">{{ form.carga_horaria_por_instrutor.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.controle_vagas_reservadas }}
                                        <label class="form-check-label" for="{{ form.controle_vagas_reservadas.id_for_label }}">
                                            Controle de Vagas Reservadas
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.acompanhamento_individual }}
                                        <label class="form-check-label" for="{{ form.acompanhamento_individual.id_for_label }}">
                                            Acompanhamento Individual dos Alunos
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.registro_ocorrencias }}
                                        <label class="form-check-label" for="{{ form.registro_ocorrencias.id_for_label }}">
                                            Registro de Ocorrências
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.checklist_equipamentos_aluno.id_for_label }}" class="form-label">
                                Checklist de Equipamentos por Aluno
                            </label>
                            {{ form.checklist_equipamentos_aluno }}
                            {% if form.checklist_equipamentos_aluno.errors %}
                                <div class="text-danger">{{ form.checklist_equipamentos_aluno.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'militares:ensino_curso_detalhes' pk=curso.pk %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Atualizar Curso
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Funções para gerenciar disciplinas
    window.selecionarTodasDisciplinas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox:not(:disabled)');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = true;
        });
    };
    
    window.desmarcarTodasDisciplinas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    };
    
    window.adicionarDisciplinasSelecionadas = function() {
        const checkboxes = document.querySelectorAll('.disciplina-checkbox:checked:not(:disabled)');
        const containerCurso = document.getElementById('disciplinas-curso');
        
        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos uma disciplina.');
            return;
        }
        
        checkboxes.forEach(function(checkbox) {
            const disciplinaId = checkbox.getAttribute('data-disciplina-id');
            const disciplinaNome = checkbox.getAttribute('data-disciplina-nome');
            const disciplinaCodigo = checkbox.closest('.form-check').querySelector('small') ? 
                checkbox.closest('.form-check').querySelector('small').textContent : '';
            
            // Verificar se já não está no curso
            const jaExiste = containerCurso.querySelector('.disciplina-item-curso[data-disciplina-id="' + disciplinaId + '"]');
            if (jaExiste) {
                return; // Pular se já existe
            }
            
            // Remover mensagem de vazio se existir
            const msgVazio = containerCurso.querySelector('p.text-muted');
            if (msgVazio && msgVazio.textContent.includes('Nenhuma disciplina')) {
                msgVazio.remove();
            }
            
            // Criar item no curso
            const novoItem = document.createElement('div');
            novoItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded disciplina-item-curso';
            novoItem.setAttribute('data-disciplina-id', disciplinaId);
            novoItem.innerHTML = `
                <div>
                    <strong>${disciplinaNome}</strong>
                    ${disciplinaCodigo ? '<small class="text-muted">' + disciplinaCodigo + '</small>' : ''}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDisciplinaCurso(${disciplinaId}, this)">
                    <i class="fas fa-times"></i>
                </button>
                <input type="hidden" name="disciplinas" value="${disciplinaId}">
            `;
            containerCurso.appendChild(novoItem);
            
            // Desmarcar e desabilitar checkbox
            checkbox.checked = false;
            checkbox.disabled = true;
            checkbox.closest('.form-check').style.opacity = '0.5';
        });
        
        // Atualizar contador
        atualizarContadorDisciplinas();
    };
    
    window.removerDisciplinaCurso = function(disciplinaId, botao) {
        if (confirm('Tem certeza que deseja remover esta disciplina do curso?')) {
            const item = botao.closest('.disciplina-item-curso');
            if (item) {
                item.remove();
                
                // Reabilitar checkbox correspondente
                const checkbox = document.querySelector('.disciplina-checkbox[data-disciplina-id="' + disciplinaId + '"]');
                if (checkbox) {
                    checkbox.disabled = false;
                    checkbox.checked = false;
                    checkbox.closest('.form-check').style.opacity = '1';
                }
                
                // Se não houver mais disciplinas, mostrar mensagem
                const containerCurso = document.getElementById('disciplinas-curso');
                if (containerCurso.querySelectorAll('.disciplina-item-curso').length === 0) {
                    containerCurso.innerHTML = '<p class="text-muted mb-0">Nenhuma disciplina vinculada. Selecione disciplinas à esquerda e clique em "Adicionar ao Curso".</p>';
                }
                
                // Atualizar contador
                atualizarContadorDisciplinas();
            }
        }
    };
    
    function atualizarContadorDisciplinas() {
        const total = document.querySelectorAll('.disciplina-item-curso').length;
        const contador = document.getElementById('total-disciplinas-curso');
        if (contador) {
            contador.textContent = total;
        }
    }
    
    // Adicionar classes Bootstrap aos campos do formulário e inicializar disciplinas
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar form-control aos inputs de texto, email, number, etc.
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="url"]');
        inputs.forEach(input => {
            if (!input.classList.contains('form-control')) {
                input.classList.add('form-control');
            }
        });
        
        // Adicionar form-select aos selects
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            if (!select.classList.contains('form-select') && !select.classList.contains('form-control')) {
                select.classList.add('form-select');
            }
        });
        
        // Adicionar form-control aos textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            if (!textarea.classList.contains('form-control')) {
                textarea.classList.add('form-control');
            }
        });
        
        // Adicionar form-check-input aos checkboxes e radios
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:not(.form-check-input)');
        checkboxes.forEach(checkbox => {
            checkbox.classList.add('form-check-input');
        });
        
        const radios = document.querySelectorAll('input[type="radio"]:not(.form-check-input)');
        radios.forEach(radio => {
            radio.classList.add('form-check-input');
        });
        
        // Inicializar disciplinas
        inicializarDisciplinas();
    });
    
    function inicializarDisciplinas() {
        atualizarContadorDisciplinas();
        
        // Marcar checkboxes das disciplinas que já estão no curso (se estiver editando)
        const disciplinasNoCurso = document.querySelectorAll('.disciplina-item-curso');
        disciplinasNoCurso.forEach(function(item) {
            const disciplinaId = item.getAttribute('data-disciplina-id');
            const checkbox = document.querySelector('.disciplina-checkbox[data-disciplina-id="' + disciplinaId + '"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.closest('.form-check').style.opacity = '0.5';
            }
        });
    }
    
    // Funções para gerenciar arquivos complementares
    let contadorArquivos = 0;
    window.adicionarCampoArquivoComplementar = function() {
        contadorArquivos++;
        const container = document.getElementById('novos-arquivos-complementares');
        const novoItem = document.createElement('div');
        novoItem.className = 'mb-3 p-3 border rounded';
        novoItem.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Título do Arquivo</label>
                    <input type="text" name="arquivos_complementares_titulos[]" class="form-control" placeholder="Ex: Manual de Instruções">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Arquivo</label>
                    <input type="file" name="arquivos_complementares[]" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.mb-3').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">Descrição (opcional)</label>
                    <textarea name="arquivos_complementares_descricoes[]" class="form-control" rows="2" placeholder="Descrição do arquivo..."></textarea>
                </div>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    window.removerArquivoComplementar = function(docId, botao) {
        if (confirm('Tem certeza que deseja remover este arquivo?')) {
            const item = botao.closest('.arquivo-complementar-item');
            if (item) {
                item.remove();
            }
        }
    };
    
    // Funções para gerenciar links úteis
    let contadorLinks = 0;
    window.adicionarCampoLinkUtil = function() {
        contadorLinks++;
        const container = document.getElementById('novos-links-uteis');
        const novoItem = document.createElement('div');
        novoItem.className = 'mb-3 p-3 border rounded';
        novoItem.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Título do Link</label>
                    <input type="text" name="links_uteis_titulos[]" class="form-control" placeholder="Ex: Site Oficial">
                </div>
                <div class="col-md-5">
                    <label class="form-label">URL</label>
                    <input type="url" name="links_uteis_urls[]" class="form-control" placeholder="https://exemplo.com">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.mb-3').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">Descrição (opcional)</label>
                    <textarea name="links_uteis_descricoes[]" class="form-control" rows="2" placeholder="Descrição do link..."></textarea>
                </div>
            </div>
        `;
        container.appendChild(novoItem);
    };
    
    window.removerLinkUtil = function(linkId, botao) {
        if (confirm('Tem certeza que deseja remover este link?')) {
            const item = botao.closest('.link-util-item');
            if (item) {
                item.remove();
            }
        }
    };
</script>
{% endblock %}
