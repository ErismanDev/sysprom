# Imports para sistema de permiss√µes
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json
import time
# from .permissoes_simples import requer_sessao_ativa, requer_acesso_promocoes
from .decorators_hierarquia import requer_hierarquia_lotacao
from .permissoes_sistema import (
    requer_perm_militares_visualizar, requer_perm_militares_criar, requer_perm_militares_editar, requer_perm_militares_excluir, requer_perm_militares_admin,
    requer_perm_reordenar_antiguidade, tem_permissao,
    requer_perm_fichas_visualizar, requer_perm_fichas_criar, requer_perm_fichas_editar, requer_perm_fichas_aprovar, requer_perm_fichas_admin,
    requer_perm_quadros_visualizar, requer_perm_quadros_criar, requer_perm_quadros_editar, requer_perm_quadros_excluir, requer_perm_quadros_admin,
    requer_perm_promocoes_visualizar, requer_perm_promocoes_criar, requer_perm_promocoes_editar, requer_perm_promocoes_aprovar, requer_perm_promocoes_homologar, requer_perm_promocoes_admin,
    requer_perm_vagas_visualizar, requer_perm_vagas_criar, requer_perm_vagas_editar, requer_perm_vagas_excluir, requer_perm_vagas_admin,
    requer_perm_comissao_visualizar, requer_perm_comissao_criar, requer_perm_comissao_editar, requer_perm_comissao_excluir, requer_perm_comissao_assinar, requer_perm_comissao_admin,
    requer_perm_documentos_visualizar, requer_perm_documentos_criar, requer_perm_documentos_editar, requer_perm_documentos_excluir, requer_perm_documentos_gerar_pdf, requer_perm_documentos_imprimir, requer_perm_documentos_assinar, requer_perm_documentos_admin,
    requer_perm_usuarios_visualizar, requer_perm_usuarios_criar, requer_perm_usuarios_editar, requer_perm_usuarios_excluir, requer_perm_usuarios_admin,
    requer_perm_relatorios_visualizar, requer_perm_relatorios_gerar_pdf, requer_perm_relatorios_imprimir, requer_perm_relatorios_admin,
    requer_perm_configuracoes_visualizar, requer_perm_configuracoes_editar, requer_perm_configuracoes_admin,
)



from django.shortcuts import render, get_object_or_404, redirect
from django.core.files.base import ContentFile
from django.contrib import messages
from django.urls import reverse
from django.contrib.auth.decorators import login_required, user_passes_test, permission_required
from django.views.decorators.csrf import csrf_protect
from django.views.decorators.http import require_http_methods
from django.contrib.auth import update_session_auth_hash
from django.core.paginator import Paginator
from django.db.models import Q
from django.core.exceptions import ValidationError
from django.contrib.auth.password_validation import validate_password
from django.core.paginator import Paginator
from django.db.models import Q, Sum, Count
from django.db.models.deletion import ProtectedError
from django.http import JsonResponse, HttpResponse
from django.utils import timezone
from datetime import date, datetime
from django.contrib.auth.models import User, Group, Permission
from django.db import models, IntegrityError
from django.conf import settings
from .models import NotificacaoSessao, PermissaoSubmenu
from .models import NotificacaoSessao
from django.http import JsonResponse
from .models import NotificacaoSessao
from django.http import JsonResponse
from django.http import HttpResponse
from django.utils import timezone
from .models import NotificacaoSessao
from django.http import JsonResponse
from django.http import HttpResponse
from django.utils import timezone
from .models import NotificacaoSessao
from django.http import JsonResponse
from django.http import HttpResponse
from django.utils import timezone
from .models import Promocao
from .models import Vaga
from django import forms
from django.http import FileResponse
from django.http import FileResponse
from .models import JustificativaEncerramento
from .models import AtaSessao
from .forms import AtaSessaoForm, OrgaoForm, GrandeComandoForm, UnidadeForm, SubUnidadeForm, ElogioForm, PunicaoForm
from .models import AtaSessao
from .models import AtaSessao, AssinaturaAta
from .models import AtaSessao
from .models import Orgao, GrandeComando, Unidade, SubUnidade
from django.http import HttpResponse
from django.utils import timezone
from .models import AtaSessao
from django.utils import timezone
from .models import ModeloAta
from .models import ModeloAta
from .forms import ModeloAtaForm
from .models import ModeloAta
from .forms import ModeloAtaForm
from .models import ModeloAta
from .models import ModeloAta
from .models import SessaoComissao, ModeloAta, AtaSessao, MembroComissao
from .models import SessaoComissao, ModeloAta, AtaSessao, MembroComissao
from .forms import ModeloAtaForm
from django import forms
from .models import NotificacaoSessao
from .models import NotificacaoSessao
from .models import NotificacaoSessao
from .models import NotificacaoSessao
from django.db import models
from django.core.paginator import Paginator
from django.contrib.auth.models import User, Group, Permission
from django.contrib.contenttypes.models import ContentType
from django import forms
# from dal import autocomplete

# Importar views espec√≠ficas para pra√ßas
from .views_pracas_import import *
from .utils import calcular_proxima_data_promocao
from .models import (
    Militar, FichaConceitoOficiais, FichaConceitoPracas, QuadroAcesso, ItemQuadroAcesso, 
    Militar, FichaConceitoOficiais, FichaConceitoPracas, QuadroAcesso, ItemQuadroAcesso, 
    Promocao, Vaga, Curso, MedalhaCondecoracao, Documento, Intersticio, Qualificacao,
    Elogio, Punicao, Publicacao,
    POSTO_GRADUACAO_CHOICES, SITUACAO_CHOICES, QUADRO_CHOICES, TIPO_QUALIFICACAO_CHOICES, STATUS_VERIFICACAO_CHOICES,
    PrevisaoVaga, AssinaturaQuadroAcesso, AssinaturaQuadroFixacaoVagas, ComissaoPromocao, MembroComissao, SessaoComissao, PresencaSessao, DeliberacaoComissao, VotoDeliberacao, DocumentoSessao, AtaSessao, ModeloAta, CargoComissao,
    VagaManual, QuadroFixacaoVagas, ItemQuadroFixacaoVagas, UsuarioFuncaoMilitar,
    FuncaoMilitar, PermissaoFuncao, PerfilAcesso, CalendarioPromocao, ItemCalendarioPromocao,
    AssinaturaCalendarioPromocao, AlmanaqueMilitar, AssinaturaAlmanaque, LogSistema, MilitarFuncao
)
from .forms import MilitarForm, DocumentoForm, UserRegistrationForm, ConfirmarSenhaForm, ComissaoPromocaoForm, MembroComissaoForm, SessaoComissaoForm, DeliberacaoComissaoForm, DocumentoSessaoForm, AtaSessaoForm, ModeloAtaForm, CargoComissaoForm, FichaConceitoPracasForm, FichaConceitoOficiaisForm, UsuarioForm, FuncaoMilitarForm, QualificacaoForm, MilitarFuncaoForm
from .decorators import usuario_comissao_required, usuario_cpo_required, usuario_cpp_required, apenas_visualizacao_comissao, administracao_required, militar_edit_permission, comissao_acesso_total, cargos_especiais_required, can_edit_ficha_conceito, can_edit_militar, diretor_gestao_chefe_promocoes_required
from .admin_decorators import admin_bypass, admin_or_permission_required, admin_or_gerenciar_usuarios_required
# from .permissoes_simples import requer_gerenciamento_comissoes
from .permissoes import requer_funcao_ativa
from django import forms
from django.contrib.auth import authenticate
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from io import BytesIO
import qrcode
from reportlab.lib.utils import ImageReader
import os
from reportlab.lib.enums import TA_JUSTIFY
import re
from html import unescape
import logging
import unicodedata

@login_required
def teste_modal(request):
    """View tempor√°ria para testar modais Bootstrap"""
    return render(request, 'teste_bootstrap_modal.html')

@login_required
def teste_ficha_conceito_modal(request):
    """View tempor√°ria para testar modal da ficha de conceito"""
    return render(request, 'teste_ficha_conceito_modal.html')

@login_required
def teste_modal_debug(request):
    """View tempor√°ria para testar debug do modal"""
    return render(request, 'teste_modal_debug.html')

@login_required
def teste_modal_simples(request):
    """View tempor√°ria para testar modal simples"""
    return render(request, 'teste_modal_simples.html')

@login_required
@requer_funcao_ativa
def militar_list(request):
    """Lista todos os militares ativos com pagina√ß√£o e busca"""
    # Par√¢metros de filtro
    query = request.GET.get('q', '').strip()
    posto_param = request.GET.get('posto', '').strip()
    situacao_param = request.GET.get('situacao', '').strip()  # 'at' ou 'in'
    quadro_param = request.GET.get('quadro', '').strip()
    estrutura_param = request.GET.get('estrutura', '').strip()

    # Base: ativos por padr√£o
    if situacao_param == 'in':
        militares = Militar.objects.filter(classificacao='INATIVO')
    else:
        militares = Militar.objects.filter(classificacao='ATIVO')

    # Filtro por busca textual
    if query:
        militares = militares.filter(
            Q(nome_completo__icontains=query) |
            Q(nome_guerra__icontains=query) |
            Q(matricula__icontains=query) |
            Q(cpf__icontains=query)
        )

    # Filtro por posto/gradua√ß√£o (valores da UI v√™m min√∫sculos)
    posto_map = {
        '1s': '1S', '2s': '2S', '3s': '3S',
        'cab': 'CAB', 'sd': 'SD', 'nvrr': 'NVRR'
    }
    if posto_param:
        pg = posto_map.get(posto_param.lower())
        if pg:
            militares = militares.filter(posto_graduacao=pg)

    # Filtro por quadro
    if quadro_param:
        militares = militares.filter(quadro=quadro_param)

    # Filtro por estrutura organizacional selecionada
    if estrutura_param:
        try:
            tipo, id_str = estrutura_param.split('_', 1)
            alvo_id = int(id_str)
            from militares.models import Lotacao
            lotacoes_qs = Lotacao.objects.filter(ativo=True, status='ATUAL')
            if tipo == 'orgao':
                lotacoes_qs = lotacoes_qs.filter(orgao_id=alvo_id)
            elif tipo == 'gc':
                lotacoes_qs = lotacoes_qs.filter(grande_comando_id=alvo_id)
            elif tipo == 'unidade':
                lotacoes_qs = lotacoes_qs.filter(unidade_id=alvo_id)
            elif tipo == 'sub_unidade':
                lotacoes_qs = lotacoes_qs.filter(sub_unidade_id=alvo_id)
            militares_ids = lotacoes_qs.values_list('militar_id', flat=True).distinct()
            militares = militares.filter(id__in=militares_ids)
        except Exception:
            pass

    # Ordena√ß√£o padr√£o por hierarquia e antiguidade
    ordenacao = 'hierarquia_antiguidade'
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,  # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
        'NVRR': 15,  # NVRR - tratado separadamente
    }
    
    if ordenacao == 'hierarquia_antiguidade':
        # Ordenar por hierarquia de postos e depois por antiguidade
        # Para Subtenentes, ordenar primeiro os que t√™m CHO, depois os que n√£o t√™m
        # Cada grupo de Subtenentes (com CHO e sem CHO) ter√° sua pr√≥pria numera√ß√£o de antiguidade
        # OTIMIZA√á√ÉO: Usar order_by simples em vez de sorted() em Python
        militares = militares.order_by('posto_graduacao', 'numeracao_antiguidade', 'nome_completo')
        
        # Reordenar numera√ß√£o de antiguidade para Subtenentes separadamente por CHO
        if militares:
            # Separar Subtenentes dos outros postos
            subtenentes = [m for m in militares if m.posto_graduacao == 'ST']
            outros_militares = [m for m in militares if m.posto_graduacao != 'ST']
            
            if subtenentes:
                # Separar Subtenentes com CHO e sem CHO
                subtenentes_com_cho = [m for m in subtenentes if m.curso_cho]
                subtenentes_sem_cho = [m for m in subtenentes if not m.curso_cho]
                
                # Reordenar numera√ß√£o para Subtenentes com CHO
                for i, militar in enumerate(subtenentes_com_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reordenar numera√ß√£o para Subtenentes sem CHO
                for i, militar in enumerate(subtenentes_sem_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reconstruir a lista com Subtenentes reordenados
                militares = outros_militares + subtenentes_com_cho + subtenentes_sem_cho
    elif ordenacao == 'posto':
        militares = militares.order_by('posto_graduacao', 'nome_completo')
    elif ordenacao == 'matricula':
        militares = militares.order_by('matricula')
    elif ordenacao == 'data_ingresso':
        militares = militares.order_by('data_ingresso')
    elif ordenacao == 'numeracao_antiguidade':
        militares = militares.order_by('numeracao_antiguidade', 'nome_completo')
    elif ordenacao == 'pontuacao':
        militares = militares.annotate(
            pontuacao_total=Sum('fichaconceitooficiais__pontos') + Sum('fichaconceitopracas__pontos')
        ).order_by('-pontuacao_total')
    else:
        militares = militares.order_by('nome_completo')

    # Pagina√ß√£o
    itens_por_pagina = request.GET.get('itens_por_pagina', 20)
    try:
        itens_por_pagina = int(itens_por_pagina)
        if itens_por_pagina not in [20, 50, 100]:
            itens_por_pagina = 20
    except (ValueError, TypeError):
        itens_por_pagina = 20
    
    # Converter para lista se necess√°rio
    if hasattr(militares, 'count'):
        # √â um QuerySet
        militares_list = list(militares)
    else:
        # J√° √© uma lista
        militares_list = militares
    
    paginator = Paginator(militares_list, itens_por_pagina)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'militares': page_obj,
        'page_obj': page_obj,
        'itens_por_pagina': itens_por_pagina,
        'total_militares': len(militares_list),
        'query': query,
        'pode_reordenar_antiguidade': tem_permissao(request.user, 'MILITARES', 'REORDENAR_ANTIGUIDADE'),
    }
    
    return render(request, 'militares/militar_list.html', context)

@login_required
def militar_detail_pessoal(request):
    """Exibe os detalhes do pr√≥prio militar do usu√°rio logado"""
    if not request.user.is_authenticated:
        return redirect('login')
    
    # Verificar se o usu√°rio tem militar associado
    try:
        militar = request.user.militar
    except Militar.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o possui militar associado.')
        return redirect('militares:home')
    
    # Verificar se o usu√°rio tem acesso "NENHUM" - apenas visualiza√ß√£o
    from .permissoes_hierarquicas import obter_nivel_acesso_usuario
    nivel_acesso = obter_nivel_acesso_usuario(request.user)
    if nivel_acesso == 'NENHUM':
        # Usu√°rio com acesso NENHUM: apenas visualiza√ß√£o, sem edi√ß√£o
        pode_editar_dados_pessoais = False
    else:
        # Outros usu√°rios podem editar seus dados pessoais
        pode_editar_dados_pessoais = True
    
    # Verificar se o usu√°rio tem sess√£o ativa (necess√°rio para o menu lateral)
    from .models import UsuarioSessao
    sessao_ativa = UsuarioSessao.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()
    
    # Para fichas pessoais, n√£o √© obrigat√≥rio ter sess√£o ativa
    # O usu√°rio pode acessar suas informa√ß√µes pessoais mesmo sem fun√ß√£o selecionada
    if not sessao_ativa:
        # Usar uma sess√£o tempor√°ria ou None para permitir acesso √†s fichas pessoais
        pass
    
    # Busca ficha de conceito
    fichas_oficiais = list(militar.fichaconceitooficiais_set.all())
    fichas_pracas = list(militar.fichaconceitopracas_set.all())
    ficha_conceito = fichas_oficiais + fichas_pracas
    ficha_conceito.sort(key=lambda x: x.data_registro, reverse=True)
    
    # Busca promo√ß√µes
    promocoes = militar.promocao_set.all().order_by('-data_promocao')
    
    # Busca lota√ß√µes
    lotacoes = militar.lotacoes.filter(ativo=True).order_by('-data_inicio', '-data_cadastro')
    
    # Verificar se h√° fun√ß√£o PRINCIPAL ativa e promover ADICIONAL se necess√°rio
    tem_principal = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='PRINCIPAL').exists()
    if not tem_principal:
        primeira_adicional = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='ADICIONAL').order_by('-data_inicio', '-data_cadastro').first()
        if primeira_adicional:
            primeira_adicional.tipo_funcao = 'PRINCIPAL'
            primeira_adicional.save()
    
    # Busca fun√ß√µes - ordenar por tipo (PRINCIPAL primeiro) e depois por data
    from django.db.models import Case, When, Value, IntegerField
    funcoes = militar.funcoes.filter(ativo=True, status__in=['ATUAL', 'ANTERIOR']).annotate(
        tipo_ordem=Case(
            When(tipo_funcao='PRINCIPAL', then=Value(1)),
            When(tipo_funcao='ADICIONAL', then=Value(2)),
            When(tipo_funcao='TEMPORARIA', then=Value(3)),
            When(tipo_funcao='COMISSAO', then=Value(4)),
            default=Value(5),
            output_field=IntegerField(),
        )
    ).order_by('-status', 'tipo_ordem', '-data_inicio', '-data_cadastro')
    
    # Busca todas as fun√ß√µes (atuais e hist√≥ricas)
    funcoes_atuais = militar.funcoes.filter(status='ATUAL').order_by('-data_inicio')
    funcoes_historicas = militar.funcoes.filter(status='ANTERIOR').order_by('-data_inicio')
    todas_funcoes = militar.funcoes.all().order_by('-data_inicio')
    
    # Busca documentos
    documentos = Documento.objects.filter(militar=militar).order_by('-data_upload')
    
    # Importar fun√ß√µes de permiss√£o
    from .permissoes_simples import (
        pode_visualizar_militares, pode_editar_militares,
        pode_visualizar_fichas_conceito, pode_editar_fichas_conceito,
        pode_visualizar_quadros_acesso, pode_editar_quadros_acesso,
        pode_visualizar_quadros_fixacao, pode_editar_quadros_fixacao,
        pode_visualizar_almanaques, pode_editar_almanaques,
        pode_visualizar_promocoes, pode_editar_promocoes,
        pode_visualizar_calendarios, pode_editar_calendarios,
        pode_visualizar_comissoes, pode_editar_comissoes,
        pode_visualizar_lotacoes, pode_editar_lotacoes,
        pode_gerenciar_usuarios, pode_gerenciar_permissoes,
        pode_acessar_logs, pode_gerenciar_medalhas
    )
    from .permissoes_militares import pode_visualizar_punicoes_elogios, pode_editar_punicoes_elogios
    
    # Buscar elogios e puni√ß√µes (o pr√≥prio militar sempre pode ver os seus)
    elogios = militar.elogios.filter(ativo=True).order_by('-data_elogio', '-data_registro')
    punicoes = militar.punicoes.filter(ativo=True).order_by('-data_punicao', '-data_registro')
    
    # Busca f√©rias do militar ordenadas por ano de refer√™ncia (do mais atual para o mais distante)
    # Inclui f√©rias de todos os planos, mesmo que o plano esteja em RASCUNHO
    from militares.models import Ferias, LicencaEspecial
    ferias = list(Ferias.objects.filter(militar=militar).select_related('plano', 'militar').order_by('-ano_referencia', '-data_inicio'))
    
    # Busca licen√ßas especiais do militar ordenadas por plano e data de in√≠cio (do mais atual para o mais distante)
    # N√ÉO filtrar por status - mostrar TODAS as licen√ßas (PLANEJADA, GOZANDO, GOZADA, CANCELADA)
    # Ordenar por plano (None primeiro) e depois por data de in√≠cio
    licencas_especiais_qs = LicencaEspecial.objects.filter(militar=militar).select_related('militar', 'cadastrado_por', 'plano').order_by('-plano__ano_plano', '-data_inicio', '-data_cadastro')
    licencas_especiais = list(licencas_especiais_qs)
    
    # Busca afastamentos do militar
    # O pr√≥prio militar sempre pode ver seus pr√≥prios afastamentos
    from militares.models import Afastamento
    afastamentos = list(militar.afastamentos.all().order_by('-data_inicio', '-data_cadastro'))
    
    # Tipos de afastamento para o modal de certid√£o
    tipos_afastamento = Afastamento.get_all_tipo_choices()
    
    # Busca cautelas de armas do militar
    from militares.models import CautelaArma, CautelaArmaColetiva
    cautelas_individuais = CautelaArma.objects.filter(militar=militar).select_related('arma', 'militar', 'entregue_por', 'devolvido_por').order_by('-data_entrega')
    cautelas_coletivas = CautelaArmaColetiva.objects.filter(responsavel=militar).select_related('responsavel', 'criado_por', 'finalizado_por').order_by('-data_inicio')
    total_cautelas = cautelas_individuais.count() + cautelas_coletivas.count()
    
    # Busca processos administrativos do militar
    from militares.models import ProcessoAdministrativo
    processos_envolvido = ProcessoAdministrativo.objects.filter(
        militares_envolvidos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_encarregado = ProcessoAdministrativo.objects.filter(
        militares_encarregados=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_escriva = ProcessoAdministrativo.objects.filter(
        escrivaos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    # Combinar todos os processos √∫nicos
    processos_ids = set()
    processos_todos = []
    
    for processo in processos_envolvido:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('envolvido', processo))
    
    for processo in processos_encarregado:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('encarregado', processo))
    
    for processo in processos_escriva:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('escriva', processo))
    
    # Ordenar por data de abertura (mais recente primeiro)
    from datetime import date
    processos_todos.sort(key=lambda x: (
        x[1].data_abertura if x[1].data_abertura else (x[1].data_criacao.date() if x[1].data_criacao else date.min)
    ), reverse=True)
    total_processos = len(processos_todos)
    
    # DEBUG: Log para verificar se as licen√ßas est√£o sendo buscadas
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"DEBUG militar_detail_pessoal - Militar ID: {militar.pk}, Licen√ßas encontradas: {len(licencas_especiais)}, IDs: {[l.pk for l in licencas_especiais]}, Afastamentos: {len(afastamentos)}")
    
    # Verificar permiss√µes baseadas na fun√ß√£o militar
    # O pr√≥prio militar sempre pode visualizar seus elogios e puni√ß√µes
    pode_ver_elogios_punicoes = pode_visualizar_punicoes_elogios(request.user, militar)
    pode_editar_elogios_punicoes = pode_editar_punicoes_elogios(request.user, militar)
    
    # Para usu√°rios com acesso NENHUM, permitir visualiza√ß√£o da pr√≥pria ficha
    if nivel_acesso == 'NENHUM':
        # Usu√°rio com acesso NENHUM pode visualizar apenas sua pr√≥pria ficha
        context = {
            'militar': militar,
            'ficha_conceito': ficha_conceito,
            'promocoes': promocoes,
            'lotacoes': lotacoes,
            'funcoes': funcoes,
            'funcoes_atuais': funcoes_atuais,
            'funcoes_historicas': funcoes_historicas,
            'todas_funcoes': todas_funcoes,
            'documentos': documentos,
            'elogios': elogios,
            'punicoes': punicoes,
            'ferias': ferias,
            'licencas_especiais': licencas_especiais,
            'afastamentos': afastamentos,
            'tipos_afastamento': tipos_afastamento,
            'cautelas_individuais': cautelas_individuais,
            'cautelas_coletivas': cautelas_coletivas,
            'total_cautelas': total_cautelas,
            'processos_todos': processos_todos,
            'total_processos': total_processos,
            'averbacoes': list(militar.averbacoes.all().order_by('-data_averbacao', '-data_cadastro')),
            'is_own_ficha': True,  # Flag para indicar que √© a pr√≥pria ficha
            'permissoes_detalhes': {
                'detail_contato': True,  # Pode ver contato pr√≥prio
                'detail_medalhas': False,  # N√£o pode ver medalhas
            },
            'menu_permissions': {
                'DETAIL_FICHAS_CONCEITO': True,  # Pode ver suas pr√≥prias fichas
                'DETAIL_PUNICOES': pode_ver_elogios_punicoes,  # Pode ver seus pr√≥prios elogios/puni√ß√µes
            },
            'pode_visualizar_punicoes_elogios': pode_ver_elogios_punicoes,  # O pr√≥prio militar sempre pode ver
            'pode_editar_punicoes_elogios': pode_editar_elogios_punicoes,  # Editar apenas superusu√°rio
            'pode_editar_dados_pessoais': False,  # N√£o pode editar dados pessoais
        }
    else:
        # Outros usu√°rios seguem as permiss√µes normais
        context = {
            'militar': militar,
            'ficha_conceito': ficha_conceito,
            'promocoes': promocoes,
            'lotacoes': lotacoes,
            'funcoes': funcoes,
            'funcoes_atuais': funcoes_atuais,
            'funcoes_historicas': funcoes_historicas,
            'todas_funcoes': todas_funcoes,
            'documentos': documentos,
            'elogios': elogios,
            'punicoes': punicoes,
            'ferias': ferias,
            'licencas_especiais': licencas_especiais,
            'afastamentos': afastamentos,
            'tipos_afastamento': tipos_afastamento,
            'cautelas_individuais': cautelas_individuais,
            'cautelas_coletivas': cautelas_coletivas,
            'total_cautelas': total_cautelas,
            'processos_todos': processos_todos,
            'total_processos': total_processos,
            'averbacoes': list(militar.averbacoes.all().order_by('-data_averbacao', '-data_cadastro')),
            'is_own_ficha': True,  # Flag para indicar que √© a pr√≥pria ficha
            'permissoes_detalhes': {
                'detail_contato': pode_visualizar_militares(request.user),  # Baseado na fun√ß√£o militar
                'detail_medalhas': pode_gerenciar_medalhas(request.user),  # Baseado na fun√ß√£o militar
            },
            'menu_permissions': {
                'DETAIL_FICHAS_CONCEITO': pode_visualizar_fichas_conceito(request.user),  # Baseado na fun√ß√£o militar
                'DETAIL_PUNICOES': pode_ver_elogios_punicoes,  # Baseado na fun√ß√£o militar e pr√≥prio militar
            },
            'pode_visualizar_punicoes_elogios': pode_ver_elogios_punicoes,  # Usa fun√ß√£o correta que considera pr√≥prio militar
            'pode_editar_punicoes_elogios': pode_editar_elogios_punicoes,  # Usa fun√ß√£o correta
            'pode_editar_dados_pessoais': pode_editar_dados_pessoais,  # Baseado no n√≠vel de acesso
        }
    
    # Adicionar permiss√µes do menu do context processor
    from .context_processors import menu_permissions_processor
    menu_context = menu_permissions_processor(request)
    context.update(menu_context)
    
    return render(request, 'militares/militar_detail.html', context)


@login_required
@admin_bypass
def militar_create(request):
    """Cria um novo militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes e diretores de gest√£o de pessoas podem cadastrar.')
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES)
        if form.is_valid():
            militar = form.save()
            messages.success(request, f'Militar {militar.nome_completo} cadastrado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao cadastrar militar. Verifique os dados.')
    else:
        form = MilitarForm()
    
    context = {
        'form': form,
        'title': 'Novo Militar',
        'action': 'create',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
def militar_update(request, pk):
    """Atualiza um militar existente"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem editar.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES, instance=militar)
        if form.is_valid():
            # Capturar a numera√ß√£o anterior antes de salvar
            numeracao_anterior = militar.numeracao_antiguidade
            
            # Salvar o militar
            militar = form.save()
            
            # Se a numera√ß√£o de antiguidade foi alterada, reordenar automaticamente
            if numeracao_anterior != militar.numeracao_antiguidade and militar.numeracao_antiguidade is not None:
                try:
                    militares_reordenados = militar.reordenar_numeracoes_apos_alteracao(numeracao_anterior)
                    if militares_reordenados and militares_reordenados > 0:
                        messages.success(request, f'Militar {militar.nome_completo} atualizado com sucesso! {militares_reordenados} militares foram reordenados automaticamente.')
                    else:
                        messages.success(request, f'Militar {militar.nome_completo} atualizado com sucesso!')
                except Exception as e:
                    messages.warning(request, f'Militar atualizado, mas houve um erro na reordena√ß√£o autom√°tica: {str(e)}')
                return redirect('militares:militar_detail', pk=militar.pk)
            else:
                messages.success(request, f'Militar {militar.nome_completo} atualizado com sucesso!')
                return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao atualizar militar. Verifique os dados.')
    else:
        form = MilitarForm(instance=militar)
    
    context = {
        'form': form,
        'militar': militar,
        'title': 'Editar Militar',
        'action': 'update',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
def militar_delete(request, pk):
    """Remove um militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem excluir.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        nome = militar.nome_completo
        militar.delete()
        messages.success(request, f'Militar {nome} removido com sucesso!')
        return redirect('militares:militar_list')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_confirm_delete.html', context)

def militar_search_ajax(request):
    """Busca militares via AJAX para autocomplete"""
    import logging
    logger = logging.getLogger(__name__)
    
    query = request.GET.get('q', '')
    logger.info(f'DEBUG - Busca AJAX recebida: {query}')
    logger.info(f'DEBUG - Metodo da requisicao: {request.method}')
    logger.info(f'DEBUG - Headers: {dict(request.headers)}')
    
    if len(query) < 2:
        logger.info('WARNING - Query muito curta, retornando vazio')
        return JsonResponse({'results': []})
    
    try:
        # Filtrar militares excluindo coron√©is (√∫ltimo posto)
        militares = Militar.objects.filter(
            Q(nome_completo__icontains=query) |
            Q(nome_guerra__icontains=query) |
            Q(matricula__icontains=query)
        ).exclude(
            posto_graduacao='CB'  # Excluir coron√©is
        )[:10]
        
        logger.info(f'‚úÖ Encontrados {militares.count()} militares')
        
        results = []
        for militar in militares:
            result = {
                'id': militar.id,
                'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}",
                'nome': militar.nome_completo,
                'matricula': militar.matricula,
                'posto': militar.get_posto_graduacao_display(),
            }
            results.append(result)
            logger.info(f'üë§ Militar encontrado: {result["nome"]} ({result["posto"]})')
        
        logger.info(f'üì¶ Retornando {len(results)} resultados')
        return JsonResponse({'results': results})
        
    except Exception as e:
        logger.error(f'‚ùå Erro na busca AJAX: {str(e)}')
        logger.error(f'‚ùå Stack trace: {e.__traceback__}')
        return JsonResponse({'results': [], 'error': str(e)}, status=500)

def buscar_usuarios_ajax(request):
    """Busca usu√°rios via AJAX para autocomplete"""
    import logging
    logger = logging.getLogger(__name__)
    
    query = request.GET.get('q', '')
    comissao_tipo = request.GET.get('comissao_tipo', '')  # CPO ou CPP
    logger.info(f'DEBUG - Busca de usuarios AJAX recebida: {query} (comissao: {comissao_tipo})')
    
    if len(query) < 2:
        logger.info('WARNING - Query muito curta, retornando vazio')
        return JsonResponse({'usuarios': []})
    
    try:
        # Buscar usu√°rios que t√™m militares vinculados e est√£o ativos
        usuarios = User.objects.filter(
            militar__isnull=False,  # Apenas usu√°rios com militar vinculado
            militar__classificacao='ATIVO',  # Apenas militares ativos
            is_active=True  # Apenas usu√°rios ativos
        ).filter(
            Q(militar__nome_completo__icontains=query) |
            Q(militar__nome_guerra__icontains=query) |
            Q(militar__matricula__icontains=query) |
            Q(first_name__icontains=query) |
            Q(last_name__icontains=query) |
            Q(username__icontains=query)
        )
        
        # Filtrar por tipo de comiss√£o se especificado
        if comissao_tipo == 'CPO':
            # Para CPO: apenas usu√°rios com fun√ß√µes CPO
            usuarios = usuarios.filter(
                militar__posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS'],  # Apenas oficiais
                funcoes__funcao_militar__nome__icontains='CPO',  # Com fun√ß√£o CPO
                funcoes__ativo=True  # Fun√ß√£o ativa
            ).distinct()
            
        elif comissao_tipo == 'CPP':
            # Para CPP: apenas usu√°rios com fun√ß√µes CPP
            usuarios = usuarios.filter(
                militar__posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS'],  # Apenas oficiais
                funcoes__funcao_militar__nome__icontains='CPP',  # Com fun√ß√£o CPP
                funcoes__ativo=True  # Fun√ß√£o ativa
            ).distinct()
        
        usuarios = usuarios.order_by('militar__nome_completo')[:10]
        
        logger.info(f'üìä Encontrados {usuarios.count()} usu√°rios')
        
        results = []
        for usuario in usuarios:
            militar = usuario.militar
            
            # Buscar a fun√ß√£o espec√≠fica do usu√°rio
            funcao_cpo_cpp = usuario.funcoes_militares.filter(
                ativo=True,
                funcao_militar__nome__icontains=comissao_tipo if comissao_tipo else ''
            ).first()
            
            results.append({
                'id': usuario.id,
                'username': usuario.username,
                'first_name': usuario.first_name,
                'last_name': usuario.last_name,
                'militar': {
                    'id': militar.id,
                    'nome': militar.nome_completo,
                    'posto': militar.get_posto_graduacao_display(),
                    'matricula': militar.matricula,
                },
                'funcao': funcao_cpo_cpp.funcao_militar.nome if funcao_cpo_cpp else None
            })
        
        logger.info(f'‚úÖ Retornando {len(results)} resultados')
        return JsonResponse({'usuarios': results})
        
    except Exception as e:
        logger.error(f'‚ùå Erro na busca de usu√°rios: {e}')
        return JsonResponse({'usuarios': [], 'error': str(e)})

@login_required
def home(request):
    """P√°gina inicial do sistema - acess√≠vel por todos os usu√°rios"""
    try:
        if not request.user.is_superuser:
            from .views_dashboard_ensino import identificar_tipo_usuario_ensino
            tipo = identificar_tipo_usuario_ensino(request.user)
            if tipo == 'aluno':
                return redirect('militares:ensino_dashboard_aluno')
            if tipo == 'instrutor':
                return redirect('militares:ensino_dashboard_instrutor')
            if tipo == 'coordenador':
                return redirect('militares:ensino_dashboard_coordenador')
            if tipo == 'supervisor':
                return redirect('militares:ensino_dashboard_supervisor')
    except Exception:
        pass
    from .models import UsuarioSessao, Publicacao, EscalaServico, EscalaMilitar
    from django.utils import timezone
    from datetime import datetime, date
    from django.db.models import Q
    
    # Obter m√™s e ano (atual ou filtrado)
    hoje = date.today()
    mes_atual = int(request.GET.get('mes', hoje.month))
    ano_atual = int(request.GET.get('ano', hoje.year))
    
    # Validar m√™s e ano
    if mes_atual < 1 or mes_atual > 12:
        mes_atual = hoje.month
    if ano_atual < 2020 or ano_atual > hoje.year + 1:
        ano_atual = hoje.year
    
    # Superusu√°rios podem acessar diretamente sem sess√£o
    if request.user.is_superuser:
        # Boletins disponibilizados
        boletins_disponibilizados = Publicacao.objects.filter(
            tipo='BOLETIM_OSTENSIVO',
            data_disponibilizacao__isnull=False
        ).order_by('-data_disponibilizacao')[:6]
        
        # Escalas de servi√ßo do m√™s atual (todas para superusu√°rio)
        escalas_mes_atual = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).order_by('data', 'hora_inicio')[:10]
        
        # Boletins reservados disponibilizados
        boletins_reservados_disponibilizados = Publicacao.objects.filter(
            tipo='BOLETIM_RESERVADO',
            data_disponibilizacao__isnull=False
        ).order_by('-data_disponibilizacao')[:6]
        
        # Boletins especiais disponibilizados
        boletins_especiais_disponibilizados = Publicacao.objects.filter(
            tipo='BOLETIM_ESPECIAL',
            data_disponibilizacao__isnull=False
        ).order_by('-data_disponibilizacao')[:6]
        
        # Buscar licenciamentos pr√≥ximos ao vencimento (5 dias antes do proximo_vencimento)
        proximo_licenciamento_vencer = None
        licenciamentos_alertas = []
        from .models import LicenciamentoViatura
        from datetime import timedelta
        data_alerta = hoje + timedelta(days=5)
        
        licenciamentos_proximos_vencimento = LicenciamentoViatura.objects.filter(
            proximo_vencimento__gte=hoje,
            proximo_vencimento__lte=data_alerta,
            ativo=True
        ).select_related('viatura', 'responsavel').order_by('proximo_vencimento')
        
        # Filtrar apenas aqueles que ainda n√£o foram renovados
        for lic in licenciamentos_proximos_vencimento:
            # Verificar se n√£o h√° um novo licenciamento ap√≥s o proximo_vencimento
            novo_licenciamento = LicenciamentoViatura.objects.filter(
                viatura=lic.viatura,
                data_vencimento__gt=lic.proximo_vencimento,
                ativo=True
            ).exists()
            
            if not novo_licenciamento:
                licenciamentos_alertas.append(lic)
        
        # Pegar o mais pr√≥ximo para o card
        proximo_licenciamento_vencer = licenciamentos_alertas[0] if licenciamentos_alertas else None
        
        # Buscar manuten√ß√µes pr√≥ximas (viatura pr√≥xima do pr√≥ximo_km_revisao)
        proxima_manutencao = None
        manutencoes_alertas = []
        from .models import ManutencaoViatura
        manutencoes_candidatas = ManutencaoViatura.objects.filter(
            proximo_km_revisao__isnull=False,
            ativo=True
        ).select_related('viatura', 'responsavel')
        
        for manutencao in manutencoes_candidatas:
            if manutencao.viatura:
                km_atual = manutencao.viatura.km_atual
                km_proximo = manutencao.proximo_km_revisao
                diferenca_km = km_proximo - km_atual
                
                # Alertar se faltam menos de 1000 km ou se j√° passou
                if diferenca_km <= 1000:
                    # Verificar se ainda n√£o foi feita uma nova manuten√ß√£o ap√≥s o pr√≥ximo_km_revisao
                    nova_manutencao = ManutencaoViatura.objects.filter(
                        viatura=manutencao.viatura,
                        km_manutencao__gte=km_proximo,
                        ativo=True
                    ).exclude(pk=manutencao.pk).exists()
                    
                    if not nova_manutencao:
                        manutencoes_alertas.append((diferenca_km, manutencao))
        
        # Ordenar por menor diferen√ßa (mais pr√≥ximo) e pegar o primeiro
        if manutencoes_alertas:
            manutencoes_alertas.sort(key=lambda x: x[0])
            manutencoes_alertas = [m[1] for m in manutencoes_alertas]
            proxima_manutencao = manutencoes_alertas[0]
        
        # Buscar trocas de √≥leo pr√≥ximas (viatura pr√≥xima do proximo_km_troca)
        proxima_troca_oleo = None
        trocas_oleo_alertas = []
        from .models import TrocaOleoViatura
        trocas_candidatas = TrocaOleoViatura.objects.filter(
            proximo_km_troca__isnull=False,
            ativo=True
        ).select_related('viatura', 'responsavel')
        
        for troca in trocas_candidatas:
            if troca.viatura:
                km_atual = troca.viatura.km_atual
                km_proximo = troca.proximo_km_troca
                diferenca_km = km_proximo - km_atual
                
                # Alertar se faltam menos de 1000 km ou se j√° passou
                if diferenca_km <= 1000:
                    # Verificar se ainda n√£o foi feita uma nova troca ap√≥s o proximo_km_troca
                    nova_troca = TrocaOleoViatura.objects.filter(
                        viatura=troca.viatura,
                        km_troca__gte=km_proximo,
                        ativo=True
                    ).exclude(pk=troca.pk).exists()
                    
                    if not nova_troca:
                        trocas_oleo_alertas.append((diferenca_km, troca))
        
        # Ordenar por menor diferen√ßa (mais pr√≥ximo) e pegar o primeiro
        if trocas_oleo_alertas:
            trocas_oleo_alertas.sort(key=lambda x: x[0])
            trocas_oleo_alertas = [t[1] for t in trocas_oleo_alertas]
            proxima_troca_oleo = trocas_oleo_alertas[0]
        
        context = {
            'boletins_disponibilizados': boletins_disponibilizados,
            'boletins_reservados_disponibilizados': boletins_reservados_disponibilizados,
            'boletins_especiais_disponibilizados': boletins_especiais_disponibilizados,
            'escalas_mes_atual': escalas_mes_atual,
            'mes_atual': mes_atual,
            'ano_atual': ano_atual,
            'nivel_usuario': None,  # Superusu√°rio n√£o precisa de n√≠vel
            'is_superuser': True,
            'proximas_ferias': None,
            'proxima_licenca_especial': None,
            'proximo_licenciamento_vencer': proximo_licenciamento_vencer,
            'licenciamentos_alertas': licenciamentos_alertas,
            'proxima_manutencao': proxima_manutencao,
            'manutencoes_alertas': manutencoes_alertas,
            'proxima_troca_oleo': proxima_troca_oleo,
            'trocas_oleo_alertas': trocas_oleo_alertas,
        }
        
        return render(request, 'militares/home.html', context)
    
    # Verificar se o usu√°rio tem sess√£o ativa com fun√ß√£o selecionada
    sessao_ativa = UsuarioSessao.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()

    if not sessao_ativa:
        # Se n√£o tem sess√£o ativa, redirecionar para sele√ß√£o de fun√ß√£o
        return redirect('militares:selecionar_funcao_lotacao')

    funcao_usuario = sessao_ativa.funcao_militar_usuario
    funcao_militar = funcao_usuario.funcao_militar
    
    # Boletins disponibilizados
    boletins_disponibilizados = Publicacao.objects.filter(
        tipo='BOLETIM_OSTENSIVO',
        data_disponibilizacao__isnull=False
    ).order_by('-data_disponibilizacao')[:6]
    
    # Boletins reservados disponibilizados
    boletins_reservados_disponibilizados = Publicacao.objects.filter(
        tipo='BOLETIM_RESERVADO',
        data_disponibilizacao__isnull=False
    ).order_by('-data_disponibilizacao')[:6]
    
    # Boletins especiais disponibilizados
    boletins_especiais_disponibilizados = Publicacao.objects.filter(
        tipo='BOLETIM_ESPECIAL',
        data_disponibilizacao__isnull=False
    ).order_by('-data_disponibilizacao')[:6]
    
    # Escalas de servi√ßo do m√™s atual - mostrar apenas escalas onde o militar foi inserido
    from .models import Militar, EscalaMilitar
    
    try:
        # Buscar o militar do usu√°rio
        militar = Militar.objects.get(user=request.user)
        
        # Buscar escalas onde o militar foi efetivamente escalado
        escalas_militar = EscalaMilitar.objects.filter(
            militar=militar,
            escala__data__month=mes_atual,
            escala__data__year=ano_atual
        ).select_related('escala').order_by('escala__data', 'escala__hora_inicio')
        
        # Extrair as escalas e remover duplicatas
        escalas_unicas = {}
        for em in escalas_militar[:10]:
            escalas_unicas[em.escala.id] = em.escala
        escalas_mes_atual = list(escalas_unicas.values())
        
        # Buscar pr√≥ximas f√©rias do militar (PLANEJADA ou GOZANDO)
        from .models import Ferias, LicencaEspecial
        proximas_ferias = Ferias.objects.filter(
            militar=militar,
            status__in=['PLANEJADA', 'GOZANDO'],
            data_inicio__gte=hoje
        ).order_by('data_inicio').first()
        
        # Buscar pr√≥xima licen√ßa especial do militar (PLANEJADA ou GOZANDO)
        proxima_licenca_especial = LicencaEspecial.objects.filter(
            militar=militar,
            status__in=['PLANEJADA', 'GOZANDO'],
            data_inicio__gte=hoje
        ).order_by('data_inicio').first()
        
    except Militar.DoesNotExist:
        # Se n√£o √© militar, n√£o tem escalas
        escalas_mes_atual = []
        proximas_ferias = None
        proxima_licenca_especial = None
    
    # Buscar licenciamentos pr√≥ximos ao vencimento (5 dias antes do proximo_vencimento)
    # Apenas para usu√°rios com acesso ao menu de viaturas
    proximo_licenciamento_vencer = None
    licenciamentos_alertas = []
    
    # Verificar se o usu√°rio tem permiss√£o para ver o menu de viaturas
    from .permissoes_hierarquicas import obter_funcao_militar_ativa
    funcao_atual = obter_funcao_militar_ativa(request.user)
    tem_permissao_viaturas = False
    
    if request.user.is_superuser:
        tem_permissao_viaturas = True
    elif funcao_atual and funcao_atual.funcao_militar:
        permissoes = funcao_atual.funcao_militar.get_menu_permissions()
        tem_permissao_viaturas = permissoes.get('show_viaturas', False)
    
    if tem_permissao_viaturas:
        from .models import LicenciamentoViatura
        from datetime import timedelta
        data_alerta = hoje + timedelta(days=5)
        
        licenciamentos_proximos_vencimento = LicenciamentoViatura.objects.filter(
            proximo_vencimento__gte=hoje,
            proximo_vencimento__lte=data_alerta,
            ativo=True
        ).select_related('viatura', 'responsavel').order_by('proximo_vencimento')
        
        # Filtrar apenas aqueles que ainda n√£o foram renovados
        for lic in licenciamentos_proximos_vencimento:
            # Verificar se n√£o h√° um novo licenciamento ap√≥s o proximo_vencimento
            novo_licenciamento = LicenciamentoViatura.objects.filter(
                viatura=lic.viatura,
                data_vencimento__gt=lic.proximo_vencimento,
                ativo=True
            ).exists()
            
            if not novo_licenciamento:
                licenciamentos_alertas.append(lic)
        
        # Pegar o mais pr√≥ximo para o card
        proximo_licenciamento_vencer = licenciamentos_alertas[0] if licenciamentos_alertas else None
    
    # Buscar manuten√ß√µes pr√≥ximas (viatura pr√≥xima do pr√≥ximo_km_revisao)
    # Considerar "pr√≥ximo" quando faltam menos de 1000 km ou quando j√° passou
    proxima_manutencao = None
    manutencoes_alertas = []
    
    if tem_permissao_viaturas:
        from .models import ManutencaoViatura
        manutencoes_candidatas = ManutencaoViatura.objects.filter(
            proximo_km_revisao__isnull=False,
            ativo=True
        ).select_related('viatura', 'responsavel')
        
        for manutencao in manutencoes_candidatas:
            if manutencao.viatura:
                km_atual = manutencao.viatura.km_atual
                km_proximo = manutencao.proximo_km_revisao
                diferenca_km = km_proximo - km_atual
                
                # Alertar se faltam menos de 1000 km ou se j√° passou
                if diferenca_km <= 1000:
                    # Verificar se ainda n√£o foi feita uma nova manuten√ß√£o ap√≥s o pr√≥ximo_km_revisao
                    nova_manutencao = ManutencaoViatura.objects.filter(
                        viatura=manutencao.viatura,
                        km_manutencao__gte=km_proximo,
                        ativo=True
                    ).exclude(pk=manutencao.pk).exists()
                    
                    if not nova_manutencao:
                        manutencoes_alertas.append((diferenca_km, manutencao))
        
        # Ordenar por menor diferen√ßa (mais pr√≥ximo) e pegar o primeiro
        if manutencoes_alertas:
            manutencoes_alertas.sort(key=lambda x: x[0])
            manutencoes_alertas = [m[1] for m in manutencoes_alertas]
            proxima_manutencao = manutencoes_alertas[0]
    
    # Buscar trocas de √≥leo pr√≥ximas (viatura pr√≥xima do proximo_km_troca)
    # Considerar "pr√≥ximo" quando faltam menos de 1000 km ou quando j√° passou
    proxima_troca_oleo = None
    trocas_oleo_alertas = []
    
    if tem_permissao_viaturas:
        from .models import TrocaOleoViatura
        trocas_candidatas = TrocaOleoViatura.objects.filter(
            proximo_km_troca__isnull=False,
            ativo=True
        ).select_related('viatura', 'responsavel')
        
        for troca in trocas_candidatas:
            if troca.viatura:
                km_atual = troca.viatura.km_atual
                km_proximo = troca.proximo_km_troca
                diferenca_km = km_proximo - km_atual
                
                # Alertar se faltam menos de 1000 km ou se j√° passou
                if diferenca_km <= 1000:
                    # Verificar se ainda n√£o foi feita uma nova troca ap√≥s o proximo_km_troca
                    nova_troca = TrocaOleoViatura.objects.filter(
                        viatura=troca.viatura,
                        km_troca__gte=km_proximo,
                        ativo=True
                    ).exclude(pk=troca.pk).exists()
                    
                    if not nova_troca:
                        trocas_oleo_alertas.append((diferenca_km, troca))
        
        # Ordenar por menor diferen√ßa (mais pr√≥ximo) e pegar o primeiro
        if trocas_oleo_alertas:
            trocas_oleo_alertas.sort(key=lambda x: x[0])
            trocas_oleo_alertas = [t[1] for t in trocas_oleo_alertas]
            proxima_troca_oleo = trocas_oleo_alertas[0]
    
    # Determinar n√≠vel de acesso do usu√°rio
    nivel_usuario = None
    if funcao_militar:
        nivel_usuario = funcao_militar
    
    context = {
        'boletins_disponibilizados': boletins_disponibilizados,
        'boletins_reservados_disponibilizados': boletins_reservados_disponibilizados,
        'boletins_especiais_disponibilizados': boletins_especiais_disponibilizados,
        'escalas_mes_atual': escalas_mes_atual,
        'mes_atual': mes_atual,
        'ano_atual': ano_atual,
        'nivel_usuario': nivel_usuario,
        'is_superuser': False,
        'proximas_ferias': proximas_ferias,
        'proxima_licenca_especial': proxima_licenca_especial,
        'proximo_licenciamento_vencer': proximo_licenciamento_vencer,
        'licenciamentos_alertas': licenciamentos_alertas,
        'proxima_manutencao': proxima_manutencao,
        'manutencoes_alertas': manutencoes_alertas,
        'proxima_troca_oleo': proxima_troca_oleo,
        'trocas_oleo_alertas': trocas_oleo_alertas,
    }
    
    return render(request, 'militares/home.html', context)

def dashboard_permission_required(view_func):
    """Decorator para verificar permiss√£o de acesso ao dashboard"""
    def wrapper(request, *args, **kwargs):
        # Superusu√°rios sempre t√™m acesso
        if request.user.is_superuser:
            return view_func(request, *args, **kwargs)
        
        # Verificar se tem sess√£o ativa
        from .models import UsuarioSessao
        sessao_ativa = UsuarioSessao.objects.filter(
            usuario=request.user,
            ativo=True
        ).first()
        
        if not sessao_ativa or not sessao_ativa.funcao_militar_usuario:
            return redirect('militares:selecionar_funcao_lotacao')
        
        funcao_militar = sessao_ativa.funcao_militar_usuario.funcao_militar
        
        # Verificar se tem n√≠vel de acesso suficiente (n√≠vel 4 ou superior)
        if funcao_militar.nivel >= 4:
            return view_func(request, *args, **kwargs)
        
        # Se n√£o tem permiss√£o, redirecionar para home com mensagem
        from django.contrib import messages
        messages.warning(request, 'Voc√™ n√£o tem permiss√£o para acessar o dashboard administrativo.')
        return redirect('militares:home')
    
    return wrapper

@login_required
@dashboard_permission_required
def militar_dashboard(request):
    """Dashboard principal do sistema"""

    # Verificar se o usu√°rio tem sess√£o ativa com fun√ß√£o selecionada
    from militares.models import UsuarioSessao
    sessao_ativa = UsuarioSessao.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()

    if not sessao_ativa:
        # Se n√£o tem sess√£o ativa, redirecionar para sele√ß√£o de fun√ß√£o
        return redirect('militares:selecionar_funcao_lotacao')

    # Todos os usu√°rios, independente da fun√ß√£o, v√£o para o dashboard principal
    # Apenas usu√°rios com "Servi√ßo Operacional" podem acessar a ficha via menu

    total_militares = Militar.objects.count()
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
    militares_inativos = total_militares - militares_ativos
    # Contar militares que possuem ficha de conceito (n√£o o total de fichas)
    militares_com_ficha = Militar.objects.filter(
        Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
    ).distinct().count()
    
    # Contar militares ativos sem ficha de conceito
    militares_sem_ficha = militares_ativos - militares_com_ficha
    documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
    total_quadros = QuadroAcesso.objects.count()
    
    # Estat√≠sticas por quadro
    estatisticas_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ).order_by('quadro')
    
    # Estat√≠sticas por posto/gradua√ß√£o
    estatisticas_posto = Militar.objects.filter(classificacao='ATIVO').values('posto_graduacao').annotate(
        total=Count('id')
    ).order_by('posto_graduacao')
    
    # Estat√≠sticas por g√™nero - Posto/Gradua√ß√£o
    estatisticas_genero_posto = Militar.objects.filter(classificacao='ATIVO').values('posto_graduacao', 'sexo').annotate(
        total=Count('id')
    ).order_by('posto_graduacao', 'sexo')
    
    # Estat√≠sticas por g√™nero - Quadro
    estatisticas_genero_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro', 'sexo').annotate(
        total=Count('id')
    ).order_by('quadro', 'sexo')
    
    # Totais por g√™nero
    total_homens = Militar.objects.filter(classificacao='ATIVO', sexo='M').count()
    total_mulheres = Militar.objects.filter(classificacao='ATIVO', sexo='F').count()
    
    # Estat√≠sticas de documentos por status
    documentos_por_status = Documento.objects.values('status').annotate(
        total=Count('id')
    ).order_by('status')
    
    # Militares aptos a quadro de acesso por posto/gradua√ß√£o
    from datetime import date
    hoje = date.today()
    
    # Buscar militares aptos (com ficha de conceito e interst√≠cio m√≠nimo)
    militares_aptos_por_posto = {}
    
    # Definir interst√≠cios m√≠nimos por posto (em anos)
    intersticios_minimos = {
        '2T': 2,  # 2¬∫ Tenente -> 1¬∫ Tenente
        '1T': 3,  # 1¬∫ Tenente -> Capit√£o
        'CP': 4,  # Capit√£o -> Major
        'MJ': 4,  # Major -> Tenente-Coronel
        'TC': 4,  # Tenente-Coronel -> Coronel
        'ST': 3,  # Subtenente -> 1¬∫ Sargento
        '1S': 3,  # 1¬∫ Sargento -> 2¬∫ Sargento
        '2S': 3,  # 2¬∫ Sargento -> 3¬∫ Sargento
        '3S': 3,  # 3¬∫ Sargento -> Cabo
        'CAB': 2, # Cabo -> Soldado
    }
    
    # Buscar militares ativos com ficha de conceito (para c√°lculo de aptos)
    militares_aptos_candidatos = Militar.objects.filter(
        classificacao='ATIVO',
        posto_graduacao__in=intersticios_minimos.keys()
    ).filter(
        Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
    ).distinct()
    
    # Verificar aptid√£o por interst√≠cio
    for militar in militares_aptos_candidatos:
        posto = militar.posto_graduacao
        if posto in intersticios_minimos:
            # Calcular anos no posto atual
            anos_no_posto = (hoje - militar.data_promocao_atual).days / 365.25
            
            if anos_no_posto >= intersticios_minimos[posto]:
                if posto not in militares_aptos_por_posto:
                    militares_aptos_por_posto[posto] = 0
                militares_aptos_por_posto[posto] += 1
    
    # Ordenar por hierarquia
    hierarquia = ['2T', '1T', 'CP', 'MJ', 'TC', 'ST', '1S', '2S', '3S', 'CAB']
    militares_aptos_ordenados = []
    total_aptos = 0
    for posto in hierarquia:
        if posto in militares_aptos_por_posto:
            militares_aptos_ordenados.append({
                'posto': posto,
                'total': militares_aptos_por_posto[posto]
            })
            total_aptos += militares_aptos_por_posto[posto]
    
    # Documentos recentes
    documentos_recentes = Documento.objects.select_related('militar').order_by('-data_upload')[:5]
    
    # Quadros de acesso recentes
    quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
    
    # Notifica√ß√µes do usu√°rio
    notificacoes_base = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).order_by('-prioridade', '-data_criacao')
    
    # Contadores de notifica√ß√µes (antes do slice)
    total_notificacoes = notificacoes_base.count()
    notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
    notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
    
    # Aplicar slice apenas para exibi√ß√£o
    notificacoes = notificacoes_base[:10]
    
    # Obter n√≠vel hier√°rquico do usu√°rio para exibi√ß√£o de permiss√µes
    from militares.permissoes_niveis import obter_nivel_hierarquico_usuario
    nivel_usuario = obter_nivel_hierarquico_usuario(request.user)
    
    context = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'militares_inativos': militares_inativos,
        'militares_com_ficha': militares_com_ficha,
        'militares_sem_ficha': militares_sem_ficha,
        'documentos_pendentes': documentos_pendentes,
        'total_quadros': total_quadros,
        'estatisticas_quadro': estatisticas_quadro,
        'estatisticas_posto': estatisticas_posto,
        'estatisticas_genero_posto': estatisticas_genero_posto,
        'estatisticas_genero_quadro': estatisticas_genero_quadro,
        'total_homens': total_homens,
        'total_mulheres': total_mulheres,
        'documentos_por_status': documentos_por_status,
        'militares_aptos_por_posto': militares_aptos_ordenados,
        'total_aptos_quadro': total_aptos,
        'documentos_recentes': documentos_recentes,
        'quadros_recentes': quadros_recentes,
        'notificacoes': notificacoes,
        'total_notificacoes': total_notificacoes,
        'notificacoes_urgentes': notificacoes_urgentes,
        'notificacoes_altas': notificacoes_altas,
        'nivel_usuario': nivel_usuario,
    }
    
    return render(request, 'militares/dashboard.html', context)

# Views para Ficha de Conceito
@login_required
def ficha_conceito_list(request):
    """Lista unificada de fichas de conceito de oficiais e pra√ßas"""
    from .permissoes_simples import filtrar_fichas_conceito_por_usuario, pode_editar_fichas_conceito, pode_visualizar_fichas_conceito, obter_funcao_militar_ativa
    from .models import UsuarioSessao
    from .filtros_hierarquicos_novo import aplicar_filtro_hierarquico_fichas
    
    militar_id = request.GET.get('militar')
    tipo_filtro = request.GET.get('tipo', 'oficiais')  # 'oficiais', 'pracas', 'todos'
    
    # Verificar se √© superusu√°rio - tem acesso total sem fun√ß√£o militar
    if request.user.is_superuser:
        # Para superusu√°rio, usar dados globais sem filtros hier√°rquicos
        if militar_id:
            militar = get_object_or_404(Militar, pk=militar_id)
            fichas_oficiais = list(militar.fichaconceitooficiais_set.all())
            fichas_pracas = list(militar.fichaconceitopracas_set.all())
            fichas = fichas_oficiais + fichas_pracas
            fichas.sort(key=lambda x: x.data_registro, reverse=True)
            militares_com_ficha = fichas
            militares_sem_ficha = []
        else:
            # Buscar oficiais ativos (todos)
            oficiais = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            )
            
            # Buscar pra√ßas ativas (todas)
            pracas = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
            )
            
            # Aplicar filtro de tipo
            if tipo_filtro == 'oficiais':
                militares_ativos = oficiais
                fichas_oficiais = FichaConceitoOficiais.objects.filter(militar__in=oficiais)
                fichas_pracas = []
            elif tipo_filtro == 'pracas':
                militares_ativos = pracas
                fichas_oficiais = []
                fichas_pracas = FichaConceitoPracas.objects.filter(militar__in=pracas)
            else:  # todos
                militares_ativos = list(oficiais) + list(pracas)
                fichas_oficiais = FichaConceitoOficiais.objects.filter(militar__in=oficiais)
                fichas_pracas = FichaConceitoPracas.objects.filter(militar__in=pracas)
            
            # Combinar fichas
            fichas = list(fichas_oficiais) + list(fichas_pracas)
            
            # Hierarquia para ordena√ß√£o
            hierarquia_oficiais = {
                'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8,
            }
            hierarquia_pracas = {
                'ST': 1, '1S': 2, '2S': 3, '3S': 4, 'CAB': 5, 'SD': 6,
            }
            
            # Ordenar fichas existentes
            fichas_list = list(fichas)
            fichas_list.sort(key=lambda x: (
                hierarquia_oficiais.get(x.militar.posto_graduacao, 999) if x.militar.is_oficial() 
                else hierarquia_pracas.get(x.militar.posto_graduacao, 999),
                x.militar.nome_completo
            ))
            
            # Buscar militares sem ficha
            militares_sem_ficha = []
            for m in militares_ativos:
                if not (m.fichaconceitooficiais_set.exists() or m.fichaconceitopracas_set.exists()):
                    militares_sem_ficha.append(m)
            
            # Ordenar militares sem ficha
            militares_sem_ficha.sort(key=lambda x: (
                hierarquia_oficiais.get(x.posto_graduacao, 999) if x.is_oficial() 
                else hierarquia_pracas.get(x.posto_graduacao, 999),
                x.nome_completo
            ))
            
            militares_com_ficha = fichas_list
            
            # Estat√≠sticas para superusu√°rio
            total_oficiais_ativos = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            ).count()
            
            total_pracas_ativos = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
            ).count()
            
            # Montar lista final: primeiro os sem ficha, depois os com ficha
            fichas_final = militares_sem_ficha + militares_com_ficha
        
        # Aplicar filtro de permiss√£o para usu√°rios comuns (n√£o necess√°rio para superusu√°rio)
        # if not pode_editar_fichas_conceito(request.user):
        #     fichas_final = filtrar_fichas_conceito_por_usuario(request.user, fichas_final)
        #     militares_com_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_com_ficha)
        #     militares_sem_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_sem_ficha)

        context = {
            'militar': militar if militar_id else None,
            'fichas': fichas_final,
            'total_oficiais_ativos': total_oficiais_ativos,
            'total_pracas_ativos': total_pracas_ativos,
            'total_fichas_oficiais': len([f for f in militares_com_ficha if hasattr(f, 'militar') and f.militar.is_oficial()]),
            'total_fichas_pracas': len([f for f in militares_com_ficha if hasattr(f, 'militar') and not f.militar.is_oficial()]),
            'militares_sem_ficha': militares_sem_ficha,
            'militares_com_ficha': militares_com_ficha,
            'tipo_filtro': tipo_filtro,
            'is_superuser': True,  # Flag para identificar superusu√°rio no template
        }
        
        print(f"DEBUG - Fichas de Conceito - Acesso SUPERUSUARIO para {request.user.username}:")
        print(f"   - Tipo filtro: {tipo_filtro}")
        print(f"   - Total oficiais ativos: {total_oficiais_ativos}")
        print(f"   - Total pra√ßas ativas: {total_pracas_ativos}")
        print(f"   - Total fichas encontradas: {len(fichas_final)}")
        print(f"   - Militares sem ficha: {len(militares_sem_ficha)}")
        print(f"   - Militares com ficha: {len(militares_com_ficha)}")
        print(f"   - Fichas de oficiais: {len([f for f in militares_com_ficha if hasattr(f, 'militar') and f.militar.is_oficial()])}")
        print(f"   - Fichas de pra√ßas: {len([f for f in militares_com_ficha if hasattr(f, 'militar') and not f.militar.is_oficial()])}")
        
        return render(request, 'militares/ficha_conceito_list.html', context)
    
    else:
        # Para usu√°rios normais, verificar se tem sess√£o ativa com fun√ß√£o selecionada
        funcao_usuario = obter_funcao_militar_ativa(request.user)
        funcao_militar = None
        
        if funcao_usuario:
            funcao_militar = funcao_usuario.funcao_militar
        else:
            # Se n√£o tem sess√£o ativa, permitir apenas visualizar pr√≥pria ficha
            # N√£o redirecionar, apenas aplicar filtro mais restritivo
            pass
    
        # Log do filtro aplicado para debug
        print(f"DEBUG - Fichas de Conceito - Filtro hierarquico aplicado para {request.user.username}:")
        if funcao_militar:
            print(f"   - Fun√ß√£o: {funcao_militar.nome}")
            print(f"   - Tipo de acesso: {funcao_militar.get_acesso_display()}")
        else:
            print(f"   - Sem fun√ß√£o ativa - permitindo apenas pr√≥pria ficha")
        
        if militar_id:
            militar = get_object_or_404(Militar, pk=militar_id)
            fichas_oficiais = list(militar.fichaconceitooficiais_set.all())
            fichas_pracas = list(militar.fichaconceitopracas_set.all())
            fichas = fichas_oficiais + fichas_pracas
            fichas.sort(key=lambda x: x.data_registro, reverse=True)
            militares_com_ficha = fichas
            militares_sem_ficha = []
        else:
            militar = None
        
            # Buscar oficiais ativos
            oficiais = Militar.objects.filter(
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            )
            
            # Buscar pra√ßas ativas
            pracas = Militar.objects.filter(
                posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
            )
        
            # Aplicar filtro de tipo com filtros hier√°rquicos
            if funcao_usuario:
                # Com fun√ß√£o ativa, aplicar filtros hier√°rquicos
                if tipo_filtro == 'oficiais':
                    militares_ativos = oficiais
                    fichas_oficiais = list(aplicar_filtro_hierarquico_fichas(FichaConceitoOficiais.objects, funcao_usuario, request.user).filter(militar__in=oficiais))
                    fichas_pracas = []
                elif tipo_filtro == 'pracas':
                    militares_ativos = pracas
                    fichas_oficiais = []
                    fichas_pracas = list(aplicar_filtro_hierarquico_fichas(FichaConceitoPracas.objects, funcao_usuario, request.user).filter(militar__in=pracas))
                else:  # todos
                    militares_ativos = list(oficiais) + list(pracas)
                    fichas_oficiais = list(aplicar_filtro_hierarquico_fichas(FichaConceitoOficiais.objects, funcao_usuario, request.user).filter(militar__in=oficiais))
                    fichas_pracas = list(aplicar_filtro_hierarquico_fichas(FichaConceitoPracas.objects, funcao_usuario, request.user).filter(militar__in=pracas))
            else:
                # Sem fun√ß√£o ativa, buscar todas as fichas (ser√° filtrado depois para mostrar apenas pr√≥pria)
                if tipo_filtro == 'oficiais':
                    militares_ativos = oficiais
                    fichas_oficiais = list(FichaConceitoOficiais.objects.filter(militar__in=oficiais))
                    fichas_pracas = []
                elif tipo_filtro == 'pracas':
                    militares_ativos = pracas
                    fichas_oficiais = []
                    fichas_pracas = list(FichaConceitoPracas.objects.filter(militar__in=pracas))
                else:  # todos
                    militares_ativos = list(oficiais) + list(pracas)
                    fichas_oficiais = list(FichaConceitoOficiais.objects.filter(militar__in=oficiais))
                    fichas_pracas = list(FichaConceitoPracas.objects.filter(militar__in=pracas))
        
            # Combinar fichas
            fichas = fichas_oficiais + fichas_pracas
            
            # Log das fichas encontradas
            print(f"   - Fichas de oficiais encontradas: {len(fichas_oficiais)}")
            print(f"   - Fichas de pra√ßas encontradas: {len(fichas_pracas)}")
            print(f"   - Total de fichas: {len(fichas)}")
        
            # Hierarquia para ordena√ß√£o
            hierarquia_oficiais = {
                'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8,
            }
            hierarquia_pracas = {
                'ST': 1, '1S': 2, '2S': 3, '3S': 4, 'CAB': 5, 'SD': 6,
            }
            
            # Ordenar fichas existentes
            fichas_list = list(fichas)
            fichas_list.sort(key=lambda x: (
                hierarquia_oficiais.get(x.militar.posto_graduacao, 999) if x.militar.is_oficial() 
                else hierarquia_pracas.get(x.militar.posto_graduacao, 999),
                x.militar.nome_completo
            ))
            
            # Buscar militares sem ficha
            militares_sem_ficha = []
            for m in militares_ativos:
                if not (m.fichaconceitooficiais_set.exists() or m.fichaconceitopracas_set.exists()):
                    militares_sem_ficha.append(m)
        
            # Ordenar militares sem ficha
            militares_sem_ficha.sort(key=lambda x: (
                hierarquia_oficiais.get(x.posto_graduacao, 999) if x.is_oficial() 
                else hierarquia_pracas.get(x.posto_graduacao, 999),
                x.nome_completo
            ))
            
            militares_com_ficha = fichas_list
    
        # Estat√≠sticas com filtros hier√°rquicos
        if militar_id:
            # Para militar espec√≠fico, usar estat√≠sticas globais
            total_oficiais_ativos = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            ).count()
            
            total_pracas_ativos = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
            ).count()
        else:
            # Para listagem geral, usar todos os militares
            total_oficiais_ativos = Militar.objects.filter(
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            ).count()
            
            total_pracas_ativos = Militar.objects.filter(
                posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
            ).count()
        
        # Montar lista final: primeiro os sem ficha, depois os com ficha
        fichas_final = militares_sem_ficha + militares_com_ficha
    
        # Aplicar filtro de permiss√£o baseado na fun√ß√£o militar da sess√£o
        # Superusu√°rios e usu√°rios com acesso TOTAL podem visualizar todas as fichas
        # Se n√£o tem permiss√£o geral, aplicar filtro (que permite ver pr√≥pria ficha)
        if not request.user.is_superuser:
            if funcao_militar and funcao_militar.acesso != 'TOTAL' and not pode_visualizar_fichas_conceito(request.user):
                fichas_final = filtrar_fichas_conceito_por_usuario(request.user, fichas_final)
                militares_com_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_com_ficha)
                militares_sem_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_sem_ficha)
            elif not funcao_militar and not pode_visualizar_fichas_conceito(request.user):
                # Sem fun√ß√£o ativa, permitir apenas pr√≥pria ficha
                fichas_final = filtrar_fichas_conceito_por_usuario(request.user, fichas_final)
                militares_com_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_com_ficha)
                militares_sem_ficha = filtrar_fichas_conceito_por_usuario(request.user, militares_sem_ficha)

        context = {
            'militar': militar,
            'fichas': fichas_final,
            'total_oficiais_ativos': total_oficiais_ativos,
            'total_pracas_ativos': total_pracas_ativos,
            'total_fichas_oficiais': len([f for f in militares_com_ficha if hasattr(f, 'militar') and f.militar.is_oficial()]),
            'total_fichas_pracas': len([f for f in militares_com_ficha if hasattr(f, 'militar') and not f.militar.is_oficial()]),
            'militares_sem_ficha': militares_sem_ficha,
            'militares_com_ficha': militares_com_ficha,
            'tipo_filtro': tipo_filtro,
            'pode_editar_fichas_conceito': pode_editar_fichas_conceito(request.user),
        }
        return render(request, 'militares/ficha_conceito_list.html', context)

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_create(request):
    """Cria nova ficha de conceito"""
    if request.method == 'POST':
        # Determinar qual formul√°rio usar baseado no tipo de militar
        militar_id = request.POST.get('militar')
        if militar_id:
            militar = Militar.objects.get(id=militar_id)
            if militar.is_oficial():
                form = FichaConceitoOficiaisForm(request.POST)
            else:
                form = FichaConceitoPracasForm(request.POST)
        else:
            # Formul√°rio padr√£o para oficiais
            form = FichaConceitoOficiaisForm(request.POST)
        
        if form.is_valid():
            ficha = form.save()
            messages.success(request, f'Ficha de conceito registrada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        # Formul√°rio padr√£o para oficiais
        form = FichaConceitoOficiaisForm()
    
    context = {
        'form': form,
        'title': 'Nova Ficha de Conceito',
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_detail.html', context)

@login_required

@login_required
def teste_modal(request):
    """View tempor√°ria para testar modais Bootstrap"""
    return render(request, 'teste_bootstrap_modal.html')

@login_required
def teste_ficha_conceito_modal(request):
    """View tempor√°ria para testar modal da ficha de conceito"""
    return render(request, 'teste_ficha_conceito_modal.html')

@login_required
def teste_modal_debug(request):
    """View tempor√°ria para testar debug do modal"""
    return render(request, 'teste_modal_debug.html')

@login_required
def teste_modal_simples(request):
    """View tempor√°ria para testar modal simples"""
    return render(request, 'teste_modal_simples.html')

@login_required
@requer_funcao_ativa
def militar_list(request):
    """Lista todos os militares ativos com pagina√ß√£o e busca"""
    militares = Militar.objects.filter(classificacao='ATIVO')

    # Ordena√ß√£o padr√£o por hierarquia e antiguidade
    ordenacao = 'hierarquia_antiguidade'
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,  # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
        'NVRR': 15,  # NVRR - tratado separadamente
    }
    
    if ordenacao == 'hierarquia_antiguidade':
        # Ordenar por hierarquia de postos e depois por antiguidade
        # Para Subtenentes, ordenar primeiro os que t√™m CHO, depois os que n√£o t√™m
        # Cada grupo de Subtenentes (com CHO e sem CHO) ter√° sua pr√≥pria numera√ß√£o de antiguidade
        # OTIMIZA√á√ÉO: Usar order_by simples em vez de sorted() em Python
        militares = militares.order_by('posto_graduacao', 'numeracao_antiguidade', 'nome_completo')
        
        # Reordenar numera√ß√£o de antiguidade para Subtenentes separadamente por CHO
        if militares:
            # Separar Subtenentes dos outros postos
            subtenentes = [m for m in militares if m.posto_graduacao == 'ST']
            outros_militares = [m for m in militares if m.posto_graduacao != 'ST']
            
            if subtenentes:
                # Separar Subtenentes com CHO e sem CHO
                subtenentes_com_cho = [m for m in subtenentes if m.curso_cho]
                subtenentes_sem_cho = [m for m in subtenentes if not m.curso_cho]
                
                # Reordenar numera√ß√£o para Subtenentes com CHO
                for i, militar in enumerate(subtenentes_com_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reordenar numera√ß√£o para Subtenentes sem CHO
                for i, militar in enumerate(subtenentes_sem_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reconstruir a lista com Subtenentes reordenados
                militares = outros_militares + subtenentes_com_cho + subtenentes_sem_cho
    elif ordenacao == 'posto':
        militares = militares.order_by('posto_graduacao', 'nome_completo')
    elif ordenacao == 'matricula':
        militares = militares.order_by('matricula')
    elif ordenacao == 'data_ingresso':
        militares = militares.order_by('data_ingresso')
    elif ordenacao == 'numeracao_antiguidade':
        militares = militares.order_by('numeracao_antiguidade', 'nome_completo')
    elif ordenacao == 'pontuacao':
        militares = militares.annotate(
            pontuacao_total=Sum('fichaconceitooficiais__pontos') + Sum('fichaconceitopracas__pontos')
        ).order_by('-pontuacao_total')
    else:
        militares = militares.order_by('nome_completo')

    # Adicionar lota√ß√£o atual para cada militar
    for militar in militares:
        militar.lotacao_atual_obj = militar.lotacao_atual()
    
    # Sem pagina√ß√£o - mostrar todos os militares
    context = {
        'militares': militares,
    }
    
    return render(request, 'militares/militar_list.html', context)


@login_required
@admin_bypass
def militar_create(request):
    """Cria um novo militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes e diretores de gest√£o de pessoas podem cadastrar.')
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES)
        if form.is_valid():
            militar = form.save()
            messages.success(request, f'Militar {militar.nome_completo} cadastrado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao cadastrar militar. Verifique os dados.')
    else:
        form = MilitarForm()
    
    context = {
        'form': form,
        'title': 'Novo Militar',
        'action': 'create',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
@login_required
@admin_bypass
def militar_delete(request, pk):
    """Remove um militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem excluir.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        nome = militar.nome_completo
        militar.delete()
        messages.success(request, f'Militar {nome} removido com sucesso!')
        return redirect('militares:militar_list')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_confirm_delete.html', context)

def militar_search_ajax(request):
    """Busca militares via AJAX para autocomplete"""
    query = request.GET.get('q', '')
    if len(query) < 2:
        return JsonResponse({'results': []})
    
    # Filtrar militares excluindo coron√©is (√∫ltimo posto)
    militares = Militar.objects.filter(
        Q(nome_completo__icontains=query) |
        Q(nome_guerra__icontains=query) |
        Q(matricula__icontains=query)
    ).exclude(
        posto_graduacao='CB'  # Excluir coron√©is
    )[:10]
    
    results = []
    for militar in militares:
        results.append({
            'id': militar.id,
            'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}",
            'nome': militar.nome_completo,
            'matricula': militar.matricula,
            'posto': militar.get_posto_graduacao_display(),
        })
    
    return JsonResponse({'results': results})

@login_required
def militar_dashboard(request):
    """Dashboard principal do sistema"""
    total_militares = Militar.objects.count()
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
    fichas_pendentes = FichaConceitoOficiais.objects.count() + FichaConceitoPracas.objects.count()
    documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
    
    # Estat√≠sticas por quadro
    estatisticas_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ).order_by('quadro')
    
    # √öltimas fichas de conceito
    fichas_oficiais = list(FichaConceitoOficiais.objects.select_related('militar').order_by('-data_registro')[:5])
    fichas_pracas = list(FichaConceitoPracas.objects.select_related('militar').order_by('-data_registro')[:5])
    ultimas_fichas = fichas_oficiais + fichas_pracas
    ultimas_fichas.sort(key=lambda x: x.data_registro, reverse=True)
    ultimas_fichas = ultimas_fichas[:5]
    
    # Documentos recentes
    documentos_recentes = Documento.objects.select_related('militar').order_by('-data_upload')[:5]
    
    # Quadros de acesso recentes
    quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
    
    # Notifica√ß√µes do usu√°rio
    notificacoes_base = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).order_by('-prioridade', '-data_criacao')
    
    # Contadores de notifica√ß√µes (antes do slice)
    total_notificacoes = notificacoes_base.count()
    notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
    notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
    
    # Aplicar slice apenas para exibi√ß√£o
    notificacoes = notificacoes_base[:10]
    
    context = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'fichas_pendentes': fichas_pendentes,
        'documentos_pendentes': documentos_pendentes,
        'estatisticas_quadro': estatisticas_quadro,
        'ultimas_fichas': ultimas_fichas,
        'documentos_recentes': documentos_recentes,
        'quadros_recentes': quadros_recentes,
        'notificacoes': notificacoes,
        'total_notificacoes': total_notificacoes,
        'notificacoes_urgentes': notificacoes_urgentes,
        'notificacoes_altas': notificacoes_altas,
    }
    
    return render(request, 'militares/dashboard.html', context)

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_create(request):
    """Cria nova ficha de conceito"""
    if request.method == 'POST':
        # Determinar qual formul√°rio usar baseado no tipo de militar
        militar_id = request.POST.get('militar')
        if militar_id:
            militar = Militar.objects.get(id=militar_id)
            if militar.is_oficial():
                form = FichaConceitoOficiaisForm(request.POST)
            else:
                form = FichaConceitoPracasForm(request.POST)
        else:
            # Formul√°rio padr√£o para oficiais
            form = FichaConceitoOficiaisForm(request.POST)
        
        if form.is_valid():
            ficha = form.save()
            messages.success(request, f'Ficha de conceito registrada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        # Formul√°rio padr√£o para oficiais
        form = FichaConceitoOficiaisForm()
    
    context = {
        'form': form,
        'title': 'Nova Ficha de Conceito',
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_detail.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_delete(request, pk):
    """Excluir ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        ficha.delete()
        messages.success(request, 'Ficha de conceito exclu√≠da com sucesso!')
        return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_confirm_delete.html', context)

@login_required
def documento_upload(request, ficha_pk):
    """Faz upload de documentos para uma ficha de conceito"""
    ficha = get_object_or_404(FichaConceitoOficiais, pk=ficha_pk)
    
    if request.method == 'POST':
        form = DocumentoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.ficha_conceito = ficha
            documento.save()
            messages.success(request, 'Documento enviado com sucesso!')
            return redirect('militares:ficha_conceito_detail', pk=ficha_pk)
        else:
            messages.error(request, 'Erro ao enviar documento. Verifique os dados.')
    else:
        form = DocumentoForm()
    
    context = {
        'form': form,
        'ficha': ficha,
    }
    
    return render(request, 'militares/documento_upload.html', context)

# Views para Quadros de Acesso
@login_required
def quadro_acesso_list(request):
    """Lista todos os quadros de acesso com filtros hier√°rquicos"""
    from militares.permissoes_simples import tem_permissao
    from militares.filtros_hierarquicos_adicionais import aplicar_filtro_hierarquico_quadros_acesso
    from militares.permissoes_hierarquicas import obter_funcao_militar_ativa
    
    # Obter fun√ß√£o militar ativa
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    # Aplicar filtros hier√°rquicos baseados no acesso da fun√ß√£o
    if request.user.is_superuser:
        quadros = QuadroAcesso.objects.all()
    elif funcao_usuario and tem_permissao(request.user, 'quadros_acesso', 'visualizar'):
        quadros = aplicar_filtro_hierarquico_quadros_acesso(QuadroAcesso.objects.all(), funcao_usuario, request.user)
    else:
        quadros = QuadroAcesso.objects.none()

    # Filtros
    tipo = request.GET.get('tipo')
    if tipo:
        quadros = quadros.filter(tipo=tipo)
    
    status = request.GET.get('status')
    if status:
        quadros = quadros.filter(status=status)
    
    # Ordena√ß√£o
    ordenacao = request.GET.get('ordenacao', '-data_criacao')
    quadros = quadros.order_by(ordenacao)
    
    # Adicionar quantidade de militares para cada quadro
    for quadro in quadros:
        quadro.total_militares_count = quadro.total_militares()
    
    # Verificar se √© uma requisi√ß√£o AJAX
    if request.GET.get('ajax') == '1':
        import json
        
        # Preparar dados para JSON
        quadros_data = []
        for quadro in quadros:
            quadros_data.append({
                'id': quadro.id,
                'tipo': quadro.tipo,
                'get_tipo_display': quadro.get_tipo_display(),
                'data_promocao': quadro.data_promocao.strftime('%d/%m/%Y'),
                'status': quadro.status,
                'get_status_display': quadro.get_status_display(),
                'total_militares': quadro.total_militares(),
                'motivo_nao_elaboracao': quadro.motivo_nao_elaboracao,
                'get_motivo_display_completo': quadro.get_motivo_display_completo() if quadro.motivo_nao_elaboracao else None,
            })
        
        return JsonResponse({
            'quadros': quadros_data,
            'total': len(quadros_data)
        })
    
    # Calcular estat√≠sticas
    total_quadros = quadros.count()
    elaborados = quadros.filter(status='ELABORADO').count()
    homologados = quadros.filter(status='HOMOLOGADO').count()
    nao_elaborados = quadros.filter(status='NAO_ELABORADO').count()
    em_elaboracao = quadros.filter(status='EM_ELABORACAO').count()
    
    context = {
        'quadros': quadros,
        'tipos': QuadroAcesso.TIPO_CHOICES,
        'status_choices': QuadroAcesso.STATUS_CHOICES,
        'filtros': {
            'tipo': tipo,
            'status': status,
            'ordenacao': ordenacao
        },
        'estatisticas': {
            'total': total_quadros,
            'elaborados': elaborados,
            'homologados': homologados,
            'nao_elaborados': nao_elaborados,
            'em_elaboracao': em_elaboracao,
        }
    }
    
    return render(request, 'militares/quadro_acesso_list.html', context)

@login_required
@requer_funcao_ativa
def militar_list(request):
    """Lista todos os militares ativos com pagina√ß√£o e busca"""
    militares = Militar.objects.filter(classificacao='ATIVO')

    # Ordena√ß√£o padr√£o por hierarquia e antiguidade
    ordenacao = 'hierarquia_antiguidade'
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,  # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    if ordenacao == 'hierarquia_antiguidade':
        # Ordenar por hierarquia de postos e depois por antiguidade
        # Para Subtenentes, ordenar primeiro os que t√™m CHO, depois os que n√£o t√™m
        # Cada grupo de Subtenentes (com CHO e sem CHO) ter√° sua pr√≥pria numera√ß√£o de antiguidade
        # OTIMIZA√á√ÉO: Usar order_by simples em vez de sorted() em Python
        militares = militares.order_by('posto_graduacao', 'numeracao_antiguidade', 'nome_completo')
        
        # Reordenar numera√ß√£o de antiguidade para Subtenentes separadamente por CHO
        if militares:
            # Separar Subtenentes dos outros postos
            subtenentes = [m for m in militares if m.posto_graduacao == 'ST']
            outros_militares = [m for m in militares if m.posto_graduacao != 'ST']
            
            if subtenentes:
                # Separar Subtenentes com CHO e sem CHO
                subtenentes_com_cho = [m for m in subtenentes if m.curso_cho]
                subtenentes_sem_cho = [m for m in subtenentes if not m.curso_cho]
                
                # Reordenar numera√ß√£o para Subtenentes com CHO
                for i, militar in enumerate(subtenentes_com_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reordenar numera√ß√£o para Subtenentes sem CHO
                for i, militar in enumerate(subtenentes_sem_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reconstruir a lista com Subtenentes reordenados
                militares = outros_militares + subtenentes_com_cho + subtenentes_sem_cho
    elif ordenacao == 'posto':
        militares = militares.order_by('posto_graduacao', 'nome_completo')
    elif ordenacao == 'matricula':
        militares = militares.order_by('matricula')
    elif ordenacao == 'data_ingresso':
        militares = militares.order_by('data_ingresso')
    elif ordenacao == 'numeracao_antiguidade':
        militares = militares.order_by('numeracao_antiguidade', 'nome_completo')
    elif ordenacao == 'pontuacao':
        militares = militares.annotate(
            pontuacao_total=Sum('fichaconceitooficiais__pontos') + Sum('fichaconceitopracas__pontos')
        ).order_by('-pontuacao_total')
    else:
        militares = militares.order_by('nome_completo')

    # Adicionar lota√ß√£o atual para cada militar
    for militar in militares:
        militar.lotacao_atual_obj = militar.lotacao_atual()
    
    # Sem pagina√ß√£o - mostrar todos os militares
    context = {
        'militares': militares,
    }
    
    return render(request, 'militares/militar_list.html', context)


@login_required
@admin_bypass
def militar_create(request):
    """Cria um novo militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes e diretores de gest√£o de pessoas podem cadastrar.')
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES)
        if form.is_valid():
            militar = form.save()
            messages.success(request, f'Militar {militar.nome_completo} cadastrado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao cadastrar militar. Verifique os dados.')
    else:
        form = MilitarForm()
    
    context = {
        'form': form,
        'title': 'Novo Militar',
        'action': 'create',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
@login_required
@admin_bypass
def militar_delete(request, pk):
    """Remove um militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem excluir.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        nome = militar.nome_completo
        militar.delete()
        messages.success(request, f'Militar {nome} removido com sucesso!')
        return redirect('militares:militar_list')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_confirm_delete.html', context)

def militar_search_ajax(request):
    """Busca militares via AJAX para autocomplete"""
    query = request.GET.get('q', '')
    if len(query) < 2:
        return JsonResponse({'results': []})
    
    # Filtrar militares excluindo coron√©is (√∫ltimo posto)
    militares = Militar.objects.filter(
        Q(nome_completo__icontains=query) |
        Q(nome_guerra__icontains=query) |
        Q(matricula__icontains=query)
    ).exclude(
        posto_graduacao='CB'  # Excluir coron√©is
    )[:10]
    
    results = []
    for militar in militares:
        results.append({
            'id': militar.id,
            'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}",
            'nome': militar.nome_completo,
            'matricula': militar.matricula,
            'posto': militar.get_posto_graduacao_display(),
        })
    
    return JsonResponse({'results': results})

@login_required
def militar_dashboard(request):
    """Dashboard principal do sistema"""
    total_militares = Militar.objects.count()
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
    fichas_pendentes = FichaConceitoOficiais.objects.count() + FichaConceitoPracas.objects.count()
    documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
    
    # Estat√≠sticas por quadro
    estatisticas_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ).order_by('quadro')
    
    # √öltimas fichas de conceito
    fichas_oficiais = list(FichaConceitoOficiais.objects.select_related('militar').order_by('-data_registro')[:5])
    fichas_pracas = list(FichaConceitoPracas.objects.select_related('militar').order_by('-data_registro')[:5])
    ultimas_fichas = fichas_oficiais + fichas_pracas
    ultimas_fichas.sort(key=lambda x: x.data_registro, reverse=True)
    ultimas_fichas = ultimas_fichas[:5]
    
    # Documentos recentes
    documentos_recentes = Documento.objects.select_related('militar').order_by('-data_upload')[:5]
    
    # Quadros de acesso recentes
    quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
    
    # Notifica√ß√µes do usu√°rio
    notificacoes_base = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).order_by('-prioridade', '-data_criacao')
    
    # Contadores de notifica√ß√µes (antes do slice)
    total_notificacoes = notificacoes_base.count()
    notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
    notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
    
    # Aplicar slice apenas para exibi√ß√£o
    notificacoes = notificacoes_base[:10]
    
    context = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'fichas_pendentes': fichas_pendentes,
        'documentos_pendentes': documentos_pendentes,
        'estatisticas_quadro': estatisticas_quadro,
        'ultimas_fichas': ultimas_fichas,
        'documentos_recentes': documentos_recentes,
        'quadros_recentes': quadros_recentes,
        'notificacoes': notificacoes,
        'total_notificacoes': total_notificacoes,
        'notificacoes_urgentes': notificacoes_urgentes,
        'notificacoes_altas': notificacoes_altas,
    }
    
    return render(request, 'militares/dashboard.html', context)

# Views para Ficha de Conceito

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_create(request):
    """Cria nova ficha de conceito"""
    if request.method == 'POST':
        # Determinar qual formul√°rio usar baseado no tipo de militar
        militar_id = request.POST.get('militar')
        if militar_id:
            militar = Militar.objects.get(id=militar_id)
            if militar.is_oficial():
                form = FichaConceitoOficiaisForm(request.POST)
            else:
                form = FichaConceitoPracasForm(request.POST)
        else:
            # Formul√°rio padr√£o para oficiais
            form = FichaConceitoOficiaisForm(request.POST)
        
        if form.is_valid():
            ficha = form.save()
            messages.success(request, f'Ficha de conceito registrada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        # Formul√°rio padr√£o para oficiais
        form = FichaConceitoOficiaisForm()
    
    context = {
        'form': form,
        'title': 'Nova Ficha de Conceito',
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_detail.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_delete(request, pk):
    """Excluir ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        ficha.delete()
        messages.success(request, 'Ficha de conceito exclu√≠da com sucesso!')
        return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_confirm_delete.html', context)

@login_required
def documento_upload(request, ficha_pk):
    """Faz upload de documentos para uma ficha de conceito"""
    ficha = get_object_or_404(FichaConceitoOficiais, pk=ficha_pk)
    
    if request.method == 'POST':
        form = DocumentoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.ficha_conceito = ficha
            documento.save()
            messages.success(request, 'Documento enviado com sucesso!')
            return redirect('militares:ficha_conceito_detail', pk=ficha_pk)
        else:
            messages.error(request, 'Erro ao enviar documento. Verifique os dados.')
    else:
        form = DocumentoForm()
    
    context = {
        'form': form,
        'ficha': ficha,
    }
    
    return render(request, 'militares/documento_upload.html', context)

# Views para Quadros de Acesso
@login_required
@requer_perm_quadros_visualizar
@login_required
@requer_perm_quadros_visualizar
def quadro_acesso_detail(request, pk):
    """Exibe detalhes de um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    militares_inaptos = quadro.militares_inaptos_com_motivo()

    nomes_postos = dict(QuadroAcesso.POSTO_CHOICES)
    nomes_quadros = dict(QuadroAcesso.QUADRO_CHOICES)
    
    # Definir ordem dos quadros e transi√ß√µes (do mais graduado ao menos graduado)
    quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    
    # Verificar se √© um quadro de pra√ßas
    if quadro.tipo == 'PRACAS':
        # Para quadros de pra√ßas: transi√ß√µes espec√≠ficas para pra√ßas
        quadros = ['PRACAS']
        transicoes_por_quadro = {
            'PRACAS': [  # Pra√ßas
                {
                    'numero': 'I',
                    'titulo': '1¬∫ SARGENTO para o posto de SUBTENENTE',
                    'origem': '1S',
                    'destino': 'ST',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Subtenente em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': '2¬∫ SARGENTO para o posto de 1¬∫ SARGENTO',
                    'origem': '2S',
                    'destino': '1S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '3¬∫ SARGENTO para o posto de 2¬∫ SARGENTO',
                    'origem': '3S',
                    'destino': '2S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': 'CABO para o posto de 3¬∫ SARGENTO',
                    'origem': 'CAB',
                    'destino': '3S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 3¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SOLDADO para o posto de CABO',
                    'origem': 'SD',
                    'destino': 'CAB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Cabo em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    elif quadro.tipo == 'MERECIMENTO':
        # Para quadros de merecimento: transi√ß√µes espec√≠ficas conforme regras
        transicoes_por_quadro = {
            'COMB': [  # Combatente - inclui TC‚ÜíCB
                {
                    'numero': 'I',
                    'titulo': 'TENENTE-CORONEL para o posto de CORONEL',
                    'origem': 'TC',
                    'destino': 'CB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar - apenas CP‚ÜíMJ (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    else:
        # Para quadros de antiguidade: todas as transi√ß√µes por antiguidade
        transicoes_por_quadro = {
            'COMB': [  # Combatente
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ASPIRANTE A OFICIAL para o posto de 2¬∫ TENENTE',
                    'origem': 'AS',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }

            ],
            'SAUDE': [  # Sa√∫de
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar
                # OCULTO TEMPORARIAMENTE - MAJOR para TENENTE-CORONEL
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SUBTENENTE para o posto de 2¬∫ TENENTE',
                    'origem': 'ST',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    
    # Buscar todos os militares aptos do quadro
    militares_aptos = quadro.itemquadroacesso_set.all().select_related('militar').order_by('posicao')
    
    # OCULTO TEMPORARIAMENTE - L√≥gica especial para o quadro ID 312 - for√ßar exibi√ß√£o da transi√ß√£o Major ‚Üí Tenente-Coronel
    # if quadro.id == 312:
    #     # Criar transi√ß√£o especial de Major para Tenente-Coronel para todos os quadros
    #     transicao_especial = {
    #         'numero': 'I',
    #         'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
    #         'origem': 'MJ',
    #         'destino': 'TC',
    #         'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
    #     }
    #     # Adicionar a transi√ß√£o especial em todos os quadros
    #     for q in quadros:
    #         if q in transicoes_por_quadro:
    #                 transicoes_por_quadro[q].insert(0, transicao_especial)
    
    # Organizar militares por quadro e transi√ß√£o
    estrutura_quadros = {}
    for q in quadros:
        estrutura_quadros[q] = {
            'nome': nomes_quadros.get(q, q),
            'transicoes': []
        }
        transicoes_do_quadro = transicoes_por_quadro.get(q, [])
        for transicao in transicoes_do_quadro:
            origem = transicao['origem']
            destino = transicao['destino']
            # Filtrar apenas subtenentes do quadro PRACAS para a transi√ß√£o ST->2T do COMP
            if q == 'COMP' and origem == 'ST' and destino == '2T':
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == 'PRACAS' and item.militar.posto_graduacao == 'ST'
                ]
            else:
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == q and item.militar.posto_graduacao == origem
                ]
            estrutura_quadros[q]['transicoes'].append({
                'origem': origem,
                'destino': destino,
                'origem_nome': nomes_postos.get(origem, origem),
                'destino_nome': nomes_postos.get(destino, destino),
                'militares': militares_desta_transicao,
            })
    
    context = {
        'quadro': quadro,
        'militares_inaptos': militares_inaptos,
        'total_inaptos': len(militares_inaptos),
        'estrutura_quadros': estrutura_quadros,
    }
    
    # OCULTO TEMPORARIAMENTE - Garantir exibi√ß√£o da transi√ß√£o MJ‚ÜíTC em todos os quadros de acesso
    # for q in estrutura_quadros:
    #     transicoes = estrutura_quadros[q]['transicoes']
    #     existe = any(
    #         t['origem'] == 'MJ' and t['destino'] == 'TC'
    #         for t in transicoes
    #     )
    #     if not existe:
    #         # Buscar militares Major do quadro correspondente
    #         militares_mj_tc = [
    #             item for item in militares_aptos 
    #             if item.militar.quadro == q and item.militar.posto_graduacao == 'MJ'
    #         ]
    #         estrutura_quadros[q]['transicoes'].insert(0, {
    #             'origem': 'MJ',
    #             'destino': 'TC',
    #             'origem_nome': nomes_postos.get('MJ', 'MJ'),
    #             'destino_nome': nomes_postos.get('TC', 'TC'),
    #             'militares': militares_mj_tc,
    #         })
    
    return render(request, 'militares/quadro_acesso_detail.html', context)

@login_required
def gerar_quadro_acesso(request):
    """Gera um quadro de acesso √∫nico por tipo e data, incluindo todos os postos"""
    if request.method == 'POST':
        tipo = request.POST.get('tipo')
        data_promocao = request.POST.get('data_promocao')
        categoria = request.POST.get('categoria', 'OFICIAIS')
        
        # Log para debug
        print(f"DEBUG - Tipo: {tipo}")
        print(f"DEBUG - Categoria: {categoria}")
        print(f"DEBUG - Data: {data_promocao}")
        print(f"DEBUG - Todos os POST data: {request.POST}")
        
        if not tipo:
            messages.error(request, 'O tipo de acesso √© obrigat√≥rio.')
            return redirect('militares:gerar_quadro_acesso')
        
        # Se n√£o foi fornecida uma data, usar a data autom√°tica
        if not data_promocao:
            # Determinar o tipo baseado no quadro (OFICIAIS ou PRACAS)
            quadro_tipo = request.POST.get('quadro', 'OFICIAIS')
            data_promocao = calcular_proxima_data_promocao(tipo=quadro_tipo)
            data_automatica = True
        else:
            try:
                data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                data_automatica = False
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:gerar_quadro_acesso')
        
        # Verificar se j√° existe um quadro para este tipo, data e categoria
        quadros_existentes = QuadroAcesso.objects.filter(
            tipo=tipo,
            data_promocao=data_promocao,
            categoria=categoria
        ).order_by('data_criacao')
        
        # Determinar se √© um aditamento
        is_aditamento = quadros_existentes.exists()
        
        # Criar um √∫nico quadro que representar√° todos os postos
        try:
            # Obter a categoria selecionada
            categoria = request.POST.get('categoria', 'OFICIAIS')
            
            print(f"DEBUG - Criando quadro com categoria: {categoria}")
            print(f"DEBUG - √â aditamento: {is_aditamento}")
            
            # Determinar o n√∫mero do aditamento se for um aditamento
            numero_aditamento = None
            if is_aditamento:
                # Contar quantos aditamentos j√° existem
                numero_aditamento = quadros_existentes.count() + 1
                print(f"DEBUG - N√∫mero do aditamento: {numero_aditamento}")
            
            novo_quadro = QuadroAcesso.objects.create(
                tipo=tipo,
                categoria=categoria,
                data_promocao=data_promocao,
                status='EM_ELABORACAO',
                observacoes=f"Quadro de {tipo.lower()} para {categoria.lower()} - {data_promocao.strftime('%d/%m/%Y')} - Inclui todos os postos"
            )
            
            # Se for aditamento, for√ßar a gera√ß√£o do n√∫mero com aditamento
            if is_aditamento and numero_aditamento:
                # Gerar o n√∫mero base
                ano = data_promocao.year
                mes = data_promocao.month
                dia = data_promocao.day
                tipo_prefixo = 'OF' if categoria == 'OFICIAIS' else 'PR'
                
                # Prefixo do quadro
                if tipo == 'ANTIGUIDADE':
                    quadro_prefixo = 'QAA'
                elif tipo == 'MERECIMENTO':
                    quadro_prefixo = 'QAM'
                else:
                    quadro_prefixo = 'QAA'
                
                base_numero = f"{quadro_prefixo}-{tipo_prefixo}-{ano:04d}/{mes:02d}/{dia:02d}"
                
                # Se for o primeiro quadro (n√£o aditamento), usar -01
                if numero_aditamento == 1:
                    novo_quadro.numero = f"{base_numero} - 01"
                else:
                    # Se for aditamento, usar -a01, -a02, etc.
                    novo_quadro.numero = f"{base_numero} - a{numero_aditamento:02d}"
                
                novo_quadro.save()
                print(f"DEBUG - N√∫mero gerado para aditamento: {novo_quadro.numero}")
            
            # --- SEGURAN√áA EXTRA: Remover assinaturas √≥rf√£s e antigas ---
            from militares.models import AssinaturaQuadroAcesso, QuadroAcesso
            # Remove assinaturas √≥rf√£s (sem quadro)
            AssinaturaQuadroAcesso.objects.filter(quadro_acesso__isnull=True).delete()
            # Remove assinaturas associadas a quadros antigos com a mesma data, tipo e categoria
            quadros_antigos = QuadroAcesso.objects.filter(
                data_promocao=data_promocao,
                tipo=tipo,
                categoria=categoria
            ).exclude(pk=novo_quadro.pk)
            AssinaturaQuadroAcesso.objects.filter(quadro_acesso__in=quadros_antigos).delete()
            # --- FIM DA SEGURAN√áA EXTRA ---
            
            print(f"DEBUG - Quadro criado com ID: {novo_quadro.pk}, categoria: {novo_quadro.categoria}")
            
            # Gerar o quadro com todos os postos
            sucesso, mensagem = novo_quadro.gerar_quadro_completo()
            
            if sucesso:
                if data_automatica:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso! Data autom√°tica: {data_promocao.strftime("%d/%m/%Y")}')
                else:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
                messages.success(request, mensagem)
                
                # Redirecionar para a view correta baseada na categoria
                print(f"DEBUG - Redirecionando para categoria: {novo_quadro.categoria}")
                if novo_quadro.categoria == 'PRACAS':
                    print(f"DEBUG - Redirecionando para pra√ßas: quadro_acesso_pracas_detail")
                    return redirect('militares:quadro_acesso_pracas_detail', pk=novo_quadro.pk)
                else:
                    print(f"DEBUG - Redirecionando para oficiais: quadro_acesso_detail")
                    return redirect('militares:quadro_acesso_detail', pk=novo_quadro.pk)
            else:
                novo_quadro.delete()
                messages.error(request, f'Erro ao criar quadro: {mensagem}')
                
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro: {str(e)}')
        
        return redirect('militares:gerar_quadro_acesso')
    
    context = {
        'tipos': QuadroAcesso.TIPO_CHOICES,
        'categorias': [
            ('OFICIAIS', 'Oficiais'),
            ('PRACAS', 'Pra√ßas')
        ],
        'categoria_selecionada': request.POST.get('categoria', 'OFICIAIS') if request.method == 'POST' else 'OFICIAIS',
        'quadros_recentes': QuadroAcesso.objects.all().order_by('-data_criacao')[:10],
        'proxima_data_automatica': calcular_proxima_data_promocao(tipo='OFICIAIS'),
    }
    
    return render(request, 'militares/gerar_quadro_acesso.html', context)

@login_required
def regerar_quadro_acesso(request, pk):
    """Regera um quadro de acesso existente"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        sucesso, mensagem = quadro.gerar_quadro_automatico()
        
        if sucesso:
            messages.success(request, mensagem)
        else:
            messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def delete_quadro_acesso(request, pk):
    """Exclui um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        # Verificar se o quadro est√° homologado (apenas para usu√°rios n√£o administradores)
        if quadro.status == 'HOMOLOGADO' and not request.user.is_superuser:
            messages.error(request, 'N√£o √© poss√≠vel excluir um quadro homologado. Apenas administradores podem excluir quadros homologados.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Excluir todos os itens do quadro primeiro
        quadro.itemquadroacesso_set.all().delete()
        # Excluir o quadro
        quadro.delete()
        
        if quadro.status == 'HOMOLOGADO':
            messages.success(request, 'Quadro de acesso homologado exclu√≠do com sucesso pelo administrador!')
        else:
            messages.success(request, 'Quadro de acesso exclu√≠do com sucesso!')
        return redirect('militares:quadro_acesso_list')
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_confirm_delete.html', context)

@login_required
def adicionar_oficial_quadro_oficiais(request, pk):
    """Adiciona um oficial ao quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, 'Quadro n√£o encontrado!')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        posicao = request.POST.get('posicao')
        pontuacao = request.POST.get('pontuacao')
        
        if not militar_id:
            messages.error(request, 'Militar n√£o selecionado!')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Verificar se o militar j√° est√° no quadro
            if quadro.itemquadroacesso_set.filter(militar=militar).exists():
                messages.error(request, f'O oficial {militar.nome_completo} j√° est√° no quadro.')
                return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Adicionar o militar ao quadro
            quadro.adicionar_militar_manual(militar, posicao, pontuacao)
            
            messages.success(request, f'Oficial {militar.nome_completo} adicionado ao quadro com sucesso!')
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
        except ValueError as e:
            messages.error(request, str(e))
        except Exception as e:
            messages.error(request, f'Erro ao adicionar militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def remover_militar_quadro_oficiais(request, pk, militar_id):
    """Remove um militar do quadro de acesso de oficiais"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado.')
        return redirect('militares:quadro_acesso_list')
    
    # Verificar se o quadro √© de oficiais
    if quadro.categoria != 'OFICIAIS':
        messages.error(request, 'Este quadro n√£o √© de oficiais!')
        return redirect('militares:quadro_acesso_list')
    
    if quadro.status == 'HOMOLOGADO':
        messages.error(request, 'Quadros homologados n√£o podem ser editados.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    try:
        militar = Militar.objects.get(pk=militar_id)
        
        # Verificar se o militar est√° no quadro
        item = quadro.itemquadroacesso_set.filter(militar=militar).first()
        if not item:
            messages.error(request, f'O oficial {militar.nome_completo} n√£o est√° no quadro.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Remover o militar
        quadro.remover_militar_manual(militar)
        
        messages.success(request, f'Oficial {militar.nome_completo} removido do quadro com sucesso!')
    except Militar.DoesNotExist:
        messages.error(request, 'Militar n√£o encontrado.')
    except ValueError as e:
        messages.error(request, str(e))
    except Exception as e:
        messages.error(request, f'Erro ao remover militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def buscar_oficiais_elegiveis(request):
    """Busca oficiais eleg√≠veis para promo√ß√£o"""
    if request.method == 'POST':
        form = BuscarOficiaisElegiveisForm(request.POST)
        if form.is_valid():
            data_promocao = form.cleaned_data['data_promocao']
            quadro = form.cleaned_data['quadro']
            posto_graduacao = form.cleaned_data['posto_graduacao']
            
            # Buscar oficiais eleg√≠veis
            oficiais_elegiveis = Militar.objects.oficiais_elegiveis_para_promocao(
                data_promocao=data_promocao,
                quadro=quadro,
                posto_graduacao=posto_graduacao
            )
            
            # Renderizar resultados
            context = {
                'oficiais_elegiveis': oficiais_elegiveis,
                'form': form,
            }
            return render(request, 'militares/buscar_oficiais_elegiveis.html', context)
    else:
        form = BuscarOficiaisElegiveisForm()
    
    context = {
        'form': form,
    }
    return render(request, 'militares/buscar_oficiais_elegiveis.html', context)

@login_required
def homologar_quadro_acesso(request, pk):
    """Homologa um quadro de acesso, solicitando confirma√ß√£o de senha via modal"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    # Verificar permiss√£o de homologa√ß√£o - apenas presidente da comiss√£o pode homologar
    if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
        # Para quadros de oficiais, verificar se √© presidente da CPO
        comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
        if not comissao_cpo or not comissao_cpo.eh_presidente(request.user):
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
            return redirect('militares:quadro_acesso_list')
    else:
        # Para quadros de pra√ßas, verificar se √© presidente da CPP
        comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
        if not comissao_cpp or not comissao_cpp.eh_presidente(request.user):
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
            return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        senha = request.POST.get('senha')
        if senha:
            user = authenticate(username=request.user.username, password=senha)
            if user is not None:
                if quadro.status == 'ELABORADO':
                    quadro.status = 'HOMOLOGADO'
                    quadro.data_homologacao = timezone.now().date()
                    quadro.homologado_por = request.user
                    quadro.save()
                    messages.success(request, 'Quadro de acesso homologado com sucesso!')
                    return redirect('militares:quadro_acesso_list')
                else:
                    messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
                    return redirect('militares:quadro_acesso_list')
            else:
                messages.error(request, 'Senha incorreta. Tente novamente.')
                return redirect('militares:quadro_acesso_list')
        else:
            messages.error(request, 'Senha √© obrigat√≥ria.')
            return redirect('militares:quadro_acesso_list')

    # Se chegou aqui, redirecionar para a lista
    return redirect('militares:quadro_acesso_list')

@login_required
def deshomologar_quadro_acesso(request, pk):
    """Deshomologa um quadro de acesso (apenas pelo usu√°rio que homologou)"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        if quadro.status == 'HOMOLOGADO':
            if quadro.homologado_por and quadro.homologado_por != request.user:
                messages.error(request, 'Apenas o usu√°rio que homologou pode deshomologar este quadro.')
            else:
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.homologado_por = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
        else:
            messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')

    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def elaborar_quadro_acesso(request, pk):
    """Elabora um quadro de acesso n√£o elaborado"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        if quadro.status == 'NAO_ELABORADO':
            # Usar a l√≥gica de gera√ß√£o autom√°tica
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
        else:
            messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def quadro_acesso_edit(request, pk):
    """Edita um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        action = request.POST.get('action', 'salvar')
        
        if action == 'salvar':
            # Edi√ß√£o b√°sica do quadro
            try:
                data_promocao = request.POST.get('data_promocao')
                if data_promocao:
                    quadro.data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                
                status = request.POST.get('status')
                if status:
                    quadro.status = status
                
                motivo_nao_elaboracao = request.POST.get('motivo_nao_elaboracao')
                if motivo_nao_elaboracao:
                    quadro.motivo_nao_elaboracao = motivo_nao_elaboracao
                else:
                    quadro.motivo_nao_elaboracao = None
                
                quadro.observacoes = request.POST.get('observacoes', '')
                quadro.assinaturas.all().delete()
                quadro.save()
                
                messages.success(request, 'Quadro de acesso atualizado com sucesso!')
                
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_acesso_edit', pk=quadro.pk)
        
        elif action == 'regenerar':
            # Regenerar o quadro
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
        
        elif action == 'homologar':
            # Verificar permiss√£o de homologa√ß√£o - apenas presidente da comiss√£o pode homologar
            if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
                # Para quadros de oficiais, verificar se √© presidente da CPO
                comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
                if not comissao_cpo or not comissao_cpo.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            else:
                # Para quadros de pra√ßas, verificar se √© presidente da CPP
                comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
                if not comissao_cpp or not comissao_cpp.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Homologar o quadro
            if quadro.status == 'ELABORADO':
                quadro.status = 'HOMOLOGADO'
                quadro.data_homologacao = timezone.now().date()
                quadro.homologado_por = request.user
                quadro.save()
                messages.success(request, 'Quadro de acesso homologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
        
        elif action == 'deshomologar':
            # Deshomologar o quadro
            if quadro.status == 'HOMOLOGADO':
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')
        
        elif action == 'elaborar':
            # Elaborar o quadro
            if quadro.status == 'NAO_ELABORADO':
                sucesso, mensagem = quadro.gerar_quadro_automatico()
                if sucesso:
                    messages.success(request, mensagem)
                else:
                    messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
            else:
                messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
        
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_edit.html', context)

@login_required
def quadro_acesso_pdf(request, pk):
    """Gera PDF do quadro de acesso no modelo institucional solicitado"""
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    import qrcode
    import locale
    from datetime import datetime

    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar

    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()

    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6)

    story = []

    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        "COMISS√ÉO DE PROMO√á√ïES DE OFICIAIS - CBMEPI-PI",
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # T√≠tulo centralizado e sublinhado
    tipo_quadro = quadro.get_tipo_display().upper()
    # O get_tipo_display() j√° retorna "QUADRO DE ACESSO POR ANTIGUIDADE" ou "QUADRO DE ACESSO POR MERECIMENTO"
    # Ent√£o usamos diretamente o valor retornado
    titulo = f'<u>{tipo_quadro}</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 16))

    # Texto introdut√≥rio com data em portugu√™s
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    data_formatada = f"{quadro.data_promocao.day} de {meses_pt[quadro.data_promocao.month]} de {quadro.data_promocao.year}"
    
    # Definir tipo e sigla do quadro
    if quadro.tipo == 'ANTIGUIDADE':
        tipo_quadro = 'por Antiguidade'
        sigla_quadro = 'QAA'
    elif quadro.tipo == 'MERECIMENTO':
        tipo_quadro = 'por Merecimento'
        sigla_quadro = 'QAM'
    else:
        tipo_quadro = 'Manual'
        sigla_quadro = 'QAM'
    
    # Definir texto introdut√≥rio baseado no tipo de quadro
    if quadro.tipo == 'MERECIMENTO':
        texto_intro = (
            f"Fica organizado o Quadro de Acesso {tipo_quadro} ({sigla_quadro}) "
            f"que visa √†s promo√ß√µes do dia {data_formatada}, tudo com fulcro no par√°grafo √∫nico do art. 6¬∫ c/c o ¬ß 2¬∞ do art. 20 da Lei n¬∞ 5.462, de 30 de junho de 2005 "
            "c/c o art. 10 da Lei 7.772 de 04 de abril de 2022."
        )
    else:
        texto_intro = (
            f"Fica organizado o Quadro de Acesso {tipo_quadro} ({sigla_quadro}) "
            f"que visa √†s promo√ß√µes do dia {data_formatada}, com fulcro nos artigos 12, 13, c/c ¬ß 3¬∫ do Art. 20, da Lei n¬∫ 5.461, de 30 de junho de 2005, "
            "alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022."
        )
    story.append(Paragraph(texto_intro, style_just))
    story.append(Spacer(1, 8))

    # Definir todos os quadros
    quadros_info = [
        {
            'numero': 1,
            'nome': 'QUADRO DE OFICIAIS BOMBEIROS MILITARES COMBATENTES (QOBM/Comb.)',
            'codigo': 'COMB'
        },
        {
            'numero': 2,
            'nome': 'QUADRO DE OFICIAIS BOMBEIROS MILITARES DE SA√öDE (QOBM/S)',
            'codigo': 'SAUDE'
        },
        {
            'numero': 3,
            'nome': 'QUADRO DE OFICIAIS BOMBEIROS MILITARES ENGENHEIROS (QOBM/E)',
            'codigo': 'ENG'
        },
        {
            'numero': 4,
            'nome': 'QUADRO DE OFICIAIS BOMBEIROS MILITARES COMPLEMENTARES (QOBM/C)',
            'codigo': 'COMP'
        }
    ]

    # Definir transi√ß√µes espec√≠ficas por quadro
    if quadro.tipo == 'MERECIMENTO':
        # Para quadros de merecimento: transi√ß√µes espec√≠ficas conforme regras
        transicoes_por_quadro = {
            'COMB': [  # Combatente - inclui TC‚ÜíCB, MJ‚ÜíTC, CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'TENENTE-CORONEL para o posto de CORONEL',
                    'origem': 'TC',
                    'destino': 'CB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar - apenas CP‚ÜíMJ (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    else:
        # Para quadros de antiguidade: todas as transi√ß√µes por antiguidade
        transicoes_por_quadro = {
            'COMB': [  # Combatente
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ASPIRANTE A OFICIAL para o posto de 2¬∫ TENENTE',
                    'origem': 'AS',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar
                # OCULTO TEMPORARIAMENTE - MAJOR para TENENTE-CORONEL
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'I',  # Ajustado de 'II' para 'I'
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',  # Ajustado de 'III' para 'II'
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',  # Ajustado de 'IV' para 'III'
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',  # Ajustado de 'V' para 'IV'
                    'titulo': 'SUBTENENTE para o posto de 2¬∫ TENENTE',
                    'origem': 'ST',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    
    # Processar cada quadro
    for i, quadro_info in enumerate(quadros_info):
        # Adicionar espa√ßamento entre quadros (exceto no primeiro)
        if i > 0:
            story.append(Spacer(1, 16))
        
        story.append(Paragraph(f'<b>{quadro_info["numero"]}. {quadro_info["nome"]}</b>', style_center))
        story.append(Spacer(1, 8))

        # Processar cada transi√ß√£o de posto espec√≠fica do quadro
        transicoes_do_quadro = transicoes_por_quadro.get(quadro_info['codigo'], [])
        
        # Ordenar transi√ß√µes para garantir ordem correta
        if quadro_info['codigo'] == 'COMB':
            # Para Combatente: TC‚ÜíCB, MJ‚ÜíTC, CP‚ÜíMJ (ordem hier√°rquica)
            transicoes_ordenadas = []
            # Primeiro, adicionar TC‚ÜíCB (mais alto)
            for transicao in transicoes_do_quadro:
                if transicao['origem'] == 'TC' and transicao['destino'] == 'CB':
                    transicoes_ordenadas.insert(0, transicao)
                else:
                    transicoes_ordenadas.append(transicao)
            # Reordenar para garantir MJ‚ÜíTC antes de CP‚ÜíMJ
            final_ordenadas = []
            for transicao in transicoes_ordenadas:
                if transicao['origem'] == 'MJ' and transicao['destino'] == 'TC':
                    final_ordenadas.insert(1, transicao)  # Ap√≥s TC‚ÜíCB
                else:
                    final_ordenadas.append(transicao)
            transicoes_do_quadro = final_ordenadas
        else:
            # Para outros quadros: MJ‚ÜíTC, CP‚ÜíMJ (ordem hier√°rquica)
            transicoes_ordenadas = []
            for transicao in transicoes_do_quadro:
                if transicao['origem'] == 'MJ' and transicao['destino'] == 'TC':
                    transicoes_ordenadas.insert(0, transicao)
                else:
                    transicoes_ordenadas.append(transicao)
            transicoes_do_quadro = transicoes_ordenadas
        for transicao in transicoes_do_quadro:
            story.append(Spacer(1, 8))
            story.append(Paragraph(f'<b>{transicao["numero"]} ‚Äì {transicao["titulo"]}</b>', style_bold))
            story.append(Spacer(1, 8))
            
            # Buscar militares aptos para esta transi√ß√£o neste quadro espec√≠fico
            todos_militares = quadro.itemquadroacesso_set.all()
            
            # Filtrar por quadro espec√≠fico
            if quadro_info['codigo'] == 'COMB':
                # Quadro Combatente - incluir apenas militares do quadro COMB
                aptos = todos_militares.filter(
                    militar__posto_graduacao=transicao['origem'],
                    militar__quadro='COMB'
                ).order_by('posicao')
            elif quadro_info['codigo'] == 'SAUDE':
                # Quadro Sa√∫de - incluir apenas militares do quadro SAUDE
                aptos = todos_militares.filter(
                    militar__posto_graduacao=transicao['origem'],
                    militar__quadro='SAUDE'
                ).order_by('posicao')
            elif quadro_info['codigo'] == 'ENG':
                # Quadro Engenheiro - incluir apenas militares do quadro ENG
                aptos = todos_militares.filter(
                    militar__posto_graduacao=transicao['origem'],
                    militar__quadro='ENG'
                ).order_by('posicao')
            elif quadro_info['codigo'] == 'COMP':
                # Quadro Complementar - incluir militares do quadro COMP
                # Para transi√ß√£o ST->2T, incluir subtenentes do quadro PRACAS
                if transicao['origem'] == 'ST' and transicao['destino'] == '2T':
                    aptos = todos_militares.filter(
                        militar__posto_graduacao=transicao['origem'],
                        militar__quadro='PRACAS'
                    ).order_by('posicao')
                else:
                    aptos = todos_militares.filter(
                        militar__posto_graduacao=transicao['origem'],
                        militar__quadro='COMP'
                    ).order_by('posicao')
            else:
                # Fallback - usar filtro gen√©rico
                aptos = todos_militares.filter(
                    militar__posto_graduacao=transicao['origem']
                ).order_by('posicao')
            
            if aptos.exists():
                # Preparar dados da tabela
                from .utils import criptografar_cpf_lgpd
                if quadro.tipo == 'MERECIMENTO':
                    header_data = [['ORD', 'CPF', 'POSTO', 'NOME', 'PONTUA√á√ÉO']]
                    for idx, item in enumerate(aptos, 1):
                        header_data.append([
                            str(idx),
                            criptografar_cpf_lgpd(item.militar.cpf),
                            item.militar.get_posto_graduacao_display() if hasattr(item.militar, 'get_posto_graduacao_display') else item.militar.posto_graduacao,
                            item.militar.nome_completo,
                            f"{item.pontuacao:.2f}" if item.pontuacao else "-"
                        ])
                    # Calcular larguras das colunas baseado no conte√∫do
                    max_ord = max([len(str(row[0])) for row in header_data])
                    max_cpf = max([len(row[1]) for row in header_data])
                    max_posto = max([len(row[2]) for row in header_data])
                    max_pontuacao = max([len(row[4]) for row in header_data])
                    
                    # Larguras fixas alinhadas entre tabelas (equil√≠brio melhor dos campos)
                    w_ord = 1.2*cm
                    w_cpf = 2.0*cm
                    w_posto = 2.4*cm
                    w_pont = 2.0*cm
                    nome_width = doc.width - (w_ord + w_cpf + w_posto + w_pont)
                    col_widths = [w_ord, w_cpf, w_posto, nome_width, w_pont]
                else:
                    # Em antiguidade, incluir coluna NOTA DO CHO somente para transi√ß√£o ST‚Üí2T
                    incluir_nota_cho = (quadro.tipo == 'ANTIGUIDADE' and transicao['origem'] == 'ST' and transicao['destino'] == '2T')
                    if incluir_nota_cho:
                        header_data = [['ORD', 'CPF', 'POSTO', 'NOME', 'NOTA']]
                        for idx, item in enumerate(aptos, 1):
                            nota_cho_val = item.militar.nota_cho if getattr(item.militar, 'nota_cho', None) is not None else None
                            header_data.append([
                                str(idx),
                                criptografar_cpf_lgpd(item.militar.cpf),
                                item.militar.get_posto_graduacao_display() if hasattr(item.militar, 'get_posto_graduacao_display') else item.militar.posto_graduacao,
                                item.militar.nome_completo,
                                f"{float(nota_cho_val):.2f}" if nota_cho_val is not None else "-"
                            ])
                        # Calcular larguras das colunas baseado no conte√∫do
                        max_ord = max([len(str(row[0])) for row in header_data])
                        max_cpf = max([len(row[1]) for row in header_data])
                        max_posto = max([len(row[2]) for row in header_data])
                        max_nota = max([len(str(row[4])) for row in header_data])
                        # Larguras fixas alinhadas
                        w_ord = 1.2*cm
                        w_cpf = 2.0*cm
                        w_posto = 2.4*cm
                        w_nota = 1.8*cm
                        nome_width = doc.width - (w_ord + w_cpf + w_posto + w_nota)
                        col_widths = [w_ord, w_cpf, w_posto, nome_width, w_nota]
                    else:
                        header_data = [['ORD', 'CPF', 'POSTO', 'NOME']]
                        for idx, item in enumerate(aptos, 1):
                            header_data.append([
                                str(idx),
                                criptografar_cpf_lgpd(item.militar.cpf),
                                item.militar.get_posto_graduacao_display() if hasattr(item.militar, 'get_posto_graduacao_display') else item.militar.posto_graduacao,
                                item.militar.nome_completo
                            ])
                        # Calcular larguras das colunas baseado no conte√∫do
                        max_ord = max([len(str(row[0])) for row in header_data])
                        max_cpf = max([len(row[1]) for row in header_data])
                        max_posto = max([len(row[2]) for row in header_data])
                        
                        # Larguras fixas alinhadas
                        w_ord = 1.2*cm
                        w_cpf = 2.0*cm
                        w_posto = 2.4*cm
                        nome_width = doc.width - (w_ord + w_cpf + w_posto)
                        col_widths = [w_ord, w_cpf, w_posto, nome_width]
                table = Table(header_data, colWidths=col_widths)
                # Aplicar estilo diferente baseado no tipo de quadro
                if quadro.tipo == 'MERECIMENTO':
                    table.setStyle(TableStyle([
                        ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
                        ('ALIGN', (0, 1), (2, -1), 'CENTER'),
                        ('ALIGN', (3, 1), (3, -1), 'LEFT'),
                        ('ALIGN', (4, 1), (4, -1), 'CENTER'),  # Alinhar coluna de pontua√ß√£o ao centro
                        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                        ('FONTSIZE', (0, 0), (-1, -1), 9),
                        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                        ('GRID', (0, 0), (-1, -1), 1, colors.black),
                        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ]))
                else:
                    table.setStyle(TableStyle([
                        ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
                        ('ALIGN', (0, 1), (2, -1), 'CENTER'),
                        ('ALIGN', (3, 1), (3, -1), 'LEFT'),
                        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                        ('FONTSIZE', (0, 0), (-1, -1), 9),
                        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                        ('GRID', (0, 0), (-1, -1), 1, colors.black),
                        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ]))
                story.append(table)
            else:
                # Mostrar mensagem padr√£o institucional quando n√£o h√° militares
                if quadro.tipo == 'MERECIMENTO':
                    # Converter sigla do posto para nome completo
                    posto_nomes = {
                        'CB': 'CORONEL',
                        'TC': 'TENENTE-CORONEL', 
                        'MJ': 'MAJOR',
                        'CP': 'CAPIT√ÉO',
                        '1T': '1¬∫ TENENTE',
                        '2T': '2¬∫ TENENTE',
                        'AS': 'ASPIRANTE A OFICIAL',
                        'AA': 'ALUNO DE ADAPTA√á√ÉO',
                        'ST': 'SUBTENENTE'
                    }
                    nome_posto = posto_nomes.get(transicao['destino'], transicao['destino'])
                    mensagem = (
                        f"Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de {nome_posto} em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022."
                    )
                else:
                    # Converter sigla do posto para nome completo
                    posto_nomes = {
                        'CB': 'CORONEL',
                        'TC': 'TENENTE-CORONEL', 
                        'MJ': 'MAJOR',
                        'CP': 'CAPIT√ÉO',
                        '1T': '1¬∫ TENENTE',
                        '2T': '2¬∫ TENENTE',
                        'AS': 'ASPIRANTE A OFICIAL',
                        'AA': 'ALUNO DE ADAPTA√á√ÉO',
                        'ST': 'SUBTENENTE'
                    }
                    nome_posto = posto_nomes.get(transicao['destino'], transicao['destino'])
                    mensagem = (
                        f"Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de {nome_posto} em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022."
                    )
                
                story.append(Paragraph(mensagem, style_just))

    # Data e local por extenso, centralizado
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    # Buscar a primeira assinatura eletr√¥nica para usar sua data
    primeira_assinatura = quadro.assinaturas.filter(assinado_por__isnull=False).order_by('data_assinatura').first()
    if primeira_assinatura:
        data_assinatura = primeira_assinatura.data_assinatura
        data_extenso = f"Teresina - PI, {data_assinatura.day} de {meses_pt[data_assinatura.month]} de {data_assinatura.year}"
    else:
        # Se n√£o houver assinatura, usar a data do quadro
        data_extenso = f"Teresina - PI, {quadro.data_promocao.day} de {meses_pt[quadro.data_promocao.month]} de {quadro.data_promocao.year}"
    
    story.append(Spacer(1, 40))
    story.append(Paragraph(data_extenso, style_center))
    
    # Se√ß√£o de Assinaturas F√≠sicas (sem t√≠tulo)
    story.append(Spacer(1, 8))

    # Buscar todas as assinaturas v√°lidas do quadro (da mais recente para a mais antiga)
    assinaturas = quadro.assinaturas.filter(assinado_por__isnull=False).order_by('-data_assinatura')
    
    for assinatura in assinaturas:
        # Nome e posto
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_completo = f"{militar.nome_completo} - {posto}"
        else:
            nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        
        # Fun√ß√£o
        funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
        
        # Tipo de assinatura
        tipo = assinatura.get_tipo_assinatura_display() or "Tipo n√£o registrado"
        
        # Exibir no formato f√≠sico: Nome - Posto BM (negrito), Fun√ß√£o (normal), Tipo (negrito menor)
        story.append(Spacer(1, 8))
        story.append(Paragraph(f"<b>{nome_completo}</b>", style_center))
        story.append(Paragraph(f"{funcao}", style_center))
        story.append(Paragraph(f"<b>{tipo}</b>", style_center))
        story.append(Spacer(1, 8))

    # Se√ß√£o de Assinaturas Eletr√¥nicas (sem t√≠tulo)
    story.append(Spacer(1, 8))
    
    # Processar assinaturas eletr√¥nicas
    for i, assinatura in enumerate(assinaturas):
        # Informa√ß√µes de assinatura eletr√¥nica
        nome_assinante = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        # Se o nome estiver vazio, usar um nome padr√£o
        if not nome_assinante or nome_assinante.strip() == '':
            nome_assinante = "Usu√°rio do Sistema"
        
        # Se o usu√°rio tem militar associado, incluir posto com BM
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_assinante = f"{posto} {militar.nome_completo}"
        
        from .utils import formatar_data_assinatura
        data_formatada, hora_formatada = formatar_data_assinatura(assinatura.data_assinatura)
        
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_assinante}, em {data_formatada} {hora_formatada}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Adicionar logo da assinatura eletr√¥nica
        from .utils import obter_caminho_assinatura_eletronica
        logo_path = obter_caminho_assinatura_eletronica()
        
        # Tabela das assinaturas: Logo + Texto de assinatura
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=2.5*cm, height=1.8*cm), Paragraph(texto_assinatura, style_small)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
        ]))
        
        story.append(assinatura_table)
        story.append(Spacer(1, 10))  # Espa√ßamento entre assinaturas
    
    # Se n√£o houver assinaturas, mostrar mensagem
    if not assinaturas.exists():
        story.append(Paragraph("Nenhuma assinatura registrada", style_center))
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(quadro, request, tipo_documento='quadro')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 1),
        ('RIGHTPADDING', (0, 0), (-1, -1), 1),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 1),

    ]))
    
    story.append(rodape_table)
    
    # Construir o PDF
    doc.build(story)
    
    # Retornar o PDF para visualiza√ß√£o em nova guia
    buffer.seek(0)
    from django.http import FileResponse
    return FileResponse(buffer, content_type='application/pdf', filename=f'quadro_acesso_{quadro.pk}.pdf')

@login_required
@requer_funcao_ativa
def militar_list(request):
    """Lista todos os militares ativos com pagina√ß√£o e busca"""
    militares = Militar.objects.filter(classificacao='ATIVO')

    # Ordena√ß√£o padr√£o por hierarquia e antiguidade
    ordenacao = 'hierarquia_antiguidade'
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,  # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    if ordenacao == 'hierarquia_antiguidade':
        # Ordenar por hierarquia de postos e depois por antiguidade
        # Para Subtenentes, ordenar primeiro os que t√™m CHO, depois os que n√£o t√™m
        # Cada grupo de Subtenentes (com CHO e sem CHO) ter√° sua pr√≥pria numera√ß√£o de antiguidade
        # OTIMIZA√á√ÉO: Usar order_by simples em vez de sorted() em Python
        militares = militares.order_by('posto_graduacao', 'numeracao_antiguidade', 'nome_completo')
        
        # Reordenar numera√ß√£o de antiguidade para Subtenentes separadamente por CHO
        if militares:
            # Separar Subtenentes dos outros postos
            subtenentes = [m for m in militares if m.posto_graduacao == 'ST']
            outros_militares = [m for m in militares if m.posto_graduacao != 'ST']
            
            if subtenentes:
                # Separar Subtenentes com CHO e sem CHO
                subtenentes_com_cho = [m for m in subtenentes if m.curso_cho]
                subtenentes_sem_cho = [m for m in subtenentes if not m.curso_cho]
                
                # Reordenar numera√ß√£o para Subtenentes com CHO
                for i, militar in enumerate(subtenentes_com_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reordenar numera√ß√£o para Subtenentes sem CHO
                for i, militar in enumerate(subtenentes_sem_cho, 1):
                    militar.numeracao_antiguidade = i
                    militar.save(update_fields=['numeracao_antiguidade'])
                
                # Reconstruir a lista com Subtenentes reordenados
                militares = outros_militares + subtenentes_com_cho + subtenentes_sem_cho
    elif ordenacao == 'posto':
        militares = militares.order_by('posto_graduacao', 'nome_completo')
    elif ordenacao == 'matricula':
        militares = militares.order_by('matricula')
    elif ordenacao == 'data_ingresso':
        militares = militares.order_by('data_ingresso')
    elif ordenacao == 'numeracao_antiguidade':
        militares = militares.order_by('numeracao_antiguidade', 'nome_completo')
    elif ordenacao == 'pontuacao':
        militares = militares.annotate(
            pontuacao_total=Sum('fichaconceitooficiais__pontos') + Sum('fichaconceitopracas__pontos')
        ).order_by('-pontuacao_total')
    else:
        militares = militares.order_by('nome_completo')

    # Adicionar lota√ß√£o atual para cada militar
    for militar in militares:
        militar.lotacao_atual_obj = militar.lotacao_atual()
    
    # Sem pagina√ß√£o - mostrar todos os militares
    context = {
        'militares': militares,
    }
    
    return render(request, 'militares/militar_list.html', context)


@login_required
@admin_bypass
def militar_create(request):
    """Cria um novo militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes e diretores de gest√£o de pessoas podem cadastrar.')
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES)
        if form.is_valid():
            militar = form.save()
            messages.success(request, f'Militar {militar.nome_completo} cadastrado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao cadastrar militar. Verifique os dados.')
    else:
        form = MilitarForm()
    
    context = {
        'form': form,
        'title': 'Novo Militar',
        'action': 'create',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
@login_required
@admin_bypass
def militar_delete(request, pk):
    """Remove um militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem excluir.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        nome = militar.nome_completo
        militar.delete()
        messages.success(request, f'Militar {nome} removido com sucesso!')
        return redirect('militares:militar_list')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_confirm_delete.html', context)

def militar_search_ajax(request):
    """Busca militares via AJAX para autocomplete"""
    query = request.GET.get('q', '')
    if len(query) < 2:
        return JsonResponse({'results': []})
    
    # Filtrar militares excluindo coron√©is (√∫ltimo posto)
    militares = Militar.objects.filter(
        Q(nome_completo__icontains=query) |
        Q(nome_guerra__icontains=query) |
        Q(matricula__icontains=query)
    ).exclude(
        posto_graduacao='CB'  # Excluir coron√©is
    )[:10]
    
    results = []
    for militar in militares:
        results.append({
            'id': militar.id,
            'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}",
            'nome': militar.nome_completo,
            'matricula': militar.matricula,
            'posto': militar.get_posto_graduacao_display(),
        })
    
    return JsonResponse({'results': results})

@login_required
def militar_dashboard(request):
    """Dashboard principal do sistema"""
    total_militares = Militar.objects.count()
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
    fichas_pendentes = FichaConceitoOficiais.objects.count() + FichaConceitoPracas.objects.count()
    documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
    
    # Estat√≠sticas por quadro
    estatisticas_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ).order_by('quadro')
    
    # √öltimas fichas de conceito
    fichas_oficiais = list(FichaConceitoOficiais.objects.select_related('militar').order_by('-data_registro')[:5])
    fichas_pracas = list(FichaConceitoPracas.objects.select_related('militar').order_by('-data_registro')[:5])
    ultimas_fichas = fichas_oficiais + fichas_pracas
    ultimas_fichas.sort(key=lambda x: x.data_registro, reverse=True)
    ultimas_fichas = ultimas_fichas[:5]
    
    # Documentos recentes
    documentos_recentes = Documento.objects.select_related('militar').order_by('-data_upload')[:5]
    
    # Quadros de acesso recentes
    quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
    
    # Notifica√ß√µes do usu√°rio
    notificacoes_base = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).order_by('-prioridade', '-data_criacao')
    
    # Contadores de notifica√ß√µes (antes do slice)
    total_notificacoes = notificacoes_base.count()
    notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
    notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
    
    # Aplicar slice apenas para exibi√ß√£o
    notificacoes = notificacoes_base[:10]
    
    context = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'fichas_pendentes': fichas_pendentes,
        'documentos_pendentes': documentos_pendentes,
        'estatisticas_quadro': estatisticas_quadro,
        'ultimas_fichas': ultimas_fichas,
        'documentos_recentes': documentos_recentes,
        'quadros_recentes': quadros_recentes,
        'notificacoes': notificacoes,
        'total_notificacoes': total_notificacoes,
        'notificacoes_urgentes': notificacoes_urgentes,
        'notificacoes_altas': notificacoes_altas,
    }
    
    return render(request, 'militares/dashboard.html', context)

# Views para Ficha de Conceito
@login_required
@apenas_visualizacao_comissao

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_create(request):
    """Cria nova ficha de conceito"""
    if request.method == 'POST':
        # Determinar qual formul√°rio usar baseado no tipo de militar
        militar_id = request.POST.get('militar')
        if militar_id:
            militar = Militar.objects.get(id=militar_id)
            if militar.is_oficial():
                form = FichaConceitoOficiaisForm(request.POST)
            else:
                form = FichaConceitoPracasForm(request.POST)
        else:
            # Formul√°rio padr√£o para oficiais
            form = FichaConceitoOficiaisForm(request.POST)
        
        if form.is_valid():
            ficha = form.save()
            messages.success(request, f'Ficha de conceito registrada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        # Formul√°rio padr√£o para oficiais
        form = FichaConceitoOficiaisForm()
    
    context = {
        'form': form,
        'title': 'Nova Ficha de Conceito',
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_detail.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_delete(request, pk):
    """Excluir ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        ficha.delete()
        messages.success(request, 'Ficha de conceito exclu√≠da com sucesso!')
        return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_confirm_delete.html', context)

@login_required
def documento_upload(request, ficha_pk):
    """Faz upload de documentos para uma ficha de conceito"""
    ficha = get_object_or_404(FichaConceitoOficiais, pk=ficha_pk)
    
    if request.method == 'POST':
        form = DocumentoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.ficha_conceito = ficha
            documento.save()
            messages.success(request, 'Documento enviado com sucesso!')
            return redirect('militares:ficha_conceito_detail', pk=ficha_pk)
        else:
            messages.error(request, 'Erro ao enviar documento. Verifique os dados.')
    else:
        form = DocumentoForm()
    
    context = {
        'form': form,
        'ficha': ficha,
    }
    
    return render(request, 'militares/documento_upload.html', context)

# Views para Quadros de Acesso
@login_required
@requer_perm_quadros_visualizar
@login_required
@requer_perm_quadros_visualizar
def quadro_acesso_detail(request, pk):
    """Exibe detalhes de um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    militares_inaptos = quadro.militares_inaptos_com_motivo()

    nomes_postos = dict(QuadroAcesso.POSTO_CHOICES)
    nomes_quadros = dict(QuadroAcesso.QUADRO_CHOICES)
    
    # Definir ordem dos quadros e transi√ß√µes (do mais graduado ao menos graduado)
    quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    
    # Verificar se √© um quadro de pra√ßas
    if quadro.tipo == 'PRACAS':
        # Para quadros de pra√ßas: transi√ß√µes espec√≠ficas para pra√ßas
        quadros = ['PRACAS']
        transicoes_por_quadro = {
            'PRACAS': [  # Pra√ßas
                {
                    'numero': 'I',
                    'titulo': '1¬∫ SARGENTO para o posto de SUBTENENTE',
                    'origem': '1S',
                    'destino': 'ST',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Subtenente em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': '2¬∫ SARGENTO para o posto de 1¬∫ SARGENTO',
                    'origem': '2S',
                    'destino': '1S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '3¬∫ SARGENTO para o posto de 2¬∫ SARGENTO',
                    'origem': '3S',
                    'destino': '2S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': 'CABO para o posto de 3¬∫ SARGENTO',
                    'origem': 'CAB',
                    'destino': '3S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 3¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SOLDADO para o posto de CABO',
                    'origem': 'SD',
                    'destino': 'CAB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Cabo em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    elif quadro.tipo == 'MERECIMENTO':
        # Para quadros de merecimento: transi√ß√µes espec√≠ficas conforme regras
        transicoes_por_quadro = {
            'COMB': [  # Combatente - inclui TC‚ÜíCB
                {
                    'numero': 'I',
                    'titulo': 'TENENTE-CORONEL para o posto de CORONEL',
                    'origem': 'TC',
                    'destino': 'CB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                # OCULTO TEMPORARIAMENTE - MAJOR para TENENTE-CORONEL
                # {
                #     'numero': 'II',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'III',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar - apenas CP‚ÜíMJ (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    else:
        # Para quadros de antiguidade: todas as transi√ß√µes por antiguidade
        transicoes_por_quadro = {
            'COMB': [  # Combatente
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ASPIRANTE A OFICIAL para o posto de 2¬∫ TENENTE',
                    'origem': 'AS',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }

            ],
            'SAUDE': [  # Sa√∫de
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SUBTENENTE para o posto de 2¬∫ TENENTE',
                    'origem': 'ST',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    
    # Buscar todos os militares aptos do quadro
    militares_aptos = quadro.itemquadroacesso_set.all().select_related('militar').order_by('posicao')
    
    # L√≥gica especial para o quadro ID 312 - for√ßar exibi√ß√£o da transi√ß√£o Major ‚Üí Tenente-Coronel
    if quadro.id == 312:
        # Criar transi√ß√£o especial de Major para Tenente-Coronel para todos os quadros
        transicao_especial = {
            'numero': 'I',
            'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
            'origem': 'MJ',
            'destino': 'TC',
            'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
        }
        # Adicionar a transi√ß√£o especial em todos os quadros
        for q in quadros:
            if q in transicoes_por_quadro:
                transicoes_por_quadro[q].insert(0, transicao_especial)
    
    # Organizar militares por quadro e transi√ß√£o
    estrutura_quadros = {}
    for q in quadros:
        estrutura_quadros[q] = {
            'nome': nomes_quadros.get(q, q),
            'transicoes': []
        }
        transicoes_do_quadro = transicoes_por_quadro.get(q, [])
        for transicao in transicoes_do_quadro:
            origem = transicao['origem']
            destino = transicao['destino']
            # Filtrar apenas subtenentes do quadro PRACAS para a transi√ß√£o ST->2T do COMP
            if q == 'COMP' and origem == 'ST' and destino == '2T':
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == 'PRACAS' and item.militar.posto_graduacao == 'ST'
                ]
            else:
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == q and item.militar.posto_graduacao == origem
                ]
            estrutura_quadros[q]['transicoes'].append({
                'origem': origem,
                'destino': destino,
                'origem_nome': nomes_postos.get(origem, origem),
                'destino_nome': nomes_postos.get(destino, destino),
                'militares': militares_desta_transicao,
            })
    
    context = {
        'quadro': quadro,
        'militares_inaptos': militares_inaptos,
        'total_inaptos': len(militares_inaptos),
        'estrutura_quadros': estrutura_quadros,
    }
    
    # OCULTO TEMPORARIAMENTE - L√≥gica que for√ßava exibi√ß√£o da transi√ß√£o MJ‚ÜíTC em todos os quadros
    # for q in estrutura_quadros:
    #     transicoes = estrutura_quadros[q]['transicoes']
    #     existe = any(
    #         t['origem'] == 'MJ' and t['destino'] == 'TC'
    #         for t in transicoes
    #     )
    #     if not existe:
    #         # Buscar militares Major do quadro correspondente
    #         militares_mj_tc = [
    #             item for item in militares_aptos 
    #             if item.militar.quadro == q and item.militar.posto_graduacao == 'MJ'
    #         ]
    #         estrutura_quadros[q]['transicoes'].insert(0, {
    #             'origem': 'MJ',
    #             'destino': 'TC',
    #             'destino_nome': nomes_postos.get('TC', 'TC'),
    #             'militares': militares_mj_tc,
    #         })
    
    return render(request, 'militares/quadro_acesso_detail.html', context)

@login_required
def gerar_quadro_acesso(request):
    """Gera um quadro de acesso √∫nico por tipo e data, incluindo todos os postos"""
    if request.method == 'POST':
        tipo = request.POST.get('tipo')
        data_promocao = request.POST.get('data_promocao')
        
        if not tipo:
            messages.error(request, 'O tipo de acesso √© obrigat√≥rio.')
            return redirect('militares:gerar_quadro_acesso')
        
        # Se n√£o foi fornecida uma data, usar a data autom√°tica
        if not data_promocao:
            # Determinar o tipo baseado no quadro (OFICIAIS ou PRACAS)
            quadro_tipo = request.POST.get('quadro', 'OFICIAIS')
            data_promocao = calcular_proxima_data_promocao(tipo=quadro_tipo)
            data_automatica = True
        else:
            try:
                data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                data_automatica = False
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:gerar_quadro_acesso')
        
        # Removida a valida√ß√£o que bloqueava quadros para a mesma data/tipo
        # (permitir m√∫ltiplos quadros na mesma data)
        
        # Criar um √∫nico quadro que representar√° todos os postos
        try:
            # Obter a categoria selecionada
            categoria = request.POST.get('categoria', 'OFICIAIS')
            
            novo_quadro = QuadroAcesso.objects.create(
                tipo=tipo,
                categoria=categoria,
                data_promocao=data_promocao,
                status='EM_ELABORACAO',
                observacoes=f"Quadro de {tipo.lower()} para {categoria.lower()} - {data_promocao.strftime('%d/%m/%Y')} - Inclui todos os postos"
            )
            
            # Gerar o quadro com todos os postos
            sucesso, mensagem = novo_quadro.gerar_quadro_completo()
            
            if sucesso:
                if data_automatica:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso! Data autom√°tica: {data_promocao.strftime("%d/%m/%Y")}')
                else:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
                messages.success(request, mensagem)
                # Redirecionar para a view correta baseada na categoria
                if novo_quadro.categoria == 'PRACAS':
                    return redirect('militares:quadro_acesso_pracas_detail', pk=novo_quadro.pk)
                else:
                    return redirect('militares:quadro_acesso_detail', pk=novo_quadro.pk)
            else:
                novo_quadro.delete()
                messages.error(request, f'Erro ao criar quadro: {mensagem}')
                
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro: {str(e)}')
        
        return redirect('militares:gerar_quadro_acesso')
    
    context = {
        'tipos': QuadroAcesso.TIPO_CHOICES,
        'categorias': [
            ('OFICIAIS', 'Oficiais'),
            ('PRACAS', 'Pra√ßas')
        ],
        'categoria_selecionada': request.POST.get('categoria', 'OFICIAIS') if request.method == 'POST' else 'OFICIAIS',
        'quadros_recentes': QuadroAcesso.objects.all().order_by('-data_criacao')[:10],
        'proxima_data_automatica': calcular_proxima_data_promocao(tipo='OFICIAIS'),
    }
    
    return render(request, 'militares/gerar_quadro_acesso.html', context)

@login_required
def regerar_quadro_acesso(request, pk):
    """Regera um quadro de acesso existente"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        sucesso, mensagem = quadro.gerar_quadro_automatico()
        
        if sucesso:
            messages.success(request, mensagem)
        else:
            messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def delete_quadro_acesso(request, pk):
    """Exclui um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        # Verificar se o quadro est√° homologado
        if quadro.status == 'HOMOLOGADO':
            messages.error(request, 'N√£o √© poss√≠vel excluir um quadro homologado. Deshomologize primeiro.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Excluir todos os itens do quadro primeiro
        quadro.itemquadroacesso_set.all().delete()
        # Excluir o quadro
        quadro.delete()
        
        messages.success(request, 'Quadro de acesso exclu√≠do com sucesso!')
        return redirect('militares:quadro_acesso_list')
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_confirm_delete.html', context)

@login_required
def adicionar_oficial_quadro_oficiais(request, pk):
    """Adiciona um oficial ao quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, 'Quadro n√£o encontrado!')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        posicao = request.POST.get('posicao')
        pontuacao = request.POST.get('pontuacao')
        
        if not militar_id:
            messages.error(request, 'Militar n√£o selecionado!')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Verificar se o militar j√° est√° no quadro
            if quadro.itemquadroacesso_set.filter(militar=militar).exists():
                messages.error(request, f'O oficial {militar.nome_completo} j√° est√° no quadro.')
                return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Adicionar o militar ao quadro
            quadro.adicionar_militar_manual(militar, posicao, pontuacao)
            
            messages.success(request, f'Oficial {militar.nome_completo} adicionado ao quadro com sucesso!')
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
        except ValueError as e:
            messages.error(request, str(e))
        except Exception as e:
            messages.error(request, f'Erro ao adicionar militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def remover_militar_quadro_oficiais(request, pk, militar_id):
    """Remove um militar do quadro de acesso de oficiais"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado.')
        return redirect('militares:quadro_acesso_list')
    
    # Verificar se o quadro √© de oficiais
    if quadro.categoria != 'OFICIAIS':
        messages.error(request, 'Este quadro n√£o √© de oficiais!')
        return redirect('militares:quadro_acesso_list')
    
    if quadro.status == 'HOMOLOGADO':
        messages.error(request, 'Quadros homologados n√£o podem ser editados.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    try:
        militar = Militar.objects.get(pk=militar_id)
        
        # Verificar se o militar est√° no quadro
        item = quadro.itemquadroacesso_set.filter(militar=militar).first()
        if not item:
            messages.error(request, f'O oficial {militar.nome_completo} n√£o est√° no quadro.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Remover o militar
        quadro.remover_militar_manual(militar)
        
        messages.success(request, f'Oficial {militar.nome_completo} removido do quadro com sucesso!')
    except Militar.DoesNotExist:
        messages.error(request, 'Militar n√£o encontrado.')
    except ValueError as e:
        messages.error(request, str(e))
    except Exception as e:
        messages.error(request, f'Erro ao remover militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def buscar_oficiais_elegiveis(request):
    """Busca oficiais eleg√≠veis para promo√ß√£o"""
    if request.method == 'POST':
        form = BuscarOficiaisElegiveisForm(request.POST)
        if form.is_valid():
            data_promocao = form.cleaned_data['data_promocao']
            quadro = form.cleaned_data['quadro']
            posto_graduacao = form.cleaned_data['posto_graduacao']
            
            # Buscar oficiais eleg√≠veis
            oficiais_elegiveis = Militar.objects.oficiais_elegiveis_para_promocao(
                data_promocao=data_promocao,
                quadro=quadro,
                posto_graduacao=posto_graduacao
            )
            
            # Renderizar resultados
            context = {
                'oficiais_elegiveis': oficiais_elegiveis,
                'form': form,
            }
            return render(request, 'militares/buscar_oficiais_elegiveis.html', context)
    else:
        form = BuscarOficiaisElegiveisForm()
    
    context = {
        'form': form,
    }
    return render(request, 'militares/buscar_oficiais_elegiveis.html', context)

@login_required
def homologar_quadro_acesso(request, pk):
    """Homologa um quadro de acesso, solicitando confirma√ß√£o de senha via modal"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    # Verificar permiss√£o de homologa√ß√£o - apenas presidente da comiss√£o pode homologar
    if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
        # Para quadros de oficiais, verificar se √© presidente da CPO
        comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
        if not comissao_cpo or not comissao_cpo.eh_presidente(request.user):
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
            return redirect('militares:quadro_acesso_list')
    else:
        # Para quadros de pra√ßas, verificar se √© presidente da CPP
        comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
        if not comissao_cpp or not comissao_cpp.eh_presidente(request.user):
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
            return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        senha = request.POST.get('senha')
        if senha:
            user = authenticate(username=request.user.username, password=senha)
            if user is not None:
                if quadro.status == 'ELABORADO':
                    quadro.status = 'HOMOLOGADO'
                    quadro.data_homologacao = timezone.now().date()
                    quadro.homologado_por = request.user
                    quadro.save()
                    messages.success(request, 'Quadro de acesso homologado com sucesso!')
                    return redirect('militares:quadro_acesso_list')
                else:
                    messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
                    return redirect('militares:quadro_acesso_list')
            else:
                messages.error(request, 'Senha incorreta. Tente novamente.')
                return redirect('militares:quadro_acesso_list')
        else:
            messages.error(request, 'Senha √© obrigat√≥ria.')
            return redirect('militares:quadro_acesso_list')

    # Se chegou aqui, redirecionar para a lista
    return redirect('militares:quadro_acesso_list')

@login_required
def deshomologar_quadro_acesso(request, pk):
    """Deshomologa um quadro de acesso (apenas pelo usu√°rio que homologou)"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        if quadro.status == 'HOMOLOGADO':
            if quadro.homologado_por and quadro.homologado_por != request.user:
                messages.error(request, 'Apenas o usu√°rio que homologou pode deshomologar este quadro.')
            else:
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.homologado_por = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
        else:
            messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')

    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def elaborar_quadro_acesso(request, pk):
    """Elabora um quadro de acesso n√£o elaborado"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        if quadro.status == 'NAO_ELABORADO':
            # Usar a l√≥gica de gera√ß√£o autom√°tica
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
        else:
            messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def quadro_acesso_edit(request, pk):
    """Edita um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        action = request.POST.get('action', 'salvar')
        
        if action == 'salvar':
            # Edi√ß√£o b√°sica do quadro
            try:
                data_promocao = request.POST.get('data_promocao')
                if data_promocao:
                    quadro.data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                
                status = request.POST.get('status')
                if status:
                    quadro.status = status
                
                motivo_nao_elaboracao = request.POST.get('motivo_nao_elaboracao')
                if motivo_nao_elaboracao:
                    quadro.motivo_nao_elaboracao = motivo_nao_elaboracao
                else:
                    quadro.motivo_nao_elaboracao = None
                
                quadro.observacoes = request.POST.get('observacoes', '')
                quadro.assinaturas.all().delete()
                quadro.save()
                
                messages.success(request, 'Quadro de acesso atualizado com sucesso!')
                
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_acesso_edit', pk=quadro.pk)
        
        elif action == 'regenerar':
            # Regenerar o quadro
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
        
        elif action == 'homologar':
            # Verificar permiss√£o de homologa√ß√£o - apenas presidente da comiss√£o pode homologar
            if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
                # Para quadros de oficiais, verificar se √© presidente da CPO
                comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
                if not comissao_cpo or not comissao_cpo.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            else:
                # Para quadros de pra√ßas, verificar se √© presidente da CPP
                comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
                if not comissao_cpp or not comissao_cpp.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Homologar o quadro
            if quadro.status == 'ELABORADO':
                quadro.status = 'HOMOLOGADO'
                quadro.data_homologacao = timezone.now().date()
                quadro.homologado_por = request.user
                quadro.save()
                messages.success(request, 'Quadro de acesso homologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
        
        elif action == 'deshomologar':
            # Deshomologar o quadro
            if quadro.status == 'HOMOLOGADO':
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')
        
        elif action == 'elaborar':
            # Elaborar o quadro
            if quadro.status == 'NAO_ELABORADO':
                sucesso, mensagem = quadro.gerar_quadro_automatico()
                if sucesso:
                    messages.success(request, mensagem)
                else:
                    messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
            else:
                messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
        
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_edit.html', context)

    buffer.seek(0)
    return FileResponse(buffer, as_attachment=True, filename=f'quadro_acesso_{quadro.pk}.pdf')

@login_required
@requer_funcao_ativa
def militar_list(request):
    """Lista militares ativos com filtro por unidade baseado na fun√ß√£o do usu√°rio"""
    from .models import UsuarioSessao
    
    # Obter sess√£o ativa do usu√°rio
    sessao_ativa = UsuarioSessao.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()
    
    if not sessao_ativa or not sessao_ativa.funcao_militar_usuario:
        # Se n√£o tem sess√£o ativa, redirecionar para sele√ß√£o de fun√ß√£o
        return redirect('militares:selecionar_funcao')
    
    funcao_usuario = sessao_ativa.funcao_militar_usuario
    
    # Filtrar militares baseado no n√≠vel de acesso hier√°rquico do usu√°rio
    funcao_militar = funcao_usuario.funcao_militar
    
    if funcao_usuario.nivel_acesso == 'TOTAL':
        # Acesso total - mostrar todos os militares
        militares = Militar.objects.filter(classificacao='ATIVO')
    elif funcao_usuario.nivel_acesso == 'NENHUM':
        # Sem acesso - mostrar apenas o pr√≥prio militar
        militares = Militar.objects.filter(
            classificacao='ATIVO',
            user=request.user
        )
    else:
        # Filtrar por hierarquia baseado no n√≠vel de acesso do usu√°rio
        militares = Militar.objects.filter(classificacao='ATIVO')
        
        # Aplicar filtro hier√°rquico baseado no organograma
        if funcao_usuario.nivel_acesso == 'ORGAO':
            # Acesso ao √≥rg√£o - filtrar por √≥rg√£o e TODA sua descend√™ncia
            if funcao_usuario.orgao:
                militares = militares.filter(
                    lotacoes__orgao=funcao_usuario.orgao,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
                
        elif funcao_usuario.nivel_acesso == 'GRANDE_COMANDO':
            # Acesso ao grande comando - filtrar por grande comando e TODA sua descend√™ncia
            if funcao_usuario.grande_comando:
                militares = militares.filter(
                    lotacoes__grande_comando=funcao_usuario.grande_comando,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
                
        elif funcao_usuario.nivel_acesso == 'UNIDADE':
            # Acesso √† unidade - filtrar por unidade e TODAS suas subunidades
            if funcao_usuario.unidade:
                from .models import SubUnidade
                # Buscar TODAS as subunidades da unidade
                subunidades = SubUnidade.objects.filter(unidade=funcao_usuario.unidade)
                militares = militares.filter(
                    Q(lotacoes__unidade=funcao_usuario.unidade) |
                    Q(lotacoes__sub_unidade__in=subunidades),
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
                
        elif funcao_usuario.nivel_acesso == 'SUBUNIDADE':
            # Acesso √† subunidade - filtrar apenas pela subunidade espec√≠fica
            if funcao_usuario.sub_unidade:
                militares = militares.filter(
                    lotacoes__sub_unidade=funcao_usuario.sub_unidade,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
    
    print(f"DEBUG - Filtro hierarquico aplicado para {request.user.username}:")
    print(f"   - Fun√ß√£o: {funcao_militar.nome}")
    print(f"   - N√≠vel de acesso: {funcao_usuario.get_nivel_acesso_display()}")
    print(f"   - √ìrg√£o: {funcao_usuario.orgao}")
    print(f"   - Grande Comando: {funcao_usuario.grande_comando}")
    print(f"   - Unidade: {funcao_usuario.unidade}")
    print(f"   - Subunidade: {funcao_usuario.sub_unidade}")
    print(f"   - Militares encontrados: {militares.count()}")
    
    # Log detalhado do filtro aplicado
    if funcao_usuario.nivel_acesso == 'ORGAO' and funcao_usuario.orgao:
        print(f"   üìä Filtro: √ìrg√£o '{funcao_usuario.orgao}' + TODA descend√™ncia")
    elif funcao_usuario.nivel_acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
        print(f"   üìä Filtro: Grande Comando '{funcao_usuario.grande_comando}' + TODA descend√™ncia")
    elif funcao_usuario.nivel_acesso == 'UNIDADE' and funcao_usuario.unidade:
        from .models import SubUnidade
        subunidades = SubUnidade.objects.filter(unidade=funcao_usuario.unidade)
        print(f"   üìä Filtro: Unidade '{funcao_usuario.unidade}' + {subunidades.count()} subunidades")
    elif funcao_usuario.nivel_acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
        print(f"   üìä Filtro: Apenas Subunidade '{funcao_usuario.sub_unidade}'")
    
    # Busca
    query = request.GET.get('q')
    if query:
        # Decodificar URL e normalizar a query
        import urllib.parse
        query = urllib.parse.unquote(query)
        query = query.strip()
        
        # Busca mais flex√≠vel - dividir a query em palavras
        palavras = query.split()
        q_objects = Q()
        
        for palavra in palavras:
            q_objects |= (
                Q(nome_completo__icontains=palavra) |
                Q(nome_guerra__icontains=palavra) |
                Q(matricula__icontains=palavra) |
                Q(cpf__icontains=palavra) |
                Q(email__icontains=palavra)
            )
        
        # Tamb√©m buscar pela query completa
        q_objects |= (
            Q(nome_completo__icontains=query) |
            Q(nome_guerra__icontains=query) |
            Q(matricula__icontains=query) |
            Q(cpf__icontains=query) |
            Q(email__icontains=query)
        )
        
        militares = militares.filter(q_objects)
    
    # Filtros
    posto = request.GET.get('posto')
    if posto:
        # Mapear os valores do frontend para os c√≥digos do banco
        posto_mapping = {
            'cb': 'CB',
            'tc': 'TC', 
            'mj': 'MJ',
            'cp': 'CP',
            '1t': '1T',
            '2t': '2T',
            'st': 'ST',
            '1s': '1S',
            '2s': '2S',
            '3s': '3S',
            'cab': 'CAB',
            'sd': 'SD',
            'nvrr': 'NVRR'
        }
        posto_codigo = posto_mapping.get(posto.lower())
        if posto_codigo:
            militares = militares.filter(posto_graduacao=posto_codigo)
    
    situacao = request.GET.get('situacao')
    if situacao:
        situacao_mapping = {
            'at': 'ATIVO',
            'in': 'INATIVO'
        }
        situacao_codigo = situacao_mapping.get(situacao.lower())
        if situacao_codigo:
            militares = militares.filter(classificacao=situacao_codigo)
    
    quadro = request.GET.get('quadro')
    if quadro:
        militares = militares.filter(quadro=quadro)
    
    # Ordena√ß√£o padr√£o por hierarquia e antiguidade
    ordenacao = request.GET.get('ordenacao', 'hierarquia_antiguidade')
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,  # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
        'NVRR': 15,  # NVRR - tratado separadamente
    }
    
    if ordenacao == 'hierarquia_antiguidade':
        # Ordenar por hierarquia de postos e depois por antiguidade
        # NVRR √© tratado separadamente - sem numera√ß√£o de antiguidade
        militares = sorted(militares, key=lambda x: (
            hierarquia_postos.get(x.posto_graduacao, 999),
            # Para NVRR, n√£o usar numera√ß√£o de antiguidade
            0 if (x.posto_graduacao == 'NVRR' or x.quadro == 'NVRR') else (x.numeracao_antiguidade or 999999),
            x.nome_completo
        ))
    elif ordenacao == 'posto':
        militares = militares.order_by('posto_graduacao', 'nome_completo')
    elif ordenacao == 'matricula':
        militares = militares.order_by('matricula')
    elif ordenacao == 'data_ingresso':
        militares = militares.order_by('data_ingresso')
    elif ordenacao == 'numeracao_antiguidade':
        # Excluir militares do NVRR da ordena√ß√£o por antiguidade
        militares = militares.exclude(quadro='NVRR').exclude(posto_graduacao='NVRR').order_by('numeracao_antiguidade', 'nome_completo')
    elif ordenacao == 'pontuacao':
        militares = militares.annotate(
            pontuacao_total=Sum('fichaconceitooficiais__pontos') + Sum('fichaconceitopracas__pontos')
        ).order_by('-pontuacao_total')
    else:
        militares = militares.order_by('nome_completo')

    # Adicionar lota√ß√£o atual para cada militar
    for militar in militares:
        militar.lotacao_atual_obj = militar.lotacao_atual()
    
    # Sem pagina√ß√£o - mostrar todos os militares
    context = {
        'militares': militares,
    }
    
    return render(request, 'militares/militar_list.html', context)

@login_required
@requer_funcao_ativa
def militar_detail(request, pk):
    """Exibe os detalhes de um militar"""
    militar = get_object_or_404(Militar, pk=pk)
    
    # Busca ficha de conceito
    fichas_oficiais = list(militar.fichaconceitooficiais_set.all())
    fichas_pracas = list(militar.fichaconceitopracas_set.all())
    ficha_conceito = fichas_oficiais + fichas_pracas
    ficha_conceito.sort(key=lambda x: x.data_registro, reverse=True)
    
    # Busca promo√ß√µes
    promocoes = militar.promocao_set.all().order_by('-data_promocao')
    
    # Busca documentos
    documentos = Documento.objects.filter(militar=militar).order_by('-data_upload')
    
    # Busca lota√ß√µes
    lotacoes = militar.lotacoes.filter(ativo=True).order_by('-data_inicio', '-data_cadastro')
    
    # Verificar se h√° fun√ß√£o PRINCIPAL ativa e promover ADICIONAL se necess√°rio
    tem_principal = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='PRINCIPAL').exists()
    if not tem_principal:
        primeira_adicional = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='ADICIONAL').order_by('-data_inicio', '-data_cadastro').first()
        if primeira_adicional:
            primeira_adicional.tipo_funcao = 'PRINCIPAL'
            primeira_adicional.save()
    
    # Busca fun√ß√µes - ordenar por tipo (PRINCIPAL primeiro) e depois por data
    from django.db.models import Case, When, Value, IntegerField
    funcoes = militar.funcoes.filter(ativo=True, status__in=['ATUAL', 'ANTERIOR']).annotate(
        tipo_ordem=Case(
            When(tipo_funcao='PRINCIPAL', then=Value(1)),
            When(tipo_funcao='ADICIONAL', then=Value(2)),
            When(tipo_funcao='TEMPORARIA', then=Value(3)),
            When(tipo_funcao='COMISSAO', then=Value(4)),
            default=Value(5),
            output_field=IntegerField(),
        )
    ).order_by('-status', 'tipo_ordem', '-data_inicio', '-data_cadastro')
    
    # Busca todas as fun√ß√µes (atuais e hist√≥ricas) para o template
    funcoes_atuais = militar.funcoes.filter(status='ATUAL').order_by('-data_inicio')
    funcoes_historicas = militar.funcoes.filter(status='ANTERIOR').order_by('-data_inicio')
    todas_funcoes = militar.funcoes.all().order_by('-data_inicio')
    
    # Busca elogios e puni√ß√µes com verifica√ß√£o de permiss√£o
    from militares.permissoes_militares import pode_visualizar_punicoes_elogios, pode_editar_punicoes_elogios, pode_editar_militares, pode_fazer_crud_pdf, tem_funcao_restrita
    
    elogios = []
    punicoes = []
    
    # Verificar se pode visualizar puni√ß√µes e elogios
    if pode_visualizar_punicoes_elogios(request.user, militar):
        elogios = militar.elogios.filter(ativo=True).order_by('-data_elogio', '-data_registro')
        punicoes = militar.punicoes.filter(ativo=True).order_by('-data_punicao', '-data_registro')
    
    # Verificar se usu√°rio tem fun√ß√£o restrita e se pode fazer CRUD/PDF
    pode_crud_pdf = pode_fazer_crud_pdf(request.user, militar)
    tem_funcao_restrita_user = tem_funcao_restrita(request.user)
    
    # Busca afastamentos do militar
    # Na ficha individual do militar, sempre mostrar TODOS os afastamentos daquele militar
    # O filtro hier√°rquico √© aplicado apenas em listas gerais, n√£o na ficha individual
    # Se o usu√°rio tem acesso para ver a ficha do militar, deve ver todos os afastamentos dele
    from militares.models import Afastamento
    afastamentos = list(militar.afastamentos.all().order_by('-data_inicio', '-data_cadastro'))
    
    # Garantir que afastamentos seja sempre uma lista (n√£o None)
    if afastamentos is None:
        afastamentos = []
    
    # Tipos de afastamento para o modal de certid√£o
    tipos_afastamento = Afastamento.get_all_tipo_choices()
    
    # Busca f√©rias do militar ordenadas por ano de refer√™ncia (do mais atual para o mais distante)
    # Inclui f√©rias de todos os planos, mesmo que o plano esteja em RASCUNHO
    from militares.models import Ferias, LicencaEspecial
    ferias = list(Ferias.objects.filter(militar=militar).select_related('plano', 'militar').order_by('-ano_referencia', '-data_inicio'))
    
    # Busca licen√ßas especiais do militar ordenadas por plano e data de in√≠cio (do mais atual para o mais distante)
    # IMPORTANTE: Para o regroup funcionar, precisa estar ordenado pelo campo que ser√° agrupado (plano)
    # Usar filtro direto para garantir que pegamos todas as licen√ßas
    licencas_especiais_qs = LicencaEspecial.objects.filter(militar=militar).select_related('militar', 'cadastrado_por', 'plano')
    licencas_especiais = list(licencas_especiais_qs)
    # Ordenar manualmente: primeiro por plano (para regroup funcionar), depois por data
    # None ser√° tratado como (9999, 9999) para vir por √∫ltimo quando ordenar reverso
    licencas_especiais.sort(key=lambda x: (
        x.plano.pk if x.plano else 9999,  # Agrupar por plano.pk primeiro (para regroup)
        x.plano.ano_plano if x.plano else 9999,  # Depois por ano do plano
        x.data_inicio if x.data_inicio else None,
        x.data_cadastro if x.data_cadastro else None
    ), reverse=True)
    
    # Busca cautelas de armas do militar
    from militares.models import CautelaArma, CautelaArmaColetiva
    cautelas_individuais = CautelaArma.objects.filter(militar=militar).select_related('arma', 'militar', 'entregue_por', 'devolvido_por').order_by('-data_entrega')
    cautelas_coletivas = CautelaArmaColetiva.objects.filter(responsavel=militar).select_related('responsavel', 'criado_por', 'finalizado_por').order_by('-data_inicio')
    total_cautelas = cautelas_individuais.count() + cautelas_coletivas.count()
    
    # Busca processos administrativos do militar
    from militares.models import ProcessoAdministrativo
    processos_envolvido = ProcessoAdministrativo.objects.filter(
        militares_envolvidos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_encarregado = ProcessoAdministrativo.objects.filter(
        militares_encarregados=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_escriva = ProcessoAdministrativo.objects.filter(
        escrivaos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    # Combinar todos os processos √∫nicos
    processos_ids = set()
    processos_todos = []
    
    for processo in processos_envolvido:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('envolvido', processo))
    
    for processo in processos_encarregado:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('encarregado', processo))
    
    for processo in processos_escriva:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('escriva', processo))
    
    # Ordenar por data de abertura (mais recente primeiro)
    # Usar data_abertura se existir, sen√£o usar data_criacao
    from datetime import date
    processos_todos.sort(key=lambda x: (
        x[1].data_abertura if x[1].data_abertura else (x[1].data_criacao.date() if x[1].data_criacao else date.min)
    ), reverse=True)
    total_processos = len(processos_todos)
    
    context = {
        'militar': militar,
        'ficha_conceito': ficha_conceito,
        'promocoes': promocoes,
        'documentos': documentos,
        'lotacoes': lotacoes,
        'funcoes': funcoes,
        'funcoes_atuais': funcoes_atuais,
        'funcoes_historicas': funcoes_historicas,
        'todas_funcoes': todas_funcoes,
        'elogios': elogios,
        'punicoes': punicoes,
        'afastamentos': afastamentos,
        'tipos_afastamento': tipos_afastamento,
        'ferias': ferias,
        'licencas_especiais': licencas_especiais,
        'averbacoes': list(militar.averbacoes.all().order_by('-data_averbacao', '-data_cadastro')),
        'cautelas_individuais': cautelas_individuais,
        'cautelas_coletivas': cautelas_coletivas,
        'total_cautelas': total_cautelas,
        'processos_todos': processos_todos,
        'total_processos': total_processos,
        'pode_editar_punicoes_elogios': pode_editar_punicoes_elogios(request.user, militar),
        'pode_visualizar_punicoes_elogios': pode_visualizar_punicoes_elogios(request.user, militar),
        'pode_editar_militares': pode_editar_militares(request.user),
        'pode_crud_pdf': pode_crud_pdf,
        'tem_funcao_restrita_user': tem_funcao_restrita_user,
    }
    
    return render(request, 'militares/militar_detail.html', context)

@requer_funcao_ativa
def militar_promocoes_pdf(request, pk):
    """Gera PDF com o hist√≥rico de promo√ß√µes de um militar"""
    militar = get_object_or_404(Militar, pk=pk)
    
    # Busca promo√ß√µes ordenadas por data
    promocoes = militar.promocao_set.all().order_by('-data_promocao')
    
    if not promocoes.exists():
        messages.warning(request, 'Este militar n√£o possui hist√≥rico de promo√ß√µes para gerar PDF.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    # Gera o PDF usando reportlab
    try:
        from io import BytesIO
        from reportlab.lib.pagesizes import A4
        from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image
        from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
        from reportlab.lib import colors
        from reportlab.lib.units import cm
        
        # Criar buffer para o PDF
        buffer = BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=1.5*cm, leftMargin=1.5*cm, topMargin=2*cm, bottomMargin=2*cm)
        story = []
        
        # Estilos
        styles = getSampleStyleSheet()
        style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=16, spaceAfter=20)
        style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=14, spaceAfter=15)
        style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=12)
        style_normal = ParagraphStyle('normal', parent=styles['Normal'], fontSize=11)
        style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
        style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
        
        # Logo/Bras√£o centralizado
        logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
        if os.path.exists(logo_path):
            story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
            story.append(Spacer(1, 6))
        
        # Cabe√ßalho institucional
        cabecalho = [
            "GOVERNO DO ESTADO DO PIAU√ç",
            "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
            "DIRETORIA DE GEST√ÉO DE PESSOAS",
            "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
            "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
        ]
        for linha in cabecalho:
            story.append(Paragraph(linha, style_center))
        story.append(Spacer(1, 10))
        
        # T√≠tulo principal centralizado e sublinhado
        story.append(Paragraph("<u>HIST√ìRICO DE PROMO√á√ïES</u>", style_title))
        story.append(Spacer(1, 16))
        
        story.append(Spacer(1, 16))
        
        # T√≠tulo discreto para dados do militar
        story.append(Paragraph("Dados do Militar", ParagraphStyle('subtitle_discreto', parent=styles['Normal'], alignment=1, fontSize=11, spaceAfter=8, textColor=colors.grey)))
        story.append(Spacer(1, 5))
        
        # Informa√ß√µes do militar em uma coluna (dados ao lado dos t√≠tulos)
        militar_data = [
            [f'Nome Completo: {militar.nome_completo}'],
            [f'Nome de Guerra: {militar.nome_guerra}'],
            [f'Matr√≠cula: {militar.matricula}'],
            [f'Posto Atual: {militar.get_posto_graduacao_display()}'],
            [f'Quadro: {militar.get_quadro_display()}'],
            [f'Data Promo√ß√£o: {militar.data_promocao_atual.strftime("%d/%m/%Y") if militar.data_promocao_atual else "N√£o informada"}'],
        ]
        
        militar_table = Table(militar_data, colWidths=[19*cm])
        militar_table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTSIZE', (0, 0), (-1, -1), 12),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 3),
            ('TOPPADDING', (0, 0), (-1, -1), 3),
            ('WORDWRAP', (0, 0), (-1, -1), True),
            ('VALIGN', (0, 0), (-1, -1), 'TOP')
        ]))
        
        story.append(militar_table)
        story.append(Spacer(1, 20))
        
        # T√≠tulo discreto para a tabela de promo√ß√µes
        story.append(Paragraph("Hist√≥rico de Promo√ß√µes", ParagraphStyle('subtitle_discreto', parent=styles['Normal'], alignment=1, fontSize=11, spaceAfter=8, textColor=colors.grey)))
        story.append(Spacer(1, 5))
        
        # Dados das promo√ß√µes
        promocoes_data = [['Data', 'Posto Anterior', 'Novo Posto', 'Crit√©rio', 'Ato']]
        for promocao in promocoes:
            promocoes_data.append([
                promocao.data_promocao.strftime('%d/%m/%Y'),
                promocao.get_posto_anterior_display(),
                promocao.get_posto_novo_display(),
                promocao.get_criterio_display(),
                promocao.numero_ato
            ])
        
        promocoes_table = Table(promocoes_data, colWidths=[3*cm, 3.5*cm, 3.5*cm, 3.5*cm, 6.5*cm])
        promocoes_table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, -1), 9),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('WORDWRAP', (0, 0), (-1, -1), True),

            # Configura√ß√µes espec√≠ficas para a √∫ltima coluna (Ato)
            ('ALIGN', (4, 0), (4, -1), 'LEFT'),  # √öltima coluna alinhada √† esquerda
            ('FONTSIZE', (4, 0), (4, -1), 8),    # Fonte menor para a √∫ltima coluna
            ('WORDWRAP', (4, 0), (4, -1), True), # Wordwrap espec√≠fico para √∫ltima coluna
            ('LEFTPADDING', (4, 0), (4, -1), 4), # Padding esquerdo para √∫ltima coluna
            ('RIGHTPADDING', (4, 0), (4, -1), 4) # Padding direito para √∫ltima coluna
        ]))
        
        story.append(promocoes_table)
        story.append(Spacer(1, 20))
        

        
        # Construir o PDF
        doc.build(story)
        pdf_content = buffer.getvalue()
        buffer.close()
        
        # Criar resposta HTTP
        from django.http import HttpResponse
        response = HttpResponse(pdf_content, content_type='application/pdf')
        response['Content-Disposition'] = f'inline; filename="historico_promocoes_{militar.matricula}_{timezone.now().strftime("%Y%m%d")}.pdf"'
        
        return response
        
    except Exception as e:
        messages.error(request, f'Erro ao gerar PDF: {str(e)}')
        return redirect('militares:militar_detail', pk=militar.pk)


@login_required
def tempo_servico_certidao_pdf(request, militar_id):
    """Gera PDF com certid√£o de tempo de servi√ßo de um militar"""
    import os
    from io import BytesIO
    from reportlab.lib.pagesizes import A4
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, PageBreak, HRFlowable
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib import colors
    from reportlab.lib.units import cm
    from django.http import FileResponse, HttpResponse
    
    militar = get_object_or_404(Militar, pk=militar_id)
    
    if not militar.data_ingresso:
        error_html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Erro - Certid√£o de Tempo de Servi√ßo</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                .error-box { border: 2px solid #dc3545; border-radius: 5px; padding: 20px; 
                            max-width: 500px; margin: 0 auto; background-color: #f8d7da; }
                h2 { color: #721c24; }
                p { color: #721c24; }
                button { background-color: #dc3545; color: white; border: none; 
                        padding: 10px 20px; border-radius: 5px; cursor: pointer; }
                button:hover { background-color: #c82333; }
            </style>
        </head>
        <body>
            <div class="error-box">
                <h2>‚ùå Erro ao Gerar Certid√£o de Tempo de Servi√ßo</h2>
                <p><strong>Este militar n√£o possui data de ingresso cadastrada.</strong></p>
                <p>Por favor, cadastre a data de ingresso antes de gerar a certid√£o.</p>
                <button onclick="window.close()">Fechar</button>
            </div>
        </body>
        </html>
        """
        return HttpResponse(error_html, status=400, content_type='text/html')
    
    try:
        # Criar buffer para o PDF
        buffer = BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=1.5*cm, leftMargin=1.5*cm, topMargin=0.1*cm, bottomMargin=2*cm)
        story = []
        
        # Estilos
        styles = getSampleStyleSheet()
        style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=16, spaceAfter=20)
        style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=14, spaceAfter=15)
        style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=12)
        style_normal = ParagraphStyle('normal', parent=styles['Normal'], fontSize=11)
        style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
        style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
        style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9, alignment=0, spaceAfter=6)
        
        # Logo/Bras√£o centralizado
        logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
        if os.path.exists(logo_path):
            story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
            story.append(Spacer(1, 6))
        
        # Cabe√ßalho institucional
        cabecalho = [
            "GOVERNO DO ESTADO DO PIAU√ç",
            "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
            "DIRETORIA DE GEST√ÉO DE PESSOAS",
            "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
            "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
        ]
        for linha in cabecalho:
            story.append(Paragraph(linha, style_center))
        story.append(Spacer(1, 12 + 0.5*cm))
        
        # T√≠tulo principal
        story.append(Paragraph("<u>CERTID√ÉO DE TEMPO DE SERVI√áO</u>", style_title))
        story.append(Spacer(1, 13 - 0.5*cm))
        
        # Calcular tempo de servi√ßo detalhado
        tempo_detalhado = militar.tempo_servico_detalhado()
        
        # Buscar todas as averba√ß√µes do militar e somar os dias de aproveitamento
        from .models import Averbacao
        averbacoes = Averbacao.objects.filter(militar=militar)
        total_dias_averbacao = sum(averbacao.aproveitamento_dias for averbacao in averbacoes)
        
        # Converter dias de averba√ß√£o para anos, meses e dias
        def converter_dias_para_anos_meses_dias(dias):
            """Converte dias em anos, meses e dias"""
            anos = dias // 365
            dias_resto = dias % 365
            meses = dias_resto // 30
            dias_finais = dias_resto % 30
            return anos, meses, dias_finais
        
        # Calcular tempo de averba√ß√£o detalhado
        if total_dias_averbacao > 0:
            anos_averb, meses_averb, dias_averb = converter_dias_para_anos_meses_dias(total_dias_averbacao)
            tempo_averbacao_extenso = f"{anos_averb} ano{'s' if anos_averb != 1 else ''}, {meses_averb} m√™s{'es' if meses_averb != 1 else ''} e {dias_averb} dia{'s' if dias_averb != 1 else ''}"
        else:
            anos_averb, meses_averb, dias_averb = 0, 0, 0
            tempo_averbacao_extenso = "0 dias"
        
        # Calcular tempo total (servi√ßo + averba√ß√£o)
        # Converter tempo de servi√ßo para dias (aproxima√ß√£o: 1 ano = 365 dias, 1 m√™s = 30 dias)
        tempo_servico_dias = (tempo_detalhado.years * 365) + (tempo_detalhado.months * 30) + tempo_detalhado.days
        
        # Somar os dias de averba√ß√£o
        total_dias = tempo_servico_dias + total_dias_averbacao
        
        # Converter total para anos, meses e dias
        anos_total, meses_total, dias_total = converter_dias_para_anos_meses_dias(total_dias)
        tempo_total_extenso = f"{anos_total} ano{'s' if anos_total != 1 else ''}, {meses_total} m√™s{'es' if meses_total != 1 else ''} e {dias_total} dia{'s' if dias_total != 1 else ''}"
        
        # Texto de certifica√ß√£o com dados do militar
        posto_display = militar.get_posto_graduacao_display()
        tempo_extenso = f"{tempo_detalhado.years} ano{'s' if tempo_detalhado.years != 1 else ''}, {tempo_detalhado.months} m√™s{'es' if tempo_detalhado.months != 1 else ''} e {tempo_detalhado.days} dia{'s' if tempo_detalhado.days != 1 else ''}"
        
        # Obter data atual formatada
        data_atual_texto = timezone.now().date().strftime("%d/%m/%Y")
        
        # Verificar se houve transfer√™ncias para inativo e reativa√ß√µes
        historico_inativacoes = []
        if militar.data_ultima_inativacao:
            historico_inativacoes.append({
                'tipo': 'inativacao',
                'data': militar.data_ultima_inativacao,
                'descricao': 'Transferido para Inativo'
            })
        if militar.data_ultima_reativacao:
            historico_inativacoes.append({
                'tipo': 'reativacao',
                'data': militar.data_ultima_reativacao,
                'descricao': 'Retornado para Ativo'
            })
        
        # Ordenar hist√≥rico por data
        historico_inativacoes.sort(key=lambda x: x['data'])
        
        # Texto de certifica√ß√£o base
        if historico_inativacoes:
            texto_certificacao = (
                f"Certifico para os devidos fins que conforme os registros funcionais desta institui√ß√£o, "
                f"foi encontrado que o servidor <b>{posto_display} BM {militar.nome_completo}</b>, "
                f"CPF: <b>{militar.cpf or 'N√£o informado'}</b>, Matr√≠cula: <b>{militar.matricula}</b>, "
                f"possui tempo de servi√ßo ativo de <b>{tempo_extenso}</b>, computado apenas nos per√≠odos em que esteve em situa√ß√£o ativa, "
                f"considerando o ingresso em <b>{militar.data_ingresso.strftime('%d/%m/%Y')}</b> at√© a presente data <b>{data_atual_texto}</b>."
            )
        else:
            texto_certificacao = (
                f"Certifico para os devidos fins que conforme os registros funcionais desta institui√ß√£o, "
                f"foi encontrado que o servidor <b>{posto_display} BM {militar.nome_completo}</b>, "
                f"CPF: <b>{militar.cpf or 'N√£o informado'}</b>, Matr√≠cula: <b>{militar.matricula}</b>, "
                f"possui tempo de servi√ßo de <b>{tempo_extenso}</b>, contados a partir de <b>{militar.data_ingresso.strftime('%d/%m/%Y')}</b> at√© a presente data <b>{data_atual_texto}</b>."
            )
        story.append(Paragraph(texto_certificacao, ParagraphStyle('certificacao', parent=styles['Normal'], fontSize=11, alignment=4, spaceAfter=10)))
        
        # Adicionar informa√ß√µes sobre transfer√™ncias e reativa√ß√µes
        if historico_inativacoes:
            story.append(Spacer(1, 10))
            story.append(Paragraph("<b>HIST√ìRICO DE SITUA√á√ïES:</b>", ParagraphStyle('titulo_historico', parent=styles['Normal'], fontSize=10, alignment=0, spaceAfter=8)))
            
            # Calcular per√≠odos
            if militar.data_ultima_inativacao and militar.data_ultima_reativacao:
                # Foi inativado e reativado - mostrar ambos os per√≠odos
                periodo_anterior = militar.tempo_servico_periodo_anterior()
                periodo_atual = militar.tempo_servico_periodo_atual()
                
                texto_historico = (
                    f"O servidor foi <b>transferido para inativo</b> em <b>{militar.data_ultima_inativacao.strftime('%d/%m/%Y')}</b>, "
                    f"permanecendo nessa situa√ß√£o at√© <b>{militar.data_ultima_reativacao.strftime('%d/%m/%Y')}</b>, quando foi <b>retornado para ativo</b>. "
                    f"Per√≠odo ativo anterior: <b>{periodo_anterior.years} ano{'s' if periodo_anterior.years != 1 else ''}, {periodo_anterior.months} m√™s{'es' if periodo_anterior.months != 1 else ''} e {periodo_anterior.days} dia{'s' if periodo_anterior.days != 1 else ''}</b>. "
                    f"Per√≠odo ativo atual (desde {militar.data_ultima_reativacao.strftime('%d/%m/%Y')}): <b>{periodo_atual.years} ano{'s' if periodo_atual.years != 1 else ''}, {periodo_atual.months} m√™s{'es' if periodo_atual.months != 1 else ''} e {periodo_atual.days} dia{'s' if periodo_atual.days != 1 else ''}</b>."
                )
            elif militar.data_ultima_inativacao and not militar.data_ultima_reativacao:
                # Foi inativado mas n√£o reativado (ainda est√° inativo)
                periodo_anterior = militar.tempo_servico_periodo_anterior()
                texto_historico = (
                    f"O servidor foi <b>transferido para inativo</b> em <b>{militar.data_ultima_inativacao.strftime('%d/%m/%Y')}</b>, "
                    f"permanecendo nessa situa√ß√£o at√© a presente data. "
                    f"Per√≠odo ativo anterior (at√© {militar.data_ultima_inativacao.strftime('%d/%m/%Y')}): <b>{periodo_anterior.years} ano{'s' if periodo_anterior.years != 1 else ''}, {periodo_anterior.months} m√™s{'es' if periodo_anterior.months != 1 else ''} e {periodo_anterior.days} dia{'s' if periodo_anterior.days != 1 else ''}</b>."
                )
            elif militar.data_ultima_reativacao and not militar.data_ultima_inativacao:
                # Foi reativado mas n√£o tem data de inativa√ß√£o (caso antigo)
                periodo_atual = militar.tempo_servico_periodo_atual()
                texto_historico = (
                    f"O servidor foi <b>retornado para ativo</b> em <b>{militar.data_ultima_reativacao.strftime('%d/%m/%Y')}</b>. "
                    f"Per√≠odo ativo atual (desde {militar.data_ultima_reativacao.strftime('%d/%m/%Y')}): <b>{periodo_atual.years} ano{'s' if periodo_atual.years != 1 else ''}, {periodo_atual.months} m√™s{'es' if periodo_atual.months != 1 else ''} e {periodo_atual.days} dia{'s' if periodo_atual.days != 1 else ''}</b>."
                )
            else:
                texto_historico = ""
            
            if texto_historico:
                story.append(Paragraph(texto_historico, ParagraphStyle('historico', parent=styles['Normal'], fontSize=11, alignment=4, spaceAfter=10)))
        
        # Adicionar informa√ß√µes sobre averba√ß√µes
        if averbacoes.exists():
            story.append(Spacer(1, 10))
            texto_averbacao = (
                f"Adicionalmente, o servidor possui tempo de contribui√ß√£o averbado de <b>{tempo_averbacao_extenso}</b>, "
                f"totalizando <b>{tempo_total_extenso}</b> de tempo total computado (tempo de servi√ßo ativo + tempo averbado)."
            )
            story.append(Paragraph(texto_averbacao, ParagraphStyle('averbacao', parent=styles['Normal'], fontSize=11, alignment=4, spaceAfter=10)))
            
            # Adicionar tabela com detalhes das averba√ß√µes
            story.append(Spacer(1, 10))
            story.append(Paragraph("<b>DETALHAMENTO DAS AVERBA√á√ïES:</b>", ParagraphStyle('titulo_tabela', parent=styles['Normal'], fontSize=10, alignment=0, spaceAfter=8)))
            
            dados_averbacoes = [['Data', 'CTC/INSS', 'Tempo Averbado', 'Documento Publica√ß√£o']]
            for averbacao in averbacoes.order_by('-data_averbacao'):
                anos_av, meses_av, dias_av = converter_dias_para_anos_meses_dias(averbacao.aproveitamento_dias)
                tempo_av_extenso = f"{anos_av} ano{'s' if anos_av != 1 else ''}, {meses_av} m√™s{'es' if meses_av != 1 else ''} e {dias_av} dia{'s' if dias_av != 1 else ''}"
                documento_pub = averbacao.documento_publicacao or "N√£o informado"
                dados_averbacoes.append([
                    averbacao.data_averbacao.strftime('%d/%m/%Y'),
                    averbacao.numero_ctc_inss,
                    tempo_av_extenso,
                    documento_pub[:50] + ('...' if len(documento_pub) > 50 else '')
                ])
            
            tabela_averbacoes = Table(dados_averbacoes, repeatRows=1, colWidths=[3*cm, 3.5*cm, 5*cm, 4.5*cm])
            tabela_averbacoes.setStyle(TableStyle([
                ('BACKGROUND', (0,0), (-1,0), colors.lightgrey),
                ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
                ('FONTSIZE', (0,0), (-1,-1), 8),
                ('GRID', (0,0), (-1,-1), 0.5, colors.grey),
                ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
                ('ALIGN', (0,0), (-1,-1), 'LEFT'),
                ('LEFTPADDING', (0,0), (-1,-1), 4),
                ('RIGHTPADDING', (0,0), (-1,-1), 4),
                ('TOPPADDING', (0,0), (-1,-1), 4),
                ('BOTTOMPADDING', (0,0), (-1,-1), 4),
            ]))
            story.append(tabela_averbacoes)
            story.append(Spacer(1, 10))
        
        # Texto final
        texto_final = "A presente certid√£o √© emitida a pedido do(a) interessado(a), para fins de comprova√ß√£o e demais usos legais que se fizerem necess√°rios."
        story.append(Paragraph(texto_final, ParagraphStyle('texto_final', parent=styles['Normal'], fontSize=11, alignment=4, spaceAfter=20)))
        story.append(Spacer(1, 30))
        
        # Cidade e Data por extenso (centralizada)
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            
            # Obter cidade
            if militar_logado and militar_logado.cidade:
                cidade_doc = militar_logado.cidade
            else:
                cidade_doc = "Teresina"
            cidade_estado = f"{cidade_doc} - PI"
        except:
            cidade_estado = "Teresina - PI"
        
        # Data por extenso - usar timezone de Bras√≠lia
        import pytz
        brasilia_tz = pytz.timezone('America/Sao_Paulo')
        data_atual = timezone.now().astimezone(brasilia_tz) if timezone.is_aware(timezone.now()) else brasilia_tz.localize(timezone.now())
        
        meses_extenso = {
            1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
            5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
            9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
        }
        data_formatada_extenso = f"{data_atual.day} de {meses_extenso[data_atual.month]} de {data_atual.year}"
        data_cidade = f"{cidade_estado}, {data_formatada_extenso}."
        
        # Adicionar cidade e data centralizada
        story.append(Paragraph(data_cidade, ParagraphStyle('data_extenso', parent=styles['Normal'], alignment=1, fontSize=11, fontName='Helvetica', spaceAfter=20)))
        
        # Obter fun√ß√£o do formul√°rio ou fun√ß√£o atual
        from .permissoes_hierarquicas import obter_funcao_militar_ativa
        funcao_selecionada = request.GET.get('funcao', '')
        if not funcao_selecionada:
            funcao_atual_obj = obter_funcao_militar_ativa(request.user)
            funcao_selecionada = funcao_atual_obj.funcao_militar.nome if funcao_atual_obj and funcao_atual_obj.funcao_militar else "Usu√°rio do Sistema"
        
        # Adicionar assinatura f√≠sica (como se fosse para assinar com caneta)
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            
            if militar_logado:
                nome_posto = f"{militar_logado.nome_completo} - {militar_logado.get_posto_graduacao_display()} BM"
                
                # Adicionar espa√ßo para assinatura f√≠sica
                story.append(Spacer(1, 1*cm))
                
                # Linha para assinatura f√≠sica - 1¬™ linha: Nome - Posto
                story.append(Paragraph(nome_posto, ParagraphStyle('assinatura_fisica', parent=styles['Normal'], alignment=1, fontSize=11, fontName='Helvetica-Bold', spaceAfter=5)))
                
                # 2¬™ linha: Fun√ß√£o
                story.append(Paragraph(funcao_selecionada, ParagraphStyle('assinatura_funcao', parent=styles['Normal'], alignment=1, fontSize=11, fontName='Helvetica', spaceAfter=20)))
                
                # Linha para assinatura (espa√ßo para caneta)
                story.append(Spacer(1, 0.3*cm))
            else:
                nome_usuario = request.user.get_full_name() or request.user.username
                story.append(Spacer(1, 1*cm))
                story.append(Paragraph(nome_usuario, ParagraphStyle('assinatura_fisica', parent=styles['Normal'], alignment=1, fontSize=11, fontName='Helvetica-Bold', spaceAfter=5)))
                story.append(Paragraph(funcao_selecionada, ParagraphStyle('assinatura_funcao', parent=styles['Normal'], alignment=1, fontSize=11, fontName='Helvetica', spaceAfter=20)))
                story.append(Spacer(1, 0.3*cm))
        except Exception as e:
            # Se houver erro, apenas adicionar espa√ßo
            story.append(Spacer(1, 1*cm))
        
        # Adicionar espa√ßo antes da assinatura eletr√¥nica
        story.append(Spacer(1, 0.5*cm))
        
        # Adicionar assinatura eletr√¥nica com logo
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            
            # Obter informa√ß√µes do assinante
            if militar_logado:
                nome_posto_quadro = f"{militar_logado.nome_completo} - {militar_logado.get_posto_graduacao_display()} BM"
                
                # Usar fun√ß√£o selecionada do formul√°rio
                funcao_display = funcao_selecionada
            else:
                nome_posto_quadro = request.user.get_full_name() or request.user.username
                funcao_display = funcao_selecionada
            
            # Data e hora da assinatura
            agora = timezone.now().astimezone(brasilia_tz) if timezone.is_aware(timezone.now()) else brasilia_tz.localize(timezone.now())
            data_formatada = agora.strftime('%d/%m/%Y')
            hora_formatada = agora.strftime('%H:%M:%S')
            
            texto_assinatura = (
                f"Documento assinado eletronicamente por {nome_posto_quadro}, em {data_formatada} {hora_formatada}, "
                f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
            )
            
            # Adicionar logo da assinatura eletr√¥nica
            from .utils import obter_caminho_assinatura_eletronica
            logo_path = obter_caminho_assinatura_eletronica()
            
            # Tabela das assinaturas: Logo + Texto de assinatura
            assinatura_data = [
                [Image(logo_path, width=3.0*cm, height=2.0*cm), Paragraph(texto_assinatura, style_small)]
            ]
            
            assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
            assinatura_table.setStyle(TableStyle([
                ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
                ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
                ('LEFTPADDING', (0, 0), (-1, -1), 6),
                ('RIGHTPADDING', (0, 0), (-1, -1), 6),
                ('TOPPADDING', (0, 0), (-1, -1), 6),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
            ]))
            
            story.append(assinatura_table)
        except Exception as e:
            # Se houver erro, apenas adicionar espa√ßo
            story.append(Spacer(1, 1*cm))
        
        # Rodap√© com QR Code para confer√™ncia de veracidade
        story.append(Spacer(1, 0.1*cm))
        
        # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
        from .utils import gerar_autenticador_veracidade
        # Usar o militar como objeto para gerar o autenticador
        autenticador = gerar_autenticador_veracidade(militar, request, tipo_documento='certidao_tempo_servico')
        
        # Tabela do rodap√©: QR + Texto de autentica√ß√£o
        rodape_data = [
            [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
        ]
        
        rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
        rodape_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 1),
            ('RIGHTPADDING', (0, 0), (-1, -1), 1),
            ('TOPPADDING', (0, 0), (-1, -1), 1),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
            ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
        ]))
        
        story.append(rodape_table)
        
        # Construir PDF
        doc.build(story)
        buffer.seek(0)
        
        # Retornar PDF para visualiza√ß√£o no navegador (sem download autom√°tico)
        filename = f'certidao_tempo_servico_{militar.matricula}_{militar.nome_guerra.replace(" ", "_")}.pdf'
        response = FileResponse(buffer, as_attachment=False, filename=filename, content_type='application/pdf')
        response['Content-Disposition'] = f'inline; filename="{filename}"'
        return response
        
    except Exception as e:
        from django.http import HttpResponse
        import traceback
        error_details = str(e)
        # Log do erro completo para debug (remover traceback em produ√ß√£o se necess√°rio)
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f'Erro ao gerar certid√£o de tempo de servi√ßo para militar {militar.pk}: {error_details}\n{traceback.format_exc()}')
        
        error_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Erro - Certid√£o de Tempo de Servi√ßo</title>
            <meta charset="utf-8">
            <style>
                body {{ font-family: Arial, sans-serif; text-align: center; padding: 50px; }}
                .error-box {{ border: 2px solid #dc3545; border-radius: 5px; padding: 20px; 
                            max-width: 600px; margin: 0 auto; background-color: #f8d7da; }}
                h2 {{ color: #721c24; }}
                p {{ color: #721c24; }}
                .error-detail {{ background-color: #fff; padding: 10px; border-radius: 3px; 
                               margin: 10px 0; font-size: 12px; text-align: left; }}
                button {{ background-color: #dc3545; color: white; border: none; 
                        padding: 10px 20px; border-radius: 5px; cursor: pointer; }}
                button:hover {{ background-color: #c82333; }}
            </style>
        </head>
        <body>
            <div class="error-box">
                <h2>‚ùå Erro ao Gerar Certid√£o de Tempo de Servi√ßo</h2>
                <p><strong>Ocorreu um erro ao gerar a certid√£o de tempo de servi√ßo.</strong></p>
                <div class="error-detail">
                    <strong>Detalhes do erro:</strong><br>
                    {error_details}
                </div>
                <p>Por favor, tente novamente ou entre em contato com o suporte t√©cnico.</p>
                <button onclick="window.close()">Fechar</button>
            </div>
        </body>
        </html>
        """
        return HttpResponse(error_html, status=500, content_type='text/html')


@login_required
@admin_bypass
def militar_create(request):
    """Cria um novo militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes e diretores de gest√£o de pessoas podem cadastrar.')
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        form = MilitarForm(request.POST, request.FILES)
        if form.is_valid():
            militar = form.save(commit=False)
            
            # Se for NVRR, garantir que n√£o tenha numera√ß√£o de antiguidade
            if militar.quadro == 'NVRR' or militar.posto_graduacao == 'NVRR':
                militar.numeracao_antiguidade = None
            
            militar.save()
            messages.success(request, f'Militar {militar.nome_completo} cadastrado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
        else:
            messages.error(request, 'Erro ao cadastrar militar. Verifique os dados.')
    else:
        form = MilitarForm()
    
    context = {
        'form': form,
        'title': 'Novo Militar',
        'action': 'create',
        'today': timezone.now().date().isoformat(),
    }
    
    return render(request, 'militares/militar_form.html', context)

@login_required
@admin_bypass
@login_required
@admin_bypass
def militar_delete(request, pk):
    """Remove um militar"""
    # Verificar permiss√£o
    if not can_edit_militar(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir militares. Apenas administradores, chefes da se√ß√£o de promo√ß√µes, diretores de gest√£o de pessoas e operadores do sistema podem excluir.')
        return redirect('militares:militar_list')
    
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        nome = militar.nome_completo
        militar.delete()
        messages.success(request, f'Militar {nome} removido com sucesso!')
        return redirect('militares:militar_list')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_confirm_delete.html', context)

def militar_search_ajax(request):
    """Busca militares via AJAX para autocomplete"""
    query = request.GET.get('q', '')
    if len(query) < 2:
        return JsonResponse({'results': []})
    
    militares = Militar.objects.filter(
        Q(nome_completo__icontains=query) |
        Q(nome_guerra__icontains=query) |
        Q(matricula__icontains=query)
    )[:10]
    
    results = []
    for militar in militares:
        results.append({
            'id': militar.id,
            'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}",
            'nome': militar.nome_completo,
            'matricula': militar.matricula,
            'posto': militar.get_posto_graduacao_display(),
            'cpf': militar.cpf,
        })
    
    return JsonResponse({'results': results})

@login_required
def militar_dashboard(request):
    """Dashboard principal do sistema"""
    from .models import UsuarioSessao
    from django.db.models import Q, Count
    
    # Verificar se √© superusu√°rio - tem acesso total sem fun√ß√£o militar
    if request.user.is_superuser:
        # Para superusu√°rio, usar estat√≠sticas globais sem filtros hier√°rquicos
        total_militares = Militar.objects.count()
        militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
        militares_inativos = total_militares - militares_ativos
        
        # Calcular oficiais e pra√ßas ativos
        oficiais_ativos = Militar.objects.filter(
            classificacao='ATIVO',
            posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
        ).count()
        pracas_ativas = Militar.objects.filter(
            classificacao='ATIVO',
            posto_graduacao__in=['1S', '2S', '3S', 'CAB', 'SD', 'AL']
        ).count()
        
        # Documentos
        documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
        documentos_aprovados = Documento.objects.filter(status='APROVADO').count()
        total_documentos = Documento.objects.count()
        documentos_rejeitados = total_documentos - documentos_aprovados - documentos_pendentes
        
        # Fichas
        total_fichas = FichaConceitoOficiais.objects.count() + FichaConceitoPracas.objects.count()
        fichas_aprovadas = 0  # Campo status n√£o existe no modelo
        fichas_pendentes = total_fichas
        
        # Militares com/sem ficha
        militares_com_ficha = Militar.objects.filter(
            Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
        ).distinct().count()
        militares_sem_ficha = militares_ativos - militares_com_ficha
        
        # Estat√≠sticas por quadro
        estatisticas_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
            total=Count('id')
        ).order_by('quadro')
        
        # Estat√≠sticas por posto/gradua√ß√£o
        estatisticas_posto = Militar.objects.filter(classificacao='ATIVO').values('posto_graduacao').annotate(
            total=Count('id')
        ).order_by('posto_graduacao')
        
        # √öltimas fichas de conceito
        fichas_oficiais = list(FichaConceitoOficiais.objects.select_related('militar').order_by('-data_registro')[:5])
        fichas_pracas = list(FichaConceitoPracas.objects.select_related('militar').order_by('-data_registro')[:5])
        ultimas_fichas = fichas_oficiais + fichas_pracas
        ultimas_fichas.sort(key=lambda x: x.data_registro, reverse=True)
        ultimas_fichas = ultimas_fichas[:5]
        
        # Documentos recentes
        documentos_recentes = Documento.objects.select_related('militar').order_by('-data_upload')[:5]
        
        # Quadros de acesso recentes
        quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
        
        
        # Notifica√ß√µes do usu√°rio
        notificacoes_base = NotificacaoSessao.objects.filter(
            usuario=request.user,
            lida=False
        ).order_by('-prioridade', '-data_criacao')
        
        # Contadores de notifica√ß√µes
        total_notificacoes = notificacoes_base.count()
        notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
        notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
        notificacoes = notificacoes_base[:10]
        
        # Definir hierarquia dos postos para ordena√ß√£o
        hierarquia_posto = {
            'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8,
            'ST': 9, '1S': 10, '2S': 11, '3S': 12, 'CAB': 13, 'SD': 14, 'AL': 15,
        }
        
        # Ordenar estat√≠sticas por hierarquia
        estatisticas_posto_list = list(estatisticas_posto)
        estatisticas_posto_list.sort(key=lambda x: hierarquia_posto.get(x['posto_graduacao'], 999))
        
        # Estat√≠sticas por g√™nero
        estatisticas_genero_posto = Militar.objects.filter(classificacao='ATIVO').values('posto_graduacao', 'sexo').annotate(
            total=Count('id')
        ).order_by('posto_graduacao', 'sexo')
        
        estatisticas_genero_posto_list = list(estatisticas_genero_posto)
        estatisticas_genero_posto_list.sort(key=lambda x: hierarquia_posto.get(x['posto_graduacao'], 999))
        
        estatisticas_genero_quadro = Militar.objects.filter(classificacao='ATIVO').values('quadro', 'sexo').annotate(
            total=Count('id')
        ).order_by('quadro', 'sexo')
        
        total_homens = Militar.objects.filter(classificacao='ATIVO', sexo='M').count()
        total_mulheres = Militar.objects.filter(classificacao='ATIVO', sexo='F').count()
        
        # Log do acesso superusu√°rio
        print(f"DEBUG - Dashboard - Acesso SUPERUSUARIO para {request.user.username}:")
        print(f"   - Acesso: TOTAL (sem restri√ß√µes)")
        print(f"   - Militares ativos: {militares_ativos}")
        print(f"   - Documentos pendentes: {documentos_pendentes}")
        
        context = {
            'total_militares': total_militares,
            'militares_ativos': militares_ativos,
            'militares_inativos': militares_inativos,
            'militares_com_ficha': militares_com_ficha,
            'militares_sem_ficha': militares_sem_ficha,
            'oficiais_ativos': oficiais_ativos,
            'pracas_ativas': pracas_ativas,
            'documentos_pendentes': documentos_pendentes,
            'documentos_aprovados': documentos_aprovados,
            'documentos_rejeitados': documentos_rejeitados,
            'total_documentos': total_documentos,
            'total_fichas': total_fichas,
            'fichas_aprovadas': fichas_aprovadas,
            'fichas_pendentes': fichas_pendentes,
            'estatisticas_quadro': estatisticas_quadro,
            'estatisticas_posto': estatisticas_posto_list,
            'estatisticas_genero_posto': estatisticas_genero_posto_list,
            'estatisticas_genero_quadro': estatisticas_genero_quadro,
            'total_homens': total_homens,
            'total_mulheres': total_mulheres,
            'ultimas_fichas': ultimas_fichas,
            'documentos_recentes': documentos_recentes,
            'quadros_recentes': quadros_recentes,
            'notificacoes': notificacoes,
            'total_notificacoes': total_notificacoes,
            'notificacoes_urgentes': notificacoes_urgentes,
            'notificacoes_altas': notificacoes_altas,
            'funcao_atual': None,  # Superusu√°rio n√£o tem fun√ß√£o espec√≠fica
            'is_superuser': True,  # Flag para identificar superusu√°rio no template
        }
        
        return render(request, 'militares/militar_dashboard.html', context)
    
    # Para usu√°rios normais, verificar se tem sess√£o ativa com fun√ß√£o selecionada
    sessao_ativa = UsuarioSessao.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()
    
    if not sessao_ativa or not sessao_ativa.funcao_militar_usuario:
        # Se n√£o tem sess√£o ativa, redirecionar para sele√ß√£o de fun√ß√£o
        return redirect('militares:selecionar_funcao_lotacao')
    
    funcao_usuario = sessao_ativa.funcao_militar_usuario
    funcao_militar = funcao_usuario.funcao_militar
    
    # Usar todos os dados sem filtros hier√°rquicos
    militares_filtrados = Militar.objects
    documentos_filtrados = Documento.objects
    fichas_oficiais_filtradas = FichaConceitoOficiais.objects
    fichas_pracas_filtradas = FichaConceitoPracas.objects
    
    # Calcular estat√≠sticas filtradas baseadas no tipo de acesso
    from django.db.models import Count, Q
    
    total_militares = militares_filtrados.count()
    militares_ativos = militares_filtrados.filter(classificacao='ATIVO').count()
    militares_inativos = total_militares - militares_ativos
    
    # Contar militares que possuem ficha de conceito
    militares_com_ficha = militares_filtrados.filter(
        Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
    ).distinct().count()
    
    # Contar militares ativos sem ficha de conceito
    militares_sem_ficha = militares_ativos - militares_com_ficha
    
    # Estat√≠sticas de documentos
    documentos_pendentes = documentos_filtrados.filter(status='PENDENTE').count()
    total_documentos = documentos_filtrados.count()
    
    # Estat√≠sticas de fichas
    total_fichas = fichas_oficiais_filtradas.count() + fichas_pracas_filtradas.count()
    fichas_aprovadas = 0  # Campo status n√£o existe no modelo
    fichas_pendentes = total_fichas  # Considerar todas como pendentes por enquanto
    
    # Estat√≠sticas por quadro (apenas militares ativos)
    estatisticas_quadro = militares_filtrados.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ).order_by('quadro')
    
    # Estat√≠sticas por posto/gradua√ß√£o (apenas militares ativos)
    estatisticas_posto = militares_filtrados.filter(classificacao='ATIVO').values('posto_graduacao').annotate(
        total=Count('id')
    ).order_by('posto_graduacao')
    
    # Criar dicion√°rio de estat√≠sticas
    stats = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'militares_inativos': militares_inativos,
        'militares_com_ficha': militares_com_ficha,
        'militares_sem_ficha': militares_sem_ficha,
        'documentos_pendentes': documentos_pendentes,
        'total_documentos': total_documentos,
        'total_fichas': total_fichas,
        'fichas_aprovadas': fichas_aprovadas,
        'fichas_pendentes': fichas_pendentes,
        'estatisticas_quadro': estatisticas_quadro,
        'estatisticas_posto': estatisticas_posto,
    }
    
    # Calcular oficiais e pra√ßas ativos filtrados
    oficiais_ativos = militares_filtrados.filter(
        posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    ).count()
    pracas_ativas = militares_filtrados.filter(
        posto_graduacao__in=['1S', '2S', '3S', 'CAB', 'SD', 'AL']
    ).count()
    
    # √öltimas fichas de conceito filtradas
    fichas_oficiais = list(fichas_oficiais_filtradas.select_related('militar').order_by('-data_registro')[:5])
    fichas_pracas = list(fichas_pracas_filtradas.select_related('militar').order_by('-data_registro')[:5])
    ultimas_fichas = fichas_oficiais + fichas_pracas
    ultimas_fichas.sort(key=lambda x: x.data_registro, reverse=True)
    ultimas_fichas = ultimas_fichas[:5]
    
    # Documentos recentes filtrados
    documentos_recentes = documentos_filtrados.select_related('militar').order_by('-data_upload')[:5]
    
    # Quadros de acesso recentes (n√£o filtrados por hierarquia)
    quadros_recentes = QuadroAcesso.objects.all().order_by('-data_criacao')[:5]
    
    
    # Notifica√ß√µes do usu√°rio
    notificacoes_base = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).order_by('-prioridade', '-data_criacao')
    
    # Contadores de notifica√ß√µes (antes do slice)
    total_notificacoes = notificacoes_base.count()
    notificacoes_urgentes = notificacoes_base.filter(prioridade='URGENTE').count()
    notificacoes_altas = notificacoes_base.filter(prioridade='ALTA').count()
    
    # Aplicar slice apenas para exibi√ß√£o
    notificacoes = notificacoes_base[:10]
    
    # Definir hierarquia dos postos para ordena√ß√£o
    hierarquia_posto = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13, # Cabo
        'SD': 14,  # Soldado
        'AL': 15,  # Aluno
    }
    
    # Ordenar estat√≠sticas por hierarquia
    estatisticas_posto_list = list(stats['estatisticas_posto'])
    estatisticas_posto_list.sort(key=lambda x: hierarquia_posto.get(x['posto_graduacao'], 999))
    
    # Estat√≠sticas por g√™nero - Posto/Gradua√ß√£o (filtradas)
    estatisticas_genero_posto = militares_filtrados.filter(classificacao='ATIVO').values('posto_graduacao', 'sexo').annotate(
        total=Count('id')
    ).order_by('posto_graduacao', 'sexo')
    
    # Ordenar por hierarquia
    estatisticas_genero_posto_list = list(estatisticas_genero_posto)
    estatisticas_genero_posto_list.sort(key=lambda x: hierarquia_posto.get(x['posto_graduacao'], 999))
    
    # Estat√≠sticas por g√™nero - Quadro (filtradas)
    estatisticas_genero_quadro = militares_filtrados.filter(classificacao='ATIVO').values('quadro', 'sexo').annotate(
        total=Count('id')
    ).order_by('quadro', 'sexo')
    
    # Totais por g√™nero (filtrados)
    total_homens = militares_filtrados.filter(classificacao='ATIVO', sexo='M').count()
    total_mulheres = militares_filtrados.filter(classificacao='ATIVO', sexo='F').count()
    
    # Log do filtro aplicado para debug
    print(f"DEBUG - Dashboard - Filtro hierarquico aplicado para {request.user.username}:")
    print(f"   - Funcao: {funcao_militar.nome}")
    print(f"   - Tipo de acesso: {funcao_militar.get_acesso_display()}")
    print(f"   - Militares ativos encontrados: {stats['militares_ativos']}")
    print(f"   - Documentos pendentes: {stats['documentos_pendentes']}")
    
    # Calcular documentos aprovados e rejeitados
    documentos_aprovados = documentos_filtrados.filter(status='APROVADO').count()
    documentos_rejeitados = stats['total_documentos'] - documentos_aprovados - stats['documentos_pendentes']
    
    context = {
        'total_militares': stats['total_militares'],
        'militares_ativos': stats['militares_ativos'],
        'militares_inativos': stats['militares_inativos'],
        'militares_com_ficha': stats['militares_com_ficha'],
        'militares_sem_ficha': stats['militares_sem_ficha'],
        'oficiais_ativos': oficiais_ativos,
        'pracas_ativas': pracas_ativas,
        'documentos_pendentes': stats['documentos_pendentes'],
        'documentos_aprovados': documentos_aprovados,
        'documentos_rejeitados': documentos_rejeitados,
        'total_documentos': stats['total_documentos'],
        'total_fichas': stats['total_fichas'],
        'fichas_aprovadas': stats['fichas_aprovadas'],
        'fichas_pendentes': stats['fichas_pendentes'],
        'estatisticas_quadro': stats['estatisticas_quadro'],
        'estatisticas_posto': estatisticas_posto_list,
        'estatisticas_genero_posto': estatisticas_genero_posto_list,
        'estatisticas_genero_quadro': estatisticas_genero_quadro,
        'total_homens': total_homens,
        'total_mulheres': total_mulheres,
        'ultimas_fichas': ultimas_fichas,
        'documentos_recentes': documentos_recentes,
        'quadros_recentes': quadros_recentes,
        'notificacoes': notificacoes,
        'total_notificacoes': total_notificacoes,
        'notificacoes_urgentes': notificacoes_urgentes,
        'notificacoes_altas': notificacoes_altas,
        'funcao_atual': funcao_usuario,  # Para exibir informa√ß√µes da fun√ß√£o no template
    }
    
    return render(request, 'militares/militar_dashboard.html', context)

# Views para Ficha de Conceito
@login_required
@apenas_visualizacao_comissao

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_create(request):
    """Cria nova ficha de conceito"""
    if request.method == 'POST':
        # Determinar qual formul√°rio usar baseado no tipo de militar
        militar_id = request.POST.get('militar')
        if militar_id:
            militar = Militar.objects.get(id=militar_id)
            if militar.is_oficial():
                form = FichaConceitoOficiaisForm(request.POST)
            else:
                form = FichaConceitoPracasForm(request.POST)
        else:
            # Formul√°rio padr√£o para oficiais
            form = FichaConceitoOficiaisForm(request.POST)
        
        if form.is_valid():
            ficha = form.save()
            messages.success(request, f'Ficha de conceito registrada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        # Formul√°rio padr√£o para oficiais
        form = FichaConceitoOficiaisForm()
    
    context = {
        'form': form,
        'title': 'Nova Ficha de Conceito',
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_detail.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_delete(request, pk):
    """Excluir ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        ficha.delete()
        messages.success(request, 'Ficha de conceito exclu√≠da com sucesso!')
        return redirect('militares:ficha_conceito_list')
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_confirm_delete.html', context)

@login_required
def documento_upload(request, ficha_pk):
    """Faz upload de documentos para uma ficha de conceito"""
    ficha = get_object_or_404(FichaConceitoOficiais, pk=ficha_pk)
    
    if request.method == 'POST':
        form = DocumentoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.ficha_conceito = ficha
            documento.save()
            messages.success(request, 'Documento enviado com sucesso!')
            return redirect('militares:ficha_conceito_detail', pk=ficha_pk)
        else:
            messages.error(request, 'Erro ao enviar documento. Verifique os dados.')
    else:
        form = DocumentoForm()
    
    context = {
        'form': form,
        'ficha': ficha,
    }
    
    return render(request, 'militares/documento_upload.html', context)

# Views para Quadros de Acesso
@login_required
@requer_perm_quadros_visualizar
@login_required
@requer_perm_quadros_visualizar
def quadro_acesso_detail(request, pk):
    """Exibe detalhes de um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    militares_inaptos = quadro.militares_inaptos_com_motivo()

    nomes_postos = dict(QuadroAcesso.POSTO_CHOICES)
    nomes_quadros = dict(QuadroAcesso.QUADRO_CHOICES)
    
    # Definir ordem dos quadros e transi√ß√µes (do mais graduado ao menos graduado)
    quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    
    # Verificar se √© um quadro de pra√ßas
    if quadro.tipo == 'PRACAS':
        # Para quadros de pra√ßas: transi√ß√µes espec√≠ficas para pra√ßas
        quadros = ['PRACAS']
        transicoes_por_quadro = {
            'PRACAS': [  # Pra√ßas
                {
                    'numero': 'I',
                    'titulo': '1¬∫ SARGENTO para o posto de SUBTENENTE',
                    'origem': '1S',
                    'destino': 'ST',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Subtenente em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': '2¬∫ SARGENTO para o posto de 1¬∫ SARGENTO',
                    'origem': '2S',
                    'destino': '1S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '3¬∫ SARGENTO para o posto de 2¬∫ SARGENTO',
                    'origem': '3S',
                    'destino': '2S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': 'CABO para o posto de 3¬∫ SARGENTO',
                    'origem': 'CAB',
                    'destino': '3S',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 3¬∫ Sargento em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SOLDADO para o posto de CABO',
                    'origem': 'SD',
                    'destino': 'CAB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Cabo em virtude de n√£o haver pra√ßa que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    elif quadro.tipo == 'MERECIMENTO':
        # Para quadros de merecimento: transi√ß√µes espec√≠ficas conforme regras
        transicoes_por_quadro = {
            'COMB': [  # Combatente - inclui TC‚ÜíCB
                {
                    'numero': 'I',
                    'titulo': 'TENENTE-CORONEL para o posto de CORONEL',
                    'origem': 'TC',
                    'destino': 'CB',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro - apenas MJ‚ÜíTC e CP‚ÜíMJ
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar - apenas CP‚ÜíMJ (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Merecimento para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    else:
        # Para quadros de antiguidade: todas as transi√ß√µes por antiguidade
        transicoes_por_quadro = {
            'COMB': [  # Combatente
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ASPIRANTE A OFICIAL para o posto de 2¬∫ TENENTE',
                    'origem': 'AS',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'SAUDE': [  # Sa√∫de
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'ENG': [  # Engenheiro
                {
                    'numero': 'I',
                    'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                    'origem': 'MJ',
                    'destino': 'TC',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'ALUNO DE ADAPTA√á√ÉO para o posto de 2¬∫ TENENTE',
                    'origem': 'AA',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ],
            'COMP': [  # Complementar (MJ‚ÜíTC comentado temporariamente)
                # {
                #     'numero': 'I',
                #     'titulo': 'MAJOR para o posto de TENENTE-CORONEL',
                #     'origem': 'MJ',
                #     'destino': 'TC',
                #     'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Tenente-Coronel em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                # },
                {
                    'numero': 'II',
                    'titulo': 'CAPIT√ÉO para o posto de MAJOR',
                    'origem': 'CP',
                    'destino': 'MJ',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Major em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'III',
                    'titulo': '1¬∫ TENENTE para o posto de CAPIT√ÉO',
                    'origem': '1T',
                    'destino': 'CP',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de Capit√£o em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'IV',
                    'titulo': '2¬∫ TENENTE para o posto de 1¬∫ TENENTE',
                    'origem': '2T',
                    'destino': '1T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 1¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                },
                {
                    'numero': 'V',
                    'titulo': 'SUBTENENTE para o posto de 2¬∫ TENENTE',
                    'origem': 'ST',
                    'destino': '2T',
                    'texto': 'Deixa de ser elaborado o Quadro de Acesso por Antiguidade para o posto de 2¬∫ Tenente em virtude de n√£o haver oficial que satisfa√ßa os requisitos essenciais para ingresso ao Quadro de acesso, nos termos do <b>art. 12</b> da Lei n¬∫ 5.461, de 30 de junho de 2005, alterada pela Lei N¬∫ 7.772, de 04 de abril de 2022.'
                }
            ]
        }
    
    # Buscar todos os militares aptos do quadro
    militares_aptos = quadro.itemquadroacesso_set.all().select_related('militar').order_by('posicao')
    
    # Organizar militares por quadro e transi√ß√£o
    estrutura_quadros = {}
    for q in quadros:
        estrutura_quadros[q] = {
            'nome': nomes_quadros.get(q, q),
            'transicoes': []
        }
        transicoes_do_quadro = transicoes_por_quadro.get(q, [])
        for transicao in transicoes_do_quadro:
            origem = transicao['origem']
            destino = transicao['destino']
            # Filtrar apenas subtenentes do quadro PRACAS para a transi√ß√£o ST->2T do COMP
            if q == 'COMP' and origem == 'ST' and destino == '2T':
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == 'PRACAS' and item.militar.posto_graduacao == 'ST'
                ]
            else:
                militares_desta_transicao = [
                    item for item in militares_aptos 
                    if item.militar.quadro == q and item.militar.posto_graduacao == origem
                ]
            estrutura_quadros[q]['transicoes'].append({
                'origem': origem,
                'destino': destino,
                'origem_nome': nomes_postos.get(origem, origem),
                'destino_nome': nomes_postos.get(destino, destino),
                'militares': militares_desta_transicao,
            })
    
    context = {
        'quadro': quadro,
        'militares_inaptos': militares_inaptos,
        'total_inaptos': len(militares_inaptos),
        'estrutura_quadros': estrutura_quadros,
    }
    
    # OCULTO TEMPORARIAMENTE - L√≥gica que for√ßava exibi√ß√£o da transi√ß√£o MJ‚ÜíTC em todos os quadros
    # for q in estrutura_quadros:
    #     transicoes = estrutura_quadros[q]['transicoes']
    #     existe = any(
    #         t['origem'] == 'MJ' and t['destino'] == 'TC'
    #         for t in transicoes
    #     )
    #     if not existe:
    #         # Buscar militares Major do quadro correspondente
    #         militares_mj_tc = [
    #             item for item in militares_aptos 
    #             if item.militar.quadro == q and item.militar.posto_graduacao == 'MJ'
    #         ]
    #         estrutura_quadros[q]['transicoes'].insert(0, {
    #             'origem': 'MJ',
    #             'destino': 'TC',
    #             'origem_nome': nomes_postos.get('MJ', 'MJ'),
    #             'destino_nome': nomes_postos.get('TC', 'TC'),
    #             'militares': militares_mj_tc,
    #         })
    
    return render(request, 'militares/quadro_acesso_detail.html', context)

@login_required
def gerar_quadro_acesso(request):
    """Gera um quadro de acesso √∫nico por tipo e data, incluindo todos os postos"""
    if request.method == 'POST':
        tipo = request.POST.get('tipo')
        data_promocao = request.POST.get('data_promocao')
        
        if not tipo:
            messages.error(request, 'O tipo de acesso √© obrigat√≥rio.')
            return redirect('militares:gerar_quadro_acesso')
        
        # Se n√£o foi fornecida uma data, usar a data autom√°tica
        if not data_promocao:
            # Determinar o tipo baseado no quadro (OFICIAIS ou PRACAS)
            quadro_tipo = request.POST.get('quadro', 'OFICIAIS')
            data_promocao = calcular_proxima_data_promocao(tipo=quadro_tipo)
            data_automatica = True
        else:
            try:
                data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                data_automatica = False
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:gerar_quadro_acesso')
        
        # Removida a valida√ß√£o que bloqueava quadros para a mesma data/tipo
        # (permitir m√∫ltiplos quadros na mesma data)
        
        # Criar um √∫nico quadro que representar√° todos os postos
        try:
            # Obter a categoria selecionada
            categoria = request.POST.get('categoria', 'OFICIAIS')
            
            novo_quadro = QuadroAcesso.objects.create(
                tipo=tipo,
                categoria=categoria,
                data_promocao=data_promocao,
                status='EM_ELABORACAO',
                observacoes=f"Quadro de {tipo.lower()} para {categoria.lower()} - {data_promocao.strftime('%d/%m/%Y')} - Inclui todos os postos"
            )
            
            # Gerar o quadro com todos os postos
            sucesso, mensagem = novo_quadro.gerar_quadro_completo()
            
            if sucesso:
                if data_automatica:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso! Data autom√°tica: {data_promocao.strftime("%d/%m/%Y")}')
                else:
                    messages.success(request, f'Quadro de {novo_quadro.get_tipo_display().lower()} criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
                messages.success(request, mensagem)
                # Redirecionar para a view correta baseada na categoria
                if novo_quadro.categoria == 'PRACAS':
                    return redirect('militares:quadro_acesso_pracas_detail', pk=novo_quadro.pk)
                else:
                    return redirect('militares:quadro_acesso_detail', pk=novo_quadro.pk)
            else:
                novo_quadro.delete()
                messages.error(request, f'Erro ao criar quadro: {mensagem}')
                
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro: {str(e)}')
        
        return redirect('militares:gerar_quadro_acesso')
    
    context = {
        'tipos': QuadroAcesso.TIPO_CHOICES,
        'categorias': [
            ('OFICIAIS', 'Oficiais'),
            ('PRACAS', 'Pra√ßas')
        ],
        'categoria_selecionada': request.POST.get('categoria', 'OFICIAIS') if request.method == 'POST' else 'OFICIAIS',
        'quadros_recentes': QuadroAcesso.objects.all().order_by('-data_criacao')[:10],
        'proxima_data_automatica': calcular_proxima_data_promocao(tipo='OFICIAIS'),
    }
    
    return render(request, 'militares/gerar_quadro_acesso.html', context)

@login_required
def regerar_quadro_acesso(request, pk):
    """Regera um quadro de acesso existente"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        sucesso, mensagem = quadro.gerar_quadro_automatico()
        
        if sucesso:
            messages.success(request, mensagem)
        else:
            messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def delete_quadro_acesso(request, pk):
    """Exclui um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        # Verificar se o quadro est√° homologado
        if quadro.status == 'HOMOLOGADO':
            messages.error(request, 'N√£o √© poss√≠vel excluir um quadro homologado. Deshomologize primeiro.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Excluir todos os itens do quadro primeiro
        quadro.itemquadroacesso_set.all().delete()
        # Excluir o quadro
        quadro.delete()
        
        messages.success(request, 'Quadro de acesso exclu√≠do com sucesso!')
        return redirect('militares:quadro_acesso_list')
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_confirm_delete.html', context)

@login_required
def adicionar_oficial_quadro_oficiais(request, pk):
    """Adiciona um oficial ao quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, 'Quadro n√£o encontrado!')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        posicao = request.POST.get('posicao')
        pontuacao = request.POST.get('pontuacao')
        
        if not militar_id:
            messages.error(request, 'Militar n√£o selecionado!')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Verificar se o militar j√° est√° no quadro
            if quadro.itemquadroacesso_set.filter(militar=militar).exists():
                messages.error(request, f'O oficial {militar.nome_completo} j√° est√° no quadro.')
                return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Adicionar o militar ao quadro
            quadro.adicionar_militar_manual(militar, posicao, pontuacao)
            
            messages.success(request, f'Oficial {militar.nome_completo} adicionado ao quadro com sucesso!')
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
        except ValueError as e:
            messages.error(request, str(e))
        except Exception as e:
            messages.error(request, f'Erro ao adicionar militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def remover_militar_quadro_oficiais(request, pk, militar_id):
    """Remove um militar do quadro de acesso de oficiais"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado.')
        return redirect('militares:quadro_acesso_list')
    
    # Verificar se o quadro √© de oficiais
    if quadro.categoria != 'OFICIAIS':
        messages.error(request, 'Este quadro n√£o √© de oficiais!')
        return redirect('militares:quadro_acesso_list')
    
    if quadro.status == 'HOMOLOGADO':
        messages.error(request, 'Quadros homologados n√£o podem ser editados.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    try:
        militar = Militar.objects.get(pk=militar_id)
        
        # Verificar se o militar est√° no quadro
        item = quadro.itemquadroacesso_set.filter(militar=militar).first()
        if not item:
            messages.error(request, f'O oficial {militar.nome_completo} n√£o est√° no quadro.')
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
        
        # Remover o militar
        quadro.remover_militar_manual(militar)
        
        messages.success(request, f'Oficial {militar.nome_completo} removido do quadro com sucesso!')
    except Militar.DoesNotExist:
        messages.error(request, 'Militar n√£o encontrado.')
    except ValueError as e:
        messages.error(request, str(e))
    except Exception as e:
        messages.error(request, f'Erro ao remover militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def buscar_oficiais_elegiveis(request):
    """Busca oficiais eleg√≠veis para promo√ß√£o"""
    if request.method == 'POST':
        form = BuscarOficiaisElegiveisForm(request.POST)
        if form.is_valid():
            data_promocao = form.cleaned_data['data_promocao']
            quadro = form.cleaned_data['quadro']
            posto_graduacao = form.cleaned_data['posto_graduacao']
            
            # Buscar oficiais eleg√≠veis
            oficiais_elegiveis = Militar.objects.oficiais_elegiveis_para_promocao(
                data_promocao=data_promocao,
                quadro=quadro,
                posto_graduacao=posto_graduacao
            )
            
            # Renderizar resultados
            context = {
                'oficiais_elegiveis': oficiais_elegiveis,
                'form': form,
            }
            return render(request, 'militares/buscar_oficiais_elegiveis.html', context)
    else:
        form = BuscarOficiaisElegiveisForm()
    
    context = {
        'form': form,
    }
    return render(request, 'militares/buscar_oficiais_elegiveis.html', context)

@login_required
def homologar_quadro_acesso(request, pk):
    """Homologa um quadro de acesso, solicitando confirma√ß√£o de senha e fun√ß√£o via modal"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        senha = request.POST.get('senha')
        funcao_id = request.POST.get('funcao_homologacao')
        
        # Verificar se a senha foi fornecida
        if not senha:
            messages.error(request, 'Senha √© obrigat√≥ria.')
            return redirect('militares:quadro_acesso_list')
        
        # Verificar se a fun√ß√£o foi selecionada
        if not funcao_id:
            messages.error(request, 'Fun√ß√£o √© obrigat√≥ria.')
            return redirect('militares:quadro_acesso_list')
        
        # Verificar se a senha est√° correta
        user = authenticate(username=request.user.username, password=senha)
        if user is None:
            messages.error(request, 'Senha incorreta. Tente novamente.')
            return redirect('militares:quadro_acesso_list')
        
        # Verificar se a fun√ß√£o existe e pertence ao usu√°rio
        try:
            funcao = UsuarioFuncaoMilitar.objects.get(id=funcao_id, usuario=request.user)
        except UsuarioFuncaoMilitar.DoesNotExist:
            messages.error(request, 'Fun√ß√£o inv√°lida.')
            return redirect('militares:quadro_acesso_list')
        
        # Verificar permiss√£o de homologa√ß√£o baseada na fun√ß√£o selecionada
        if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
            # Para quadros de oficiais, verificar se √© presidente da CPO
            comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
            if not comissao_cpo or not comissao_cpo.eh_presidente_por_funcao(request.user, funcao):
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
                return redirect('militares:quadro_acesso_list')
        else:
            # Para quadros de pra√ßas, verificar se √© presidente da CPP
            comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
            if not comissao_cpp or not comissao_cpp.eh_presidente_por_funcao(request.user, funcao):
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
                return redirect('militares:quadro_acesso_list')
        
        # Homologar o quadro
        if quadro.status == 'ELABORADO':
            quadro.status = 'HOMOLOGADO'
            quadro.data_homologacao = timezone.now().date()
            quadro.homologado_por = request.user
            quadro.save()
            messages.success(request, 'Quadro de acesso homologado com sucesso!')
            return redirect('militares:quadro_acesso_list')
        else:
            messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
            return redirect('militares:quadro_acesso_list')

    # Se chegou aqui, redirecionar para a lista
    return redirect('militares:quadro_acesso_list')

@login_required
def deshomologar_quadro_acesso(request, pk):
    """Deshomologa um quadro de acesso (apenas pelo usu√°rio que homologou)"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')

    if request.method == 'POST':
        if quadro.status == 'HOMOLOGADO':
            if quadro.homologado_por and quadro.homologado_por != request.user:
                messages.error(request, 'Apenas o usu√°rio que homologou pode deshomologar este quadro.')
            else:
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.homologado_por = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
        else:
            messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')

    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def elaborar_quadro_acesso(request, pk):
    """Elabora um quadro de acesso n√£o elaborado"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        if quadro.status == 'NAO_ELABORADO':
            # Usar a l√≥gica de gera√ß√£o autom√°tica
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
        else:
            messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def quadro_acesso_edit(request, pk):
    """Edita um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        action = request.POST.get('action', 'salvar')
        
        if action == 'salvar':
            # Edi√ß√£o b√°sica do quadro
            try:
                data_promocao = request.POST.get('data_promocao')
                if data_promocao:
                    quadro.data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                
                status = request.POST.get('status')
                if status:
                    quadro.status = status
                
                motivo_nao_elaboracao = request.POST.get('motivo_nao_elaboracao')
                if motivo_nao_elaboracao:
                    quadro.motivo_nao_elaboracao = motivo_nao_elaboracao
                else:
                    quadro.motivo_nao_elaboracao = None
                
                quadro.observacoes = request.POST.get('observacoes', '')
                quadro.assinaturas.all().delete()
                quadro.save()
                
                messages.success(request, 'Quadro de acesso atualizado com sucesso!')
                
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_acesso_edit', pk=quadro.pk)
        
        elif action == 'regenerar':
            # Regenerar o quadro
            sucesso, mensagem = quadro.gerar_quadro_automatico()
            if sucesso:
                messages.success(request, mensagem)
            else:
                messages.error(request, f'Erro ao regenerar quadro: {mensagem}')
        
        elif action == 'homologar':
            # Verificar permiss√£o de homologa√ß√£o - apenas presidente da comiss√£o pode homologar
            if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
                # Para quadros de oficiais, verificar se √© presidente da CPO
                comissao_cpo = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
                if not comissao_cpo or not comissao_cpo.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de oficiais. Apenas o presidente da CPO pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            else:
                # Para quadros de pra√ßas, verificar se √© presidente da CPP
                comissao_cpp = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
                if not comissao_cpp or not comissao_cpp.eh_presidente(request.user):
                    messages.error(request, 'Voc√™ n√£o tem permiss√£o para homologar quadros de pra√ßas. Apenas o presidente da CPP pode homologar.')
                    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
            
            # Homologar o quadro
            if quadro.status == 'ELABORADO':
                quadro.status = 'HOMOLOGADO'
                quadro.data_homologacao = timezone.now().date()
                quadro.homologado_por = request.user
                quadro.save()
                messages.success(request, 'Quadro de acesso homologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros elaborados podem ser homologados.')
        
        elif action == 'deshomologar':
            # Deshomologar o quadro
            if quadro.status == 'HOMOLOGADO':
                quadro.status = 'ELABORADO'
                quadro.data_homologacao = None
                quadro.save()
                messages.success(request, 'Quadro de acesso deshomologado com sucesso!')
            else:
                messages.error(request, 'Apenas quadros homologados podem ser deshomologados.')
        
        elif action == 'elaborar':
            # Elaborar o quadro
            if quadro.status == 'NAO_ELABORADO':
                sucesso, mensagem = quadro.gerar_quadro_automatico()
                if sucesso:
                    messages.success(request, mensagem)
                else:
                    messages.error(request, f'Erro ao elaborar quadro: {mensagem}')
            else:
                messages.error(request, 'Apenas quadros n√£o elaborados podem ser elaborados.')
        
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_acesso_edit.html', context)

@login_required
def quadro_acesso_print(request, pk):
    """Vers√£o para impress√£o do quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    context = {
        'quadro': quadro,
        'itens': quadro.itemquadroacesso_set.all().order_by('posicao'),
    }
    
    return render(request, 'militares/quadro_acesso_print.html', context)

@login_required
def marcar_nao_elaborado(request, pk):
    """Marca um quadro como n√£o elaborado"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if request.method == 'POST':
        motivo = request.POST.get('motivo')
        observacoes = request.POST.get('observacoes', '')
        
        quadro.status = 'NAO_ELABORADO'
        quadro.motivo_nao_elaboracao = motivo
        quadro.observacoes = observacoes
        quadro.save()
        
        # Limpar itens existentes
        quadro.itemquadroacesso_set.all().delete()
        
        messages.success(request, 'Quadro marcado como n√£o elaborado.')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

# Views para Promo√ß√µes
@login_required
@requer_perm_promocoes_visualizar
@login_required
def promocao_list(request):
    """Lista promo√ß√µes"""
    # Filtros
    query = request.GET.get('q', '')
    criterio = request.GET.get('criterio', '')
    data_inicio = request.GET.get('data_inicio', '')
    data_fim = request.GET.get('data_fim', '')
    
    promocoes = Promocao.objects.all()
    
    # Aplicar filtros
    if query:
        promocoes = promocoes.filter(
            Q(militar__nome_completo__icontains=query) |
            Q(militar__nome_guerra__icontains=query) |
            Q(militar__matricula__icontains=query) |
            Q(numero_ato__icontains=query)
        )
    
    if criterio:
        promocoes = promocoes.filter(criterio=criterio)
    
    if data_inicio:
        promocoes = promocoes.filter(data_promocao__gte=data_inicio)
    
    if data_fim:
        promocoes = promocoes.filter(data_promocao__lte=data_fim)
    
    # Ordena√ß√£o: primeiro normais, depois hist√≥ricas, ambas por hierarquia de postos
    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13, # Cabo
        'SD': 14,  # Soldado
        'NVRR': 15, # NVRR
    }
    
    # Converter para lista para ordena√ß√£o personalizada
    promocoes_list = list(promocoes)
    
    # Ordenar: primeiro por tipo (normais primeiro), depois por hierarquia de posto, depois por data
    promocoes_list.sort(key=lambda x: (
        x.is_historica,  # False (normais) vem primeiro, True (hist√≥ricas) depois
        hierarquia_postos.get(x.posto_novo, 999),  # Hierarquia do posto novo
        -x.data_promocao.toordinal()  # Data mais recente primeiro (ordinal negativo)
    ))
    
    promocoes = promocoes_list
    
    # Estat√≠sticas
    total_promocoes = Promocao.objects.count()
    promocoes_este_ano = Promocao.objects.filter(data_promocao__year=timezone.now().year).count()
    militares_promovidos = Promocao.objects.values('militar').distinct().count()
    promocoes_merecimento = Promocao.objects.filter(criterio='MERECIMENTO').count()
    
    # Pagina√ß√£o com seletor de registros por p√°gina
    registros_por_pagina = request.GET.get('registros', '20')
    try:
        registros_por_pagina = int(registros_por_pagina)
        # Validar valores permitidos
        if registros_por_pagina not in [10, 20, 50, 100]:
            registros_por_pagina = 20
    except ValueError:
        registros_por_pagina = 20
    
    paginator = Paginator(promocoes, registros_por_pagina)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # Op√ß√µes de registros por p√°gina
    opcoes_registros = [10, 20, 50, 100]
    
    context = {
        'promocoes': page_obj,
        'total_promocoes': total_promocoes,
        'promocoes_este_ano': promocoes_este_ano,
        'militares_promovidos': militares_promovidos,
        'promocoes_merecimento': promocoes_merecimento,
        'registros_por_pagina': registros_por_pagina,
        'opcoes_registros': opcoes_registros,
    }
    
    return render(request, 'militares/promocao_list.html', context)

@login_required
@requer_perm_promocoes_criar
@login_required
def promocao_create(request):
    """Registra nova promo√ß√£o"""
    from .forms import PromocaoForm
    
    if request.method == 'POST':
        form = PromocaoForm(request.POST)
        if form.is_valid():
            militar = form.cleaned_data['militar']
            posto_anterior = form.cleaned_data['posto_anterior']
            posto_novo = form.cleaned_data['posto_novo']
            criterio = form.cleaned_data['criterio']
            data_promocao = form.cleaned_data['data_promocao']
            data_publicacao = form.cleaned_data['data_publicacao']
            numero_ato = form.cleaned_data['numero_ato']
            observacoes = form.cleaned_data['observacoes']
            is_historica = form.cleaned_data.get('is_historica', False)
            
            # Se n√£o foi informado posto anterior, usar o atual do militar
            if not posto_anterior:
                posto_anterior = militar.posto_graduacao
            
            # Cria promo√ß√£o
            promocao = Promocao.objects.create(
                militar=militar,
                posto_anterior=posto_anterior,
                posto_novo=posto_novo,
                criterio=criterio,
                data_promocao=data_promocao,
                data_publicacao=data_publicacao or timezone.now().date(),
                numero_ato=numero_ato or f"ATO-{timezone.now().strftime('%Y%m%d%H%M%S')}",
                observacoes=observacoes,
                is_historica=is_historica
            )
            
            # S√≥ atualiza o militar se n√£o for promo√ß√£o hist√≥rica
            if not is_historica:
                # Capturar dados anteriores antes da promo√ß√£o
                posto_anterior = militar.posto_graduacao
                quadro_anterior = militar.quadro
                
                # Atualizar posto e data de promo√ß√£o
                militar.posto_graduacao = posto_novo
                militar.data_promocao_atual = data_promocao
                
                # Atribuir a pr√≥xima numera√ß√£o dispon√≠vel no novo posto
                nova_numeracao = militar.atribuir_numeracao_por_promocao(posto_anterior, quadro_anterior)
                
                # Reordenar os militares do posto anterior (preencher gap)
                militares_reordenados = militar.reordenar_posto_anterior_apos_promocao(posto_anterior, quadro_anterior)
                
                militar.save()
                
                messages.success(
                    request, 
                    f'Promo√ß√£o registrada com sucesso! {militar.nome_completo} recebeu a {nova_numeracao}¬™ numera√ß√£o de antiguidade no posto de {militar.get_posto_graduacao_display()}. {militares_reordenados} militares foram reordenados no posto anterior.'
                )
            else:
                # Mensagem para promo√ß√µes hist√≥ricas (qualquer posto)
                messages.success(request, f'Promo√ß√£o hist√≥rica registrada com sucesso! O posto atual do militar n√£o foi alterado.')
            
            return redirect('militares:promocao_list')
    else:
        form = PromocaoForm()
    
    # Verificar se h√° um militar pr√©-selecionado na URL
    militar_pre_selecionado = None
    militar_id = request.GET.get('militar')
    if militar_id:
        try:
            militar_pre_selecionado = Militar.objects.get(pk=militar_id)
            if form.is_bound:
                form.initial['militar'] = militar_pre_selecionado
        except Militar.DoesNotExist:
            pass
    
    context = {
        'form': form,
        'militares': Militar.objects.filter(classificacao='ATIVO').order_by('nome_completo'),
        'postos': POSTO_GRADUACAO_CHOICES,
        'criterios': Promocao.CRITERIO_CHOICES,
        'today': timezone.now().date().isoformat(),
        'militar_pre_selecionado': militar_pre_selecionado,
    }
    
    return render(request, 'militares/promocao_form.html', context)

@login_required
@requer_perm_promocoes_editar
@login_required
def promocao_update(request, pk):
    """Edita uma promo√ß√£o existente"""
    from .forms import PromocaoForm
    
    print(f"DEBUG: Tentando editar promo√ß√£o com PK: {pk}")
    
    try:
        promocao = Promocao.objects.get(pk=pk)
        print(f"DEBUG: Promo√ß√£o encontrada: {promocao}")
        print(f"DEBUG: Militar: {promocao.militar.nome_completo}")
        print(f"DEBUG: Posto anterior: {promocao.posto_anterior}")
        print(f"DEBUG: Posto novo: {promocao.posto_novo}")
    except Promocao.DoesNotExist:
        print(f"DEBUG: Promo√ß√£o n√£o encontrada para PK: {pk}")
        messages.error(request, 'Promo√ß√£o n√£o encontrada.')
        return redirect('militares:promocao_list')
    
    if request.method == 'POST':
        form = PromocaoForm(request.POST, instance=promocao)
        if form.is_valid():
            # Capturar dados antes da edi√ß√£o para compara√ß√£o
            posto_anterior_original = promocao.posto_anterior
            posto_novo_original = promocao.posto_novo
            is_historica_original = promocao.is_historica
            militar_original = promocao.militar
            
            # Salvar a promo√ß√£o editada
            promocao = form.save()
            
            # Se a promo√ß√£o n√£o √© mais hist√≥rica e foi alterada para n√£o hist√≥rica
            if not promocao.is_historica and is_historica_original:
                # Atualizar o militar com o novo posto
                militar = promocao.militar
                militar.posto_graduacao = promocao.posto_novo
                militar.data_promocao_atual = promocao.data_promocao
                militar.save()
                messages.success(request, f'Promo√ß√£o editada com sucesso! O posto atual do militar foi atualizado para {militar.get_posto_graduacao_display()}.')
            elif promocao.is_historica and not is_historica_original:
                # Se foi alterada para hist√≥rica, reverter o posto do militar
                militar = promocao.militar
                # Buscar a √∫ltima promo√ß√£o n√£o hist√≥rica
                ultima_promocao = Promocao.objects.filter(
                    militar=militar, 
                    is_historica=False
                ).exclude(pk=pk).order_by('-data_promocao').first()
                
                if ultima_promocao:
                    militar.posto_graduacao = ultima_promocao.posto_novo
                    militar.data_promocao_atual = ultima_promocao.data_promocao
                else:
                    # Se n√£o houver outras promo√ß√µes, usar o posto anterior desta promo√ß√£o
                    militar.posto_graduacao = promocao.posto_anterior
                    militar.data_promocao_atual = None
                
                militar.save()
                messages.success(request, f'Promo√ß√£o editada com sucesso! O posto atual do militar foi revertido para {militar.get_posto_graduacao_display()}.')
            else:
                # Se n√£o houve mudan√ßa no tipo de promo√ß√£o
                messages.success(request, 'Promo√ß√£o editada com sucesso!')
            
            return redirect('militares:promocao_list')
    else:
        form = PromocaoForm(instance=promocao)
    
    context = {
        'form': form,
        'promocao': promocao,
        'militares': Militar.objects.filter(classificacao='ATIVO').order_by('nome_completo'),
        'postos': POSTO_GRADUACAO_CHOICES,
        'criterios': Promocao.CRITERIO_CHOICES,
        'today': timezone.now().date().isoformat(),
        'is_editing': True,
    }
    
    print(f"DEBUG: Editando promo√ß√£o {promocao.pk}, is_editing={context['is_editing']}")
    print(f"DEBUG: Dados da promo√ß√£o: posto_anterior={promocao.posto_anterior}, posto_novo={promocao.posto_novo}")
    print(f"DEBUG: Contexto completo: {context}")
    
    return render(request, 'militares/promocao_form.html', context)

@login_required
def promocao_historica_create(request):
    """Registra promo√ß√£o hist√≥rica (n√£o atualiza o militar)"""
    if request.method == 'POST':
        militar_id = request.POST.get('militar')
        posto_anterior = request.POST.get('posto_anterior')
        posto_novo = request.POST.get('posto_novo')
        criterio = request.POST.get('criterio')
        data_promocao = request.POST.get('data_promocao')
        data_publicacao = request.POST.get('data_publicacao')
        numero_ato = request.POST.get('numero_ato')
        observacoes = request.POST.get('observacoes')
        
        if all([militar_id, posto_anterior, posto_novo, criterio, data_promocao]):
            militar = get_object_or_404(Militar, pk=militar_id)
            
            # Cria promo√ß√£o hist√≥rica (n√£o atualiza o militar)
            promocao = Promocao.objects.create(
                militar=militar,
                posto_anterior=posto_anterior,
                posto_novo=posto_novo,
                criterio=criterio,
                data_promocao=data_promocao,
                data_publicacao=data_publicacao or timezone.now().date(),
                numero_ato=numero_ato or f"ATO-HIST-{timezone.now().strftime('%Y%m%d%H%M%S')}",
                observacoes=observacoes,
                is_historica=True
            )
            
            messages.success(request, f'Promo√ß√£o hist√≥rica registrada com sucesso!')
            return redirect('militares:promocao_list')
    
    context = {
        'militares': Militar.objects.all().order_by('nome_completo'),  # Todos os militares, n√£o s√≥ ativos
        'postos': POSTO_GRADUACAO_CHOICES,
        'criterios': Promocao.CRITERIO_CHOICES,
        'today': timezone.now().date().isoformat(),
        'is_historica': True,
    }
    
    return render(request, 'militares/promocao_form.html', context)

@login_required
@requer_perm_promocoes_admin
def promocao_delete(request, pk):
    promocao = get_object_or_404(Promocao, pk=pk)
    if request.method == 'POST':
        promocao.delete()
        messages.success(request, 'Promo√ß√£o exclu√≠da com sucesso!')
        return redirect('militares:promocao_list')
    return render(request, 'militares/promocao_confirm_delete.html', {'promocao': promocao})

# Views para Vagas
@login_required
@requer_perm_vagas_visualizar
def vaga_list(request):
    """Quadro de Fixa√ß√£o de Vagas: mostra vagas do sistema separadas por quadro e permite inserir vagas manuais"""
    # Processa o formul√°rio de vaga manual
    if request.method == 'POST':
        if 'vaga_manual' in request.POST:
            posto = request.POST.get('posto')
            quadro = request.POST.get('quadro')
            quantidade = request.POST.get('quantidade')
            justificativa = request.POST.get('justificativa')
            observacoes = request.POST.get('observacoes')
            if posto and quadro and quantidade and justificativa:
                try:
                    quantidade = int(quantidade)
                    if quantidade < 1:
                        quantidade = 1
                except ValueError:
                    quantidade = 1
                VagaManual.objects.create(
                    posto=posto,
                    quadro=quadro,
                    quantidade=quantidade,
                    justificativa=justificativa,
                    observacoes=observacoes or ''
                )
                messages.success(request, 'Vaga manual inserida com sucesso!')
                return redirect('vaga_list')
        
        # Processa atualiza√ß√£o de vagas fixadas
        elif 'atualizar_vagas_fixadas' in request.POST:
            for key, value in request.POST.items():
                if key.startswith('vagas_fixadas_'):
                    # Extrai o ID da previs√£o de vaga
                    previsao_id = key.replace('vagas_fixadas_', '')
                    try:
                        previsao = PrevisaoVaga.objects.get(id=previsao_id)
                        vagas_fixadas = int(value) if value else 0
                        previsao.vagas_fixadas = vagas_fixadas
                        
                        # Busca observa√ß√µes correspondentes
                        obs_key = f'observacoes_vagas_fixadas_{previsao_id}'
                        observacoes = request.POST.get(obs_key, '')
                        previsao.observacoes_vagas_fixadas = observacoes
                        
                        previsao.save()
                    except (PrevisaoVaga.DoesNotExist, ValueError):
                        continue
            
            messages.success(request, 'Vagas fixadas atualizadas com sucesso!')
            return redirect('vaga_list')
    
    # Busca previs√µes de vagas por quadro (oficiais)
    previsoes_oficiais = PrevisaoVaga.objects.filter(
        posto__in=['2T', '1T', 'CP', 'MJ', 'TC', 'CB'],
        ativo=True
    ).order_by('quadro', 'posto')
    
    # Busca previs√µes de vagas por quadro (pra√ßas)
    previsoes_pracas = PrevisaoVaga.objects.filter(
        posto__in=['ST', 'SGT', 'CB', 'SD'],
        ativo=True
    ).order_by('quadro', 'posto')
    
    # Organiza por quadro
    vagas_oficiais_por_quadro = {}
    vagas_pracas_por_quadro = {}
    
    for previsao in previsoes_oficiais:
        if previsao.quadro not in vagas_oficiais_por_quadro:
            vagas_oficiais_por_quadro[previsao.quadro] = []
        vagas_oficiais_por_quadro[previsao.quadro].append(previsao)
    
    for previsao in previsoes_pracas:
        if previsao.quadro not in vagas_pracas_por_quadro:
            vagas_pracas_por_quadro[previsao.quadro] = []
        vagas_pracas_por_quadro[previsao.quadro].append(previsao)
    
    # Busca vagas manuais
    vagas_manuais = VagaManual.objects.all().order_by('-data_solicitacao')
    
    context = {
        'vagas_oficiais_por_quadro': vagas_oficiais_por_quadro,
        'vagas_pracas_por_quadro': vagas_pracas_por_quadro,
        'vagas_manuais': vagas_manuais,
        'quadros': [
            ('COMB', 'Quadro de Oficiais Bombeiros Militares Combatentes - QOBM/Comb.'),
            ('SAUDE', 'Quadro de Oficiais Bombeiros Militares de Sa√∫de - QOBM/Sa√∫de'),
            ('ENG', 'Quadro de Oficiais Bombeiros Militares Engenheiros - QOBM/Eng.'),
            ('COMP', 'Quadro de Oficiais Bombeiros Militares Complementar - QOBM/Comp.'),
        ]
    }
    
    return render(request, 'militares/vaga_list.html', context)

@login_required
@requer_perm_vagas_editar
def vaga_update(request, pk):
    """Atualiza vaga"""
    vaga = get_object_or_404(Vaga, pk=pk)
    
    if request.method == 'POST':
        efetivo_atual = request.POST.get('efetivo_atual')
        efetivo_maximo = request.POST.get('efetivo_maximo')
        
        if efetivo_atual and efetivo_maximo:
            vaga.efetivo_atual = int(efetivo_atual)
            vaga.efetivo_maximo = int(efetivo_maximo)
            vaga.save()
            
            messages.success(request, f'Vaga atualizada com sucesso!')
            return redirect('militares:vaga_list')
    
    context = {
        'vaga': vaga,
    }
    
    return render(request, 'militares/vaga_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_form(request, militar_pk):
    """Formul√°rio de ficha de conceito com upload de documentos - redireciona para view espec√≠fica"""
    militar = get_object_or_404(Militar, pk=militar_pk)
    
    # Verificar se √© oficial ou pra√ßa
    postos_oficiais = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    is_oficial = militar.posto_graduacao in postos_oficiais
    
    if is_oficial:
        # Se √© oficial, usar a view gen√©rica (que j√° funciona para oficiais)
        return ficha_conceito_form_oficiais(request, militar_pk)
    else:
        # Se √© pra√ßa, redirecionar para a view espec√≠fica de pra√ßas
        from .views_pracas import ficha_conceito_pracas_form
        return ficha_conceito_pracas_form(request, militar_pk)

from .decorators import usuario_comissao_required, usuario_cpo_required, usuario_cpp_required, apenas_visualizacao_comissao, administracao_required, militar_edit_permission, comissao_acesso_total, cargos_especiais_required, can_edit_ficha_conceito

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_form_oficiais(request, militar_pk):
    """Formul√°rio de ficha de conceito para oficiais com upload de documentos"""
    # Verificar permiss√£o
    if not can_edit_ficha_conceito(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar fichas de conceito. Apenas Chefe da Se√ß√£o de Promo√ß√µes e Auxiliar da Se√ß√£o de Promo√ß√µes podem editar.')
        return redirect('militares:ficha_conceito_list')
    
    militar = get_object_or_404(Militar, pk=militar_pk)
    
    # Verificar se j√° existe uma ficha para este militar
    ficha_existente_oficiais = militar.fichaconceitooficiais_set.first()
    ficha_existente_pracas = militar.fichaconceitopracas_set.first()
    
    if request.method == 'POST':
        if ficha_existente_oficiais:
            # Se j√° existe ficha de oficiais, atualizar
            form = FichaConceitoOficiaisForm(request.POST, request.FILES, instance=ficha_existente_oficiais, militar=militar)
        elif ficha_existente_pracas:
            # Se j√° existe ficha de pra√ßas, atualizar
            form = FichaConceitoPracasForm(request.POST, request.FILES, instance=ficha_existente_pracas, militar=militar)
        else:
            # Se n√£o existe, criar nova ficha baseada no posto
            if militar.posto_graduacao in ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']:
                form = FichaConceitoOficiaisForm(request.POST, request.FILES, militar=militar)
            else:
                form = FichaConceitoPracasForm(request.POST, request.FILES, militar=militar)
        
        if form.is_valid():
            ficha = form.save(commit=False)
            ficha.militar = militar
            ficha.save()
            
            # Processar documentos se fornecidos
            documentos = request.FILES.getlist('documentos')
            for doc_file in documentos:
                Documento.objects.create(
                    militar=militar,
                    ficha_conceito=ficha,
                    tipo='OUTROS',
                    titulo=f"Documento: {doc_file.name}",
                    arquivo=doc_file
                )
            
            messages.success(request, 'Ficha de conceito salva com sucesso!')
            return redirect('militares:ficha_conceito_list')
        else:
            # Debug: mostrar erros do formul√°rio
            print("Erros do formul√°rio:", form.errors)
            messages.error(request, f'Erro ao salvar ficha de conceito: {form.errors}')
    else:
        if ficha_existente_oficiais:
            # Se j√° existe ficha de oficiais, carregar dados
            form = FichaConceitoOficiaisForm(instance=ficha_existente_oficiais, militar=militar)
        elif ficha_existente_pracas:
            # Se j√° existe ficha de pra√ßas, carregar dados
            form = FichaConceitoPracasForm(instance=ficha_existente_pracas, militar=militar)
        else:
            # Se n√£o existe, criar formul√°rio vazio baseado no posto
            if militar.posto_graduacao in ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']:
                form = FichaConceitoOficiaisForm(militar=militar)
            else:
                form = FichaConceitoPracasForm(militar=militar)
    
    context = {
        'form': form,
        'militar': militar,
        'ficha': ficha_existente_oficiais or ficha_existente_pracas,
        'documento_form': DocumentoForm(),
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@diretor_gestao_chefe_promocoes_required
def ficha_conceito_edit(request, pk):
    """Editar ficha de conceito"""
    # Verificar permiss√£o
    if not can_edit_ficha_conceito(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar fichas de conceito. Apenas Chefe da Se√ß√£o de Promo√ß√µes e Auxiliar da Se√ß√£o de Promo√ß√µes podem editar.')
        return redirect('militares:ficha_conceito_list')
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
        form_class = FichaConceitoOficiaisForm
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
            form_class = FichaConceitoPracasForm
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        form = form_class(request.POST, instance=ficha, militar=ficha.militar)
        if form.is_valid():
            form.save()
            messages.success(request, 'Ficha de conceito atualizada com sucesso!')
            return redirect('militares:ficha_conceito_list')
    else:
        form = form_class(instance=ficha, militar=ficha.militar)
    
    context = {
        'form': form,
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/ficha_conceito_form.html', context)

@login_required
@apenas_visualizacao_comissao
def ficha_conceito_detail(request, pk):
    """Detalhes da ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    tipo_ficha = None
    
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
        tipo_ficha = 'oficiais'
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
            tipo_ficha = 'pracas'
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    # Calcular pontos detalhados para exibi√ß√£o
    if tipo_ficha == 'oficiais':
        pontos_detalhados = {
            'tempo_posto': {
                'valor': ficha.tempo_posto_extenso,
                'pontos': min(ficha.tempo_posto_anos * 1.0, 5.0),
                'limite': 5.0,
                'descricao': 'Tempo de Servi√ßo no Posto Atual (apenas anos completos)'
            },
            'cursos_militares': {
                'valor': ficha.cursos_especializacao + ficha.cursos_csbm,
                'pontos': min((ficha.cursos_especializacao * 2.5 + ficha.cursos_csbm * 4.0), 5.0),
                'limite': 5.0,
                'descricao': 'Conclus√£o de Cursos Militares'
            },
            'instrutor': {
                'valor': (ficha.cursos_cfsd + ficha.cursos_chc + ficha.cursos_chsgt +
                         ficha.cursos_cas + ficha.cursos_cho + ficha.cursos_cfo +
                         ficha.cursos_cao + ficha.cursos_instrutor_csbm),
                'pontos': min((ficha.cursos_cfsd * 0.5 + ficha.cursos_chc * 0.75 +
                              ficha.cursos_chsgt * 1.0 + ficha.cursos_cas * 1.25 +
                              ficha.cursos_cho * 1.5 + ficha.cursos_cfo * 1.75 +
                              ficha.cursos_cao * 3.0 + ficha.cursos_instrutor_csbm * 2.5), 10.0),
                'limite': 10.0,
                'descricao': 'Instrutor em Cursos Militares'
            },
            'cursos_civis': {
                'valor': (ficha.cursos_civis_superior + ficha.cursos_civis_especializacao +
                         ficha.cursos_civis_mestrado + ficha.cursos_civis_doutorado),
                'pontos': (ficha.cursos_civis_superior * 1.5 + ficha.cursos_civis_especializacao * 2.0 +
                          ficha.cursos_civis_mestrado * 3.0 + ficha.cursos_civis_doutorado * 4.0),
                'limite': None,
                'descricao': 'Conclus√£o em Cursos Civis'
            },
            'medalhas': {
                'valor': ficha.medalha_federal + ficha.medalha_estadual + ficha.medalha_cbmepi,
                'pontos': min((ficha.medalha_federal * 0.5 + ficha.medalha_estadual * 0.25 +
                              ficha.medalha_cbmepi * 0.25), 1.0),
                'limite': 1.0,
                'descricao': 'Medalhas e Condecora√ß√µes'
            },
            'elogios': {
                'valor': ficha.elogio_individual + ficha.elogio_coletivo,
                'pontos': min((ficha.elogio_individual * 0.25 + ficha.elogio_coletivo * 0.125), 0.25), 
                'limite': 0.25,
                'descricao': 'Elogios'
            },
            'punicoes': {
                'valor': ficha.punicao_repreensao + ficha.punicao_detencao + ficha.punicao_prisao,
                'pontos': -(ficha.punicao_repreensao * 0.5 + ficha.punicao_detencao * 1.0 + 
                           ficha.punicao_prisao * 2.0),
                'limite': None,
                'descricao': 'Puni√ß√µes'
            },
            'falta_aproveitamento': {
                'valor': ficha.falta_aproveitamento,
                'pontos': -(ficha.falta_aproveitamento * 5.0),
                'limite': None,
                'descricao': 'Falta de Aproveitamento em Cursos Militares'
            }
        }
    else:  # pra√ßas
        pontos_detalhados = {
            'tempo_posto': {
                'valor': ficha.tempo_posto_extenso,
                'pontos': ficha.tempo_posto_anos * 1.0,
                'limite': None,
                'descricao': 'Tempo de Servi√ßo no Posto Atual (apenas anos completos)'
            },
            'cursos_militares': {
                'valor': ficha.cursos_especializacao,
                'pontos': min((ficha.cursos_especializacao * 2.0), 4.0),
                'limite': 4.0,
                'descricao': 'Conclus√£o de Cursos Militares'
            },
            'instrutor': {
                'valor': (ficha.cursos_cfsd + ficha.cursos_chc + ficha.cursos_chsgt +
                         ficha.cursos_cas + ficha.cursos_cho),
                'pontos': min((ficha.cursos_cfsd * 0.50 + ficha.cursos_chc * 0.75 +
                              ficha.cursos_chsgt * 1.00 + ficha.cursos_cas * 1.25 +
                              ficha.cursos_cho * 1.50), 5.0),
                'limite': 5.0,
                'descricao': 'Monitor em Cursos Militares'
            },
            'cursos_civis': {
                'valor': (ficha.cursos_civis_tecnico + ficha.cursos_civis_superior + 
                         ficha.cursos_civis_especializacao + ficha.cursos_civis_mestrado + 
                         ficha.cursos_civis_doutorado),
                'pontos': (ficha.cursos_civis_tecnico * 1.75 + ficha.cursos_civis_superior * 3.00 +
                          ficha.cursos_civis_especializacao * 4.00 + ficha.cursos_civis_mestrado * 9.00 +
                          ficha.cursos_civis_doutorado * 15.00),
                'limite': None,
                'descricao': 'Conclus√£o em Cursos Civis'
            },
            'medalhas': {
                'valor': ficha.medalha_federal + ficha.medalha_estadual + ficha.medalha_cbmepi,
                'pontos': min((ficha.medalha_federal * 0.50 + ficha.medalha_estadual * 0.30 +
                              ficha.medalha_cbmepi * 0.20), 1.0),
                'limite': 1.0,
                'descricao': 'Medalhas e Condecora√ß√µes'
            },
            'elogios': {
                'valor': ficha.elogio_individual + ficha.elogio_coletivo,
                'pontos': min((ficha.elogio_individual * 0.15 + ficha.elogio_coletivo * 0.10), 0.25), 
                'limite': 0.25,
                'descricao': 'Elogios'
            },
            'punicoes': {
                'valor': ficha.punicao_repreensao + ficha.punicao_detencao + ficha.punicao_prisao,
                'pontos': -(ficha.punicao_repreensao * 1.0 + ficha.punicao_detencao * 2.0 + 
                           ficha.punicao_prisao * 5.0),
                'limite': None,
                'descricao': 'Puni√ß√µes'
            },
            'falta_aproveitamento': {
                'valor': ficha.falta_aproveitamento,
                'pontos': -(ficha.falta_aproveitamento * 10.0),
                'limite': None,
                'descricao': 'Falta de Aproveitamento em Cursos Militares'
            }
        }
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
        'pontos_detalhados': pontos_detalhados,
        'total_pontos': ficha.calcular_pontos(),
        'tipo_ficha': tipo_ficha,
    }
    
    response = render(request, 'militares/ficha_conceito_detail.html', context)
    response['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response['Pragma'] = 'no-cache'
    response['Expires'] = '0'
    return response

@login_required
def documento_upload(request, ficha_pk):
    """Upload de documentos para ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    ficha_tipo = None
    
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=ficha_pk)
        ficha_tipo = 'oficiais'
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=ficha_pk)
            ficha_tipo = 'pracas'
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        form = DocumentoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.militar = ficha.militar
            
            # Atribuir ao campo correto baseado no tipo de ficha
            if ficha_tipo == 'oficiais':
                documento.ficha_conceito_oficiais = ficha
            else:
                documento.ficha_conceito_pracas = ficha
            
            documento.save()
            
            messages.success(request, 'Documento enviado com sucesso!')
            return redirect('militares:militar_detail', pk=ficha.militar.pk)
    else:
        form = DocumentoForm()
    
    # Buscar documentos relacionados √† ficha
    if ficha_tipo == 'oficiais':
        documentos = Documento.objects.filter(ficha_conceito_oficiais=ficha)
    else:
        documentos = Documento.objects.filter(ficha_conceito_pracas=ficha)
    
    context = {
        'form': form,
        'ficha': ficha,
        'militar': ficha.militar,
        'documentos': documentos,
    }
    
    return render(request, 'militares/documento_upload.html', context)

@login_required
def conferir_ficha(request, pk):
    """Conferir ficha de conceito"""
    # Tentar buscar em ambos os modelos
    ficha = None
    try:
        ficha = get_object_or_404(FichaConceitoOficiais, pk=pk)
    except:
        try:
            ficha = get_object_or_404(FichaConceitoPracas, pk=pk)
        except:
            messages.error(request, 'Ficha de conceito n√£o encontrada.')
            return redirect('militares:ficha_conceito_list')
    
    if request.method == 'POST':
        acao = request.POST.get('acao')
        observacoes = request.POST.get('observacoes', '')
        
        if acao in ['aprovar', 'rejeitar']:
            # Atualiza apenas as observa√ß√µes, j√° que n√£o h√° campo status
            ficha.observacoes = observacoes
            ficha.save()
            
            messages.success(request, f'Ficha {acao}da com sucesso!')
            return redirect('militares:militar_detail', pk=ficha.militar.pk)
    
    context = {
        'ficha': ficha,
        'militar': ficha.militar,
    }
    
    return render(request, 'militares/conferir_ficha.html', context)

@login_required
def conferir_documento(request, pk):
    """Conferir documento"""
    documento = get_object_or_404(Documento, pk=pk)
    
    if request.method == 'POST':
        acao = request.POST.get('acao')
        observacoes = request.POST.get('observacoes', '')
        
        if acao in ['aprovar', 'rejeitar', 'arquivar']:
            documento.status = acao.upper()
            documento.conferido_por = request.user
            documento.data_conferencia = timezone.now()
            documento.observacoes = observacoes
            documento.save()
            
            messages.success(request, f'Documento {acao}do com sucesso!')
            return redirect('militares:militar_detail', pk=documento.militar.pk)
    
    context = {
        'documento': documento,
        'militar': documento.militar,
    }
    
    return render(request, 'militares/conferir_documento.html', context)

@login_required
@requer_perm_promocoes_visualizar
def promocao_detail(request, pk):
    """Detalhes da promo√ß√£o"""
    promocao = get_object_or_404(Promocao, pk=pk)
    
    context = {
        'promocao': promocao,
    }
    
    return render(request, 'militares/promocao_detail.html', context)

@login_required
def estatisticas(request):
    """Estat√≠sticas do sistema"""
    # Estat√≠sticas gerais
    total_militares = Militar.objects.count()
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').count()
    
    # Definir hierarquia para ordena√ß√£o
    hierarquia_posto = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'NVRR': 9, # Navegador
        'ST': 10,  # Subtenente
        '1S': 11,  # 1¬∫ Sargento
        '2S': 12,  # 2¬∫ Sargento
        '3S': 13,  # 3¬∫ Sargento
        'CAB': 14, # Cabo
        'SD': 15,  # Soldado
    }
    
    hierarquia_quadro = {
        'COMB': 1,    # Combatente
        'SAUDE': 2,   # Sa√∫de
        'ENG': 3,     # Engenheiro
        'COMP': 4,    # Complementar
        'NVRR': 5,    # NVRR
        'PRACAS': 6,  # Pra√ßas
    }
    
    # Por quadro - ordenar por hierarquia
    estatisticas_quadro = list(Militar.objects.filter(classificacao='ATIVO').values('quadro').annotate(
        total=Count('id')
    ))
    estatisticas_quadro.sort(key=lambda x: hierarquia_quadro.get(x['quadro'], 999))
    
    # Por posto - ordenar por hierarquia
    estatisticas_posto = list(Militar.objects.filter(classificacao='ATIVO').values('posto_graduacao').annotate(
        total=Count('id')
    ))
    estatisticas_posto.sort(key=lambda x: hierarquia_posto.get(x['posto_graduacao'], 999))
    
    # Fichas de conceito
    total_fichas = FichaConceitoOficiais.objects.count() + FichaConceitoPracas.objects.count()
    fichas_aprovadas = 0  # Removido filtro por status que n√£o existe
    fichas_pendentes = 0  # Removido filtro por status que n√£o existe
    
    # Documentos
    total_documentos = Documento.objects.count()
    documentos_aprovados = Documento.objects.filter(status='APROVADO').count()
    documentos_pendentes = Documento.objects.filter(status='PENDENTE').count()
    
    # Estat√≠sticas dos quadros de acesso
    total_quadros_acesso = QuadroAcesso.objects.count()
    if total_quadros_acesso > 0:
        estatisticas_quadros_acesso = {
            'total': total_quadros_acesso,
            'elaborados': QuadroAcesso.objects.filter(status='ELABORADO').count(),
            'homologados': QuadroAcesso.objects.filter(status='HOMOLOGADO').count(),
            'nao_elaborados': QuadroAcesso.objects.filter(status='NAO_ELABORADO').count(),
            'em_elaboracao': QuadroAcesso.objects.filter(status='EM_ELABORACAO').count(),
            'militares_aptos': sum([q.itemquadroacesso_set.count() for q in QuadroAcesso.objects.filter(status='ELABORADO')]),
            'status': sorted(
                list(QuadroAcesso.objects.values('status').annotate(total=Count('id'))),
                key=lambda x: {
                    'ELABORADO': 1,
                    'HOMOLOGADO': 2,
                    'ASSINADO': 3,
                    'EM_ELABORACAO': 4,
                    'NAO_ELABORADO': 5
                }.get(x['status'], 999)
            ),
            'tipo': list(QuadroAcesso.objects.values('tipo').annotate(total=Count('id'))),
            'categoria': list(QuadroAcesso.objects.values('categoria').annotate(total=Count('id'))),
        }
    else:
        estatisticas_quadros_acesso = None
    
    context = {
        'total_militares': total_militares,
        'militares_ativos': militares_ativos,
        'estatisticas_quadro': estatisticas_quadro,
        'estatisticas_posto': estatisticas_posto,
        'total_fichas': total_fichas,
        'fichas_aprovadas': fichas_aprovadas,
        'fichas_pendentes': fichas_pendentes,
        'total_documentos': total_documentos,
        'documentos_aprovados': documentos_aprovados,
        'documentos_pendentes': documentos_pendentes,
        'estatisticas_quadros_acesso': estatisticas_quadros_acesso,
    }
    
    return render(request, 'militares/estatisticas.html', context)

def register(request):
    """Registro de usu√°rio"""
    if request.method == 'POST':
        form = UserRegistrationForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Conta criada com sucesso! Fa√ßa login para continuar.')
            return redirect('login')
    else:
        form = UserRegistrationForm()
    
    return render(request, 'registration/register.html', {'form': form})

def intersticio_list(request):
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    # Definir a hierarquia dos quadros
    hierarquia_quadros = {
        'COMB': 1,    # Combatente
        'SAUDE': 2,   # Sa√∫de
        'ENG': 3,     # Engenheiro
        'COMP': 4,    # Complementar
        'PRACAS': 5,  # Pra√ßas
    }
    
    # Buscar interst√≠cios ativos
    intersticios = list(Intersticio.objects.filter(ativo=True))
    
    # Filtrar apenas postos de pra√ßas no quadro de pra√ßas
    postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    intersticios = [i for i in intersticios if i.quadro != 'PRACAS' or i.posto in postos_pracas]
    
    # Ordenar por quadro primeiro, depois por posto (hierarquia)
    intersticios_ordenados = sorted(intersticios, key=lambda x: (
        hierarquia_quadros.get(x.quadro, 999),
        hierarquia_postos.get(x.posto, 999)
    ))
    
    return render(request, 'militares/intersticio_list.html', {'intersticios': intersticios_ordenados})

@login_required
@administracao_required
def intersticio_manage(request):
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    # Definir a hierarquia dos quadros
    hierarquia_quadros = {
        'COMB': 1,    # Combatente
        'SAUDE': 2,   # Sa√∫de
        'ENG': 3,     # Engenheiro
        'COMP': 4,    # Complementar
        'PRACAS': 5,  # Pra√ßas
    }
    
    # Buscar todos os interst√≠cios
    intersticios = list(Intersticio.objects.all())
    
    # Filtrar apenas postos de pra√ßas no quadro de pra√ßas
    postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    intersticios = [i for i in intersticios if i.quadro != 'PRACAS' or i.posto in postos_pracas]
    
    # Ordenar por quadro primeiro, depois por posto (hierarquia)
    intersticios_ordenados = sorted(intersticios, key=lambda x: (
        hierarquia_quadros.get(x.quadro, 999),
        hierarquia_postos.get(x.posto, 999)
    ))
    
    if request.method == 'POST':
        for inter in intersticios_ordenados:
            anos = request.POST.get(f'anos_{inter.id}', '').strip()
            meses = request.POST.get(f'meses_{inter.id}', '').strip()
            try:
                inter.tempo_minimo_anos = int(anos) if anos.isdigit() else 0
                inter.tempo_minimo_meses = int(meses) if meses.isdigit() else 0
                inter.save()
            except Exception as e:
                messages.error(request, f'Erro ao salvar {inter}: {e}')
        messages.success(request, 'Interst√≠cios atualizados com sucesso!')
        return redirect('militares:intersticio_manage')
    
    context = {
        'intersticios': intersticios_ordenados,
        'quadros': QUADRO_CHOICES,
        'postos': POSTO_GRADUACAO_CHOICES,
    }
    return render(request, 'militares/intersticio_manage.html', context)

@login_required
@administracao_required
def intersticio_create(request):
    """Criar novo interst√≠cio"""
    if request.method == 'POST':
        quadro = request.POST.get('novo_quadro')
        posto = request.POST.get('novo_posto')
        anos = request.POST.get('novo_anos', '0')
        meses = request.POST.get('novo_meses', '0')
        
        try:
            # Verificar se j√° existe um interst√≠cio para este quadro/posto
            if Intersticio.objects.filter(quadro=quadro, posto=posto).exists():
                messages.error(request, 'J√° existe um interst√≠cio para este quadro e posto!')
            else:
                Intersticio.objects.create(
                    quadro=quadro,
                    posto=posto,
                    tempo_minimo_anos=int(anos),
                    tempo_minimo_meses=int(meses),
                    ativo=True
                )
                messages.success(request, 'Interst√≠cio criado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao criar interst√≠cio: {e}')
    
    return redirect('militares:intersticio_manage')

@login_required
@administracao_required
def intersticio_delete(request, pk):
    """Excluir interst√≠cio"""
    intersticio = get_object_or_404(Intersticio, pk=pk)
    
    if request.method == 'POST':
        intersticio.delete()
        messages.success(request, 'Interst√≠cio exclu√≠do com sucesso!')
        return redirect('militares:intersticio_manage')
    
    context = {
        'intersticio': intersticio,
    }
    
    return render(request, 'militares/intersticio_confirm_delete.html', context)

@login_required
def marcar_cursos_inerentes(request, militar_pk):
    """Marca automaticamente os cursos inerentes ao quadro do militar"""
    if request.method == 'POST':
        militar = get_object_or_404(Militar, pk=militar_pk)
        militar.marcar_cursos_inerentes()
        return JsonResponse({'success': True, 'message': 'Cursos inerentes marcados com sucesso!'})
    return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'}, status=405)

@login_required
def relatorio_requisitos_quadro(request, pk):
    """Relat√≥rio detalhado dos requisitos dos militares para um quadro de acesso"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    # Buscar militares candidatos para o quadro espec√≠fico
    # Definir postos baseado no tipo de quadro
    if quadro.tipo == 'MERECIMENTO':
        # Para quadro de merecimento: incluir TC apenas para COMB (TC‚ÜíCB), excluir subtenentes (ST)
        postos = ['2T', '1T', 'CP', 'MJ', 'TC']
    else:
        # Para quadro de antiguidade: incluir todos os postos
        postos = ['ST', '2T', '1T', 'CP', 'MJ', 'TC', 'CB']
    
    # Buscar militares candidatos baseado no tipo de quadro
    militares_candidatos = []
    
    # Para quadros de merecimento, buscar apenas militares com ficha de conceito
    if quadro.tipo == 'MERECIMENTO':
        militares_candidatos = Militar.objects.filter(
            classificacao='ATIVO'
        ).filter(
            Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
        ).filter(
            posto_graduacao__in=postos
        )
    else:
        # Para quadros de antiguidade, buscar todos os militares ativos
        militares_candidatos = Militar.objects.filter(
            classificacao='ATIVO'
        ).filter(
            posto_graduacao__in=postos
        )
    
    # Debug: imprimir quantidade de candidatos encontrados
    print(f"DEBUG: Encontrados {len(militares_candidatos)} militares candidatos para o quadro {quadro.tipo}")
    
    relatorio = []
    for militar in militares_candidatos:
        # Validar cada requisito individualmente
        tem_ficha = militar.fichaconceitooficiais_set.exists() or militar.fichaconceitopracas_set.exists()
        
        apto_intersticio = quadro._validar_intersticio_minimo(militar, quadro.data_promocao)
        motivo_intersticio = ""
        if not apto_intersticio:
            motivo_intersticio = "Interst√≠cio insuficiente at√© a data da promo√ß√£o"
        
        apto_saude = quadro._validar_inspecao_saude(militar)
        motivo_saude = ""
        if not apto_saude:
            motivo_saude = "Inspe√ß√£o de sa√∫de vencida ou n√£o realizada"
        
        apto_cursos = quadro._validar_cursos_inerentes(militar)
        motivo_cursos = ""
        if not apto_cursos:
            motivo_cursos = "Cursos inerentes insuficientes para o posto subsequente"
        
        # Status geral
        apto_geral = tem_ficha and apto_intersticio and apto_saude and apto_cursos
        
        relatorio.append({
            'militar': militar,
            'tem_ficha': tem_ficha,
            'apto_intersticio': apto_intersticio,
            'motivo_intersticio': motivo_intersticio,
            'apto_saude': apto_saude,
            'motivo_saude': motivo_saude,
            'apto_cursos': apto_cursos,
            'motivo_cursos': motivo_cursos,
            'apto_geral': apto_geral,
            'tempo_no_posto': militar.tempo_posto_atual(),
            'data_inspecao': militar.data_inspecao_saude,
            'validade_inspecao': militar.data_validade_inspecao_saude,
        })
    
    # Ordenar por status (aptos primeiro) e depois por nome
    relatorio.sort(key=lambda x: (not x['apto_geral'], x['militar'].nome_completo))
    
    context = {
        'quadro': quadro,
        'relatorio': relatorio,
        'total_candidatos': len(relatorio),
        'total_aptos': sum(1 for r in relatorio if r['apto_geral']),
        'total_inaptos': sum(1 for r in relatorio if not r['apto_geral']),
    }
    
    return render(request, 'militares/relatorio_requisitos_quadro.html', context)

@login_required
def test_template(request):
    """View de teste para verificar se o problema persiste"""
    quadros = QuadroAcesso.objects.all()
    
    # Calcular estat√≠sticas
    total_quadros = quadros.count()
    elaborados = quadros.filter(status='ELABORADO').count()
    nao_elaborados = quadros.filter(status='NAO_ELABORADO').count()
    em_elaboracao = quadros.filter(status='EM_ELABORACAO').count()
    
    context = {
        'estatisticas': {
            'total': total_quadros,
            'elaborados': elaborados,
            'nao_elaborados': nao_elaborados,
            'em_elaboracao': em_elaboracao,
        }
    }
    
    return render(request, 'militares/simple_test.html', context)

class RelatorioAptosPromocaoForm(forms.Form):
    tipo = forms.ChoiceField(choices=[('ANTIGUIDADE', 'Antiguidade'), ('MERECIMENTO', 'Merecimento')], label="Tipo de Quadro de Acesso")
    data_promocao = forms.DateField(label="Data prevista para promo√ß√£o", widget=forms.DateInput(attrs={'type': 'date'}))

@login_required
def relatorio_aptos_promocao(request):
    QUADROS = [
        ('COMB', 'Combatente'),
        ('SAUDE', 'Sa√∫de'),
        ('ENG', 'Engenharia'),
        ('COMP', 'Complementar'),
    ]
    POSTOS = [
        ('2T', '2¬∫ Tenente'),
        ('1T', '1¬∫ Tenente'),
        ('CP', 'Capit√£o'),
        ('MJ', 'Major'),
        ('TC', 'Tenente-Coronel'),
        ('CB', 'Coronel'),
    ]
    relatorio = []
    form = RelatorioAptosPromocaoForm(request.GET or None)
    if form.is_valid():
        tipo = form.cleaned_data['tipo']
        data_promocao = form.cleaned_data['data_promocao']
        for cod_quadro, nome_quadro in QUADROS:
            quadro_data = {'nome': nome_quadro, 'postos': []}
            for cod_posto, nome_posto in POSTOS:
                militares = Militar.objects.filter(
                    quadro=cod_quadro,
                    posto_graduacao=cod_posto,
                    classificacao='ATIVO'
                ).filter(
                    Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
                ).distinct()
                aptos = []
                for militar in militares:
                    # Usa as regras j√° implementadas no modelo QuadroAcesso
                    dummy_quadro = QuadroAcesso(tipo=tipo, categoria='OFICIAIS' if cod_quadro in ['COMB', 'SAUDE', 'ENG', 'COMP'] else 'PRACAS', data_promocao=data_promocao)
                    apto, _ = dummy_quadro.validar_requisitos_quadro_acesso(militar, data_promocao)
                    if apto:
                        aptos.append(militar)
                quadro_data['postos'].append({
                    'nome': nome_posto,
                    'aptos': aptos,
                })
            relatorio.append(quadro_data)
    context = {
        'form': form,
        'relatorio': relatorio,
        'form_submitted': form.is_valid(),
        'tipo': form.cleaned_data['tipo'] if form.is_valid() else None,
        'data_promocao': form.cleaned_data['data_promocao'] if form.is_valid() else None,
    }
    return render(request, 'militares/relatorio_aptos_promocao.html', context)

@login_required
def test_quadro_simple(request):
    """View de teste muito simples para verificar se o problema √© espec√≠fico da p√°gina de quadros"""
    return render(request, 'militares/simple_test.html', {
        'estatisticas': {
            'total': 0,
            'elaborados': 0,
            'nao_elaborados': 0,
            'em_elaboracao': 0,
        }
    })

@login_required
def criar_quadro_manual(request):
    """Cria um quadro de acesso manual"""
    if request.method == 'POST':
        data_promocao = request.POST.get('data_promocao')
        observacoes = request.POST.get('observacoes', '')
        
        if not data_promocao:
            messages.error(request, 'A data de promo√ß√£o √© obrigat√≥ria.')
            return redirect('militares:criar_quadro_manual')
        
        try:
            data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
        except ValueError:
            messages.error(request, 'Data de promo√ß√£o inv√°lida.')
            return redirect('militares:criar_quadro_manual')
        
        # Verificar se j√° existe um quadro manual para esta data (permitir m√∫ltiplos quadros)
        # quadro_existente = QuadroAcesso.objects.filter(
        #     tipo='MANUAL',
        #     data_promocao=data_promocao
        # ).first()
        
        # if quadro_existente:
        #     messages.warning(request, f'J√° existe um quadro manual para a data {data_promocao.strftime("%d/%m/%Y")}.')
        #     return redirect('militares:quadro_acesso_detail', pk=quadro_existente.pk)
        
        # Criar o quadro manual
        try:
            novo_quadro = QuadroAcesso.objects.create(
                tipo='MANUAL',
                data_promocao=data_promocao,
                status='EM_ELABORACAO',
                is_manual=True,
                criterio_ordenacao_manual=request.POST.get('criterio_ordenacao', 'MANUAL'),
                observacoes=observacoes or f"Quadro manual para {data_promocao.strftime('%d/%m/%Y')}"
            )
            
            messages.success(request, f'Quadro manual criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
            # Redirecionar para a view correta baseada na categoria
            if novo_quadro.categoria == 'PRACAS':
                return redirect('militares:quadro_acesso_pracas_detail', pk=novo_quadro.pk)
            else:
                return redirect('militares:quadro_acesso_detail', pk=novo_quadro.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro manual: {str(e)}')
        
        return redirect('militares:criar_quadro_manual')
    
    context = {
        'proxima_data_automatica': calcular_proxima_data_promocao(),
    }
    
    return render(request, 'militares/criar_quadro_manual.html', context)

@login_required
def adicionar_militar_quadro_manual(request, pk):
    """Adiciona um militar ao quadro manual"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if not quadro.is_manual:
        messages.error(request, 'Apenas quadros manuais podem ter militares adicionados.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        posicao = request.POST.get('posicao')
        pontuacao = request.POST.get('pontuacao', 0)
        
        if not militar_id:
            messages.error(request, 'Selecione um militar.')
            return redirect('militares:adicionar_militar_quadro_manual', pk=quadro.pk)
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Converter posi√ß√£o para inteiro se fornecida
            posicao_int = None
            if posicao:
                try:
                    posicao_int = int(posicao)
                except ValueError:
                    messages.error(request, 'Posi√ß√£o deve ser um n√∫mero inteiro.')
                    return redirect('militares:adicionar_militar_quadro_manual', pk=quadro.pk)
            
            # Converter pontua√ß√£o para decimal
            try:
                pontuacao_decimal = float(pontuacao)
            except ValueError:
                pontuacao_decimal = 0
            
            # Adicionar militar ao quadro
            quadro.adicionar_militar_manual(militar, posicao_int, pontuacao_decimal)
            
            messages.success(request, f'Militar {militar.nome_completo} adicionado ao quadro com sucesso!')
            
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
        except ValueError as e:
            messages.error(request, str(e))
        except Exception as e:
            messages.error(request, f'Erro ao adicionar militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def remover_militar_quadro_manual(request, pk, militar_id):
    """Remove um militar do quadro manual"""
    try:
        quadro = QuadroAcesso.objects.get(pk=pk)
    except QuadroAcesso.DoesNotExist:
        messages.error(request, f'Quadro de acesso com ID {pk} n√£o encontrado. O quadro pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        return redirect('militares:quadro_acesso_list')
    
    if not quadro.is_manual:
        messages.error(request, 'Apenas quadros manuais podem ter militares removidos.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    if request.method == 'POST':
        try:
            militar = Militar.objects.get(pk=militar_id)
            quadro.remover_militar_manual(militar)
            messages.success(request, f'Militar {militar.nome_completo} removido do quadro com sucesso!')
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
        except ValueError as e:
            messages.error(request, str(e))
        except Exception as e:
            messages.error(request, f'Erro ao remover militar: {str(e)}')
    
    return redirect('militares:quadro_acesso_detail', pk=quadro.pk)

@login_required
def buscar_militares_ajax(request):
    """Busca militares para adicionar ao quadro manual via AJAX"""
    if request.method == 'GET':
        termo = request.GET.get('termo', '')
        if len(termo) < 2:
            return JsonResponse({'militares': []})
        
        militares = Militar.objects.filter(
            classificacao='ATIVO',
            nome_completo__icontains=termo
        ).values('id', 'nome_completo', 'posto_graduacao', 'quadro', 'matricula')[:10]
        
        return JsonResponse({'militares': list(militares)})
    
    return JsonResponse({'militares': []})

@login_required
def buscar_pontuacao_militar(request, militar_id):
    """Retorna a pontua√ß√£o da ficha de conceito do militar"""
    from militares.models import Militar
    try:
        militar = Militar.objects.get(pk=militar_id)
        ficha = militar.fichaconceitooficiais_set.first() or militar.fichaconceitopracas_set.first()
        pontuacao = ficha.pontos if ficha else 0
        return JsonResponse({'pontuacao': float(pontuacao)})
    except Militar.DoesNotExist:
        return JsonResponse({'pontuacao': 0})

@login_required
def militares_disponiveis_ajax(request):
    """Retorna TODOS os militares cadastrados no sistema para indexa√ß√£o"""
    if request.method == 'GET':
        try:
            from django.db.models import Q
            
            # Obter termo de pesquisa
            termo_pesquisa = request.GET.get('q', '').strip()
            
            # Buscar militares
            militares_query = Militar.objects.all()
            
            # Aplicar filtro de pesquisa se houver
            if termo_pesquisa:
                militares_query = militares_query.filter(
                    Q(nome_completo__icontains=termo_pesquisa) |
                    Q(nome_guerra__icontains=termo_pesquisa) |
                    Q(matricula__icontains=termo_pesquisa) |
                    Q(posto_graduacao__icontains=termo_pesquisa)
                )
            
            militares = militares_query.values(
                'id', 
                'nome_completo', 
                'posto_graduacao', 
                'matricula',
                'classificacao',
                'nome_guerra'
            ).order_by('posto_graduacao', 'nome_completo')
            
            # Converter para lista e adicionar informa√ß√µes formatadas
            militares_list = []
            for militar in militares:
                # Obter o display do posto/gradua√ß√£o
                posto_display = dict(POSTO_GRADUACAO_CHOICES).get(militar['posto_graduacao'], militar['posto_graduacao'])
                
                militares_list.append({
                    'id': militar['id'],
                    'nome_completo': militar['nome_completo'],
                    'nome_guerra': militar['nome_guerra'] or '',
                    'posto_graduacao': militar['posto_graduacao'],
                    'posto_display': posto_display,
                    'matricula': militar['matricula'],
                    'classificacao': militar['classificacao'],
                    'display_name': f"{posto_display} {militar['nome_completo']} ({militar['matricula']})"
                })
            
            return JsonResponse({
                'success': True,
                'militares': militares_list,
                'total': len(militares_list)
            })
        except Exception as e:
            return JsonResponse({
                'success': False,
                'error': str(e)
            })
    
    return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'})

@login_required
def buscar_publicacoes_militar_ajax(request, pk):
    """Busca publica√ß√µes onde o militar est√° indexado via AJAX"""
    try:
        militar = get_object_or_404(Militar, pk=pk)
        
        # Buscar publica√ß√µes onde o militar est√° indexado
        publicacoes = militar.publicacoes_indexadas.all().order_by('-data_publicacao', '-data_criacao')
        
        # Listar todas as publica√ß√µes indexadas (sem filtro de status)
        
        # Limitar resultados para performance
        publicacoes = publicacoes[:50]
        
        # Preparar dados para JSON
        publicacoes_data = []
        for pub in publicacoes:
            # Determinar o n√∫mero do boletim baseado no tipo
            numero_boletim = None
            if pub.numero_boletim:
                numero_boletim = f"Ostensivo {pub.numero_boletim}"
            elif pub.numero_boletim_reservado:
                numero_boletim = f"Reservado {pub.numero_boletim_reservado}"
            elif pub.numero_boletim_especial:
                numero_boletim = f"Especial {pub.numero_boletim_especial}"
            
            # Determinar URL do boletim baseada no tipo
            url_boletim = None
            if pub.status == 'PUBLICADA' and numero_boletim:
                # Buscar o boletim que cont√©m esta publica√ß√£o
                boletim = None
                if pub.numero_boletim:
                    boletim = Publicacao.objects.filter(
                        tipo='BOLETIM_OSTENSIVO',
                        numero_boletim=pub.numero_boletim,
                        status='PUBLICADA'
                    ).first()
                elif pub.numero_boletim_reservado:
                    boletim = Publicacao.objects.filter(
                        tipo='BOLETIM_RESERVADO',
                        numero_boletim_reservado=pub.numero_boletim_reservado,
                        status='PUBLICADA'
                    ).first()
                elif pub.numero_boletim_especial:
                    boletim = Publicacao.objects.filter(
                        tipo='BOLETIM_ESPECIAL',
                        numero=pub.numero_boletim_especial,
                        data_disponibilizacao__isnull=False
                    ).first()
                
                if boletim:
                    if pub.numero_boletim:
                        url_boletim = f'/militares/boletins-ostensivos/{boletim.id}/pdf/?t={int(time.time())}'
                    elif pub.numero_boletim_reservado:
                        url_boletim = f'/militares/boletins-reservados/{boletim.id}/pdf/?t={int(time.time())}'
                    elif pub.numero_boletim_especial:
                        url_boletim = f'/militares/boletins-especiais/{boletim.id}/pdf/?t={int(time.time())}'
            
            publicacoes_data.append({
                'id': pub.id,
                'numero': pub.numero,
                'titulo': pub.titulo,
                'tipo': pub.get_tipo_display(),
                'tipo_codigo': pub.tipo,
                'status': pub.get_status_display(),
                'status_codigo': pub.status,
                'data_publicacao': pub.data_publicacao.strftime('%d/%m/%Y %H:%M') if pub.data_publicacao else None,
                'data_criacao': pub.data_criacao.strftime('%d/%m/%Y %H:%M'),
                'origem': pub.origem_publicacao or 'N√£o informado',
                'topicos': pub.topicos or 'N√£o informado',
                'numero_boletim': numero_boletim or 'N√£o publicado',
                'url_detalhes': f'/militares/notas/{pub.id}/gerar-pdf/?t={int(time.time())}',
                'url_boletim': url_boletim,
            })
        
        return JsonResponse({
            'success': True,
            'publicacoes': publicacoes_data,
            'total': len(publicacoes_data),
            'militar': {
                'id': militar.id,
                'nome': militar.nome_completo,
                'posto': militar.get_posto_graduacao_display(),
                'matricula': militar.matricula
            }
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)

@login_required
def buscar_militares_indexados_ajax(request, pk):
    """Busca militares j√° indexados em uma publica√ß√£o via AJAX"""
    import logging
    logger = logging.getLogger(__name__)
    
    logger.info(f'DEBUG - Buscando militares indexados para publicacao {pk}')
    
    if request.method == 'GET':
        try:
            # Buscar a publica√ß√£o
            publicacao = get_object_or_404(Publicacao, pk=pk)
            
            # Buscar militares j√° indexados nesta publica√ß√£o
            militares_indexados = publicacao.militares_indexados.all().values(
                'id', 
                'nome_completo', 
                'posto_graduacao', 
                'matricula',
                'classificacao',
                'nome_guerra'
            ).order_by('posto_graduacao', 'nome_completo')
            
            # Converter para lista e adicionar informa√ß√µes formatadas
            militares_list = []
            for militar in militares_indexados:
                # Obter o display do posto/gradua√ß√£o
                posto_display = dict(POSTO_GRADUACAO_CHOICES).get(militar['posto_graduacao'], militar['posto_graduacao'])
                
                militares_list.append({
                    'id': militar['id'],
                    'nome_completo': militar['nome_completo'],
                    'nome_guerra': militar['nome_guerra'] or '',
                    'posto_graduacao': militar['posto_graduacao'],
                    'posto_display': posto_display,
                    'matricula': militar['matricula'],
                    'classificacao': militar['classificacao'],
                    'display_name': f"{posto_display} {militar['nome_completo']} ({militar['matricula']})"
                })
            
            logger.info(f'‚úÖ Encontrados {len(militares_list)} militares indexados')
            
            return JsonResponse({
                'success': True,
                'militares_indexados': militares_list,
                'total_indexados': len(militares_list)
            })
            
        except Exception as e:
            logger.error(f'‚ùå Erro ao buscar militares indexados: {str(e)}')
            return JsonResponse({
                'success': False,
                'error': f'Erro ao buscar militares indexados: {str(e)}'
            }, status=500)
    
    return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'})

@login_required
def salvar_indexacao_militares_ajax(request, pk):
    """Salva a indexa√ß√£o de militares em uma publica√ß√£o via AJAX"""
    import logging
    logger = logging.getLogger(__name__)
    
    logger.info(f'DEBUG - Salvando indexacao para publicacao {pk}')
    logger.info(f'DEBUG - Metodo: {request.method}')
    logger.info(f'DEBUG - Usuario: {request.user}')
    
    if request.method == 'POST':
        try:
            # Buscar a publica√ß√£o
            logger.info(f'DEBUG - Buscando publicacao {pk}...')
            publicacao = get_object_or_404(Publicacao, pk=pk)
            logger.info(f'SUCCESS - Publicacao encontrada: {publicacao.titulo}')
            logger.info(f'DEBUG - Criado por: {publicacao.criado_por}')
            
            # Verificar permiss√µes (apenas quem pode editar a publica√ß√£o)
            if not (request.user.is_superuser or publicacao.criado_por == request.user):
                logger.warning(f'‚ùå Usu√°rio {request.user} n√£o tem permiss√£o para indexar na publica√ß√£o {pk}')
                return JsonResponse({
                    'success': False,
                    'error': 'Voc√™ n√£o tem permiss√£o para indexar militares nesta publica√ß√£o'
                }, status=403)
            
            # Obter IDs dos militares do POST
            militares_ids = request.POST.getlist('militares_ids[]')
            logger.info(f'DEBUG - IDs dos militares recebidos: {militares_ids}')
            
            if not militares_ids:
                logger.warning('‚ö†Ô∏è Nenhum militar selecionado - limpando indexa√ß√µes anteriores')
                # Limpar indexa√ß√µes anteriores (permitir nota sem militares indexados)
                publicacao.militares_indexados.clear()
                logger.info('‚úÖ Indexa√ß√µes anteriores removidas - nota sem militares indexados')
                
                return JsonResponse({
                    'success': True,
                    'message': 'Indexa√ß√£o atualizada com sucesso! A nota ficou sem militares indexados.',
                    'militares_indexados': [],
                    'total_indexados': 0,
                    'publicacao_id': publicacao.id,
                    'publicacao_titulo': publicacao.titulo
                })
            
            # Validar se os militares existem
            logger.info(f'DEBUG - Validando existencia dos militares...')
            militares = Militar.objects.filter(id__in=militares_ids)
            logger.info(f'‚úÖ Militares encontrados: {militares.count()} de {len(militares_ids)}')
            
            if militares.count() != len(militares_ids):
                logger.error(f'‚ùå Alguns militares n√£o foram encontrados')
                return JsonResponse({
                    'success': False,
                    'error': 'Alguns militares selecionados n√£o foram encontrados'
                })
            
            # Limpar indexa√ß√µes anteriores e adicionar novas
            logger.info(f'DEBUG - Limpando indexacoes anteriores...')
            publicacao.militares_indexados.clear()
            logger.info(f'DEBUG - Adicionando novas indexacoes...')
            publicacao.militares_indexados.set(militares)
            logger.info(f'‚úÖ Indexa√ß√µes salvas com sucesso')
            
            # Buscar dados dos militares indexados para resposta
            militares_data = []
            for militar in militares:
                militares_data.append({
                    'id': militar.id,
                    'nome': militar.nome_completo,
                    'posto': militar.get_posto_graduacao_display(),
                    'matricula': militar.matricula
                })
            
            logger.info(f'‚úÖ Resposta preparada com {len(militares_data)} militares')
            
            return JsonResponse({
                'success': True,
                'message': f'Indexa√ß√£o salva com sucesso! {len(militares)} militar(es) indexado(s).',
                'militares_indexados': militares_data,
                'total_indexados': len(militares_data),
                'publicacao_id': publicacao.id,
                'publicacao_titulo': publicacao.titulo
            })
            
        except Exception as e:
            logger.error(f'‚ùå Erro ao salvar indexa√ß√£o: {str(e)}')
            logger.error(f'‚ùå Stack trace: {e.__traceback__}')
            return JsonResponse({
                'success': False,
                'error': f'Erro ao salvar indexa√ß√£o: {str(e)}'
            }, status=500)
    
    logger.warning(f'‚ùå M√©todo n√£o permitido: {request.method}')
    return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'}, status=405)

@login_required
def gerar_fichas_conceito_todos(request):
    """Gera fichas de conceito para todos os militares cadastrados que ainda n√£o possuem"""
    if request.method == 'POST':
        # Verificar se est√° sendo chamado da p√°gina de oficiais
        is_oficiais = request.POST.get('is_oficiais', False)
        
        if is_oficiais:
            # Filtrar apenas oficiais ativos
            militares_ativos = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            )
            tipo_militar = "oficiais"
        else:
            # Buscar todos os militares ativos
            militares_ativos = Militar.objects.filter(classificacao='ATIVO')
            tipo_militar = "militares"
        
        # Buscar militares que n√£o possuem ficha de conceito
        militares_sem_ficha = militares_ativos.exclude(
            Q(fichaconceitooficiais__isnull=False) | Q(fichaconceitopracas__isnull=False)
        )
        
        fichas_criadas = 0
        militares_processados = 0
        
        for militar in militares_sem_ficha:
            # Verificar se j√° existe ficha para este militar (dupla verifica√ß√£o)
            ficha_existente_oficiais = militar.fichaconceitooficiais_set.first()
            ficha_existente_pracas = militar.fichaconceitopracas_set.first()
            
            if not ficha_existente_oficiais and not ficha_existente_pracas:
                # Determinar qual tipo de ficha criar baseado no posto
                if militar.posto_graduacao in ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']:
                    # Criar ficha de oficiais
                    ficha = FichaConceitoOficiais.objects.create(
                        militar=militar,
                    )
                else:
                    # Criar ficha de pra√ßas
                    ficha = FichaConceitoPracas.objects.create(
                        militar=militar,
                    )
                fichas_criadas += 1
            
            militares_processados += 1
        
        # Mensagens informativas
        if fichas_criadas > 0:
            messages.success(request, f'‚úÖ Foram criadas {fichas_criadas} fichas de conceito com tempo de servi√ßo no posto para {tipo_militar} que n√£o possu√≠am.')
        else:
            messages.info(request, f'‚ÑπÔ∏è Todos os {tipo_militar} ativos j√° possuem fichas de conceito.')
        
        if militares_processados > 0:
            messages.info(request, f'üìä Processados {militares_processados} {tipo_militar} ativos.')
        
        # Informa√ß√£o adicional sobre militares que j√° tinham fichas
        militares_com_ficha = militares_ativos.count() - militares_sem_ficha.count()
        if militares_com_ficha > 0:
            messages.info(request, f'üîí {militares_com_ficha} {tipo_militar} j√° possu√≠am fichas de conceito e n√£o foram alterados.')
    
    return redirect('militares:ficha_conceito_list')

@login_required
@administracao_required
def limpar_pontos_fichas_conceito(request):
    """Limpa os pontos das fichas de conceito, mantendo apenas o tempo no posto"""
    if request.method == 'POST':
        # Verificar se est√° sendo chamado da p√°gina de oficiais
        is_oficiais = request.POST.get('is_oficiais', False)
        
        if is_oficiais:
            # Filtrar apenas fichas de oficiais
            oficiais = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
            )
            fichas = FichaConceitoOficiais.objects.filter(militar__in=oficiais)
            tipo_militar = "oficiais"
        else:
            # Buscar todas as fichas de conceito
            fichas_oficiais = FichaConceitoOficiais.objects.all()
            fichas_pracas = FichaConceitoPracas.objects.all()
            fichas = list(fichas_oficiais) + list(fichas_pracas)
            tipo_militar = "militares"
        
        fichas_limpas = 0
        
        for ficha in fichas:
            # Salvar o tempo no posto atual
            tempo_posto_atual = ficha.militar.tempo_posto_atual()
            
            # Atualizar diretamente no banco para evitar chamar o m√©todo save()
            if isinstance(ficha, FichaConceitoOficiais):
                FichaConceitoOficiais.objects.filter(pk=ficha.pk).update(
                    # Limpar todos os campos de pontos
                    cursos_especializacao=0,
                    cursos_csbm=0,
                    cursos_cfsd=0,
                    cursos_chc=0,
                    cursos_chsgt=0,
                    cursos_cas=0,
                    cursos_cho=0,
                    cursos_cfo=0,
                    cursos_cao=0,
                    cursos_instrutor_csbm=0,
                    cursos_civis_superior=0,
                    cursos_civis_especializacao=0,
                    cursos_civis_mestrado=0,
                    cursos_civis_doutorado=0,
                    medalha_federal=0,
                    medalha_estadual=0,
                    medalha_cbmepi=0,
                    elogio_individual=0,
                    elogio_coletivo=0,
                    punicao_repreensao=0,
                    punicao_detencao=0,
                    punicao_prisao=0,
                    falta_aproveitamento=0,
                    # Atualizar o tempo no posto para o valor atual
                    tempo_posto=tempo_posto_atual,
                    # Recalcular os pontos (apenas tempo no posto)
                    pontos=tempo_posto_atual * 1.0,  # 1.0 ponto por ano no posto
                )
            else:
                FichaConceitoPracas.objects.filter(pk=ficha.pk).update(
                    # Limpar todos os campos de pontos
                    cursos_especializacao=0,
                    cursos_csbm=0,
                    cursos_cfsd=0,
                    cursos_chc=0,
                    cursos_chsgt=0,
                    cursos_cas=0,
                    cursos_cho=0,
                    cursos_cfo=0,
                    cursos_cao=0,
                    cursos_instrutor_csbm=0,
                    cursos_civis_superior=0,
                    cursos_civis_especializacao=0,
                    cursos_civis_mestrado=0,
                    cursos_civis_doutorado=0,
                    medalha_federal=0,
                    medalha_estadual=0,
                    medalha_cbmepi=0,
                    elogio_individual=0,
                    elogio_coletivo=0,
                    punicao_repreensao=0,
                    punicao_detencao=0,
                    punicao_prisao=0,
                    falta_aproveitamento=0,
                    # Atualizar o tempo no posto para o valor atual
                    tempo_posto=tempo_posto_atual,
                    # Recalcular os pontos (apenas tempo no posto)
                    pontos=tempo_posto_atual * 1.0,  # 1.0 ponto por ano no posto
                )
            fichas_limpas += 1
        
        if fichas_limpas > 0:
            messages.success(request, f'‚úÖ Foram limpas {fichas_limpas} fichas de conceito de {tipo_militar}. Apenas o tempo no posto foi mantido.')
        else:
            messages.info(request, f'‚ÑπÔ∏è Nenhuma ficha de conceito de {tipo_militar} encontrada para limpeza.')
    
    return redirect('militares:ficha_conceito_list')

@login_required
@requer_perm_vagas_criar
def vaga_create(request):
    """Cria uma nova vaga"""
    if request.method == 'POST':
        posto = request.POST.get('posto')
        quadro = request.POST.get('quadro')
        efetivo_atual = request.POST.get('efetivo_atual')
        efetivo_maximo = request.POST.get('efetivo_maximo')
        if posto and quadro and efetivo_maximo:
            vaga = Vaga(
                posto=posto,
                quadro=quadro,
                efetivo_atual=efetivo_atual or 0,
                efetivo_maximo=efetivo_maximo
            )
            vaga.save()
            messages.success(request, 'Vaga criada com sucesso!')
            return redirect('militares:vaga_list')
        else:
            messages.error(request, 'Preencha todos os campos obrigat√≥rios.')
    # Para GET, exibe o mesmo modal, mas normalmente s√≥ √© chamado via POST
    return redirect('militares:vaga_list')

# Views para Previs√£o de Vagas
def previsao_vaga_list(request):
    """Lista todas as previs√µes de vagas organizadas por quadro"""
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    # Definir a hierarquia dos quadros
    hierarquia_quadros = {
        'COMB': 1,    # Combatente
        'SAUDE': 2,   # Sa√∫de
        'ENG': 3,     # Engenheiro
        'COMP': 4,    # Complementar
        'PRACAS': 5,  # Pra√ßas
    }
    
    # Buscar previs√µes de vagas ativas
    previsoes = list(PrevisaoVaga.objects.filter(ativo=True))
    
    # Calcular efetivo atual baseado nos militares cadastrados
    for previsao in previsoes:
        # Subtenentes est√£o cadastrados como COMP mas contam para PRACAS
        if previsao.posto == 'ST' and previsao.quadro == 'PRACAS':
            # Contar ST cadastrados como COMP (quadro de origem)
            efetivo_atual = Militar.objects.filter(
                posto_graduacao='ST',
                quadro='COMP',  # ST est√£o cadastrados como COMP
                classificacao='ATIVO'   # Apenas militares ativos
            ).count()
        else:
            # Para outros postos, contar normalmente
            efetivo_atual = Militar.objects.filter(
                posto_graduacao=previsao.posto,
                quadro=previsao.quadro,
                classificacao='ATIVO'  # Apenas militares ativos
            ).count()
        
        previsao.efetivo_atual = efetivo_atual
        previsao.save()  # Isso vai recalcular vagas_disponiveis automaticamente
    
    # Remover previs√µes de vaga de ST em quadros que n√£o sejam PRACAS
    previsoes = [p for p in previsoes if not (p.posto == 'ST' and p.quadro != 'PRACAS')]
    
    # Ordenar por quadro primeiro, depois por posto (hierarquia)
    previsoes_ordenadas = sorted(previsoes, key=lambda x: (
        hierarquia_quadros.get(x.quadro, 999),
        hierarquia_postos.get(x.posto, 999)
    ))
    
    # Calcular estat√≠sticas gerais
    total_efetivo_atual = sum(p.efetivo_atual for p in previsoes_ordenadas)
    total_efetivo_previsto = sum(p.efetivo_previsto for p in previsoes_ordenadas)
    total_vagas_disponiveis = sum(p.vagas_disponiveis for p in previsoes_ordenadas)
    
    context = {
        'previsoes': previsoes_ordenadas,
        'total_efetivo_atual': total_efetivo_atual,
        'total_efetivo_previsto': total_efetivo_previsto,
        'total_vagas_disponiveis': total_vagas_disponiveis,
    }
    
    return render(request, 'militares/previsao_vaga_list.html', context)

@login_required
@administracao_required
def previsao_vaga_manage(request):
    """Gerenciar previs√µes de vagas"""
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    # Definir a hierarquia dos quadros
    hierarquia_quadros = {
        'COMB': 1,    # Combatente
        'SAUDE': 2,   # Sa√∫de
        'ENG': 3,     # Engenheiro
        'COMP': 4,    # Complementar
        'PRACAS': 5,  # Pra√ßas
    }
    
    # Buscar todas as previs√µes de vagas
    previsoes = list(PrevisaoVaga.objects.all())
    
    # Filtrar apenas postos de pra√ßas no quadro de pra√ßas
    postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    previsoes = [p for p in previsoes if p.quadro != 'PRACAS' or p.posto in postos_pracas]
    
    # Ordenar por quadro primeiro, depois por posto (hierarquia)
    previsoes_ordenadas = sorted(previsoes, key=lambda x: (
        hierarquia_quadros.get(x.quadro, 999),
        hierarquia_postos.get(x.posto, 999)
    ))
    
    if request.method == 'POST':
        for previsao in previsoes_ordenadas:
            efetivo_atual = request.POST.get(f'efetivo_atual_{previsao.id}', '').strip()
            efetivo_previsto = request.POST.get(f'efetivo_previsto_{previsao.id}', '').strip()
            try:
                previsao.efetivo_atual = int(efetivo_atual) if efetivo_atual.isdigit() else 0
                previsao.efetivo_previsto = int(efetivo_previsto) if efetivo_previsto.isdigit() else 0
                previsao.save()
                # Recarregar o objeto do banco para verificar se o c√°lculo foi aplicado
                previsao.refresh_from_db()
                print(f"[DEBUG] PrevisaoVaga ID {previsao.id} | Atual: {previsao.efetivo_atual} | Previsto: {previsao.efetivo_previsto} | Vagas Dispon√≠veis: {previsao.vagas_disponiveis}")
            except Exception as e:
                messages.error(request, f'Erro ao salvar {previsao}: {e}')
        messages.success(request, 'Previs√µes de vagas atualizadas com sucesso!')
        return redirect('militares:previsao_vaga_manage')
    
    context = {
        'previsoes': previsoes_ordenadas,
        'quadros': QUADRO_CHOICES,
        'postos': POSTO_GRADUACAO_CHOICES,
    }
    return render(request, 'militares/previsao_vaga_manage.html', context)

@login_required
@administracao_required
def previsao_vaga_create(request):
    """Criar nova previs√£o de vaga"""
    if request.method == 'POST':
        quadro = request.POST.get('novo_quadro')
        posto = request.POST.get('novo_posto')
        efetivo_atual = request.POST.get('novo_efetivo_atual', '0')
        efetivo_previsto = request.POST.get('novo_efetivo_previsto', '0')
        
        try:
            # Verificar se j√° existe uma previs√£o para este quadro/posto
            if PrevisaoVaga.objects.filter(quadro=quadro, posto=posto).exists():
                messages.error(request, 'J√° existe uma previs√£o de vaga para este quadro e posto!')
            else:
                PrevisaoVaga.objects.create(
                    quadro=quadro,
                    posto=posto,
                    efetivo_atual=int(efetivo_atual),
                    efetivo_previsto=int(efetivo_previsto),
                    ativo=True
                )
                messages.success(request, 'Previs√£o de vaga criada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao criar previs√£o de vaga: {e}')
    
    return redirect('militares:previsao_vaga_manage')

@login_required
@administracao_required
def previsao_vaga_delete(request, pk):
    """Excluir previs√£o de vaga"""
    previsao = get_object_or_404(PrevisaoVaga, pk=pk)
    
    if request.method == 'POST':
        previsao.delete()
        messages.success(request, 'Previs√£o de vaga exclu√≠da com sucesso!')
        return redirect('militares:previsao_vaga_manage')
    
    context = {
        'previsao': previsao,
    }
    
    return render(request, 'militares/previsao_vaga_confirm_delete.html', context)

@login_required
@administracao_required
def previsao_vaga_delete_ajax(request, pk):
    """Excluir previs√£o de vaga via AJAX"""
    if request.method == 'POST':
        try:
            previsao = PrevisaoVaga.objects.get(pk=pk)
            previsao.delete()
            return JsonResponse({'success': True})
        except PrevisaoVaga.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Previs√£o de vaga n√£o encontrada'})
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'})

@login_required
@requer_perm_documentos_excluir
def documento_delete(request, pk):
    """Excluir documento"""
    try:
        documento = Documento.objects.get(pk=pk)
    except Documento.DoesNotExist:
        messages.error(request, f'Documento com ID {pk} n√£o encontrado. O documento pode ter sido exclu√≠do anteriormente ou o ID est√° incorreto.')
        # Redirecionar para a lista de militares se n√£o conseguir identificar o militar
        return redirect('militares:militar_list')
    
    if request.method == 'POST':
        nome_arquivo = documento.filename()
        militar_pk = documento.militar.pk
        documento.delete()
        messages.success(request, f'Documento "{nome_arquivo}" exclu√≠do com sucesso!')
        return redirect('militares:militar_detail', pk=militar_pk)
    
    context = {
        'documento': documento,
        'militar': documento.militar,
    }
    
    return render(request, 'militares/documento_confirm_delete.html', context)

@login_required
def assinar_documentos_quadro(request, pk):
    """P√°gina para assinar documentos de um quadro de acesso"""
    quadro = get_object_or_404(QuadroAcesso, pk=pk)
    
    # Buscar militares do quadro
    militares_quadro = []
    if quadro.status in ['ELABORADO', 'HOMOLOGADO']:
        militares_quadro = quadro.itemquadroacesso_set.all().order_by('posicao')
    
    # Buscar documentos pendentes de assinatura
    documentos_pendentes = Documento.objects.filter(
        militar__in=[item.militar for item in militares_quadro],
        status='PENDENTE'
    ).order_by('militar__nome_completo', 'data_upload')
    
    # Criar lista de documentos com informa√ß√µes do militar e posi√ß√£o
    documentos_com_info = []
    militares_sem_documentos = []
    
    for item in militares_quadro:
        documentos_militar = documentos_pendentes.filter(militar=item.militar)
        if documentos_militar.exists():
            for doc in documentos_militar:
                documentos_com_info.append({
                    'documento': doc,
                    'militar': item.militar,
                    'posicao': item.posicao,
                    'item_quadro': item
                })
        else:
            militares_sem_documentos.append(item)
    
    context = {
        'quadro': quadro,
        'militares_quadro': militares_quadro,
        'documentos_pendentes': documentos_pendentes,
        'documentos_com_info': documentos_com_info,
        'militares_sem_documentos': militares_sem_documentos,
        'total_documentos_pendentes': documentos_pendentes.count(),
    }
    
    return render(request, 'militares/assinar_documentos_quadro.html', context)

@login_required
def assinar_documento(request, pk):
    """Assinar documento com confirma√ß√£o de senha"""
    documento = get_object_or_404(Documento, pk=pk)
    
    # Buscar fun√ß√µes do usu√°rio para sele√ß√£o
    from militares.models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar').order_by('funcao_militar__nome')
    
    # Fun√ß√£o atual selecionada (da sess√£o ou primeira dispon√≠vel)
    funcao_atual = request.session.get('funcao_atual_nome', '')
    if not funcao_atual and funcoes_usuario.exists():
        funcao_atual = funcoes_usuario.first().funcao_militar.nome
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        observacoes = request.POST.get('observacoes_assinatura', '')
        funcao_assinatura = request.POST.get('funcao_assinatura', '')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'documento': documento,
                'militar': documento.militar,
                'funcoes_usuario': funcoes_usuario,
                'funcao_atual': funcao_atual,
            }
            return render(request, 'militares/assinar_documento.html', context)
        
        # Assinar o documento
        documento.status = 'ASSINADO'
        documento.assinado_por = request.user
        documento.data_assinatura = timezone.now()
        documento.observacoes_assinatura = observacoes
        documento.funcao_assinatura = funcao_assinatura
        documento.save()
        
        messages.success(request, f'Documento "{documento.titulo}" assinado com sucesso!')
        return redirect('militares:militar_detail', pk=documento.militar.pk)
    
    context = {
        'documento': documento,
        'militar': documento.militar,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
    }
    
    return render(request, 'militares/assinar_documento.html', context)

@login_required
def assinar_quadro_acesso(request, pk):
    """Assinar quadro de acesso com confirma√ß√£o de senha"""
    quadro = get_object_or_404(QuadroAcesso, pk=pk)
    
    # Buscar comiss√£o relacionada ao quadro
    if quadro.tipo in ['ANTIGUIDADE', 'MERECIMENTO']:
        comissao = ComissaoPromocao.get_comissao_ativa_por_tipo('CPO')
    else:
        comissao = ComissaoPromocao.get_comissao_ativa_por_tipo('CPP')
    membros_comissao = comissao.membros.filter(ativo=True).select_related('militar', 'usuario').order_by('tipo', 'militar__nome_completo') if comissao else []
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        observacoes = request.POST.get('observacoes', '')
        tipo_assinatura = request.POST.get('tipo_assinatura', 'APROVACAO')
        funcao_assinatura = request.POST.get('funcao_assinatura', '')
        membro_id = request.POST.get('membro_id')
        membro = membros_comissao.filter(id=membro_id).first() if membro_id else None
        
        # Verificar senha do usu√°rio selecionado
        if not membro or not membro.usuario or not membro.usuario.check_password(senha):
            messages.error(request, 'Senha incorreta ou membro inv√°lido. Tente novamente.')
            context = {
                'quadro': quadro,
                'membros_comissao': membros_comissao,
            }
            return render(request, 'militares/assinar_quadro_acesso.html', context)
        
        # Verificar se j√° existe uma assinatura deste membro para este tipo
        assinatura_existente = AssinaturaQuadroAcesso.objects.filter(
            quadro_acesso=quadro,
            assinado_por=membro.usuario,
            tipo_assinatura=tipo_assinatura
        ).first()
        
        if assinatura_existente:
            messages.error(request, f'Este membro j√° assinou este quadro como "{assinatura_existente.get_tipo_assinatura_display()}".')
            context = {
                'quadro': quadro,
                'membros_comissao': membros_comissao,
            }
            return render(request, 'militares/assinar_quadro_acesso.html', context)
        
        # Usar fun√ß√£o selecionada no formul√°rio ou obter fun√ß√£o atual do membro
        if funcao_assinatura:
            funcao_atual = funcao_assinatura
        else:
            # Obter fun√ß√£o atual do membro
            if membro.cargo:
                funcao_atual = f"{membro.get_tipo_display()} - {membro.cargo.nome}"
            else:
                funcao_atual = membro.get_tipo_display()
            
            # Se n√£o conseguir obter fun√ß√£o do membro, tentar buscar fun√ß√£o ativa do usu√°rio
            if not funcao_atual or funcao_atual == " - ":
                funcao_usuario = UsuarioFuncaoMilitar.objects.filter(
                    usuario=membro.usuario,
                    ativo=True
                ).first()
                
                if funcao_usuario:
                    funcao_atual = funcao_usuario.funcao_militar.nome
                else:
                    funcao_atual = "Usu√°rio do Sistema"
        
        # Criar a assinatura
        assinatura = AssinaturaQuadroAcesso.objects.create(
            quadro_acesso=quadro,
            assinado_por=membro.usuario,
            observacoes=observacoes,
            tipo_assinatura=tipo_assinatura,
            funcao_assinatura=funcao_atual
        )
        
        messages.success(request, f'Quadro de acesso assinado com sucesso como "{assinatura.get_tipo_assinatura_display()}"!')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    # Obter fun√ß√µes ativas do usu√°rio para o modal de assinatura
    from militares.models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar')
    
    # Obter fun√ß√£o atual do usu√°rio
    funcao_atual = None
    funcao_ativa = funcoes_usuario.filter(ativo=True).first()
    if funcao_ativa:
        funcao_atual = funcao_ativa.funcao_militar.nome
    
    context = {
        'quadro': quadro,
        'membros_comissao': membros_comissao,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
    }
    
    return render(request, 'militares/assinar_quadro_acesso.html', context)

@login_required
def retirar_assinatura_quadro_acesso(request, pk, assinatura_pk):
    """Retirar assinatura do quadro de acesso - apenas antes da homologa√ß√£o"""
    quadro = get_object_or_404(QuadroAcesso, pk=pk)
    assinatura = get_object_or_404(AssinaturaQuadroAcesso, pk=assinatura_pk, quadro_acesso=quadro)
    
    # Verificar se o quadro j√° foi homologado
    if quadro.status == 'HOMOLOGADO':
        messages.error(request, 'N√£o √© poss√≠vel retirar assinaturas de um quadro j√° homologado.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    # Verificar se o usu√°rio √© o autor da assinatura ou tem permiss√£o administrativa
    if assinatura.assinado_por != request.user and not request.user.is_superuser and not request.user.is_staff:
        messages.error(request, 'Voc√™ s√≥ pode retirar suas pr√≥prias assinaturas.')
        return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'quadro': quadro,
                'assinatura': assinatura,
            }
            return render(request, 'militares/retirar_assinatura_quadro_acesso.html', context)
        
        # Verificar se a assinatura √© de aprova√ß√£o e se h√° outras assinaturas de aprova√ß√£o
        if assinatura.tipo_assinatura == 'APROVACAO':
            outras_aprovacoes = quadro.assinaturas.filter(
                tipo_assinatura='APROVACAO'
            ).exclude(pk=assinatura.pk).count()
            
            if outras_aprovacoes == 0:
                # Se n√£o h√° outras aprova√ß√µes, voltar o status do quadro para EM_ELABORACAO
                quadro.status = 'EM_ELABORACAO'
                quadro.save()
        
        # Excluir a assinatura
        assinatura.delete()
        
        messages.success(request, f'Assinatura de "{assinatura.get_tipo_assinatura_display()}" retirada com sucesso!')
        
        # Redirecionar de volta para a p√°gina de onde veio
        next_url = request.GET.get('next')
        if next_url:
            return redirect(next_url)
        else:
            return redirect('militares:quadro_acesso_detail', pk=quadro.pk)
    
    context = {
        'quadro': quadro,
        'assinatura': assinatura,
    }
    
    return render(request, 'militares/retirar_assinatura_quadro_acesso.html', context)

# ============================================================================
# VIEWS DA COMISS√ÉO DE PROMO√á√ÉO DE OFICIAIS
# ============================================================================

@login_required
def comissao_list(request):
    """Lista todas as comiss√µes de promo√ß√£o de oficiais e pra√ßas com filtros hier√°rquicos"""
    from militares.permissoes_simples import tem_permissao
    from militares.filtros_hierarquicos_adicionais import aplicar_filtro_hierarquico_comissoes
    from militares.permissoes_hierarquicas import obter_funcao_militar_ativa
    from militares.models import UsuarioFuncaoMilitar
    
    # Obter fun√ß√£o militar ativa
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    # Aplicar filtros hier√°rquicos baseados no acesso da fun√ß√£o
    if request.user.is_superuser:
        comissoes = ComissaoPromocao.objects.all()
    elif funcao_usuario and tem_permissao(request.user, 'comissoes', 'visualizar'):
        # Aplicar filtro hier√°rquico primeiro
        comissoes = aplicar_filtro_hierarquico_comissoes(ComissaoPromocao.objects.all(), funcao_usuario, request.user)
        
        # Depois aplicar filtro por tipo de comiss√£o baseado na fun√ß√£o
        if funcao_usuario.funcao_militar:
            funcao = funcao_usuario.funcao_militar
            tipo_comissao = funcao.tipo_comissao
            
            if tipo_comissao == 'CPO':
                comissoes = comissoes.filter(tipo='CPO')
            elif tipo_comissao == 'CPP':
                comissoes = comissoes.filter(tipo='CPP')
            elif tipo_comissao == 'NENHUM':
                comissoes = ComissaoPromocao.objects.none()
    else:
        comissoes = ComissaoPromocao.objects.none()
        
        # Fallback para permiss√µes espec√≠ficas por tipo de comiss√£o (apenas se n√£o h√° fun√ß√£o militar)
        if not comissoes.exists():
            # Verificar permiss√£o para comiss√µes de oficiais
            if tem_permissao(request.user, 'comissoes_oficiais', 'visualizar'):
                comissoes_oficiais = ComissaoPromocao.objects.filter(tipo='CPO')
                comissoes = comissoes.union(comissoes_oficiais)
            
            # Verificar permiss√£o para comiss√µes de pra√ßas
            if tem_permissao(request.user, 'comissoes_pracas', 'visualizar'):
                comissoes_pracas = ComissaoPromocao.objects.filter(tipo='CPP')
                comissoes = comissoes.union(comissoes_pracas)
        
        # Fallback final para permiss√£o gen√©rica de comiss√µes
        if not comissoes.exists() and tem_permissao(request.user, 'comissoes', 'visualizar'):
            comissoes = ComissaoPromocao.objects.all()

    # Filtros
    status = request.GET.get('status')
    if status:
        comissoes = comissoes.filter(status=status)
    
    # Busca
    busca = request.GET.get('busca')
    if busca:
        comissoes = comissoes.filter(
            models.Q(nome__icontains=busca) |
            models.Q(observacoes__icontains=busca)
        )
    
    context = {
        'comissoes': comissoes,
        'status_choices': ComissaoPromocao.STATUS_CHOICES,
    }
    return render(request, 'militares/comissao/list.html', context)

@login_required
def comissao_detail(request, pk):
    """Detalhes de uma comiss√£o de promo√ß√£o de oficiais"""
    from militares.permissoes_simples import tem_permissao
    
    try:
        comissao = ComissaoPromocao.objects.get(pk=pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('comissao_list')
    
    # Verificar permiss√£o espec√≠fica por tipo de comiss√£o
    tem_permissao_visualizar = False
    if request.user.is_superuser or request.user.is_staff:
        tem_permissao_visualizar = True
    elif comissao.tipo == 'CPO' and tem_permissao(request.user, 'comissoes_oficiais', 'visualizar'):
        tem_permissao_visualizar = True
    elif comissao.tipo == 'CPP' and tem_permissao(request.user, 'comissoes_pracas', 'visualizar'):
        tem_permissao_visualizar = True
    elif tem_permissao(request.user, 'comissoes', 'visualizar'):
        tem_permissao_visualizar = True
    
    if not tem_permissao_visualizar:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar esta comiss√£o.')
        return redirect('militares:home')
    
    # Buscar quadros de acesso relacionados √† comiss√£o
    if comissao.tipo == 'CPO':
        # Para comiss√£o de oficiais, buscar quadros de oficiais
        quadros_acesso_base = QuadroAcesso.objects.filter(
            categoria='OFICIAIS'
        ).order_by('-data_promocao')
    else:
        # Para comiss√£o de pra√ßas, buscar quadros de pra√ßas
        quadros_acesso_base = QuadroAcesso.objects.filter(
            categoria='PRACAS'
        ).order_by('-data_promocao')
    
    # Aplicar slice para mostrar apenas os √∫ltimos 10 quadros
    quadros_acesso = quadros_acesso_base[:10]
    
    # Buscar quadros de fixa√ß√£o de vagas relacionados √† comiss√£o
    if comissao.tipo == 'CPO':
        # Para comiss√£o de oficiais, buscar quadros de oficiais
        quadros_fixacao_vagas = QuadroFixacaoVagas.objects.filter(
            tipo='OFICIAIS'
        ).order_by('-data_promocao')[:10]  # √öltimos 10 quadros
    else:
        # Para comiss√£o de pra√ßas, buscar quadros de pra√ßas
        quadros_fixacao_vagas = QuadroFixacaoVagas.objects.filter(
            tipo='PRACAS'
        ).order_by('-data_promocao')[:10]  # √öltimos 10 quadros
    
    # Buscar quadros de acesso por merecimento e suas fichas de conceito
    quadros_merecimento = quadros_acesso_base.filter(tipo='MERECIMENTO')
    fichas_conceito_merecimento = {}
    
    for quadro in quadros_merecimento:
        militares_quadro = []
        for item in quadro.itemquadroacesso_set.all().order_by('posicao'):
            militar = item.militar
            # Buscar ficha de conceito do militar
            if comissao.tipo == 'CPO':
                ficha = militar.fichaconceitooficiais_set.first()
            else:
                ficha = militar.fichaconceitopracas_set.first()
            
            if ficha:
                militares_quadro.append({
                    'militar': militar,
                    'ficha': ficha,
                    'posicao': item.posicao,
                    'pontuacao': item.pontuacao
                })
        
        if militares_quadro:
            fichas_conceito_merecimento[quadro] = militares_quadro
    
    # Buscar votos da comiss√£o
    votos_comissao = VotoDeliberacao.objects.filter(
        deliberacao__sessao__comissao=comissao
    ).select_related(
        'deliberacao__sessao',
        'membro__militar'
    ).order_by('-data_registro')[:10]  # √öltimos 10 votos
    
    # Calcular estat√≠sticas dos votos
    total_votos = VotoDeliberacao.objects.filter(deliberacao__sessao__comissao=comissao).count()
    votos_favor = VotoDeliberacao.objects.filter(deliberacao__sessao__comissao=comissao, voto='FAVOR').count()
    votos_contra = VotoDeliberacao.objects.filter(deliberacao__sessao__comissao=comissao, voto='CONTRA').count()
    votos_abstencao = VotoDeliberacao.objects.filter(deliberacao__sessao__comissao=comissao, voto='ABSTENCAO').count()
    
    context = {
        'comissao': comissao,
        'membros': comissao.membros.all(),
        'sessoes': comissao.sessoes.all()[:5],  # √öltimas 5 sess√µes
        'quadros_acesso': quadros_acesso,
        'quadros_fixacao_vagas': quadros_fixacao_vagas,
        'fichas_conceito_merecimento': fichas_conceito_merecimento,
        'votos_comissao': votos_comissao,
        'total_votos': total_votos,
        'votos_favor': votos_favor,
        'votos_contra': votos_contra,
        'votos_abstencao': votos_abstencao,
    }
    return render(request, 'militares/comissao/detail.html', context)

@login_required
def comissao_create(request):
    """Criar nova comiss√£o de promo√ß√£o de oficiais"""
    from militares.permissoes_simples import tem_permissao
    
    # Verificar permiss√£o gen√©rica para criar comiss√µes
    if not (request.user.is_superuser or request.user.is_staff or 
            tem_permissao(request.user, 'comissoes', 'criar')):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para criar comiss√µes.')
        return redirect('militares:home')
    
    if request.method == 'POST':
        form = ComissaoPromocaoForm(request.POST)
        if form.is_valid():
            nova_comissao = form.save(commit=False)
            # Inativar comiss√£o ativa do mesmo tipo
            comissao_ativa = ComissaoPromocao.objects.filter(tipo=nova_comissao.tipo, status='ATIVA').first()
            if comissao_ativa:
                comissao_ativa.status = 'INATIVA'
                comissao_ativa.save()
            nova_comissao.status = 'ATIVA'
            nova_comissao.save()
            messages.success(request, 'Comiss√£o criada com sucesso!')
            return redirect('militares:comissao_detail', pk=nova_comissao.pk)
    else:
        form = ComissaoPromocaoForm()
    context = {
        'form': form,
        'title': 'Nova Comiss√£o de Promo√ß√µes',
    }
    return render(request, 'militares/comissao/form.html', context)

@login_required
def comissao_update(request, pk):
    """Editar comiss√£o de promo√ß√£o de oficiais"""
    from militares.permissoes_simples import tem_permissao
    
    try:
        comissao = ComissaoPromocao.objects.get(pk=pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('comissao_list')
    
    # Verificar permiss√£o espec√≠fica por tipo de comiss√£o
    tem_permissao_editar = False
    if request.user.is_superuser or request.user.is_staff:
        tem_permissao_editar = True
    elif comissao.tipo == 'CPO' and tem_permissao(request.user, 'comissoes_oficiais', 'editar'):
        tem_permissao_editar = True
    elif comissao.tipo == 'CPP' and tem_permissao(request.user, 'comissoes_pracas', 'editar'):
        tem_permissao_editar = True
    elif tem_permissao(request.user, 'comissoes', 'editar'):
        tem_permissao_editar = True
    
    if not tem_permissao_editar:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar esta comiss√£o.')
        return redirect('militares:home')
    
    if request.method == 'POST':
        form = ComissaoPromocaoForm(request.POST, instance=comissao)
        if form.is_valid():
            form.save()
            messages.success(request, 'Comiss√£o atualizada com sucesso!')
            return redirect('militares:comissao_detail', pk=comissao.pk)
    else:
        form = ComissaoPromocaoForm(instance=comissao)
    
    context = {
        'form': form,
        'comissao': comissao,
        'title': 'Editar Comiss√£o de Promo√ß√£o de Oficiais',
    }
    return render(request, 'militares/comissao/form.html', context)

@login_required
def comissao_delete(request, pk):
    """Excluir comiss√£o de promo√ß√£o de oficiais"""
    try:
        comissao = ComissaoPromocao.objects.get(pk=pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar permiss√£o espec√≠fica por tipo de comiss√£o
    from militares.permissoes_simples import tem_permissao
    
    tem_permissao_excluir = False
    if request.user.is_superuser or request.user.is_staff:
        tem_permissao_excluir = True
    elif comissao.tipo == 'CPO' and tem_permissao(request.user, 'comissoes_oficiais', 'excluir'):
        tem_permissao_excluir = True
    elif comissao.tipo == 'CPP' and tem_permissao(request.user, 'comissoes_pracas', 'excluir'):
        tem_permissao_excluir = True
    elif tem_permissao(request.user, 'comissoes', 'excluir'):
        tem_permissao_excluir = True
    
    if not tem_permissao_excluir:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir esta comiss√£o.')
        return redirect('militares:home')
    
    # Verificar se a comiss√£o tem sess√µes
    if comissao.sessoes.exists():
        messages.error(request, 'N√£o √© poss√≠vel excluir uma comiss√£o que possui sess√µes. Apenas edi√ß√£o √© permitida.')
        return redirect('militares:comissao_detail', pk=pk)
    
    # Verificar se a comiss√£o tem membros
    if comissao.membros.exists():
        messages.error(request, 'N√£o √© poss√≠vel excluir uma comiss√£o que possui membros. Apenas edi√ß√£o √© permitida.')
        return redirect('militares:comissao_detail', pk=pk)
    
    if request.method == 'POST':
        comissao.delete()
        messages.success(request, 'Comiss√£o exclu√≠da com sucesso!')
        return redirect('militares:comissao_list')
    
    context = {
        'comissao': comissao,
    }
    return render(request, 'militares/comissao/delete.html', context)

@login_required
@comissao_acesso_total
def membro_comissao_list(request, comissao_pk):
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Definir a hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13, # Cabo
        'SD': 14,  # Soldado
    }
    
    # Buscar todos os membros da comiss√£o
    todos_membros = comissao.membros.select_related('militar', 'usuario').all()
    
    # Mostrar todos os membros da comiss√£o (sem filtro de fun√ß√µes)
    membros = list(todos_membros)
    
    # Para cada membro, buscar suas fun√ß√µes do grupo COMISSAO compat√≠veis com o tipo da comiss√£o
    for membro in membros:
        if membro.usuario:
            # Buscar fun√ß√µes do grupo COMISSAO compat√≠veis com o tipo da comiss√£o
            # Considerar todas as fun√ß√µes como ativas (sem filtro de ativo/inativo)
            funcoes_comissao = membro.usuario.funcoes_militares.filter(
                funcao_militar__grupo='COMISSAO'
            ).filter(
                funcao_militar__tipo_comissao__in=[comissao.tipo, 'AMBOS']
            ).select_related('funcao_militar')
            membro.funcoes_comissao = funcoes_comissao
        else:
            membro.funcoes_comissao = []
    
    # Ordenar por tipo primeiro, depois por hierarquia de posto
    membros.sort(key=lambda x: (
        x.tipo,  # Primeiro por tipo (EFETIVO, NATO, SUPLENTE)
        hierarquia_postos.get(x.militar.posto_graduacao, 999),  # Depois por hierarquia
        x.militar.nome_completo  # Por √∫ltimo por nome
    ))
    
    # Calcular contagens para estat√≠sticas usando list comprehension
    membros_ativos_count = sum(1 for membro in membros if membro.ativo)
    membros_com_usuario_count = sum(1 for membro in membros if membro.usuario is not None)
    membros_sem_usuario_count = sum(1 for membro in membros if membro.usuario is None)
    
    context = {
        'comissao': comissao,
        'membros': membros,
        'membros_ativos_count': membros_ativos_count,
        'membros_com_usuario_count': membros_com_usuario_count,
        'membros_sem_usuario_count': membros_sem_usuario_count,
        'title': 'Membros da Comiss√£o',
    }
    return render(request, 'militares/comissao/membros/list.html', context)

@login_required
@comissao_acesso_total
def sincronizar_membros_comissao(request, comissao_pk):
    """Sincroniza membros da comiss√£o baseado nas fun√ß√µes militares"""
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    if request.method == 'POST':
        # Executar sincroniza√ß√£o
        resultado = MembroComissao.sincronizar_membros_por_funcoes(comissao)
        
        if resultado['criados'] > 0 or resultado['atualizados'] > 0:
            messages.success(
                request, 
                f'Sincroniza√ß√£o conclu√≠da! {resultado["criados"]} membros criados, '
                f'{resultado["atualizados"]} membros atualizados.'
            )
        else:
            messages.info(request, 'Nenhum membro foi adicionado ou atualizado.')
        
        return redirect('militares:membro_comissao_list', comissao_pk=comissao.pk)
    
    # Buscar usu√°rios com fun√ß√µes espec√≠ficas para o tipo de comiss√£o
    funcoes = FuncaoMilitar.objects.filter(
        grupo='COMISSAO',
        tipo_comissao__in=[comissao.tipo, 'AMBOS'],
        ativo=True
    )
    
    # Buscar usu√°rios com essas fun√ß√µes
    usuarios_com_funcoes = UsuarioFuncaoMilitar.objects.filter(
        funcao_militar__in=funcoes,
        ativo=True
    ).select_related('usuario', 'usuario__militar', 'funcao_militar')
    
    # Filtrar usu√°rios que t√™m militar vinculado
    usuarios_validos = []
    for usuario_funcao in usuarios_com_funcoes:
        if hasattr(usuario_funcao.usuario, 'militar') and usuario_funcao.usuario.militar:
            usuarios_validos.append(usuario_funcao)
    
    context = {
        'comissao': comissao,
        'usuarios_com_funcoes': usuarios_validos,
        'funcoes': funcoes,
        'title': f'Sincronizar Membros - {comissao.nome}'
    }
    
    return render(request, 'militares/comissao/membros/sincronizar.html', context)

@login_required
@comissao_acesso_total
def membro_comissao_add(request, comissao_pk):
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar fun√ß√£o atual do usu√°rio
    funcao_atual_id = request.session.get('funcao_atual_id')
    if not funcao_atual_id:
        messages.error(request, 'Nenhuma fun√ß√£o selecionada. Selecione uma fun√ß√£o primeiro.')
        return redirect('militares:selecionar_funcao')
    
    try:
        funcao_atual = UsuarioFuncaoMilitar.objects.get(
            id=funcao_atual_id,
            usuario=request.user,
            ativo=True
        )
    except UsuarioFuncaoMilitar.DoesNotExist:
        messages.error(request, 'Fun√ß√£o atual n√£o encontrada ou inativa.')
        return redirect('militares:selecionar_funcao')
    
    if request.method == 'POST':
        form = MembroComissaoForm(request.POST, comissao_tipo=comissao.tipo)
        # Definir o valor do campo comissao antes da valida√ß√£o
        form.data = form.data.copy()
        form.data['comissao'] = comissao.id
        if form.is_valid():
            membro = form.save(commit=False)
            membro.comissao = comissao
            # Definir o usu√°rio automaticamente baseado no militar selecionado
            if membro.militar and membro.militar.user:
                membro.usuario = membro.militar.user
            
            # Definir o tipo automaticamente baseado na fun√ß√£o do militar
            # Buscar a fun√ß√£o de comiss√£o do militar
            funcao_comissao = UsuarioFuncaoMilitar.objects.filter(
                usuario=membro.militar.user,
                funcao_militar__grupo='COMISSAO',
                ativo=True
            ).first()
            
            if funcao_comissao:
                # Definir tipo baseado no nome da fun√ß√£o
                nome_funcao = funcao_comissao.funcao_militar.nome.upper()
                if 'PRESIDENTE' in nome_funcao:
                    membro.tipo = 'PRESIDENTE'
                elif 'SECRETARIO' in nome_funcao or 'SECRET√ÅRIO' in nome_funcao:
                    membro.tipo = 'SECRETARIO'
                elif 'NATO' in nome_funcao:
                    membro.tipo = 'NATO'
                else:
                    membro.tipo = 'EFETIVO'
                
                # Definir a fun√ß√£o militar
                membro.funcao_militar = funcao_comissao.funcao_militar

            # Verifica√ß√£o de duplicidade
            existe = MembroComissao.objects.filter(
                comissao=comissao,
                militar=membro.militar,
                tipo=membro.tipo
            ).exists()
            if existe:
                messages.error(request, 'J√° existe um membro com esse militar e tipo nesta comiss√£o!')
                return render(request, 'militares/comissao/membros/form.html', {
                    'form': form,
                    'comissao': comissao,
                    'funcao_atual': funcao_atual,
                    'title': 'Adicionar Membro',
                })

            try:
                membro.save()
                messages.success(request, 'Membro adicionado com sucesso!')
                return redirect('militares:membro_comissao_list', comissao_pk=comissao.pk)
            except IntegrityError:
                messages.error(request, 'J√° existe um membro com esse militar e tipo nesta comiss√£o!')
                return render(request, 'militares/comissao/membros/form.html', {
                    'form': form,
                    'comissao': comissao,
                    'funcao_atual': funcao_atual,
                    'title': 'Adicionar Membro',
                })
    else:
        form = MembroComissaoForm(comissao_tipo=comissao.tipo)
        # Definir o valor inicial do campo comissao
        form.initial['comissao'] = comissao.id
        
        # O campo militar agora √© um CharField que aceita IDs
        # A valida√ß√£o de posto ser√° feita no modelo
    
    # Buscar militares com fun√ß√µes de comiss√£o compat√≠veis com o tipo da comiss√£o
    print(f"DEBUG: Buscando militares com fun√ß√µes de comiss√£o para {comissao.tipo}...")
    
    # Buscar militares que tenham fun√ß√£o do grupo COMISSAO compat√≠vel com o tipo da comiss√£o (todas as fun√ß√µes consideradas ativas)
    militares_comissao = Militar.objects.filter(
        user__isnull=False,
        classificacao='ATIVO',
        user__is_active=True,
        user__funcoes_militares__funcao_militar__grupo='COMISSAO',
        user__funcoes_militares__funcao_militar__tipo_comissao__in=[comissao.tipo, 'AMBOS']
    ).distinct().order_by('nome_completo')
    print(f"DEBUG: Mostrando apenas militares com fun√ß√µes de COMISSAO")
    
    print(f"DEBUG: Encontrados {militares_comissao.count()} militares com fun√ß√µes de comiss√£o")
    for militar in militares_comissao[:5]:  # Mostrar apenas os primeiros 5
        print(f"DEBUG: - {militar.nome_completo} (ID: {militar.id})")
    
    context = {
        'form': form,
        'comissao': comissao,
        'funcao_atual': funcao_atual,
        'militares_comissao': militares_comissao,
        'title': 'Adicionar Membro',
    }
    return render(request, 'militares/comissao/membros/form.html', context)

@login_required
@comissao_acesso_total
def membro_comissao_update(request, comissao_pk, pk):
    """Editar membro da comiss√£o"""
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
        membro = MembroComissao.objects.get(pk=pk, comissao=comissao)
    except (ComissaoPromocao.DoesNotExist, MembroComissao.DoesNotExist):
        messages.error(request, 'Membro n√£o encontrado.')
        return redirect('militares:comissao_detail', pk=comissao_pk)
    
    # Verificar fun√ß√£o atual do usu√°rio
    funcao_atual_id = request.session.get('funcao_atual_id')
    if not funcao_atual_id:
        messages.error(request, 'Nenhuma fun√ß√£o selecionada. Selecione uma fun√ß√£o primeiro.')
        return redirect('militares:selecionar_funcao')
    
    try:
        funcao_atual = UsuarioFuncaoMilitar.objects.get(
            id=funcao_atual_id,
            usuario=request.user,
            ativo=True
        )
    except UsuarioFuncaoMilitar.DoesNotExist:
        messages.error(request, 'Fun√ß√£o atual n√£o encontrada ou inativa.')
        return redirect('militares:selecionar_funcao')
    
    if request.method == 'POST':
        form = MembroComissaoForm(request.POST, instance=membro, comissao_tipo=comissao.tipo)
        if form.is_valid():
            membro = form.save(commit=False)
            # Definir o usu√°rio automaticamente baseado no militar selecionado
            if membro.militar and membro.militar.user:
                membro.usuario = membro.militar.user

            # Verifica√ß√£o de duplicidade (excluindo o pr√≥prio membro sendo editado)
            tipo = form.cleaned_data.get('tipo')
            existe = MembroComissao.objects.filter(
                comissao=comissao,
                militar=membro.militar,
                tipo=tipo
            ).exclude(pk=membro.pk).exists()
            if existe:
                messages.error(request, 'J√° existe um membro com esse militar e tipo nesta comiss√£o!')
                return render(request, 'militares/comissao/membros/form.html', {
                    'form': form,
                    'comissao': comissao,
                    'membro': membro,
                    'funcao_atual': funcao_atual,
                    'title': 'Editar Membro da Comiss√£o',
                })

            try:
                membro.save()
                messages.success(request, 'Membro atualizado com sucesso!')
                return redirect('militares:membro_comissao_list', comissao_pk=comissao.pk)
            except IntegrityError:
                messages.error(request, 'J√° existe um membro com esse militar e tipo nesta comiss√£o!')
                return render(request, 'militares/comissao/membros/form.html', {
                    'form': form,
                    'comissao': comissao,
                    'membro': membro,
                    'funcao_atual': funcao_atual,
                    'title': 'Editar Membro da Comiss√£o',
                })
    else:
        form = MembroComissaoForm(instance=membro, comissao_tipo=comissao.tipo)
    
    # Buscar militares com fun√ß√µes de comiss√£o compat√≠veis com o tipo da comiss√£o (todas as fun√ß√µes consideradas ativas)
    militares_comissao = Militar.objects.filter(
        user__isnull=False,
        classificacao='ATIVO',
        user__is_active=True,
        user__funcoes_militares__funcao_militar__grupo='COMISSAO',
        user__funcoes_militares__funcao_militar__tipo_comissao__in=[comissao.tipo, 'AMBOS']
    ).distinct().order_by('nome_completo')
    
    context = {
        'form': form,
        'comissao': comissao,
        'membro': membro,
        'funcao_atual': funcao_atual,
        'militares_comissao': militares_comissao,
        'title': 'Editar Membro da Comiss√£o',
    }
    return render(request, 'militares/comissao/membros/form.html', context)

@login_required
@comissao_acesso_total
def membro_comissao_autocomplete(request):
    """View para autocomplete de militares com fun√ß√µes de comiss√£o"""
    query = request.GET.get('q', '')
    
    if len(query) < 2:
        return JsonResponse({'results': []})
    
    # Buscar militares que possuem fun√ß√µes do grupo COMISSAO
    # Nota: Esta view n√£o tem acesso ao tipo da comiss√£o, ent√£o mant√©m o filtro original
    militares = Militar.objects.filter(
        user__isnull=False,
        classificacao='ATIVO',
        user__is_active=True,
        user__funcoes_militares__funcao_militar__grupo='COMISSAO',
        nome_completo__icontains=query
    ).distinct().order_by('nome_completo')[:10]
    
    results = []
    for militar in militares:
        # Buscar fun√ß√µes do grupo COMISSAO para este militar
        funcoes_comissao = militar.user.funcoes_militares.filter(
            funcao_militar__grupo='COMISSAO'
        )
        funcoes_nomes = []
        for f in funcoes_comissao:
            status = "‚úì" if f.ativo else "‚úó"
            funcoes_nomes.append(f"{f.funcao_militar.nome} {status}")
        
        funcoes_text = f" ({', '.join(funcoes_nomes)})" if funcoes_nomes else ""
        
        results.append({
            'id': militar.id,
            'text': f"{militar.get_posto_graduacao_display()} {militar.nome_completo} - {militar.matricula}{funcoes_text}"
        })
    
    return JsonResponse({'results': results})

@login_required
@comissao_acesso_total
def membro_comissao_delete(request, comissao_pk, pk):
    """Remover membro da comiss√£o"""
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
        membro = MembroComissao.objects.get(pk=pk, comissao=comissao)
    except (ComissaoPromocao.DoesNotExist, MembroComissao.DoesNotExist):
        messages.error(request, 'Membro n√£o encontrado.')
        return redirect('militares:comissao_detail', pk=comissao_pk)
    
    if request.method == 'POST':
        membro.delete()
        messages.success(request, 'Membro removido com sucesso!')
        return redirect('militares:membro_comissao_list', comissao_pk=comissao.pk)
    
    context = {
        'comissao': comissao,
        'membro': membro,
    }
    return render(request, 'militares/comissao/membros/delete.html', context)

@login_required
@comissao_acesso_total
def sessao_comissao_list(request):
    """Lista sess√µes de uma comiss√£o"""
    comissao_pk = request.GET.get('comissao')
    if not comissao_pk:
        messages.error(request, 'Comiss√£o n√£o especificada.')
        return redirect('militares:comissao_list')
    
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    sessoes = comissao.sessoes.all()
    
    # Filtros
    status = request.GET.get('status')
    if status:
        sessoes = sessoes.filter(status=status)
    
    tipo = request.GET.get('tipo')
    if tipo:
        sessoes = sessoes.filter(tipo=tipo)
    
    context = {
        'comissao': comissao,
        'sessoes': sessoes,
        'status_choices': SessaoComissao.STATUS_CHOICES,
        'tipo_choices': SessaoComissao.TIPO_CHOICES,
    }
    return render(request, 'militares/comissao/sessoes/list.html', context)

@login_required
@comissao_acesso_total
def sessao_comissao_detail(request, pk):
    """Detalhes de uma sess√£o"""
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    user_membro = MembroComissao.objects.filter(
        comissao=comissao,
        usuario=request.user,
        ativo=True
    ).first()
    
    # Fun√ß√£o para normalizar texto
    def normalizar(texto):
        if not texto:
            return ''
        return unicodedata.normalize('NFKD', texto).encode('ASCII', 'ignore').decode('ASCII').upper()
    
    # Verificar se a pauta √© sobre aprova√ß√£o de quadro de acesso (singular/plural, ignorando acentos e case)
    pauta_aprovacao_quadro = False
    quadros_acesso_sessao = []
    pauta_normalizada = normalizar(sessao.pauta)
    if (
        'APROVACAO DE QUADRO DE ACESSO' in pauta_normalizada or
        'APROVACAO DE QUADROS DE ACESSO' in pauta_normalizada or
        'APROVACAO DE QUADROS DE ACESSOS' in pauta_normalizada
    ):
        pauta_aprovacao_quadro = True
        # Buscar quadros de acesso da comiss√£o espec√≠fica
        if comissao.tipo == 'CPO':
            quadros_acesso_sessao = QuadroAcesso.objects.filter(
                categoria='OFICIAIS',
                status__in=['ELABORADO', 'HOMOLOGADO', 'ASSINADO']
            ).order_by('-data_promocao')
        else:
            quadros_acesso_sessao = QuadroAcesso.objects.filter(
                categoria='PRACAS',
                status__in=['ELABORADO', 'HOMOLOGADO', 'ASSINADO']
            ).order_by('-data_promocao')
    
    context = {
        'comissao': comissao,
        'sessao': sessao,
        'presencas': sessao.presencas.all(),
        'deliberacoes': sessao.deliberacoes.all(),
        'user_membro': user_membro,
        'justificativas_encerramento': sessao.justificativas_encerramento.all(),
        'votos_sessao': VotoDeliberacao.objects.filter(deliberacao__sessao=sessao).select_related('membro__militar', 'deliberacao').order_by('deliberacao__numero', 'membro__militar__nome_completo'),
        'pauta_aprovacao_quadro': pauta_aprovacao_quadro,
        'quadros_acesso_sessao': quadros_acesso_sessao,
    }
    return render(request, 'militares/comissao/sessoes/detail.html', context)

@login_required
@comissao_acesso_total
def sessao_comissao_create(request):
    """Criar nova sess√£o"""
    comissao_pk = request.GET.get('comissao')
    if not comissao_pk:
        messages.error(request, 'Comiss√£o n√£o especificada.')
        return redirect('militares:comissao_list')
    
    try:
        comissao = ComissaoPromocao.objects.get(pk=comissao_pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    if request.method == 'POST':
        form = SessaoComissaoForm(request.POST, request.FILES)
        if form.is_valid():
            sessao = form.save(commit=False)
            sessao.comissao = comissao
            sessao.save()
            
            # Criar registros de presen√ßa para todos os membros
            for membro in comissao.membros.filter(ativo=True):
                PresencaSessao.objects.create(
                    sessao=sessao,
                    membro=membro,
                    presente=False
                )
            
            # Criar documento se fornecido
            documento_titulo = form.cleaned_data.get('documento_titulo')
            documento_tipo = form.cleaned_data.get('documento_tipo')
            documento_arquivo = form.cleaned_data.get('documento_arquivo')
            documento_descricao = form.cleaned_data.get('documento_descricao')
            
            if documento_titulo and documento_tipo and documento_arquivo:
                documento = DocumentoSessao.objects.create(
                    sessao=sessao,
                    tipo=documento_tipo,
                    titulo=documento_titulo,
                    descricao=documento_descricao,
                    arquivo=documento_arquivo,
                    upload_por=request.user
                )
                messages.success(request, f'Sess√£o criada com sucesso! Documento "{documento.titulo}" anexado.')
            else:
                messages.success(request, 'Sess√£o criada com sucesso!')
            
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    else:
        form = SessaoComissaoForm()
    
    context = {
        'form': form,
        'comissao': comissao,
        'title': 'Nova Sess√£o da Comiss√£o',
    }
    return render(request, 'militares/comissao/sessoes/form.html', context)

@login_required
@comissao_acesso_total
def sessao_comissao_update(request, pk):
    """Editar sess√£o"""
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    if request.method == 'POST':
        form = SessaoComissaoForm(request.POST, request.FILES, instance=sessao)
        if form.is_valid():
            try:
                # Salvar a sess√£o
                sessao_atualizada = form.save()
                
                # Processar documento se fornecido
                documento_titulo = form.cleaned_data.get('documento_titulo')
                documento_tipo = form.cleaned_data.get('documento_tipo')
                documento_arquivo = form.cleaned_data.get('documento_arquivo')
                documento_descricao = form.cleaned_data.get('documento_descricao')
                
                if documento_titulo and documento_tipo and documento_arquivo:
                    # Criar ou atualizar documento da sess√£o
                    documento_sessao, created = DocumentoSessao.objects.get_or_create(
                        sessao=sessao_atualizada,
                        defaults={
                            'tipo': documento_tipo,
                            'titulo': documento_titulo,
                            'descricao': documento_descricao or '',
                            'arquivo': documento_arquivo,
                            'upload_por': request.user,
                        }
                    )
                    
                    if not created:
                        # Atualizar documento existente
                        documento_sessao.tipo = documento_tipo
                        documento_sessao.titulo = documento_titulo
                        documento_sessao.descricao = documento_descricao or ''
                        documento_sessao.arquivo = documento_arquivo
                        documento_sessao.save()
                
                messages.success(request, 'Sess√£o atualizada com sucesso!')
                return redirect('militares:sessao_comissao_detail', pk=sessao_atualizada.pk)
            except Exception as e:
                messages.error(request, f'Erro ao salvar sess√£o: {str(e)}')
        else:
            # Log dos erros de valida√ß√£o para debug
            print("Erros de valida√ß√£o do formul√°rio:")
            for field, errors in form.errors.items():
                print(f"Campo {field}: {errors}")
            
            # Criar mensagem de erro mais espec√≠fica
            error_messages = []
            for field, errors in form.errors.items():
                field_name = form.fields[field].label if field in form.fields else field
                for error in errors:
                    error_messages.append(f"{field_name}: {error}")
            
            if error_messages:
                messages.error(request, f'Erro ao atualizar sess√£o: {"; ".join(error_messages)}')
            else:
                messages.error(request, 'Erro ao atualizar sess√£o. Verifique os dados informados.')
    else:
        form = SessaoComissaoForm(instance=sessao)
    
    context = {
        'form': form,
        'comissao': comissao,
        'sessao': sessao,
        'title': 'Editar Sess√£o da Comiss√£o',
    }
    return render(request, 'militares/comissao/sessoes/form.html', context)

@login_required
@comissao_acesso_total
def sessao_comissao_delete(request, pk):
    """Deletar sess√£o da comiss√£o"""
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar se a sess√£o pode ser deletada
    if sessao.status == 'CONCLUIDA':
        messages.error(request, 'N√£o √© poss√≠vel deletar uma sess√£o que j√° foi conclu√≠da.')
        return redirect(f'militares:sessao_comissao_list?comissao={comissao.pk}')
    
    # Verificar se h√° ata associada
    try:
        if sessao.ata_editada:
            messages.error(request, 'N√£o √© poss√≠vel deletar uma sess√£o que possui ata.')
            return redirect(f'militares:sessao_comissao_list?comissao={comissao.pk}')
    except:
        pass  # N√£o h√° ata associada
    
    if sessao.deliberacoes.exists():
        messages.error(request, 'N√£o √© poss√≠vel deletar uma sess√£o que possui delibera√ß√µes.')
        return redirect(f'/militares/comissao/sessoes/?comissao={comissao.pk}')
    
    if request.method == 'POST':
        sessao_numero = sessao.numero
        sessao.delete()
        messages.success(request, f'Sess√£o {sessao_numero} deletada com sucesso!')
        return redirect(f'/militares/comissao/sessoes/?comissao={comissao.pk}')
    
    context = {
        'sessao': sessao,
        'comissao': comissao,
    }
    return render(request, 'militares/comissao/sessoes/delete.html', context)

@login_required
def presenca_sessao_update(request, sessao_pk):
    """Atualizar presen√ßas de uma sess√£o"""
    try:
        sessao = SessaoComissao.objects.get(pk=sessao_pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    if request.method == 'POST':
        # Obter todos os membros da comiss√£o
        membros = comissao.membros.all()
        
        for membro in membros:
            # Verificar se o membro est√° presente
            presente = request.POST.get(f'presenca_{membro.pk}') == '1'
            
            # Obter ou criar presen√ßa
            presenca, created = PresencaSessao.objects.get_or_create(
                sessao=sessao,
                membro=membro,
                defaults={'presente': presente}
            )
            
            # Atualizar presen√ßa
            presenca.presente = presente
            presenca.save()
            
            # Debug: imprimir informa√ß√µes
            print(f"Membro: {membro.militar.nome_completo}, Presente: {presente}, POST data: {request.POST.get(f'presenca_{membro.pk}')}")
        
        # Debug: imprimir todos os dados POST
        print("POST data:", request.POST)
        print("Total de presen√ßas salvas:", sessao.presencas.filter(presente=True).count())
        
        messages.success(request, 'Presen√ßas atualizadas com sucesso!')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Obter membros da comiss√£o
    membros = comissao.membros.all()
    
    # Obter presen√ßas existentes
    presencas_existentes = set(sessao.presencas.filter(presente=True).values_list('membro_id', flat=True))
    
    context = {
        'comissao': comissao,
        'sessao': sessao,
        'membros': membros,
        'presencas_existentes': presencas_existentes,
    }
    return render(request, 'militares/comissao/sessoes/presenca_form.html', context)

@login_required
@comissao_acesso_total
def deliberacao_comissao_create(request):
    """Criar nova delibera√ß√£o"""
    sessao_pk = request.GET.get('sessao')
    resultado = request.GET.get('resultado')
    
    if not sessao_pk:
        messages.error(request, 'Sess√£o n√£o especificada.')
        return redirect('militares:comissao_list')
    
    try:
        sessao = SessaoComissao.objects.get(pk=sessao_pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Se o par√¢metro resultado estiver presente, redirecionar para a p√°gina de resultados
    if resultado:
        return redirect('militares:deliberacao_comissao_resultado', sessao_pk=sessao.pk)
    
    if request.method == 'POST':
        form = DeliberacaoComissaoForm(request.POST)
        if form.is_valid():
            deliberacao = form.save(commit=False)
            deliberacao.sessao = sessao
            deliberacao.save()
            
            messages.success(request, 'Delibera√ß√£o criada com sucesso!')
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    else:
        form = DeliberacaoComissaoForm()
    
    context = {
        'form': form,
        'comissao': comissao,
        'sessao': sessao,
        'title': 'Nova Delibera√ß√£o',
    }
    return render(request, 'militares/comissao/deliberacoes/form.html', context)

@login_required
@comissao_acesso_total
def deliberacao_comissao_update(request, pk):
    """Editar delibera√ß√£o"""
    try:
        deliberacao = DeliberacaoComissao.objects.get(pk=pk)
        sessao = deliberacao.sessao
        comissao = sessao.comissao
    except DeliberacaoComissao.DoesNotExist:
        messages.error(request, 'Delibera√ß√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    if request.method == 'POST':
        form = DeliberacaoComissaoForm(request.POST, instance=deliberacao)
        if form.is_valid():
            form.save()
            messages.success(request, 'Delibera√ß√£o atualizada com sucesso!')
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    else:
        form = DeliberacaoComissaoForm(instance=deliberacao)
    
    context = {
        'form': form,
        'comissao': comissao,
        'sessao': sessao,
        'deliberacao': deliberacao,
        'title': 'Editar Delibera√ß√£o',
    }
    return render(request, 'militares/comissao/deliberacoes/form.html', context)

@login_required
@comissao_acesso_total
def voto_deliberacao_create(request, deliberacao_pk):
    """Registrar voto do usu√°rio logado em uma delibera√ß√£o"""
    try:
        deliberacao = DeliberacaoComissao.objects.get(pk=deliberacao_pk)
        sessao = deliberacao.sessao
        comissao = sessao.comissao
    except DeliberacaoComissao.DoesNotExist:
        messages.error(request, 'Delibera√ß√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar se o usu√°rio logado √© membro da comiss√£o
    membro_usuario = MembroComissao.objects.filter(
        comissao=comissao,
        usuario=request.user,
        ativo=True
    ).first()
    
    if not membro_usuario:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar se o membro estava presente na sess√£o
    presenca = sessao.presencas.filter(membro=membro_usuario, presente=True).first()
    if not presenca:
        messages.error(request, 'Voc√™ n√£o estava presente nesta sess√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar se j√° votou
    voto_existente = deliberacao.votos.filter(membro=membro_usuario).first()
    
    if request.method == 'POST':
        # Verificar se a senha foi fornecida
        senha_votante = request.POST.get('senha_votante')
        if not senha_votante:
            messages.error(request, 'Senha √© obrigat√≥ria para confirmar o voto.')
            context = {
                'comissao': comissao,
                'sessao': sessao,
                'deliberacao': deliberacao,
                'membro_usuario': membro_usuario,
                'voto_existente': voto_existente,
            }
            return render(request, 'militares/comissao/deliberacoes/voto_form.html', context)
        
        # Validar senha do usu√°rio
        if not request.user.check_password(senha_votante):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'comissao': comissao,
                'sessao': sessao,
                'deliberacao': deliberacao,
                'membro_usuario': membro_usuario,
                'voto_existente': voto_existente,
            }
            return render(request, 'militares/comissao/deliberacoes/voto_form.html', context)
        
        # Obter dados do voto
        voto = request.POST.get('voto')
        voto_proferido = request.POST.get('voto_proferido', '')
        
        if not voto:
            messages.error(request, 'Voc√™ deve escolher uma op√ß√£o de voto.')
            context = {
                'comissao': comissao,
                'sessao': sessao,
                'deliberacao': deliberacao,
                'membro_usuario': membro_usuario,
                'voto_existente': voto_existente,
            }
            return render(request, 'militares/comissao/deliberacoes/voto_form.html', context)
        
        # Criar ou atualizar voto
        if voto_existente:
            voto_existente.voto = voto
            voto_existente.voto_proferido = voto_proferido
            voto_existente.save()
        else:
            voto_existente = VotoDeliberacao.objects.create(
                deliberacao=deliberacao,
                membro=membro_usuario,
                voto=voto,
                voto_proferido=voto_proferido
            )
        
        # Atualizar contadores da delibera√ß√£o
        votos_favor = deliberacao.votos.filter(voto='FAVOR').count()
        votos_contra = deliberacao.votos.filter(voto='CONTRA').count()
        votos_abstencao = deliberacao.votos.filter(voto='ABSTENCAO').count()
        
        deliberacao.votos_favor = votos_favor
        deliberacao.votos_contra = votos_contra
        deliberacao.votos_abstencao = votos_abstencao
        deliberacao.save()
        
        if voto_existente:
            messages.success(request, f'‚úÖ Voto atualizado com sucesso!')
        else:
            messages.success(request, f'‚úÖ Voto registrado com sucesso!')
        
        # Redirecionar de volta para o formul√°rio de voto para mostrar os dados atualizados
        return redirect('militares:voto_deliberacao_create', deliberacao_pk=deliberacao.pk)
    
    # Criar formul√°rio para o voto proferido com CKEditor
    
    class VotoProferidoForm(forms.Form):
        voto_proferido = forms.CharField(
            widget=forms.Textarea(
                attrs={
                    'placeholder': 'Digite aqui o texto do voto que voc√™ proferiu durante a sess√£o...',
                    'class': 'ckeditor5',
                    'data-config-name': 'voto_proferido_config'
                }
            ),
            required=False,
            label='Voto Proferido'
        )
    
    form = VotoProferidoForm(initial={
        'voto_proferido': voto_existente.voto_proferido if voto_existente else ''
    })
    
    context = {
        'comissao': comissao,
        'sessao': sessao,
        'deliberacao': deliberacao,
        'membro_usuario': membro_usuario,
        'voto_existente': voto_existente,
        'form': form,
    }
    return render(request, 'militares/comissao/deliberacoes/voto_form.html', context)

@login_required
def voto_deliberacao_editor_popup(request, deliberacao_pk):
    """Editor de voto em modal/popup similar ao editor de atas"""
    deliberacao = get_object_or_404(DeliberacaoComissao, pk=deliberacao_pk)
    sessao = deliberacao.sessao
    comissao = sessao.comissao
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro_usuario = MembroComissao.objects.filter(
        comissao=comissao,
        usuario=request.user,
        ativo=True
    ).first()
    
    if not membro_usuario:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:deliberacao_comissao_detail', pk=deliberacao.pk)
    
    # Verificar se j√° existe um voto para este membro
    voto_existente = VotoDeliberacao.objects.filter(
        deliberacao=deliberacao,
        membro=membro_usuario
    ).first()
    
    if request.method == 'POST':
        # Processar dados do formul√°rio
        voto = request.POST.get('voto')
        voto_proferido = request.POST.get('voto_proferido', '')
        senha_votante = request.POST.get('senha_votante')
        
        # Valida√ß√µes
        if not senha_votante:
            return JsonResponse({'success': False, 'error': 'Senha √© obrigat√≥ria para confirmar o voto.'})
        
        if not request.user.check_password(senha_votante):
            return JsonResponse({'success': False, 'error': 'Senha incorreta. Tente novamente.'})
        
        if not voto:
            return JsonResponse({'success': False, 'error': 'Voc√™ deve escolher uma op√ß√£o de voto.'})
        
        # Criar ou atualizar voto
        if voto_existente:
            voto_existente.voto = voto
            voto_existente.voto_proferido = voto_proferido
            voto_existente.save()
        else:
            voto_existente = VotoDeliberacao.objects.create(
                deliberacao=deliberacao,
                membro=membro_usuario,
                voto=voto,
                voto_proferido=voto_proferido
            )
        
        # Atualizar contadores da delibera√ß√£o
        votos_favor = deliberacao.votos.filter(voto='FAVOR').count()
        votos_contra = deliberacao.votos.filter(voto='CONTRA').count()
        votos_abstencao = deliberacao.votos.filter(voto='ABSTENCAO').count()
        
        deliberacao.votos_favor = votos_favor
        deliberacao.votos_contra = votos_contra
        deliberacao.votos_abstencao = votos_abstencao
        deliberacao.save()
        
        return JsonResponse({
            'success': True, 
            'message': 'Voto salvo com sucesso!',
            'voto_id': voto_existente.pk,
            'redirect_url': f'/militares/meus-votos/{voto_existente.pk}/visualizar/'
        })
    
    # Preparar dados para o template
    context = {
        'deliberacao': deliberacao,
        'sessao': sessao,
        'comissao': comissao,
        'membro_usuario': membro_usuario,
        'voto_existente': voto_existente,
    }
    
    return render(request, 'militares/comissao/deliberacoes/voto_editor_popup.html', context)

@login_required
def comissao_pdf(request, pk):
    """Gerar PDF da comiss√£o de promo√ß√£o de oficiais"""
    from reportlab.platypus import SimpleDocTemplate, Image, Spacer, Paragraph
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    
    try:
        comissao = ComissaoPromocao.objects.get(pk=pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('comissao_list')
    
    # Criar o PDF
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'inline; filename="comissao_promocao_{pk}.pdf"'
    
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()
    
    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    
    story = []
    
    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        f"{comissao.get_tipo_display().upper()} - CBMEPI-PI",
        "Av. Miguel Rosa, 3515 Terreo - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # Informa√ß√µes da comiss√£o
    story.append(Paragraph(f"<b>Nome:</b> {comissao.nome}", style_bold))
    story.append(Spacer(1, 6))
    story.append(Paragraph(f"<b>Data de Cria√ß√£o:</b> {comissao.data_criacao.strftime('%d/%m/%Y')}", style_bold))
    story.append(Spacer(1, 6))
    story.append(Paragraph(f"<b>Status:</b> {comissao.get_status_display()}", style_bold))
    story.append(Spacer(1, 6))
    
    if comissao.data_termino:
        story.append(Paragraph(f"<b>Data de T√©rmino:</b> {comissao.data_termino.strftime('%d/%m/%Y')}", style_bold))
        story.append(Spacer(1, 6))
    
    story.append(Spacer(1, 12))
    
    # Obter todos os membros ativos ordenados por tipo (presidente, membros, secret√°rio)
    membros_ativos = comissao.membros.filter(ativo=True).order_by(
        'tipo'  # PRESIDENTE, EFETIVO, NATO, SECRETARIO
    )
    
    # Presidente
    presidente = membros_ativos.filter(tipo='PRESIDENTE').first()
    if presidente:
        story.append(Paragraph("<b>PRESIDENTE:</b>", style_bold))
        story.append(Paragraph(f"{presidente.militar.get_posto_graduacao_display()} {presidente.militar.get_quadro_display()} {presidente.militar.nome_completo} - {presidente.cargo.nome}", style_center))
        story.append(Spacer(1, 8))
    
    # Membros Natos
    membros_natos = membros_ativos.filter(tipo='NATO')
    if membros_natos:
        story.append(Paragraph("<b>MEMBROS NATOS:</b>", style_bold))
        for membro in membros_natos:
            story.append(Paragraph(f"{membro.militar.get_posto_graduacao_display()} {membro.militar.get_quadro_display()} {membro.militar.nome_completo} - {membro.cargo.nome}", style_center))
        story.append(Spacer(1, 8))
    
    # Membros Efetivos
    membros_efetivos = membros_ativos.filter(tipo='EFETIVO')
    if membros_efetivos:
        story.append(Paragraph("<b>MEMBROS EFETIVOS:</b>", style_bold))
        for membro in membros_efetivos:
            story.append(Paragraph(f"{membro.militar.get_posto_graduacao_display()} {membro.militar.get_quadro_display()} {membro.militar.nome_completo} - {membro.cargo.nome}", style_center))
        story.append(Spacer(1, 8))
    
    # Secret√°rio
    secretario = membros_ativos.filter(tipo='SECRETARIO').first()
    if secretario:
        story.append(Paragraph("<b>SECRET√ÅRIO:</b>", style_bold))
        story.append(Paragraph(f"{secretario.militar.get_posto_graduacao_display()} {secretario.militar.get_quadro_display()} {secretario.militar.nome_completo} - {secretario.cargo.nome}", style_center))
        story.append(Spacer(1, 8))
    
    # Observa√ß√µes
    if comissao.observacoes:
        story.append(Spacer(1, 12))
        story.append(Paragraph("<b>OBSERVA√á√ïES:</b>", style_bold))
        story.append(Paragraph(comissao.observacoes, style_center))
    
    # Gerar o PDF
    doc.build(story)
    pdf = buffer.getvalue()
    buffer.close()
    
    response.write(pdf)
    return response

@login_required
def comissao_encerrar(request, pk):
    try:
        comissao = ComissaoPromocao.objects.get(pk=pk)
    except ComissaoPromocao.DoesNotExist:
        messages.error(request, 'Comiss√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    if comissao.status == 'INATIVA':
        messages.info(request, 'Esta comiss√£o j√° est√° inativa.')
    else:
        comissao.status = 'INATIVA'
        comissao.save()
        messages.success(request, 'Comiss√£o encerrada com sucesso!')
    return redirect('militares:comissao_list')

@login_required
def documento_sessao_create(request):
    """Upload de documento para uma sess√£o"""
    sessao_pk = request.GET.get('sessao')
    if not sessao_pk:
        messages.error(request, 'Sess√£o n√£o especificada.')
        return redirect('militares:sessao_comissao_list')
    
    try:
        sessao = SessaoComissao.objects.get(pk=sessao_pk)
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:sessao_comissao_list')
    
    if request.method == 'POST':
        form = DocumentoSessaoForm(request.POST, request.FILES)
        if form.is_valid():
            documento = form.save(commit=False)
            documento.sessao = sessao
            documento.upload_por = request.user
            documento.save()
            messages.success(request, f'Documento "{documento.titulo}" enviado com sucesso!')
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
        else:
            messages.error(request, 'Erro ao enviar documento. Verifique os dados.')
    else:
        form = DocumentoSessaoForm()
    
    context = {
        'form': form,
        'sessao': sessao,
        'title': 'Enviar Documento',
        'action': 'create',
    }
    
    return render(request, 'militares/comissao/documentos/form.html', context)

@login_required
def documento_sessao_update(request, pk):
    """Editar documento da sess√£o"""
    documento = get_object_or_404(DocumentoSessao, pk=pk)
    
    if request.method == 'POST':
        form = DocumentoSessaoForm(request.POST, request.FILES, instance=documento)
        if form.is_valid():
            form.save()
            messages.success(request, f'Documento "{documento.titulo}" atualizado com sucesso!')
            return redirect('militares:sessao_comissao_detail', pk=documento.sessao.pk)
        else:
            messages.error(request, 'Erro ao atualizar documento. Verifique os dados.')
    else:
        form = DocumentoSessaoForm(instance=documento)
    
    context = {
        'form': form,
        'documento': documento,
        'sessao': documento.sessao,
        'title': 'Editar Documento',
        'action': 'update',
    }
    
    return render(request, 'militares/comissao/documentos/form.html', context)

@login_required
@administracao_required
def documento_sessao_delete(request, pk):
    """Excluir documento da sess√£o (apenas administradores do sistema)"""
    documento = get_object_or_404(DocumentoSessao, pk=pk)
    sessao_pk = documento.sessao.pk
    titulo = documento.titulo
    
    if request.method == 'POST':
        documento.delete()
        messages.success(request, f'Documento "{titulo}" exclu√≠do com sucesso!')
        return redirect('militares:sessao_comissao_detail', pk=sessao_pk)
    
    context = {
        'documento': documento,
        'sessao': documento.sessao,
    }
    return render(request, 'militares/comissao/documentos/delete.html', context)

@login_required
def documento_sessao_view(request, pk):
    """Visualizar documento da sess√£o"""
    documento = get_object_or_404(DocumentoSessao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    try:
        membro = MembroComissao.objects.get(
            comissao=documento.sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        # Verificar se o usu√°rio √© membro mas n√£o est√° ativo
        try:
            membro_inativo = MembroComissao.objects.get(
                comissao=documento.sessao.comissao,
                usuario=request.user
            )
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este documento. Seu cadastro na comiss√£o n√£o est√° ativo.')
        except MembroComissao.DoesNotExist:
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este documento. Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=documento.sessao.pk)
    
    context = {
        'documento': documento,
        'sessao': documento.sessao,
    }
    
    if documento.can_preview():
        return render(request, 'militares/comissao/documentos/view.html', context)
    else:
        # Para arquivos que n√£o podem ser visualizados, fazer download
        import os
        if os.path.exists(documento.arquivo.path):
            return FileResponse(open(documento.arquivo.path, 'rb'), content_type='application/octet-stream')
        else:
            messages.error(request, 'Arquivo n√£o encontrado.')
            return redirect('militares:sessao_comissao_detail', pk=documento.sessao.pk)

@login_required
def documento_sessao_download(request, pk):
    """Download de documento da sess√£o"""
    documento = get_object_or_404(DocumentoSessao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=documento.sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        # Verificar se o usu√°rio √© membro mas n√£o est√° ativo
        membro_inativo = MembroComissao.objects.filter(
            comissao=documento.sessao.comissao,
            usuario=request.user
        ).first()
        if membro_inativo:
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para baixar este documento. Seu cadastro na comiss√£o n√£o est√° ativo.')
        else:
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para baixar este documento. Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=documento.sessao.pk)
    
    import os
    if os.path.exists(documento.arquivo.path):
        response = FileResponse(open(documento.arquivo.path, 'rb'))
        response['Content-Disposition'] = f'attachment; filename="{documento.filename()}"'
        return response
    else:
        messages.error(request, 'Arquivo n√£o encontrado.')
        return redirect('militares:sessao_comissao_detail', pk=documento.sessao.pk)

@login_required
def sessao_encerrar(request, pk):
    """Encerrar sess√£o com confirma√ß√£o de senha"""
    sessao = get_object_or_404(SessaoComissao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar se todos os presentes (exceto presidente) votaram
    todos_votaram = sessao.todos_presentes_votaram_exceto_presidente
    
    # Se n√£o todos votaram, apenas o secret√°rio pode encerrar
    if not todos_votaram and membro.cargo != 'SECRETARIO':
        messages.error(request, 'Apenas o secret√°rio pode encerrar a sess√£o quando nem todos os membros votaram.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar membros presentes que n√£o votaram (excluindo o presidente)
    membros_sem_voto = []
    for presenca in sessao.presencas.filter(presente=True):
        membro_presenca = presenca.membro
        # O presidente n√£o √© obrigado a votar
        if membro_presenca.cargo == 'PRESIDENTE':
            continue
            
        votos_do_membro = VotoDeliberacao.objects.filter(
            deliberacao__sessao=sessao,
            membro=membro_presenca
        ).count()
        if votos_do_membro < sessao.deliberacoes.count():
            membros_sem_voto.append({
                'membro': membro_presenca,
                'votos_realizados': votos_do_membro,
                'total_deliberacoes': sessao.deliberacoes.count(),
                'deliberacoes_nao_votadas': sessao.deliberacoes.count() - votos_do_membro
            })
    
    if request.method == 'POST':
        password = request.POST.get('password')
        if not password:
            messages.error(request, 'Senha √© obrigat√≥ria para encerrar a sess√£o.')
            return render(request, 'militares/comissao/sessoes/encerrar_confirmacao.html', {
                'sessao': sessao,
                'comissao': sessao.comissao,
                'membros_sem_voto': membros_sem_voto,
                'todos_votaram': todos_votaram,
                'membro_usuario': membro
            })
        
        if not request.user.check_password(password):
            messages.error(request, 'Senha incorreta. Sess√£o n√£o foi encerrada.')
            return render(request, 'militares/comissao/sessoes/encerrar_confirmacao.html', {
                'sessao': sessao,
                'comissao': sessao.comissao,
                'membros_sem_voto': membros_sem_voto,
                'todos_votaram': todos_votaram,
                'membro_usuario': membro
            })
        
        # Coletar justificativas para membros sem voto (apenas se secret√°rio e nem todos votaram)
        justificativas = {}
        if membro.cargo == 'SECRETARIO' and membros_sem_voto:
            for membro_info in membros_sem_voto:
                membro_id = membro_info['membro'].id
                justificativa = request.POST.get(f'justificativa_{membro_id}', '').strip()
                if justificativa:
                    justificativas[membro_id] = justificativa
        
        # Encerrar a sess√£o
        sessao.status = 'CONCLUIDA'
        sessao.hora_fim = timezone.now().time()
        sessao.save()
        
        # Salvar justificativas se houver
        if justificativas:
            
            justificativas_salvas = []
            for membro_info in membros_sem_voto:
                membro_id = membro_info['membro'].id
                if membro_id in justificativas:
                    # Salvar justificativa no modelo
                    justificativa_obj, created = JustificativaEncerramento.objects.get_or_create(
                        sessao=sessao,
                        membro=membro_info['membro'],
                        defaults={
                            'justificativa': justificativas[membro_id],
                            'registrado_por': request.user
                        }
                    )
                    
                    if not created:
                        # Atualizar justificativa existente
                        justificativa_obj.justificativa = justificativas[membro_id]
                        justificativa_obj.registrado_por = request.user
                        justificativa_obj.save()
                    
                    justificativas_salvas.append(
                        f"{membro_info['membro'].militar.nome_completo}: {justificativas[membro_id]}"
                    )
            
            if justificativas_salvas:
                messages.success(request, f'Sess√£o {sessao.numero} encerrada com sucesso! {len(justificativas_salvas)} justificativa(s) registrada(s).')
        else:
            messages.success(request, f'Sess√£o {sessao.numero} encerrada com sucesso!')
        
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Buscar votos da sess√£o para o modal de sele√ß√£o
    votos_sessao = VotoDeliberacao.objects.filter(
        deliberacao__sessao=sessao
    ).select_related('membro__militar', 'membro__cargo', 'deliberacao').order_by('deliberacao__numero', 'membro__militar__nome_completo')
    
    return render(request, 'militares/comissao/sessoes/encerrar_confirmacao.html', {
        'sessao': sessao,
        'comissao': sessao.comissao,
        'membros_sem_voto': membros_sem_voto,
        'todos_votaram': todos_votaram,
        'membro_usuario': membro,
        'votos_sessao': votos_sessao
    })

@login_required
def sessao_gerar_ata(request, pk):
    """Gerar ata da sess√£o da comiss√£o"""
    sessao = get_object_or_404(SessaoComissao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar se existe uma ata editada
    try:
        ata_editada = sessao.ata_editada
        tem_conteudo_editado = ata_editada and ata_editada.conteudo
    except:
        ata_editada = None
        tem_conteudo_editado = False
    
    # Preparar dados para a ata
    context = {
        'sessao': sessao,
        'comissao': sessao.comissao,
        'presencas': sessao.presencas.all(),
        'deliberacoes': sessao.deliberacoes.all().order_by('numero'),
        'membro_usuario': membro,
        'justificativas_encerramento': sessao.justificativas_encerramento.all(),
        'data_geracao': timezone.now(),
        'ata_editada': ata_editada,
        'tem_conteudo_editado': tem_conteudo_editado,
    }
    
    # Adicionar dados para assinaturas (se houver ata editada)
    if ata_editada:
        # Buscar fun√ß√µes do usu√°rio para o modal de assinatura
        from militares.models import UsuarioFuncaoMilitar
        funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
            usuario=request.user,
            ativo=True
        ).order_by('funcao_militar__nome')
        
        context.update({
            'funcoes_usuario': funcoes_usuario,
            'funcao_atual': request.session.get('funcao_atual_nome', 'Usu√°rio do Sistema'),
        })
    
    return render(request, 'militares/comissao/sessoes/ata.html', context)

@login_required
def sessao_editar_ata(request, pk):
    """Editar ata da sess√£o com editor de texto rico"""
    sessao = get_object_or_404(SessaoComissao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Preparar dados para a ata
    context = {
        'sessao': sessao,
        'comissao': sessao.comissao,
        'presencas': sessao.presencas.all(),
        'deliberacoes': sessao.deliberacoes.all().order_by('numero'),
        'membro_usuario': membro,
        'justificativas_encerramento': sessao.justificativas_encerramento.all(),
        'data_geracao': timezone.now(),
    }
    
    try:
        ata = sessao.ata_editada
    except AtaSessao.DoesNotExist:
        ata = AtaSessao(sessao=sessao, editado_por=request.user)
    
    # Se for uma requisi√ß√£o AJAX, retornar JSON
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        if request.method == 'POST':
            print(f"DEBUG: Recebendo POST AJAX - dados: {request.POST}")
            form = AtaSessaoForm(request.POST, instance=ata)
            print(f"DEBUG: Form v√°lido: {form.is_valid()}")
            if form.is_valid():
                ata = form.save(commit=False)
                ata.editado_por = request.user
                # Limpar assinaturas eletr√¥nicas ao editar a ata
                ata.assinaturas.all().delete()
                ata.save()
                print(f"DEBUG: Ata salva com sucesso - vers√£o: {ata.versao}")
                return JsonResponse({
                    'success': True,
                    'message': f'Ata salva com sucesso! Vers√£o {ata.versao}. As assinaturas eletr√¥nicas foram removidas.',
                    'versao': ata.versao
                })
            else:
                print(f"DEBUG: Erros no formul√°rio: {form.errors}")
                return JsonResponse({
                    'success': False,
                    'errors': form.errors
                })
        else:
            return JsonResponse({
                'success': False,
                'errors': {'__all__': ['M√©todo n√£o permitido']}
            })
    
    # Processamento normal (n√£o-AJAX)
    if request.method == 'POST':
        form = AtaSessaoForm(request.POST, instance=ata)
        if form.is_valid():
            ata = form.save(commit=False)
            ata.editado_por = request.user
            # Limpar assinaturas eletr√¥nicas ao editar a ata
            ata.assinaturas.all().delete()
            ata.save()
            messages.success(request, f'Ata editada e salva com sucesso! Vers√£o {ata.versao}. As assinaturas eletr√¥nicas foram removidas e ser√° necess√°rio assinar novamente.')
            return redirect('militares:sessao_editar_ata', pk=sessao.pk)
    else:
        form = AtaSessaoForm(instance=ata)
    
    context['form'] = form
    context['ata_salva'] = ata if ata.pk else None
    
    return render(request, 'militares/comissao/sessoes/editar_ata.html', context)

@login_required
def ata_conteudo_ajax(request, pk):
    """Retornar conte√∫do da ata via AJAX"""
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
        
        # Verificar se o usu√°rio √© membro da comiss√£o
        membro = MembroComissao.objects.filter(
            comissao=ata.sessao.comissao,
            usuario=request.user,
            ativo=True
        ).first()
        
        if not membro:
            return JsonResponse({
                'success': False,
                'error': 'Voc√™ n√£o √© membro desta comiss√£o.'
            })
        
        return JsonResponse({
            'success': True,
            'conteudo': ata.conteudo or '',
            'sessao_numero': ata.sessao.numero,
            'data_sessao': ata.sessao.data_sessao.strftime('%d/%m/%Y'),
            'hora_sessao': ata.sessao.hora_inicio.strftime('%H:%M'),
            'local_sessao': ata.sessao.local,
            'versao': ata.versao,
            'editado_por': ata.editado_por.get_full_name() or ata.editado_por.username,
            'data_edicao': ata.data_edicao.strftime('%d/%m/%Y %H:%M')
        })
        
    except AtaSessao.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Ata n√£o encontrada.'
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': f'Erro ao carregar ata: {str(e)}'
        })

@login_required
def sessao_editar_ata_popup(request, pk):
    """Editar ata da sess√£o em p√°gina separada/popup"""
    sessao = get_object_or_404(SessaoComissao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Preparar dados para a ata
    context = {
        'sessao': sessao,
        'comissao': sessao.comissao,
        'presencas': sessao.presencas.all(),
        'deliberacoes': sessao.deliberacoes.all().order_by('numero'),
        'membro_usuario': membro,
        'justificativas_encerramento': sessao.justificativas_encerramento.all(),
        'data_geracao': timezone.now(),
    }
    
    try:
        ata = sessao.ata_editada
    except AtaSessao.DoesNotExist:
        ata = AtaSessao(sessao=sessao, editado_por=request.user)
    
    if request.method == 'POST':
        form = AtaSessaoForm(request.POST, instance=ata)
        if form.is_valid():
            ata = form.save(commit=False)
            ata.editado_por = request.user
            ata.save()
            messages.success(request, f'Ata editada e salva com sucesso! Vers√£o {ata.versao}.')
            return redirect('militares:sessao_editar_ata_popup', pk=sessao.pk)
    else:
        form = AtaSessaoForm(instance=ata)
    
    context['form'] = form
    context['ata_salva'] = ata if ata.pk else None
    
    # Se for uma requisi√ß√£o AJAX, retornar JSON
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        if form.is_valid():
            ata = form.save(commit=False)
            ata.editado_por = request.user
            ata.assinaturas.all().delete()
            ata.save()
            return JsonResponse({
                'success': True,
                'message': f'Ata salva com sucesso! Vers√£o {ata.versao}.',
                'versao': ata.versao
            })
        else:
            return JsonResponse({
                'success': False,
                'errors': form.errors
            })
    
    return render(request, 'militares/comissao/sessoes/editar_ata_popup.html', context)

@login_required
def ata_para_assinatura(request, pk):
    """Marcar ata para assinatura dos membros"""
    
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
    except AtaSessao.DoesNotExist:
        messages.error(request, 'Ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    try:
        membro = MembroComissao.objects.get(
            comissao=ata.sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    if request.method == 'POST':
        ata.status = 'PARA_ASSINATURA'
        ata.save()
        messages.success(request, 'Ata marcada para assinatura dos membros.')
        return redirect('militares:ata_assinaturas', pk=pk)
    
    context = {
        'ata': ata,
        'sessao': ata.sessao,
        'comissao': ata.sessao.comissao,
        'membros_presentes': ata.sessao.presencas.filter(presente=True),
    }
    return render(request, 'militares/comissao/sessoes/ata_para_assinatura.html', context)

@login_required
def ata_assinaturas(request, pk):
    """Gerenciar assinaturas da ata"""
    
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
    except AtaSessao.DoesNotExist:
        messages.error(request, 'Ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    try:
        membro = MembroComissao.objects.get(
            comissao=ata.sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    if request.method == 'POST':
        # Processar assinatura
        membro_id = request.POST.get('membro_id')
        observacoes = request.POST.get('observacoes', '').strip()
        
        if membro_id:
            try:
                membro_para_assinar = MembroComissao.objects.get(id=membro_id)
                # Verificar se o membro estava presente
                if not ata.sessao.presencas.filter(membro=membro_para_assinar, presente=True).exists():
                    messages.error(request, 'Apenas membros presentes podem assinar a ata.')
                    return redirect('militares:ata_assinaturas', pk=pk)
                
                # Criar ou atualizar assinatura
                assinatura, created = AssinaturaAta.objects.get_or_create(
                    ata=ata,
                    membro=membro_para_assinar,
                    defaults={
                        'assinado_por': request.user,
                        'observacoes': observacoes
                    }
                )
                
                if not created:
                    assinatura.assinado_por = request.user
                    assinatura.observacoes = observacoes
                    assinatura.save()
                
                messages.success(request, f'Assinatura de {membro_para_assinar.militar.nome_completo} registrada com sucesso!')
                
                # Verificar se todos assinaram
                if ata.pode_ser_finalizada():
                    ata.status = 'ASSINADA'
                    ata.save()
                    messages.info(request, 'Todos os membros presentes assinaram a ata!')
                
            except MembroComissao.DoesNotExist:
                messages.error(request, 'Membro n√£o encontrado.')
    
    # Obter membros presentes e suas assinaturas
    membros_presentes = ata.sessao.presencas.filter(presente=True).select_related('membro__militar')
    assinaturas = ata.assinaturas.select_related('membro__militar', 'assinado_por')
    
    context = {
        'ata': ata,
        'sessao': ata.sessao,
        'comissao': ata.sessao.comissao,
        'membros_presentes': membros_presentes,
        'assinaturas': assinaturas,
        'membro_usuario': membro,
    }
    return render(request, 'militares/comissao/sessoes/ata_assinaturas.html', context)

@login_required
def ata_gerar_pdf(request, pk):
    """Gerar PDF da ata finalizada"""
    from reportlab.lib.pagesizes import A4
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.lib.enums import TA_JUSTIFY
    from io import BytesIO
    import html2text
    import os
    import qrcode
    
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
    except AtaSessao.DoesNotExist:
        messages.error(request, 'Ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Permitir gerar PDF para qualquer status da ata
    # if ata.status != 'ASSINADA' and ata.status != 'FINALIZADA':
    #     messages.error(request, 'A ata deve estar assinada para gerar o PDF.')
    #     return redirect('militares:ata_assinaturas', pk=pk)
    
    # Criar o PDF
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()
    
    # Configurar fonte para suportar caracteres especiais
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont
    
    # Registrar fonte que suporta UTF-8 (usando fonte padr√£o do sistema)
    try:
        # Tentar usar fonte Arial que suporta caracteres especiais
        pdfmetrics.registerFont(TTFont('Arial', 'arial.ttf'))
        font_name = 'Arial'
    except:
        # Se n√£o conseguir, usar fonte padr√£o
        font_name = 'Helvetica'
    
    # Estilos customizados com fonte que suporta UTF-8
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11, fontName=font_name)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName=font_name, fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1, fontName=font_name)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8, fontName=font_name)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9, fontName=font_name)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11, spaceAfter=8, fontName=font_name)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6, fontName=font_name)
    
    # Estilos para cabe√ßalho institucional (padr√£o do sistema)
    style_header = ParagraphStyle('header', parent=styles['Heading1'], fontSize=12, alignment=1, spaceAfter=8, spaceBefore=12, fontName=font_name)
    style_subheader = ParagraphStyle('subheader', parent=styles['Heading2'], fontSize=11, alignment=1, spaceAfter=6, spaceBefore=10, fontName=font_name)
    
    # Novos estilos para formata√ß√£o avan√ßada
    style_heading1 = ParagraphStyle('heading1', parent=styles['Heading1'], fontSize=12, spaceAfter=8, spaceBefore=12, fontName=font_name)
    style_heading2 = ParagraphStyle('heading2', parent=styles['Heading2'], fontSize=11, spaceAfter=6, spaceBefore=10, fontName=font_name)
    style_heading3 = ParagraphStyle('heading3', parent=styles['Heading3'], fontSize=10, spaceAfter=4, spaceBefore=8, fontName=font_name)
    style_paragraph = ParagraphStyle('paragraph', parent=styles['Normal'], fontSize=10, spaceAfter=6, alignment=4, firstLineIndent=20, fontName=font_name)
    style_list_item = ParagraphStyle('list_item', parent=styles['Normal'], fontSize=10, spaceAfter=4, leftIndent=20, firstLineIndent=-10, fontName=font_name)
    style_quote = ParagraphStyle('quote', parent=styles['Normal'], fontSize=10, spaceAfter=6, leftIndent=30, rightIndent=30, fontName=font_name)
    
    story = []
    
    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Cabe√ßalho institucional (igual aos quadros)
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
    ]
    
    # Determinar o tipo de comiss√£o baseado no campo tipo
    if ata.sessao.comissao.tipo == 'CPO':
        tipo_comissao = "COMISS√ÉO DE PROMO√á√ïES DE OFICIAIS - CBMEPI-PI"
    else:
        tipo_comissao = "COMISS√ÉO DE PROMO√á√ïES DE PRA√áAS - CBMEPI-PI"
    
    cabecalho.extend([
        tipo_comissao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ])
    
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))
    
    # T√≠tulo centralizado e sublinhado (mesma visualiza√ß√£o do HTML)
    if ata.sessao.comissao.tipo == 'CPO':
        tipo_comissao = "ATA DA REUNI√ÉO DA COMISS√ÉO DE PROMO√á√ÉO DE OFICIAIS DO CBMEPI"
    elif ata.sessao.comissao.tipo == 'CPP':
        tipo_comissao = "ATA DA REUNI√ÉO DA COMISS√ÉO DE PROMO√á√ÉO DE PRA√áAS DO CBMEPI"
    else:
        tipo_comissao = "ATA DA REUNI√ÉO DA COMISS√ÉO DE PROMO√á√ÉO DO CBMEPI"
    
    titulo = f'<u>{tipo_comissao}</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 56.7))  # 2cm de espa√ßamento ap√≥s o t√≠tulo
    
    # Conte√∫do da ata (mantendo HTML do CKEditor, mas limpo para ReportLab)
    style_html = ParagraphStyle('html', parent=styles['Normal'], fontSize=11, alignment=TA_JUSTIFY, spaceAfter=8, leading=16, fontName=font_name)
    conteudo_limpo = clean_html_for_reportlab(ata.conteudo)
    
    try:
        story.append(Paragraph(conteudo_limpo, style_html))
    except Exception as e:
        # Se houver erro no parsing do HTML, tentar com texto simples
        print(f"Erro ao processar HTML da ata: {str(e)}")
        # Remover todas as tags HTML e usar apenas texto
        import re
        texto_simples = re.sub(r'<[^>]+>', '', ata.conteudo or '')
        texto_simples = unescape(texto_simples)
        story.append(Paragraph(texto_simples, style_html))
    story.append(Spacer(1, 40))
    
    # Data da sess√£o centralizada ap√≥s o conte√∫do (sistema autom√°tico)
    if ata.sessao.data_sessao:
        # Converter data para extenso
        from datetime import datetime
        data_sessao = ata.sessao.data_sessao
        
        # Mapeamento de meses
        meses = {
            1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
            5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
            9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
        }
        
        dia = data_sessao.day
        mes = meses[data_sessao.month]
        ano = data_sessao.year
        
        # Formatar data por extenso
        data_extenso = f"Teresina, {dia} de {mes} de {ano}"
        story.append(Paragraph(f"<center><b>{data_extenso}</b></center>", style_center))
    story.append(Spacer(1, 30))
    
    # Assinaturas manuais
    story.append(Spacer(1, 15))
    
    assinaturas = ata.assinaturas.select_related('membro__militar').order_by('data_assinatura')
    for assinatura in assinaturas:
        # Fun√ß√£o para obter a abrevia√ß√£o correta do quadro
        def get_quadro_abreviado(quadro):
            if quadro == 'Complementar':
                return 'QOBM/C'
            elif quadro == 'Combatente':
                return 'QOBM/Comb.'
            elif quadro == 'Engenheiro':
                return 'QOBM/E'
            elif quadro == 'Sa√∫de':
                return 'QOBM/S'
            else:
                return quadro
        
        # Nome, posto e quadro na mesma linha
        quadro_abreviado = get_quadro_abreviado(assinatura.membro.militar.get_quadro_display())
        nome_posto_quadro = f"{assinatura.membro.militar.nome_completo} - {assinatura.membro.militar.get_posto_graduacao_display()} {quadro_abreviado}"
        story.append(Paragraph(f"<center>{nome_posto_quadro}</center>", style_center))
        
        # Tipo de membro e fun√ß√£o
        tipo_membro = assinatura.membro.get_tipo_display()
        cargo_membro = assinatura.membro.cargo.nome if assinatura.membro.cargo else ""
        if cargo_membro:
            story.append(Paragraph(f"<center>{tipo_membro} - {cargo_membro}</center>", style_center))
        else:
            story.append(Paragraph(f"<center>{tipo_membro}</center>", style_center))
        
        if assinatura.observacoes:
            story.append(Paragraph(f"Obs: {assinatura.observacoes}", style_signature))
        story.append(Spacer(1, 10))
    
    # Rodap√© com Assinaturas Eletr√¥nicas e QR Code
    story.append(Spacer(1, 40))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Buscar todas as assinaturas v√°lidas da ata (da mais recente para a mais antiga)
    assinaturas_eletronicas = ata.assinaturas.filter(assinado_por__isnull=False).order_by('-data_assinatura')
    
    if assinaturas_eletronicas.exists():
        for i, assinatura_eletronica in enumerate(assinaturas_eletronicas):
            # Informa√ß√µes de assinatura eletr√¥nica
            nome_assinante = assinatura_eletronica.assinado_por.get_full_name() or assinatura_eletronica.assinado_por.username
            # Se o nome estiver vazio, usar um nome padr√£o
            if not nome_assinante or nome_assinante.strip() == '':
                nome_assinante = "Usu√°rio do Sistema"
            
            from .utils import formatar_data_assinatura
            data_formatada, hora_formatada = formatar_data_assinatura(assinatura_eletronica.data_assinatura)
            
            # Fun√ß√£o para obter a abrevia√ß√£o correta do quadro
            def get_quadro_abreviado(quadro):
                if quadro == 'Complementar':
                    return 'QOBM/C'
                elif quadro == 'Combatente':
                    return 'QOBM/Comb.'
                elif quadro == 'Engenheiro':
                    return 'QOBM/E'
                elif quadro == 'Sa√∫de':
                    return 'QOBM/S'
                else:
                    return quadro
            
            # Nome, posto e quadro do militar
            quadro_abreviado = get_quadro_abreviado(assinatura_eletronica.membro.militar.get_quadro_display())
            nome_posto_quadro = f"{assinatura_eletronica.membro.militar.nome_completo} - {assinatura_eletronica.membro.militar.get_posto_graduacao_display()} {quadro_abreviado}"
            
            # Obter a fun√ß√£o da assinatura (que foi capturada durante a assinatura)
            funcao_atual = assinatura_eletronica.funcao_assinatura or 'Usu√°rio do Sistema'
            
            texto_assinatura = (
                f"Documento assinado eletronicamente por {nome_posto_quadro}, em {data_formatada} {hora_formatada}, "
                f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
            )
            
            # Tabela das assinaturas: Logo + Texto de assinatura
            from .utils import obter_caminho_assinatura_eletronica
            assinatura_data = [
                [Image(obter_caminho_assinatura_eletronica(), width=2.5*cm, height=1.8*cm), Paragraph(texto_assinatura, style_small)]
            ]
            
            assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
            assinatura_table.setStyle(TableStyle([
                ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
                ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
                ('LEFTPADDING', (0, 0), (-1, -1), 6),
                ('RIGHTPADDING', (0, 0), (-1, -1), 6),
                ('TOPPADDING', (0, 0), (-1, -1), 6),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
            ]))
            
            story.append(assinatura_table)
            
            # Espa√ßamento entre assinaturas (exceto na √∫ltima)
            if i < len(assinaturas_eletronicas) - 1:
                story.append(Spacer(1, 12))
        
        # Mostrar apenas documento gerado pelo usu√°rio logado
        agora = timezone.localtime(timezone.now())
        nome_usuario = request.user.get_full_name() or request.user.username
        if not nome_usuario or nome_usuario.strip() == '':
            nome_usuario = "Usu√°rio do Sistema"
        data_formatada = agora.strftime('%d/%m/%Y')
        hora_formatada = agora.strftime('%H:%M')
        texto_geracao = f"Documento gerado pelo usu√°rio {nome_usuario} em {data_formatada}, √†s {hora_formatada}."
        story.append(Paragraph(texto_geracao, style_small))
    
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(ata, request, tipo_documento='ata')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 1),
        ('RIGHTPADDING', (0, 0), (-1, -1), 1),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
    ]))
    
    story.append(rodape_table)
    
    # Gerar PDF
    doc.build(story)
    buffer.seek(0)
    
    # Criar resposta HTTP
    response = HttpResponse(buffer.getvalue(), content_type='application/pdf')
    response['Content-Disposition'] = f'inline; filename="ata_sessao_{ata.sessao.numero}.pdf"'
    
    return response

@login_required
def ata_finalizar(request, pk):
    """Finalizar ata ap√≥s todas as assinaturas"""
    
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
    except AtaSessao.DoesNotExist:
        messages.error(request, 'Ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    try:
        membro = MembroComissao.objects.get(
            comissao=ata.sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    if request.method == 'POST':
        if ata.pode_ser_finalizada():
            ata.status = 'FINALIZADA'
            ata.data_finalizacao = timezone.now()
            ata.save()
            messages.success(request, 'Ata finalizada com sucesso! Agora voc√™ pode gerar o PDF.')
        else:
            messages.error(request, 'A ata n√£o pode ser finalizada. Todos os membros presentes devem assinar primeiro.')
    
    return redirect('militares:ata_assinaturas', pk=pk)

def clean_html_for_reportlab(html):
    if not html:
        return ""
    
    # Decodifica entidades HTML primeiro
    html = unescape(html)
    
    # Remove coment√°rios HTML
    html = re.sub(r'<!--.*?-->', '', html, flags=re.DOTALL)
    
    # Remove atributos style, id, class, target, etc.
    html = re.sub(r'(<\w+)([^>]*)(style|id|class|target|rel|onclick|onmouseover|onmouseout|align|width|height|data-[^=]*)=["\"][^"\"]*["\"]', r'\1', html)
    
    # Remove todos os atributos de todas as tags, exceto href em <a>
    html = re.sub(r'<(?!a\b)(\w+)[^>]*>', r'<\1>', html)
    
    # Remove atributos de <a> exceto href
    html = re.sub(r'<a\s+[^>]*?href=(["\"][^"\"]*["\"])[^>]*>', r'<a href=\1>', html)
    
    # Remove tags n√£o suportadas (mant√©m apenas p, b, i, u, br, a, ul, ol, li, strong, em)
    html = re.sub(r'</?(?!p\b|b\b|i\b|u\b|br\b|a\b|ul\b|ol\b|li\b|strong\b|em\b)[a-zA-Z0-9]+[^>]*>', '', html)
    
    # Corrigir tags <br> n√£o fechadas - substituir por <br/>
    html = re.sub(r'<br\s*>', '<br/>', html)
    html = re.sub(r'<br\s+[^>]*>', '<br/>', html)
    
    # Corrigir tags <br> com fechamento incorreto
    html = re.sub(r'<br\s*></br>', '<br/>', html)
    
    # Remove espa√ßos extras entre tags
    html = re.sub(r'>\s+<', '><', html)
    
    # Remove espa√ßos em branco no in√≠cio e fim
    html = html.strip()
    
    return html

@login_required
def modelo_ata_list(request):
    print(f"=== IN√çCIO modelo_ata_list ===")
    print(f"GET params: {request.GET}")
    print(f"Headers: {dict(request.headers)}")
    
    modelos = ModeloAta.objects.all()
    tipo_comissao = request.GET.get('tipo_comissao')
    if tipo_comissao:
        modelos = modelos.filter(tipo_comissao=tipo_comissao)
    tipo_sessao = request.GET.get('tipo_sessao')
    if tipo_sessao:
        modelos = modelos.filter(tipo_sessao=tipo_sessao)
    ativo = request.GET.get('ativo')
    if ativo is not None:
        modelos = modelos.filter(ativo=ativo == 'true')
    padrao = request.GET.get('padrao')
    if padrao is not None:
        modelos = modelos.filter(padrao=padrao == 'true')
    
    print(f"Modelos encontrados: {modelos.count()}")
    
    context = {
        'modelos': modelos,
        'tipos_comissao': ModeloAta.TIPO_COMISSAO_CHOICES,
        'tipos_sessao': ModeloAta.TIPO_SESSAO_CHOICES,
        'filtros': {
            'tipo_comissao': tipo_comissao,
            'tipo_sessao': tipo_sessao,
            'ativo': ativo,
            'padrao': padrao,
        }
    }
    
    # Verificar se √© uma requisi√ß√£o para JSON
    format_json = request.GET.get('format') == 'json'
    ajax_request = request.GET.get('ajax') == '1'
    
    print(f"Format JSON: {format_json}")
    print(f"Ajax Request: {ajax_request}")
    
    if format_json or ajax_request:
        print("=== RETORNANDO JSON ===")
        modelos_data = []
        for modelo in modelos:
            modelos_data.append({
                'id': modelo.pk,
                'nome': modelo.nome,
                'descricao': modelo.descricao,
                'tipo_comissao': modelo.tipo_comissao,
                'tipo_comissao_display': modelo.get_tipo_comissao_display(),
                'tipo_sessao': modelo.tipo_sessao,
                'tipo_sessao_display': modelo.get_tipo_sessao_display(),
                'ativo': modelo.ativo,
                'padrao': modelo.padrao,
                'criado_por': modelo.criado_por.get_full_name() if modelo.criado_por else modelo.criado_por.username,
                'data_criacao': modelo.data_criacao.strftime('%d/%m/%Y %H:%M') if modelo.data_criacao else '',
            })
        
        response_data = {
            'success': True,
            'modelos': modelos_data
        }
        print(f"Response data: {response_data}")
        return JsonResponse(response_data)
    
    print("=== RETORNANDO HTML ===")
    return render(request, 'militares/modelo_ata/list.html', context)

@login_required
def modelo_ata_create(request):
    if request.method == 'POST':
        form = ModeloAtaForm(request.POST)
        if form.is_valid():
            modelo = form.save(commit=False)
            modelo.criado_por = request.user
            modelo.save()
            messages.success(request, f'Modelo "{modelo.nome}" criado com sucesso!')
            return redirect('militares:modelo_ata_list')
    else:
        form = ModeloAtaForm()
    context = {
        'form': form,
        'titulo': 'Criar Novo Modelo de Ata',
        'variaveis_disponiveis': [
            '{{sessao.numero}} - N√∫mero da sess√£o',
            '{{sessao.data_sessao}} - Data da sess√£o',
            '{{sessao.hora_inicio}} - Hora de in√≠cio',
            '{{sessao.hora_fim}} - Hora de t√©rmino',
            '{{sessao.local}} - Local da sess√£o',
            '{{sessao.tipo}} - Tipo da sess√£o',
            '{{sessao.pauta}} - Pauta da sess√£o',
            '{{comissao.nome}} - Nome da comiss√£o',
            '{{comissao.tipo}} - Tipo da comiss√£o',
        ]
    }
    return render(request, 'militares/modelo_ata/form.html', context)

@login_required
def modelo_ata_update(request, pk):
    print(f"=== IN√çCIO modelo_ata_update ===")
    print(f"PK: {pk}")
    print(f"M√©todo: {request.method}")
    print(f"Headers: {dict(request.headers)}")
    
    modelo = get_object_or_404(ModeloAta, pk=pk)
    print(f"Modelo encontrado: {modelo.nome}")
    
    # Verificar se √© uma requisi√ß√£o AJAX
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    print(f"√â AJAX: {is_ajax}")
    
    if request.method == 'POST':
        print("=== PROCESSANDO POST ===")
        print(f"POST data: {request.POST}")
        
        try:
            # Obter dados do formul√°rio
            nome = request.POST.get('nome', '').strip()
            descricao = request.POST.get('descricao', '').strip()
            tipo_comissao = request.POST.get('tipo_comissao', 'GERAL')
            tipo_sessao = request.POST.get('tipo_sessao', 'GERAL')
            conteudo = request.POST.get('conteudo', '').strip()
            
            print(f"Nome: {nome}")
            print(f"Descri√ß√£o: {descricao}")
            print(f"Tipo Comiss√£o: {tipo_comissao}")
            print(f"Tipo Sess√£o: {tipo_sessao}")
            print(f"Conte√∫do: {conteudo[:100] if conteudo else 'VAZIO'}")
            
            # Valida√ß√µes
            if not nome:
                error_msg = 'Nome do modelo √© obrigat√≥rio.'
                if is_ajax:
                    return JsonResponse({'success': False, 'error': error_msg})
                else:
                    messages.error(request, error_msg)
                    return redirect('militares:modelo_ata_list')
            
            if not conteudo:
                error_msg = 'Conte√∫do do modelo √© obrigat√≥rio.'
                if is_ajax:
                    return JsonResponse({'success': False, 'error': error_msg})
                else:
                    messages.error(request, error_msg)
                    return redirect('militares:modelo_ata_list')
            
            # Atualizar o modelo
            modelo.nome = nome
            modelo.descricao = descricao
            modelo.tipo_comissao = tipo_comissao
            modelo.tipo_sessao = tipo_sessao
            modelo.conteudo = conteudo
            modelo.save()
            
            print(f"Modelo atualizado com sucesso: {modelo.nome}")
            
            success_msg = f'Modelo "{modelo.nome}" atualizado com sucesso!'
            
            if is_ajax:
                return JsonResponse({
                    'success': True,
                    'message': success_msg,
                    'modelo_id': modelo.pk,
                    'modelo_nome': modelo.nome
                })
            else:
                messages.success(request, success_msg)
                return redirect('militares:modelo_ata_list')
                
        except Exception as e:
            print(f"ERRO ao atualizar modelo: {str(e)}")
            import traceback
            traceback.print_exc()
            
            error_msg = f'Erro ao atualizar modelo: {str(e)}'
            
            if is_ajax:
                return JsonResponse({'success': False, 'error': error_msg})
            else:
                messages.error(request, error_msg)
                return redirect('militares:modelo_ata_list')
    else:
        print("=== M√âTODO GET ===")
        form = ModeloAtaForm(instance=modelo)
    
    context = {
        'form': form,
        'modelo': modelo,
        'titulo': f'Editar Modelo: {modelo.nome}',
        'variaveis_disponiveis': [
            '{{sessao.numero}} - N√∫mero da sess√£o',
            '{{sessao.data_sessao}} - Data da sess√£o',
            '{{sessao.hora_inicio}} - Hora de in√≠cio',
            '{{sessao.hora_fim}} - Hora de t√©rmino',
            '{{sessao.local}} - Local da sess√£o',
            '{{sessao.tipo}} - Tipo da sess√£o',
            '{{sessao.pauta}} - Pauta da sess√£o',
            '{{comissao.nome}} - Nome da comiss√£o',
            '{{comissao.tipo}} - Tipo da comiss√£o',
        ]
    }
    return render(request, 'militares/modelo_ata/form.html', context)

@login_required
def modelo_ata_delete(request, pk):
    modelo = get_object_or_404(ModeloAta, pk=pk)
    
    # Verificar se √© uma requisi√ß√£o AJAX
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    if request.method == 'POST':
        nome = modelo.nome
        modelo.delete()
        
        if is_ajax:
            return JsonResponse({
                'success': True,
                'message': f'Modelo "{nome}" exclu√≠do com sucesso!'
            })
        else:
            messages.success(request, f'Modelo "{nome}" exclu√≠do com sucesso!')
            return redirect('militares:modelo_ata_list')
    
    context = {
        'modelo': modelo,
        'titulo': f'Excluir Modelo: {modelo.nome}'
    }
    return render(request, 'militares/modelo_ata/delete.html', context)

@login_required
def modelo_ata_detail(request, pk):
    modelo = get_object_or_404(ModeloAta, pk=pk)
    
    # Verificar se √© uma requisi√ß√£o AJAX
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    if is_ajax:
        return JsonResponse({
            'success': True,
            'modelo': {
                'id': modelo.pk,
                'nome': modelo.nome,
                'descricao': modelo.descricao,
                'tipo_comissao': modelo.tipo_comissao,
                'tipo_comissao_display': modelo.get_tipo_comissao_display(),
                'tipo_sessao': modelo.tipo_sessao,
                'tipo_sessao_display': modelo.get_tipo_sessao_display(),
                'conteudo': modelo.conteudo,
                'ativo': modelo.ativo,
                'padrao': modelo.padrao,
                'criado_por': modelo.criado_por.get_full_name() if modelo.criado_por else modelo.criado_por.username,
                'data_criacao': modelo.data_criacao.strftime('%d/%m/%Y %H:%M') if modelo.data_criacao else '',
            }
        })
    
    context = {
        'modelo': modelo,
        'titulo': f'Modelo: {modelo.nome}'
    }
    return render(request, 'militares/modelo_ata/detail.html', context)

@login_required
def modelo_ata_aplicar(request, sessao_pk):
    sessao = get_object_or_404(SessaoComissao, pk=sessao_pk)
    try:
        membro = MembroComissao.objects.get(
            comissao=sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    # Verificar se √© uma requisi√ß√£o AJAX
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    if request.method == 'POST':
        modelo_id = request.POST.get('modelo_id')
        if modelo_id:
            try:
                modelo = ModeloAta.objects.get(pk=modelo_id, ativo=True)
                if modelo.pode_ser_usado_para(sessao):
                    conteudo_aplicado = modelo.aplicar_variaveis(sessao)
                    try:
                        ata = sessao.ata_editada
                    except AtaSessao.DoesNotExist:
                        ata = AtaSessao(sessao=sessao, editado_por=request.user)
                    ata.conteudo = conteudo_aplicado
                    ata.editado_por = request.user
                    ata.save()
                    
                    if is_ajax:
                        return JsonResponse({
                            'success': True,
                            'message': f'Modelo "{modelo.nome}" aplicado com sucesso!',
                            'conteudo': conteudo_aplicado
                        })
                    else:
                        messages.success(request, f'Modelo "{modelo.nome}" aplicado com sucesso!')
                        return redirect('militares:sessao_editar_ata', pk=sessao.pk)
                else:
                    error_msg = 'Este modelo n√£o pode ser usado para esta sess√£o.'
                    if is_ajax:
                        return JsonResponse({'success': False, 'error': error_msg})
                    else:
                        messages.error(request, error_msg)
            except ModeloAta.DoesNotExist:
                error_msg = 'Modelo n√£o encontrado.'
                if is_ajax:
                    return JsonResponse({'success': False, 'error': error_msg})
                else:
                    messages.error(request, error_msg)
    
    modelos_disponiveis = ModeloAta.get_modelos_disponiveis(sessao)
    modelo_padrao = ModeloAta.get_modelo_padrao(sessao)
    context = {
        'sessao': sessao,
        'modelos_disponiveis': modelos_disponiveis,
        'modelo_padrao': modelo_padrao,
        'titulo': f'Aplicar Modelo √† Sess√£o {sessao.numero}'
    }
    return render(request, 'militares/modelo_ata/aplicar.html', context)

@login_required
def modelo_ata_salvar_atual(request, sessao_pk):
    
    print(f"=== IN√çCIO DA FUN√á√ÉO modelo_ata_salvar_atual ===")
    print(f"Sess√£o PK: {sessao_pk}")
    print(f"M√©todo: {request.method}")
    
    sessao = get_object_or_404(SessaoComissao, pk=sessao_pk)
    print(f"Sess√£o encontrada: {sessao}")
    
    # Verificar se existe uma ata
    try:
        ata = sessao.ata_editada
        print(f"Ata encontrada: {ata}")
        print(f"Conte√∫do da ata: {ata.conteudo[:100] if ata.conteudo else 'VAZIO'}")
    except AtaSessao.DoesNotExist:
        print("ERRO: N√£o existe uma ata para esta sess√£o")
        messages.error(request, 'N√£o existe uma ata para esta sess√£o.')
        return redirect('militares:sessao_editar_ata', pk=sessao.pk)
    
    # Criar formul√°rio personalizado sem o campo conteudo
    class ModeloAtaSalvarForm(forms.ModelForm):
        class Meta:
            model = ModeloAta
            fields = ['nome', 'descricao', 'tipo_comissao', 'tipo_sessao', 'ativo', 'padrao']
            widgets = {
                'nome': forms.TextInput(attrs={
                    'class': 'form-control',
                    'placeholder': 'Ex: Modelo Padr√£o CPO Ordin√°ria'
                }),
                'descricao': forms.Textarea(attrs={
                    'class': 'form-control',
                    'rows': 3,
                    'placeholder': 'Descri√ß√£o do modelo e quando us√°-lo...'
                }),
                'tipo_comissao': forms.Select(attrs={'class': 'form-control'}),
                'tipo_sessao': forms.Select(attrs={'class': 'form-control'}),
                'ativo': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
                'padrao': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
            }
    
    if request.method == 'POST':
        print("=== PROCESSANDO POST ===")
        print(f"POST data: {request.POST}")
        
        # Verificar se √© uma requisi√ß√£o AJAX
        is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest' or request.content_type == 'application/json'
        
        try:
            # Obter dados do formul√°rio
            nome = request.POST.get('nome', '').strip()
            descricao = request.POST.get('descricao', '').strip()
            tipo_comissao = request.POST.get('tipo_comissao', 'GERAL')
            tipo_sessao = request.POST.get('tipo_sessao', 'GERAL')
            conteudo = request.POST.get('conteudo', '').strip()
            
            print(f"Nome: {nome}")
            print(f"Descri√ß√£o: {descricao}")
            print(f"Tipo Comiss√£o: {tipo_comissao}")
            print(f"Tipo Sess√£o: {tipo_sessao}")
            print(f"Conte√∫do: {conteudo[:100] if conteudo else 'VAZIO'}")
            
            # Valida√ß√µes
            if not nome:
                error_msg = 'Nome do modelo √© obrigat√≥rio.'
                if is_ajax:
                    return JsonResponse({'success': False, 'error': error_msg})
                else:
                    messages.error(request, error_msg)
                    return redirect('militares:sessao_editar_ata', pk=sessao.pk)
            
            if not conteudo:
                error_msg = 'Conte√∫do do modelo √© obrigat√≥rio.'
                if is_ajax:
                    return JsonResponse({'success': False, 'error': error_msg})
                else:
                    messages.error(request, error_msg)
                    return redirect('militares:sessao_editar_ata', pk=sessao.pk)
            
            # Criar o modelo
            modelo = ModeloAta.objects.create(
                nome=nome,
                descricao=descricao,
                tipo_comissao=tipo_comissao,
                tipo_sessao=tipo_sessao,
                conteudo=conteudo,
                criado_por=request.user,
                ativo=True,
                padrao=False
            )
            
            print(f"Modelo salvo com sucesso: {modelo.nome} (ID: {modelo.pk})")
            
            success_msg = f'Modelo "{modelo.nome}" criado com sucesso!'
            
            if is_ajax:
                return JsonResponse({
                    'success': True,
                    'message': success_msg,
                    'modelo_id': modelo.pk,
                    'modelo_nome': modelo.nome
                })
            else:
                messages.success(request, success_msg)
                return redirect('militares:modelo_ata_list')
                
        except Exception as e:
            print(f"ERRO ao salvar modelo: {str(e)}")
            import traceback
            traceback.print_exc()
            
            error_msg = f'Erro ao salvar modelo: {str(e)}'
            
            if is_ajax:
                return JsonResponse({'success': False, 'error': error_msg})
            else:
                messages.error(request, error_msg)
                return redirect('militares:sessao_editar_ata', pk=sessao.pk)
    else:
        print("=== M√âTODO GET ===")
        form = ModeloAtaSalvarForm(initial={
            'nome': f'Modelo da Sess√£o {sessao.numero} - {sessao.comissao.nome}',
            'tipo_comissao': sessao.comissao.tipo,
            'tipo_sessao': sessao.tipo,
            'descricao': f'Modelo criado a partir da ata da sess√£o {sessao.numero} realizada em {sessao.data_sessao.strftime("%d/%m/%Y")}',
        })
    
    context = {
        'form': form,
        'sessao': sessao,
        'ata': ata,
        'titulo': f'Salvar Ata como Modelo - Sess√£o {sessao.numero}',
        'variaveis_disponiveis': [
            '{{sessao.numero}} - N√∫mero da sess√£o',
            '{{sessao.data_sessao}} - Data da sess√£o',
            '{{sessao.hora_inicio}} - Hora de in√≠cio',
            '{{sessao.hora_fim}} - Hora de t√©rmino',
            '{{sessao.local}} - Local da sess√£o',
            '{{sessao.tipo}} - Tipo da sess√£o',
            '{{sessao.pauta}} - Pauta da sess√£o',
            '{{comissao.nome}} - Nome da comiss√£o',
            '{{comissao.tipo}} - Tipo da comiss√£o',
        ]
    }
    
    print("=== RENDERIZANDO TEMPLATE ===")
    return render(request, 'militares/modelo_ata/salvar_atual.html', context)

@login_required
@comissao_acesso_total
def deliberacao_comissao_resultado(request, sessao_pk):
    """Exibir resultado das delibera√ß√µes com votos dos membros"""
    try:
        sessao = SessaoComissao.objects.get(pk=sessao_pk)
        comissao = sessao.comissao
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    user_membro = MembroComissao.objects.filter(
        comissao=comissao,
        usuario=request.user,
        ativo=True
    ).first()
    
    # Buscar todas as delibera√ß√µes da sess√£o com seus votos
    deliberacoes = sessao.deliberacoes.prefetch_related('votos__membro__militar').all()
    
    context = {
        'comissao': comissao,
        'sessao': sessao,
        'deliberacoes': deliberacoes,
        'user_membro': user_membro,
        'membros_presentes': [p.membro for p in sessao.presencas.filter(presente=True)],
    }
    return render(request, 'militares/comissao/deliberacoes/resultado.html', context)

@login_required
@comissao_acesso_total
def deliberacao_resultado_update(request, pk):
    """Editar resultado da delibera√ß√£o ap√≥s vota√ß√£o conclu√≠da"""
    deliberacao = get_object_or_404(DeliberacaoComissao, pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    membro = MembroComissao.objects.filter(
        comissao=deliberacao.sessao.comissao,
        usuario=request.user,
        ativo=True
    ).first()
    if not membro:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=deliberacao.sessao.pk)
    
    # Verificar se a vota√ß√£o foi conclu√≠da
    total_presentes = deliberacao.sessao.presencas.filter(presente=True).count()
    total_votos = deliberacao.votos.count()
    
    if total_votos < total_presentes:
        messages.error(request, 
            f'A vota√ß√£o ainda n√£o foi conclu√≠da ({total_votos}/{total_presentes} votos). '
            'O resultado s√≥ pode ser registrado ap√≥s todos os membros presentes votarem.'
        )
        return redirect('militares:deliberacao_comissao_detail', pk=deliberacao.pk)
    
    if request.method == 'POST':
        # Criar formul√°rio apenas com o campo resultado
        class ResultadoForm(forms.Form):
            resultado = forms.CharField(
                widget=forms.Textarea(attrs={
                    'rows': 6,
                    'class': 'form-control',
                    'placeholder': 'Registre aqui a decis√£o ou resultado da delibera√ß√£o ap√≥s a vota√ß√£o...'
                }),
                required=True,
                label='Resultado da Delibera√ß√£o'
            )
        
        form = ResultadoForm(request.POST)
        if form.is_valid():
            deliberacao.resultado = form.cleaned_data['resultado']
            deliberacao.save()
            
            messages.success(request, 'Resultado da delibera√ß√£o registrado com sucesso!')
            return redirect('militares:deliberacao_comissao_detail', pk=deliberacao.pk)
    else:
        # Formul√°rio inicial com o resultado atual
        class ResultadoForm(forms.Form):
            resultado = forms.CharField(
                widget=forms.Textarea(attrs={
                    'rows': 6,
                    'class': 'form-control',
                    'placeholder': 'Registre aqui a decis√£o ou resultado da delibera√ß√£o ap√≥s a vota√ß√£o...'
                }),
                required=True,
                label='Resultado da Delibera√ß√£o',
                initial=deliberacao.resultado
            )
        
        form = ResultadoForm()
    
    context = {
        'deliberacao': deliberacao,
        'form': form,
        'sessao': deliberacao.sessao,
        'comissao': deliberacao.sessao.comissao,
        'membro': membro,
        'total_presentes': total_presentes,
        'total_votos': total_votos,
        'title': f'Registrar Resultado - Delibera√ß√£o {deliberacao.numero}'
    }
    
    return render(request, 'militares/comissao/deliberacoes/resultado_form.html', context)

@login_required
def notificacoes_list(request):
    """Lista todas as notifica√ß√µes do usu√°rio"""
    
    notificacoes = NotificacaoSessao.objects.filter(
        usuario=request.user
    ).order_by('-data_criacao')
    
    # Filtros
    tipo = request.GET.get('tipo')
    if tipo:
        notificacoes = notificacoes.filter(tipo=tipo)
    
    lida = request.GET.get('lida')
    if lida is not None:
        notificacoes = notificacoes.filter(lida=lida == 'true')
    
    # Pagina√ß√£o
    paginator = Paginator(notificacoes, 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'notificacoes': page_obj,
        'tipos': NotificacaoSessao.TIPO_CHOICES,
        'filtros': {
            'tipo': tipo,
            'lida': lida,
        }
    }
    
    return render(request, 'militares/notificacoes/list.html', context)

@login_required
def notificacao_marcar_lida(request, pk):
    """Marca uma notifica√ß√£o como lida"""
    
    try:
        notificacao = NotificacaoSessao.objects.get(
            pk=pk,
            usuario=request.user
        )
        notificacao.marcar_como_lida()
        messages.success(request, 'Notifica√ß√£o marcada como lida.')
    except NotificacaoSessao.DoesNotExist:
        messages.error(request, 'Notifica√ß√£o n√£o encontrada.')
    
    return redirect('militares:notificacoes_list')

@login_required
def notificacao_marcar_todas_lidas(request):
    """Marca todas as notifica√ß√µes do usu√°rio como lidas"""
    
    notificacoes = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    )
    
    count = notificacoes.count()
    notificacoes.update(lida=True, data_leitura=timezone.now())
    
    messages.success(request, f'{count} notifica√ß√£o(√µes) marcada(s) como lida(s).')
    return redirect('militares:notificacoes_list')

@login_required
def notificacao_delete(request, pk):
    """Remove uma notifica√ß√£o"""
    
    try:
        notificacao = NotificacaoSessao.objects.get(
            pk=pk,
            usuario=request.user
        )
        notificacao.delete()
        messages.success(request, 'Notifica√ß√£o removida.')
    except NotificacaoSessao.DoesNotExist:
        messages.error(request, 'Notifica√ß√£o n√£o encontrada.')
    
    return redirect('militares:notificacoes_list')

@login_required
def notificacoes_api_nao_lidas(request):
    """API para retornar o total de notifica√ß√µes n√£o lidas"""
    total = NotificacaoSessao.objects.filter(
        usuario=request.user,
        lida=False
    ).count()
    
    return JsonResponse({
        'total': total
    })

# Views para gerenciar cargos da comiss√£o
@login_required
@comissao_acesso_total
def cargo_comissao_list(request):
    """Lista todos os cargos da comiss√£o"""
    cargos = CargoComissao.objects.all()
    
    context = {
        'cargos': cargos,
        'title': 'Cargos da Comiss√£o',
    }
    return render(request, 'militares/comissao/cargos/list.html', context)

@login_required
@comissao_acesso_total
def cargo_comissao_create(request):
    """Cria um novo cargo"""
    if request.method == 'POST':
        form = CargoComissaoForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Cargo criado com sucesso!')
            return redirect('militares:cargo_comissao_list')
    else:
        form = CargoComissaoForm()
    
    context = {
        'form': form,
        'title': 'Novo Cargo da Comiss√£o',
    }
    return render(request, 'militares/comissao/cargos/form.html', context)

@login_required
@comissao_acesso_total
def cargo_comissao_update(request, pk):
    """Edita um cargo existente"""
    try:
        cargo = CargoComissao.objects.get(pk=pk)
    except CargoComissao.DoesNotExist:
        messages.error(request, 'Cargo n√£o encontrado.')
        return redirect('militares:cargo_comissao_list')
    
    if request.method == 'POST':
        form = CargoComissaoForm(request.POST, instance=cargo)
        if form.is_valid():
            form.save()
            messages.success(request, 'Cargo atualizado com sucesso!')
            return redirect('militares:cargo_comissao_list')
    else:
        form = CargoComissaoForm(instance=cargo)
    
    context = {
        'form': form,
        'cargo': cargo,
        'title': 'Editar Cargo da Comiss√£o',
    }
    return render(request, 'militares/comissao/cargos/form.html', context)

@login_required
@comissao_acesso_total
def cargo_comissao_delete(request, pk):
    """Exclui um cargo"""
    try:
        cargo = CargoComissao.objects.get(pk=pk)
    except CargoComissao.DoesNotExist:
        messages.error(request, 'Cargo n√£o encontrado.')
        return redirect('militares:cargo_comissao_list')
    
    # Buscar membros vinculados ao cargo
    # Como MembroComissao.cargo referencia CargoFuncao, n√£o CargoComissao,
    # vamos buscar por membros que tenham o mesmo nome de cargo
    membros_vinculados = MembroComissao.objects.filter(cargo__nome=cargo.nome)
    erro_protegido = False
    

    
    if request.method == 'POST':
        try:
            cargo.delete()
            messages.success(request, 'Cargo exclu√≠do com sucesso!')
            return redirect('militares:cargo_comissao_list')
        except ProtectedError:
            erro_protegido = True
            messages.error(request, 'N√£o √© poss√≠vel excluir este cargo porque ele est√° vinculado a um ou mais membros da comiss√£o. Troque o cargo desses membros antes de excluir.')
    
    context = {
        'cargo': cargo,
        'title': 'Excluir Cargo da Comiss√£o',
        'membros_vinculados': membros_vinculados,
        'erro_protegido': erro_protegido,
    }
    return render(request, 'militares/comissao/cargos/delete.html', context)

# =============================================================================
# M√ìDULO DE QUADROS DE FIXA√á√ÉO DE VAGAS
# =============================================================================

@login_required
def quadro_fixacao_vagas_list(request):
    """Lista todos os quadros de fixa√ß√£o de vagas de oficiais"""
    from militares.permissoes_simples import tem_permissao
    from militares.filtros_hierarquicos_adicionais import aplicar_filtro_hierarquico_quadros_fixacao
    from militares.permissoes_hierarquicas import obter_funcao_militar_ativa
    
    # Obter fun√ß√£o militar ativa
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    # Aplicar filtros hier√°rquicos baseados no acesso da fun√ß√£o
    if request.user.is_superuser or request.user.is_staff:
        quadros = QuadroFixacaoVagas.objects.all().order_by('-data_criacao')
    elif funcao_usuario and tem_permissao(request.user, 'quadros_fixacao', 'visualizar'):
        quadros = aplicar_filtro_hierarquico_quadros_fixacao(QuadroFixacaoVagas.objects.all(), funcao_usuario, request.user).order_by('-data_criacao')
    else:
        quadros = QuadroFixacaoVagas.objects.none()

    # Filtros
    data_inicio = request.GET.get('data_inicio')
    if data_inicio:
        try:
            data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            quadros = quadros.filter(data_criacao__gte=data_inicio)
        except ValueError:
            pass
    
    data_fim = request.GET.get('data_fim')
    if data_fim:
        try:
            data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
            quadros = quadros.filter(data_criacao__lte=data_fim)
        except ValueError:
            pass
    
    # Pagina√ß√£o
    paginator = Paginator(quadros, 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # Estat√≠sticas
    total_quadros = quadros.count()
    
    # Verificar se o usu√°rio √© membro de alguma comiss√£o
    membro_comissao = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True,
        comissao__status='ATIVA'
    ).first()
    
    context = {
        'quadros': page_obj,
        'total_quadros': total_quadros,
        'filtros': {
            'data_inicio': data_inicio,
            'data_fim': data_fim,
        },
        'membro_comissao': membro_comissao,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/list.html', context)

@login_required
def quadro_fixacao_vagas_create(request):
    """Cria um novo quadro de fixa√ß√£o de vagas"""
    if request.method == 'POST':
        titulo = request.POST.get('titulo')
        tipo = request.POST.get('tipo')
        data_promocao = request.POST.get('data_promocao')
        observacoes = request.POST.get('observacoes', '')
        
        if not titulo:
            messages.error(request, 'O t√≠tulo do quadro √© obrigat√≥rio.')
            return redirect('militares:quadro_fixacao_vagas_create')
        
        if not tipo:
            messages.error(request, 'O tipo de quadro √© obrigat√≥rio.')
            return redirect('militares:quadro_fixacao_vagas_create')
        
        if not data_promocao:
            data_promocao = calcular_proxima_data_promocao()
            data_automatica = True
        else:
            try:
                data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                data_automatica = False
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_fixacao_vagas_create')
        
        # Verificar se j√° existe um quadro para esta data
        # Removida a valida√ß√£o que impedia m√∫ltiplos quadros para a mesma data
        # (permitir m√∫ltiplos quadros de fixa√ß√£o de vagas para a mesma data)
        
        # Criar o quadro
        try:
            novo_quadro = QuadroFixacaoVagas.objects.create(
                titulo=titulo,
                tipo=tipo,
                data_promocao=data_promocao,
                status='RASCUNHO',
                observacoes=observacoes,
                criado_por=request.user
            )
            
            # Capturar previs√µes de vagas baseado no tipo
            if tipo == 'OFICIAIS':
                # Buscar previs√µes para oficiais (quadros COMB, SAUDE, ENG, COMP, NVRR)
                previsoes = PrevisaoVaga.objects.filter(
                    ativo=True,
                    quadro__in=['COMB', 'SAUDE', 'ENG', 'COMP', 'NVRR'],
                    posto__in=['AS', 'AA', '2T', '1T', 'CP', 'MJ', 'TC', 'CB']
                ).order_by('quadro', 'posto')
            else:  # PRACAS
                # Buscar previs√µes para pra√ßas (quadro PRACAS)
                previsoes = PrevisaoVaga.objects.filter(
                    ativo=True,
                    quadro='PRACAS',
                    posto__in=['ST', '1S', '2S', '3S', 'CAB', 'SD']
                ).order_by('quadro', 'posto')
            
            # Criar itens do quadro baseado nas previs√µes
            for previsao in previsoes:
                # Capturar observa√ß√£o espec√≠fica para este item
                observacao_key = f'observacoes_{previsao.id}'
                observacao = request.POST.get(observacao_key, '').strip()
                
                ItemQuadroFixacaoVagas.objects.create(
                    quadro=novo_quadro,
                    previsao_vaga=previsao,
                    vagas_fixadas=previsao.vagas_disponiveis,  # Inicialmente igual √†s vagas dispon√≠veis
                    observacoes=observacao
                )
            
            if data_automatica:
                messages.success(request, f'Quadro de Fixa√ß√£o de Vagas criado com sucesso! Data autom√°tica: {data_promocao.strftime("%d/%m/%Y")}')
            else:
                messages.success(request, f'Quadro de Fixa√ß√£o de Vagas criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
            return redirect('militares:quadro_fixacao_vagas_detail', pk=novo_quadro.pk)
                
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro: {str(e)}')
        
        return redirect('militares:quadro_fixacao_vagas_create')
    
    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }
    
    # Buscar previs√µes de vagas para mostrar no preview
    previsoes_oficiais = PrevisaoVaga.objects.filter(
        ativo=True,
        quadro__in=['COMB', 'SAUDE', 'ENG', 'COMP', 'NVRR'],
        posto__in=['AS', 'AA', '2T', '1T', 'CP', 'MJ', 'TC', 'CB']
    )
    
    previsoes_pracas = PrevisaoVaga.objects.filter(
        ativo=True,
        quadro='PRACAS',
        posto__in=['ST', '1S', '2S', '3S', 'CAB', 'SD']
    )
    
    # Agrupar previs√µes por quadro e ordenar por hierarquia
    vagas_por_quadro_oficiais = {}
    for previsao in previsoes_oficiais:
        if previsao.quadro not in vagas_por_quadro_oficiais:
            vagas_por_quadro_oficiais[previsao.quadro] = []
        vagas_por_quadro_oficiais[previsao.quadro].append(previsao)
    
    # Ordenar por hierarquia dentro de cada quadro
    for quadro in vagas_por_quadro_oficiais:
        vagas_por_quadro_oficiais[quadro].sort(
            key=lambda x: hierarquia_postos.get(x.posto, 999)
        )
    
    vagas_por_quadro_pracas = {}
    for previsao in previsoes_pracas:
        if previsao.quadro not in vagas_por_quadro_pracas:
            vagas_por_quadro_pracas[previsao.quadro] = []
        vagas_por_quadro_pracas[previsao.quadro].append(previsao)
    
    # Ordenar por hierarquia dentro de cada quadro
    for quadro in vagas_por_quadro_pracas:
        vagas_por_quadro_pracas[quadro].sort(
            key=lambda x: hierarquia_postos.get(x.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    vagas_por_quadro_oficiais_ordenado = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in vagas_por_quadro_oficiais:
            vagas_por_quadro_oficiais_ordenado[cod_quadro] = vagas_por_quadro_oficiais[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, vagas in vagas_por_quadro_oficiais.items():
        if cod_quadro not in vagas_por_quadro_oficiais_ordenado:
            vagas_por_quadro_oficiais_ordenado[cod_quadro] = vagas
    
    context = {
        'tipos': QuadroFixacaoVagas.TIPO_CHOICES,
        'proxima_data_automatica': calcular_proxima_data_promocao(),
        'vagas_por_quadro_oficiais': vagas_por_quadro_oficiais_ordenado,
        'vagas_por_quadro_pracas': vagas_por_quadro_pracas,
        'quadros': QUADRO_CHOICES,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/create.html', context)

@login_required
def quadro_fixacao_vagas_detail(request, pk):
    """Detalhes de um quadro de fixa√ß√£o de vagas"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para ver este quadro
    membros_comissao = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True,
        comissao__status='ATIVA'
    )
    
    if membros_comissao.exists():
        # Verificar se √© membro de ambas as comiss√µes
        tem_cpo = membros_comissao.filter(comissao__tipo='CPO').exists()
        tem_cpp = membros_comissao.filter(comissao__tipo='CPP').exists()
        
        # Se √© membro de ambas, pode ver todos os quadros
        if tem_cpo and tem_cpp:
            pass  # Pode ver todos os quadros
        elif tem_cpo and quadro.tipo != 'OFICIAIS':
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
            return redirect('militares:quadro_fixacao_vagas_list')
        elif tem_cpp and quadro.tipo != 'PRACAS':
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
            return redirect('militares:quadro_fixacao_vagas_list')

    # Buscar itens do quadro agrupados por quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )

    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }

    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Ordenar itens dentro de cada quadro por hierarquia de postos (do mais alto para o mais baixo)
    for quadro_cod in grupos:
        grupos[quadro_cod]['itens'].sort(
            key=lambda x: hierarquia_postos.get(x.previsao_vaga.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    grupos_ordenados = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in grupos:
            grupos_ordenados[cod_quadro] = grupos[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, grupo in grupos.items():
        if cod_quadro not in grupos_ordenados:
            grupos_ordenados[cod_quadro] = grupo
    
    grupos = grupos_ordenados

    context = {
        'quadro': quadro,
        'grupos': grupos,
    }

    return render(request, 'militares/quadro_fixacao_vagas/detail.html', context)

@login_required
@cargos_especiais_required
def quadro_fixacao_vagas_update(request, pk):
    """Atualiza um quadro de fixa√ß√£o de vagas (geral)"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para editar este quadro
    # Superusu√°rios e staff t√™m acesso total, independente de serem membros de comiss√£o
    if not request.user.is_superuser and not request.user.is_staff:
        membro_comissao = MembroComissao.objects.filter(
            usuario=request.user,
            ativo=True,
            comissao__status='ATIVA'
        ).first()
        
        if membro_comissao:
            if membro_comissao.comissao.tipo == 'CPO' and quadro.tipo != 'OFICIAIS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
            elif membro_comissao.comissao.tipo == 'CPP' and quadro.tipo != 'PRACAS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')

    if request.method == 'POST':
        # Atualizar dados b√°sicos do quadro
        titulo = request.POST.get('titulo')
        data_promocao = request.POST.get('data_promocao')
        observacoes = request.POST.get('observacoes', '')

        if titulo:
            quadro.titulo = titulo
        if data_promocao:
            try:
                quadro.data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_fixacao_vagas_update', pk=pk)
        quadro.observacoes = observacoes
        # Limpar assinaturas eletr√¥nicas ao editar o quadro
        quadro.assinaturas.all().delete()
        quadro.save()

        # Atualizar observa√ß√µes dos itens (vagas fixadas s√£o autom√°ticas)
        for key, value in request.POST.items():
            if key.startswith('observacoes_'):
                item_id = key.replace('observacoes_', '')
                try:
                    item = ItemQuadroFixacaoVagas.objects.get(id=item_id, quadro=quadro)
                    item.observacoes = value
                    # As vagas fixadas s√£o automaticamente sincronizadas no save() do modelo
                    item.save()
                except (ItemQuadroFixacaoVagas.DoesNotExist, ValueError):
                    continue
        messages.success(request, 'Quadro de fixa√ß√£o de vagas atualizado com sucesso! As assinaturas eletr√¥nicas foram removidas e ser√° necess√°rio assinar novamente.')
        return redirect('militares:quadro_fixacao_vagas_detail', pk=quadro.pk)

    # Buscar itens do quadro agrupados por quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )

    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }

    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Ordenar itens dentro de cada quadro por hierarquia de postos (do mais alto para o mais baixo)
    for quadro_cod in grupos:
        grupos[quadro_cod]['itens'].sort(
            key=lambda x: hierarquia_postos.get(x.previsao_vaga.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    grupos_ordenados = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in grupos:
            grupos_ordenados[cod_quadro] = grupos[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, grupo in grupos.items():
        if cod_quadro not in grupos_ordenados:
            grupos_ordenados[cod_quadro] = grupo
    
    grupos = grupos_ordenados

    context = {
        'quadro': quadro,
        'grupos': grupos,
    }
    return render(request, 'militares/quadro_fixacao_vagas/update.html', context)

@login_required
def quadro_fixacao_vagas_pdf_view(request, pk):
    """Visualiza o PDF do quadro de fixa√ß√£o de vagas em nova aba"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para visualizar este quadro
    # Superusu√°rios e staff t√™m acesso total, independente de serem membros de comiss√£o
    if not request.user.is_superuser and not request.user.is_staff:
        membro_comissao = MembroComissao.objects.filter(
            usuario=request.user,
            ativo=True,
            comissao__status='ATIVA'
        ).first()
        
        if membro_comissao:
            if membro_comissao.comissao.tipo == 'CPO' and quadro.tipo != 'OFICIAIS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
            elif membro_comissao.comissao.tipo == 'CPP' and quadro.tipo != 'PRACAS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')

    # Buscar itens do quadro agrupados por quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )

    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }

    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Ordenar itens dentro de cada quadro por hierarquia de postos (do mais alto para o mais baixo)
    for quadro_cod in grupos:
        grupos[quadro_cod]['itens'].sort(
            key=lambda x: hierarquia_postos.get(x.previsao_vaga.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    grupos_ordenados = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in grupos:
            grupos_ordenados[cod_quadro] = grupos[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, grupo in grupos.items():
        if cod_quadro not in grupos_ordenados:
            grupos_ordenados[cod_quadro] = grupo
    
    grupos = grupos_ordenados

    context = {
        'quadro': quadro,
        'grupos': grupos,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/pdf_view.html', context)

@login_required
def quadro_fixacao_vagas_pdf(request, pk):
    """Gera PDF do quadro de fixa√ß√£o de vagas no modelo institucional"""
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    import qrcode
    import locale
    from datetime import datetime

    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar

    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, f'Quadro de fixa√ß√£o de vagas com ID {pk} n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para visualizar este quadro
    membro_comissao = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True,
        comissao__status='ATIVA'
    ).first()
    
    if membro_comissao:
        if membro_comissao.comissao.tipo == 'CPO' and quadro.tipo != 'OFICIAIS':
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
            return redirect('militares:quadro_fixacao_vagas_list')
        elif membro_comissao.comissao.tipo == 'CPP' and quadro.tipo != 'PRACAS':
            messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
            return redirect('militares:quadro_fixacao_vagas_list')

    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()

    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6)

    story = []

    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Determinar local de gera√ß√£o baseado na fun√ß√£o do usu√°rio (hierarquia completa)
    local_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario and funcao_usuario.funcao_militar:
        hierarquia = []
        
        # Construir hierarquia completa at√© a inst√¢ncia mais espec√≠fica
        if hasattr(funcao_usuario, 'orgao') and funcao_usuario.orgao:
            hierarquia.append(funcao_usuario.orgao.nome.upper())
        if hasattr(funcao_usuario, 'grande_comando') and funcao_usuario.grande_comando:
            hierarquia.append(funcao_usuario.grande_comando.nome.upper())
        if hasattr(funcao_usuario, 'unidade') and funcao_usuario.unidade:
            hierarquia.append(funcao_usuario.unidade.nome.upper())
        if hasattr(funcao_usuario, 'sub_unidade') and funcao_usuario.sub_unidade:
            hierarquia.append(funcao_usuario.sub_unidade.nome.upper())
        
        # Se encontrou alguma inst√¢ncia, usar a mais espec√≠fica (√∫ltima da lista)
        if hierarquia:
            local_geracao = hierarquia[-1]
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        local_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # T√≠tulo centralizado e sublinhado
    tipo_quadro = "QUADRO DE FIXA√á√ÉO DE VAGAS"
    if quadro.tipo == 'OFICIAIS':
        tipo_quadro += " PARA OFICIAIS"
    elif quadro.tipo == 'PRACAS':
        tipo_quadro += " PARA PRACAS"
    
    titulo = f'<u>{tipo_quadro}</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 16))

    # Texto introdut√≥rio com data em portugu√™s
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    data_formatada = f"{quadro.data_promocao.day} de {meses_pt[quadro.data_promocao.month]} de {quadro.data_promocao.year}"
    
    # Texto introdut√≥rio espec√≠fico para oficiais ou pra√ßas
    if quadro.tipo == 'OFICIAIS':
        # Adicionar cada par√°grafo separadamente
        story.append(Paragraph("O DIRETOR DE GEST√ÉO DE PESSOAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç, no uso de suas atribui√ß√µes que lhe confere o Art. 18, da lei 5.949, de 17 de dezembro de 2009, alterado pelo Art. 1¬∞ da lei 7.772, de 04 de abril de 2022;", style_just))
        story.append(Spacer(1, 8))
        
        story.append(Paragraph("CONSIDERANDO o Anexo √önico, da lei n¬∫ 5.949, de 17 de dezembro de 2009 (Lei de Organiza√ß√£o B√°sica do CBMEPI), alterado pela Lei 7.772, de 04 de abril de 2022;", style_just))
        story.append(Spacer(1, 8))
        
        story.append(Paragraph("CONSIDERANDO o Art. 2¬∫ da Lei n¬∫ 5.461 de 30 de junho de 2005 (Lei de Promo√ß√£o de Oficiais do CBMEPI).", style_just))
    else:  # PRACAS
        # Adicionar cada par√°grafo separadamente
        story.append(Paragraph("O DIRETOR DE GEST√ÉO DE PESSOAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç, no uso de suas atribui√ß√µes que lhe confere o Art. 18, da lei 5.949, de 17 de dezembro de 2009, alterado pelo Art. 1¬∫ da lei 7.772, de 04 de abril de 2022;", style_just))
        story.append(Spacer(1, 8))
        
        story.append(Paragraph("CONSIDERANDO o Anexo √önico, da lei n¬∫ 5.949, de 17 de dezembro de 2009 (Lei de Organiza√ß√£o B√°sica do CBMEPI), alterado pela Lei 7.772, de 04 de abril de 2022;", style_just))
        story.append(Spacer(1, 8))
        
        story.append(Paragraph("CONSIDERANDO o Art. 2¬∫ da Lei n¬∫ 5.462 de 30 de junho de 2005 (Lei de Promo√ß√£o de Pra√ßas do CBMEPI);", style_just))
        story.append(Spacer(1, 8))
        
        story.append(Paragraph("RESOLVE:", style_just))
    story.append(Spacer(1, 16))
    
    # Artigo 1¬∫ em par√°grafo separado
    artigo_1 = f"""
    <b>Art. 1¬∫</b> Fixar as vagas para as promo√ß√µes de {quadro.get_tipo_display()} em {data_formatada}, conforme segue:
    """
    
    story.append(Paragraph(artigo_1, style_bold))
    story.append(Spacer(1, 16))

    # Buscar itens do quadro agrupados por quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )

    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13,  # Cabo
        'SD': 14,  # Soldado
    }

    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Ordenar itens dentro de cada quadro por hierarquia de postos (do mais alto para o mais baixo)
    for quadro_cod in grupos:
        grupos[quadro_cod]['itens'].sort(
            key=lambda x: hierarquia_postos.get(x.previsao_vaga.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    grupos_ordenados = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in grupos:
            grupos_ordenados[cod_quadro] = grupos[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, grupo in grupos.items():
        if cod_quadro not in grupos_ordenados:
            grupos_ordenados[cod_quadro] = grupo
    
    grupos = grupos_ordenados

    # Tabela principal
    for cod_quadro, grupo in grupos.items():
        # Definir nomes completos dos quadros
        quadro_nomes_completos = {
            'COMB': 'Quadro de Oficiais Bombeiros Militares Combatentes (QOBM/Comb.)',
            'SAUDE': 'Quadro de Oficiais Bombeiros Militares de Sa√∫de (QOBM/Sa√∫de)',
            'ENG': 'Quadro de Oficiais Bombeiros Militares Engenheiros (QOBM/Eng.)',
            'COMP': 'Quadro de Oficiais Bombeiros Militares Complementar (QOBM/Comp.)',
            'PRACAS': 'Quadro de Pra√ßas (QP)',
        }
        
        # T√≠tulo do quadro com nome completo
        nome_quadro_completo = quadro_nomes_completos.get(cod_quadro, grupo['nome'])
        story.append(Paragraph(f"<b>{nome_quadro_completo}</b>", style_subtitle))
        story.append(Spacer(1, 8))
        
        # Dados da tabela (sem cabe√ßalho)
        data = []
        
        # Dados da tabela
        for item in grupo['itens']:
            posto = item.previsao_vaga.get_posto_display()
            vagas_fixadas = str(item.vagas_fixadas)
            vagas_disponiveis = str(item.previsao_vaga.vagas_disponiveis)
            observacoes = item.observacoes or '-'
            
            data.append([posto, vagas_fixadas, vagas_disponiveis, observacoes])
        
        # Criar tabela com larguras espec√≠ficas para evitar sobreposi√ß√£o
        table = Table(data, colWidths=[5*cm, 3*cm, 3*cm, 5*cm])
        table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('ALIGN', (3, 0), (3, -1), 'LEFT'),  # Observa√ß√µes alinhadas √† esquerda
            ('FONTSIZE', (0, 0), (-1, -1), 9),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 4),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
            ('WORDWRAP', (0, 0), (-1, -1), True),  # Quebra de linha autom√°tica
        ]))
        
        story.append(table)
        story.append(Spacer(1, 16))

    # Observa√ß√µes do quadro
    if quadro.observacoes:
        story.append(Paragraph("<b>Observa√ß√µes Gerais:</b>", style_bold))
        story.append(Spacer(1, 6))
        story.append(Paragraph(quadro.observacoes, style_just))
        story.append(Spacer(1, 16))

    # Data e local
    data_extenso = f"Teresina, {data_formatada}"
    story.append(Spacer(1, 40))
    story.append(Paragraph(data_extenso, style_center))
    
    # Se√ß√£o de Assinaturas F√≠sicas (sem t√≠tulo)
    story.append(Spacer(1, 8))

    # Buscar todas as assinaturas v√°lidas do quadro (da mais recente para a mais antiga)
    assinaturas = quadro.assinaturas.filter(assinado_por__isnull=False).order_by('-data_assinatura')
    
    for assinatura in assinaturas:
        # Nome e posto
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_completo = f"{militar.nome_completo} - {posto}"
        else:
            nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        
        # Fun√ß√£o
        funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
        
        # Tipo de assinatura
        tipo = assinatura.get_tipo_assinatura_display() or "Tipo n√£o registrado"
        
        # Exibir no formato f√≠sico: Nome - Posto BM (negrito), Fun√ß√£o (normal), Tipo (negrito menor)
        story.append(Spacer(1, 8))
        story.append(Paragraph(f"<b>{nome_completo}</b>", style_center))
        story.append(Paragraph(f"{funcao}", style_center))
        story.append(Paragraph(f"<b>{tipo}</b>", style_center))
        story.append(Spacer(1, 8))

    # Se√ß√£o de Assinaturas Eletr√¥nicas (sem t√≠tulo)
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=0.5, spaceAfter=8, spaceBefore=8, color=colors.lightgrey))
    story.append(Spacer(1, 8))
    
    # Buscar todas as assinaturas para exibir na se√ß√£o eletr√¥nica
    assinaturas_eletronicas = quadro.assinaturas.filter(
        assinado_por__isnull=False
    ).order_by('-data_assinatura')
    
    for i, assinatura in enumerate(assinaturas_eletronicas):
        # Nome e posto - seguir o mesmo padr√£o dos quadros de acesso
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_completo = f"{posto} {militar.nome_completo}"
        else:
            nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        
        # Fun√ß√£o
        funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
        
        # Tipo de assinatura
        tipo = assinatura.get_tipo_assinatura_display() or "Tipo n√£o registrado"
        
        # Data da assinatura
        from .utils import formatar_data_assinatura
        data_formatada, hora_formatada = formatar_data_assinatura(assinatura.data_assinatura)
        data_assinatura = f"{data_formatada} {hora_formatada}"
        
        # Texto da assinatura eletr√¥nica no padr√£o solicitado
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_completo}, em {data_assinatura}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Tabela das assinaturas: Logo + Texto de assinatura
        from .utils import obter_caminho_assinatura_eletronica
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=3.5*cm, height=2.0*cm), Paragraph(texto_assinatura, style_small)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 1),
            ('RIGHTPADDING', (0, 0), (-1, -1), 1),
            ('TOPPADDING', (0, 0), (-1, -1), 1),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
        ]))
        
        story.append(assinatura_table)
        
        # Adicionar linha separadora entre assinaturas (exceto na √∫ltima)
        if i < len(assinaturas_eletronicas) - 1:
            story.append(Spacer(1, 8))
            story.append(HRFlowable(width="100%", thickness=0.5, spaceAfter=8, spaceBefore=8, color=colors.lightgrey))
            story.append(Spacer(1, 8))
    
    # Se n√£o houver assinaturas, mostrar mensagem
    if not assinaturas.exists() and not assinaturas_eletronicas.exists():
        story.append(Paragraph("Nenhuma assinatura registrada", style_center))
    
    
    
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(quadro, request, tipo_documento='quadro_fixacao')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 1),
        ('RIGHTPADDING', (0, 0), (-1, -1), 1),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
    ]))
    
    story.append(rodape_table)
    
    # Construir o PDF
    doc.build(story)
    
    # Retornar o PDF para visualiza√ß√£o em nova guia
    buffer.seek(0)
    from django.http import FileResponse
    return FileResponse(buffer, content_type='application/pdf', filename=f'quadro_fixacao_vagas_{quadro.pk}.pdf')

@login_required
@cargos_especiais_required
def quadro_fixacao_vagas_oficiais_create(request):
    """Cria um novo quadro de fixa√ß√£o de vagas para oficiais"""
    if request.method == 'POST':
        titulo = request.POST.get('titulo')
        data_promocao = request.POST.get('data_promocao')
        observacoes = request.POST.get('observacoes', '')
        
        if not titulo:
            messages.error(request, 'O t√≠tulo do quadro √© obrigat√≥rio.')
            return redirect('militares:quadro_fixacao_vagas_oficiais_create')
        
        if not data_promocao:
            data_promocao = calcular_proxima_data_promocao()
            data_automatica = True
        else:
            try:
                data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
                data_automatica = False
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_fixacao_vagas_oficiais_create')
        
        # Verificar se j√° existe um quadro para esta data
        quadro_existente = QuadroFixacaoVagas.objects.filter(
            data_promocao=data_promocao,
            tipo='OFICIAIS'
        ).first()
        
        # Removida a valida√ß√£o que impedia m√∫ltiplos quadros para a mesma data
        # (permitir m√∫ltiplos quadros de fixa√ß√£o de vagas para a mesma data)
        
        # Criar o quadro
        try:
            novo_quadro = QuadroFixacaoVagas.objects.create(
                titulo=titulo,
                tipo='OFICIAIS',
                data_promocao=data_promocao,
                status='RASCUNHO',
                observacoes=observacoes,
                criado_por=request.user
            )
            
            # Buscar previs√µes para oficiais (quadros COMB, SAUDE, ENG, COMP, NVRR)
            previsoes = PrevisaoVaga.objects.filter(
                ativo=True,
                quadro__in=['COMB', 'SAUDE', 'ENG', 'COMP', 'NVRR'],
                posto__in=['AS', 'AA', '2T', '1T', 'CP', 'MJ', 'TC', 'CB']
            ).order_by('quadro', 'posto')
            
            # Criar itens do quadro baseado nas previs√µes
            for previsao in previsoes:
                # Capturar observa√ß√£o espec√≠fica para este item
                observacao_key = f'observacoes_{previsao.id}'
                observacao = request.POST.get(observacao_key, '').strip()
                
                ItemQuadroFixacaoVagas.objects.create(
                    quadro=novo_quadro,
                    previsao_vaga=previsao,
                    vagas_fixadas=previsao.vagas_disponiveis,  # Inicialmente igual √†s vagas dispon√≠veis
                    observacoes=observacao
                )
            
            if data_automatica:
                messages.success(request, f'Quadro de Fixa√ß√£o de Vagas para Oficiais criado com sucesso! Data autom√°tica: {data_promocao.strftime("%d/%m/%Y")}')
            else:
                messages.success(request, f'Quadro de Fixa√ß√£o de Vagas para Oficiais criado com sucesso para {data_promocao.strftime("%d/%m/%Y")}!')
            return redirect('militares:quadro_fixacao_vagas_oficiais_detail', pk=novo_quadro.pk)
                
        except Exception as e:
            messages.error(request, f'Erro ao criar quadro: {str(e)}')
        
        return redirect('militares:quadro_fixacao_vagas_oficiais_create')
    
    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
    }
    
    # Buscar previs√µes de vagas para oficiais
    previsoes_oficiais = PrevisaoVaga.objects.filter(
        ativo=True,
        quadro__in=['COMB', 'SAUDE', 'ENG', 'COMP', 'NVRR'],
        posto__in=['AS', 'AA', '2T', '1T', 'CP', 'MJ', 'TC', 'CB']
    )
    
    # Calcular efetivo atual em tempo real para cada previs√£o
    for previsao in previsoes_oficiais:
        if previsao.quadro == 'COMP':
            # Para COMP, incluir ST (Subtenentes) que s√£o cadastrados como COMP mas contam para pra√ßas
            efetivo_atual = Militar.objects.filter(
                posto_graduacao=previsao.posto,
                quadro='COMP',
                classificacao='ATIVO'
            ).count()
        else:
            # Para outros quadros, usar o quadro espec√≠fico
            efetivo_atual = Militar.objects.filter(
                posto_graduacao=previsao.posto,
                quadro=previsao.quadro,
                classificacao='ATIVO'
            ).count()
        
        # Atualizar o efetivo atual da previs√£o (apenas para exibi√ß√£o)
        previsao.efetivo_atual = efetivo_atual
    
    # Agrupar previs√µes por quadro e ordenar por hierarquia
    vagas_por_quadro_oficiais = {}
    for previsao in previsoes_oficiais:
        if previsao.quadro not in vagas_por_quadro_oficiais:
            vagas_por_quadro_oficiais[previsao.quadro] = []
        vagas_por_quadro_oficiais[previsao.quadro].append(previsao)
    
    # Ordenar por hierarquia dentro de cada quadro
    for quadro in vagas_por_quadro_oficiais:
        vagas_por_quadro_oficiais[quadro].sort(
            key=lambda x: hierarquia_postos.get(x.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    vagas_por_quadro_oficiais_ordenado = {}
    for cod_quadro in ordem_quadros:
        if cod_quadro in vagas_por_quadro_oficiais:
            vagas_por_quadro_oficiais_ordenado[cod_quadro] = vagas_por_quadro_oficiais[cod_quadro]
    
    # Adicionar outros quadros que possam existir
    for cod_quadro, vagas in vagas_por_quadro_oficiais.items():
        if cod_quadro not in vagas_por_quadro_oficiais_ordenado:
            vagas_por_quadro_oficiais_ordenado[cod_quadro] = vagas
    
    context = {
        'proxima_data_automatica': calcular_proxima_data_promocao(),
        'vagas_por_quadro_oficiais': vagas_por_quadro_oficiais_ordenado,
        'quadros': QUADRO_CHOICES,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/oficiais_create.html', context)

@login_required
def quadro_fixacao_vagas_oficiais_detail(request, pk):
    """Detalhes de um quadro de fixa√ß√£o de vagas para oficiais"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')
    
    # Buscar itens do quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )
    
    # Agrupar por quadro
    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Estat√≠sticas
    total_vagas_fixadas = quadro.total_vagas_fixadas()
    total_vagas_disponiveis = quadro.total_vagas_disponiveis()
    
    context = {
        'quadro': quadro,
        'grupos': grupos,
        'total_vagas_fixadas': total_vagas_fixadas,
        'total_vagas_disponiveis': total_vagas_disponiveis,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/oficiais_detail.html', context)

@login_required
def assinar_quadro_fixacao_vagas(request, pk):
    """Assinar quadro de fixa√ß√£o de vagas com confirma√ß√£o de senha"""
    quadro = get_object_or_404(QuadroFixacaoVagas, pk=pk)
    
    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para assinar este quadro
    # Superusu√°rios e staff t√™m acesso total, independente de serem membros de comiss√£o
    if not request.user.is_superuser and not request.user.is_staff:
        membro_comissao = MembroComissao.objects.filter(
            usuario=request.user,
            ativo=True,
            comissao__status='ATIVA'
        ).first()
        
        if membro_comissao:
            if membro_comissao.comissao.tipo == 'CPO' and quadro.tipo != 'OFICIAIS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para assinar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
            elif membro_comissao.comissao.tipo == 'CPP' and quadro.tipo != 'PRACAS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para assinar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        observacoes = request.POST.get('observacoes', '')
        tipo_assinatura = request.POST.get('tipo_assinatura', 'APROVACAO')
        funcao_assinatura = request.POST.get('funcao_assinatura', '')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'quadro': quadro,
            }
            return render(request, 'militares/assinar_quadro_fixacao_vagas.html', context)
        
        # Verificar se j√° existe uma assinatura deste usu√°rio para este tipo
        assinatura_existente = AssinaturaQuadroFixacaoVagas.objects.filter(
            quadro_fixacao_vagas=quadro,
            assinado_por=request.user,
            tipo_assinatura=tipo_assinatura
        ).first()
        
        if assinatura_existente:
            messages.error(request, f'Voc√™ j√° assinou este quadro como "{assinatura_existente.get_tipo_assinatura_display()}".')
            context = {
                'quadro': quadro,
            }
            return render(request, 'militares/assinar_quadro_fixacao_vagas.html', context)
        
        # Usar fun√ß√£o selecionada no formul√°rio ou obter fun√ß√£o atual do usu√°rio
        if funcao_assinatura:
            funcao_atual = funcao_assinatura
        else:
            # Obter fun√ß√£o atual do usu√°rio
            from militares.models import UsuarioFuncaoMilitar
            funcao_usuario = UsuarioFuncaoMilitar.objects.filter(
                usuario=request.user,
                ativo=True
            ).first()
            
            if funcao_usuario:
                funcao_atual = funcao_usuario.funcao_militar.nome
            else:
                funcao_atual = "Usu√°rio do Sistema"
        
        # Criar a assinatura
        assinatura = AssinaturaQuadroFixacaoVagas.objects.create(
            quadro_fixacao_vagas=quadro,
            assinado_por=request.user,
            observacoes=observacoes,
            tipo_assinatura=tipo_assinatura,
            funcao_assinatura=funcao_atual
        )
        
        # Se a assinatura for de aprova√ß√£o, mudar o status do quadro para APROVADO
        if tipo_assinatura == 'APROVACAO':
            quadro.status = 'APROVADO'
            quadro.save()
        
        messages.success(request, f'Quadro de fixa√ß√£o de vagas assinado com sucesso como "{assinatura.get_tipo_assinatura_display()}"!')
        return redirect('militares:quadro_fixacao_vagas_visualizar_html', pk=quadro.pk)
    
    # Obter fun√ß√µes ativas do usu√°rio para o modal de assinatura
    from militares.models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar')
    
    # Obter fun√ß√£o atual do usu√°rio
    funcao_atual = None
    funcao_ativa = funcoes_usuario.filter(ativo=True).first()
    if funcao_ativa:
        funcao_atual = funcao_ativa.funcao_militar.nome
    
    context = {
        'quadro': quadro,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
    }
    
    return render(request, 'militares/assinar_quadro_fixacao_vagas.html', context)

@login_required
def retirar_assinatura_quadro_fixacao_vagas(request, pk, assinatura_pk):
    """Retirar assinatura do quadro de fixa√ß√£o de vagas - apenas antes da homologa√ß√£o"""
    quadro = get_object_or_404(QuadroFixacaoVagas, pk=pk)
    assinatura = get_object_or_404(AssinaturaQuadroFixacaoVagas, pk=assinatura_pk, quadro_fixacao_vagas=quadro)
    
    # Verificar se o quadro j√° foi homologado
    if quadro.status == 'HOMOLOGADO':
        messages.error(request, 'N√£o √© poss√≠vel retirar assinaturas de um quadro j√° homologado.')
        return redirect('militares:quadro_fixacao_vagas_visualizar_html', pk=quadro.pk)
    
    # Verificar se o usu√°rio √© o autor da assinatura ou tem permiss√£o administrativa
    if assinatura.assinado_por != request.user and not request.user.is_staff:
        messages.error(request, 'Voc√™ s√≥ pode retirar suas pr√≥prias assinaturas.')
        return redirect('militares:quadro_fixacao_vagas_visualizar_html', pk=quadro.pk)
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'quadro': quadro,
                'assinatura': assinatura,
            }
            return render(request, 'militares/retirar_assinatura_quadro_fixacao_vagas.html', context)
        
        # Verificar se a assinatura √© de aprova√ß√£o e se h√° outras assinaturas de aprova√ß√£o
        if assinatura.tipo_assinatura == 'APROVACAO':
            outras_aprovacoes = quadro.assinaturas.filter(
                tipo_assinatura='APROVACAO'
            ).exclude(pk=assinatura.pk).count()
            
            if outras_aprovacoes == 0:
                # Se n√£o h√° outras aprova√ß√µes, voltar o status do quadro para RASCUNHO
                quadro.status = 'RASCUNHO'
                quadro.save()
        
        # Excluir a assinatura
        assinatura.delete()
        
        messages.success(request, f'Assinatura de "{assinatura.get_tipo_assinatura_display()}" retirada com sucesso!')
        return redirect('militares:quadro_fixacao_vagas_visualizar_html', pk=quadro.pk)
    
    context = {
        'quadro': quadro,
        'assinatura': assinatura,
    }
    
    return render(request, 'militares/retirar_assinatura_quadro_fixacao_vagas.html', context)

@login_required
@cargos_especiais_required
def quadro_fixacao_vagas_delete(request, pk):
    """Exclui um quadro de fixa√ß√£o de vagas"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    if request.method == 'POST':
        try:
            quadro.delete()
            messages.success(request, 'Quadro de fixa√ß√£o de vagas exclu√≠do com sucesso!')
            return redirect('militares:quadro_fixacao_vagas_list')
        except Exception as e:
            messages.error(request, f'Erro ao excluir quadro: {str(e)}')
    
    context = {
        'quadro': quadro,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/delete.html', context)

@login_required
def quadro_fixacao_vagas_oficiais_detail(request, pk):
    """Detalhes de um quadro de fixa√ß√£o de vagas para oficiais"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')
    
    # Buscar itens do quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )
    
    # Agrupar por quadro
    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    # Estat√≠sticas
    total_vagas_fixadas = quadro.total_vagas_fixadas()
    total_vagas_disponiveis = quadro.total_vagas_disponiveis()
    
    context = {
        'quadro': quadro,
        'grupos': grupos,
        'total_vagas_fixadas': total_vagas_fixadas,
        'total_vagas_disponiveis': total_vagas_disponiveis,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/oficiais_detail.html', context)

@login_required
@cargos_especiais_required
def quadro_fixacao_vagas_oficiais_update(request, pk):
    """Atualiza um quadro de fixa√ß√£o de vagas para oficiais"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk)
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')
    
    if request.method == 'POST':
        # Atualizar dados b√°sicos do quadro
        titulo = request.POST.get('titulo')
        data_promocao = request.POST.get('data_promocao')
        observacoes = request.POST.get('observacoes', '')
        
        if titulo:
            quadro.titulo = titulo
        if data_promocao:
            try:
                quadro.data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
            except ValueError:
                messages.error(request, 'Data de promo√ß√£o inv√°lida.')
                return redirect('militares:quadro_fixacao_vagas_oficiais_update', pk=pk)
        
        quadro.observacoes = observacoes
        # Limpar assinaturas eletr√¥nicas ao editar o quadro
        quadro.assinaturas.all().delete()
        quadro.save()
        
        # Atualizar vagas fixadas
        for key, value in request.POST.items():
            if key.startswith('vagas_fixadas_'):
                item_id = key.replace('vagas_fixadas_', '')
                try:
                    item = ItemQuadroFixacaoVagas.objects.get(id=item_id, quadro=quadro)
                    vagas_fixadas = int(value) if value else 0
                    item.vagas_fixadas = vagas_fixadas
                    
                    # Buscar observa√ß√µes correspondentes
                    obs_key = f'observacoes_{item_id}'
                    observacoes_item = request.POST.get(obs_key, '')
                    item.observacoes = observacoes_item
                    
                    item.save()
                except (ItemQuadroFixacaoVagas.DoesNotExist, ValueError):
                    continue
        
        messages.success(request, 'Quadro de fixa√ß√£o de vagas atualizado com sucesso! As assinaturas eletr√¥nicas foram removidas e ser√° necess√°rio assinar novamente.')
        return redirect('militares:quadro_fixacao_vagas_oficiais_detail', pk=quadro.pk)
    
    # Buscar itens do quadro
    itens = quadro.itens.select_related('previsao_vaga').order_by(
        'previsao_vaga__quadro', 'previsao_vaga__posto'
    )
    
    # Agrupar por quadro
    grupos = {}
    for item in itens:
        previsao = item.previsao_vaga
        if previsao.quadro not in grupos:
            grupos[previsao.quadro] = {
                'nome': previsao.get_quadro_display(),
                'itens': []
            }
        grupos[previsao.quadro]['itens'].append(item)
    
    context = {
        'quadro': quadro,
        'grupos': grupos,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/oficiais_update.html', context)

@login_required
@cargos_especiais_required
def quadro_fixacao_vagas_oficiais_delete(request, pk):
    """Exclui um quadro de fixa√ß√£o de vagas para oficiais"""
    try:
        quadro = QuadroFixacaoVagas.objects.get(pk=pk, tipo='OFICIAIS')
    except QuadroFixacaoVagas.DoesNotExist:
        messages.error(request, 'Quadro de fixa√ß√£o de vagas n√£o encontrado.')
        return redirect('militares:quadro_fixacao_vagas_list')

    if request.method == 'POST':
        try:
            quadro.delete()
            messages.success(request, 'Quadro de fixa√ß√£o de vagas exclu√≠do com sucesso!')
            return redirect('militares:quadro_fixacao_vagas_list')
        except Exception as e:
            messages.error(request, f'Erro ao excluir quadro: {str(e)}')
            return redirect('militares:quadro_fixacao_vagas_oficiais_detail', pk=pk)
    
    context = {
        'quadro': quadro,
    }
    return render(request, 'militares/quadro_fixacao_vagas/oficiais_confirm_delete.html', context)

def gerar_codigo_verificacao(texto_documento):
    """
    Gera um c√≥digo de verifica√ß√£o baseado no hash SHA-256 do texto do documento.
    Retorna os primeiros 10 caracteres do hash hexadecimal.
    """
    return hashlib.sha256(texto_documento.encode('utf-8')).hexdigest()[:10]

@login_required
def proxima_numeracao_disponivel(request):
    """Retorna a pr√≥xima numera√ß√£o dispon√≠vel para um posto/quadro espec√≠fico"""
    
    if request.method == 'GET':
        posto = request.GET.get('posto')
        quadro = request.GET.get('quadro')
        
        if not posto or not quadro:
            return JsonResponse({'erro': 'Posto e quadro s√£o obrigat√≥rios'}, status=400)
        
        # Buscar todas as numera√ß√µes existentes para o posto/quadro
        numeracoes_existentes = list(Militar.objects.filter(
            classificacao='ATIVO',
            posto_graduacao=posto,
            quadro=quadro,
            numeracao_antiguidade__isnull=False
        ).values_list('numeracao_antiguidade', flat=True).order_by('numeracao_antiguidade'))
        
        # Encontrar o primeiro n√∫mero dispon√≠vel (n√£o necessariamente o maior + 1)
        proxima_numeracao = 1
        for num in numeracoes_existentes:
            if proxima_numeracao < num:
                # Encontrou um gap, usar este n√∫mero
                break
            proxima_numeracao = num + 1
        
        return JsonResponse({
            'proxima_numeracao': proxima_numeracao,
            'posto': posto,
            'quadro': quadro,
            'numeracoes_existentes': numeracoes_existentes
        })
    
    return JsonResponse({'erro': 'M√©todo n√£o permitido'}, status=405)

def reordenar_numeracoes_militares(posto):
    """
    Reordena as numera√ß√µes de antiguidade para um posto espec√≠fico,
    corrigindo apenas repeti√ß√µes e gaps, mantendo a ordem atual dos demais.
    """
    # Buscar todos os militares ativos do posto, mantendo a ordem atual
    militares = Militar.objects.filter(
        classificacao='ATIVO',
        posto_graduacao=posto
    ).order_by('numeracao_antiguidade', 'id')

    if not militares:
        return 0

    # Detectar problemas (repeti√ß√µes e gaps)
    seen = set()
    start_reorder_index = None
    expected_num = 1
    
    for idx, militar in enumerate(militares):
        current_num = militar.numeracao_antiguidade
        
        # Verificar se h√° repeti√ß√£o
        if current_num in seen:
            start_reorder_index = idx
            break
        
        # Verificar se h√° gap (n√∫mero faltando)
        if current_num != expected_num:
            start_reorder_index = idx
            break
            
        seen.add(current_num)
        expected_num += 1

    # Se n√£o houver problemas (repeti√ß√£o ou gap), n√£o faz nada
    if start_reorder_index is None:
        return 0

    # A partir do primeiro problema, reordena sequencialmente
    # Manter a ordem atual dos militares, apenas corrigindo a numera√ß√£o
    nova_numeracao = militares[start_reorder_index-1].numeracao_antiguidade + 1 if start_reorder_index > 0 else 1
    militares_para_atualizar = []
    
    for militar in militares[start_reorder_index:]:
        if militar.numeracao_antiguidade != nova_numeracao:
            militar.numeracao_antiguidade = nova_numeracao
            militares_para_atualizar.append(militar)
        nova_numeracao += 1

    if militares_para_atualizar:
        Militar.objects.bulk_update(militares_para_atualizar, ['numeracao_antiguidade'])

    return len(militares_para_atualizar)

@login_required
@requer_perm_reordenar_antiguidade
def reordenar_numeracoes_view(request):
    """View para reordenar numera√ß√µes de antiguidade por posto, baseado na data de promo√ß√£o"""
    if request.method == 'POST':
        posto = request.POST.get('posto')
        
        # Exigir que o posto seja fornecido
        if not posto:
            messages.error(request, 'O posto √© obrigat√≥rio para reordenar numera√ß√µes')
            return redirect('militares:militar_list')
        
        try:
            # Executar reordena√ß√£o baseada apenas no posto e data de promo√ß√£o
            total_atualizados = reordenar_numeracoes_militares(posto)
            
            # Contar total de militares do posto
            total_militares = Militar.objects.filter(
                classificacao='ATIVO',
                posto_graduacao=posto
            ).count()
            
            posto_display = dict(POSTO_GRADUACAO_CHOICES).get(posto, posto)
            
            if total_atualizados > 0:
                messages.success(
                    request, 
                    f'Corre√ß√µes aplicadas com sucesso para o posto {posto_display}! '
                    f'{total_atualizados} militares foram corrigidos (repeti√ß√µes e gaps removidos).'
                )
            else:
                messages.info(
                    request, 
                    f'Nenhuma corre√ß√£o necess√°ria para o posto {posto_display}. '
                    f'As numera√ß√µes j√° est√£o corretas (sem repeti√ß√µes ou gaps).'
                )
            
        except Exception as e:
            messages.error(request, f'Erro ao reordenar: {str(e)}')
        
        return redirect('militares:militar_list')
    
    return redirect('militares:militar_list')

@login_required
def aplicar_promocao_view(request):
    """View para aplicar promo√ß√£o e atribuir numera√ß√£o automaticamente"""
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        novo_posto = request.POST.get('novo_posto')
        novo_quadro = request.POST.get('novo_quadro')
        
        if not militar_id or not novo_posto or not novo_quadro:
            return JsonResponse({'erro': 'Dados incompletos para promo√ß√£o'}, status=400)
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Capturar dados anteriores
            posto_anterior = militar.posto_graduacao
            quadro_anterior = militar.quadro
            
            # Atualizar posto e quadro
            militar.posto_graduacao = novo_posto
            militar.quadro = novo_quadro
            
            # Aplicar nova numera√ß√£o por promo√ß√£o
            nova_numeracao = militar.atribuir_numeracao_por_promocao(posto_anterior, quadro_anterior)
            
            # Reordenar os militares do posto anterior (preencher gap)
            militares_reordenados = militar.reordenar_posto_anterior_apos_promocao(posto_anterior, quadro_anterior)
            
            # L√ìGICA ESPECIAL: Converter ficha de conceito quando Subtenente promove para 2¬∫ Tenente
            if posto_anterior == 'ST' and novo_posto == '2T':
                from militares.models import FichaConceitoPracas, FichaConceitoOficiais
                
                # Verificar se existe ficha de pra√ßas
                ficha_pracas = militar.fichaconceitopracas_set.first()
                if ficha_pracas:
                    # Criar nova ficha de oficiais com os dados da ficha de pra√ßas
                    ficha_oficiais = FichaConceitoOficiais.objects.create(
                        militar=militar,
                        tempo_posto=ficha_pracas.tempo_posto,
                        cursos_especializacao=ficha_pracas.cursos_especializacao,
                        cursos_cfsd=ficha_pracas.cursos_cfsd,
                        cursos_chc=ficha_pracas.cursos_chc,
                        cursos_chsgt=ficha_pracas.cursos_chsgt,
                        cursos_cas=ficha_pracas.cursos_cas,
                        cursos_cho=ficha_pracas.cursos_cho,
                        cursos_civis_superior=ficha_pracas.cursos_civis_superior,
                        cursos_civis_especializacao=ficha_pracas.cursos_civis_especializacao,
                        cursos_civis_mestrado=ficha_pracas.cursos_civis_mestrado,
                        cursos_civis_doutorado=ficha_pracas.cursos_civis_doutorado,
                        medalha_federal=ficha_pracas.medalha_federal,
                        medalha_estadual=ficha_pracas.medalha_estadual,
                        medalha_cbmepi=ficha_pracas.medalha_cbmepi,
                        elogio_individual=ficha_pracas.elogio_individual,
                        elogio_coletivo=ficha_pracas.elogio_coletivo,
                        punicao_repreensao=ficha_pracas.punicao_repreensao,
                        punicao_detencao=0,  # Campo n√£o existe em pra√ßas, usar 0
                        punicao_prisao=0,    # Campo n√£o existe em pra√ßas, usar 0
                        falta_aproveitamento=ficha_pracas.falta_aproveitamento,
                        observacoes=f"Ficha convertida automaticamente da promo√ß√£o de Subtenente para 2¬∫ Tenente. Original: {ficha_pracas.id}"
                    )
                    
                    # Remover a ficha de pra√ßas antiga
                    ficha_pracas.delete()
                    
                    # Atualizar a mensagem para incluir informa√ß√£o sobre a convers√£o
                    mensagem_adicional = " Ficha de conceito convertida de pra√ßas para oficiais."
                else:
                    mensagem_adicional = ""
            else:
                mensagem_adicional = ""
            
            # Salvar as altera√ß√µes
            militar.save()
            
            return JsonResponse({
                'sucesso': True,
                'nova_numeracao': nova_numeracao,
                'mensagem': f'Promo√ß√£o aplicada com sucesso! Nova numera√ß√£o: {nova_numeracao}¬∫. {militares_reordenados} militares foram reordenados no posto anterior.{mensagem_adicional}'
            })
            
        except Militar.DoesNotExist:
            return JsonResponse({'erro': 'Militar n√£o encontrado'}, status=404)
        except Exception as e:
            return JsonResponse({'erro': f'Erro ao aplicar promo√ß√£o: {str(e)}'}, status=500)
    
    return JsonResponse({'erro': 'M√©todo n√£o permitido'}, status=405)

@login_required
def militar_inativo_list(request):
    """Lista militares inativos (transferidos, aposentados, exonerados) - excluindo NVRR"""
    
    # Filtrar apenas militares inativos, EXCETO NVRR (que tem lista pr√≥pria)
    militares = Militar.objects.filter(
        classificacao__in=['INATIVO', 'AGREGADO', 'PRESO', 'RR', 'FALECIDO', 'LICENCIADO_A_PEDIDO', 'FUN_CIVIL', 'SAV']
    ).exclude(quadro='NVRR').order_by('posto_graduacao', 'nome_completo')
    
    # Filtros
    situacao = request.GET.get('situacao')
    if situacao:
        militares = militares.filter(classificacao=situacao)
    
    posto = request.GET.get('posto')
    if posto:
        militares = militares.filter(posto_graduacao=posto)
    
    quadro = request.GET.get('quadro')
    if quadro:
        militares = militares.filter(quadro=quadro)
    
    # Busca por nome
    busca = request.GET.get('busca')
    if busca:
        militares = militares.filter(
            models.Q(nome_completo__icontains=busca) |
            models.Q(nome_guerra__icontains=busca) |
            models.Q(matricula__icontains=busca)
        )
    
    # Estat√≠sticas
    total_inativos = militares.count()
    por_situacao = militares.values('situacao').annotate(
        count=models.Count('id')
    ).order_by('situacao')
    
    # Pagina√ß√£o
    paginator = Paginator(militares, 50)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # Importar fun√ß√µes de permiss√£o
    from .permissoes_simples import (
        pode_visualizar_inativos, pode_editar_inativos, 
        pode_reativar_inativos, pode_excluir_inativos
    )
    
    # Verificar permiss√µes espec√≠ficas para inativos
    pode_visualizar = pode_visualizar_inativos(request.user)
    pode_editar = pode_editar_inativos(request.user)
    pode_reativar = pode_reativar_inativos(request.user)
    pode_excluir = pode_excluir_inativos(request.user)
    
    context = {
        'page_obj': page_obj,
        'militares': page_obj,
        'situacoes': SITUACAO_CHOICES,
        'postos': POSTO_GRADUACAO_CHOICES,
        'quadros': QUADRO_CHOICES,
        'filtros': {
            'situacao': situacao,
            'posto': posto,
            'quadro': quadro,
            'busca': busca
        },
        'estatisticas': {
            'total': total_inativos,
            'por_situacao': por_situacao
        },
        'pode_visualizar_militares': pode_visualizar,
        'pode_editar_militares': pode_editar,
        'pode_reativar_inativos': pode_reativar,
        'pode_excluir_inativos': pode_excluir,
    }
    
    return render(request, 'militares/militar_inativo_list.html', context)

@login_required
def militar_inativo_detail(request, pk):
    """Detalhes de um militar inativo"""
    militar = get_object_or_404(Militar, pk=pk)
    
    # Verificar se √© realmente inativo
    if militar.classificacao not in ['INATIVO', 'TRANSFERIDO', 'APOSENTADO', 'EXONERADO']:
        messages.warning(request, 'Este militar n√£o est√° inativo.')
        return redirect('militares:militar_detail', pk=pk)
    
    # Buscar os mesmos dados que a view militar_detail busca
    # Busca ficha de conceito
    fichas_oficiais = list(militar.fichaconceitooficiais_set.all())
    fichas_pracas = list(militar.fichaconceitopracas_set.all())
    ficha_conceito = fichas_oficiais + fichas_pracas
    ficha_conceito.sort(key=lambda x: x.data_registro, reverse=True)
    
    # Busca promo√ß√µes
    promocoes = militar.promocao_set.all().order_by('-data_promocao')
    
    # Busca documentos
    documentos = Documento.objects.filter(militar=militar).order_by('-data_upload')
    
    # Busca lota√ß√µes
    lotacoes = militar.lotacoes.filter(ativo=True).order_by('-data_inicio', '-data_cadastro')
    
    # Verificar se h√° fun√ß√£o PRINCIPAL ativa e promover ADICIONAL se necess√°rio
    tem_principal = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='PRINCIPAL').exists()
    if not tem_principal:
        primeira_adicional = militar.funcoes.filter(ativo=True, status='ATUAL', tipo_funcao='ADICIONAL').order_by('-data_inicio', '-data_cadastro').first()
        if primeira_adicional:
            primeira_adicional.tipo_funcao = 'PRINCIPAL'
            primeira_adicional.save()
    
    # Busca fun√ß√µes - ordenar por tipo (PRINCIPAL primeiro) e depois por data
    from django.db.models import Case, When, Value, IntegerField
    funcoes = militar.funcoes.filter(ativo=True, status__in=['ATUAL', 'ANTERIOR']).annotate(
        tipo_ordem=Case(
            When(tipo_funcao='PRINCIPAL', then=Value(1)),
            When(tipo_funcao='ADICIONAL', then=Value(2)),
            When(tipo_funcao='TEMPORARIA', then=Value(3)),
            When(tipo_funcao='COMISSAO', then=Value(4)),
            default=Value(5),
            output_field=IntegerField(),
        )
    ).order_by('-status', 'tipo_ordem', '-data_inicio', '-data_cadastro')
    
    # Busca todas as fun√ß√µes (atuais e hist√≥ricas)
    funcoes_atuais = militar.funcoes.filter(status='ATUAL').order_by('-data_inicio')
    funcoes_historicas = militar.funcoes.filter(status='ANTERIOR').order_by('-data_inicio')
    todas_funcoes = militar.funcoes.all().order_by('-data_inicio')
    
    # Busca elogios e puni√ß√µes com verifica√ß√£o de permiss√£o
    from militares.permissoes_militares import pode_visualizar_punicoes_elogios, pode_editar_punicoes_elogios, pode_editar_militares
    
    elogios = []
    punicoes = []
    
    # Verificar se pode visualizar puni√ß√µes e elogios
    if pode_visualizar_punicoes_elogios(request.user, militar):
        elogios = militar.elogios.filter(ativo=True).order_by('-data_elogio', '-data_registro')
        punicoes = militar.punicoes.filter(ativo=True).order_by('-data_punicao', '-data_registro')
    
    # Busca afastamentos do militar
    from militares.models import Afastamento
    from militares.permissoes_hierarquicas import obter_funcao_militar_ativa
    from militares.filtros_hierarquicos import aplicar_filtro_hierarquico_afastamentos
    
    # Verificar se o usu√°rio √© o pr√≥prio militar (verificar tanto user.militar quanto militar.user)
    is_proprio_militar = False
    try:
        # Verificar se request.user.militar existe e √© o mesmo militar
        if hasattr(request.user, 'militar') and request.user.militar:
            is_proprio_militar = (request.user.militar.pk == militar.pk)
        # Verificar tamb√©m se militar.user existe e √© o mesmo usu√°rio
        if not is_proprio_militar and militar.user:
            is_proprio_militar = (militar.user.pk == request.user.pk)
    except Exception as e:
        # Em caso de erro, assumir que n√£o √© o pr√≥prio militar
        is_proprio_militar = False
    
    # Sempre mostrar afastamentos para o pr√≥prio militar ou superusu√°rio
    if is_proprio_militar or request.user.is_superuser:
        # O pr√≥prio militar ou superusu√°rio v√™ todos os seus afastamentos
        afastamentos = list(militar.afastamentos.all().order_by('-data_inicio', '-data_cadastro'))
    else:
        # Para outros usu√°rios, aplicar filtro hier√°rquico
        queryset = militar.afastamentos.all()
        funcao_usuario = obter_funcao_militar_ativa(request.user)
        if funcao_usuario:
            queryset = aplicar_filtro_hierarquico_afastamentos(queryset, funcao_usuario, request.user)
            afastamentos = list(queryset.order_by('-data_inicio', '-data_cadastro'))
        else:
            # Se n√£o tem fun√ß√£o ativa, n√£o mostrar afastamentos
            afastamentos = []
    
    # Garantir que afastamentos seja sempre uma lista (n√£o None)
    if afastamentos is None:
        afastamentos = []
    
    # Tipos de afastamento para o modal de certid√£o
    tipos_afastamento = Afastamento.get_all_tipo_choices()
    
    # Busca f√©rias do militar ordenadas por ano de refer√™ncia (do mais atual para o mais distante)
    # Inclui f√©rias de todos os planos, mesmo que o plano esteja em RASCUNHO
    from militares.models import Ferias, LicencaEspecial
    ferias = list(Ferias.objects.filter(militar=militar).select_related('plano', 'militar').order_by('-ano_referencia', '-data_inicio'))
    
    # Busca licen√ßas especiais do militar ordenadas por plano e data de in√≠cio (do mais atual para o mais distante)
    # IMPORTANTE: Para o regroup funcionar, precisa estar ordenado pelo campo que ser√° agrupado (plano)
    # Usar filtro direto para garantir que pegamos todas as licen√ßas
    licencas_especiais_qs = LicencaEspecial.objects.filter(militar=militar).select_related('militar', 'cadastrado_por', 'plano')
    licencas_especiais = list(licencas_especiais_qs)
    # Ordenar manualmente: primeiro por plano (para regroup funcionar), depois por data
    # None ser√° tratado como (9999, 9999) para vir por √∫ltimo quando ordenar reverso
    licencas_especiais.sort(key=lambda x: (
        x.plano.pk if x.plano else 9999,  # Agrupar por plano.pk primeiro (para regroup)
        x.plano.ano_plano if x.plano else 9999,  # Depois por ano do plano
        x.data_inicio if x.data_inicio else None,
        x.data_cadastro if x.data_cadastro else None
    ), reverse=True)
    
    # Busca cautelas de armas do militar
    from militares.models import CautelaArma, CautelaArmaColetiva
    cautelas_individuais = CautelaArma.objects.filter(militar=militar).select_related('arma', 'militar', 'entregue_por', 'devolvido_por').order_by('-data_entrega')
    cautelas_coletivas = CautelaArmaColetiva.objects.filter(responsavel=militar).select_related('responsavel', 'criado_por', 'finalizado_por').order_by('-data_inicio')
    total_cautelas = cautelas_individuais.count() + cautelas_coletivas.count()
    
    # Busca processos administrativos do militar
    from militares.models import ProcessoAdministrativo
    processos_envolvido = ProcessoAdministrativo.objects.filter(
        militares_envolvidos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_encarregado = ProcessoAdministrativo.objects.filter(
        militares_encarregados=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    processos_escriva = ProcessoAdministrativo.objects.filter(
        escrivaos=militar,
        ativo=True
    ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').order_by('-data_abertura', '-data_criacao')
    
    # Combinar todos os processos √∫nicos
    processos_ids = set()
    processos_todos = []
    
    for processo in processos_envolvido:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('envolvido', processo))
    
    for processo in processos_encarregado:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('encarregado', processo))
    
    for processo in processos_escriva:
        if processo.pk not in processos_ids:
            processos_ids.add(processo.pk)
            processos_todos.append(('escriva', processo))
    
    # Ordenar por data de abertura (mais recente primeiro)
    # Usar data_abertura se existir, sen√£o usar data_criacao
    from datetime import date
    processos_todos.sort(key=lambda x: (
        x[1].data_abertura if x[1].data_abertura else (x[1].data_criacao.date() if x[1].data_criacao else date.min)
    ), reverse=True)
    total_processos = len(processos_todos)
    
    # Extrair data de transfer√™ncia para inatividade das observa√ß√µes
    data_transferencia_inativo = None
    if militar.observacoes:
        import re
        # Procurar por padr√£o "Transferido para Inativo em DD/MM/YYYY"
        match = re.search(r'Transferido para Inativo em (\d{2}/\d{2}/\d{4})', militar.observacoes)
        if match:
            try:
                from datetime import datetime
                data_transferencia_inativo = datetime.strptime(match.group(1), '%d/%m/%Y').date()
            except ValueError:
                pass
    
    # Importar fun√ß√µes de permiss√£o
    from .permissoes_simples import (
        pode_visualizar_inativos, pode_editar_inativos, 
        pode_reativar_inativos, pode_excluir_inativos
    )
    
    # Verificar permiss√µes espec√≠ficas para inativos
    pode_visualizar = pode_visualizar_inativos(request.user)
    pode_editar = pode_editar_inativos(request.user)
    pode_reativar = pode_reativar_inativos(request.user)
    pode_excluir = pode_excluir_inativos(request.user)
    
    context = {
        'militar': militar,
        'ficha_conceito': ficha_conceito,
        'promocoes': promocoes,
        'documentos': documentos,
        'lotacoes': lotacoes,
        'funcoes': funcoes,
        'funcoes_atuais': funcoes_atuais,
        'funcoes_historicas': funcoes_historicas,
        'todas_funcoes': todas_funcoes,
        'elogios': elogios,
        'punicoes': punicoes,
        'afastamentos': afastamentos,
        'tipos_afastamento': tipos_afastamento,
        'ferias': ferias,
        'licencas_especiais': licencas_especiais,
        'averbacoes': list(militar.averbacoes.all().order_by('-data_averbacao', '-data_cadastro')),
        'cautelas_individuais': cautelas_individuais,
        'cautelas_coletivas': cautelas_coletivas,
        'total_cautelas': total_cautelas,
        'processos_todos': processos_todos,
        'total_processos': total_processos,
        'data_transferencia_inativo': data_transferencia_inativo,
        'pode_visualizar_inativos': pode_visualizar,
        'pode_editar_inativos': pode_editar,
        'pode_reativar_inativos': pode_reativar,
        'pode_excluir_inativos': pode_excluir,
        'pode_editar_punicoes_elogios': pode_editar_punicoes_elogios(request.user, militar),
        'pode_visualizar_punicoes_elogios': pode_visualizar_punicoes_elogios(request.user, militar),
        'pode_editar_militares': pode_editar_militares(request.user),
    }
    
    return render(request, 'militares/militar_detail.html', context)

@login_required
@diretor_gestao_chefe_promocoes_required
def militar_transferir_inativo(request, pk):
    """Transferir militar para situa√ß√£o inativa"""
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        data_transferencia = request.POST.get('data_transferencia')
        motivo = request.POST.get('motivo')
        
        if data_transferencia and motivo:
            try:
                # Validar data
                from datetime import datetime
                data_transferencia = datetime.strptime(data_transferencia, '%Y-%m-%d').date()
                
                # Salvar valores anteriores para hist√≥rico e restaura√ß√£o
                situacao_anterior = militar.situacao
                quadro_anterior = militar.quadro
                classificacao_anterior = militar.classificacao
                
                # Salvar quadro anterior nas observa√ß√µes para restaura√ß√£o na reativa√ß√£o
                # Formato: "QUADRO_ANTERIOR:COMB" (ser√° extra√≠do na reativa√ß√£o)
                observacao_quadro = f"\nQUADRO_ANTERIOR:{quadro_anterior}"
                
                # Calcular e salvar o tempo de servi√ßo acumulado antes de transferir para inativo
                from dateutil.relativedelta import relativedelta
                from datetime import timedelta
                
                if militar.classificacao == 'ATIVO':
                    # Se estava ativo, calcular tempo desde √∫ltima reativa√ß√£o ou desde ingresso
                    if militar.data_ultima_reativacao:
                        # Calcular tempo desde √∫ltima reativa√ß√£o (em dias exatos)
                        dias_desde_reativacao = (data_transferencia - militar.data_ultima_reativacao).days
                        # Somar com tempo acumulado anterior
                        tempo_acumulado_anterior = militar.tempo_servico_acumulado_dias or 0
                        militar.tempo_servico_acumulado_dias = tempo_acumulado_anterior + dias_desde_reativacao
                    else:
                        # Se n√£o tem data de reativa√ß√£o, calcular desde ingresso (em dias exatos)
                        dias_desde_ingresso = (data_transferencia - militar.data_ingresso).days
                        militar.tempo_servico_acumulado_dias = dias_desde_ingresso
                
                # Salvar numera√ß√£o de antiguidade anterior antes de inativar
                if militar.numeracao_antiguidade:
                    militar.numeracao_antiguidade_anterior = militar.numeracao_antiguidade
                    # Limpar numera√ß√£o atual (inativos n√£o t√™m numera√ß√£o)
                    militar.numeracao_antiguidade = None
                
                # Salvar data de inativa√ß√£o
                militar.data_ultima_inativacao = data_transferencia
                
                # Atualizar automaticamente os campos conforme solicitado
                militar.quadro = 'RESERVA_REMUNERADA'  # Quadro: Reserva Remunerada
                militar.classificacao = 'INATIVO'      # Classifica√ß√£o: Inativo
                militar.situacao = 'INATIVO'           # Situa√ß√£o: Inativo
                
                # Adicionar observa√ß√£o com hist√≥rico
                observacao_adicional = f"""
Transferido para Inativo em {data_transferencia.strftime('%d/%m/%Y')} √†s {timezone.localtime(timezone.now()).strftime('%H:%M')}.

ALTERA√á√ïES REALIZADAS:
- Quadro: {quadro_anterior} ‚Üí {militar.get_quadro_display()}
- Classifica√ß√£o: {classificacao_anterior} ‚Üí {militar.get_classificacao_display()}
- Situa√ß√£o: {situacao_anterior} ‚Üí {militar.get_situacao_display()}

MOTIVO: {motivo}

Transfer√™ncia realizada por: {request.user.get_full_name() or request.user.username}
"""
                
                militar.observacoes = f"{militar.observacoes or ''}{observacao_quadro}\n{observacao_adicional}"
                militar.save()
                
                messages.success(request, f'Militar {militar.nome_completo} transferido para inativo com sucesso!')
                messages.info(request, 'Quadro alterado para Reserva Remunerada, Classifica√ß√£o para Inativo e Situa√ß√£o para Inativo.')
                return redirect('militares:militar_inativo_detail', pk=militar.pk)
                
            except ValueError:
                messages.error(request, 'Data inv√°lida. Use o formato DD/MM/AAAA.')
        else:
            messages.error(request, 'Todos os campos s√£o obrigat√≥rios.')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_transferir_inativo.html', context)

@login_required
def militar_reativar(request, pk):
    """Reativar militar inativo"""
    militar = get_object_or_404(Militar, pk=pk)
    
    if request.method == 'POST':
        motivo = request.POST.get('motivo')
        data_retorno = request.POST.get('data_retorno')
        
        if motivo and data_retorno:
            try:
                # Validar data
                from datetime import datetime
                data_retorno = datetime.strptime(data_retorno, '%Y-%m-%d').date()
                
                # Salvar data de reativa√ß√£o
                militar.data_ultima_reativacao = data_retorno
                
                # Reativar militar
                militar.classificacao = 'ATIVO'
                
                # Restaurar quadro anterior se n√£o for RESERVA_REMUNERADA ou NVRR
                # Extrair quadro anterior das observa√ß√µes se existir
                quadro_anterior = None
                if militar.observacoes:
                    import re
                    match = re.search(r'QUADRO_ANTERIOR:(\w+)', militar.observacoes)
                    if match:
                        quadro_anterior = match.group(1)
                
                # Se n√£o encontrou nas observa√ß√µes, verificar se o quadro atual √© RESERVA_REMUNERADA
                # e tentar restaurar baseado no posto/gradua√ß√£o
                if not quadro_anterior and militar.quadro == 'RESERVA_REMUNERADA':
                    # Restaurar quadro baseado no posto/gradua√ß√£o
                    if militar.is_oficial():
                        # Oficiais: padr√£o √© COMB, mas pode ser SAUDE, ENG, COMP
                        # Tentar encontrar o quadro mais comum para o posto
                        from .models import Militar as MilitarModel
                        quadro_mais_comum = MilitarModel.objects.filter(
                            classificacao='ATIVO',
                            posto_graduacao=militar.posto_graduacao
                        ).exclude(quadro__in=['RESERVA_REMUNERADA', 'NVRR', 'PRACAS']).values('quadro').annotate(
                            count=models.Count('id')
                        ).order_by('-count').first()
                        quadro_anterior = quadro_mais_comum['quadro'] if quadro_mais_comum else 'COMB'
                    else:
                        # Pra√ßas: sempre PRACAS
                        quadro_anterior = 'PRACAS'
                
                # Restaurar quadro se encontrado (nunca restaurar para NVRR)
                if quadro_anterior and quadro_anterior not in ['RESERVA_REMUNERADA', 'NVRR']:
                    militar.quadro = quadro_anterior
                elif militar.quadro == 'NVRR':
                    # Se o quadro atual √© NVRR, restaurar baseado no posto
                    if militar.is_oficial():
                        militar.quadro = 'COMB'  # Padr√£o para oficiais
                    else:
                        militar.quadro = 'PRACAS'  # Padr√£o para pra√ßas
                
                # Restaurar numera√ß√£o de antiguidade se existir anterior
                if militar.numeracao_antiguidade_anterior:
                    # Verificar se a numera√ß√£o anterior ainda est√° dispon√≠vel
                    from .models import Militar as MilitarModel
                    numeracao_ocupada = MilitarModel.objects.filter(
                        classificacao='ATIVO',
                        posto_graduacao=militar.posto_graduacao,
                        quadro=militar.quadro,
                        numeracao_antiguidade=militar.numeracao_antiguidade_anterior
                    ).exclude(pk=militar.pk).exists()
                    
                    if not numeracao_ocupada:
                        # Restaurar numera√ß√£o anterior
                        militar.numeracao_antiguidade = militar.numeracao_antiguidade_anterior
                    else:
                        # Se a numera√ß√£o est√° ocupada, atribuir pr√≥xima dispon√≠vel
                        # Buscar a maior numera√ß√£o existente para o posto e quadro
                        from .models import Militar as MilitarModel
                        max_numeracao = MilitarModel.objects.filter(
                            classificacao='ATIVO',
                            posto_graduacao=militar.posto_graduacao,
                            quadro=militar.quadro
                        ).exclude(pk=militar.pk).aggregate(
                            models.Max('numeracao_antiguidade')
                        )['numeracao_antiguidade__max']
                        militar.numeracao_antiguidade = (max_numeracao or 0) + 1
                elif not militar.numeracao_antiguidade:
                    # Se n√£o tem numera√ß√£o anterior nem atual, atribuir pr√≥xima dispon√≠vel
                    # Buscar a maior numera√ß√£o existente para o posto e quadro
                    from .models import Militar as MilitarModel
                    max_numeracao = MilitarModel.objects.filter(
                        classificacao='ATIVO',
                        posto_graduacao=militar.posto_graduacao,
                        quadro=militar.quadro
                    ).exclude(pk=militar.pk).aggregate(
                        models.Max('numeracao_antiguidade')
                    )['numeracao_antiguidade__max']
                    militar.numeracao_antiguidade = (max_numeracao or 0) + 1
                
                militar.observacoes = f"{militar.observacoes or ''}\n\nReativado em {data_retorno.strftime('%d/%m/%Y')} √†s {timezone.now().strftime('%H:%M')}. Motivo: {motivo}"
                militar.save()
                
                messages.success(request, f'Militar {militar.nome_completo} reativado com sucesso!')
                return redirect('militares:militar_detail', pk=militar.pk)
            except ValueError:
                messages.error(request, 'Data inv√°lida. Use o formato DD/MM/AAAA.')
        else:
            messages.error(request, 'Todos os campos s√£o obrigat√≥rios.')
    
    context = {
        'militar': militar,
    }
    
    return render(request, 'militares/militar_reativar.html', context)

    class Meta:
        model = User
        fields = [
            'username', 'first_name', 'last_name', 'email',
            'is_active', 'is_staff', 'is_superuser', 'groups'
        ]
        widgets = {
            'username': forms.TextInput(attrs={'class': 'form-control'}),
            'first_name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'üîç Digite o nome do militar para buscar e preencher automaticamente...',
                'autocomplete': 'off'
            }),
            'last_name': forms.TextInput(attrs={'class': 'form-control'}),
            'email': forms.EmailInput(attrs={'class': 'form-control'}),
            'groups': forms.SelectMultiple(attrs={'class': 'form-control'}),
        }
    
    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get('password')
        confirm_password = cleaned_data.get('confirm_password')
        
        # Se √© uma cria√ß√£o de usu√°rio (n√£o tem instance.pk), senha √© obrigat√≥ria
        if not self.instance.pk:
            if not password:
                raise forms.ValidationError('Senha √© obrigat√≥ria para novos usu√°rios.')
            if not confirm_password:
                raise forms.ValidationError('Confirma√ß√£o de senha √© obrigat√≥ria para novos usu√°rios.')
        
        if password and confirm_password and password != confirm_password:
            raise forms.ValidationError('As senhas n√£o coincidem.')
        
        return cleaned_data

@login_required
@administracao_required
def usuario_create(request):
    """Criar novo usu√°rio"""
    if request.method == 'POST':
        form = UsuarioForm(request.POST)
        if form.is_valid():
            usuario = form.save(commit=False)
            password = form.cleaned_data.get('password')
            if password:
                usuario.set_password(password)
            usuario.save()
            form.save_m2m()  # Salvar grupos
            # Atribuir fun√ß√£o militar selecionada ao usu√°rio
            try:
                from .models import UsuarioFuncaoMilitar
                funcao_selecionada = form.cleaned_data.get('funcao_militar')
                if funcao_selecionada:
                    UsuarioFuncaoMilitar.objects.get_or_create(
                        usuario=usuario,
                        funcao_militar=funcao_selecionada,
                        defaults={
                            'tipo_funcao': 'PRINCIPAL',
                            'ativo': True
                        }
                    )
            except Exception:
                pass
            
            # Associar militar se fornecido
            militar_id = form.cleaned_data.get('militar_id')
            if militar_id:
                try:
                    militar = Militar.objects.get(id=militar_id)
                    # Vincular militar ao usu√°rio
                    militar.user = usuario
                    militar.save()
                    messages.success(request, f'Usu√°rio "{usuario.username}" criado com sucesso e vinculado ao militar "{militar.nome_completo}"!')
                except Militar.DoesNotExist:
                    messages.warning(request, f'Usu√°rio "{usuario.username}" criado com sucesso, mas militar n√£o encontrado.')
            else:
                messages.success(request, f'Usu√°rio "{usuario.username}" criado com sucesso!')
            
            return redirect('militares:usuarios_custom_list')
    else:
        form = UsuarioForm()
    
    context = {
        'form': form,
        'title': 'Criar Novo Usu√°rio',
        'submit_text': 'Criar Usu√°rio'
    }
    
    return render(request, 'militares/usuarios/form.html', context)

class GrupoForm(forms.ModelForm):
    """Formul√°rio para cria√ß√£o/edi√ß√£o de grupos"""
    
    class Meta:
        model = Group
        fields = ['name', 'permissions']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'permissions': forms.SelectMultiple(attrs={'class': 'form-control'}),
        }

@login_required
@administracao_required
def dashboard_permissoes(request):
    """Dashboard com estat√≠sticas do sistema de permiss√µes - REDIRECIONADO PARA P√ÅGINA UNIFICADA"""
    # Redirecionar para a p√°gina unificada de gerenciamento de permiss√µes
    return redirect('militares:funcoes_militares_list')

@login_required
def meus_votos_list(request):
    """Lista todos os votos do usu√°rio logado"""
    # Verificar se o usu√°rio √© membro de alguma comiss√£o
    membros_usuario = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True
    )
    
    if not membros_usuario.exists():
        messages.warning(request, 'Voc√™ n√£o √© membro de nenhuma comiss√£o ativa.')
        return redirect('militares:comissao_list')
    
    # Buscar todos os votos do usu√°rio
    votos = VotoDeliberacao.objects.filter(
        membro__usuario=request.user,
        membro__ativo=True
    ).select_related(
        'deliberacao__sessao__comissao',
        'membro__militar'
    ).order_by('-data_registro')
    
    # Calcular estat√≠sticas
    total_votos = votos.count()
    votos_favor = votos.filter(voto='FAVOR').count()
    votos_contra = votos.filter(voto='CONTRA').count()
    votos_abstencao = votos.filter(voto='ABSTENCAO').count()
    
    context = {
        'votos': votos,
        'total_votos': total_votos,
        'votos_favor': votos_favor,
        'votos_contra': votos_contra,
        'votos_abstencao': votos_abstencao,
        'title': 'Meus Votos',
    }
    return render(request, 'militares/comissao/deliberacoes/meus_votos_list.html', context)

@login_required
def meu_voto_detail(request, pk):
    """Visualizar detalhes de um voto espec√≠fico do usu√°rio"""
    try:
        voto = VotoDeliberacao.objects.select_related(
            'deliberacao__sessao__comissao',
            'membro__militar'
        ).get(pk=pk)
    except VotoDeliberacao.DoesNotExist:
        messages.error(request, 'Voto n√£o encontrado.')
        return redirect('militares:meus_votos_list')
    
    # Verificar se o voto pertence ao usu√°rio logado
    if voto.membro.usuario != request.user:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este voto.')
        return redirect('militares:meus_votos_list')
    
    context = {
        'voto': voto,
        'title': f'Voto - Delibera√ß√£o {voto.deliberacao.numero}',
    }
    return render(request, 'militares/comissao/deliberacoes/meu_voto_detail.html', context)

@login_required
def meu_voto_update(request, pk):
    """Editar um voto espec√≠fico do usu√°rio"""
    try:
        voto = VotoDeliberacao.objects.select_related(
            'deliberacao__sessao__comissao',
            'membro__militar'
        ).get(pk=pk)
    except VotoDeliberacao.DoesNotExist:
        messages.error(request, 'Voto n√£o encontrado.')
        return redirect('militares:meus_votos_list')
    
    # Verificar se o voto pertence ao usu√°rio logado
    if voto.membro.usuario != request.user:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar este voto.')
        return redirect('militares:meus_votos_list')
    
    # Verificar se a sess√£o ainda est√° aberta
    if voto.deliberacao.sessao.status == 'FINALIZADA':
        messages.error(request, 'N√£o √© poss√≠vel editar votos de sess√µes finalizadas.')
        return redirect('militares:meu_voto_detail', pk=voto.pk)
    
    if request.method == 'POST':
        # Obter dados do voto
        novo_voto = request.POST.get('voto')
        voto_proferido = request.POST.get('voto_proferido', '')
        senha_votante = request.POST.get('senha_votante')
        
        # Validar senha
        if not senha_votante:
            messages.error(request, 'Senha √© obrigat√≥ria para confirmar a edi√ß√£o do voto.')
            
            # Criar formul√°rio para o voto proferido com CKEditor 5
            class VotoProferidoForm(forms.Form):
                voto_proferido = forms.CharField(
                    widget=forms.Textarea(
                        attrs={
                            'placeholder': 'Digite aqui o texto do voto que voc√™ proferiu durante a sess√£o...',
                            'class': 'ckeditor5',
                            'data-config-name': 'voto_proferido_config'
                        }
                    ),
                    required=False,
                    label='Voto Proferido'
                )
            
            context = {
                'voto': voto,
                'form': VotoProferidoForm(initial={'voto_proferido': voto.voto_proferido}),
            }
            return render(request, 'militares/comissao/deliberacoes/meu_voto_form.html', context)
        
        # Validar senha do usu√°rio
        if not request.user.check_password(senha_votante):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            
            # Criar formul√°rio para o voto proferido com CKEditor 5
            class VotoProferidoForm(forms.Form):
                voto_proferido = forms.CharField(
                    widget=forms.Textarea(
                        attrs={
                            'placeholder': 'Digite aqui o texto do voto que voc√™ proferiu durante a sess√£o...',
                            'class': 'ckeditor5',
                            'data-config-name': 'voto_proferido_config'
                        }
                    ),
                    required=False,
                    label='Voto Proferido'
                )
            
            context = {
                'voto': voto,
                'form': VotoProferidoForm(initial={'voto_proferido': voto.voto_proferido}),
            }
            return render(request, 'militares/comissao/deliberacoes/meu_voto_form.html', context)
        
        if not novo_voto:
            messages.error(request, 'Voc√™ deve escolher uma op√ß√£o de voto.')
            
            # Criar formul√°rio para o voto proferido com CKEditor 5
            class VotoProferidoForm(forms.Form):
                voto_proferido = forms.CharField(
                    widget=forms.Textarea(
                        attrs={
                            'placeholder': 'Digite aqui o texto do voto que voc√™ proferiu durante a sess√£o...',
                            'class': 'ckeditor5',
                            'data-config-name': 'voto_proferido_config'
                        }
                    ),
                    required=False,
                    label='Voto Proferido'
                )
            
            context = {
                'voto': voto,
                'form': VotoProferidoForm(initial={'voto_proferido': voto.voto_proferido}),
            }
            return render(request, 'militares/comissao/deliberacoes/meu_voto_form.html', context)
        
        # Atualizar voto
        voto.voto = novo_voto
        voto.voto_proferido = voto_proferido
        # Limpar assinatura eletr√¥nica ao editar o voto
        voto.assinado = False
        voto.data_assinatura = None
        voto.funcao_assinatura = ''
        voto.tipo_assinatura = ''
        voto.observacoes_assinatura = ''
        voto.save()
        
        # Atualizar contadores da delibera√ß√£o
        votos_favor = voto.deliberacao.votos.filter(voto='FAVOR').count()
        votos_contra = voto.deliberacao.votos.filter(voto='CONTRA').count()
        votos_abstencao = voto.deliberacao.votos.filter(voto='ABSTENCAO').count()
        
        voto.deliberacao.votos_favor = votos_favor
        voto.deliberacao.votos_contra = votos_contra
        voto.deliberacao.votos_abstencao = votos_abstencao
        voto.deliberacao.save()
        
        messages.success(request, f'‚úÖ Voto atualizado com sucesso!')
        return redirect('militares:voto_visualizar_assinar', pk=voto.pk)
    
    # Criar formul√°rio para o voto proferido com CKEditor 5 (mesmo das atas)
    
    class VotoProferidoForm(forms.Form):
        voto_proferido = forms.CharField(
            widget=forms.Textarea(
                attrs={
                    'placeholder': 'Digite aqui o texto do voto que voc√™ proferiu durante a sess√£o...',
                    'class': 'ckeditor5',
                    'data-config-name': 'voto_proferido_config'
                }
            ),
            required=False,
            label='Voto Proferido'
        )
    
    form = VotoProferidoForm(initial={
        'voto_proferido': voto.voto_proferido
    })
    
    context = {
        'voto': voto,
        'form': form,
        'title': f'Editar Voto - Delibera√ß√£o {voto.deliberacao.numero}',
    }
    return render(request, 'militares/comissao/deliberacoes/meu_voto_form.html', context)

@login_required
def meu_voto_delete(request, pk):
    """Excluir um voto espec√≠fico do usu√°rio"""
    try:
        voto = VotoDeliberacao.objects.select_related(
            'deliberacao__sessao__comissao',
            'membro__militar'
        ).get(pk=pk)
    except VotoDeliberacao.DoesNotExist:
        messages.error(request, 'Voto n√£o encontrado.')
        return redirect('militares:meus_votos_list')
    
    # Verificar se o voto pertence ao usu√°rio logado
    if voto.membro.usuario != request.user:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir este voto.')
        return redirect('militares:meus_votos_list')
    
    # Verificar se a sess√£o ainda est√° aberta
    if voto.deliberacao.sessao.status == 'FINALIZADA':
        messages.error(request, 'N√£o √© poss√≠vel excluir votos de sess√µes finalizadas.')
        return redirect('militares:meu_voto_detail', pk=voto.pk)
    
    if request.method == 'POST':
        # Salvar refer√™ncias antes de excluir
        deliberacao = voto.deliberacao
        
        # Excluir o voto
        voto.delete()
        
        # Atualizar contadores da delibera√ß√£o
        votos_favor = deliberacao.votos.filter(voto='FAVOR').count()
        votos_contra = deliberacao.votos.filter(voto='CONTRA').count()
        votos_abstencao = deliberacao.votos.filter(voto='ABSTENCAO').count()
        
        deliberacao.votos_favor = votos_favor
        deliberacao.votos_contra = votos_contra
        deliberacao.votos_abstencao = votos_abstencao
        deliberacao.save()
        
        messages.success(request, '‚úÖ Voto exclu√≠do com sucesso!')
        return redirect('militares:meus_votos_list')
    
    context = {
        'voto': voto,
        'title': f'Excluir Voto - Delibera√ß√£o {voto.deliberacao.numero}',
    }
    return render(request, 'militares/comissao/deliberacoes/meu_voto_confirm_delete.html', context)

@login_required
def status_efetivo_vagas(request):
    """Mostra o status do efetivo atual e permite atualiza√ß√£o manual das vagas"""
    from .signals import atualizar_todas_vagas_efetivo
    
    # Contar militares por posto e quadro
    efetivo_por_posto_quadro = {}
    militares_ativos = Militar.objects.filter(classificacao='ATIVO')
    
    for militar in militares_ativos:
        key = f"{militar.get_posto_graduacao_display()} - {militar.get_quadro_display()}"
        if key not in efetivo_por_posto_quadro:
            efetivo_por_posto_quadro[key] = {
                'posto': militar.posto_graduacao,
                'quadro': militar.quadro,
                'efetivo_atual': 0,
                'militares': []
            }
        efetivo_por_posto_quadro[key]['efetivo_atual'] += 1
        efetivo_por_posto_quadro[key]['militares'].append(militar)
    
    # Buscar vagas existentes
    vagas = Vaga.objects.all().order_by('posto', 'quadro')
    vagas_dict = {}
    for vaga in vagas:
        key = f"{vaga.get_posto_display()} - {vaga.get_quadro_display()}"
        vagas_dict[key] = vaga
    
    # Buscar previs√µes existentes
    previsoes = PrevisaoVaga.objects.filter(ativo=True).order_by('posto', 'quadro')
    previsoes_dict = {}
    for previsao in previsoes:
        key = f"{previsao.get_posto_display()} - {previsao.get_quadro_display()}"
        previsoes_dict[key] = previsao
    
    # Processar atualiza√ß√£o se solicitado
    if request.method == 'POST' and 'atualizar_efetivo' in request.POST:
        try:
            resultado = atualizar_todas_vagas_efetivo()
            messages.success(
                request, 
                f"Efetivo atualizado com sucesso! "
                f"Militares processados: {resultado['militares_processados']}, "
                f"Vagas criadas: {resultado['vagas_criadas']}, "
                f"Vagas atualizadas: {resultado['vagas_atualizadas']}, "
                f"Previs√µes atualizadas: {resultado['previsoes_atualizadas']}"
            )
            return redirect('militares:status_efetivo_vagas')
        except Exception as e:
            messages.error(request, f"Erro ao atualizar efetivo: {str(e)}")
    
    context = {
        'efetivo_por_posto_quadro': efetivo_por_posto_quadro,
        'vagas_dict': vagas_dict,
        'previsoes_dict': previsoes_dict,
        'total_militares_ativos': militares_ativos.count(),
        'total_vagas': vagas.count(),
        'total_previsoes': previsoes.count(),
    }
    
    return render(request, 'militares/status_efetivo_vagas.html', context)

@login_required
@requer_perm_reordenar_antiguidade
def reordenar_antiguidade_apos_inativacao(request):
    """View para reordenar numera√ß√µes de antiguidade ap√≥s inativa√ß√µes"""
    if request.method == 'POST':
        posto = request.POST.get('posto')
        quadro = request.POST.get('quadro')
        
        try:
            # Executar reordena√ß√£o
            total_reordenados = Militar.reordenar_todos_apos_inativacao(
                posto_graduacao=posto if posto else None,
                quadro=quadro if quadro else None
            )
            
            messages.success(
                request, 
                f'Reordena√ß√£o conclu√≠da com sucesso! {total_reordenados} militares foram reordenados.'
            )
            
        except Exception as e:
            messages.error(request, f'Erro ao reordenar: {str(e)}')
        
        return redirect('militares:status_efetivo_vagas')
    
    # GET - mostrar formul√°rio
    context = {
        'postos': POSTO_GRADUACAO_CHOICES,
        'quadros': QUADRO_CHOICES,
    }
    
    return render(request, 'militares/reordenar_antiguidade_apos_inativacao.html', context)

@login_required
def promocao_subtenente_view(request):
    """View espec√≠fica para promo√ß√£o de subtenentes do quadro pra√ßas para complementar"""
    if request.method == 'POST':
        militar_id = request.POST.get('militar_id')
        data_promocao = request.POST.get('data_promocao')
        
        if not militar_id or not data_promocao:
            messages.error(request, 'Militar e data de promo√ß√£o s√£o obrigat√≥rios.')
            return redirect('militares:militar_list')
        
        try:
            from datetime import datetime
            data_promocao = datetime.strptime(data_promocao, '%Y-%m-%d').date()
        except ValueError:
            messages.error(request, 'Data de promo√ß√£o inv√°lida.')
            return redirect('militares:militar_list')
        
        try:
            militar = Militar.objects.get(pk=militar_id)
            
            # Verificar se √© subtenente do quadro pra√ßas
            if militar.posto_graduacao != 'ST' or militar.quadro != 'PRACAS':
                messages.error(request, 'Apenas subtenentes do quadro pra√ßas podem ser promovidos.')
                return redirect('militares:militar_detail', pk=militar_id)
            
            # Verificar se est√° apto para promo√ß√£o
            if not militar.apto_promocao_antiguidade():
                messages.error(request, 'Militar n√£o est√° apto para promo√ß√£o. Verifique inspe√ß√£o de sa√∫de, interst√≠cio e cursos obrigat√≥rios.')
                return redirect('militares:militar_detail', pk=militar_id)
            
            # Capturar dados anteriores
            posto_anterior = militar.posto_graduacao
            quadro_anterior = militar.quadro
            
            # Atualizar posto e quadro
            militar.posto_graduacao = '2T'  # 2¬∫ Tenente
            militar.quadro = 'COMP'  # Complementar
            militar.data_promocao_atual = data_promocao
            
            # Aplicar nova numera√ß√£o por promo√ß√£o
            nova_numeracao = militar.atribuir_numeracao_por_promocao(posto_anterior, quadro_anterior)
            
            # Reordenar os militares do posto anterior (preencher gap)
            militares_reordenados = militar.reordenar_posto_anterior_apos_promocao(posto_anterior, quadro_anterior)
            
            # L√ìGICA ESPECIAL: Converter ficha de conceito quando Subtenente promove para 2¬∫ Tenente
            ficha_oficiais, mensagem_conversao = militar.converter_ficha_pracas_para_oficiais(
                motivo_conversao="Promo√ß√£o de Subtenente para 2¬∫ Tenente"
            )
            
            if ficha_oficiais:
                mensagem_adicional = " Ficha de conceito convertida de pra√ßas para oficiais."
            else:
                mensagem_adicional = f" {mensagem_conversao}"
            
            # Salvar as altera√ß√µes
            militar.save()
            
            # Registrar a promo√ß√£o no hist√≥rico
            from militares.models import Promocao
            Promocao.objects.create(
                militar=militar,
                posto_anterior=posto_anterior,
                posto_novo='2T',
                criterio='ANTIGUIDADE',
                data_promocao=data_promocao,
                data_publicacao=data_promocao,
                numero_ato='Promo√ß√£o autom√°tica via sistema',
                observacoes=f'Promo√ß√£o de Subtenente (Pra√ßas) para 2¬∫ Tenente (Complementar). Nova numera√ß√£o: {nova_numeracao}¬∫.{mensagem_adicional}'
            )
            
            messages.success(
                request, 
                f'Promo√ß√£o realizada com sucesso! {militar.nome_completo} foi promovido de Subtenente (Pra√ßas) para 2¬∫ Tenente (Complementar) com a {nova_numeracao}¬™ numera√ß√£o de antiguidade. {militares_reordenados} militares foram reordenados no posto anterior.{mensagem_adicional}'
            )
            
            return redirect('militares:militar_detail', pk=militar_id)
            
        except Militar.DoesNotExist:
            messages.error(request, 'Militar n√£o encontrado.')
            return redirect('militares:militar_list')
        except Exception as e:
            messages.error(request, f'Erro ao realizar promo√ß√£o: {str(e)}')
            return redirect('militares:militar_detail', pk=militar_id)
    
    # GET - mostrar formul√°rio de promo√ß√£o
    militar_id = request.GET.get('militar_id')
    if not militar_id:
        messages.error(request, 'ID do militar √© obrigat√≥rio.')
        return redirect('militares:militar_list')
    
    try:
        militar = Militar.objects.get(pk=militar_id)
        
        # Verificar se √© subtenente do quadro pra√ßas
        if militar.posto_graduacao != 'ST' or militar.quadro != 'PRACAS':
            messages.error(request, 'Apenas subtenentes do quadro pra√ßas podem ser promovidos.')
            return redirect('militares:militar_detail', pk=militar_id)
        
        # Verificar se est√° apto para promo√ß√£o
        apto_promocao = militar.apto_promocao_antiguidade()
        
        # Calcular pr√≥xima data de promo√ß√£o
        from datetime import date
        hoje = date.today()
        proxima_data = date(hoje.year, 7, 18) if hoje < date(hoje.year, 7, 18) else date(hoje.year, 12, 25)
        
        context = {
            'militar': militar,
            'apto_promocao': apto_promocao,
            'proxima_data': proxima_data,
        }
        
        return render(request, 'militares/promocao_subtenente.html', context)
        
    except Militar.DoesNotExist:
        messages.error(request, 'Militar n√£o encontrado.')
        return redirect('militares:militar_list')

@login_required
@administracao_required
def replicar_funcoes_ativas(request):
    """Replica fun√ß√µes ativas para todos os usu√°rios, removendo fun√ß√µes antigas"""
    if request.method == 'POST':
        from django.core.management import call_command
        from io import StringIO
        import sys
        
        # Capturar output do comando
        old_stdout = sys.stdout
        sys.stdout = captured_output = StringIO()
        
        try:
            # Executar comando de replica√ß√£o
            call_command('replicar_funcoes_ativas', '--forcar')
            output = captured_output.getvalue()
            
            # Dividir output em linhas para exibir
            linhas = output.split('\n')
            messages.success(request, 'Replica√ß√£o de fun√ß√µes ativas executada com sucesso!')
            
            # Adicionar detalhes do output
            for linha in linhas:
                if linha.strip() and not linha.startswith('=== '):
                    messages.info(request, linha.strip())
                    
        except Exception as e:
            messages.error(request, f'Erro ao executar replica√ß√£o: {str(e)}')
        finally:
            sys.stdout = old_stdout
        
        return redirect('militares:usuarios_custom_list')
    
    # Se GET, mostrar p√°gina de confirma√ß√£o
    funcoes_ativas = FuncaoMilitar.objects.filter(ativo=True).count()
    usuarios_ativos = User.objects.filter(is_active=True).count()
    
    context = {
        'funcoes_ativas': funcoes_ativas,
        'usuarios_ativos': usuarios_ativos,
    }
    
    return render(request, 'militares/usuarios/replicar_funcoes.html', context)

@login_required
@administracao_required
def usuarios_custom_list(request):
    # Par√¢metros de filtro
    query = request.GET.get('q', '').strip()
    status = request.GET.get('status', '')
    grupo = request.GET.get('grupo', '')
    ordenacao = request.GET.get('ordenacao', 'nome')
    
    # Query base
    usuarios = User.objects.all().select_related('militar').prefetch_related('groups', 'funcoes_militares')
    
    # Aplicar filtros
    if query:
        usuarios = usuarios.filter(
            Q(first_name__icontains=query) |
            Q(last_name__icontains=query) |
            Q(username__icontains=query) |
            Q(email__icontains=query) |
            Q(militar__nome_completo__icontains=query)
        )
    
    if status == 'ativo':
        usuarios = usuarios.filter(is_active=True)
    elif status == 'inativo':
        usuarios = usuarios.filter(is_active=False)
    
    if grupo:
        usuarios = usuarios.filter(groups__name__icontains=grupo)
    
    # Aplicar ordena√ß√£o
    if ordenacao == 'nome':
        usuarios = usuarios.order_by('first_name', 'last_name')
    elif ordenacao == 'username':
        usuarios = usuarios.order_by('username')
    elif ordenacao == 'email':
        usuarios = usuarios.order_by('email')
    elif ordenacao == 'data_criacao':
        usuarios = usuarios.order_by('-date_joined')
    elif ordenacao == 'status':
        usuarios = usuarios.order_by('-is_active', 'first_name')
    else:
        usuarios = usuarios.order_by('first_name', 'last_name')
    
    # Buscar militar e fun√ß√µes/cargos
    usuarios_info = []
    for usuario in usuarios:
        militar = getattr(usuario, 'militar', None)
        funcoes_militar = []
        if militar:
            membros_comissao = MembroComissao.objects.filter(militar=militar, ativo=True)
            funcoes_militar = [membro.get_tipo_display() for membro in membros_comissao]
        
        # Fun√ß√µes diretas do usu√°rio
        funcoes_usuario = usuario.funcoes_militares.all().order_by('funcao_militar__nome')
        
        usuarios_info.append({
            'usuario': usuario,
            'militar': militar,
            'funcoes_militar': funcoes_militar,
            'funcoes_usuario': funcoes_usuario,
        })
    
    # Estat√≠sticas
    total_usuarios = User.objects.count()
    usuarios_ativos = User.objects.filter(is_active=True).count()
    usuarios_inativos = User.objects.filter(is_active=False).count()
    
    # Grupos dispon√≠veis para filtro
    grupos_disponiveis = Group.objects.all().order_by('name')
    
    context = {
        'usuarios_info': usuarios_info,
        'query': query,
        'status': status,
        'grupo': grupo,
        'ordenacao': ordenacao,
        'total_usuarios': total_usuarios,
        'usuarios_ativos': usuarios_ativos,
        'usuarios_inativos': usuarios_inativos,
        'grupos_disponiveis': grupos_disponiveis,
        'resultados_count': len(usuarios_info),
    }
    return render(request, 'militares/usuarios/custom_list.html', context)

@login_required
@administracao_required
def usuario_detail(request, pk):
    """Detalhes de um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    
    # Buscar militar vinculado
    militar = getattr(usuario, 'militar', None)
    funcoes_militar = []
    
    if militar:
        membros_comissao = MembroComissao.objects.filter(militar=militar, ativo=True)
        funcoes_militar = [membro.get_tipo_display() for membro in membros_comissao]
    
    # Fun√ß√µes diretas do usu√°rio
    funcoes_usuario = usuario.funcoes_militares.filter(ativo=True).order_by('funcao_militar__nome')
    
    # Permiss√µes do usu√°rio
    permissoes_usuario = usuario.user_permissions.all()
    permissoes_grupos = []
    for grupo in usuario.groups.all():
        permissoes_grupo = grupo.permissions.all()
        permissoes_grupos.extend(permissoes_grupo)
    permissoes_grupos = list(set(permissoes_grupos))
    
    context = {
        'usuario': usuario,
        'militar': militar,
        'funcoes_militar': funcoes_militar,
        'funcoes_usuario': funcoes_usuario,
        'permissoes_usuario': permissoes_usuario,
        'permissoes_grupos': permissoes_grupos,
    }
    return render(request, 'militares/usuarios/detail.html', context)

# Views para gerenciamento de permiss√µes

@login_required
@administracao_required
def usuario_update(request, pk):
    """Editar um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    
    if request.method == 'POST':
        # Formul√°rio simples para editar dados b√°sicos
        username = request.POST.get('username', '').strip()
        first_name = request.POST.get('first_name', '')
        last_name = request.POST.get('last_name', '')
        email = request.POST.get('email', '')
        is_active = request.POST.get('is_active') == 'on'
        
        # Validar username
        if not username:
            messages.error(request, 'O username √© obrigat√≥rio.')
            return render(request, 'militares/usuarios/update.html', {'usuario': usuario})
        if User.objects.filter(username=username).exclude(pk=usuario.pk).exists():
            messages.error(request, 'J√° existe usu√°rio com esse username.')
            return render(request, 'militares/usuarios/update.html', {'usuario': usuario})

        usuario.username = username
        usuario.first_name = first_name
        usuario.last_name = last_name
        usuario.email = email
        usuario.is_active = is_active
        usuario.save()
        
        messages.success(request, f'Usu√°rio {usuario.get_full_name()} atualizado com sucesso!')
        return redirect('militares:usuarios_custom_list')
    
    context = {
        'usuario': usuario,
    }
    return render(request, 'militares/usuarios/update.html', context)

@login_required
@administracao_required
def usuario_delete(request, pk):
    """Excluir um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    
    if request.method == 'POST':
        nome_usuario = usuario.get_full_name()
        usuario.delete()
        messages.success(request, f'Usu√°rio {nome_usuario} exclu√≠do com sucesso!')
        return redirect('militares:usuarios_custom_list')
    
    context = {
        'usuario': usuario,
    }
    return render(request, 'militares/usuarios/delete.html', context)

# Views para gerenciar fun√ß√µes dos usu√°rios
@login_required
@administracao_required
def usuario_funcoes_list(request, pk):
    """Lista todas as fun√ß√µes militares de um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    funcoes = usuario.funcoes_militares.all().order_by('funcao_militar__nome')
    
    # Estat√≠sticas
    funcoes_ativas = funcoes.filter(ativo=True)
    funcoes_inativas = funcoes.filter(ativo=False)
    
    context = {
        'usuario': usuario,
        'funcoes': funcoes,
        'funcoes_ativas': funcoes_ativas,
        'funcoes_inativas': funcoes_inativas,
        'funcoes_suspensas': [],  # N√£o aplic√°vel para fun√ß√µes militares
    }
    return render(request, 'militares/usuarios/funcoes/list.html', context)


# Views para sele√ß√£o de fun√ß√£o ap√≥s login
def selecionar_funcao(request):
    """
    View para selecionar fun√ß√£o/cargo ap√≥s login
    """
    if not request.user.is_authenticated:
        return redirect('login')
    
    # Superusu√°rios v√£o direto para o dashboard
    if request.user.is_superuser:
        return redirect('militares:home')
    
    # Importar sistema de sincroniza√ß√£o
    from .sincronizar_funcoes_militar import sincronizar_funcoes_militar, obter_funcoes_militar_logado
    
    # Sincronizar fun√ß√µes do militar logado
    resultado_sincronizacao = sincronizar_funcoes_militar(request.user)
    
    if not resultado_sincronizacao['sucesso']:
        messages.error(request, f'Erro ao carregar fun√ß√µes: {resultado_sincronizacao["mensagem"]}')
        return redirect('logout')
    
    # Verificar se j√° tem uma fun√ß√£o ativa
    funcao_ativa = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True
    ).first()
    
    if funcao_ativa:
        # Se j√° tem fun√ß√£o ativa, redirecionar para dashboard
        return redirect('militares:home')
    
    # Buscar fun√ß√µes do usu√°rio (agora sincronizadas com a ficha do militar)
    funcoes_usuario = obter_funcoes_militar_logado(request.user)
    
    # Se n√£o tem fun√ß√µes, redireciona para erro
    if funcoes_usuario.count() == 0:
        messages.error(request, 'Voc√™ n√£o possui fun√ß√µes ativas cadastradas na sua ficha militar.')
        return redirect('logout')
    
    # Se s√≥ tem uma fun√ß√£o, seleciona automaticamente
    if funcoes_usuario.count() == 1:
        funcao = funcoes_usuario.first()
        
        # Desativar todas as fun√ß√µes do usu√°rio (tirar de "em andamento")
        UsuarioFuncaoMilitar.objects.filter(usuario=request.user).update(ativo=False)
        
        # Ativar a fun√ß√£o selecionada (colocar "em andamento")
        funcao.ativo = True
        funcao.save()
        
        # Desativar sess√µes anteriores
        from militares.models import UsuarioSessao
        UsuarioSessao.objects.filter(usuario=request.user, ativo=True).update(ativo=False)
        
        # Criar nova sess√£o
        sessao = UsuarioSessao.objects.create(
            usuario=request.user,
            funcao_militar_usuario=funcao
        )
        
        # Verificar se tem lota√ß√£o definida
        lotacao = sessao.get_nivel_lotacao()
        if lotacao and lotacao != "Sem lota√ß√£o definida":
            messages.success(request, f'Fun√ß√£o atual definida automaticamente: {funcao.funcao_militar.nome} - Lota√ß√£o: {lotacao}')
        else:
            messages.success(request, f'Fun√ß√£o atual definida automaticamente: {funcao.funcao_militar.nome}')
        
        return redirect('militares:home')
    
    if request.method == 'POST':
        funcao_id = request.POST.get('funcao_id')
        if funcao_id:
            try:
                funcao = funcoes_usuario.get(id=funcao_id)
                
                # Desativar todas as fun√ß√µes do usu√°rio (tirar de "em andamento")
                UsuarioFuncaoMilitar.objects.filter(usuario=request.user).update(ativo=False)
                
                # Ativar a fun√ß√£o selecionada (colocar "em andamento")
                funcao.ativo = True
                funcao.save()
                
                # Desativar sess√µes anteriores
                from militares.models import UsuarioSessao
                UsuarioSessao.objects.filter(usuario=request.user, ativo=True).update(ativo=False)
                
                # Criar nova sess√£o
                sessao = UsuarioSessao.objects.create(
                    usuario=request.user,
                    funcao_militar_usuario=funcao
                )
                
                # Verificar se tem lota√ß√£o definida
                lotacao = sessao.get_nivel_lotacao()
                if lotacao and lotacao != "Sem lota√ß√£o definida":
                    messages.success(request, f'Fun√ß√£o atual definida: {funcao.funcao_militar.nome} - Lota√ß√£o: {lotacao}')
                else:
                    messages.success(request, f'Fun√ß√£o atual definida: {funcao.funcao_militar.nome}')
                
                print(f"DEBUG - Redirecionando para dashboard ap√≥s definir fun√ß√£o: {funcao.funcao_militar.nome}")
                return redirect('militares:home')
            except UsuarioFuncaoMilitar.DoesNotExist:
                messages.error(request, 'Fun√ß√£o inv√°lida selecionada.')
    
    context = {
        'funcoes': funcoes_usuario,
        'usuario': request.user,
    }
    return render(request, 'militares/usuarios/selecionar_funcao.html', context)

@csrf_exempt
@require_http_methods(["POST"])
def trocar_funcao_ajax(request):
    """
    View para trocar fun√ß√£o via AJAX
    Agora trabalha diretamente com MilitarFuncao
    """
    if not request.user.is_authenticated:
        return JsonResponse({'success': False, 'message': 'Usu√°rio n√£o autenticado'})
    
    try:
        data = json.loads(request.body)
        funcao_id = data.get('funcao_id')
        
        if not funcao_id:
            return JsonResponse({'success': False, 'message': 'ID da fun√ß√£o √© obrigat√≥rio'})
        
        # Verificar se o usu√°rio tem militar associado
        if not hasattr(request.user, 'militar') or not request.user.militar:
            return JsonResponse({'success': False, 'message': 'Usu√°rio n√£o possui militar associado'})
        
        # Buscar a fun√ß√£o do militar
        from militares.models import MilitarFuncao, UsuarioSessao, UsuarioFuncaoMilitar
        
        funcao_militar = MilitarFuncao.objects.get(
            id=funcao_id,
            militar=request.user.militar,
            status='ATUAL',
            ativo=True
        )
        
        # Obter lota√ß√£o atual do militar
        lotacao_atual = request.user.militar.lotacao_atual()
        
        # Buscar lota√ß√£o do militar para configurar os campos de acesso
        from militares.models import Lotacao
        lotacao_obj = Lotacao.objects.filter(
            militar=request.user.militar,
            status='ATUAL',
            ativo=True
        ).first()
        
        # Criar ou atualizar UsuarioFuncaoMilitar para compatibilidade com o sistema de sess√µes
        usuario_funcao, created = UsuarioFuncaoMilitar.objects.get_or_create(
            usuario=request.user,
            funcao_militar=funcao_militar.funcao_militar,
            defaults={
                'tipo_funcao': funcao_militar.tipo_funcao,
                'nivel_acesso': funcao_militar.funcao_militar.acesso,  # Usar o acesso da fun√ß√£o militar
                'orgao': lotacao_obj.orgao if lotacao_obj else None,
                'grande_comando': lotacao_obj.grande_comando if lotacao_obj else None,
                'unidade': lotacao_obj.unidade if lotacao_obj else None,
                'sub_unidade': lotacao_obj.sub_unidade if lotacao_obj else None,
                'ativo': True,
            }
        )
        
        if not created:
            # Atualizar fun√ß√£o existente
            usuario_funcao.tipo_funcao = funcao_militar.tipo_funcao
            usuario_funcao.nivel_acesso = funcao_militar.funcao_militar.acesso  # Atualizar tamb√©m o n√≠vel de acesso
            usuario_funcao.orgao = lotacao_obj.orgao if lotacao_obj else None
            usuario_funcao.grande_comando = lotacao_obj.grande_comando if lotacao_obj else None
            usuario_funcao.unidade = lotacao_obj.unidade if lotacao_obj else None
            usuario_funcao.sub_unidade = lotacao_obj.sub_unidade if lotacao_obj else None
            usuario_funcao.ativo = True
            usuario_funcao.save()
        
        # Desativar todas as outras fun√ß√µes do usu√°rio
        UsuarioFuncaoMilitar.objects.filter(
            usuario=request.user
        ).exclude(id=usuario_funcao.id).update(ativo=False)
        
        # Desativar sess√µes anteriores
        UsuarioSessao.objects.filter(usuario=request.user, ativo=True).update(ativo=False)
        
        # Criar nova sess√£o
        sessao = UsuarioSessao.objects.create(
            usuario=request.user,
            funcao_militar_usuario=usuario_funcao
        )
        
        # Atualizar sess√£o do Django com informa√ß√µes da fun√ß√£o
        request.session['funcao_atual_id'] = usuario_funcao.id
        request.session['funcao_atual_nome'] = funcao_militar.funcao_militar.nome
        request.session['sessao_militar_id'] = sessao.id
        
        # For√ßar atualiza√ß√£o do menu marcando a sess√£o como modificada
        request.session.modified = True
        
        # Verificar se tem lota√ß√£o definida
        lotacao = request.user.militar.lotacao_atual()
        
        # Atualizar informa√ß√µes de lota√ß√£o na sess√£o
        if lotacao and lotacao != "Sem lota√ß√£o definida":
            request.session['funcao_lotacao'] = str(lotacao)
        else:
            request.session.pop('funcao_lotacao', None)
        
        # Obter permiss√µes da nova fun√ß√£o para debug
        funcao_militar_obj = funcao_militar.funcao_militar
        menu_permissions = funcao_militar_obj.get_menu_permissions()
        
        print(f"[TROCA] Fun√ß√£o alterada para: {funcao_militar_obj.nome}")
        print(f"   - Dashboard: {menu_permissions.get('show_dashboard', False)}")
        print(f"   - Efetivo: {menu_permissions.get('show_efetivo', False)}")
        print(f"   - Se√ß√£o Promo√ß√µes: {menu_permissions.get('show_secao_promocoes', False)}")
        print(f"   - Administra√ß√£o: {menu_permissions.get('show_administracao', False)}")
        
        return JsonResponse({
            'success': True,
            'message': f'Fun√ß√£o alterada para: {funcao_militar_obj.nome}',
            'funcao_nome': funcao_militar_obj.nome,
            'lotacao': str(lotacao) if lotacao and lotacao != "Sem lota√ß√£o definida" else None,
            'sessao_id': sessao.id,
            'sincronizacao': {
                'funcoes_criadas': 1 if created else 0,
                'funcoes_atualizadas': 0 if created else 1,
                'funcoes_desativadas': 0
            }
        })
        
    except MilitarFuncao.DoesNotExist:
        return JsonResponse({'success': False, 'message': 'Fun√ß√£o n√£o encontrada'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro: {str(e)}'})

def trocar_funcao(request):
    """
    View para trocar fun√ß√£o durante a sess√£o
    """
    if not request.user.is_authenticated:
        return redirect('login')
    
    # Buscar fun√ß√µes ativas do usu√°rio
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar')
    
    if request.method == 'POST':
        funcao_id = request.POST.get('funcao_id')
        if funcao_id:
            try:
                funcao = funcoes_usuario.get(id=funcao_id)
                request.session['funcao_atual_id'] = funcao.id
                request.session['funcao_atual_nome'] = funcao.funcao_militar.nome
                request.session['funcoes_disponiveis'] = list(funcoes_usuario.values('id', 'funcao_militar__nome'))
                messages.success(request, f'Fun√ß√£o alterada para: {funcao.funcao_militar.nome}')
                return redirect(request.POST.get('next', 'militares:militar_dashboard'))
            except UsuarioFuncaoMilitar.DoesNotExist:
                messages.error(request, 'Fun√ß√£o inv√°lida selecionada.')
    
    context = {
        'funcoes': funcoes_usuario,
        'usuario': request.user,
        'funcao_atual_id': request.session.get('funcao_atual_id'),
        'next': request.GET.get('next', 'militares:militar_dashboard'),
    }
    return render(request, 'militares/usuarios/trocar_funcao.html', context)

def obter_funcao_atual(request):
    """
    Fun√ß√£o helper para obter a fun√ß√£o atual da sess√£o
    """
    if not request.user.is_authenticated:
        return None
    
    funcao_id = request.session.get('funcao_atual_id')
    if funcao_id:
        try:
            return UsuarioFuncaoMilitar.objects.get(id=funcao_id, usuario=request.user)
        except UsuarioFuncaoMilitar.DoesNotExist:
            # Se a fun√ß√£o n√£o existe mais, limpa a sess√£o
            request.session.pop('funcao_atual_id', None)
            request.session.pop('funcao_atual_nome', None)
    
    return None

@login_required
@csrf_protect
def alterar_senha(request):
    """View para alterar senha do usu√°rio logado"""
    if request.method == 'POST':
        form = AlterarSenhaForm(request.user, request.POST)
        if form.is_valid():
            form.save()
            # Atualizar a sess√£o para n√£o deslogar o usu√°rio
            update_session_auth_hash(request, form.user)
            messages.success(request, '‚úÖ Senha alterada com sucesso!')
            return redirect('militares:usuario_detail', pk=request.user.pk)
    else:
        form = AlterarSenhaForm(request.user)
    
    context = {
        'form': form,
        'usuario': request.user,
        'ensino_tipo': request.session.get('ensino_tipo'),
        'ensino_id': request.session.get('ensino_id'),
        'requer_senha_atual': request.user.has_usable_password(),
    }
    return render(request, 'militares/usuarios/alterar_senha.html', context)

@login_required
@admin_or_gerenciar_usuarios_required
def alterar_senha_usuario(request, pk):
    """View para administradores alterarem senha de outros usu√°rios"""
    usuario = get_object_or_404(User, pk=pk)
    
    if request.method == 'POST':
        form = AlterarSenhaAdminForm(usuario, request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, f'‚úÖ Senha do usu√°rio {usuario.get_full_name()} alterada com sucesso!')
            return redirect('militares:usuario_detail', pk=usuario.pk)
    else:
        form = AlterarSenhaAdminForm(usuario)
    
    context = {
        'form': form,
        'usuario': usuario,
        'usuario_alvo': usuario,
    }
    return render(request, 'militares/usuarios/alterar_senha_admin.html', context)

class AlterarSenhaForm(forms.Form):
    """Formul√°rio para alterar senha"""
    senha_atual = forms.CharField(
        label='Senha Atual',
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Digite sua senha atual'
        }),
        strip=False
    )
    nova_senha1 = forms.CharField(
        label='Nova Senha',
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Digite a nova senha'
        }),
        strip=False
    )
    nova_senha2 = forms.CharField(
        label='Confirmar Nova Senha',
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Confirme a nova senha'
        }),
        strip=False
    )

    def __init__(self, user, *args, **kwargs):
        self.user = user
        super().__init__(*args, **kwargs)
        # Se o usu√°rio n√£o possui senha utiliz√°vel, n√£o exigir senha atual
        if not self.user.has_usable_password():
            self.fields['senha_atual'].required = False

    def clean_senha_atual(self):
        senha_atual = self.cleaned_data.get('senha_atual')
        # Apenas validar quando o usu√°rio possui senha utiliz√°vel
        if self.user.has_usable_password():
            if not senha_atual or not self.user.check_password(senha_atual):
                raise forms.ValidationError('Senha atual incorreta.')
        return senha_atual

    def clean(self):
        cleaned_data = super().clean()
        nova_senha1 = cleaned_data.get('nova_senha1')
        nova_senha2 = cleaned_data.get('nova_senha2')

        if nova_senha1 and nova_senha2:
            if nova_senha1 != nova_senha2:
                raise forms.ValidationError('As senhas n√£o coincidem.')
            
            # Validar a nova senha
            try:
                validate_password(nova_senha2, self.user)
            except ValidationError as e:
                raise forms.ValidationError(e.messages[0])

        return cleaned_data

    def save(self, commit=True):
        nova_senha = self.cleaned_data['nova_senha1']
        self.user.set_password(nova_senha)
        if commit:
            self.user.save()
        return self.user

class AlterarSenhaAdminForm(forms.Form):
    """Formul√°rio para administradores alterarem senha de outros usu√°rios"""
    nova_senha1 = forms.CharField(
        label='Nova Senha',
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Digite a nova senha'
        }),
        strip=False
    )
    nova_senha2 = forms.CharField(
        label='Confirmar Nova Senha',
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Confirme a nova senha'
        }),
        strip=False
    )

    def __init__(self, user, *args, **kwargs):
        self.user = user
        super().__init__(*args, **kwargs)

    def clean(self):
        cleaned_data = super().clean()
        nova_senha1 = cleaned_data.get('nova_senha1')
        nova_senha2 = cleaned_data.get('nova_senha2')

        if nova_senha1 and nova_senha2:
            if nova_senha1 != nova_senha2:
                raise forms.ValidationError('As senhas n√£o coincidem.')
            
            # Validar a nova senha
            try:
                validate_password(nova_senha2, self.user)
            except ValidationError as e:
                raise forms.ValidationError(e.messages[0])

        return cleaned_data

    def save(self, commit=True):
        nova_senha = self.cleaned_data['nova_senha1']
        self.user.set_password(nova_senha)
        if commit:
            self.user.save()
        return self.user

from django.contrib.auth.models import Group, Permission
from django.contrib.auth.decorators import login_required, permission_required
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib import messages

@login_required
def buscar_funcao_militar(request):
    """Busca a fun√ß√£o/cargo do militar para preenchimento autom√°tico"""
    militar_id = request.GET.get('militar_id')
    
    if not militar_id:
        return JsonResponse({'error': 'ID do militar n√£o fornecido'}, status=400)
    
    try:
        militar = Militar.objects.get(pk=militar_id)
        
        # Buscar fun√ß√£o do militar atrav√©s do usu√°rio vinculado
        funcao_militar = None
        if militar.user:
            # Buscar fun√ß√£o ativa do usu√°rio
            funcao_usuario = UsuarioFuncaoMilitar.objects.filter(
                usuario=militar.user,
                ativo=True
            ).select_related('funcao_militar').first()
            
            if funcao_usuario:
                funcao_militar = {
                    'id': funcao_usuario.funcao_militar.id,
                    'nome': funcao_usuario.funcao_militar.nome,
                    'tipo': funcao_usuario.get_tipo_funcao_display()
                }
        
        # Se n√£o encontrou fun√ß√£o via usu√°rio, buscar todas as fun√ß√µes do usu√°rio
        if not funcao_militar and militar.user:
            # Buscar todas as fun√ß√µes ativas do usu√°rio
            funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
                usuario=militar.user,
                status='AT'
            ).select_related('funcao_militar').order_by('funcao_militar__nome')
            
            if funcoes_usuario.exists():
                # Se h√° m√∫ltiplas fun√ß√µes, retornar a primeira como padr√£o
                funcao_usuario = funcoes_usuario.first()
                funcao_militar = {
                    'id': funcao_usuario.funcao_militar.id,
                    'nome': funcao_usuario.funcao_militar.nome,
                    'tipo': funcao_usuario.get_tipo_funcao_display()
                }
        
        return JsonResponse({
            'success': True,
            'funcao': funcao_militar,
            'militar': {
                'id': militar.id,
                'nome': militar.nome_completo,
                'posto': militar.get_posto_graduacao_display(),
                'matricula': militar.matricula
            }
        })
        
    except Militar.DoesNotExist:
        return JsonResponse({'error': 'Militar n√£o encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'error': f'Erro ao buscar fun√ß√£o: {str(e)}'}, status=500)

@login_required
def buscar_funcoes_usuario(request):
    """Busca as fun√ß√µes/cargos do usu√°rio para permitir escolha"""
    usuario_id = request.GET.get('usuario_id')
    
    if not usuario_id:
        return JsonResponse({'error': 'ID do usu√°rio n√£o fornecido'}, status=400)
    
    try:
        usuario = User.objects.get(pk=usuario_id)
        
        # Buscar todas as fun√ß√µes ativas do usu√°rio
        funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
            usuario=usuario,
            status='AT'
        ).select_related('funcao_militar').order_by('funcao_militar__nome')
        
        funcoes = []
        for funcao in funcoes_usuario:
            funcoes.append({
                'id': funcao.funcao_militar.id,
                'nome': funcao.funcao_militar.nome,
                'tipo': funcao.get_tipo_funcao_display(),
                'descricao': funcao.funcao_militar.descricao or '',
                'data_inicio': funcao.data_inicio.strftime('%d/%m/%Y'),
                'data_fim': funcao.data_fim.strftime('%d/%m/%Y') if funcao.data_fim else None
            })
        
        return JsonResponse({
            'success': True,
            'funcoes': funcoes,
            'usuario': {
                'id': usuario.id,
                'nome': usuario.get_full_name(),
                'username': usuario.username
            }
        })
        
    except User.DoesNotExist:
        return JsonResponse({'error': 'Usu√°rio n√£o encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'error': f'Erro ao buscar fun√ß√µes: {str(e)}'}, status=500)

@login_required
def voto_deliberacao_delete(request, voto_pk):
    """Excluir voto de uma delibera√ß√£o"""
    try:
        voto = VotoDeliberacao.objects.get(pk=voto_pk)
        deliberacao = voto.deliberacao
        sessao = deliberacao.sessao
        comissao = sessao.comissao
    except VotoDeliberacao.DoesNotExist:
        messages.error(request, 'Voto n√£o encontrado.')
        return redirect('militares:comissao_list')
    
    # Verificar se o usu√°rio logado √© o autor do voto ou tem permiss√£o
    if voto.membro.usuario != request.user:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir este voto.')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    if request.method == 'POST':
        # Verificar se a senha foi fornecida
        senha_votante = request.POST.get('senha_votante')
        if not senha_votante:
            messages.error(request, 'Senha √© obrigat√≥ria para confirmar a exclus√£o.')
            return redirect('militares:voto_deliberacao_create', deliberacao_pk=deliberacao.pk)
        
        # Validar senha do usu√°rio
        if not request.user.check_password(senha_votante):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            return redirect('militares:voto_deliberacao_create', deliberacao_pk=deliberacao.pk)
        
        # Excluir o voto
        voto.delete()
        
        # Atualizar contadores da delibera√ß√£o
        votos_favor = deliberacao.votos.filter(voto='FAVOR').count()
        votos_contra = deliberacao.votos.filter(voto='CONTRA').count()
        votos_abstencao = deliberacao.votos.filter(voto='ABSTENCAO').count()
        
        deliberacao.votos_favor = votos_favor
        deliberacao.votos_contra = votos_contra
        deliberacao.votos_abstencao = votos_abstencao
        deliberacao.save()
        
        messages.success(request, '‚úÖ Voto exclu√≠do com sucesso!')
        return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
    
    context = {
        'voto': voto,
        'deliberacao': deliberacao,
        'sessao': sessao,
        'comissao': comissao,
    }
    return render(request, 'militares/comissao/deliberacoes/voto_delete.html', context)

@login_required
def assinar_ata_eletronica(request, pk):
    """Processar assinatura eletr√¥nica da ata"""
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'})
    
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        
        # Verificar se o usu√°rio √© membro da comiss√£o
        membro = MembroComissao.objects.filter(
            comissao=sessao.comissao,
            usuario=request.user,
            ativo=True
        ).first()
        
        if not membro:
            return JsonResponse({
                'success': False,
                'error': 'Voc√™ n√£o √© membro desta comiss√£o.'
            })
        
        # Buscar a ata da sess√£o
        try:
            ata = AtaSessao.objects.get(sessao=sessao)
        except AtaSessao.DoesNotExist:
            return JsonResponse({
                'success': False,
                'error': 'Ata n√£o encontrada para esta sess√£o.'
            })
        
        # Verificar se a ata est√° para assinatura
        if ata.status != 'PARA_ASSINATURA':
            return JsonResponse({
                'success': False,
                'error': 'Ata n√£o est√° dispon√≠vel para assinatura.'
            })
        
        # Processar dados da assinatura
        import json
        dados = json.loads(request.body)
        
        hash_documento = dados.get('hash')
        timestamp = dados.get('timestamp')
        assinatura_digital = dados.get('assinatura')
        certificado = dados.get('certificado')
        assinante = dados.get('assinante')
        data_assinatura = dados.get('data_assinatura')
        
        # Validar dados obrigat√≥rios (certificado pode ser 'ASSINATURA_SIMPLES_SEI' para assinatura simples)
        if not all([hash_documento, timestamp, assinatura_digital, assinante]):
            return JsonResponse({
                'success': False,
                'error': 'Dados de assinatura incompletos.'
            })
        
        # Criar registro de assinatura
        from .models import AssinaturaAta
        
        # Buscar o membro da comiss√£o
        membro = MembroComissao.objects.get(
            comissao=sessao.comissao,
            usuario=request.user,
            ativo=True
        )
        
        # Capturar a fun√ß√£o atual do usu√°rio na sess√£o
        funcao_atual = request.session.get('funcao_atual_nome', 'Usu√°rio do Sistema')
        
        # Verificar se j√° existe uma assinatura para este membro nesta ata
        assinatura_criada = False
        try:
            assinatura = AssinaturaAta.objects.get(ata=ata, membro=membro)
            # Atualizar a assinatura existente com os novos dados eletr√¥nicos
            assinatura.hash_documento = hash_documento
            assinatura.timestamp = timestamp
            assinatura.assinatura_digital = assinatura_digital
            assinatura.certificado = certificado or 'ASSINATURA_SIMPLES_SEI'
            assinatura.ip_assinatura = request.META.get('REMOTE_ADDR', '')
            assinatura.user_agent = request.META.get('HTTP_USER_AGENT', '')
            assinatura.assinado_por = request.user
            assinatura.funcao_assinatura = funcao_atual
            assinatura.save()
        except AssinaturaAta.DoesNotExist:
            # Criar nova assinatura
            assinatura = AssinaturaAta.objects.create(
                ata=ata,
                membro=membro,
                assinado_por=request.user,
                hash_documento=hash_documento,
                timestamp=timestamp,
                assinatura_digital=assinatura_digital,
                certificado=certificado or 'ASSINATURA_SIMPLES_SEI',
                ip_assinatura=request.META.get('REMOTE_ADDR', ''),
                user_agent=request.META.get('HTTP_USER_AGENT', ''),
                funcao_assinatura=funcao_atual
            )
            assinatura_criada = True
        
        # Verificar se todos os membros presentes assinaram
        membros_presentes = sessao.presencas.filter(presente=True)
        assinaturas_realizadas = AssinaturaAta.objects.filter(ata=ata)
        
        if assinaturas_realizadas.count() >= membros_presentes.count():
            # Todos assinaram, marcar ata como assinada
            ata.status = 'ASSINADA'
            ata.save()
            
            acao = 'assinado' if assinatura_criada else 'atualizado'
            return JsonResponse({
                'success': True,
                'message': f'Documento {acao} com sucesso! Ata marcada como assinada.',
                'ata_status': 'ASSINADA'
            })
        else:
            acao = 'assinado' if assinatura_criada else 'atualizado'
            return JsonResponse({
                'success': True,
                'message': f'Documento {acao} com sucesso! Aguardando outras assinaturas.',
                'ata_status': 'PARA_ASSINATURA',
                'assinaturas_restantes': membros_presentes.count() - assinaturas_realizadas.count()
            })
        
    except SessaoComissao.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Sess√£o n√£o encontrada.'
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': f'Erro ao processar assinatura: {str(e)}'
        })

@login_required
def ata_assinaturas_eletronicas(request, pk):
    """P√°gina para visualizar assinaturas eletr√¥nicas da ata no formato SEI"""
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        
        # Verificar se o usu√°rio √© membro da comiss√£o
        membro = MembroComissao.objects.filter(
            comissao=sessao.comissao,
            usuario=request.user,
            ativo=True
        ).first()
        
        if not membro:
            messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
        
        # Buscar a ata da sess√£o
        try:
            ata = AtaSessao.objects.get(sessao=sessao)
        except AtaSessao.DoesNotExist:
            messages.error(request, 'Ata n√£o encontrada para esta sess√£o.')
            return redirect('militares:sessao_comissao_detail', pk=sessao.pk)
        
        # Buscar assinaturas eletr√¥nicas
        assinaturas = AssinaturaAta.objects.filter(ata=ata).order_by('data_assinatura')
        
        context = {
            'sessao': sessao,
            'comissao': sessao.comissao,
            'ata': ata,
            'assinaturas': assinaturas,
            'membro_usuario': membro,
        }
        
        return render(request, 'militares/comissao/sessoes/ata_assinaturas_eletronicas.html', context)
        
    except SessaoComissao.DoesNotExist:
        messages.error(request, 'Sess√£o n√£o encontrada.')
        return redirect('militares:comissao_list')
    except Exception as e:
        messages.error(request, f'Erro ao carregar assinaturas: {str(e)}')
        return redirect('militares:sessao_comissao_detail', pk=pk)

@login_required
def quadro_fixacao_vagas_visualizar_html(request, pk):
    quadro = get_object_or_404(QuadroFixacaoVagas, pk=pk)
    
    # Verificar se o usu√°rio √© membro de alguma comiss√£o e tem permiss√£o para visualizar este quadro
    # Superusu√°rios e staff t√™m acesso total, independente de serem membros de comiss√£o
    if not request.user.is_superuser and not request.user.is_staff:
        membro_comissao = MembroComissao.objects.filter(
            usuario=request.user,
            ativo=True,
            comissao__status='ATIVA'
        ).first()
        
        if membro_comissao:
            if membro_comissao.comissao.tipo == 'CPO' and quadro.tipo != 'OFICIAIS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
            elif membro_comissao.comissao.tipo == 'CPP' and quadro.tipo != 'PRACAS':
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar este quadro.')
                return redirect('militares:quadro_fixacao_vagas_list')
    assinaturas = quadro.assinaturas.filter(assinado_por__isnull=False).order_by('-data_assinatura')
    
    # Agrupar itens por quadro e ordenar por hierarquia
    itens_por_quadro = {}
    for item in quadro.itens.all().select_related('previsao_vaga'):
        quadro_nome = item.previsao_vaga.quadro
        if quadro_nome not in itens_por_quadro:
            itens_por_quadro[quadro_nome] = []
        itens_por_quadro[quadro_nome].append(item)
    
    # Definir hierarquia dos postos (do mais alto para o mais baixo)
    hierarquia_postos = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
        'ST': 9,   # Subtenente
        '1S': 10,  # 1¬∫ Sargento
        '2S': 11,  # 2¬∫ Sargento
        '3S': 12,  # 3¬∫ Sargento
        'CAB': 13, # Cabo
        'SD': 14,  # Soldado
    }
    
    # Ordenar itens por hierarquia (posto) dentro de cada quadro
    for quadro_nome in itens_por_quadro:
        itens_por_quadro[quadro_nome].sort(
            key=lambda x: hierarquia_postos.get(x.previsao_vaga.posto, 999)
        )
    
    # Ordenar quadros na sequ√™ncia hier√°rquica: COMB, SAUDE, ENG, COMP
    ordem_quadros = ['COMB', 'SAUDE', 'ENG', 'COMP']
    itens_por_quadro_ordenado = {}
    
    # Primeiro, adicionar os quadros na ordem hier√°rquica
    for cod_quadro in ordem_quadros:
        if cod_quadro in itens_por_quadro:
            itens_por_quadro_ordenado[cod_quadro] = itens_por_quadro[cod_quadro]
    
    # Depois, adicionar outros quadros que possam existir
    for cod_quadro, itens in itens_por_quadro.items():
        if cod_quadro not in itens_por_quadro_ordenado:
            itens_por_quadro_ordenado[cod_quadro] = itens
    
    itens_por_quadro = itens_por_quadro_ordenado
    
    # Obter fun√ß√µes ativas do usu√°rio para o modal de assinatura
    from militares.models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar')
    
    # Obter fun√ß√£o atual do usu√°rio
    funcao_atual = None
    funcao_ativa = funcoes_usuario.filter(ativo=True).first()
    if funcao_ativa:
        funcao_atual = funcao_ativa.funcao_militar.nome
    
    context = {
        'quadro': quadro,
        'assinaturas': assinaturas,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
        'itens_por_quadro': itens_por_quadro,
    }
    
    return render(request, 'militares/quadro_fixacao_vagas/visualizar.html', context)

@login_required
def ata_assinar_melhorada(request, pk):
    """Assinar ata seguindo o padr√£o dos quadros de acesso"""
    
    try:
        ata = AtaSessao.objects.get(sessao_id=pk)
    except AtaSessao.DoesNotExist:
        messages.error(request, 'Ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Verificar se o usu√°rio √© membro da comiss√£o
    try:
        membro = MembroComissao.objects.get(
            comissao=ata.sessao.comissao,
            usuario=request.user,
            ativo=True
        )
    except MembroComissao.DoesNotExist:
        messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    if request.method == 'POST':
        # Processar assinatura
        membro_id = request.POST.get('membro_id')
        observacoes = request.POST.get('observacoes', '').strip()
        senha = request.POST.get('senha')
        
        if not membro_id:
            messages.error(request, 'Selecione um membro para assinar.')
            return redirect('militares:ata_assinar_melhorada', pk=pk)
        
        if not senha:
            messages.error(request, 'Digite sua senha para confirmar a assinatura.')
            return redirect('militares:ata_assinar_melhorada', pk=pk)
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta.')
            return redirect('militares:ata_assinar_melhorada', pk=pk)
        
        try:
            membro_para_assinar = MembroComissao.objects.get(id=membro_id)
            # Verificar se o membro estava presente
            if not ata.sessao.presencas.filter(membro=membro_para_assinar, presente=True).exists():
                messages.error(request, 'Apenas membros presentes podem assinar a ata.')
                return redirect('militares:ata_assinar_melhorada', pk=pk)
            
            # Verificar se j√° n√£o assinou
            if ata.assinaturas.filter(membro=membro_para_assinar).exists():
                messages.error(request, 'Este membro j√° assinou a ata.')
                return redirect('militares:ata_assinar_melhorada', pk=pk)
            
            # Capturar a fun√ß√£o atual do usu√°rio na sess√£o
            funcao_atual = request.session.get('funcao_atual_nome', 'Usu√°rio do Sistema')
            
            # Criar assinatura
            assinatura = AssinaturaAta.objects.create(
                ata=ata,
                membro=membro_para_assinar,
                assinado_por=request.user,
                observacoes=observacoes,
                funcao_assinatura=funcao_atual
            )
            
            messages.success(request, f'Assinatura de {membro_para_assinar.militar.nome_completo} registrada com sucesso!')
            
            # Verificar se todos assinaram
            membros_presentes = ata.sessao.presencas.filter(presente=True).count()
            assinaturas_count = ata.assinaturas.count()
            
            if assinaturas_count >= membros_presentes:
                ata.status = 'ASSINADA'
                ata.save()
                messages.info(request, 'Todos os membros presentes assinaram a ata!')
            
            return redirect('militares:ata_assinar_melhorada', pk=pk)
            
        except MembroComissao.DoesNotExist:
            messages.error(request, 'Membro n√£o encontrado.')
    
    # Obter membros presentes e suas assinaturas
    membros_presentes = ata.sessao.presencas.filter(presente=True).select_related('membro__militar', 'membro__cargo')
    assinaturas = ata.assinaturas.select_related('membro__militar', 'assinado_por')
    
    context = {
        'ata': ata,
        'sessao': ata.sessao,
        'comissao': ata.sessao.comissao,
        'membros_presentes': membros_presentes,
        'assinaturas': assinaturas,
        'membro_usuario': membro,
    }
    return render(request, 'militares/comissao/sessoes/ata_assinaturas_melhorada.html', context)

@login_required
def assinar_ata_html(request, pk):
    """Assinar ata via modal"""
    from .models import AtaSessao, AssinaturaAta
    
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        ata = AtaSessao.objects.get(sessao=sessao)
    except (SessaoComissao.DoesNotExist, AtaSessao.DoesNotExist):
        messages.error(request, 'Sess√£o ou ata n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        tipo_assinatura = request.POST.get('tipo_assinatura', 'APROVACAO')
        observacoes = request.POST.get('observacoes', '')
        funcao_assinatura = request.POST.get('funcao_assinatura', '')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
        
        # Verificar se o usu√°rio √© membro da comiss√£o
        membro = MembroComissao.objects.filter(
            comissao=sessao.comissao,
            usuario=request.user,
            ativo=True
        ).first()
        
        if not membro:
            messages.error(request, 'Voc√™ n√£o √© membro desta comiss√£o.')
            return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
        
        # Verificar se j√° existe uma assinatura deste membro nesta ata
        assinatura_existente = AssinaturaAta.objects.filter(
            ata=ata,
            membro=membro
        ).first()
        
        if assinatura_existente:
            messages.error(request, f'Voc√™ j√° assinou esta ata como "{assinatura_existente.get_tipo_assinatura_display()}".')
            return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
        
        # Usar a fun√ß√£o selecionada pelo usu√°rio ou fun√ß√£o padr√£o
        if not funcao_assinatura:
            funcao_assinatura = request.session.get('funcao_atual_nome', 'Usu√°rio do Sistema')
        
        # Criar assinatura
        assinatura = AssinaturaAta.objects.create(
            ata=ata,
            membro=membro,
            assinado_por=request.user,
            funcao_assinatura=funcao_assinatura,
            tipo_assinatura=tipo_assinatura,
            observacoes=observacoes,
            ip_assinatura=request.META.get('REMOTE_ADDR', ''),
            user_agent=request.META.get('HTTP_USER_AGENT', '')
        )
        
        messages.success(request, 'Ata assinada com sucesso!')
        return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
    
    messages.error(request, 'M√©todo n√£o permitido.')
    return redirect('militares:sessao_gerar_ata', pk=sessao.pk)

@login_required
def retirar_assinatura_ata(request, pk, assinatura_pk):
    """Retirar assinatura da ata - apenas antes da finaliza√ß√£o"""
    from .models import AtaSessao, AssinaturaAta
    
    try:
        sessao = SessaoComissao.objects.get(pk=pk)
        ata = AtaSessao.objects.get(sessao=sessao)
        assinatura = AssinaturaAta.objects.get(pk=assinatura_pk, ata=ata)
    except (SessaoComissao.DoesNotExist, AtaSessao.DoesNotExist, AssinaturaAta.DoesNotExist):
        messages.error(request, 'Sess√£o, ata ou assinatura n√£o encontrada.')
        return redirect('militares:sessao_comissao_detail', pk=pk)
    
    # Verificar se a ata j√° foi finalizada
    if ata.status == 'FINALIZADA':
        messages.error(request, 'N√£o √© poss√≠vel retirar assinaturas de uma ata j√° finalizada.')
        return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
    
    # Verificar se o usu√°rio √© o autor da assinatura ou tem permiss√£o administrativa
    if assinatura.assinado_por != request.user and not request.user.is_staff:
        messages.error(request, 'Voc√™ s√≥ pode retirar suas pr√≥prias assinaturas.')
        return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'sessao': sessao,
                'ata': ata,
                'assinatura': assinatura,
            }
            return render(request, 'militares/retirar_assinatura_ata.html', context)
        
        # Verificar se a assinatura √© de aprova√ß√£o e se h√° outras assinaturas de aprova√ß√£o
        if assinatura.tipo_assinatura == 'APROVACAO':
            outras_aprovacoes = ata.assinaturas.filter(
                tipo_assinatura='APROVACAO'
            ).exclude(pk=assinatura.pk).count()
            
            if outras_aprovacoes == 0:
                # Se n√£o h√° outras aprova√ß√µes, voltar o status da ata para PARA_ASSINATURA
                ata.status = 'PARA_ASSINATURA'
                ata.save()
        
        # Excluir a assinatura
        assinatura.delete()
        
        messages.success(request, f'Assinatura de "{assinatura.get_tipo_assinatura_display()}" retirada com sucesso!')
        
        # Redirecionar de volta para a p√°gina de onde veio
        next_url = request.GET.get('next')
        if next_url:
            return redirect(next_url)
        else:
            return redirect('militares:sessao_gerar_ata', pk=sessao.pk)
    
    context = {
        'sessao': sessao,
        'ata': ata,
        'assinatura': assinatura,
    }
    
    return render(request, 'militares/retirar_assinatura_ata.html', context)
from django.http import FileResponse
from reportlab.platypus import SimpleDocTemplate, Image, Spacer, Paragraph, Table, TableStyle, HRFlowable
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm
from reportlab.lib import colors
from io import BytesIO
import os
from django.contrib.auth.decorators import login_required
from django.shortcuts import redirect
from django.contrib import messages

@login_required
def voto_deliberacao_pdf(request, pk):
    """Gera PDF do voto individual, incluindo assinatura eletr√¥nica no padr√£o dos quadros"""
    from .models import VotoDeliberacao
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    import qrcode
    import locale
    from datetime import datetime

    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar

    try:
        voto = VotoDeliberacao.objects.select_related(
            'deliberacao__sessao__comissao',
            'membro__militar',
            'membro__usuario'
        ).get(pk=pk)
    except VotoDeliberacao.DoesNotExist:
        messages.error(request, 'Voto n√£o encontrado.')
        return redirect('militares:meus_votos_list')

    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()

    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6)

    story = []

    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        f"{voto.deliberacao.sessao.comissao.nome.upper()} - CBMEPI-PI",
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # T√≠tulo centralizado e sublinhado
    titulo = '<u>VOTO PROFERIDO EM DELIBERA√á√ÉO DE COMISS√ÉO</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 16))

    # Informa√ß√µes do voto (alinhadas √† esquerda)
    info_data = [
        [Paragraph('<b>Delibera√ß√£o:</b>', style_bold), Paragraph(f"{voto.deliberacao.numero} - {voto.deliberacao.assunto}", styles['Normal'])],
        [Paragraph('<b>Comiss√£o:</b>', style_bold), Paragraph(voto.deliberacao.sessao.comissao.nome, styles['Normal'])],
        [Paragraph('<b>Data da Sess√£o:</b>', style_bold), Paragraph(voto.deliberacao.sessao.data_sessao.strftime('%d/%m/%Y'), styles['Normal'])],
        [Paragraph('<b>Membro:</b>', style_bold), Paragraph(voto.membro.militar.nome_completo, styles['Normal'])],
        [Paragraph('<b>Fun√ß√£o:</b>', style_bold), Paragraph(voto.funcao_assinatura or 'Membro da Comiss√£o', styles['Normal'])],
        [Paragraph('<b>Op√ß√£o de Voto:</b>', style_bold), Paragraph(voto.get_voto_display(), styles['Normal'])],
    ]
    info_table = Table(info_data, colWidths=[4*cm, 11*cm], hAlign='LEFT')
    info_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
        ('ALIGN', (0, 0), (0, -1), 'LEFT'),
        ('ALIGN', (1, 0), (1, -1), 'LEFT'),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('LEFTPADDING', (0, 0), (-1, -1), 0),
        ('RIGHTPADDING', (0, 0), (-1, -1), 0),
    ]))
    story.append(info_table)
    story.append(Spacer(1, 40))

    # Voto proferido (espa√ßamento 1,15 e justificado)
    if voto.voto_proferido:
        story.append(Paragraph('<b>Voto Proferido:</b>', style_bold))
        story.append(Spacer(1, 4))
        # Criar estilo com espa√ßamento 1,15 e justificado
        style_voto = ParagraphStyle('voto', parent=styles['Normal'], leading=15, alignment=4)
        story.append(Paragraph(voto.voto_proferido, style_voto))
        story.append(Spacer(1, 40))

    # Cidade, UF e Data (igual ao template)
    story.append(Spacer(1, 20))
    
    # Mapear meses para portugu√™s
    meses = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
        5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
        9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    data_registro = voto.data_registro
    dia = data_registro.day
    mes = meses[data_registro.month]
    ano = data_registro.year
    
    data_texto = f"Teresina - PI, {dia} de {mes} de {ano}."
    story.append(Paragraph(f"<center>{data_texto}</center>", style_center))
    story.append(Spacer(1, 20))
    
    # Assinatura F√≠sica (igual ao template)
    story.append(Paragraph(f"<center><b>{voto.membro.militar.nome_completo}</b></center>", style_center))
    story.append(Spacer(1, 4))
    
    funcao_assinatura = voto.funcao_assinatura or "Membro da Comiss√£o"
    story.append(Paragraph(f"<center><font size='10' color='#888888'>{funcao_assinatura}</font></center>", style_center))
    story.append(Spacer(1, 2))
    story.append(Paragraph("<center><font size='8'><b>Voto</b></font></center>", style_center))
    story.append(Spacer(1, 20))

    # Assinatura Eletr√¥nica (padr√£o dos quadros) - NO FINAL DA FOLHA
    if voto.assinado and voto.data_assinatura:
        # Informa√ß√µes de assinatura eletr√¥nica
        nome_assinante = voto.membro.militar.nome_completo
        
        # Se o usu√°rio tem militar associado, incluir posto com BM
        if hasattr(voto.membro.militar, 'get_posto_graduacao_display'):
            posto = voto.membro.militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_assinante = f"{posto} {voto.membro.militar.nome_completo}"
        
        # Data e hora da assinatura
        from django.utils import timezone
        agora = timezone.localtime(voto.data_assinatura)
        data_formatada = agora.strftime('%d/%m/%Y')
        hora_formatada = agora.strftime('%H:%M:%S')
        
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_assinante}, em {data_formatada} {hora_formatada}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Adicionar logo da assinatura eletr√¥nica
        from .utils import obter_caminho_assinatura_eletronica
        logo_path = obter_caminho_assinatura_eletronica()
        
        # Tabela das assinaturas: Logo + Texto de assinatura
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=3.5*cm, height=2.0*cm), Paragraph(texto_assinatura, style_small)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 1),
            ('RIGHTPADDING', (0, 0), (-1, -1), 1),
            ('TOPPADDING', (0, 0), (-1, -1), 1),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
        ]))
        
        story.append(assinatura_table)
        story.append(Spacer(1, 20))

    # Rodap√© com QR Code (padr√£o dos quadros) - NO FINAL DA FOLHA
    # Gerar URL de autentica√ß√£o
    from django.urls import reverse
    from django.contrib.sites.shortcuts import get_current_site
    
    current_site = get_current_site(request)
    protocol = 'https' if request.is_secure() else 'http'
    url_autenticacao = f"{protocol}://{current_site.domain}{reverse('militares:voto_visualizar_assinar', kwargs={'pk': voto.pk})}"
    
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(voto, request, tipo_documento='voto')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 1),
        ('RIGHTPADDING', (0, 0), (-1, -1), 1),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
    ]))
    
    story.append(rodape_table)

    # Construir o PDF
    doc.build(story)
    
    # Retornar o PDF para visualiza√ß√£o em nova guia
    buffer.seek(0)
    from django.http import FileResponse
    return FileResponse(buffer, content_type='application/pdf', filename=f'voto_deliberacao_{voto.pk}.pdf')
from django.shortcuts import get_object_or_404, render, redirect
from django.utils import timezone
from django.contrib.auth.decorators import login_required

@login_required
def voto_visualizar_assinar(request, pk):
    from .models import VotoDeliberacao, UsuarioFuncaoMilitar, MilitarFuncao
    from django.utils import timezone
    
    voto = get_object_or_404(VotoDeliberacao, pk=pk, membro__usuario=request.user)
    
    # Buscar todas as fun√ß√µes ATUAIS do usu√°rio
    # Todas as fun√ß√µes ficam ATUAIS at√© voc√™ marcar para parar de exercer
    militar = None
    if hasattr(request.user, 'militar') and request.user.militar:
        militar = request.user.militar
        
        # Buscar APENAS fun√ß√µes ATUAIS do militar
        funcoes_usuario = MilitarFuncao.objects.filter(
            militar=militar,
            status='ATUAL'
        ).select_related('funcao_militar').order_by('funcao_militar__nome')
        
    else:
        # Fallback: usar o m√©todo antigo se n√£o houver militar vinculado
        funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
            usuario=request.user
        ).select_related('funcao_militar').order_by('funcao_militar__nome')
    
    # Fun√ß√£o atual selecionada (da sess√£o ou primeira dispon√≠vel)
    funcao_atual = request.session.get('funcao_atual_nome', '')
    if not funcao_atual and funcoes_usuario:
        if hasattr(funcoes_usuario[0], 'funcao_militar'):
            funcao_atual = funcoes_usuario[0].funcao_militar.nome
        else:
            funcao_atual = funcoes_usuario[0].funcao_militar.nome
    
    context = {
        'voto': voto,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
    }
    
    return render(request, 'militares/comissao/deliberacoes/voto_visualizar_assinar.html', context)

@login_required
def assinar_voto(request, pk):
    from .models import VotoDeliberacao
    from django.contrib.auth import authenticate
    from django.contrib import messages
    
    voto = get_object_or_404(VotoDeliberacao, pk=pk, membro__usuario=request.user)
    
    if request.method == "POST" and not voto.assinado:
        # Validar senha
        senha = request.POST.get('senha')
        if not authenticate(username=request.user.username, password=senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            return redirect('militares:voto_visualizar_assinar', pk=pk)
        
        # Capturar fun√ß√£o da assinatura
        funcao_assinatura = request.POST.get('funcao_assinatura')
        tipo_assinatura = request.POST.get('tipo_assinatura', 'VOTO')
        observacoes = request.POST.get('observacoes', '')
        
        # Salvar assinatura
        voto.assinado = True
        voto.data_assinatura = timezone.now()
        voto.funcao_assinatura = funcao_assinatura
        voto.tipo_assinatura = tipo_assinatura
        voto.observacoes_assinatura = observacoes
        voto.save()
        
        messages.success(request, 'Voto assinado eletronicamente com sucesso!')
    
    return redirect('militares:voto_visualizar_assinar', pk=pk)

@login_required
def verificar_autenticidade(request):
    """
    View para verificar a autenticidade de documentos
    """
    resultado = None
    documento = None
    erro = None
    
    if request.method == 'POST':
        codigo_verificador = request.POST.get('codigo_verificador', '').strip()
        codigo_crc = request.POST.get('codigo_crc', '').strip()
        
        if codigo_verificador and codigo_crc:
            try:
                # Extrair o ID do c√≥digo verificador (primeiros 8 d√≠gitos)
                if len(codigo_verificador) >= 8:
                    documento_id = int(codigo_verificador[:8])
                    
                    # Verificar o c√≥digo CRC
                    codigo_crc_esperado = f"{hash(str(documento_id)) % 0xFFFFFFF:07X}"
                    
                    if codigo_crc.upper() == codigo_crc_esperado:
                        # Buscar o documento automaticamente baseado no ID
                        documento_encontrado = False
                        
                        # Tentar Quadro de Acesso
                        try:
                            documento = QuadroAcesso.objects.get(pk=documento_id)
                            resultado = {
                                'tipo': 'Quadro de Acesso',
                                'titulo': f'Quadro de Acesso - {documento.get_tipo_display()}',
                                'data_criacao': documento.data_criacao,
                                'assinaturas': documento.assinaturas.count()
                            }
                            documento_encontrado = True
                        except QuadroAcesso.DoesNotExist:
                            pass
                        
                        # Tentar Quadro de Fixa√ß√£o de Vagas
                        if not documento_encontrado:
                            try:
                                documento = QuadroFixacaoVagas.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Quadro de Fixa√ß√£o de Vagas',
                                    'titulo': f'Quadro de Fixa√ß√£o - {documento.get_tipo_display()}',
                                    'data_criacao': documento.data_criacao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except QuadroFixacaoVagas.DoesNotExist:
                                pass
                        
                        # Tentar Nota de Servi√ßo
                        if not documento_encontrado:
                            try:
                                from .models import Publicacao
                                documento = Publicacao.objects.get(pk=documento_id, tipo='NOTA')
                                resultado = {
                                    'tipo': 'Nota de Servi√ßo',
                                    'titulo': f'Nota {documento.numero} - {documento.titulo}',
                                    'data_criacao': documento.data_criacao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except Publicacao.DoesNotExist:
                                pass
                        
                        # Tentar Boletim Ostensivo
                        if not documento_encontrado:
                            try:
                                from .models import Publicacao
                                documento = Publicacao.objects.get(pk=documento_id, tipo='BOLETIM_OSTENSIVO')
                                resultado = {
                                    'tipo': 'Boletim Ostensivo',
                                    'titulo': f'Boletim N¬∫ {documento.numero} - {documento.titulo}',
                                    'data_criacao': documento.data_criacao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except Publicacao.DoesNotExist:
                                pass
                        
                        # Tentar Ata de Sess√£o
                        if not documento_encontrado:
                            try:
                                documento = AtaSessao.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Ata de Sess√£o',
                                    'titulo': f'Ata da Sess√£o {documento.sessao.numero}',
                                    'data_criacao': documento.sessao.data_sessao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except AtaSessao.DoesNotExist:
                                pass
                        
                        # Tentar Voto de Delibera√ß√£o
                        if not documento_encontrado:
                            try:
                                documento = VotoDeliberacao.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Voto de Delibera√ß√£o',
                                    'titulo': f'Voto de {documento.membro.militar.nome_completo}',
                                    'data_criacao': documento.data_registro,
                                    'assinaturas': 1 if documento.assinado else 0
                                }
                                documento_encontrado = True
                            except VotoDeliberacao.DoesNotExist:
                                pass
                        
                        # Tentar Calend√°rio de Promo√ß√£o
                        if not documento_encontrado:
                            try:
                                documento = CalendarioPromocao.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Calend√°rio de Promo√ß√£o',
                                    'titulo': documento.get_titulo_completo(),
                                    'data_criacao': documento.data_criacao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except CalendarioPromocao.DoesNotExist:
                                pass
                        
                        # Tentar Almanaque Militar
                        if not documento_encontrado:
                            try:
                                documento = AlmanaqueMilitar.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Almanaque Militar',
                                    'titulo': f'{documento.numero} - {documento.titulo}',
                                    'data_criacao': documento.data_geracao,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except AlmanaqueMilitar.DoesNotExist:
                                pass
                        
                        # Tentar Proposta de Medalhas
                        if not documento_encontrado:
                            try:
                                from .models import PropostaMedalha
                                documento = PropostaMedalha.objects.get(pk=documento_id)
                                resultado = {
                                    'tipo': 'Proposta de Medalhas',
                                    'titulo': f'Proposta {documento.numero_proposta}',
                                    'data_criacao': documento.criado_em,
                                    'assinaturas': documento.assinaturas.count()
                                }
                                documento_encontrado = True
                            except PropostaMedalha.DoesNotExist:
                                pass
                        
                        if not documento_encontrado:
                            erro = "Documento n√£o encontrado com o c√≥digo informado."
                    else:
                        erro = "C√≥digo CRC inv√°lido. Verifique os c√≥digos informados."
                else:
                    erro = "C√≥digo verificador inv√°lido. Deve ter pelo menos 8 d√≠gitos."
                    
            except (ValueError, TypeError):
                erro = "C√≥digo verificador inv√°lido. Deve conter apenas n√∫meros."
            except QuadroAcesso.DoesNotExist:
                erro = "Quadro de Acesso n√£o encontrado com o c√≥digo informado."
            except AtaSessao.DoesNotExist:
                erro = "Ata de Sess√£o n√£o encontrada com o c√≥digo informado."
            except VotoDeliberacao.DoesNotExist:
                erro = "Voto de Delibera√ß√£o n√£o encontrado com o c√≥digo informado."
            except QuadroFixacaoVagas.DoesNotExist:
                erro = "Quadro de Fixa√ß√£o de Vagas n√£o encontrado com o c√≥digo informado."
            except CalendarioPromocao.DoesNotExist:
                erro = "Calend√°rio de Promo√ß√£o n√£o encontrado com o c√≥digo informado."
            except AlmanaqueMilitar.DoesNotExist:
                erro = "Almanaque Militar n√£o encontrado com o c√≥digo informado."
            except PropostaMedalha.DoesNotExist:
                erro = "Proposta de Medalha n√£o encontrada com o c√≥digo informado."
            except Publicacao.DoesNotExist:
                erro = "Nota de Servi√ßo n√£o encontrada com o c√≥digo informado."
            except Exception as e:
                erro = f"Erro interno do sistema. Tente novamente ou entre em contato com o suporte."
        else:
            erro = "Por favor, informe ambos os c√≥digos."
    
    context = {
        'resultado': resultado,
        'documento': documento,
        'erro': erro
    }
    
    return render(request, 'militares/verificar_autenticidade.html', context)

# Views para Calend√°rios de Promo√ß√µes
@login_required
def calendario_promocao_list(request):
    """Lista todos os calend√°rios de promo√ß√µes"""
    # Verificar se usu√°rio tem permiss√£o para CRUD completo
    from .decorators import usuario_comissao_required, usuario_cpo_required, usuario_cpp_required, apenas_visualizacao_comissao, administracao_required, militar_edit_permission, comissao_acesso_total, cargos_especiais_required, can_edit_ficha_conceito
    from functools import wraps
    
    def has_crud_permission(user):
        cargos_especiais = [
        'Diretor de Gest√£o de Pessoas', 
        'Chefe da Se√ß√£o de Promo√ß√µes',
        'Membro Efetivo da Comiss√£o de Promo√ß√µes de Oficiais',
        'Membro Efetivo da Comiss√£o de Promo√ß√µes de Pra√ßas'
    ]
        funcoes_especiais = UsuarioFuncaoMilitar.objects.filter(
            usuario=user,
            ativo=True,
            funcao_militar__nome__in=cargos_especiais
        )
        return user.is_superuser or user.is_staff or funcoes_especiais.exists()
    
    calendarios = CalendarioPromocao.objects.all().order_by('-ano', '-semestre')
    
    # Adicionar alertas para cada calend√°rio
    for calendario in calendarios:
        calendario.alertas = calendario.get_alertas_datas()
        calendario.tem_alertas = len(calendario.alertas) > 0
    
    context = {
        'calendarios': calendarios,
        'title': 'Calend√°rios de Promo√ß√µes',
        'can_edit': has_crud_permission(request.user),
    }
    return render(request, 'militares/calendario_promocao/list.html', context)

@login_required
def calendario_promocao_detail(request, pk):
    """Exibe detalhes de um calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    # Verificar se usu√°rio tem permiss√£o para CRUD completo
    def has_crud_permission(user):
        cargos_especiais = [
        'Diretor de Gest√£o de Pessoas', 
        'Chefe da Se√ß√£o de Promo√ß√µes',
        'Membro Efetivo da Comiss√£o de Promo√ß√µes de Oficiais',
        'Membro Efetivo da Comiss√£o de Promo√ß√µes de Pra√ßas'
    ]
        funcoes_especiais = UsuarioFuncaoMilitar.objects.filter(
            usuario=user,
            ativo=True,
            funcao_militar__nome__in=cargos_especiais
        )
        return user.is_superuser or user.is_staff or funcoes_especiais.exists()
    
    itens = calendario.itens.all().order_by('ordem')
    
    # Adicionar alertas para o calend√°rio
    alertas = calendario.get_alertas_datas()
    
    context = {
        'calendario': calendario,
        'itens': itens,
        'alertas': alertas,
        'title': f'Calend√°rio {calendario.numero}',
        'can_edit': has_crud_permission(request.user),
        'active_menu': 'calendario_promocao',
    }
    return render(request, 'militares/calendario_promocao/detail.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_create(request):
    """Cria um novo calend√°rio de promo√ß√£o"""
    if request.method == 'POST':
        ano = request.POST.get('ano')
        semestre = request.POST.get('semestre')
        tipo = request.POST.get('tipo')
        observacoes = request.POST.get('observacoes', '')
        
        if ano and semestre and tipo:
            # Permitir m√∫ltiplos calend√°rios para o mesmo per√≠odo
            # A numera√ß√£o ser√° gerada automaticamente (CAL-OF-2025/1, CAL-OF-2025/1-A01, etc.)
            
            calendario = CalendarioPromocao.objects.create(
                ano=ano,
                semestre=semestre,
                tipo=tipo,
                observacoes=observacoes
            )
            
            messages.success(request, f'Calend√°rio {calendario.numero} criado com sucesso!')
            return redirect('militares:calendario_promocao_detail', pk=calendario.pk)
        else:
            messages.error(request, 'Ano, semestre e tipo s√£o obrigat√≥rios.')
    
    context = {
        'title': 'Criar Calend√°rio de Promo√ß√£o',
        'semestres': [('1', '1¬∫ Semestre'), ('2', '2¬∫ Semestre')],
        'tipos': CalendarioPromocao.TIPO_CHOICES,
    }
    return render(request, 'militares/calendario_promocao/create.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_update(request, pk):
    """Atualiza um calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        ano = request.POST.get('ano')
        semestre = request.POST.get('semestre')
        tipo = request.POST.get('tipo')
        observacoes = request.POST.get('observacoes', '')
        ativo = request.POST.get('ativo') == 'on'
        
        if ano and semestre and tipo:
            # Permitir m√∫ltiplos calend√°rios para o mesmo per√≠odo
            # A numera√ß√£o ser√° gerada automaticamente se necess√°rio
            
            calendario.ano = ano
            calendario.semestre = semestre
            calendario.tipo = tipo
            calendario.observacoes = observacoes
            calendario.ativo = ativo
            calendario.save()
            
            messages.success(request, f'Calend√°rio {calendario.numero} atualizado com sucesso!')
            return redirect('militares:calendario_promocao_detail', pk=calendario.pk)
        else:
            messages.error(request, 'Ano, semestre e tipo s√£o obrigat√≥rios.')
    
    context = {
        'calendario': calendario,
        'title': f'Editar Calend√°rio {calendario.periodo_completo}',
        'semestres': [('1', '1¬∫ Semestre'), ('2', '2¬∫ Semestre')],
        'tipos': CalendarioPromocao.TIPO_CHOICES,
    }
    return render(request, 'militares/calendario_promocao/update.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_delete(request, pk):
    """Exclui um calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        if not calendario.pode_ser_excluido():
            messages.error(request, f'Calend√°rio {calendario.numero} n√£o pode ser exclu√≠do pois est√° {calendario.get_status_display()}.')
            return redirect('militares:calendario_promocao_detail', pk=calendario.pk)
        
        nome_calendario = calendario.numero or calendario.periodo_completo
        calendario.delete()
        messages.success(request, f'Calend√°rio {nome_calendario} exclu√≠do com sucesso!')
        return redirect('militares:calendario_promocao_list')
    
    context = {
        'calendario': calendario,
        'title': f'Excluir Calend√°rio {calendario.numero or calendario.periodo_completo}',
        'pode_excluir': calendario.pode_ser_excluido(),
    }
    return render(request, 'militares/calendario_promocao/delete.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_aprovar(request, pk):
    """Aprova um calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        if calendario.status in ['RASCUNHO', 'EM_ELABORACAO']:
            calendario.aprovar(request.user)
            messages.success(request, f'Calend√°rio {calendario.numero} aprovado com sucesso!')
        else:
            messages.error(request, f'Calend√°rio {calendario.numero} n√£o pode ser aprovado no status atual.')
        
        return redirect('militares:calendario_promocao_detail', pk=calendario.pk)
    
    context = {
        'calendario': calendario,
        'title': f'Aprovar Calend√°rio {calendario.numero or calendario.periodo_completo}',
        'pode_aprovar': calendario.status in ['RASCUNHO', 'EM_ELABORACAO'],
    }
    return render(request, 'militares/calendario_promocao/aprovar.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_homologar(request, pk):
    """Homologa um calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        if calendario.status == 'APROVADO':
            calendario.homologar(request.user)
            messages.success(request, f'Calend√°rio {calendario.numero} homologado com sucesso!')
        else:
            messages.error(request, f'Calend√°rio {calendario.numero} n√£o pode ser homologado no status atual.')
        
        return redirect('militares:calendario_promocao_detail', pk=calendario.pk)
    
    context = {
        'calendario': calendario,
        'title': f'Homologar Calend√°rio {calendario.numero or calendario.periodo_completo}',
        'pode_homologar': calendario.status == 'APROVADO',
    }
    return render(request, 'militares/calendario_promocao/homologar.html', context)

@login_required
@cargos_especiais_required
def item_calendario_create(request, calendario_pk):
    """Adiciona um item ao calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=calendario_pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        tipo_atividade = request.POST.get('tipo_atividade')
        data_inicio = request.POST.get('data_inicio')
        data_fim = request.POST.get('data_fim')
        ordem = request.POST.get('ordem', 0)
        observacoes = request.POST.get('observacoes', '')
        
        if tipo_atividade and data_inicio and data_fim:
            try:
                data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
                data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
                
                # Verificar se j√° existe um item deste tipo no calend√°rio
                if ItemCalendarioPromocao.objects.filter(calendario=calendario, tipo_atividade=tipo_atividade).exists():
                    messages.error(request, 'J√° existe um item deste tipo no calend√°rio.')
                    return redirect('militares:calendario_promocao_detail', pk=calendario_pk)
                
                # Criar o item sem ordem (ser√° definida automaticamente no save)
                item = ItemCalendarioPromocao.objects.create(
                    calendario=calendario,
                    tipo_atividade=tipo_atividade,
                    data_inicio=data_inicio,
                    data_fim=data_fim,
                    ordem=0,  # Ser√° definida automaticamente no save
                    observacoes=observacoes
                )
                
                # Reordenar todos os itens do calend√°rio
                ItemCalendarioPromocao.reordenar_itens_calendario(calendario)
                
                messages.success(request, f'Item "{item.get_tipo_atividade_display()}" adicionado com sucesso!')
                return redirect('militares:calendario_promocao_detail', pk=calendario_pk)
                
            except ValueError:
                messages.error(request, 'Data inv√°lida. Use o formato DD/MM/AAAA.')
        else:
            messages.error(request, 'Tipo de atividade e datas s√£o obrigat√≥rios.')
    
    # Determinar o pr√≥ximo item a ser adicionado
    itens_existentes = calendario.itens.values_list('tipo_atividade', flat=True)
    proximo_item = None
    
    # Buscar o pr√≥ximo item na ordem padr√£o que ainda n√£o foi adicionado
    for tipo_atividade, ordem in sorted(ItemCalendarioPromocao.ORDEM_PADRAO.items(), key=lambda x: x[1]):
        if tipo_atividade not in itens_existentes:
            proximo_item = tipo_atividade
            break
    
    # Se n√£o h√° pr√≥ximo item, usar o primeiro da lista
    if not proximo_item:
        proximo_item = ItemCalendarioPromocao.TIPO_ATIVIDADE_CHOICES[0][0]
    
    # Criar lista de tipos de atividade com ordem
    tipos_com_ordem = []
    for tipo_valor, tipo_label in ItemCalendarioPromocao.TIPO_ATIVIDADE_CHOICES:
        ordem = ItemCalendarioPromocao.ORDEM_PADRAO.get(tipo_valor, 999)
        tipos_com_ordem.append({
            'valor': tipo_valor,
            'label': tipo_label,
            'ordem': ordem,
            'display': f"{ordem}. {tipo_label}"
        })
    
    # Ordenar por ordem
    tipos_com_ordem.sort(key=lambda x: x['ordem'])
    
    context = {
        'calendario': calendario,
        'title': f'Adicionar Item ao Calend√°rio {calendario.periodo_completo}',
        'tipos_atividade': tipos_com_ordem,
        'proximo_item': proximo_item,
        'ordem_proximo_item': ItemCalendarioPromocao.ORDEM_PADRAO.get(proximo_item, 999),
    }
    return render(request, 'militares/calendario_promocao/item_create.html', context)

@login_required
@cargos_especiais_required
def item_calendario_update(request, pk):
    """Atualiza um item do calend√°rio de promo√ß√£o"""
    try:
        item = ItemCalendarioPromocao.objects.get(pk=pk)
    except ItemCalendarioPromocao.DoesNotExist:
        messages.error(request, 'Item do calend√°rio n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        tipo_atividade = request.POST.get('tipo_atividade')
        data_inicio = request.POST.get('data_inicio')
        data_fim = request.POST.get('data_fim')
        ordem = request.POST.get('ordem', 0)
        observacoes = request.POST.get('observacoes', '')
        
        if tipo_atividade and data_inicio and data_fim:
            try:
                data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
                data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
                
                # Verificar se j√° existe outro item deste tipo no calend√°rio
                if ItemCalendarioPromocao.objects.filter(
                    calendario=item.calendario, 
                    tipo_atividade=tipo_atividade
                ).exclude(pk=item.pk).exists():
                    messages.error(request, 'J√° existe um item deste tipo no calend√°rio.')
                    return redirect('militares:calendario_promocao_detail', pk=item.calendario.pk)
                
                item.tipo_atividade = tipo_atividade
                item.data_inicio = data_inicio
                item.data_fim = data_fim
                item.ordem = 0  # Ser√° definida automaticamente no save
                item.observacoes = observacoes
                item.save()
                
                # Reordenar todos os itens do calend√°rio
                ItemCalendarioPromocao.reordenar_itens_calendario(item.calendario)
                
                messages.success(request, f'Item "{item.get_tipo_atividade_display()}" atualizado com sucesso!')
                return redirect('militares:calendario_promocao_detail', pk=item.calendario.pk)
                
            except ValueError:
                messages.error(request, 'Data inv√°lida. Use o formato DD/MM/AAAA.')
        else:
            messages.error(request, 'Tipo de atividade e datas s√£o obrigat√≥rios.')
    
    context = {
        'item': item,
        'calendario': item.calendario,
        'title': f'Editar Item do Calend√°rio {item.calendario.periodo_completo}',
        'tipos_atividade': ItemCalendarioPromocao.TIPO_ATIVIDADE_CHOICES,
    }
    return render(request, 'militares/calendario_promocao/item_update.html', context)

@login_required
def calendario_promocao_visualizar_assinatura(request, pk):
    """Visualiza√ß√£o do calend√°rio de promo√ß√£o com op√ß√µes de assinatura"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    # Buscar itens do calend√°rio ordenados por ordem
    itens = calendario.itens.all().order_by('ordem')
    
    # Buscar assinaturas eletr√¥nicas
    assinaturas = calendario.assinaturas.all().order_by('data_assinatura')
    
    # Verificar permiss√µes de assinatura
    can_sign = False
    
    # Verificar se n√£o √© o usu√°rio "usuario"
    if request.user.username == 'usuario':
        can_sign = False
    else:
        # Verificar se o usu√°rio tem fun√ß√µes espec√≠ficas
        funcoes_especificas = [
            'Presidente', 'Diretor', 'Chefe', 'Comandante', 'Secret√°rio', 
            'Coordenador', 'Supervisor', 'Gerente', 'Assessor', 'Consultor',
            'Membro de Comiss√£o', 'Membro Efetivo', 'Membro Nato'
        ]
        
        # Verificar se tem fun√ß√µes ativas
        funcoes_ativas = UsuarioFuncaoMilitar.objects.filter(
            usuario=request.user,
            ativo=True,
            data_fim__isnull=True
        )
        
        # Verificar se √© membro de comiss√£o ativa
        membro_comissao = MembroComissao.objects.filter(
            usuario=request.user,
            ativo=True,
            data_termino__isnull=True
        ).exists()
        
        # Verificar se tem fun√ß√µes espec√≠ficas ou √© membro de comiss√£o
        tem_funcao_especifica = False
        for funcao in funcoes_ativas:
            if any(nome in funcao.funcao_militar.nome for nome in funcoes_especificas):
                tem_funcao_especifica = True
                break
        
        if tem_funcao_especifica or membro_comissao or request.user.is_superuser or request.user.is_staff:
            can_sign = True
    
    # Buscar fun√ß√µes do usu√°rio para assinatura
    funcoes_usuario = []
    funcao_atual = None
    funcoes_adicionadas = set()  # Para evitar duplicatas
    
    if request.user.is_authenticated and request.user.username != 'usuario':
        print(f"DEBUG: Verificando fun√ß√µes para usu√°rio: {request.user.username}")
        
        # Buscar TODAS as comiss√µes ativas (n√£o apenas do tipo do calend√°rio)
        comissoes_ativas = ComissaoPromocao.objects.filter(status='ATIVA')
        
        # Adicionar fun√ß√µes de comiss√£o
        for comissao in comissoes_ativas:
            membros_comissao = comissao.membros.filter(usuario=request.user)
            for membro in membros_comissao:
                nome_funcao = membro.cargo.nome
                if nome_funcao not in funcoes_adicionadas:
                    funcoes_usuario.append({
                        'tipo': 'comissao',
                        'objeto': membro,
                        'nome': nome_funcao,
                        'descricao': f"{nome_funcao} ({comissao.get_tipo_display()})"
                    })
                    funcoes_adicionadas.add(nome_funcao)
        
        # Buscar TODAS as fun√ß√µes espec√≠ficas do usu√°rio (sem filtrar)
        funcoes_especificas = UsuarioFuncaoMilitar.objects.filter(
            usuario=request.user,
            ativo=True,
            data_fim__isnull=True
        )
        
        print(f"DEBUG: Fun√ß√µes espec√≠ficas encontradas: {funcoes_especificas.count()}")
        
        # Adicionar TODAS as fun√ß√µes espec√≠ficas do usu√°rio (sem filtrar)
        for funcao in funcoes_especificas:
            nome_funcao = funcao.funcao_militar.nome
            if nome_funcao not in funcoes_adicionadas:
                print(f"DEBUG: Adicionando fun√ß√£o espec√≠fica: {nome_funcao}")
                funcoes_usuario.append({
                    'tipo': 'especifica',
                    'objeto': funcao,
                    'nome': nome_funcao,
                    'descricao': f"{nome_funcao} (Fun√ß√£o Espec√≠fica)"
                })
                funcoes_adicionadas.add(nome_funcao)
        
        # Definir fun√ß√£o atual (primeira da lista)
        if funcoes_usuario:
            funcao_atual = funcoes_usuario[0]['nome']
        
        # Debug: Log das fun√ß√µes encontradas
        print(f"DEBUG: Total de fun√ß√µes encontradas: {len(funcoes_usuario)}")
        for i, funcao in enumerate(funcoes_usuario):
            print(f"DEBUG: Fun√ß√£o {i+1}: {funcao['nome']} - {funcao['descricao']}")
        
        # Se n√£o encontrou nenhuma fun√ß√£o, permitir assinatura como usu√°rio gen√©rico
        if not funcoes_usuario and can_sign:
            funcoes_usuario.append({
                'tipo': 'generico',
                'objeto': None,
                'nome': 'Usu√°rio Autorizado',
                'descricao': 'Usu√°rio Autorizado (Fun√ß√£o Gen√©rica)'
            })
            funcao_atual = 'Usu√°rio Autorizado'
    
    context = {
        'calendario': calendario,
        'itens': itens,
        'assinaturas': assinaturas,
        'can_sign': can_sign,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
        'title': f'Visualizar Calend√°rio {calendario.numero}',
    }
    return render(request, 'militares/calendario_promocao/visualizar_assinatura.html', context)

@login_required
@cargos_especiais_required
def calendario_promocao_assinar(request, pk):
    """Assinar calend√°rio de promo√ß√£o"""
    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, 'Calend√°rio de promo√ß√£o n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    # Verificar permiss√µes de assinatura
    if request.user.username == 'usuario':
        messages.error(request, 'O usu√°rio "usuario" n√£o tem permiss√£o para assinar calend√°rios.')
        return redirect('militares:calendario_promocao_visualizar_assinatura', pk=pk)
    
    # Verificar se o usu√°rio tem fun√ß√µes espec√≠ficas
    funcoes_especificas = [
        'Presidente', 'Diretor', 'Chefe', 'Comandante', 'Secret√°rio', 
        'Coordenador', 'Supervisor', 'Gerente', 'Assessor', 'Consultor',
        'Membro de Comiss√£o', 'Membro Efetivo', 'Membro Nato'
    ]
    
    # Verificar se tem fun√ß√µes ativas
    funcoes_ativas = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True,
        data_fim__isnull=True
    )
    
    # Verificar se √© membro de comiss√£o ativa
    membro_comissao = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True,
        data_termino__isnull=True
    ).exists()
    
    # Verificar se tem fun√ß√µes espec√≠ficas ou √© membro de comiss√£o
    tem_funcao_especifica = False
    for funcao in funcoes_ativas:
        if any(nome in funcao.funcao_militar.nome for nome in funcoes_especificas):
            tem_funcao_especifica = True
            break
    
    if not (tem_funcao_especifica or membro_comissao or request.user.is_superuser or request.user.is_staff):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para assinar calend√°rios. √â necess√°rio ter fun√ß√µes espec√≠ficas ou ser membro de comiss√£o.')
        return redirect('militares:calendario_promocao_visualizar_assinatura', pk=pk)
    
    if request.method == 'POST':
        tipo_assinatura = request.POST.get('tipo_assinatura')
        funcao_assinatura = request.POST.get('funcao_assinatura', '')
        observacoes = request.POST.get('observacoes', '')
        senha = request.POST.get('senha')
        
        if not senha:
            messages.error(request, 'Senha √© obrigat√≥ria para confirmar a assinatura.')
            return redirect('militares:calendario_promocao_visualizar_assinatura', pk=pk)
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta.')
            return redirect('militares:calendario_promocao_visualizar_assinatura', pk=pk)
        
        # Criar assinatura
        try:
            assinatura = AssinaturaCalendarioPromocao.objects.create(
                calendario=calendario,
                tipo_assinatura=tipo_assinatura,
                funcao_assinatura=funcao_assinatura,
                assinado_por=request.user,
                observacoes=observacoes
            )
            messages.success(request, f'Calend√°rio {calendario.numero} assinado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao assinar calend√°rio: {str(e)}')
        
        return redirect('militares:calendario_promocao_visualizar_assinatura', pk=pk)
    
    context = {
        'calendario': calendario,
        'title': f'Assinar Calend√°rio {calendario.numero}',
    }
    return render(request, 'militares/calendario_promocao/assinar.html', context)

@login_required
def retirar_assinatura_calendario(request, pk, assinatura_pk):
    """Retirar assinatura do calend√°rio de promo√ß√£o - apenas antes da homologa√ß√£o"""
    calendario = get_object_or_404(CalendarioPromocao, pk=pk)
    assinatura = get_object_or_404(AssinaturaCalendarioPromocao, pk=assinatura_pk, calendario=calendario)
    
    # Verificar se o calend√°rio j√° foi homologado
    if calendario.status == 'HOMOLOGADO':
        messages.error(request, 'N√£o √© poss√≠vel retirar assinaturas de um calend√°rio j√° homologado.')
        return redirect('militares:calendario_promocao_visualizar_assinatura', pk=calendario.pk)
    
    # Verificar se o usu√°rio √© o autor da assinatura ou tem permiss√£o administrativa
    if assinatura.assinado_por != request.user and not request.user.is_superuser and not request.user.is_staff:
        messages.error(request, 'Voc√™ s√≥ pode retirar suas pr√≥prias assinaturas.')
        return redirect('militares:calendario_promocao_visualizar_assinatura', pk=calendario.pk)
    
    if request.method == 'POST':
        senha = request.POST.get('senha')
        
        # Verificar senha do usu√°rio
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Tente novamente.')
            context = {
                'calendario': calendario,
                'assinatura': assinatura,
            }
            return render(request, 'militares/retirar_assinatura_calendario.html', context)
        
        # Verificar se a assinatura √© de aprova√ß√£o e se h√° outras assinaturas de aprova√ß√£o
        if assinatura.tipo_assinatura == 'APROVACAO':
            outras_aprovacoes = calendario.assinaturas.filter(
                tipo_assinatura='APROVACAO'
            ).exclude(pk=assinatura.pk).count()
            
            if outras_aprovacoes == 0:
                # Se n√£o h√° outras aprova√ß√µes, voltar o status do calend√°rio para EM_ELABORACAO
                calendario.status = 'EM_ELABORACAO'
                calendario.save()
        
        # Excluir a assinatura
        assinatura.delete()
        
        messages.success(request, f'Assinatura de "{assinatura.get_tipo_assinatura_display()}" retirada com sucesso!')
        
        # Redirecionar de volta para a p√°gina de onde veio
        next_url = request.GET.get('next')
        if next_url:
            return redirect(next_url)
        else:
            return redirect('militares:calendario_promocao_visualizar_assinatura', pk=calendario.pk)
    
    context = {
        'calendario': calendario,
        'assinatura': assinatura,
    }
    
    return render(request, 'militares/retirar_assinatura_calendario.html', context)

@login_required
def calendario_promocao_gerar_pdf(request, pk):
    """Gera PDF do calend√°rio de promo√ß√£o no modelo institucional"""
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    import qrcode
    import locale
    from datetime import datetime

    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar

    try:
        calendario = CalendarioPromocao.objects.get(pk=pk)
    except CalendarioPromocao.DoesNotExist:
        messages.error(request, f'Calend√°rio de promo√ß√£o com ID {pk} n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')

    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()

    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6)

    story = []

    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Determinar local de gera√ß√£o baseado na fun√ß√£o do usu√°rio (hierarquia completa)
    local_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario and funcao_usuario.funcao_militar:
        hierarquia = []
        
        # Construir hierarquia completa at√© a inst√¢ncia mais espec√≠fica
        if hasattr(funcao_usuario, 'orgao') and funcao_usuario.orgao:
            hierarquia.append(funcao_usuario.orgao.nome.upper())
        if hasattr(funcao_usuario, 'grande_comando') and funcao_usuario.grande_comando:
            hierarquia.append(funcao_usuario.grande_comando.nome.upper())
        if hasattr(funcao_usuario, 'unidade') and funcao_usuario.unidade:
            hierarquia.append(funcao_usuario.unidade.nome.upper())
        if hasattr(funcao_usuario, 'sub_unidade') and funcao_usuario.sub_unidade:
            hierarquia.append(funcao_usuario.sub_unidade.nome.upper())
        
        # Se encontrou alguma inst√¢ncia, usar a mais espec√≠fica (√∫ltima da lista)
        if hierarquia:
            local_geracao = hierarquia[-1]
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        local_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # T√≠tulo centralizado e sublinhado
    titulo_completo = calendario.get_titulo_completo()
    titulo = f'<u>{titulo_completo}</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 16))

    # Informa√ß√µes do calend√°rio
    info_data = [
        ['Per√≠odo:', f"{calendario.get_semestre_display()} {calendario.ano}"],
        ['Tipo:', calendario.get_tipo_display()],
        ['Status:', calendario.get_status_display()],
        ['Data de Cria√ß√£o:', calendario.data_criacao.strftime('%d/%m/%Y %H:%M')],
    ]
    
    if calendario.data_aprovacao:
        info_data.append(['Aprovado em:', calendario.data_aprovacao.strftime('%d/%m/%Y %H:%M')])
        info_data.append(['Aprovado por:', calendario.aprovado_por.get_full_name()])
    
    if calendario.data_homologacao:
        info_data.append(['Homologado em:', calendario.data_homologacao.strftime('%d/%m/%Y %H:%M')])
        info_data.append(['Homologado por:', calendario.homologado_por.get_full_name()])

    info_table = Table(info_data, colWidths=[4*cm, 10*cm])
    info_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#f8f9fa')),
        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 0), (-1, -1), 'Helvetica'),
        ('FONTSIZE', (0, 0), (-1, -1), 12),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
    ]))
    story.append(info_table)
    story.append(Spacer(1, 40))

    # Itens do calend√°rio
    if calendario.itens.exists():
        story.append(Paragraph("ITENS DO CALEND√ÅRIO", style_subtitle))
        story.append(Spacer(1, 10))
        
        # Cabe√ßalho da tabela
        header_data = [['Ordem', 'Atividade', 'Per√≠odo']]
        
        # Dados dos itens
        for item in calendario.itens.all().order_by('ordem'):
            header_data.append([
                str(item.ordem),
                item.get_tipo_atividade_display(),
                item.periodo_formatado
            ])
        
        items_table = Table(header_data, colWidths=[1.5*cm, 10*cm, 4*cm])
        items_table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, -1), 9),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ]))
        story.append(items_table)
        story.append(Spacer(1, 40))

    # Data e local
    from django.utils import timezone
    data_atual = timezone.localtime(timezone.now())
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    data_formatada = f"{data_atual.day} de {meses_pt[data_atual.month]} de {data_atual.year}"
    data_extenso = f"Teresina, {data_formatada}"
    story.append(Spacer(1, 40))
    story.append(Paragraph(data_extenso, style_center))
    
    # Se√ß√£o de Assinaturas F√≠sicas (sem t√≠tulo)
    story.append(Spacer(1, 8))

    # Buscar todas as assinaturas v√°lidas do calend√°rio (da mais recente para a mais antiga)
    assinaturas = calendario.assinaturas.filter(assinado_por__isnull=False).order_by('-data_assinatura')
    
    for assinatura in assinaturas:
        # Nome e posto
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_completo = f"{militar.nome_completo} - {posto}"
        else:
            nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        
        # Fun√ß√£o
        funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
        
        # Exibir no formato f√≠sico: Nome - Posto BM (negrito), Fun√ß√£o (normal)
        story.append(Spacer(1, 8))
        story.append(Paragraph(f"<b>{nome_completo}</b>", style_center))
        story.append(Paragraph(f"{funcao}", style_center))
        story.append(Spacer(1, 8))

    # Se n√£o houver assinaturas, mostrar mensagem
    if not assinaturas.exists():
        story.append(Paragraph("Nenhuma assinatura registrada", style_center))

    # Se√ß√£o de Assinaturas Eletr√¥nicas (sem t√≠tulo)
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=0.5, spaceAfter=8, spaceBefore=8, color=colors.lightgrey))
    story.append(Spacer(1, 8))
    
    # Buscar todas as assinaturas para exibir na se√ß√£o eletr√¥nica
    assinaturas_eletronicas = calendario.assinaturas.filter(
        assinado_por__isnull=False
    ).order_by('-data_assinatura')
    
    for i, assinatura in enumerate(assinaturas_eletronicas):
        # Nome e posto - seguir o mesmo padr√£o dos quadros de acesso
        if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
            militar = assinatura.assinado_por.militar
            posto = militar.get_posto_graduacao_display()
            # Adicionar BM ap√≥s o posto se n√£o j√° estiver presente
            if "BM" not in posto:
                posto = f"{posto} BM"
            nome_completo = f"{posto} {militar.nome_completo}"
        else:
            nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
        
        # Data da assinatura
        from .utils import formatar_data_assinatura
        data_formatada, hora_formatada = formatar_data_assinatura(assinatura.data_assinatura)
        data_assinatura = f"{data_formatada} {hora_formatada}"
        
        # Texto da assinatura eletr√¥nica no padr√£o solicitado
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_completo}, em {data_assinatura}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        from .utils import obter_caminho_assinatura_eletronica
        # Tabela das assinaturas: Logo + Texto de assinatura
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=3.5*cm, height=2.0*cm), Paragraph(texto_assinatura, style_small)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[3*cm, 13*cm])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 1),
            ('RIGHTPADDING', (0, 0), (-1, -1), 1),
            ('TOPPADDING', (0, 0), (-1, -1), 1),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
        ]))
        
        story.append(assinatura_table)
        
        # Adicionar linha separadora entre assinaturas (exceto na √∫ltima)
        if i < len(assinaturas_eletronicas) - 1:
            story.append(Spacer(1, 8))
            story.append(HRFlowable(width="100%", thickness=0.5, spaceAfter=8, spaceBefore=8, color=colors.lightgrey))
            story.append(Spacer(1, 8))
    
    
    
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(calendario, request, tipo_documento='calendario_promocao')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 13*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 1),
        ('RIGHTPADDING', (0, 0), (-1, -1), 1),
        ('TOPPADDING', (0, 0), (-1, -1), 1),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
    ]))
    
    story.append(rodape_table)
    
    # Construir o PDF
    doc.build(story)
    
    # Retornar o PDF para visualiza√ß√£o em nova guia
    buffer.seek(0)
    from django.http import FileResponse
    return FileResponse(buffer, content_type='application/pdf', filename=f'calendario_promocao_{calendario.pk}.pdf')

@login_required
@cargos_especiais_required
def item_calendario_delete(request, pk):
    """Exclui um item do calend√°rio de promo√ß√£o"""
    try:
        item = ItemCalendarioPromocao.objects.get(pk=pk)
    except ItemCalendarioPromocao.DoesNotExist:
        messages.error(request, 'Item do calend√°rio n√£o encontrado.')
        return redirect('militares:calendario_promocao_list')
    
    if request.method == 'POST':
        nome_item = item.get_tipo_atividade_display()
        calendario_pk = item.calendario.pk
        item.delete()
        messages.success(request, f'Item "{nome_item}" exclu√≠do com sucesso!')
        return redirect('militares:calendario_promocao_detail', pk=calendario_pk)
    
    context = {
        'item': item,
        'calendario': item.calendario,
        'title': f'Excluir Item do Calend√°rio {item.calendario.periodo_completo}',
    }
    return render(request, 'militares/calendario_promocao/item_delete.html', context)

@login_required
def calendario_promocao_visualizar(request):
    """Visualiza√ß√£o p√∫blica dos calend√°rios de promo√ß√µes ativos"""
    calendarios_ativos = CalendarioPromocao.objects.filter(ativo=True).order_by('-ano', '-semestre')
    
    context = {
        'calendarios': calendarios_ativos,
        'title': 'Calend√°rios de Promo√ß√µes',
    }
    return render(request, 'militares/calendario_promocao/visualizar.html', context)
# Views para Almanaque
from django.core.files.base import ContentFile
from django.http import HttpResponse
from reportlab.lib.pagesizes import A4
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak, HRFlowable
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm, inch
from reportlab.lib import colors
from io import BytesIO

@login_required
def almanaque_militares(request):
    """Almanaque dos militares organizado por hierarquia"""
    
    # Definir ordem hier√°rquica dos postos (do mais graduado ao menos graduado)
    ordem_postos_oficiais = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    ordem_postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    
    # Buscar todos os militares ativos
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').order_by('posto_graduacao', 'numeracao_antiguidade', 'nome_completo')
    
    # Separar oficiais, pra√ßas e NVRR
    oficiais = []
    pracas = []
    nvrr = []
    
    for militar in militares_ativos:
        if militar.is_nvrr():
            nvrr.append(militar)
        elif militar.is_oficial():
            oficiais.append(militar)
        else:
            pracas.append(militar)
    
    # Organizar oficiais por hierarquia
    oficiais_organizados = {}
    for posto in ordem_postos_oficiais:
        militares_posto = [m for m in oficiais if m.posto_graduacao == posto]
        if militares_posto:
            # Ordenar por n√∫mero de antiguidade (menor primeiro) e depois por data de promo√ß√£o
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            oficiais_organizados[posto] = militares_posto
    
    # Organizar pra√ßas por hierarquia
    pracas_organizadas = {}
    for posto in ordem_postos_pracas:
        militares_posto = [m for m in pracas if m.posto_graduacao == posto]
        if militares_posto:
            # Ordenar por n√∫mero de antiguidade (menor primeiro) e depois por data de promo√ß√£o
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            pracas_organizadas[posto] = militares_posto
    
    # Organizar NVRR separadamente
    nvrr_organizados = {}
    if nvrr:
        # Ordenar por data de promo√ß√£o (mais antiga primeiro) e depois por nome
        nvrr.sort(key=lambda x: (x.data_promocao_atual, x.nome_completo))
        nvrr_organizados['NVRR'] = nvrr
    
    # Organizar todos os militares por hierarquia geral (incluindo NVRR)
    todos_organizados = {}
    ordem_geral = ordem_postos_oficiais + ordem_postos_pracas
    
    for posto in ordem_geral:
        militares_posto = [m for m in militares_ativos if m.posto_graduacao == posto]
        if militares_posto:
            # Ordenar por n√∫mero de antiguidade (menor primeiro) e depois por data de promo√ß√£o
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            todos_organizados[posto] = militares_posto
    
    # Adicionar NVRR ao todos_organizados
    if nvrr:
        todos_organizados['NVRR'] = nvrr
        ordem_geral = ['NVRR'] + ordem_geral
    
    context = {
        'title': 'Almanaque dos Militares',
        'oficiais_organizados': oficiais_organizados,
        'pracas_organizadas': pracas_organizadas,
        'nvrr_organizados': nvrr_organizados,
        'todos_organizados': todos_organizados,
        'ordem_postos_oficiais': ordem_postos_oficiais,
        'ordem_postos_pracas': ordem_postos_pracas,
        'ordem_geral': ordem_geral,
        'total_oficiais': len(oficiais),
        'total_pracas': len(pracas),
        'total_nvrr': len(nvrr),
        'total_geral': len(militares_ativos),
        'POSTO_GRADUACAO_CHOICES': POSTO_GRADUACAO_CHOICES,
    }
    
    return render(request, 'militares/almanaque.html', context)

@login_required
def almanaque_list(request):
    """Lista todos os almanaques seguindo o padr√£o dos quadros de fixa√ß√£o de vagas"""
    from militares.permissoes_simples import tem_permissao
    
    # Superusu√°rios e staff t√™m acesso total
    if request.user.is_superuser or request.user.is_staff:
        almanaques = AlmanaqueMilitar.objects.filter(ativo=True).order_by('-data_geracao')
    else:
        # Verificar permiss√£o baseada no sistema de permiss√µes granulares
        if tem_permissao(request.user, 'almanaques', 'visualizar'):
            almanaques = AlmanaqueMilitar.objects.filter(ativo=True).order_by('-data_geracao')
        else:
            almanaques = AlmanaqueMilitar.objects.none()

    # Filtros
    data_inicio = request.GET.get('data_inicio')
    if data_inicio:
        try:
            from datetime import datetime
            data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            almanaques = almanaques.filter(data_geracao__date__gte=data_inicio)
        except ValueError:
            pass
    
    data_fim = request.GET.get('data_fim')
    if data_fim:
        try:
            from datetime import datetime
            data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
            almanaques = almanaques.filter(data_geracao__date__lte=data_fim)
        except ValueError:
            pass
    
    # Pagina√ß√£o
    paginator = Paginator(almanaques, 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # Estat√≠sticas
    total_almanaques = almanaques.count()
    
    # Verificar se o usu√°rio √© membro de alguma comiss√£o
    membro_comissao = MembroComissao.objects.filter(
        usuario=request.user,
        ativo=True,
        comissao__status='ATIVA'
    ).first()
    
    context = {
        'almanaques': page_obj,
        'total_almanaques': total_almanaques,
        'filtros': {
            'data_inicio': data_inicio,
            'data_fim': data_fim,
        },
        'membro_comissao': membro_comissao,
    }
    
    return render(request, 'militares/almanaque/list.html', context)

@login_required
def almanaque_create(request):
    """Cria um novo almanaque"""
    if request.method == 'POST':
        tipo = request.POST.get('tipo', 'GERAL')
        titulo = request.POST.get('titulo', f'Almanaque {tipo.lower().title()} - {timezone.now().strftime("%d/%m/%Y")}')
        observacoes = request.POST.get('observacoes', '')
        status = request.POST.get('status', 'RASCUNHO')
        
        try:
            # 1. Obter dados dos militares
            militares_ativos = Militar.objects.filter(classificacao='ATIVO').exclude(quadro='NVRR')
            
            # 2. Separar oficiais e pra√ßas
            oficiais = [m for m in militares_ativos if m.is_oficial()]
            pracas = [m for m in militares_ativos if not m.is_oficial()]
            
            # 3. Filtrar por tipo
            if tipo == 'OFICIAIS':
                militares_filtrados = oficiais
                titulo_final = "ALMANAQUE DOS OFICIAIS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
            elif tipo == 'PRACAS':
                militares_filtrados = pracas
                titulo_final = "ALMANAQUE DAS PRA√áAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
            else:  # GERAL
                militares_filtrados = list(militares_ativos)
                titulo_final = "ALMANAQUE GERAL DOS MILITARES DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
            
            # 4. Organizar dados para HTML
            dados_organizados = {}
            ordem_postos = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA', 'ST', '1S', '2S', '3S', 'CAB', 'SD']
            
            for posto in ordem_postos:
                militares_posto = [m for m in militares_filtrados if m.posto_graduacao == posto]
                if militares_posto:
                    militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
                    dados_organizados[posto] = militares_posto
            
            # 5. Gerar HTML primeiro
            html_content = gerar_html_almanaque(dados_organizados, titulo_final, observacoes, tipo)
            
            # 6.1. Definir data da √∫ltima promo√ß√£o baseada na data de cria√ß√£o
            from datetime import date
            data_atual = date.today()
            
            # Datas de promo√ß√£o conhecidas
            data_promocao_1 = date(2025, 7, 18)   # 18/07/2025
            data_promocao_2_oficiais = date(2025, 12, 23)  # 23/12/2025
            data_promocao_2_pracas = date(2025, 12, 25)    # 25/12/2025
            
            # Determinar qual data de promo√ß√£o usar baseada na data atual
            if tipo == 'OFICIAIS':
                if data_atual <= data_promocao_2_oficiais:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_oficiais  # 23/12/2025
            elif tipo == 'PRACAS':
                if data_atual <= data_promocao_2_pracas:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_pracas  # 25/12/2025
            else:  # GERAL
                # Para geral, usar a data mais recente entre todas as promo√ß√µes
                if data_atual <= data_promocao_2_pracas:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_pracas  # 25/12/2025
            
            # 7. Criar almanaque no banco (apenas com HTML)
            almanaque = AlmanaqueMilitar.objects.create(
                titulo=titulo,
                tipo=tipo,
                status=status,
                observacoes=observacoes,
                criado_por=request.user,
                conteudo_html=html_content,
                total_oficiais=len(oficiais),
                total_pracas=len(pracas),
                total_geral=len(militares_ativos),
                data_ultima_promocao=data_ultima_promocao,
                ativo=True
            )
            
            messages.success(request, f'Almanaque "{almanaque.titulo}" gerado com sucesso!')
            return redirect('militares:almanaque_detail', pk=almanaque.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao gerar almanaque: {str(e)}')
            return redirect('militares:almanaque_create')
    
    context = {
        'title': 'Gerar Novo Almanaque',
    }
    return render(request, 'militares/almanaque_create.html', context)

@login_required
def almanaque_detail(request, pk):
    """Detalhes de um almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    context = {
        'almanaque': almanaque,
        'title': f'Detalhes do Almanaque - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_detail.html', context)

@login_required
def almanaque_delete(request, pk):
    """Exclui um almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    if not almanaque.pode_ser_excluido():
        messages.error(request, 'Este almanaque n√£o pode ser exclu√≠do.')
        return redirect('militares:almanaque_detail', pk=almanaque.pk)
    
    if request.method == 'POST':
        titulo = almanaque.titulo
        almanaque.delete()
        messages.success(request, f'Almanaque "{titulo}" exclu√≠do com sucesso!')
        return redirect('militares:almanaque_list')
    
    context = {
        'almanaque': almanaque,
        'title': f'Excluir Almanaque - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_delete.html', context)

@login_required
def almanaque_edit(request, pk):
    """Edita um almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    if not almanaque.pode_ser_editado():
        messages.error(request, 'Este almanaque n√£o pode ser editado.')
        return redirect('militares:almanaque_detail', pk=almanaque.pk)
    
    if request.method == 'POST':
        titulo = request.POST.get('titulo', almanaque.titulo)
        observacoes = request.POST.get('observacoes', almanaque.observacoes)
        status = request.POST.get('status', almanaque.status)
        
        try:
            almanaque.titulo = titulo
            almanaque.observacoes = observacoes
            almanaque.status = status
            almanaque.save()
            
            messages.success(request, f'Almanaque "{almanaque.titulo}" atualizado com sucesso!')
            return redirect('militares:almanaque_detail', pk=almanaque.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao atualizar almanaque: {str(e)}')
    
    context = {
        'almanaque': almanaque,
        'title': f'Editar Almanaque - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_edit.html', context)

@login_required
def almanaque_visualizar_html(request, pk):
    """Visualiza o almanaque em HTML"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    # Buscar assinaturas do almanaque
    assinaturas = almanaque.get_assinaturas_ordenadas()
    
    # Buscar fun√ß√µes do usu√°rio para o modal de assinatura
    from .models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True
    ).order_by('funcao_militar__nome')
    
    # Fun√ß√£o atual do usu√°rio (se houver)
    funcao_atual = None
    if funcoes_usuario.exists():
        funcao_atual = funcoes_usuario.first().funcao_militar.nome
    
    context = {
        'almanaque': almanaque,
        'assinaturas': assinaturas,
        'funcoes_usuario': funcoes_usuario,
        'funcao_atual': funcao_atual,
        'title': f'Visualizar Almanaque - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_visualizar_html.html', context)

@login_required
def almanaque_gerar_pdf(request, pk):
    """Gera PDF do almanaque dinamicamente (mesmo padr√£o dos outros documentos)"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    try:
        # Gerar PDF a partir do almanaque espec√≠fico (que inclui assinaturas)
        from .pdf_utils import gerar_pdf_almanaque_direct
        pdf_content = gerar_pdf_almanaque_direct(almanaque, request)
        
        # Retornar o PDF para visualiza√ß√£o em nova guia (mesmo padr√£o dos quadros)
        from io import BytesIO
        response = HttpResponse(content_type='application/pdf')
        response['Content-Disposition'] = f'inline; filename="almanaque_{almanaque.ano}.pdf"'
        response.write(pdf_content)
        return response
    except Exception as e:
        messages.error(request, f'Erro ao gerar PDF: {e}')
        return redirect('militares:almanaque_detail', pk=pk)

# =============================================================================
# VIEWS PARA LOGS DO SISTEMA
# =============================================================================


@login_required
@administracao_required
def logs_sistema_list(request):
    """Lista de logs do sistema"""
    from .models import LogSistema
    from django.core.paginator import Paginator
    
    logs = LogSistema.objects.all().order_by('-timestamp')
    
    # Filtros
    nivel = request.GET.get('nivel')
    modulo = request.GET.get('modulo')
    acao = request.GET.get('acao')
    usuario = request.GET.get('usuario')
    data_inicio = request.GET.get('data_inicio')
    data_fim = request.GET.get('data_fim')
    
    if nivel:
        logs = logs.filter(nivel=nivel)
    if modulo:
        logs = logs.filter(modulo=modulo)
    if acao:
        logs = logs.filter(acao=acao)
    if usuario:
        logs = logs.filter(usuario__username__icontains=usuario)
    if data_inicio:
        logs = logs.filter(timestamp__date__gte=data_inicio)
    if data_fim:
        logs = logs.filter(timestamp__date__lte=data_fim)
    
    # Pagina√ß√£o
    paginator = Paginator(logs, 50)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    # Estat√≠sticas
    estatisticas = LogSistema.get_estatisticas()
    
    context = {
        'page_obj': page_obj,
        'is_paginated': page_obj.has_other_pages,
        'estatisticas': estatisticas,
        'total_logs': logs.count(),
        'filtros': {
            'nivel': nivel,
            'modulo': modulo,
            'acao': acao,
            'usuario': usuario,
            'data_inicio': data_inicio,
            'data_fim': data_fim,
        },
        'niveis': LogSistema.NIVEL_CHOICES,
        'modulos': LogSistema.MODULO_CHOICES,
        'acoes': LogSistema.ACAO_CHOICES,
    }
    
    return render(request, 'militares/logs/list.html', context)


@login_required
@administracao_required
def logs_sistema_detail(request, pk):
    """Detalhes de um log espec√≠fico"""
    try:
        log = LogSistema.objects.get(pk=pk)
    except LogSistema.DoesNotExist:
        messages.error(request, 'Log n√£o encontrado.')
        return redirect('militares:logs_sistema_list')
    
    context = {
        'log': log,
    }
    
    return render(request, 'militares/logs/detail.html', context)


@login_required
@administracao_required
def logs_sistema_marcar_processado(request, pk):
    """Marca um log como processado"""
    try:
        log = LogSistema.objects.get(pk=pk)
        log.marcar_como_processado()
        messages.success(request, 'Log marcado como processado.')
    except LogSistema.DoesNotExist:
        messages.error(request, 'Log n√£o encontrado.')
    
    return redirect('militares:logs_sistema_detail', pk=pk)


@login_required
@administracao_required
def logs_sistema_marcar_notificado(request, pk):
    """Marca um log como notificado"""
    try:
        log = LogSistema.objects.get(pk=pk)
        log.marcar_como_notificado()
        messages.success(request, 'Log marcado como notificado.')
    except LogSistema.DoesNotExist:
        messages.error(request, 'Log n√£o encontrado.')
    
    return redirect('militares:logs_sistema_detail', pk=pk)


@login_required
@administracao_required
def logs_sistema_limpar_antigos(request):
    """Remove logs antigos"""
    if request.method == 'POST':
        dias = int(request.POST.get('dias', 30))
        logs_removidos = LogSistema.limpar_logs_antigos(dias)
        messages.success(request, f'{logs_removidos} logs antigos removidos.')
        return redirect('militares:logs_sistema_list')
    
    return render(request, 'militares/logs/limpar_antigos.html')


@login_required
@administracao_required
def logs_sistema_estatisticas(request):
    """Estat√≠sticas dos logs"""
    data_inicio = request.GET.get('data_inicio')
    data_fim = request.GET.get('data_fim')
    
    if data_inicio:
        data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
    if data_fim:
        data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
    
    estatisticas = LogSistema.get_estatisticas(data_inicio, data_fim)
    
    # Logs por hora (√∫ltimas 24 horas)
    from django.utils import timezone
    from datetime import timedelta
    
    agora = timezone.now()
    ontem = agora - timedelta(days=1)
    
    logs_por_hora = LogSistema.objects.filter(
        timestamp__gte=ontem
    ).extra(
        select={'hora': "EXTRACT(hour FROM timestamp)"}
    ).values('hora').annotate(
        count=Count('id')
    ).order_by('hora')
    
    # Logs por n√≠vel (√∫ltimos 7 dias)
    ultima_semana = agora - timedelta(days=7)
    logs_por_nivel = LogSistema.objects.filter(
        timestamp__gte=ultima_semana
    ).values('nivel').annotate(
        count=Count('id')
    ).order_by('-count')
    
    # Logs por m√≥dulo (√∫ltimos 7 dias)
    logs_por_modulo = LogSistema.objects.filter(
        timestamp__gte=ultima_semana
    ).values('modulo').annotate(
        count=Count('id')
    ).order_by('-count')
    
    context = {
        'estatisticas': estatisticas,
        'logs_por_hora': logs_por_hora,
        'logs_por_nivel': logs_por_nivel,
        'logs_por_modulo': logs_por_modulo,
        'data_inicio': data_inicio,
        'data_fim': data_fim,
    }
    
    return render(request, 'militares/logs/estatisticas.html', context)


@login_required
@administracao_required
def logs_sistema_exportar(request):
    """Exporta logs para CSV"""
    from django.http import HttpResponse
    import csv
    
    logs = LogSistema.objects.all()
    
    # Aplicar filtros
    nivel = request.GET.get('nivel')
    modulo = request.GET.get('modulo')
    acao = request.GET.get('acao')
    data_inicio = request.GET.get('data_inicio')
    data_fim = request.GET.get('data_fim')
    
    if nivel:
        logs = logs.filter(nivel=nivel)
    if modulo:
        logs = logs.filter(modulo=modulo)
    if acao:
        logs = logs.filter(acao=acao)
    if data_inicio:
        logs = logs.filter(timestamp__date__gte=data_inicio)
    if data_fim:
        logs = logs.filter(timestamp__date__lte=data_fim)
    
    # Criar resposta CSV
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = f'attachment; filename="logs_sistema_{timezone.now().strftime("%Y%m%d_%H%M%S")}.csv"'
    
    writer = csv.writer(response)
    writer.writerow([
        'Data/Hora', 'N√≠vel', 'M√≥dulo', 'A√ß√£o', 'Usu√°rio', 'Descri√ß√£o',
        'Modelo Afetado', 'ID Objeto', 'IP', 'URL', 'M√©todo HTTP',
        'Tempo Execu√ß√£o', 'Erro', 'Processado', 'Notificado'
    ])
    
    for log in logs:
        writer.writerow([
            log.timestamp.strftime('%d/%m/%Y %H:%M:%S'),
            log.get_nivel_display(),
            log.get_modulo_display(),
            log.get_acao_display(),
            log.usuario.username if log.usuario else '',
            log.descricao,
            log.modelo_afetado or '',
            log.objeto_id or '',
            log.ip_address or '',
            log.url or '',
            log.metodo_http or '',
            log.tempo_execucao or '',
            log.erro or '',
            'Sim' if log.processado else 'N√£o',
            'Sim' if log.notificado else 'N√£o',
        ])
    
    return response

@login_required
def almanaque_assinatura_create(request, pk):
    """Cria uma assinatura para o almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    if not almanaque.pode_ser_assinado():
        messages.error(request, 'Este almanaque n√£o pode ser assinado.')
        return redirect('militares:almanaque_visualizar_html', pk=almanaque.pk)
    
    if request.method == 'POST':
        tipo_assinatura = request.POST.get('tipo_assinatura', 'APROVACAO')
        funcao_militar = request.POST.get('funcao_militar', '')
        observacoes = request.POST.get('observacoes', '')
        senha = request.POST.get('senha', '')
        
        # Verificar senha
        if not request.user.check_password(senha):
            messages.error(request, 'Senha incorreta. Por favor, tente novamente.')
            return redirect('militares:almanaque_visualizar_html', pk=almanaque.pk)
        
        try:
            # Verificar se j√° existe assinatura deste tipo
            if AssinaturaAlmanaque.objects.filter(
                almanaque=almanaque,
                assinado_por=request.user,
                tipo_assinatura=tipo_assinatura
            ).exists():
                messages.error(request, 'Voc√™ j√° assinou este almanaque com este tipo de assinatura.')
                return redirect('militares:almanaque_visualizar_html', pk=almanaque.pk)
            
            # Criar assinatura
            assinatura = AssinaturaAlmanaque.objects.create(
                almanaque=almanaque,
                assinado_por=request.user,
                tipo_assinatura=tipo_assinatura,
                funcao_militar=funcao_militar,
                observacoes=observacoes
            )
            
            messages.success(request, f'Assinatura adicionada com sucesso ao almanaque "{almanaque.titulo}"!')
            return redirect('militares:almanaque_visualizar_html', pk=almanaque.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao criar assinatura: {str(e)}')
    
    # Buscar assinaturas existentes do usu√°rio
    assinaturas_existentes = AssinaturaAlmanaque.objects.filter(
        almanaque=almanaque,
        assinado_por=request.user
    ).order_by('data_assinatura')
    
    context = {
        'almanaque': almanaque,
        'assinaturas_existentes': assinaturas_existentes,
        'title': f'Assinar Almanaque - {almanaque.titulo}',
        'now': timezone.now(),
    }
    return render(request, 'militares/almanaque_assinatura_create.html', context)

@login_required
def almanaque_assinatura_delete(request, pk, assinatura_pk):
    """Remove uma assinatura do almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    assinatura = get_object_or_404(AssinaturaAlmanaque, pk=assinatura_pk, almanaque=almanaque)
    
    # Verificar permiss√£o
    if assinatura.assinado_por != request.user and not request.user.is_superuser:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para remover esta assinatura.')
        return redirect('militares:almanaque_detail', pk=almanaque.pk)
    
    if request.method == 'POST':
        assinatura.delete()
        messages.success(request, 'Assinatura removida com sucesso!')
        return redirect('militares:almanaque_detail', pk=almanaque.pk)
    
    context = {
        'almanaque': almanaque,
        'assinatura': assinatura,
        'title': f'Remover Assinatura - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_assinatura_delete.html', context)

def gerar_pdf_almanaque(tipo):
    """Fun√ß√£o auxiliar para gerar o conte√∫do PDF do almanaque no padr√£o institucional"""
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from io import BytesIO
    import os
    import qrcode
    import locale
    from datetime import datetime
    from django.utils import timezone

    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar

    # Definir ordem hier√°rquica dos postos
    ordem_postos_oficiais = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    ordem_postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    
    # Buscar todos os militares ativos (excluindo NVRR)
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').exclude(quadro='NVRR').order_by('posto_graduacao', 'numeracao_antiguidade', 'data_promocao_atual')
    
    # Separar oficiais e pra√ßas (excluindo NVRR)
    oficiais = []
    pracas = []
    
    for militar in militares_ativos:
        # Verifica√ß√£o adicional para excluir NVRR pelo quadro
        if militar.quadro == 'NVRR':
            continue
        elif militar.is_oficial():
            oficiais.append(militar)
        else:
            pracas.append(militar)
    
    # Organizar por hierarquia
    oficiais_organizados = {}
    for posto in ordem_postos_oficiais:
        militares_posto = [m for m in oficiais if m.posto_graduacao == posto]
        if militares_posto:
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            oficiais_organizados[posto] = militares_posto
    
    pracas_organizadas = {}
    for posto in ordem_postos_pracas:
        militares_posto = [m for m in pracas if m.posto_graduacao == posto]
        if militares_posto:
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            pracas_organizadas[posto] = militares_posto
    
    # Determinar t√≠tulo e dados baseado no tipo
    if tipo == 'OFICIAIS':
        titulo = "ALMANAQUE DOS OFICIAIS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = oficiais_organizados
        ordem_postos = ordem_postos_oficiais
        total = len(oficiais)
    elif tipo == 'PRACAS':
        titulo = "ALMANAQUE DAS PRA√áAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = pracas_organizadas
        ordem_postos = ordem_postos_pracas
        total = len(pracas)
    else:  # GERAL
        titulo = "ALMANAQUE GERAL DOS MILITARES DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = {**oficiais_organizados, **pracas_organizadas}
        ordem_postos = ordem_postos_oficiais + ordem_postos_pracas
        total = len(militares_ativos)

    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=2*cm, leftMargin=2*cm, topMargin=2*cm, bottomMargin=2*cm)
    styles = getSampleStyleSheet()

    # Estilos customizados
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=1, fontSize=13, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=1, fontSize=11, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    style_signature = ParagraphStyle('signature', parent=styles['Normal'], fontSize=10, spaceAfter=6)

    story = []

    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))

    # Determinar local de gera√ß√£o baseado na fun√ß√£o do usu√°rio (hierarquia completa)
    local_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario and funcao_usuario.funcao_militar:
        hierarquia = []
        
        # Construir hierarquia completa at√© a inst√¢ncia mais espec√≠fica
        if hasattr(funcao_usuario, 'orgao') and funcao_usuario.orgao:
            hierarquia.append(funcao_usuario.orgao.nome.upper())
        if hasattr(funcao_usuario, 'grande_comando') and funcao_usuario.grande_comando:
            hierarquia.append(funcao_usuario.grande_comando.nome.upper())
        if hasattr(funcao_usuario, 'unidade') and funcao_usuario.unidade:
            hierarquia.append(funcao_usuario.unidade.nome.upper())
        if hasattr(funcao_usuario, 'sub_unidade') and funcao_usuario.sub_unidade:
            hierarquia.append(funcao_usuario.sub_unidade.nome.upper())
        
        # Se encontrou alguma inst√¢ncia, usar a mais espec√≠fica (√∫ltima da lista)
        if hierarquia:
            local_geracao = hierarquia[-1]
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        local_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))

    # T√≠tulo centralizado e sublinhado
    titulo_formatado = f'<u>{titulo}</u>'
    story.append(Paragraph(titulo_formatado, style_title))
    story.append(Spacer(1, 16))

    # Texto introdut√≥rio
    story.append(Paragraph("O DIRETOR DE GEST√ÉO DE PESSOAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç, no uso de suas atribui√ß√µes que lhe confere o Art. 18, da lei 5.949, de 17 de dezembro de 2009, alterado pelo Art. 1¬∞ da lei 7.772, de 04 de abril de 2022;", style_just))
    story.append(Spacer(1, 8))
    
    story.append(Paragraph("CONSIDERANDO o Anexo √önico, da lei n¬∫ 5.949, de 17 de dezembro de 2009 (Lei de Organiza√ß√£o B√°sica do CBMEPI), alterado pela Lei 7.772, de 04 de abril de 2022;", style_just))
    story.append(Spacer(1, 8))
    
    story.append(Paragraph("CONSIDERANDO a necessidade de manter atualizado o almanaque dos militares do CBMEPI;", style_just))
    story.append(Spacer(1, 8))
    
    story.append(Paragraph("RESOLVE:", style_just))
    story.append(Spacer(1, 16))
    
    # Artigo 1¬∫
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    # Definir datas de promo√ß√£o conforme o tipo e data de gera√ß√£o
    from django.utils import timezone
    data_atual = timezone.localtime(timezone.now())
    
    if tipo == 'OFICIAIS':
        tipo_militar = '<b><u>OFICIAIS</u></b>'
        # Se gerado entre 18/07 e 23/12: usar 18/07/2025
        # Se gerado entre 23/12 e 18/07: usar 23/12/2025
        if (data_atual.month == 7 and data_atual.day >= 18) or (data_atual.month > 7 and data_atual.month < 12) or (data_atual.month == 12 and data_atual.day < 23):
            data_formatada = "18/07/2025"
        else:
            data_formatada = "23/12/2025"
    elif tipo == 'PRACAS':
        tipo_militar = '<b><u>PRA√áAS</u></b>'
        # Se gerado entre 18/07 e 25/12: usar 18/07/2025
        # Se gerado entre 25/12 e 18/07: usar 25/12/2025
        if (data_atual.month == 7 and data_atual.day >= 18) or (data_atual.month > 7 and data_atual.month < 12) or (data_atual.month == 12 and data_atual.day < 25):
            data_formatada = "18/07/2025"
        else:
            data_formatada = "25/12/2025"
    else:
        tipo_militar = "Militares"
        data_formatada = "18/07/2025"
    
    artigo_1 = f"""
    <b>Art. 1¬∫</b> Fica fixada a antiguidade dos {tipo_militar} do Corpo de Bombeiros Militar do Estado do Piau√≠, ap√≥s as promo√ß√µes ocorridas em {data_formatada}, conforme segue:
    """
    
    story.append(Paragraph(artigo_1, style_bold))
    story.append(Spacer(1, 16))

    # Tabela principal com dados dos militares
    for posto in ordem_postos:
        if posto in dados_organizados and dados_organizados[posto]:
            militares = dados_organizados[posto]
            
            # Nome completo do posto
            nomes_postos = {
                'CB': 'CORONEL',
                'TC': 'TENENTE-CORONEL',
                'MJ': 'MAJOR',
                'CP': 'CAPIT√ÉO',
                '1T': '1¬∫ TENENTE',
                '2T': '2¬∫ TENENTE',
                'AS': 'ASPIRANTE',
                'AA': 'ALUNO-ASTO',
                'ST': 'SUBTENENTE',
                '1S': '1¬∫ SARGENTO',
                '2S': '2¬∫ SARGENTO',
                '3S': '3¬∫ SARGENTO',
                'CAB': 'CABO',
                'SD': 'SOLDADO'
            }
            
            nome_posto = nomes_postos.get(posto, posto)
            story.append(Paragraph(f"<b>{nome_posto} ({len(militares)})</b>", style_subtitle))
            story.append(Spacer(1, 8))
            
            # Cabe√ßalho da tabela
            header_data = [['ORD', 'CPF', 'POSTO/GRADUA√á√ÉO', 'NOME', 'ANTIGUIDADE', 'DATA PROMO√á√ÉO']]
            
            # Dados dos militares
            for i, militar in enumerate(militares, 1):
                # Criptografar CPF
                cpf_criptografado = criptografar_cpf(militar.cpf)
                
                header_data.append([
                    str(i),
                    cpf_criptografado,
                    militar.get_posto_graduacao_display(),
                    militar.nome_completo,
                    str(militar.numeracao_antiguidade or '-'),
                    militar.data_promocao_atual.strftime('%d/%m/%Y') if militar.data_promocao_atual else '-'
                ])
            
            # Criar tabela com larguras espec√≠ficas
            table = Table(header_data, colWidths=[1.5*cm, 3*cm, 4*cm, 6*cm, 2*cm, 3*cm])
            table.setStyle(TableStyle([
                ('ALIGN', (0, 0), (-1, 0), 'CENTER'),  # Cabe√ßalho centralizado
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 9),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
                ('FONTSIZE', (0, 1), (-1, -1), 8),
                ('ALIGN', (0, 1), (0, -1), 'CENTER'),  # ORD centralizada
                ('ALIGN', (1, 1), (1, -1), 'CENTER'),  # CPF centralizado
                ('ALIGN', (2, 1), (2, -1), 'CENTER'),  # POSTO centralizado
                ('ALIGN', (3, 1), (3, -1), 'LEFT'),    # NOME alinhado √† esquerda
                ('ALIGN', (4, 1), (4, -1), 'CENTER'),  # ANTIGUIDADE centralizada
                ('ALIGN', (5, 1), (5, -1), 'CENTER'),  # DATA centralizada
                ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'), # Alinhamento vertical centralizado
                ('LEFTPADDING', (0, 0), (-1, -1), 4),
                ('RIGHTPADDING', (0, 0), (-1, -1), 4),
                ('TOPPADDING', (0, 0), (-1, -1), 3),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 3),
            ]))
            
            story.append(table)
            story.append(Spacer(1, 15))

    # Estat√≠sticas
    story.append(Spacer(1, 40))
    stats_data = [
        ['ESTAT√çSTICAS', ''],
        ['Total de Militares', str(total)],
    ]
    
    if tipo == 'GERAL':
        stats_data.extend([
            ['Oficiais', str(len(oficiais))],
            ['Pra√ßas', str(len(pracas))],
        ])
    
    stats_table = Table(stats_data, colWidths=[8*cm, 4*cm])
    stats_table.setStyle(TableStyle([
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
        ('FONTSIZE', (0, 1), (-1, -1), 10),
    ]))
    
    story.append(stats_table)
    story.append(Spacer(1, 30))
    
    # Data e local
    story.append(Paragraph(f"Teresina, {data_formatada}", style_center))
    
    
    
    # Rodap√© com QR Code para confer√™ncia de veracidade
    story.append(Spacer(1, 8))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Gerar QR Code com informa√ß√µes do documento
    qr_data = f"ALMANAQUE {tipo} - CBMEPI - {data_atual.strftime('%d/%m/%Y %H:%M')}"
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(qr_data)
    qr.make(fit=True)
    
    # Criar imagem do QR Code
    qr_img = qr.make_image(fill_color="black", back_color="white")
    qr_buffer = BytesIO()
    qr_img.save(qr_buffer, format='PNG')
    qr_buffer.seek(0)
    
    # Adicionar QR Code ao PDF
    story.append(Image(qr_buffer, width=2*cm, height=2*cm, hAlign='CENTER'))
    story.append(Spacer(1, 6))
    
    # Texto de autentica√ß√£o
    texto_autenticacao = f"""
    <b>DOCUMENTO OFICIAL</b><br/>
    Almanaque {tipo} do Corpo de Bombeiros Militar do Estado do Piau√≠<br/>
    Gerado em {data_atual.strftime('%d/%m/%Y √†s %H:%M:%S')}<br/>
    Total de militares: {total}<br/>
    <i>Este documento pode ser verificado atrav√©s do QR Code acima</i>
    """
    
    story.append(Paragraph(texto_autenticacao, style_small))
    
    # Construir o PDF
    doc.build(story)
    
    # Retornar o conte√∫do do PDF
    pdf_content = buffer.getvalue()
    buffer.close()
    
    return pdf_content

@login_required
def almanaque_visualizar(request, pk):
    """Visualiza um almanaque - abre o PDF em nova aba"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    if almanaque.arquivo_pdf:
        # Redirecionar para o PDF em nova aba
        return redirect(almanaque.arquivo_pdf.url)
    else:
        messages.error(request, 'PDF n√£o encontrado para este almanaque.')
        return redirect('militares:almanaque_list')

@login_required
def almanaque_assinar(request, pk):
    """Assina um almanaque"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    if request.method == 'POST':
        # Verificar se j√° assinou
        if AssinaturaAlmanaque.objects.filter(almanaque=almanaque, assinado_por=request.user).exists():
            messages.warning(request, 'Voc√™ j√° assinou este almanaque.')
            return redirect('militares:almanaque_visualizar', pk=pk)
        
        # Criar assinatura
        assinatura = AssinaturaAlmanaque.objects.create(
            almanaque=almanaque,
            assinado_por=request.user,
            funcao_militar=request.POST.get('funcao_militar', ''),
            observacoes=request.POST.get('observacoes', '')
        )
        
        messages.success(request, 'Almanaque assinado com sucesso!')
        return redirect('militares:almanaque_visualizar', pk=pk)
    
    # Buscar cargos/fun√ß√µes do usu√°rio
    cargos_funcoes = UsuarioFuncaoMilitar.objects.filter(usuario=request.user, ativo=True)
    
    context = {
        'almanaque': almanaque,
        'cargos_funcoes': cargos_funcoes,
        'title': f'Assinar Almanaque - {almanaque.titulo}',
    }
    return render(request, 'militares/almanaque_assinar.html', context)

@login_required
def almanaque_gerar_pdf_com_assinaturas(request, pk):
    """Gera PDF do almanaque com assinaturas"""
    almanaque = get_object_or_404(AlmanaqueMilitar, pk=pk)
    
    # Buscar assinaturas
    assinaturas = AssinaturaAlmanaque.objects.filter(almanaque=almanaque).order_by('data_assinatura')
    
    # Gerar PDF com assinaturas
    pdf_content = gerar_pdf_almanaque_com_assinaturas(almanaque, assinaturas)
    
    # Criar resposta HTTP
    response = HttpResponse(pdf_content, content_type='application/pdf')
    response['Content-Disposition'] = f'attachment; filename="almanaque_{almanaque.tipo}_{almanaque.data_geracao.strftime("%Y%m%d_%H%M%S")}_assinado.pdf"'
    
    return response

def gerar_pdf_almanaque_com_assinaturas(almanaque, assinaturas):
    """Gera PDF do almanaque com assinaturas"""
    # Criar buffer para o PDF
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4)
    story = []
    
    # Estilos
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=16,
        spaceAfter=30,
        alignment=1,
        textColor=colors.darkblue
    )
    
    subtitle_style = ParagraphStyle(
        'CustomSubtitle',
        parent=styles['Heading2'],
        fontSize=14,
        spaceAfter=20,
        textColor=colors.darkblue
    )
    
    # T√≠tulo principal
    story.append(Paragraph("ALMANAQUE DOS MILITARES", title_style))
    story.append(Paragraph(f"T√≠tulo: {almanaque.titulo}", subtitle_style))
    story.append(Paragraph(f"Tipo: {almanaque.get_tipo_display()}", subtitle_style))
    story.append(Paragraph(f"Data de Gera√ß√£o: {almanaque.data_geracao.strftime('%d/%m/%Y √†s %H:%M')}", subtitle_style))
    story.append(Spacer(1, 40))
    
    # Estat√≠sticas
    story.append(Paragraph("ESTAT√çSTICAS", subtitle_style))
    stats_data = [
        ['Categoria', 'Quantidade'],
        ['Oficiais', str(almanaque.total_oficiais)],
        ['Pra√ßas', str(almanaque.total_pracas)],
        ['Total', str(almanaque.total_geral)]
    ]
    
    stats_table = Table(stats_data, colWidths=[2*inch, 1*inch])
    stats_table.setStyle(TableStyle([
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ('ALIGN', (0, 1), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
        ('FONTSIZE', (0, 1), (-1, -1), 10),
    ]))
    
    story.append(stats_table)

    
    # Se√ß√£o de assinaturas
    if assinaturas.exists():
        story.append(Paragraph("ASSINATURAS", subtitle_style))
        story.append(Spacer(1, 40))
        
        # Tabela de assinaturas
        assinaturas_data = [['Assinado por', 'Cargo/Fun√ß√£o', 'Data', 'Observa√ß√µes']]
        
        for assinatura in assinaturas:
            assinaturas_data.append([
                assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username,
                assinatura.funcao_militar,
                assinatura.data_assinatura.strftime('%d/%m/%Y √†s %H:%M'),
                assinatura.observacoes or '-'
            ])
        
        assinaturas_table = Table(assinaturas_data, colWidths=[2*inch, 2*inch, 1*inch, 2*inch])
        assinaturas_table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('ALIGN', (0, 1), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
        ]))
        
        story.append(assinaturas_table)
    else:
        story.append(Paragraph("Nenhuma assinatura registrada.", subtitle_style))
    
    # Adicionar autenticador de veracidade
    story.append(Spacer(1, 20))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(almanaque, None, tipo_documento='almanaque')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], styles['Normal'])]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[2*inch, 4*inch])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 6),
        ('RIGHTPADDING', (0, 0), (-1, -1), 6),
        ('TOPPADDING', (0, 0), (-1, -1), 6),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
    ]))
    
    story.append(rodape_table)
    
    # Construir PDF
    doc.build(story)
    pdf_content = buffer.getvalue()
    buffer.close()
    
    return pdf_content

@admin_bypass
def criar_usuario_admin_web(request):
    """View para criar usu√°rios admin via web"""
    
    if request.method == 'POST':
        username = request.POST.get('username')
        first_name = request.POST.get('first_name')
        last_name = request.POST.get('last_name')
        email = request.POST.get('email')
        password = request.POST.get('password')
        confirm_password = request.POST.get('confirm_password')
        
        # Valida√ß√µes
        if not username or not password:
            messages.error(request, 'Username e senha s√£o obrigat√≥rios!')
            return redirect('militares:criar_usuario_admin')
        
        if password != confirm_password:
            messages.error(request, 'Senhas n√£o coincidem!')
            return redirect('militares:criar_usuario_admin')
        
        if User.objects.filter(username=username).exists():
            messages.error(request, f'Usu√°rio "{username}" j√° existe!')
            return redirect('militares:criar_usuario_admin')
        
        try:
            # Criar usu√°rio
            user = User.objects.create_user(
                username=username,
                email=email,
                password=password,
                first_name=first_name,
                last_name=last_name,
                is_staff=True,
                is_superuser=True,
                is_active=True
            )
            
            # Configurar permiss√µes
            todas_permissoes = Permission.objects.all()
            user.user_permissions.set(todas_permissoes)
            
            # Adicionar a todos os grupos
            todos_grupos = Group.objects.all()
            for grupo in todos_grupos:
                user.groups.add(grupo)
            
            # Configurar fun√ß√£o de administrador
            cargo_admin = FuncaoMilitar.objects.get_or_create(
                nome='Administrador',
                defaults={
                    'descricao': 'Administrador do sistema com acesso total',
                    'ativo': True
                }
            )[0]
            
            UsuarioFuncaoMilitar.objects.get_or_create(
                usuario=user,
                funcao_militar=cargo_admin,
                defaults={
                    'tipo_funcao': 'EFETIVA',
                    'status': 'ATIVO',
                    'data_inicio': '2024-01-01'
                }
            )
            
            messages.success(request, f'Usu√°rio admin "{username}" criado com sucesso!')
            return redirect('militares:listar_usuarios_admin')
            
        except Exception as e:
            messages.error(request, f'Erro ao criar usu√°rio: {e}')
            return redirect('militares:criar_usuario_admin')
    
    return render(request, 'militares/usuarios/criar_usuario_admin.html')

@admin_bypass
def listar_usuarios_admin_web(request):
    """View para listar usu√°rios admin via web"""
    
    admins = User.objects.filter(is_superuser=True).order_by('username')
    
    # Buscar fun√ß√µes de cada admin
    for admin in admins:
        admin.funcao_ativa = UsuarioFuncaoMilitar.objects.filter(
            usuario=admin,
            ativo=True
        ).first()
    
    context = {
        'admins': admins,
    }
    
    return render(request, 'militares/usuarios/listar_usuarios_admin.html', context)

@admin_bypass
def remover_usuario_admin_web(request, user_id):
    """View para remover usu√°rio admin via web"""
    
    try:
        user = User.objects.get(id=user_id)
        
        if not user.is_superuser:
            messages.error(request, f'Usu√°rio "{user.username}" n√£o √© admin!')
            return redirect('militares:listar_usuarios_admin')
        
        if user.username == 'admin':
            messages.error(request, 'N√£o √© poss√≠vel remover o usu√°rio admin principal!')
            return redirect('militares:listar_usuarios_admin')
        
        username = user.username
        user.delete()
        
        messages.success(request, f'Usu√°rio admin "{username}" removido com sucesso!')
        
    except User.DoesNotExist:
        messages.error(request, 'Usu√°rio n√£o encontrado!')
    
    return redirect('militares:listar_usuarios_admin')

@admin_bypass
def gerenciar_usuarios_admin(request):
    """View principal para gerenciar usu√°rios admin"""
    
    total_admins = User.objects.filter(is_superuser=True).count()
    admins_ativos = User.objects.filter(is_superuser=True, is_active=True).count()
    
    context = {
        'total_admins': total_admins,
        'admins_ativos': admins_ativos,
    }
    
    return render(request, 'militares/usuarios/gerenciar_usuarios_admin.html', context)

@login_required
@requer_funcao_ativa
def militar_list_paginada(request):
    """Lista todos os militares ativos com pagina√ß√£o simples"""
    # Buscar todos os militares ativos
    militares = Militar.objects.filter(classificacao='ATIVO').order_by('nome_completo')
    
    # Pagina√ß√£o
    itens_por_pagina = request.GET.get('itens_por_pagina', 20)
    try:
        itens_por_pagina = int(itens_por_pagina)
        if itens_por_pagina not in [20, 50, 100]:
            itens_por_pagina = 20
    except (ValueError, TypeError):
        itens_por_pagina = 20
    
    paginator = Paginator(militares, itens_por_pagina)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'militares': page_obj,
        'page_obj': page_obj,
        'itens_por_pagina': itens_por_pagina,
        'total_militares': militares.count(),
    }
    
    return render(request, 'militares/militar_list.html', context) 

@login_required
def almanaque_preview(request):
    """Gera preview HTML do almanaque"""
    from django.http import JsonResponse
    
    tipo = request.GET.get('tipo', 'GERAL')
    titulo = request.GET.get('titulo', '')
    observacoes = request.GET.get('observacoes', '')
    
    try:
        # Obter dados organizados
        dados_organizados, titulo_final, total = obter_dados_almanaque(tipo)
        
        # Gerar HTML
        html_content = gerar_html_almanaque(dados_organizados, titulo_final, observacoes, tipo)
        
        return JsonResponse({
            'success': True,
            'html': html_content,
            'total': total
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        })

@login_required
def almanaque_gerar_pdf_preview(request):
    """Gera PDF do almanaque baseado no preview"""
    tipo = request.GET.get('tipo', 'GERAL')
    titulo = request.GET.get('titulo', '')
    observacoes = request.GET.get('observacoes', '')
    
    # Gerar o PDF usando a fun√ß√£o correta
    from .pdf_utils import gerar_pdf_almanaque_direct_old
    pdf_content = gerar_pdf_almanaque_direct_old(tipo)
    
    # Criar resposta HTTP
    response = HttpResponse(pdf_content, content_type='application/pdf')
    filename = f'almanaque_{tipo.lower()}_{timezone.now().strftime("%Y%m%d_%H%M%S")}.pdf'
    response['Content-Disposition'] = f'attachment; filename="{filename}"'
    
    return response

def obter_dados_almanaque(tipo):
    """Fun√ß√£o auxiliar para obter dados organizados do almanaque"""
    # Definir ordem hier√°rquica dos postos
    ordem_postos_oficiais = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    ordem_postos_pracas = ['ST', '1S', '2S', '3S', 'CAB', 'SD']
    
    # Buscar todos os militares ativos (excluindo NVRR)
    militares_ativos = Militar.objects.filter(classificacao='ATIVO').exclude(quadro='NVRR').order_by('posto_graduacao', 'numeracao_antiguidade', 'data_promocao_atual')
    
    # Separar oficiais e pra√ßas (excluindo NVRR)
    oficiais = []
    pracas = []
    
    for militar in militares_ativos:
        if militar.quadro == 'NVRR':
            continue
        elif militar.is_oficial():
            oficiais.append(militar)
        else:
            pracas.append(militar)
    
    # Organizar por hierarquia
    oficiais_organizados = {}
    for posto in ordem_postos_oficiais:
        militares_posto = [m for m in oficiais if m.posto_graduacao == posto]
        if militares_posto:
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            oficiais_organizados[posto] = militares_posto
    
    pracas_organizadas = {}
    for posto in ordem_postos_pracas:
        militares_posto = [m for m in pracas if m.posto_graduacao == posto]
        if militares_posto:
            militares_posto.sort(key=lambda x: (x.numeracao_antiguidade or 999999, x.data_promocao_atual or datetime.date.max))
            pracas_organizadas[posto] = militares_posto
    
    # Determinar t√≠tulo e dados baseado no tipo
    if tipo == 'OFICIAIS':
        titulo = "ALMANAQUE DOS OFICIAIS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = oficiais_organizados
        total = len(oficiais)
    elif tipo == 'PRACAS':
        titulo = "ALMANAQUE DAS PRA√áAS DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = pracas_organizadas
        total = len(pracas)
    else:  # GERAL
        titulo = "ALMANAQUE GERAL DOS MILITARES DO CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç"
        dados_organizados = {**oficiais_organizados, **pracas_organizadas}
        total = len(militares_ativos)
    
    return dados_organizados, titulo, total

def criptografar_cpf(cpf):
    """
    Criptografa o CPF mostrando apenas os primeiros 3 d√≠gitos e os √∫ltimos 2
    Exemplo: 123.456.789-00 -> 123.***.***-00
    """
    if not cpf:
        return cpf
    
    # Remover pontos e tra√ßos
    cpf_limpo = cpf.replace('.', '').replace('-', '')
    
    if len(cpf_limpo) != 11:
        return cpf
    
    # Retornar CPF criptografado
    return f"{cpf_limpo[:3]}.***.***-{cpf_limpo[-2:]}"

def gerar_html_almanaque(dados_organizados, titulo, observacoes, tipo):
    """Gera HTML do almanaque para preview"""
    from django.template.loader import render_to_string
    
    # Mapear postos para nomes completos
    nomes_postos = {
        'CB': 'CORONEL',
        'TC': 'TENENTE-CORONEL',
        'MJ': 'MAJOR',
        'CP': 'CAPIT√ÉO',
        '1T': '1¬∫ TENENTE',
        '2T': '2¬∫ TENENTE',
        'AS': 'ASPIRANTE',
        'AA': 'ALUNO-ASTO',
        'ST': 'SUBTENENTE',
        '1S': '1¬∫ SARGENTO',
        '2S': '2¬∫ SARGENTO',
        '3S': '3¬∫ SARGENTO',
        'CAB': 'CABO',
        'SD': 'SOLDADO'
    }
    
    # Preparar dados para o template
    secoes = []
    ordem_total = 1
    
    for posto, militares in dados_organizados.items():
        if militares:
            secao = {
                'posto': posto,
                'nome_posto': nomes_postos.get(posto, posto),
                'militares': []
            }
            
            for militar in militares:
                # Criptografar CPF
                cpf_criptografado = criptografar_cpf(militar.cpf)
                
                secao['militares'].append({
                    'ordem': ordem_total,
                    'cpf': cpf_criptografado,
                    'posto': militar.get_posto_graduacao_display(),
                    'nome': militar.nome_completo,
                    'antiguidade': militar.numeracao_antiguidade or '-',
                    'data_promocao': militar.data_promocao_atual.strftime('%d/%m/%Y') if militar.data_promocao_atual else '-'
                })
                ordem_total += 1
            
            secoes.append(secao)
    
    # Renderizar template HTML
    context = {
        'titulo': titulo,
        'observacoes': observacoes,
        'secoes': secoes,
        'total': ordem_total - 1,
        'tipo': tipo,
        'data_geracao': timezone.now().strftime('%d/%m/%Y √†s %H:%M')
    }
    
    try:
        return render_to_string('militares/almanaque_preview_content.html', context)
    except Exception as e:
        # Fallback: gerar HTML simples se o template falhar
        html_simple = f"""
        <div class="almanaque-preview">
            <h1>{titulo}</h1>
            <p>Gerado em {timezone.now().strftime('%d/%m/%Y √†s %H:%M')}</p>
            <p>Total de militares: {ordem_total - 1}</p>
            <p>Tipo: {tipo}</p>
        </div>
        """
        return html_simple

@login_required
def almanaque_gerar_html_pdf(request):
    """Gera PDF do almanaque a partir do HTML e salva no banco"""
    if request.method == 'POST':
        tipo = request.POST.get('tipo', 'GERAL')
        titulo = request.POST.get('titulo', '')
        observacoes = request.POST.get('observacoes', '')
    else:
        tipo = request.GET.get('tipo', 'GERAL')
        titulo = request.GET.get('titulo', '')
        observacoes = request.GET.get('observacoes', '')
    
    # Obter dados organizados do almanaque
    dados_organizados, titulo_padrao, total = obter_dados_almanaque(tipo)
    
    # Usar t√≠tulo personalizado se fornecido, sen√£o usar o padr√£o
    titulo_final = titulo if titulo else titulo_padrao
    
    # Gerar HTML do almanaque
    html_content = gerar_html_almanaque(dados_organizados, titulo_final, observacoes, tipo)
    
    # Gerar PDF a partir do HTML
    try:
        from .pdf_utils import gerar_pdf_almanaque_direct_old
        pdf_content = gerar_pdf_almanaque_direct_old(tipo)
    except Exception as e:
        # Fallback para o m√©todo original
        pdf_content = gerar_pdf_almanaque(tipo)
    
    # Se for POST, salvar no banco de dados
    if request.method == 'POST':
        try:
            # Definir data da √∫ltima promo√ß√£o baseada na data de cria√ß√£o
            from datetime import date
            data_atual = date.today()
            
            # Datas de promo√ß√£o conhecidas
            data_promocao_1 = date(2025, 7, 18)   # 18/07/2025
            data_promocao_2_oficiais = date(2025, 12, 23)  # 23/12/2025
            data_promocao_2_pracas = date(2025, 12, 25)    # 25/12/2025
            
            # Determinar qual data de promo√ß√£o usar baseada na data atual
            if tipo == 'OFICIAIS':
                if data_atual <= data_promocao_2_oficiais:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_oficiais  # 23/12/2025
            elif tipo == 'PRACAS':
                if data_atual <= data_promocao_2_pracas:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_pracas  # 25/12/2025
            else:  # GERAL
                # Para geral, usar a data mais recente entre todas as promo√ß√µes
                if data_atual <= data_promocao_2_pracas:
                    data_ultima_promocao = data_promocao_1  # 18/07/2025
                else:
                    data_ultima_promocao = data_promocao_2_pracas  # 25/12/2025
            
            # Salvar no banco
            almanaque = AlmanaqueMilitar.objects.create(
                titulo=titulo_final,
                tipo=tipo,
                observacoes=observacoes,
                arquivo_pdf=ContentFile(pdf_content, name=f'almanaque_{tipo.lower()}_{timezone.now().strftime("%Y%m%d_%H%M%S")}.pdf'),
                conteudo_html=html_content,
                data_ultima_promocao=data_ultima_promocao
            )
            
            # Atualizar estat√≠sticas
            militares_ativos = Militar.objects.filter(classificacao='ATIVO')
            oficiais = [m for m in militares_ativos if m.is_oficial()]
            pracas = [m for m in militares_ativos if not m.is_oficial()]
            
            almanaque.total_oficiais = len(oficiais)
            almanaque.total_pracas = len(pracas)
            almanaque.total_geral = len(militares_ativos)
            almanaque.save()
            
            messages.success(request, f'Almanaque "{almanaque.titulo}" gerado e salvo com sucesso!')
            return redirect('militares:almanaque_detail', pk=almanaque.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao salvar almanaque: {str(e)}')
            return redirect('militares:almanaque_create')
    
    # Se for GET, apenas retornar o PDF para download
    response = HttpResponse(pdf_content, content_type='application/pdf')
    filename = f'almanaque_{tipo.lower()}_{timezone.now().strftime("%Y%m%d_%H%M%S")}.pdf'
    response['Content-Disposition'] = f'attachment; filename="{filename}"'
    
    return response

@login_required
def exportar_militares_excel(request):
    """
    Exporta a lista de militares para Excel
    """
    from django.http import HttpResponse
    import csv
    from datetime import datetime
    
    # Obter militares ativos (mesma l√≥gica da view de listagem)
    militares = Militar.objects.filter(classificacao='ATIVO')
    
    # Aplicar filtros se fornecidos
    query = request.GET.get('q')
    if query:
        militares = militares.filter(
            Q(nome_completo__icontains=query) |
            Q(nome_guerra__icontains=query) |
            Q(matricula__icontains=query) |
            Q(cpf__icontains=query) |
            Q(email__icontains=query)
        )
    
    posto = request.GET.get('posto')
    if posto:
        posto_mapping = {
            'cb': 'CB', 'tc': 'TC', 'mj': 'MJ', 'cp': 'CP',
            '1t': '1T', '2t': '2T', 'st': 'ST', '1s': '1S',
            '2s': '2S', '3s': '3S', 'cab': 'CAB', 'sd': 'SD', 'nvrr': 'NVRR'
        }
        posto_codigo = posto_mapping.get(posto.lower())
        if posto_codigo:
            militares = militares.filter(posto_graduacao=posto_codigo)
    
    situacao = request.GET.get('situacao')
    if situacao:
        situacao_mapping = {'at': 'ATIVO', 'in': 'INATIVO'}
        situacao_codigo = situacao_mapping.get(situacao.lower())
        if situacao_codigo:
            militares = militares.filter(classificacao=situacao_codigo)
    
    quadro = request.GET.get('quadro')
    if quadro:
        militares = militares.filter(quadro=quadro)
    
    # Ordenar por hierarquia e antiguidade
    hierarquia_postos = {
        'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8,
        'ST': 9, '1S': 10, '2S': 11, '3S': 12, 'CAB': 13, 'SD': 14, 'NVRR': 15
    }
    
    militares = sorted(militares, key=lambda x: (
        hierarquia_postos.get(x.posto_graduacao, 999),
        0 if (x.posto_graduacao == 'NVRR' or x.quadro == 'NVRR') else (x.numeracao_antiguidade or 999999),
        x.nome_completo
    ))
    
    # Criar resposta HTTP
    response = HttpResponse(content_type='text/csv; charset=utf-8')
    response['Content-Disposition'] = f'attachment; filename="militares_{timezone.localtime(timezone.now()).strftime("%Y%m%d_%H%M%S")}.csv"'
    
    # Adicionar BOM para UTF-8 (importante para Excel)
    response.write('\ufeff')
    
    # Criar writer CSV
    writer = csv.writer(response, delimiter=';')
    
    # Cabe√ßalhos
    headers = [
        'Matr√≠cula',
        'Nome Completo',
        'Nome de Guerra',
        'CPF',
        'Posto/Gradua√ß√£o',
        'Quadro',
        'Numera√ß√£o de Antiguidade',
        'Data de Nascimento',
        'Idade',
        'Data de Ingresso',
        'Tempo de Servi√ßo',
        'Data da √öltima Promo√ß√£o',
        'Tempo no Posto Atual',
        'E-mail',
        'Telefone',
        'Celular',
        'Situa√ß√£o',
        'Observa√ß√µes'
    ]
    writer.writerow(headers)
    
    # Dados dos militares
    for militar in militares:
        # Calcular idade
        from datetime import date
        hoje = date.today()
        idade = hoje.year - militar.data_nascimento.year - ((hoje.month, hoje.day) < (militar.data_nascimento.month, militar.data_nascimento.day))
        
        # Calcular tempo de servi√ßo
        tempo_servico = hoje.year - militar.data_ingresso.year - ((hoje.month, hoje.day) < (militar.data_ingresso.month, militar.data_ingresso.day))
        
        # Calcular tempo no posto atual
        tempo_posto = hoje.year - militar.data_promocao_atual.year - ((hoje.month, hoje.day) < (militar.data_promocao_atual.month, militar.data_promocao_atual.day))
        
        row = [
            militar.matricula,
            militar.nome_completo,
            militar.nome_guerra or '',
            militar.cpf,
            militar.get_posto_graduacao_display(),
            militar.get_quadro_display(),
            militar.numeracao_antiguidade or 'NVRR' if (militar.posto_graduacao == 'NVRR' or militar.quadro == 'NVRR') else militar.numeracao_antiguidade or '',
            militar.data_nascimento.strftime('%d/%m/%Y'),
            idade,
            militar.data_ingresso.strftime('%d/%m/%Y'),
            tempo_servico,
            militar.data_promocao_atual.strftime('%d/%m/%Y'),
            tempo_posto,
            militar.email or '',
            militar.telefone or '',
            militar.celular or '',
            militar.get_situacao_display(),
            militar.observacoes or ''
        ]
        writer.writerow(row)
    
    return response
@login_required
def debug_funcoes_usuario(request):
    """View para debug das fun√ß√µes do usu√°rio logado"""
    from .models import UsuarioFuncaoMilitar
    
    # Buscar todas as fun√ß√µes do usu√°rio (considerando todas como ativas)
    funcoes_ativas = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user
    ).select_related('funcao_militar')
    
    # Verificar se tem fun√ß√µes especiais para editar fichas de conceito
    funcoes_especiais = funcoes_ativas.filter(
        funcao_militar__nome__in=['Diretor de Gest√£o de Pessoas', 'Chefe da Se√ß√£o de Promo√ß√µes', 'Administrador do Sistema', 'Administrador', 'Operador do Sistema']
    )
    
    # Verificar se √© superusu√°rio
    is_superuser = request.user.is_superuser
    
    context = {
        'usuario': request.user,
        'funcoes_ativas': funcoes_ativas,
        'funcoes_especiais': funcoes_especiais,
        'is_superuser': is_superuser,
        'pode_editar_fichas': is_superuser or funcoes_especiais.exists(),
    }
    
    return render(request, 'militares/debug_funcoes.html', context)


# Views para Qualifica√ß√µes
@login_required
@requer_funcao_ativa
def qualificacoes_militar(request, militar_id):
    """Lista as qualifica√ß√µes de um militar espec√≠fico"""
    militar = get_object_or_404(Militar, id=militar_id)
    qualificacoes = militar.qualificacoes.all()
    
    context = {
        'militar': militar,
        'qualificacoes': qualificacoes,
    }
    return render(request, 'militares/qualificacoes_militar.html', context)


@login_required
@requer_perm_militares_editar
def adicionar_qualificacao(request, militar_id):
    """Adiciona uma nova qualifica√ß√£o para um militar"""
    militar = get_object_or_404(Militar, id=militar_id)
    
    if request.method == 'POST':
        form = QualificacaoForm(request.POST, request.FILES)
        if form.is_valid():
            qualificacao = form.save(commit=False)
            qualificacao.militar = militar
            qualificacao.save()
            messages.success(request, 'Qualifica√ß√£o adicionada com sucesso!')
            return redirect('militares:qualificacoes_militar', militar_id=militar.id)
        else:
            messages.error(request, 'Por favor, corrija os erros no formul√°rio.')
    else:
        form = QualificacaoForm()
    
    context = {
        'militar': militar,
        'form': form,
    }
    return render(request, 'militares/adicionar_qualificacao.html', context)


@login_required
@requer_funcao_ativa
def visualizar_qualificacao(request, qualificacao_id):
    """Visualiza uma qualifica√ß√£o (apenas leitura)"""
    qualificacao = get_object_or_404(Qualificacao, id=qualificacao_id)
    
    context = {
        'qualificacao': qualificacao,
    }
    return render(request, 'militares/visualizar_qualificacao.html', context)


@login_required
@requer_funcao_ativa
def visualizar_documento_qualificacao(request, qualificacao_id):
    """Visualiza o documento da qualifica√ß√£o"""
    qualificacao = get_object_or_404(Qualificacao, id=qualificacao_id)
    
    if not qualificacao.arquivo_certificado:
        messages.error(request, 'Esta qualifica√ß√£o n√£o possui arquivo de certificado anexado.')
        return redirect('militares:qualificacoes_militar', militar_id=qualificacao.militar.id)
    
    context = {
        'qualificacao': qualificacao,
    }
    return render(request, 'militares/visualizar_documento_qualificacao.html', context)


@login_required
@requer_perm_militares_editar
def editar_qualificacao(request, qualificacao_id):
    """Edita uma qualifica√ß√£o existente"""
    qualificacao = get_object_or_404(Qualificacao, id=qualificacao_id)
    
    if request.method == 'POST':
        form = QualificacaoForm(request.POST, request.FILES, instance=qualificacao)
        if form.is_valid():
            form.save()
            messages.success(request, 'Qualifica√ß√£o atualizada com sucesso!')
            return redirect('militares:qualificacoes_militar', militar_id=qualificacao.militar.id)
        else:
            messages.error(request, 'Por favor, corrija os erros no formul√°rio.')
    else:
        form = QualificacaoForm(instance=qualificacao)
    
    context = {
        'qualificacao': qualificacao,
        'form': form,
    }
    return render(request, 'militares/editar_qualificacao.html', context)


@login_required
@requer_perm_militares_excluir
def excluir_qualificacao(request, qualificacao_id):
    """Exclui uma qualifica√ß√£o"""
    qualificacao = get_object_or_404(Qualificacao, id=qualificacao_id)
    militar_id = qualificacao.militar.id
    
    if request.method == 'POST':
        qualificacao.delete()
        messages.success(request, 'Qualifica√ß√£o exclu√≠da com sucesso!')
        return redirect('militares:qualificacoes_militar', militar_id=militar_id)
    
    context = {
        'qualificacao': qualificacao,
    }
    return render(request, 'militares/excluir_qualificacao.html', context)


@login_required
@requer_perm_militares_editar
def verificar_qualificacao(request, qualificacao_id):
    """Marca uma qualifica√ß√£o como verificada"""
    qualificacao = get_object_or_404(Qualificacao, id=qualificacao_id)
    
    if request.method == 'POST':
        status = request.POST.get('status')
        observacoes = request.POST.get('observacoes', '')
        
        qualificacao.status_verificacao = status
        qualificacao.observacoes = observacoes
        qualificacao.save()
        
        status_display = qualificacao.get_status_verificacao_display()
        messages.success(request, f'Qualifica√ß√£o marcada como {status_display}!')
        return redirect('militares:qualificacoes_militar', militar_id=qualificacao.militar.id)
    
    context = {
        'qualificacao': qualificacao,
    }
    return render(request, 'militares/verificar_qualificacao.html', context)


# ==================== VIEWS PARA FUN√á√ïES MILITARES ====================

@login_required
def funcoes_militares_list(request):
    """Lista todas as fun√ß√µes militares"""
    funcoes = FuncaoMilitar.objects.all().order_by('ordem', 'nome')
    
    # Aplicar filtros
    grupo_filtro = request.GET.get('grupo')
    if grupo_filtro:
        funcoes = funcoes.filter(grupo=grupo_filtro)
    
    status_filtro = request.GET.get('status')
    if status_filtro == 'ativo':
        funcoes = funcoes.filter(ativo=True)
    elif status_filtro == 'inativo':
        funcoes = funcoes.filter(ativo=False)
    
    # Pesquisa por nome
    pesquisa = request.GET.get('pesquisa')
    if pesquisa:
        funcoes = funcoes.filter(nome__icontains=pesquisa)
    
    # Estat√≠sticas
    total_funcoes = FuncaoMilitar.objects.count()
    funcoes_ativas = FuncaoMilitar.objects.filter(ativo=True).count()
    funcoes_inativas = FuncaoMilitar.objects.filter(ativo=False).count()
    
    context = {
        'funcoes': funcoes,
        'total_funcoes': total_funcoes,
        'funcoes_ativas': funcoes_ativas,
        'funcoes_inativas': funcoes_inativas,
        'grupo_filtro': grupo_filtro,
        'status_filtro': status_filtro,
        'pesquisa': pesquisa,
        'title': 'Fun√ß√µes Militares',
    }
    return render(request, 'militares/funcoes/funcoes_militares_list.html', context)


@login_required
@administracao_required
def funcoes_militares_create(request):
    """Cria uma nova fun√ß√£o militar com sistema de permiss√µes - apenas administradores do sistema"""
    from .models import PermissaoFuncao, FuncaoMenuConfig
    
    if request.method == 'POST':
        form = FuncaoMilitarForm(request.POST)
        if form.is_valid():
            funcao = form.save()
            
            # Criar configura√ß√£o de menu padr√£o baseada no grupo
            menu_config = FuncaoMenuConfig.objects.create(
                funcao_militar=funcao,
                ativo=True
            )
            
            # Processar permiss√µes do formul√°rio
            # Campos de menu principal
            menu_fields = [
                'show_dashboard', 'show_efetivo', 'show_secao_promocoes', 
                'show_medalhas', 'show_administracao', 'show_notas'
            ]
            
            # Atualizar campos de menu
            for field in menu_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            menu_config.save()
            
            # Limpar permiss√µes de submenu existentes
            PermissaoFuncao.objects.filter(funcao_militar=funcao).delete()
            
            # Mapear campos do formul√°rio para m√≥dulos
            submenu_mapping = {
                'show_ativos': 'SUBMENU_ATIVOS',
                'show_inativos': 'SUBMENU_INATIVOS',
                'show_lotacoes': 'SUBMENU_LOTACOES',
                'show_fichas_oficiais': 'SUBMENU_FICHAS_OFICIAIS',
                'show_fichas_pracas': 'SUBMENU_FICHAS_PRACAS',
                'show_quadros_acesso': 'SUBMENU_QUADROS_ACESSO',
                'show_quadros_fixacao': 'SUBMENU_QUADROS_FIXACAO',
                'show_almanaques': 'SUBMENU_ALMANAQUES',
                'show_promocoes': 'SUBMENU_PROMOCOES',
                'show_calendarios': 'SUBMENU_CALENDARIOS',
                'show_comissoes': 'SUBMENU_COMISSOES',
                'show_meus_votos': 'SUBMENU_MEUS_VOTOS',
                'show_intersticios': 'SUBMENU_INTERSTICIOS',
                'show_gerenciar_intersticios': 'SUBMENU_GERENCIAR_INTERSTICIOS',
                'show_gerenciar_previsao': 'SUBMENU_GERENCIAR_PREVISAO',
                'show_medalhas_concessoes': 'SUBMENU_MEDALHAS_CONCESSOES',
                'show_medalhas_propostas': 'SUBMENU_MEDALHAS_PROPOSTAS',
                'show_elegiveis': 'SUBMENU_ELEGIVEIS',
                'show_propostas': 'SUBMENU_PROPOSTAS',
                'notas_visualizar': 'NOTAS_VISUALIZAR',
                'notas_criar': 'NOTAS_CRIAR',
                'notas_editar': 'NOTAS_EDITAR',
                'notas_lista': 'SUBMENU_NOTAS_LISTA',
                'notas_excluir': 'NOTAS_EXCLUIR',
                'show_usuarios': 'SUBMENU_USUARIOS',
                'show_permissoes': 'SUBMENU_PERMISSOES',
                'show_logs': 'SUBMENU_LOGS',
                'show_administracao': 'SUBMENU_ADMINISTRACAO',
                'show_planejadas': 'MENU_PLANEJADAS',
                'show_operador_planejadas': 'SUBMENU_OPERADOR_PLANEJADAS',
                'show_fiscal_planejadas': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Mapear permiss√µes espec√≠ficas de a√ß√µes
            acoes_mapping = {
                # Ativos
                'ativos_visualizar': 'ATIVOS_VISUALIZAR',
                'ativos_criar': 'ATIVOS_CRIAR',
                'ativos_editar': 'ATIVOS_EDITAR',
                'ativos_excluir': 'ATIVOS_EXCLUIR',
                'ativos_transferir': 'ATIVOS_TRANSFERIR',
                'ativos_promover': 'ATIVOS_PROMOVER',
                'ativos_inativar': 'ATIVOS_INATIVAR',
                'ativos_ficha_conceito': 'ATIVOS_FICHA_CONCEITO',
                'ativos_exportar': 'ATIVOS_EXPORTAR',
                'ativos_dashboard': 'ATIVOS_DASHBOARD',
                'ativos_reordenar': 'ATIVOS_REORDENAR',
                
                # Inativos
                'inativos_visualizar': 'INATIVOS_VISUALIZAR',
                'inativos_editar': 'INATIVOS_EDITAR',
                'inativos_excluir': 'INATIVOS_EXCLUIR',
                'inativos_reativar': 'INATIVOS_REATIVAR',
                
                # Lota√ß√µes
                'lotacoes_visualizar': 'LOTACOES_VISUALIZAR',
                'lotacoes_criar': 'LOTACOES_CRIAR',
                'lotacoes_editar': 'LOTACOES_EDITAR',
                'lotacoes_excluir': 'LOTACOES_EXCLUIR',
                
                # Bot√µes granulares - Lota√ß√µes
                'botao_lotacao_nova': 'BOTAO_LOTACAO_NOVA',
                'botao_lotacao_editar': 'BOTAO_LOTACAO_EDITAR',
                'botao_lotacao_excluir': 'BOTAO_LOTACAO_EXCLUIR',
                'botao_lotacao_estatisticas': 'BOTAO_LOTACAO_ESTATISTICAS',
                
                
                # Bot√µes granulares - Publica√ß√µes
                'botao_publicacao_nova': 'BOTAO_PUBLICACAO_NOVA',
                'botao_publicacao_editar': 'BOTAO_PUBLICACAO_EDITAR',
                'botao_publicacao_publicar': 'BOTAO_PUBLICACAO_PUBLICAR',
                'botao_publicacao_assinar': 'BOTAO_PUBLICACAO_ASSINAR',
                
                # Detalhes do Militar
                'detail_fichas_conceito': 'DETAIL_FICHAS_CONCEITO',
                'detail_punicoes': 'DETAIL_PUNICOES',

                # Elogios/Puni√ß√µes - A√ß√µes
                'elogios_visualizar': 'ELOGIOS_VISUALIZAR',
                'elogios_criar': 'ELOGIOS_CRIAR',
                'elogios_editar': 'ELOGIOS_EDITAR',
                'punicoes_visualizar': 'PUNICOES_VISUALIZAR',
                'punicoes_criar': 'PUNICOES_CRIAR',
                'punicoes_editar': 'PUNICOES_EDITAR',
                
                # Nota: Campos de ensino (ensino_visualizar, ensino_criar, etc.) s√£o processados
                # apenas em permissoes_especificas, n√£o aqui no template_to_modulo
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Oficiais
                'fichas_oficiais_visualizar': 'FICHAS_OFICIAIS_VISUALIZAR',
                'fichas_oficiais_criar': 'FICHAS_OFICIAIS_CRIAR',
                'fichas_oficiais_editar': 'FICHAS_OFICIAIS_EDITAR',
                'fichas_oficiais_excluir': 'FICHAS_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Pra√ßas
                'fichas_pracas_visualizar': 'FICHAS_PRACAS_VISUALIZAR',
                'fichas_pracas_criar': 'FICHAS_PRACAS_CRIAR',
                'fichas_pracas_editar': 'FICHAS_PRACAS_EDITAR',
                'fichas_pracas_excluir': 'FICHAS_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Calend√°rios
                'calendarios_visualizar': 'CALENDARIOS_VISUALIZAR',
                'calendarios_criar': 'CALENDARIOS_CRIAR',
                'calendarios_editar': 'CALENDARIOS_EDITAR',
                'calendarios_excluir': 'CALENDARIOS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Fixa√ß√£o
                'quadros_fixacao_visualizar': 'QUADROS_FIXACAO_VISUALIZAR',
                'quadros_fixacao_criar': 'QUADROS_FIXACAO_CRIAR',
                'quadros_fixacao_editar': 'QUADROS_FIXACAO_EDITAR',
                'quadros_fixacao_excluir': 'QUADROS_FIXACAO_EXCLUIR',
                'quadros_fixacao_assinar': 'QUADROS_FIXACAO_ASSINAR',
                'quadros_fixacao_gerar_pdf': 'QUADROS_FIXACAO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Acesso
                'quadros_acesso_visualizar': 'QUADROS_ACESSO_VISUALIZAR',
                'quadros_acesso_criar': 'QUADROS_ACESSO_CRIAR',
                'quadros_acesso_editar': 'QUADROS_ACESSO_EDITAR',
                'quadros_acesso_excluir': 'QUADROS_ACESSO_EXCLUIR',
                'quadros_acesso_assinar': 'QUADROS_ACESSO_ASSINAR',
                'quadros_acesso_homologar': 'QUADROS_ACESSO_HOMOLOGAR',
                'quadros_acesso_deshomologar': 'QUADROS_ACESSO_DESHOMOLOGAR',
                'quadros_acesso_elaborar': 'QUADROS_ACESSO_ELABORAR',
                'quadros_acesso_regenerar': 'QUADROS_ACESSO_REGENERAR',
                'quadros_acesso_gerar_pdf': 'QUADROS_ACESSO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes (gen√©ricas)
                'comissoes_visualizar': 'COMISSOES_VISUALIZAR',
                'comissoes_criar': 'COMISSOES_CRIAR',
                'comissoes_editar': 'COMISSOES_EDITAR',
                'comissoes_excluir': 'COMISSOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Oficiais
                'comissoes_oficiais_visualizar': 'COMISSOES_OFICIAIS_VISUALIZAR',
                'comissoes_oficiais_criar': 'COMISSOES_OFICIAIS_CRIAR',
                'comissoes_oficiais_editar': 'COMISSOES_OFICIAIS_EDITAR',
                'comissoes_oficiais_excluir': 'COMISSOES_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Pra√ßas
                'comissoes_pracas_visualizar': 'COMISSOES_PRACAS_VISUALIZAR',
                'comissoes_pracas_criar': 'COMISSOES_PRACAS_CRIAR',
                'comissoes_pracas_editar': 'COMISSOES_PRACAS_EDITAR',
                'comissoes_pracas_excluir': 'COMISSOES_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Meus Votos
                'meus_votos_visualizar': 'MEUS_VOTOS_VISUALIZAR',
                'meus_votos_votar': 'MEUS_VOTOS_VOTAR',
                
                # Se√ß√£o de Promo√ß√µes - Promo√ß√µes
                'promocoes_visualizar': 'PROMOCOES_VISUALIZAR',
                'promocoes_criar': 'PROMOCOES_CRIAR',
                'promocoes_editar': 'PROMOCOES_EDITAR',
                'promocoes_excluir': 'PROMOCOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Almanaques
                'almanaques_visualizar': 'ALMANAQUES_VISUALIZAR',
                'almanaques_criar': 'ALMANAQUES_CRIAR',
                'almanaques_editar': 'ALMANAQUES_EDITAR',
                'almanaques_excluir': 'ALMANAQUES_EXCLUIR',
                'almanaques_assinar': 'ALMANAQUES_ASSINAR',
                'almanaques_gerar_pdf': 'ALMANAQUES_GERAR_PDF',
                
                # Medalhas - Concess√µes
                'medalhas_concessoes_visualizar': 'MEDALHAS_CONCESSOES_VISUALIZAR',
                'medalhas_concessoes_criar': 'MEDALHAS_CONCESSOES_CRIAR',
                'medalhas_concessoes_editar': 'MEDALHAS_CONCESSOES_EDITAR',
                'medalhas_concessoes_excluir': 'MEDALHAS_CONCESSOES_EXCLUIR',
                
                # Medalhas - Propostas
                'medalhas_propostas_visualizar': 'MEDALHAS_PROPOSTAS_VISUALIZAR',
                'medalhas_propostas_criar': 'MEDALHAS_PROPOSTAS_CRIAR',
                'medalhas_propostas_editar': 'MEDALHAS_PROPOSTAS_EDITAR',
                'medalhas_propostas_excluir': 'MEDALHAS_PROPOSTAS_EXCLUIR',
                
                # Medalhas - Eleg√≠veis
                'elegiveis_visualizar': 'ELEGIVEIS_VISUALIZAR',
                'elegiveis_gerar': 'ELEGIVEIS_GERAR',
                'elegiveis_exportar': 'ELEGIVEIS_EXPORTAR',
                
                # Medalhas - Propostas (Lista)
                'propostas_visualizar': 'PROPOSTAS_VISUALIZAR',
                'propostas_criar': 'PROPOSTAS_CRIAR',
                'propostas_editar': 'PROPOSTAS_EDITAR',
                'propostas_excluir': 'PROPOSTAS_EXCLUIR',
                
                # Configura√ß√µes - Usu√°rios
                'usuarios_visualizar': 'USUARIOS_VISUALIZAR',
                'usuarios_criar': 'USUARIOS_CRIAR',
                'usuarios_editar': 'USUARIOS_EDITAR',
                'usuarios_excluir': 'USUARIOS_EXCLUIR',
                
                # Configura√ß√µes - Permiss√µes
                'permissoes_visualizar': 'PERMISSOES_VISUALIZAR',
                'permissoes_editar': 'PERMISSOES_EDITAR',
                'permissoes_administrar': 'PERMISSOES_ADMINISTRAR',
                
                # Configura√ß√µes - Logs
                'logs_visualizar': 'LOGS_VISUALIZAR',
                'logs_exportar': 'LOGS_EXPORTAR',
                'logs_limpar': 'LOGS_LIMPAR',
                
                # Planejadas
                'PLANEJADAS_VISUALIZAR': 'PLANEJADAS_VISUALIZAR',
                'PLANEJADAS_CRIAR': 'PLANEJADAS_CRIAR',
                'PLANEJADAS_EDITAR': 'PLANEJADAS_EDITAR',
                'PLANEJADAS_EXCLUIR': 'PLANEJADAS_EXCLUIR',
                'PLANEJADAS_ADICIONAR_MILITAR': 'PLANEJADAS_ADICIONAR_MILITAR',
                'PLANEJADAS_REMOVER_MILITAR': 'PLANEJADAS_REMOVER_MILITAR',
                'PLANEJADAS_ASSINAR_OPERADOR': 'PLANEJADAS_ASSINAR_OPERADOR',
                'PLANEJADAS_ASSINAR_FISCAL': 'PLANEJADAS_ASSINAR_FISCAL',
                'MENU_PLANEJADAS': 'MENU_PLANEJADAS',
                'SUBMENU_PLANEJADAS': 'SUBMENU_PLANEJADAS',
                'SUBMENU_OPERADOR_PLANEJADAS': 'SUBMENU_OPERADOR_PLANEJADAS',
                'SUBMENU_FISCAL_PLANEJADAS': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Criar permiss√µes de submenu
            permissoes_criadas = 0
            for campo_form, modulo in submenu_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='VISUALIZAR',
                        ativo=True
                    )
                    permissoes_criadas += 1
            
            # Criar permiss√µes espec√≠ficas de a√ß√µes
            acoes_criadas = 0
            for campo_form, modulo in acoes_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='EXECUTAR',
                        ativo=True
                    )
                    acoes_criadas += 1
            
            # Se n√£o foram selecionadas permiss√µes espec√≠ficas, aplicar configura√ß√£o padr√£o por grupo
            if permissoes_criadas == 0:
                aplicar_configuracoes_por_grupo(funcao, menu_config)
            
            messages.success(
                request, 
                f'Fun√ß√£o militar "{funcao.nome}" criada com sucesso! '
                f'Configurados {len([f for f in menu_fields if f in request.POST])} menus principais '
                f'e {permissoes_criadas} submenus com {acoes_criadas} a√ß√µes espec√≠ficas.'
            )
            return redirect('militares:funcoes_militares_list')
        else:
            messages.error(request, 'Por favor, corrija os erros no formul√°rio.')
    else:
        form = FuncaoMilitarForm()
    
    context = {
        'form': form,
        'action': 'Nova',
        'title': 'Nova Fun√ß√£o Militar',
    }
    return render(request, 'militares/funcoes/funcoes_militares_form.html', context)


def aplicar_configuracao_padrao(tipo_config):
    """Aplica configura√ß√£o padr√£o baseada no tipo"""
    from .forms_permissoes_funcoes import PermissaoFuncaoFormSet
    
    # Configura√ß√µes padr√£o para cada tipo
    configuracoes = {
        'basico': {
            'modulos': ['MENU_DASHBOARD', 'MENU_EFETIVO'],
            'acesso': 'VISUALIZAR'
        },
        'operacional': {
            'modulos': ['MENU_DASHBOARD', 'MENU_EFETIVO', 'MENU_SECAO_PROMOCOES', 'MENU_ESCALAS'],
            'acesso': 'CRIAR'
        },
        'gerencial': {
            'modulos': ['MENU_DASHBOARD', 'MENU_EFETIVO', 'MENU_SECAO_PROMOCOES', 'MENU_MEDALHAS', 'MENU_ESCALAS'],
            'acesso': 'EDITAR'
        },
        'administrativo': {
            'modulos': ['MENU_DASHBOARD', 'MENU_EFETIVO', 'MENU_SECAO_PROMOCOES', 'MENU_MEDALHAS', 'MENU_ESCALAS', 'MENU_CONFIGURACOES'],
            'acesso': 'ADMINISTRAR'
        }
    }
    
    if tipo_config in configuracoes:
        config = configuracoes[tipo_config]
        # Criar formset com configura√ß√µes padr√£o
        formset = PermissaoFuncaoFormSet()
        # Aqui voc√™ pode adicionar l√≥gica para preencher o formset com as configura√ß√µes padr√£o
        return formset
    
    return PermissaoFuncaoFormSet()


def aplicar_configuracoes_por_grupo(funcao, menu_config):
    """Aplica configura√ß√µes de menu baseadas no grupo da fun√ß√£o"""
    from .models import PermissaoFuncao
    
    # Configura√ß√µes por grupo
    configuracoes_grupo = {
        'ADMINISTRATIVO': {
            'menu': {
                'show_dashboard': True,
                'show_efetivo': True,
                'show_secao_promocoes': True,
                'show_medalhas': True,
                'show_administracao': True,
                'show_logs': True,
            },
            'permissoes': [
                ('MENU_DASHBOARD', 'VISUALIZAR'),
                ('MENU_EFETIVO', 'VISUALIZAR'),
                ('MENU_SECAO_PROMOCOES', 'ADMINISTRAR'),
                ('MENU_MEDALHAS', 'ADMINISTRAR'),
                ('MENU_ESCALAS', 'ADMINISTRAR'),
                ('SUBMENU_ESCALAS_DASHBOARD', 'VISUALIZAR'),
                ('SUBMENU_ESCALAS_LISTA', 'ADMINISTRAR'),
                ('SUBMENU_ESCALAS_CONFIGURACAO', 'ADMINISTRAR'),
                ('SUBMENU_ESCALAS_BANCO_HORAS', 'ADMINISTRAR'),
                ('SUBMENU_ESCALAS_OPERACOES', 'ADMINISTRAR'),
                ('MENU_CONFIGURACOES', 'ADMINISTRAR'),
                ('SUBMENU_ATIVOS', 'VISUALIZAR'),
                ('SUBMENU_INATIVOS', 'VISUALIZAR'),
                ('SUBMENU_LOTACOES', 'VISUALIZAR'),
                ('SUBMENU_FICHAS_OFICIAIS', 'ADMINISTRAR'),
                ('SUBMENU_FICHAS_PRACAS', 'ADMINISTRAR'),
                ('SUBMENU_QUADROS_ACESSO', 'ADMINISTRAR'),
                ('SUBMENU_QUADROS_FIXACAO', 'ADMINISTRAR'),
                ('SUBMENU_ALMANAQUES', 'ADMINISTRAR'),
                ('SUBMENU_PROMOCOES', 'ADMINISTRAR'),
                ('SUBMENU_CALENDARIOS', 'ADMINISTRAR'),
                ('SUBMENU_COMISSOES', 'ADMINISTRAR'),
                ('SUBMENU_MEUS_VOTOS', 'VISUALIZAR'),
                ('SUBMENU_INTERSTICIOS', 'ADMINISTRAR'),
                ('SUBMENU_GERENCIAR_INTERSTICIOS', 'ADMINISTRAR'),
                ('SUBMENU_GERENCIAR_PREVISAO', 'ADMINISTRAR'),
                ('SUBMENU_MEDALHAS_CONCESSOES', 'ADMINISTRAR'),
                ('SUBMENU_MEDALHAS_PROPOSTAS', 'ADMINISTRAR'),
                ('SUBMENU_ELEGIVEIS', 'VISUALIZAR'),
                ('SUBMENU_PROPOSTAS', 'VISUALIZAR'),
                ('SUBMENU_USUARIOS', 'ADMINISTRAR'),
                ('SUBMENU_PERMISSOES', 'ADMINISTRAR'),
                ('SUBMENU_LOGS', 'VISUALIZAR'),
                ('SUBMENU_ADMINISTRACAO', 'ADMINISTRAR'),
            ]
        },
        'GESTAO': {
            'menu': {
                'show_dashboard': True,
                'show_efetivo': True,
                'show_secao_promocoes': True,
                'show_medalhas': True,
                'show_administracao': False,
                'show_logs': False,
            },
            'permissoes': [
                ('MENU_DASHBOARD', 'VISUALIZAR'),
                ('MENU_EFETIVO', 'VISUALIZAR'),
                ('MENU_SECAO_PROMOCOES', 'EDITAR'),
                ('MENU_MEDALHAS', 'EDITAR'),
                ('MENU_ESCALAS', 'EDITAR'),
                ('SUBMENU_ESCALAS_DASHBOARD', 'VISUALIZAR'),
                ('SUBMENU_ESCALAS_LISTA', 'EDITAR'),
                ('SUBMENU_ESCALAS_CONFIGURACAO', 'EDITAR'),
                ('SUBMENU_ESCALAS_BANCO_HORAS', 'EDITAR'),
                ('SUBMENU_ESCALAS_OPERACOES', 'EDITAR'),
                ('SUBMENU_ATIVOS', 'VISUALIZAR'),
                ('SUBMENU_INATIVOS', 'VISUALIZAR'),
                ('SUBMENU_LOTACOES', 'VISUALIZAR'),
                ('SUBMENU_FICHAS_OFICIAIS', 'EDITAR'),
                ('SUBMENU_FICHAS_PRACAS', 'EDITAR'),
                ('SUBMENU_QUADROS_ACESSO', 'EDITAR'),
                ('SUBMENU_QUADROS_FIXACAO', 'EDITAR'),
                ('SUBMENU_ALMANAQUES', 'EDITAR'),
                ('SUBMENU_PROMOCOES', 'EDITAR'),
                ('SUBMENU_CALENDARIOS', 'EDITAR'),
                ('SUBMENU_COMISSOES', 'EDITAR'),
                ('SUBMENU_MEUS_VOTOS', 'VISUALIZAR'),
                ('SUBMENU_INTERSTICIOS', 'EDITAR'),
                ('SUBMENU_GERENCIAR_INTERSTICIOS', 'EDITAR'),
                ('SUBMENU_GERENCIAR_PREVISAO', 'EDITAR'),
                ('SUBMENU_MEDALHAS_CONCESSOES', 'EDITAR'),
                ('SUBMENU_MEDALHAS_PROPOSTAS', 'EDITAR'),
                ('SUBMENU_ELEGIVEIS', 'VISUALIZAR'),
                ('SUBMENU_PROPOSTAS', 'VISUALIZAR'),
            ]
        },
        'COMISSAO': {
            'menu': {
                'show_dashboard': True,
                'show_efetivo': False,
                'show_secao_promocoes': True,
                'show_medalhas': False,
                'show_administracao': False,
                'show_logs': False,
            },
            'permissoes': [
                ('MENU_DASHBOARD', 'VISUALIZAR'),
                ('MENU_SECAO_PROMOCOES', 'VISUALIZAR'),
                ('SUBMENU_FICHAS_OFICIAIS', 'VISUALIZAR'),
                ('SUBMENU_FICHAS_PRACAS', 'VISUALIZAR'),
                ('SUBMENU_QUADROS_ACESSO', 'VISUALIZAR'),
                ('SUBMENU_QUADROS_FIXACAO', 'VISUALIZAR'),
                ('SUBMENU_ALMANAQUES', 'VISUALIZAR'),
                ('SUBMENU_PROMOCOES', 'VISUALIZAR'),
                ('SUBMENU_CALENDARIOS', 'VISUALIZAR'),
                ('SUBMENU_COMISSOES', 'VISUALIZAR'),
                ('SUBMENU_MEUS_VOTOS', 'VISUALIZAR'),
                ('SUBMENU_INTERSTICIOS', 'VISUALIZAR'),
                ('SUBMENU_ELEGIVEIS', 'VISUALIZAR'),
                ('SUBMENU_PROPOSTAS', 'VISUALIZAR'),
            ]
        },
        'OPERACIONAL': {
            'menu': {
                'show_dashboard': True,
                'show_efetivo': True,
                'show_escalas': True,
                'show_secao_promocoes': False,
                'show_medalhas': False,
                'show_administracao': False,
                'show_logs': False,
            },
            'permissoes': [
                ('MENU_DASHBOARD', 'VISUALIZAR'),
                ('MENU_EFETIVO', 'VISUALIZAR'),
                ('SUBMENU_ATIVOS', 'VISUALIZAR'),
                ('SUBMENU_INATIVOS', 'VISUALIZAR'),
                ('SUBMENU_LOTACOES', 'VISUALIZAR'),
                ('MENU_ESCALAS', 'VISUALIZAR'),
                ('SUBMENU_ESCALAS_DASHBOARD', 'VISUALIZAR'),
                ('SUBMENU_ESCALAS_LISTA', 'VISUALIZAR'),
            ]
        }
    }
    
    # Aplicar configura√ß√µes baseadas no grupo
    if funcao.grupo in configuracoes_grupo:
        config = configuracoes_grupo[funcao.grupo]
        
        # Aplicar configura√ß√µes de menu
        for campo, valor in config['menu'].items():
            setattr(menu_config, campo, valor)
        
        # Criar permiss√µes
        for modulo, acesso in config['permissoes']:
            PermissaoFuncao.objects.create(
                funcao_militar=funcao,
                modulo=modulo,
                acesso=acesso,
                ativo=True
            )
    
    menu_config.save()


@login_required
def teste_template(request):
    """View de teste para verificar se o template est√° funcionando"""
    return render(request, 'militares/funcoes/teste_template.html')

@login_required
# @administracao_required
def gerenciar_permissoes_unificado(request, funcao_id):
    """
    Interface unificada e moderna para gerenciar todas as permiss√µes de uma fun√ß√£o militar.
    
    Funcionalidades:
    - Configura√ß√£o de menus vis√≠veis
    - Permiss√µes granulares por m√≥dulo
    - Aplica√ß√£o de perfis predefinidos
    - Valida√ß√£o de permiss√µes
    - Interface responsiva e intuitiva
    """
    from .models import FuncaoMilitar, FuncaoMenuConfig, PermissaoFuncao, PerfilAcesso
    from django.contrib.auth.models import User, Group, Permission
    from django.contrib.contenttypes.models import ContentType
    from django.db.models import Count, Q
    from django.contrib import messages
    from django.http import JsonResponse
    from django.shortcuts import render, get_object_or_404, redirect
    import json
    
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    if request.method == 'POST':
        print(f"üîç DEBUG: Requisi√ß√£o POST recebida para fun√ß√£o {funcao.nome}")
        print(f"üîç DEBUG: Dados POST: {dict(request.POST)}")
        try:
            # Verificar se √© uma requisi√ß√£o AJAX para aplicar perfil
            if request.headers.get('Content-Type') == 'application/json':
                data = json.loads(request.body)
                if data.get('action') == 'aplicar_perfil':
                    perfil_id = data.get('perfil_id')
                    perfil = get_object_or_404(PerfilAcesso, pk=perfil_id)
                    perfil.aplicar_perfil(funcao)
                    
                    # Aplicar configura√ß√µes de menu do perfil
                    menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                        funcao_militar=funcao,
                        defaults={'ativo': True}
                    )
                    
                    # Configura√ß√µes padr√£o baseadas no perfil
                    if 'ADMINISTRADOR' in perfil.nome.upper():
                        menu_config.show_dashboard = True
                        menu_config.show_efetivo = True
                        menu_config.show_publicacoes = True
                        menu_config.show_secao_promocoes = True
                        menu_config.show_medalhas = True
                        menu_config.show_configuracoes = True
                        menu_config.show_administracao = True
                        menu_config.show_logs = True
                    elif 'COMANDANTE' in perfil.nome.upper():
                        menu_config.show_dashboard = True
                        menu_config.show_efetivo = True
                        menu_config.show_publicacoes = True
                        menu_config.show_secao_promocoes = True
                        menu_config.show_medalhas = True
                        menu_config.show_configuracoes = False
                        menu_config.show_administracao = False
                        menu_config.show_logs = False
                    elif 'SARGENTEANTE' in perfil.nome.upper():
                        menu_config.show_dashboard = True
                        menu_config.show_efetivo = True
                        menu_config.show_publicacoes = True
                        menu_config.show_secao_promocoes = False
                        menu_config.show_medalhas = False
                        menu_config.show_configuracoes = False
                        menu_config.show_administracao = False
                        menu_config.show_logs = False
                    
                    menu_config.save()
                    
                    return JsonResponse({
                        'success': True,
                        'message': f'Perfil "{perfil.nome}" aplicado com sucesso!'
                    })
            
            # Processar configura√ß√µes de menu
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            # Atualizar configura√ß√µes de menu - todos os campos do FuncaoMenuConfig
            menu_fields = [
                'show_dashboard', 'show_efetivo', 'show_publicacoes', 'show_escalas',
                'show_secao_promocoes', 'show_medalhas', 'show_configuracoes', 'show_administracao', 'show_logs',
                'show_pessoal', 'show_relatorios',                 'show_planejadas', 'show_afastamentos', 'show_ferias',
                # Submenus - Efetivo
                'show_ativos', 'show_inativos', 'show_lotacoes', 'show_averbacoes',
                # Menus e Submenus - Ensino
                'show_ensino', 'show_ensino_dashboard', 'show_ensino_cursos', 'show_ensino_turmas',
                'show_ensino_disciplinas', 'show_ensino_alunos', 'show_ensino_instrutores',
                'show_ensino_monitores', 'show_ensino_aulas', 'show_ensino_frequencias',
                'show_ensino_avaliacoes', 'show_ensino_certificados', 'show_ensino_quadros_trabalho_semanal',
                # Submenus - Publica√ß√µes
                'show_notas', 'show_boletins_ostensivos', 'show_boletins_reservados', 'show_boletins_especiais',
                # Submenus - Se√ß√£o de Promo√ß√µes
                'show_fichas_oficiais', 'show_fichas_pracas', 'show_calendarios', 'show_quadros_fixacao',
                'show_quadros_acesso', 'show_comissoes', 'show_meus_votos', 'show_promocoes', 'show_almanaques',
                # Submenus - Medalhas
                'show_medalhas_concessoes', 'show_medalhas_propostas', 'show_elegiveis', 'show_propostas',
                # Submenus - Escalas
                'show_escalas_dashboard', 'show_escalas_lista', 'show_escalas_configuracao', 'show_escalas_banco_horas', 'show_escalas_operacoes',
                # Submenus - Planejadas
                'show_operador_planejadas', 'show_fiscal_planejadas', 'show_liquidacao',
                # Submenus - Configura√ß√µes
                'show_intersticios', 'show_gerenciar_intersticios', 'show_gerenciar_previsao', 'show_usuarios',
                'show_permissoes', 'show_orgaos', 'show_organograma', 'show_logs', 'show_titulos_publicacao',
                'show_grandes_comandos', 'show_unidades', 'show_sub_unidades',
                # Submenus - Pessoal
                'show_minhas_informacoes', 'show_minha_ficha_cadastro', 'show_minha_ficha_conceito_oficial',
                'show_minha_ficha_conceito_praca', 'show_criar_ficha_conceito_oficial', 'show_criar_ficha_conceito_praca',
                # Submenus - Relat√≥rios
                'show_relatorios_militares', 'show_relatorios_promocoes', 'show_relatorios_medalhas',
                'show_relatorios_publicacoes', 'show_relatorios_gerais',
                # Menus e Submenus - Frota
                'show_viaturas', 'show_frota', 'show_equipamentos_operacionais', 'show_equipamentos_operacionais_combustivel', 'show_equipamentos_operacionais_manutencoes', 'show_equipamentos_operacionais_trocas_oleo', 'show_equipamentos_operacionais_tempos_uso', 'show_controle_combustivel', 'show_manutencoes',
                'show_trocas_oleo', 'show_licenciamentos', 'show_rodagens', 'show_painel_guarda',
                # Menus e Submenus - Material B√©lico
                'show_material_belico', 'show_armas_instituicao', 'show_armas_particulares',
                'show_cautelas_armas', 'show_controle_movimentacoes', 'show_controle_municao', 'show_cautelas_municoes',
                # Menus e Submenus - Bens M√≥veis
                'show_bens_moveis',
                # Menus e Submenus - Almoxarifado
                'show_almoxarifado',
                'show_processos'
            ]
            
            # Atualizar configura√ß√µes de menu - todos os campos do FuncaoMenuConfig
            for field in menu_fields:
                setattr(menu_config, field, field in request.POST)
            
            # Mapeamento de campos do formul√°rio para campos do menu_config
            campo_form_to_menu_field = {
                'MENU_AFASTAMENTOS': 'show_afastamentos',
                'MENU_FERIAS': 'show_ferias',
                'MENU_PLANEJADAS': 'show_planejadas',
                'MENU_DASHBOARD': 'show_dashboard',
                'MENU_EFETIVO': 'show_efetivo',
                'MENU_PUBLICACOES': 'show_publicacoes',
                'MENU_ESCALAS': 'show_escalas',
                'MENU_SECAO_PROMOCOES': 'show_secao_promocoes',
                'MENU_MEDALHAS': 'show_medalhas',
                'MENU_CONFIGURACOES': 'show_configuracoes',
                'MENU_RELATORIOS': 'show_relatorios',
                'MENU_PESSOAL': 'show_pessoal',
                'MENU_FROTA': 'show_viaturas',
                'MENU_MATERIAL_BELICO': 'show_material_belico',
                'MENU_BENS_MOVEIS': 'show_bens_moveis',
                'MENU_ALMOXARIFADO': 'show_almoxarifado',
                'MENU_PROCESSOS': 'show_processos',
                'SUBMENU_AVERBACOES': 'show_averbacoes',
            }
            
            # Atualizar menu_config com campos do formul√°rio
            for campo_form, campo_menu in campo_form_to_menu_field.items():
                if campo_form in request.POST and hasattr(menu_config, campo_menu):
                    setattr(menu_config, campo_menu, True)
            
            menu_config.save()
            
            # Debug: verificar o que foi salvo
            print(f"DEBUG: Salvando permiss√µes para fun√ß√£o {funcao.nome}")
            print(f"DEBUG: Campos salvos: {[field for field in menu_fields if field in request.POST]}")
            print(f"DEBUG: Total de campos marcados: {len([field for field in menu_fields if field in request.POST])}")
            print(f"DEBUG: Todos os campos POST: {list(request.POST.keys())}")
            print(f"DEBUG: M√©todo da requisi√ß√£o: {request.method}")
            print(f"DEBUG: Content-Type: {request.headers.get('Content-Type')}")
            
            # Primeiro, marcar todas as permiss√µes existentes como inativas
            PermissaoFuncao.objects.filter(funcao_militar=funcao).update(ativo=False)
            
            # Depois, criar/reativar permiss√µes baseadas no formul√°rio
            permissoes_criadas = 0
            
            # Definir estrutura de permiss√µes por m√≥dulo
            modulos_permissoes = {
                # Menus principais
                'MENU_DASHBOARD': 'VISUALIZAR',
                'MENU_EFETIVO': 'VISUALIZAR', 
                'MENU_SECAO_PROMOCOES': 'VISUALIZAR',
                'MENU_MEDALHAS': 'VISUALIZAR',
                'MENU_PUBLICACOES': 'VISUALIZAR',
                'MENU_ESCALAS': 'VISUALIZAR',
                'MENU_CONFIGURACOES': 'VISUALIZAR',
                'MENU_RELATORIOS': 'VISUALIZAR',
                'MENU_PESSOAL': 'VISUALIZAR',
                'MENU_AFASTAMENTOS': 'VISUALIZAR',
                'MENU_FERIAS': 'VISUALIZAR',
            
                # Submenus - Pessoal
                'SUBMENU_MINHAS_INFORMACOES': 'VISUALIZAR',
                'SUBMENU_MINHA_FICHA_CADASTRO': 'VISUALIZAR',
                'SUBMENU_MINHA_FICHA_CONCEITO_OFICIAL': 'VISUALIZAR',
                'SUBMENU_MINHA_FICHA_CONCEITO_PRACA': 'VISUALIZAR',
                'SUBMENU_CRIAR_FICHA_CONCEITO_OFICIAL': 'CRIAR',
                'SUBMENU_CRIAR_FICHA_CONCEITO_PRACA': 'CRIAR',
                
                # Submenus - Efetivo
                'SUBMENU_ATIVOS': 'VISUALIZAR',
                'SUBMENU_INATIVOS': 'VISUALIZAR',
                'SUBMENU_LOTACOES': 'VISUALIZAR',
                'SUBMENU_AVERBACOES': 'VISUALIZAR',
                
                # Submenus - Se√ß√£o de Promo√ß√µes
                'SUBMENU_FICHAS_OFICIAIS': 'VISUALIZAR',
                'SUBMENU_FICHAS_PRACAS': 'VISUALIZAR',
                'SUBMENU_QUADROS_ACESSO': 'VISUALIZAR',
                'SUBMENU_QUADROS_FIXACAO': 'VISUALIZAR',
                'SUBMENU_ALMANAQUES': 'VISUALIZAR',
                'SUBMENU_PROMOCOES': 'VISUALIZAR',
                'SUBMENU_CALENDARIOS': 'VISUALIZAR',
                'SUBMENU_COMISSOES': 'VISUALIZAR',
                'SUBMENU_MEUS_VOTOS': 'VISUALIZAR',
                'SUBMENU_INTERSTICIOS': 'VISUALIZAR',
                'SUBMENU_GERENCIAR_INTERSTICIOS': 'VISUALIZAR',
                'SUBMENU_GERENCIAR_PREVISAO': 'VISUALIZAR',
                
                # Submenus - Medalhas
                'SUBMENU_MEDALHAS_CONCESSOES': 'VISUALIZAR',
                'SUBMENU_MEDALHAS_PROPOSTAS': 'VISUALIZAR',
                'SUBMENU_ELEGIVEIS': 'VISUALIZAR',
                'SUBMENU_PROPOSTAS': 'VISUALIZAR',
                'SUBMENU_CONCEDER_MEDALHA': 'CRIAR',
                
                # Submenus - Publica√ß√µes
                'SUBMENU_NOTAS': 'VISUALIZAR',
                'SUBMENU_NOTAS_RESERVADAS': 'VISUALIZAR',
                'SUBMENU_BOLETINS_OSTENSIVOS': 'VISUALIZAR',
                'SUBMENU_BOLETINS_RESERVADOS': 'VISUALIZAR',
                'SUBMENU_BOLETINS_ESPECIAIS': 'VISUALIZAR',
                
                # Submenus - Escalas de Servi√ßo
                'SUBMENU_ESCALAS_DASHBOARD': 'VISUALIZAR',
                'SUBMENU_ESCALAS_LISTA': 'VISUALIZAR',
                'SUBMENU_ESCALAS_CONFIGURACAO': 'VISUALIZAR',
                'SUBMENU_ESCALAS_BANCO_HORAS': 'VISUALIZAR',
                'SUBMENU_ESCALAS_OPERACOES': 'VISUALIZAR',
                
                # Submenus - Configura√ß√µes/Sistema
                'SUBMENU_USUARIOS': 'VISUALIZAR',
                'SUBMENU_PERMISSOES': 'VISUALIZAR',
                'SUBMENU_ORGAOS': 'VISUALIZAR',
                'SUBMENU_ORGANOGRAMA': 'VISUALIZAR',
                'SUBMENU_LOGS': 'VISUALIZAR',
                'SUBMENU_TITULOS_PUBLICACAO': 'VISUALIZAR',
                'SUBMENU_ADMINISTRACAO': 'VISUALIZAR',
                'SUBMENU_GRANDES_COMANDOS': 'VISUALIZAR',
                'SUBMENU_UNIDADES': 'VISUALIZAR',
                'SUBMENU_SUB_UNIDADES': 'VISUALIZAR',
                
                # Submenus - Relat√≥rios
                'SUBMENU_RELATORIOS_MILITARES': 'VISUALIZAR',
                'SUBMENU_RELATORIOS_PROMOCOES': 'VISUALIZAR',
                'SUBMENU_RELATORIOS_MEDALHAS': 'VISUALIZAR',
                'SUBMENU_RELATORIOS_PUBLICACOES': 'VISUALIZAR',
                'SUBMENU_RELATORIOS_GERAIS': 'VISUALIZAR',
                
                # Submenus - Planejadas
                'MENU_PLANEJADAS': 'VISUALIZAR',
                'SUBMENU_OPERADOR_PLANEJADAS': 'VISUALIZAR',
                'SUBMENU_FISCAL_PLANEJADAS': 'VISUALIZAR',
                'SUBMENU_LIQUIDACAO': 'VISUALIZAR',
                
                # Menus e Submenus - Elogios
                'MENU_ELOGIOS': 'VISUALIZAR',
                'SUBMENU_ELOGIOS_OFICIAIS': 'VISUALIZAR',
                'SUBMENU_ELOGIOS_PRACAS': 'VISUALIZAR',
                
                # Menus e Submenus - Puni√ß√µes
                'MENU_PUNICOES': 'VISUALIZAR',
                'SUBMENU_PUNICOES_OFICIAIS': 'VISUALIZAR',
                'SUBMENU_PUNICOES_PRACAS': 'VISUALIZAR',
                
                # Menus e Submenus - Frota
                'MENU_FROTA': 'VISUALIZAR',
                'SUBMENU_VIATURAS': 'VISUALIZAR',
                'MENU_EQUIPAMENTOS_OPERACIONAIS': 'VISUALIZAR',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS': 'VISUALIZAR',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL': 'VISUALIZAR',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES': 'VISUALIZAR',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO': 'VISUALIZAR',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO': 'VISUALIZAR',
                'SUBMENU_CONTROLE_COMBUSTIVEL': 'VISUALIZAR',
                'SUBMENU_MANUTENCOES': 'VISUALIZAR',
                'SUBMENU_TROCAS_OLEO': 'VISUALIZAR',
                'SUBMENU_LICENCIAMENTOS': 'VISUALIZAR',
                'SUBMENU_RODAGENS': 'VISUALIZAR',
                'SUBMENU_PAINEL_GUARDA': 'VISUALIZAR',
                
                # Menus e Submenus - Material B√©lico
                'MENU_MATERIAL_BELICO': 'VISUALIZAR',
                'SUBMENU_ARMAS_INSTITUICAO': 'VISUALIZAR',
                'SUBMENU_ARMAS_PARTICULARES': 'VISUALIZAR',
                'SUBMENU_CAUTELAS_ARMAS': 'VISUALIZAR',
                'SUBMENU_CONTROLE_MOVIMENTACOES': 'VISUALIZAR',
                'SUBMENU_CONTROLE_MUNICAO': 'VISUALIZAR',
                'SUBMENU_CAUTELAS_MUNICOES': 'VISUALIZAR',
                
                # Menus e Submenus - Processos Administrativos
                'MENU_PROCESSOS': 'VISUALIZAR',
                
                # Menus e Submenus - Almoxarifado
                'MENU_ALMOXARIFADO': 'VISUALIZAR',
                'SUBMENU_ALMOXARIFADO_ITENS': 'VISUALIZAR',
                'SUBMENU_ALMOXARIFADO_ENTRADAS': 'VISUALIZAR',
                'SUBMENU_ALMOXARIFADO_SAIDAS': 'VISUALIZAR',
                'SUBMENU_ALMOXARIFADO_REQUISICOES': 'VISUALIZAR',
                
                # Menus e Submenus - Ensino
                'MENU_ENSINO': 'VISUALIZAR',
                'SUBMENU_ENSINO_DASHBOARD': 'VISUALIZAR',
                'SUBMENU_ENSINO_CURSOS': 'VISUALIZAR',
                'SUBMENU_ENSINO_TURMAS': 'VISUALIZAR',
                'SUBMENU_ENSINO_DISCIPLINAS': 'VISUALIZAR',
                'SUBMENU_ENSINO_ALUNOS': 'VISUALIZAR',
                'SUBMENU_ENSINO_INSTRUTORES': 'VISUALIZAR',
                'SUBMENU_ENSINO_MONITORES': 'VISUALIZAR',
                'SUBMENU_ENSINO_AULAS': 'VISUALIZAR',
                'SUBMENU_ENSINO_FREQUENCIAS': 'VISUALIZAR',
                'SUBMENU_ENSINO_AVALIACOES': 'VISUALIZAR',
                'SUBMENU_ENSINO_CERTIFICADOS': 'VISUALIZAR',
                'SUBMENU_ENSINO_QUADROS_TRABALHO_SEMANAL': 'VISUALIZAR',
            }
            
            # Mapeamento de campos do template para m√≥dulos
            template_to_modulo = {
                'show_dashboard': 'MENU_DASHBOARD',
                'show_efetivo': 'MENU_EFETIVO',
                'show_secao_promocoes': 'MENU_SECAO_PROMOCOES',
                'show_medalhas': 'MENU_MEDALHAS',
                'show_publicacoes': 'MENU_PUBLICACOES',
                'show_escalas': 'MENU_ESCALAS',
                'show_configuracoes': 'MENU_CONFIGURACOES',
                'show_relatorios': 'MENU_RELATORIOS',
                'show_pessoal': 'MENU_PESSOAL',
                'show_afastamentos': 'MENU_AFASTAMENTOS',
                'show_ferias': 'MENU_FERIAS',
                
                # Submenus - Pessoal
                'show_minhas_informacoes': 'SUBMENU_MINHAS_INFORMACOES',
                'show_minha_ficha_cadastro': 'SUBMENU_MINHA_FICHA_CADASTRO',
                'show_minha_ficha_conceito_oficial': 'SUBMENU_MINHA_FICHA_CONCEITO_OFICIAL',
                'show_minha_ficha_conceito_praca': 'SUBMENU_MINHA_FICHA_CONCEITO_PRACA',
                'show_criar_ficha_conceito_oficial': 'SUBMENU_CRIAR_FICHA_CONCEITO_OFICIAL',
                'show_criar_ficha_conceito_praca': 'SUBMENU_CRIAR_FICHA_CONCEITO_PRACA',
                
                # Submenus - Efetivo
                'show_ativos': 'SUBMENU_ATIVOS',
                'show_inativos': 'SUBMENU_INATIVOS',
                'show_lotacoes': 'SUBMENU_LOTACOES',
                'show_averbacoes': 'SUBMENU_AVERBACOES',
                
                # Submenus - Se√ß√£o de Promo√ß√µes
                'show_fichas_oficiais': 'SUBMENU_FICHAS_OFICIAIS',
                'show_fichas_pracas': 'SUBMENU_FICHAS_PRACAS',
                'show_quadros_acesso': 'SUBMENU_QUADROS_ACESSO',
                'show_quadros_fixacao': 'SUBMENU_QUADROS_FIXACAO',
                'show_almanaques': 'SUBMENU_ALMANAQUES',
                'show_promocoes': 'SUBMENU_PROMOCOES',
                'show_calendarios': 'SUBMENU_CALENDARIOS',
                'show_comissoes': 'SUBMENU_COMISSOES',
                'show_meus_votos': 'SUBMENU_MEUS_VOTOS',
                'show_intersticios': 'SUBMENU_INTERSTICIOS',
                'show_gerenciar_intersticios': 'SUBMENU_GERENCIAR_INTERSTICIOS',
                'show_gerenciar_previsao': 'SUBMENU_GERENCIAR_PREVISAO',
                
                # Submenus - Medalhas
                'show_medalhas_concessoes': 'SUBMENU_MEDALHAS_CONCESSOES',
                'show_medalhas_propostas': 'SUBMENU_MEDALHAS_PROPOSTAS',
                'show_elegiveis': 'SUBMENU_ELEGIVEIS',
                'show_propostas': 'SUBMENU_PROPOSTAS',
                
                # Submenus - Publica√ß√µes
                'show_notas': 'SUBMENU_NOTAS',
                'show_boletins_ostensivos': 'SUBMENU_BOLETINS_OSTENSIVOS',
                'show_boletins_reservados': 'SUBMENU_BOLETINS_RESERVADOS',
                'show_boletins_especiais': 'SUBMENU_BOLETINS_ESPECIAIS',
                
                # Submenus - Escalas de Servi√ßo
                'show_escalas_dashboard': 'SUBMENU_ESCALAS_DASHBOARD',
                'show_escalas_lista': 'SUBMENU_ESCALAS_LISTA',
                'show_escalas_configuracao': 'SUBMENU_ESCALAS_CONFIGURACAO',
                'show_escalas_banco_horas': 'SUBMENU_ESCALAS_BANCO_HORAS',
                'show_escalas_operacoes': 'SUBMENU_ESCALAS_OPERACOES',
                
                # Submenus - Configura√ß√µes/Sistema
                'show_usuarios': 'SUBMENU_USUARIOS',
                'show_permissoes': 'SUBMENU_PERMISSOES',
                'show_orgaos': 'SUBMENU_ORGAOS',
                'show_organograma': 'SUBMENU_ORGANOGRAMA',
                'show_logs': 'SUBMENU_LOGS',
                'show_titulos_publicacao': 'SUBMENU_TITULOS_PUBLICACAO',
                'show_administracao': 'SUBMENU_ADMINISTRACAO',
                'show_grandes_comandos': 'SUBMENU_GRANDES_COMANDOS',
                'show_unidades': 'SUBMENU_UNIDADES',
                'show_sub_unidades': 'SUBMENU_SUB_UNIDADES',
                
                # Submenus - Relat√≥rios
                'show_relatorios_militares': 'SUBMENU_RELATORIOS_MILITARES',
                'show_relatorios_promocoes': 'SUBMENU_RELATORIOS_PROMOCOES',
                'show_relatorios_medalhas': 'SUBMENU_RELATORIOS_MEDALHAS',
                'show_relatorios_publicacoes': 'SUBMENU_RELATORIOS_PUBLICACOES',
                'show_relatorios_gerais': 'SUBMENU_RELATORIOS_GERAIS',
                
                # Submenus - Planejadas
                'show_planejadas': 'MENU_PLANEJADAS',
                'show_operador_planejadas': 'SUBMENU_OPERADOR_PLANEJADAS',
                'show_fiscal_planejadas': 'SUBMENU_FISCAL_PLANEJADAS',
                'show_liquidacao': 'SUBMENU_LIQUIDACAO',
                
                # Menus e Submenus - Frota
                'show_viaturas': 'MENU_FROTA',
                'show_frota': 'MENU_FROTA',
                'show_viaturas_submenu': 'SUBMENU_VIATURAS',
                'show_equipamentos_operacionais': 'MENU_EQUIPAMENTOS_OPERACIONAIS',
                'show_equipamentos_operacionais_combustivel': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL',
                'show_equipamentos_operacionais_manutencoes': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES',
                'show_equipamentos_operacionais_trocas_oleo': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO',
                'show_equipamentos_operacionais_tempos_uso': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO',
                'show_controle_combustivel': 'SUBMENU_CONTROLE_COMBUSTIVEL',
                'show_manutencoes': 'SUBMENU_MANUTENCOES',
                'show_trocas_oleo': 'SUBMENU_TROCAS_OLEO',
                'show_licenciamentos': 'SUBMENU_LICENCIAMENTOS',
                'show_rodagens': 'SUBMENU_RODAGENS',
                'show_painel_guarda': 'SUBMENU_PAINEL_GUARDA',
                
                # Menus e Submenus - Material B√©lico
                'show_material_belico': 'MENU_MATERIAL_BELICO',
                
                # Menus e Submenus - Bens M√≥veis
                'show_bens_moveis': 'MENU_BENS_MOVEIS',
                
                # Menus e Submenus - Almoxarifado
                'show_almoxarifado': 'MENU_ALMOXARIFADO',
                'show_processos': 'MENU_PROCESSOS',
                
                # Menus e Submenus - Ensino
                'show_ensino': 'MENU_ENSINO',
                'show_ensino_dashboard': 'SUBMENU_ENSINO_DASHBOARD',
                'show_ensino_cursos': 'SUBMENU_ENSINO_CURSOS',
                'show_ensino_turmas': 'SUBMENU_ENSINO_TURMAS',
                'show_ensino_disciplinas': 'SUBMENU_ENSINO_DISCIPLINAS',
                'show_ensino_alunos': 'SUBMENU_ENSINO_ALUNOS',
                'show_ensino_instrutores': 'SUBMENU_ENSINO_INSTRUTORES',
                'show_ensino_monitores': 'SUBMENU_ENSINO_MONITORES',
                'show_ensino_aulas': 'SUBMENU_ENSINO_AULAS',
                'show_ensino_frequencias': 'SUBMENU_ENSINO_FREQUENCIAS',
                'show_ensino_avaliacoes': 'SUBMENU_ENSINO_AVALIACOES',
                'show_ensino_certificados': 'SUBMENU_ENSINO_CERTIFICADOS',
                'show_ensino_quadros_trabalho_semanal': 'SUBMENU_ENSINO_QUADROS_TRABALHO_SEMANAL',
                
                'show_armas_instituicao': 'SUBMENU_ARMAS_INSTITUICAO',
                'show_armas_particulares': 'SUBMENU_ARMAS_PARTICULARES',
                'show_cautelas_armas': 'SUBMENU_CAUTELAS_ARMAS',
                'show_controle_movimentacoes': 'SUBMENU_CONTROLE_MOVIMENTACOES',
                'show_controle_municao': 'SUBMENU_CONTROLE_MUNICAO',
                'show_cautelas_municoes': 'SUBMENU_CAUTELAS_MUNICOES',
            }
            
            # Processar permiss√µes de menus baseadas nas configura√ß√µes
            # Guardar quais campos foram realmente salvos para n√£o processar novamente
            campos_salvos_com_sucesso = set()
            
            # Processar tamb√©m campos diretos do formul√°rio (MENU_*, SUBMENU_*)
            campos_diretos = {
                'MENU_FROTA', 'MENU_EQUIPAMENTOS_OPERACIONAIS', 'MENU_MATERIAL_BELICO', 'SUBMENU_AVERBACOES',
                'SUBMENU_VIATURAS', 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS', 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL', 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES', 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO', 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO', 'SUBMENU_CONTROLE_COMBUSTIVEL', 'SUBMENU_MANUTENCOES',
                'SUBMENU_TROCAS_OLEO', 'SUBMENU_LICENCIAMENTOS', 'SUBMENU_RODAGENS',
                'SUBMENU_PAINEL_GUARDA', 'SUBMENU_ARMAS_INSTITUICAO', 'SUBMENU_ARMAS_PARTICULARES',
                'SUBMENU_CAUTELAS_ARMAS', 'SUBMENU_CONTROLE_MOVIMENTACOES', 'SUBMENU_CONTROLE_MUNICAO',
                'SUBMENU_CAUTELAS_MUNICOES',
                # Menus e Submenus - Ensino
                'MENU_ENSINO', 'SUBMENU_ENSINO_DASHBOARD', 'SUBMENU_ENSINO_CURSOS', 'SUBMENU_ENSINO_TURMAS',
                'SUBMENU_ENSINO_DISCIPLINAS', 'SUBMENU_ENSINO_ALUNOS', 'SUBMENU_ENSINO_INSTRUTORES',
                'SUBMENU_ENSINO_MONITORES', 'SUBMENU_ENSINO_AULAS', 'SUBMENU_ENSINO_FREQUENCIAS',
                'SUBMENU_ENSINO_AVALIACOES', 'SUBMENU_ENSINO_CERTIFICADOS', 'SUBMENU_ENSINO_QUADROS_TRABALHO_SEMANAL'
            }
            
            for campo_direto in campos_diretos:
                if campo_direto in request.POST:
                    modulo = campo_direto
                    acesso = modulos_permissoes.get(modulo, 'VISUALIZAR')
                    try:
                        permissao, created = PermissaoFuncao.objects.get_or_create(
                            funcao_militar=funcao,
                            modulo=modulo,
                            acesso=acesso,
                            defaults={'ativo': True}
                        )
                        if not created:
                            permissao.ativo = True
                            permissao.save()
                        campos_salvos_com_sucesso.add(modulo)
                        permissoes_criadas += 1
                    except Exception as e:
                        print(f"Erro ao criar permiss√£o {modulo}: {e}")
            
            for campo_template, modulo in template_to_modulo.items():
                if campo_template in request.POST:
                    # Encontrar o acesso correspondente
                    acesso = modulos_permissoes.get(modulo, 'VISUALIZAR')
                    # Verificar se j√° existe e reativar, ou criar nova
                    try:
                        permissao, created = PermissaoFuncao.objects.get_or_create(
                            funcao_militar=funcao,
                            modulo=modulo,
                            acesso=acesso,
                            defaults={'ativo': True}
                        )
                        if not created:
                            # Reativar se estava inativa
                            permissao.ativo = True
                            permissao.save()
                        permissoes_criadas += 1
                        campos_salvos_com_sucesso.add(campo_template)
                        campos_salvos_com_sucesso.add(modulo)  # Tamb√©m marcar o m√≥dulo como salvo
                        print(f"DEBUG: Permiss√£o de menu {'criada' if created else 'reativada'} - {campo_template} -> {modulo}: {acesso}")
                    except Exception as e:
                        print(f"DEBUG: Erro ao salvar permiss√£o {campo_template}: {str(e)}")
            
            # Processar tamb√©m os campos que v√™m diretamente do formul√°rio (ex: MENU_AFASTAMENTOS, MENU_PESSOAL, SUBMENU_ATIVOS, etc)
            # Verificar se campos com nome direto de m√≥dulo foram enviados
            modulos_diretos_do_form = {
                'MENU_AFASTAMENTOS': 'MENU_AFASTAMENTOS',
                'MENU_FERIAS': 'MENU_FERIAS',
                'MENU_PLANEJADAS': 'MENU_PLANEJADAS',
                'MENU_PESSOAL': 'MENU_PESSOAL',
                'MENU_EFETIVO': 'MENU_EFETIVO',
                'MENU_SECAO_PROMOCOES': 'MENU_SECAO_PROMOCOES',
                'MENU_MEDALHAS': 'MENU_MEDALHAS',
                'MENU_PUBLICACOES': 'MENU_PUBLICACOES',
                'MENU_ESCALAS': 'MENU_ESCALAS',
                'MENU_CONFIGURACOES': 'MENU_CONFIGURACOES',
                'MENU_RELATORIOS': 'MENU_RELATORIOS',
                'SUBMENU_PLANEJADAS': 'SUBMENU_PLANEJADAS',
                'SUBMENU_MINHAS_INFORMACOES': 'SUBMENU_MINHAS_INFORMACOES',
                'SUBMENU_MINHA_FICHA_CADASTRO': 'SUBMENU_MINHA_FICHA_CADASTRO',
                'SUBMENU_MINHA_FICHA_CONCEITO_OFICIAL': 'SUBMENU_MINHA_FICHA_CONCEITO_OFICIAL',
                'SUBMENU_MINHA_FICHA_CONCEITO_PRACA': 'SUBMENU_MINHA_FICHA_CONCEITO_PRACA',
                'SUBMENU_CRIAR_FICHA_CONCEITO_OFICIAL': 'SUBMENU_CRIAR_FICHA_CONCEITO_OFICIAL',
                'SUBMENU_CRIAR_FICHA_CONCEITO_PRACA': 'SUBMENU_CRIAR_FICHA_CONCEITO_PRACA',
                'SUBMENU_ATIVOS': 'SUBMENU_ATIVOS',
                'SUBMENU_INATIVOS': 'SUBMENU_INATIVOS',
                'SUBMENU_LOTACOES': 'SUBMENU_LOTACOES',
                'SUBMENU_AVERBACOES': 'SUBMENU_AVERBACOES',
                'SUBMENU_FICHAS_OFICIAIS': 'SUBMENU_FICHAS_OFICIAIS',
                'SUBMENU_FICHAS_PRACAS': 'SUBMENU_FICHAS_PRACAS',
                'SUBMENU_QUADROS_ACESSO': 'SUBMENU_QUADROS_ACESSO',
                'SUBMENU_QUADROS_FIXACAO': 'SUBMENU_QUADROS_FIXACAO',
                'SUBMENU_ALMANAQUES': 'SUBMENU_ALMANAQUES',
                'SUBMENU_PROMOCOES': 'SUBMENU_PROMOCOES',
                'SUBMENU_CALENDARIOS': 'SUBMENU_CALENDARIOS',
                'SUBMENU_COMISSOES': 'SUBMENU_COMISSOES',
                'SUBMENU_MEUS_VOTOS': 'SUBMENU_MEUS_VOTOS',
                'SUBMENU_INTERSTICIOS': 'SUBMENU_INTERSTICIOS',
                'SUBMENU_GERENCIAR_INTERSTICIOS': 'SUBMENU_GERENCIAR_INTERSTICIOS',
                'SUBMENU_GERENCIAR_PREVISAO': 'SUBMENU_GERENCIAR_PREVISAO',
                'SUBMENU_MEDALHAS_CONCESSOES': 'SUBMENU_MEDALHAS_CONCESSOES',
                'SUBMENU_MEDALHAS_PROPOSTAS': 'SUBMENU_MEDALHAS_PROPOSTAS',
                'SUBMENU_ELEGIVEIS': 'SUBMENU_ELEGIVEIS',
                'SUBMENU_PROPOSTAS': 'SUBMENU_PROPOSTAS',
                'SUBMENU_CONCEDER_MEDALHA': 'SUBMENU_CONCEDER_MEDALHA',
                'SUBMENU_NOTAS': 'SUBMENU_NOTAS',
                'SUBMENU_BOLETINS_OSTENSIVOS': 'SUBMENU_BOLETINS_OSTENSIVOS',
                'SUBMENU_BOLETINS_RESERVADOS': 'SUBMENU_BOLETINS_RESERVADOS',
                'SUBMENU_BOLETINS_ESPECIAIS': 'SUBMENU_BOLETINS_ESPECIAIS',
                'SUBMENU_ESCALAS_DASHBOARD': 'SUBMENU_ESCALAS_DASHBOARD',
                'SUBMENU_ESCALAS_LISTA': 'SUBMENU_ESCALAS_LISTA',
                'SUBMENU_ESCALAS_CONFIGURACAO': 'SUBMENU_ESCALAS_CONFIGURACAO',
                'SUBMENU_ESCALAS_BANCO_HORAS': 'SUBMENU_ESCALAS_BANCO_HORAS',
                'SUBMENU_ESCALAS_OPERACOES': 'SUBMENU_ESCALAS_OPERACOES',
                'SUBMENU_USUARIOS': 'SUBMENU_USUARIOS',
                'SUBMENU_PERMISSOES': 'SUBMENU_PERMISSOES',
                'SUBMENU_ORGAOS': 'SUBMENU_ORGAOS',
                'SUBMENU_ORGANOGRAMA': 'SUBMENU_ORGANOGRAMA',
                'SUBMENU_LOGS': 'SUBMENU_LOGS',
                'SUBMENU_TITULOS_PUBLICACAO': 'SUBMENU_TITULOS_PUBLICACAO',
                'SUBMENU_ADMINISTRACAO': 'SUBMENU_ADMINISTRACAO',
                'SUBMENU_GRANDES_COMANDOS': 'SUBMENU_GRANDES_COMANDOS',
                'SUBMENU_UNIDADES': 'SUBMENU_UNIDADES',
                'SUBMENU_SUB_UNIDADES': 'SUBMENU_SUB_UNIDADES',
                'SUBMENU_RELATORIOS_MILITARES': 'SUBMENU_RELATORIOS_MILITARES',
                'SUBMENU_RELATORIOS_PROMOCOES': 'SUBMENU_RELATORIOS_PROMOCOES',
                'SUBMENU_RELATORIOS_MEDALHAS': 'SUBMENU_RELATORIOS_MEDALHAS',
                'SUBMENU_RELATORIOS_PUBLICACOES': 'SUBMENU_RELATORIOS_PUBLICACOES',
                'SUBMENU_RELATORIOS_GERAIS': 'SUBMENU_RELATORIOS_GERAIS',
                'SUBMENU_OPERADOR_PLANEJADAS': 'SUBMENU_OPERADOR_PLANEJADAS',
                'SUBMENU_FISCAL_PLANEJADAS': 'SUBMENU_FISCAL_PLANEJADAS',
                'SUBMENU_LIQUIDACAO': 'SUBMENU_LIQUIDACAO',
                
                # Menus e Submenus - Elogios
                'MENU_ELOGIOS': 'MENU_ELOGIOS',
                'SUBMENU_ELOGIOS_OFICIAIS': 'SUBMENU_ELOGIOS_OFICIAIS',
                'SUBMENU_ELOGIOS_PRACAS': 'SUBMENU_ELOGIOS_PRACAS',
                
                # Menus e Submenus - Puni√ß√µes
                'MENU_PUNICOES': 'MENU_PUNICOES',
                'SUBMENU_PUNICOES_OFICIAIS': 'SUBMENU_PUNICOES_OFICIAIS',
                'SUBMENU_PUNICOES_PRACAS': 'SUBMENU_PUNICOES_PRACAS',
                
                # Menus e Submenus - Frota
                'MENU_FROTA': 'MENU_FROTA',
                'SUBMENU_VIATURAS': 'SUBMENU_VIATURAS',
                'SUBMENU_CONTROLE_COMBUSTIVEL': 'SUBMENU_CONTROLE_COMBUSTIVEL',
                
                # Menus e Submenus - Equipamentos Operacionais
                'MENU_EQUIPAMENTOS_OPERACIONAIS': 'MENU_EQUIPAMENTOS_OPERACIONAIS',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO': 'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO',
                'SUBMENU_MANUTENCOES': 'SUBMENU_MANUTENCOES',
                'SUBMENU_TROCAS_OLEO': 'SUBMENU_TROCAS_OLEO',
                'SUBMENU_LICENCIAMENTOS': 'SUBMENU_LICENCIAMENTOS',
                'SUBMENU_RODAGENS': 'SUBMENU_RODAGENS',
                'SUBMENU_PAINEL_GUARDA': 'SUBMENU_PAINEL_GUARDA',
                
                # Menus e Submenus - Material B√©lico
                'MENU_MATERIAL_BELICO': 'MENU_MATERIAL_BELICO',
                'SUBMENU_ARMAS_INSTITUICAO': 'SUBMENU_ARMAS_INSTITUICAO',
                'SUBMENU_ARMAS_PARTICULARES': 'SUBMENU_ARMAS_PARTICULARES',
                'SUBMENU_CAUTELAS_ARMAS': 'SUBMENU_CAUTELAS_ARMAS',
                'SUBMENU_CONTROLE_MOVIMENTACOES': 'SUBMENU_CONTROLE_MOVIMENTACOES',
                'SUBMENU_CONTROLE_MUNICAO': 'SUBMENU_CONTROLE_MUNICAO',
                'SUBMENU_CAUTELAS_MUNICOES': 'SUBMENU_CAUTELAS_MUNICOES',
                
                # Menus e Submenus - Processos Administrativos
                'MENU_PROCESSOS': 'MENU_PROCESSOS',
                
                # Menus e Submenus - Almoxarifado
                'MENU_ALMOXARIFADO': 'MENU_ALMOXARIFADO',
                'SUBMENU_ALMOXARIFADO_ITENS': 'SUBMENU_ALMOXARIFADO_ITENS',
                'SUBMENU_ALMOXARIFADO_ENTRADAS': 'SUBMENU_ALMOXARIFADO_ENTRADAS',
                'SUBMENU_ALMOXARIFADO_SAIDAS': 'SUBMENU_ALMOXARIFADO_SAIDAS',
                'SUBMENU_ALMOXARIFADO_REQUISICOES': 'SUBMENU_ALMOXARIFADO_REQUISICOES',
            }
            for campo_form, modulo_direto in modulos_diretos_do_form.items():
                if campo_form in request.POST and campo_form not in campos_salvos_com_sucesso:
                    # Verificar se j√° foi processado pelo template_to_modulo
                    ja_processado = False
                    for campo_tpl, mod_tpl in template_to_modulo.items():
                        if campo_tpl in request.POST and mod_tpl == modulo_direto:
                            ja_processado = True
                            break
                    
                    if not ja_processado:
                        acesso = modulos_permissoes.get(modulo_direto, 'VISUALIZAR')
                        # Verificar se j√° existe e reativar, ou criar nova
                        try:
                            permissao, created = PermissaoFuncao.objects.get_or_create(
                                funcao_militar=funcao,
                                modulo=modulo_direto,
                                acesso=acesso,
                                defaults={'ativo': True}
                            )
                            if not created:
                                permissao.ativo = True
                                permissao.save()
                            permissoes_criadas += 1
                            campos_salvos_com_sucesso.add(campo_form)
                            campos_salvos_com_sucesso.add(modulo_direto)
                            print(f"DEBUG: Permiss√£o de menu {'criada' if created else 'reativada'} diretamente - {campo_form} -> {modulo_direto}: {acesso}")
                        except Exception as e:
                            print(f"DEBUG: Erro ao salvar permiss√£o {campo_form}: {str(e)}")
            
            # Mapeamento de permiss√µes espec√≠ficas por m√≥dulo
            permissoes_especificas = {
                # Militares
                'MILITARES_VISUALIZAR': ('MILITARES', 'VISUALIZAR'),
                'MILITARES_CRIAR': ('MILITARES', 'CRIAR'),
                'MILITARES_EDITAR': ('MILITARES', 'EDITAR'),
                'MILITARES_EXCLUIR': ('MILITARES', 'EXCLUIR'),
                'MILITARES_TRANSFERIR': ('MILITARES', 'TRANSFERIR'),
                'MILITARES_PROMOVER': ('MILITARES', 'PROMOVER'),
                'MILITARES_INATIVAR': ('MILITARES', 'INATIVAR'),
                'MILITARES_FICHA_CONCEITO': ('MILITARES', 'FICHA_CONCEITO'),
                'MILITARES_EXPORTAR': ('MILITARES', 'EXPORTAR'),
                
                # Submenus - Ativos
                'SUBMENU_ATIVOS_visualizar': ('SUBMENU_ATIVOS', 'VISUALIZAR'),
                'SUBMENU_ATIVOS_criar': ('SUBMENU_ATIVOS', 'CRIAR'),
                'SUBMENU_ATIVOS_editar': ('SUBMENU_ATIVOS', 'EDITAR'),
                'SUBMENU_ATIVOS_excluir': ('SUBMENU_ATIVOS', 'EXCLUIR'),
                
                # Submenus - Inativos
                'SUBMENU_INATIVOS_visualizar': ('SUBMENU_INATIVOS', 'VISUALIZAR'),
                'SUBMENU_INATIVOS_editar': ('SUBMENU_INATIVOS', 'EDITAR'),
                'SUBMENU_INATIVOS_excluir': ('SUBMENU_INATIVOS', 'EXCLUIR'),
                
                # Submenus - Lota√ß√µes
                'SUBMENU_LOTACOES_visualizar': ('SUBMENU_LOTACOES', 'VISUALIZAR'),
                'SUBMENU_LOTACOES_criar': ('SUBMENU_LOTACOES', 'CRIAR'),
                'SUBMENU_LOTACOES_editar': ('SUBMENU_LOTACOES', 'EDITAR'),
                'SUBMENU_LOTACOES_excluir': ('SUBMENU_LOTACOES', 'EXCLUIR'),
                
                # Inativos
                'INATIVOS_VISUALIZAR': ('INATIVOS', 'VISUALIZAR'),
                'INATIVOS_EDITAR': ('INATIVOS', 'EDITAR'),
                'INATIVOS_EXCLUIR': ('INATIVOS', 'EXCLUIR'),
                'INATIVOS_REATIVAR': ('INATIVOS', 'REATIVAR'),
                
                # Notas
                'NOTAS_VISUALIZAR': ('NOTAS', 'VISUALIZAR'),
                'NOTAS_CRIAR': ('NOTAS', 'CRIAR'),
                'NOTAS_EDITAR': ('NOTAS', 'EDITAR'),
                'NOTAS_EXCLUIR': ('NOTAS', 'EXCLUIR'),
                'NOTAS_PUBLICAR': ('NOTAS', 'PUBLICAR'),
                'NOTAS_APROVAR': ('NOTAS', 'APROVAR'),
                'NOTAS_REVISAR': ('NOTAS', 'REVISAR'),
                
                # Notas Reservadas
                'NOTAS_RESERVADAS_VISUALIZAR': ('NOTAS_RESERVADAS', 'VISUALIZAR'),
                'NOTAS_RESERVADAS_CRIAR': ('NOTAS_RESERVADAS', 'CRIAR'),
                'NOTAS_RESERVADAS_EDITAR': ('NOTAS_RESERVADAS', 'EDITAR'),
                'NOTAS_RESERVADAS_EXCLUIR': ('NOTAS_RESERVADAS', 'EXCLUIR'),
                'NOTAS_RESERVADAS_PUBLICAR': ('NOTAS_RESERVADAS', 'PUBLICAR'),
                'NOTAS_RESERVADAS_APROVAR': ('NOTAS_RESERVADAS', 'APROVAR'),
                'NOTAS_RESERVADAS_REVISAR': ('NOTAS_RESERVADAS', 'REVISAR'),
                
                # Submenus - Notas Reservadas
                'SUBMENU_NOTAS_RESERVADAS_visualizar': ('SUBMENU_NOTAS_RESERVADAS', 'VISUALIZAR'),
                'SUBMENU_NOTAS_RESERVADAS_criar': ('SUBMENU_NOTAS_RESERVADAS', 'CRIAR'),
                'SUBMENU_NOTAS_RESERVADAS_editar': ('SUBMENU_NOTAS_RESERVADAS', 'EDITAR'),
                'SUBMENU_NOTAS_RESERVADAS_excluir': ('SUBMENU_NOTAS_RESERVADAS', 'EXCLUIR'),
                
                # Boletins Ostensivos
                'BOLETINS_OSTENSIVOS_VISUALIZAR': ('BOLETINS_OSTENSIVOS', 'VISUALIZAR'),
                'BOLETINS_OSTENSIVOS_CRIAR': ('BOLETINS_OSTENSIVOS', 'CRIAR'),
                'BOLETINS_OSTENSIVOS_EDITAR': ('BOLETINS_OSTENSIVOS', 'EDITAR'),
                'BOLETINS_OSTENSIVOS_EXCLUIR': ('BOLETINS_OSTENSIVOS', 'EXCLUIR'),
                'BOLETINS_OSTENSIVOS_PUBLICAR': ('BOLETINS_OSTENSIVOS', 'PUBLICAR'),
                'BOLETINS_OSTENSIVOS_APROVAR': ('BOLETINS_OSTENSIVOS', 'APROVAR'),
                'BOLETINS_OSTENSIVOS_REVISAR': ('BOLETINS_OSTENSIVOS', 'REVISAR'),
                
                # Boletins Reservados
                'BOLETINS_RESERVADOS_VISUALIZAR': ('BOLETINS_RESERVADOS', 'VISUALIZAR'),
                'BOLETINS_RESERVADOS_CRIAR': ('BOLETINS_RESERVADOS', 'CRIAR'),
                'BOLETINS_RESERVADOS_EDITAR': ('BOLETINS_RESERVADOS', 'EDITAR'),
                'BOLETINS_RESERVADOS_EXCLUIR': ('BOLETINS_RESERVADOS', 'EXCLUIR'),
                'BOLETINS_RESERVADOS_PUBLICAR': ('BOLETINS_RESERVADOS', 'PUBLICAR'),
                'BOLETINS_RESERVADOS_APROVAR': ('BOLETINS_RESERVADOS', 'APROVAR'),
                'BOLETINS_RESERVADOS_REVISAR': ('BOLETINS_RESERVADOS', 'REVISAR'),
                
                # Submenus - Boletins Reservados
                'SUBMENU_BOLETINS_RESERVADOS_visualizar': ('SUBMENU_BOLETINS_RESERVADOS', 'VISUALIZAR'),
                'SUBMENU_BOLETINS_RESERVADOS_criar': ('SUBMENU_BOLETINS_RESERVADOS', 'CRIAR'),
                'SUBMENU_BOLETINS_RESERVADOS_editar': ('SUBMENU_BOLETINS_RESERVADOS', 'EDITAR'),
                'SUBMENU_BOLETINS_RESERVADOS_excluir': ('SUBMENU_BOLETINS_RESERVADOS', 'EXCLUIR'),
                
                # Escalas de Servi√ßo
                'ESCALAS_VISUALIZAR': ('ESCALAS', 'VISUALIZAR'),
                'ESCALAS_CRIAR': ('ESCALAS', 'CRIAR'),
                'ESCALAS_EDITAR': ('ESCALAS', 'EDITAR'),
                'ESCALAS_EXCLUIR': ('ESCALAS', 'EXCLUIR'),
                'ESCALAS_GERAR_PDF': ('ESCALAS', 'GERAR_PDF'),
                'ESCALAS_ADICIONAR_MILITAR': ('ESCALAS', 'ADICIONAR_MILITAR'),
                'ESCALAS_REMOVER_MILITAR': ('ESCALAS', 'REMOVER_MILITAR'),
                'ESCALAS_CONFIGURAR_HORAS': ('ESCALAS', 'CONFIGURAR_HORAS'),
                'ESCALAS_OPERACOES_PLANEJADAS': ('ESCALAS', 'OPERACOES_PLANEJADAS'),
                
                # Quadros de Acesso
                'QUADROS_ACESSO_VISUALIZAR': ('QUADROS_ACESSO', 'VISUALIZAR'),
                'QUADROS_ACESSO_CRIAR': ('QUADROS_ACESSO', 'CRIAR'),
                'QUADROS_ACESSO_EDITAR': ('QUADROS_ACESSO', 'EDITAR'),
                'QUADROS_ACESSO_EXCLUIR': ('QUADROS_ACESSO', 'EXCLUIR'),
                'QUADROS_ACESSO_GERAR_PDF': ('QUADROS_ACESSO', 'GERAR_PDF'),
                'QUADROS_ACESSO_HOMOLOGAR': ('QUADROS_ACESSO', 'HOMOLOGAR'),
                'QUADROS_ACESSO_ELABORAR': ('QUADROS_ACESSO', 'ELABORAR'),
                
                # Medalhas
                'MEDALHAS_VISUALIZAR': ('MEDALHAS', 'VISUALIZAR'),
                'MEDALHAS_CRIAR': ('MEDALHAS', 'CRIAR'),
                'MEDALHAS_EDITAR': ('MEDALHAS', 'EDITAR'),
                'MEDALHAS_EXCLUIR': ('MEDALHAS', 'EXCLUIR'),
                
                # Processos Administrativos
                'PROCESSOS_VISUALIZAR': ('PROCESSOS', 'VISUALIZAR'),
                'PROCESSOS_CRIAR': ('PROCESSOS', 'CRIAR'),
                'PROCESSOS_EDITAR': ('PROCESSOS', 'EDITAR'),
                'PROCESSOS_EXCLUIR': ('PROCESSOS', 'EXCLUIR'),
                'PROCESSOS_GERAR_PDF': ('PROCESSOS', 'GERAR_PDF'),
                # Almoxarifado
                'ALMOXARIFADO_VISUALIZAR': ('ALMOXARIFADO', 'VISUALIZAR'),
                'ALMOXARIFADO_CRIAR': ('ALMOXARIFADO', 'CRIAR'),
                'ALMOXARIFADO_EDITAR': ('ALMOXARIFADO', 'EDITAR'),
                'ALMOXARIFADO_EXCLUIR': ('ALMOXARIFADO', 'EXCLUIR'),
                'MEDALHAS_APROVAR': ('MEDALHAS', 'APROVAR'),
                'MEDALHAS_HOMOLOGAR': ('MEDALHAS', 'HOMOLOGAR'),
                'MEDALHAS_CONCEDER': ('MEDALHAS', 'CONCEDER'),
                
                # Usu√°rios
                'USUARIOS_VISUALIZAR': ('USUARIOS', 'VISUALIZAR'),
                'USUARIOS_CRIAR': ('USUARIOS', 'CRIAR'),
                'USUARIOS_EDITAR': ('USUARIOS', 'EDITAR'),
                'USUARIOS_EXCLUIR': ('USUARIOS', 'EXCLUIR'),
                'USUARIOS_ALTERAR_SENHA': ('USUARIOS', 'ALTERAR_SENHA'),
                'USUARIOS_GERENCIAR_FUNCOES': ('USUARIOS', 'GERENCIAR_FUNCOES'),
                
                # Relat√≥rios
                'RELATORIOS_VISUALIZAR': ('RELATORIOS', 'VISUALIZAR'),
                'RELATORIOS_GERAR': ('RELATORIOS', 'GERAR'),
                'RELATORIOS_EXPORTAR': ('RELATORIOS', 'EXPORTAR'),
                'RELATORIOS_IMPRIMIR': ('RELATORIOS', 'IMPRIMIR'),
                
                # Opera√ß√µes Planejadas
                'PLANEJADAS_VISUALIZAR': ('PLANEJADAS', 'VISUALIZAR'),
                'PLANEJADAS_CRIAR': ('PLANEJADAS', 'CRIAR'),
                'PLANEJADAS_EDITAR': ('PLANEJADAS', 'EDITAR'),
                'PLANEJADAS_EXCLUIR': ('PLANEJADAS', 'EXCLUIR'),
                'PLANEJADAS_ADICIONAR_MILITAR': ('PLANEJADAS', 'ADICIONAR_MILITAR'),
                'PLANEJADAS_REMOVER_MILITAR': ('PLANEJADAS', 'REMOVER_MILITAR'),
                'PLANEJADAS_ASSINAR_OPERADOR': ('PLANEJADAS', 'ASSINAR_OPERADOR'),
                'PLANEJADAS_ASSINAR_FISCAL': ('PLANEJADAS', 'ASSINAR_FISCAL'),
                
                # Afastamentos
                'AFASTAMENTOS_VISUALIZAR': ('AFASTAMENTOS', 'VISUALIZAR'),
                'AFASTAMENTOS_CRIAR': ('AFASTAMENTOS', 'CRIAR'),
                'AFASTAMENTOS_EDITAR': ('AFASTAMENTOS', 'EDITAR'),
                'AFASTAMENTOS_EXCLUIR': ('AFASTAMENTOS', 'EXCLUIR'),
                
                # Frota/Viaturas
                'VIATURAS_VISUALIZAR': ('VIATURAS', 'VISUALIZAR'),
                'VIATURAS_CRIAR': ('VIATURAS', 'CRIAR'),
                'VIATURAS_EDITAR': ('VIATURAS', 'EDITAR'),
                'VIATURAS_EXCLUIR': ('VIATURAS', 'EXCLUIR'),
                
                # Equipamentos Operacionais
                'EQUIPAMENTOS_OPERACIONAIS_VISUALIZAR': ('EQUIPAMENTOS_OPERACIONAIS', 'VISUALIZAR'),
                'EQUIPAMENTOS_OPERACIONAIS_CRIAR': ('EQUIPAMENTOS_OPERACIONAIS', 'CRIAR'),
                'EQUIPAMENTOS_OPERACIONAIS_EDITAR': ('EQUIPAMENTOS_OPERACIONAIS', 'EDITAR'),
                'EQUIPAMENTOS_OPERACIONAIS_EXCLUIR': ('EQUIPAMENTOS_OPERACIONAIS', 'EXCLUIR'),
                
                # Material B√©lico/Armas
                'ARMAS_VISUALIZAR': ('ARMAS', 'VISUALIZAR'),
                'ARMAS_CRIAR': ('ARMAS', 'CRIAR'),
                'ARMAS_EDITAR': ('ARMAS', 'EDITAR'),
                'ARMAS_EXCLUIR': ('ARMAS', 'EXCLUIR'),
                
                # Bens M√≥veis
                'BENS_MOVEIS_VISUALIZAR': ('BENS_MOVEIS', 'VISUALIZAR'),
                'BENS_MOVEIS_CRIAR': ('BENS_MOVEIS', 'CRIAR'),
                'BENS_MOVEIS_EDITAR': ('BENS_MOVEIS', 'EDITAR'),
                'BENS_MOVEIS_EXCLUIR': ('BENS_MOVEIS', 'EXCLUIR'),
                
                # Elogios
                'elogios_visualizar': ('ELOGIOS', 'VISUALIZAR'),
                'elogios_criar': ('ELOGIOS', 'CRIAR'),
                'elogios_editar': ('ELOGIOS', 'EDITAR'),
                'ELOGIOS_VISUALIZAR': ('ELOGIOS', 'VISUALIZAR'),
                'ELOGIOS_CRIAR': ('ELOGIOS', 'CRIAR'),
                'ELOGIOS_EDITAR': ('ELOGIOS', 'EDITAR'),
                'ELOGIOS_EXCLUIR': ('ELOGIOS', 'EXCLUIR'),
                
                # Puni√ß√µes
                'punicoes_visualizar': ('PUNICOES', 'VISUALIZAR'),
                'punicoes_criar': ('PUNICOES', 'CRIAR'),
                'punicoes_editar': ('PUNICOES', 'EDITAR'),
                'PUNICOES_VISUALIZAR': ('PUNICOES', 'VISUALIZAR'),
                'PUNICOES_CRIAR': ('PUNICOES', 'CRIAR'),
                'PUNICOES_EDITAR': ('PUNICOES', 'EDITAR'),
                'PUNICOES_EXCLUIR': ('PUNICOES', 'EXCLUIR'),
                
                # Ensino
                'ensino_visualizar': ('ENSINO', 'VISUALIZAR'),
                'ensino_criar': ('ENSINO', 'CRIAR'),
                'ensino_editar': ('ENSINO', 'EDITAR'),
                'ensino_excluir': ('ENSINO', 'EXCLUIR'),
                'ENSINO_VISUALIZAR': ('ENSINO', 'VISUALIZAR'),
                'ENSINO_CRIAR': ('ENSINO', 'CRIAR'),
                'ENSINO_EDITAR': ('ENSINO', 'EDITAR'),
                'ENSINO_EXCLUIR': ('ENSINO', 'EXCLUIR'),
                
                # Fichas de Conceito
                'FICHAS_CONCEITO_VISUALIZAR': ('FICHAS_CONCEITO', 'VISUALIZAR'),
                'FICHAS_CONCEITO_CRIAR': ('FICHAS_CONCEITO', 'CRIAR'),
                'FICHAS_CONCEITO_EDITAR': ('FICHAS_CONCEITO', 'EDITAR'),
                'FICHAS_CONCEITO_EXCLUIR': ('FICHAS_CONCEITO', 'EXCLUIR'),
                
                # Quadros de Fixa√ß√£o
                'QUADROS_FIXACAO_VISUALIZAR': ('QUADROS_FIXACAO', 'VISUALIZAR'),
                'QUADROS_FIXACAO_CRIAR': ('QUADROS_FIXACAO', 'CRIAR'),
                'QUADROS_FIXACAO_EDITAR': ('QUADROS_FIXACAO', 'EDITAR'),
                'QUADROS_FIXACAO_EXCLUIR': ('QUADROS_FIXACAO', 'EXCLUIR'),
                
                # Comiss√µes
                'COMISSOES_VISUALIZAR': ('COMISSOES', 'VISUALIZAR'),
                'COMISSOES_CRIAR': ('COMISSOES', 'CRIAR'),
                'COMISSOES_EDITAR': ('COMISSOES', 'EDITAR'),
                'COMISSOES_EXCLUIR': ('COMISSOES', 'EXCLUIR'),
                
                # Boletins Especiais
                'BOLETINS_ESPECIAIS_VISUALIZAR': ('BOLETINS_ESPECIAIS', 'VISUALIZAR'),
                'BOLETINS_ESPECIAIS_CRIAR': ('BOLETINS_ESPECIAIS', 'CRIAR'),
                'BOLETINS_ESPECIAIS_EDITAR': ('BOLETINS_ESPECIAIS', 'EDITAR'),
                'BOLETINS_ESPECIAIS_EXCLUIR': ('BOLETINS_ESPECIAIS', 'EXCLUIR'),
                'BOLETINS_ESPECIAIS_PUBLICAR': ('BOLETINS_ESPECIAIS', 'PUBLICAR'),
                
                # Submenus de Planejadas
                'SUBMENU_PLANEJADAS': ('SUBMENU_PLANEJADAS', 'VISUALIZAR'),
                'SUBMENU_OPERADOR_PLANEJADAS': ('SUBMENU_OPERADOR_PLANEJADAS', 'VISUALIZAR'),
                'SUBMENU_FISCAL_PLANEJADAS': ('SUBMENU_FISCAL_PLANEJADAS', 'VISUALIZAR'),
            }
            
            # Processar permiss√µes espec√≠ficas com hierarquia
            # Hierarquia: VISUALIZAR < CRIAR < EDITAR < EXCLUIR
            hierarquia_acessos = ['VISUALIZAR', 'CRIAR', 'EDITAR', 'EXCLUIR']
            
            # Agrupar permiss√µes por m√≥dulo para aplicar hierarquia
            permissoes_por_modulo = {}
            for campo, (modulo, acesso) in permissoes_especificas.items():
                if campo in request.POST:
                    if modulo not in permissoes_por_modulo:
                        permissoes_por_modulo[modulo] = []
                    permissoes_por_modulo[modulo].append((campo, acesso))
            
            # Processar cada m√≥dulo aplicando hierarquia
            for modulo, permissoes_modulo in permissoes_por_modulo.items():
                # Encontrar o n√≠vel mais alto de acesso marcado
                niveis_marcados = []
                for campo, acesso in permissoes_modulo:
                    if acesso in hierarquia_acessos:
                        niveis_marcados.append(hierarquia_acessos.index(acesso))
                
                if niveis_marcados:
                    # Pegar o n√≠vel mais alto
                    nivel_maximo = max(niveis_marcados)
                    
                    # Criar/ativar todas as permiss√µes at√© o n√≠vel m√°ximo
                    for i in range(nivel_maximo + 1):
                        acesso_hierarquico = hierarquia_acessos[i]
                        
                        # Encontrar o campo correspondente
                        campo_correspondente = None
                        for campo, acesso in permissoes_especificas.items():
                            if permissoes_especificas[campo][0] == modulo and permissoes_especificas[campo][1] == acesso_hierarquico:
                                campo_correspondente = campo
                                break
                        
                        if campo_correspondente and campo_correspondente not in campos_salvos_com_sucesso:
                            try:
                                permissao, created = PermissaoFuncao.objects.get_or_create(
                                    funcao_militar=funcao,
                                    modulo=modulo,
                                    acesso=acesso_hierarquico,
                                    defaults={'ativo': True}
                                )
                                if not created:
                                    permissao.ativo = True
                                    permissao.save()
                                permissoes_criadas += 1
                                campos_salvos_com_sucesso.add(campo_correspondente)
                                print(f"DEBUG: Permiss√£o hier√°rquica {'criada' if created else 'reativada'} - {campo_correspondente} -> {modulo}: {acesso_hierarquico}")
                            except Exception as e:
                                print(f"DEBUG: Erro ao salvar permiss√£o hier√°rquica {campo_correspondente}: {str(e)}")
                
                # Processar permiss√µes que n√£o est√£o na hierarquia (ex: PUBLICAR, APROVAR, etc)
                for campo, acesso in permissoes_modulo:
                    if acesso not in hierarquia_acessos and campo not in campos_salvos_com_sucesso:
                        try:
                            permissao, created = PermissaoFuncao.objects.get_or_create(
                                funcao_militar=funcao,
                                modulo=modulo,
                                acesso=acesso,
                                defaults={'ativo': True}
                            )
                            if not created:
                                permissao.ativo = True
                                permissao.save()
                            permissoes_criadas += 1
                            campos_salvos_com_sucesso.add(campo)
                            print(f"DEBUG: Permiss√£o espec√≠fica {'criada' if created else 'reativada'} - {campo} -> {modulo}: {acesso}")
                        except Exception as e:
                            print(f"DEBUG: Erro ao salvar permiss√£o espec√≠fica {campo}: {str(e)}")
            
            # Debug: verificar se campos de afastamentos foram enviados
            afastamentos_campos = ['MENU_AFASTAMENTOS', 'AFASTAMENTOS_VISUALIZAR', 'AFASTAMENTOS_CRIAR', 'AFASTAMENTOS_EDITAR', 'AFASTAMENTOS_EXCLUIR']
            print(f"DEBUG: Campos de afastamentos no POST:")
            for campo_afast in afastamentos_campos:
                if campo_afast in request.POST:
                    print(f"  - {campo_afast}: presente")
                else:
                    print(f"  - {campo_afast}: ausente")
            
            # Processar permiss√µes granulares de bot√µes
            permissoes_botoes = {
                'BOTAO_LOTACAO_NOVA': ('BOTAO_LOTACAO_NOVA', 'TOTAL'),
                'BOTAO_LOTACAO_EDITAR': ('BOTAO_LOTACAO_EDITAR', 'TOTAL'),
                'BOTAO_LOTACAO_EXCLUIR': ('BOTAO_LOTACAO_EXCLUIR', 'TOTAL'),
                'BOTAO_LOTACAO_ESTATISTICAS': ('BOTAO_LOTACAO_ESTATISTICAS', 'TOTAL'),
                'BOTAO_PUBLICACAO_NOVA': ('BOTAO_PUBLICACAO_NOVA', 'TOTAL'),
                'BOTAO_PUBLICACAO_EDITAR': ('BOTAO_PUBLICACAO_EDITAR', 'TOTAL'),
                'BOTAO_PUBLICACAO_PUBLICAR': ('BOTAO_PUBLICACAO_PUBLICAR', 'TOTAL'),
                'BOTAO_PUBLICACAO_ASSINAR': ('BOTAO_PUBLICACAO_ASSINAR', 'TOTAL'),
                'BOTAO_AFASTAMENTO_NOVO': ('BOTAO_AFASTAMENTO_NOVO', 'TOTAL'),
                'BOTAO_AFASTAMENTO_EDITAR': ('BOTAO_AFASTAMENTO_EDITAR', 'TOTAL'),
                'BOTAO_AFASTAMENTO_EXCLUIR': ('BOTAO_AFASTAMENTO_EXCLUIR', 'TOTAL'),
                'BOTAO_AFASTAMENTO_VISUALIZAR': ('BOTAO_AFASTAMENTO_VISUALIZAR', 'TOTAL'),
                'BOTAO_PLANO_LICENCA_ESPECIAL_VISUALIZAR': ('BOTAO_PLANO_LICENCA_ESPECIAL_VISUALIZAR', 'TOTAL'),
            }
            
            for campo, (modulo, acesso) in permissoes_botoes.items():
                if campo in request.POST and campo not in campos_salvos_com_sucesso:
                    try:
                        permissao, created = PermissaoFuncao.objects.get_or_create(
                            funcao_militar=funcao,
                            modulo=modulo,
                            acesso=acesso,
                            defaults={'ativo': True}
                        )
                        if not created:
                            permissao.ativo = True
                            permissao.save()
                        permissoes_criadas += 1
                        campos_salvos_com_sucesso.add(campo)
                        print(f"DEBUG: Permiss√£o de bot√£o {'criada' if created else 'reativada'} - {campo} -> {modulo}: {acesso}")
                    except Exception as e:
                        print(f"DEBUG: Erro ao salvar permiss√£o de bot√£o {campo}: {str(e)}")
            
            # Processar TODOS os campos restantes do POST que n√£o foram processados
            # Isso garante que nenhum checkbox marcado seja perdido
            campos_processados = set()
            
            # Usar o conjunto de campos j√° salvos com sucesso como base
            campos_processados.update(campos_salvos_com_sucesso)
            
            # Processar todos os outros campos do POST que s√£o checkboxes
            todos_campos_post = set(request.POST.keys())
            campos_ignorados = {'csrfmiddlewaretoken', 'submit', 'action'}
            campos_nao_processados = todos_campos_post - campos_processados - campos_ignorados
            
            print(f"DEBUG: Total de campos no POST: {len(todos_campos_post)}")
            print(f"DEBUG: Campos processados: {len(campos_processados)}")
            print(f"DEBUG: Campos n√£o processados (ser√£o processados agora): {len(campos_nao_processados)}")
            
            # Processar campos MENU_ e SUBMENU_ que vieram diretamente do template (sem show_)
            for campo in campos_nao_processados:
                # Processar campos MENU_* e SUBMENU_* diretamente
                if (campo.startswith('MENU_') or campo.startswith('SUBMENU_')) and campo not in campos_salvos_com_sucesso:
                    # Se for MENU_XXX ou SUBMENU_XXX sem sufixo de acesso, assumir VISUALIZAR
                    modulo = campo
                    acesso = 'VISUALIZAR'
                    
                    # Verificar se est√° em modulos_permissoes para obter acesso correto
                    if modulo in modulos_permissoes:
                        acesso = modulos_permissoes[modulo]
                    
                    # Criar ou reativar permiss√£o
                    try:
                        permissao, created = PermissaoFuncao.objects.get_or_create(
                            funcao_militar=funcao,
                            modulo=modulo,
                            acesso=acesso,
                            defaults={'ativo': True}
                        )
                        if not created:
                            permissao.ativo = True
                            permissao.save()
                        permissoes_criadas += 1
                        campos_salvos_com_sucesso.add(campo)
                        campos_processados.add(campo)
                        print(f"DEBUG: Permiss√£o de menu/submenu {'criada' if created else 'reativada'} - {campo} -> {modulo}: {acesso}")
                    except Exception as e:
                        print(f"DEBUG: Erro ao salvar permiss√£o {campo}: {str(e)}")
            
            # Atualizar lista de campos n√£o processados ap√≥s processar MENU_ e SUBMENU_
            campos_nao_processados = todos_campos_post - campos_processados - campos_ignorados
            
            # Processar demais campos gen√©ricos (ex: BOTAO_*, CAMPOS_MODULO_ACESSO, etc)
            for campo in campos_nao_processados:
                # Pular se j√° foi salvo
                if campo in campos_salvos_com_sucesso:
                    continue
                    
                # Primeiro verificar se o campo est√° no dicion√°rio de permiss√µes espec√≠ficas
                if campo in permissoes_especificas:
                    modulo, acesso = permissoes_especificas[campo]
                    # Criar ou reativar permiss√£o
                    try:
                        permissao, created = PermissaoFuncao.objects.get_or_create(
                            funcao_militar=funcao,
                            modulo=modulo,
                            acesso=acesso,
                            defaults={'ativo': True}
                        )
                        if not created:
                            permissao.ativo = True
                            permissao.save()
                        permissoes_criadas += 1
                        campos_salvos_com_sucesso.add(campo)
                        print(f"DEBUG: Permiss√£o espec√≠fica {'criada' if created else 'reativada'} - {campo} -> {modulo}: {acesso}")
                    except Exception as e:
                        print(f"DEBUG: Erro ao processar campo {campo}: {str(e)}")
                    continue
                
                # Tentar processar como permiss√£o gen√©rica
                # Se o campo parece ser um m√≥dulo (ex: BOTAO_XXX, MODULO_ACESSO, etc)
                partes = campo.split('_')
                if len(partes) >= 2:
                    # Verificar tipos de acesso compostos primeiro (do mais espec√≠fico para o menos espec√≠fico)
                    acesso_tipos_compostos = [
                        'ASSINAR_OPERADOR', 'ASSINAR_FISCAL', 'ADICIONAR_MILITAR', 'REMOVER_MILITAR',
                        'OPERACOES_PLANEJADAS', 'CONFIGURAR_HORAS', 'ALTERAR_SENHA', 'GERENCIAR_FUNCOES',
                        'GERAR_PDF', 'FICHA_CONCEITO'
                    ]
                    
                    acesso = None
                    modulo = None
                    
                    # Verificar tipos de acesso compostos
                    for tipo_composto in acesso_tipos_compostos:
                        if campo.endswith('_' + tipo_composto):
                            modulo = campo[:-len('_' + tipo_composto)]
                            acesso = tipo_composto
                            break
                    
                    # Se n√£o encontrou tipo composto, verificar tipos simples
                    if not acesso:
                        acesso_tipo = partes[-1].upper()
                        tipos_simples = ['VISUALIZAR', 'CRIAR', 'EDITAR', 'EXCLUIR', 'TOTAL', 'ASSINAR', 'PUBLICAR', 
                                         'APROVAR', 'REVISAR', 'EXPORTAR', 'TRANSFERIR', 'PROMOVER', 'INATIVAR', 
                                         'REATIVAR', 'HOMOLOGAR', 'ELABORAR', 'GERAR', 'IMPRIMIR', 'CONCEDER']
                        
                        if acesso_tipo in tipos_simples:
                            modulo = '_'.join(partes[:-1])
                            acesso = acesso_tipo
                        elif campo.startswith('BOTAO_'):
                            # Bot√µes sem tipo de acesso expl√≠cito recebem TOTAL
                            modulo = campo
                            acesso = 'TOTAL'
                        else:
                            # Se n√£o tem tipo de acesso expl√≠cito, assumir VISUALIZAR
                            modulo = campo
                            acesso = 'VISUALIZAR'
                    
                    # Criar ou reativar permiss√£o
                    if modulo and acesso:
                        try:
                            permissao, created = PermissaoFuncao.objects.get_or_create(
                                funcao_militar=funcao,
                                modulo=modulo,
                                acesso=acesso,
                                defaults={'ativo': True}
                            )
                            if not created:
                                permissao.ativo = True
                                permissao.save()
                            permissoes_criadas += 1
                            campos_salvos_com_sucesso.add(campo)
                            campos_processados.add(campo)
                            print(f"DEBUG: Permiss√£o gen√©rica {'criada' if created else 'reativada'} - {campo} -> {modulo}: {acesso}")
                        except Exception as e:
                            print(f"DEBUG: Erro ao processar campo {campo}: {str(e)}")
                    else:
                        print(f"DEBUG: N√£o foi poss√≠vel processar campo {campo} - m√≥dulo ou acesso n√£o definido")
            
            print(f"DEBUG: Total de permiss√µes criadas/reativadas: {permissoes_criadas}")
            
            # Verificar se as permiss√µes foram salvas corretamente
            permissoes_salvas = PermissaoFuncao.objects.filter(funcao_militar=funcao, ativo=True)
            print(f"DEBUG: Permiss√µes salvas no banco: {permissoes_salvas.count()}")
            
            # Verificar especificamente permiss√µes de reservados
            reservados_salvas = permissoes_salvas.filter(
                Q(modulo__contains='RESERVADOS') | Q(modulo__contains='NOTAS_RESERVADAS')
            )
            print(f"DEBUG: Permiss√µes de reservados salvas: {reservados_salvas.count()}")
            
            # Verificar se √© uma requisi√ß√£o AJAX
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message': f'Permiss√µes atualizadas com sucesso! {permissoes_criadas} permiss√µes configuradas.'
                })
            else:
                # Adicionar mensagem de sucesso
                messages.success(
                    request, 
                    f'Permiss√µes atualizadas com sucesso! {permissoes_criadas} permiss√µes configuradas.'
                )
                # Redirecionar para evitar reenvio do formul√°rio
                return redirect('militares:gerenciar_permissoes_unificado', funcao_id=funcao.id)
            
        except Exception as e:
            # Verificar se √© uma requisi√ß√£o AJAX
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': False,
                    'message': f'Erro ao salvar permiss√µes: {str(e)}'
                })
            else:
                messages.error(
                    request, 
                    f'Erro ao salvar permiss√µes: {str(e)}'
                )
            
    # Preparar dados para o template
    try:
        # Obter configura√ß√£o de menu atual
        menu_config, created = FuncaoMenuConfig.objects.get_or_create(
            funcao_militar=funcao,
            defaults={'ativo': True}
        )
    
        # Obter permiss√µes atuais
        permissoes_atuais = PermissaoFuncao.objects.filter(
            funcao_militar=funcao,
            ativo=True
        ).values_list('modulo', 'acesso')
        
        # Mapeamento reverso: m√≥dulos para campos do template
        modulo_to_template = {
            'MENU_DASHBOARD': 'show_dashboard',
            'MENU_EFETIVO': 'show_efetivo',
            'MENU_EFETIVO_ELOGIOS': 'show_efetivo_elogios',
            'MENU_EFETIVO_PUNICOES': 'show_efetivo_punicoes',
            'MENU_ELOGIOS': 'show_elogios',
            'SUBMENU_ELOGIOS_OFICIAIS': 'show_elogios_oficiais',
            'SUBMENU_ELOGIOS_PRACAS': 'show_elogios_pracas',
            'MENU_PUNICOES': 'show_punicoes',
            'SUBMENU_PUNICOES_OFICIAIS': 'show_punicoes_oficiais',
            'SUBMENU_PUNICOES_PRACAS': 'show_punicoes_pracas',
            'MENU_SECAO_PROMOCOES': 'show_secao_promocoes',
            'MENU_MEDALHAS': 'show_medalhas',
            'MENU_PUBLICACOES': 'show_publicacoes',
            'MENU_ESCALAS': 'show_escalas',
            'MENU_CONFIGURACOES': 'show_configuracoes',
            'MENU_RELATORIOS': 'show_relatorios',
            'MENU_PESSOAL': 'show_pessoal',
            'MENU_PLANEJADAS': 'show_planejadas',
            'MENU_AFASTAMENTOS': 'show_afastamentos',
            
            # Submenus - Pessoal
            'SUBMENU_MINHAS_INFORMACOES': 'show_minhas_informacoes',
            'SUBMENU_MINHA_FICHA_CADASTRO': 'show_minha_ficha_cadastro',
            'SUBMENU_MINHA_FICHA_CONCEITO_OFICIAL': 'show_minha_ficha_conceito_oficial',
            'SUBMENU_MINHA_FICHA_CONCEITO_PRACA': 'show_minha_ficha_conceito_praca',
            'SUBMENU_CRIAR_FICHA_CONCEITO_OFICIAL': 'show_criar_ficha_conceito_oficial',
            'SUBMENU_CRIAR_FICHA_CONCEITO_PRACA': 'show_criar_ficha_conceito_praca',
            
                # Submenus - Efetivo
                'SUBMENU_ATIVOS': 'show_ativos',
                'SUBMENU_INATIVOS': 'show_inativos',
                'SUBMENU_LOTACOES': 'show_lotacoes',
                'SUBMENU_AVERBACOES': 'show_averbacoes',
            
            # Submenus - Se√ß√£o de Promo√ß√µes
            'SUBMENU_FICHAS_OFICIAIS': 'show_fichas_oficiais',
            'SUBMENU_FICHAS_PRACAS': 'show_fichas_pracas',
            'SUBMENU_QUADROS_ACESSO': 'show_quadros_acesso',
            'SUBMENU_QUADROS_FIXACAO': 'show_quadros_fixacao',
            'SUBMENU_ALMANAQUES': 'show_almanaques',
            'SUBMENU_PROMOCOES': 'show_promocoes',
            'SUBMENU_CALENDARIOS': 'show_calendarios',
            'SUBMENU_COMISSOES': 'show_comissoes',
            'SUBMENU_MEUS_VOTOS': 'show_meus_votos',
            'SUBMENU_INTERSTICIOS': 'show_intersticios',
            'SUBMENU_GERENCIAR_INTERSTICIOS': 'show_gerenciar_intersticios',
            'SUBMENU_GERENCIAR_PREVISAO': 'show_gerenciar_previsao',
            
            # Submenus - Medalhas
            'SUBMENU_MEDALHAS_CONCESSOES': 'show_medalhas_concessoes',
            'SUBMENU_MEDALHAS_PROPOSTAS': 'show_medalhas_propostas',
            'SUBMENU_ELEGIVEIS': 'show_elegiveis',
            'SUBMENU_PROPOSTAS': 'show_propostas',
            
            # Submenus - Publica√ß√µes
            'SUBMENU_NOTAS': 'show_notas',
            'SUBMENU_BOLETINS_OSTENSIVOS': 'show_boletins_ostensivos',
            'SUBMENU_BOLETINS_RESERVADOS': 'show_boletins_reservados',
            'SUBMENU_BOLETINS_ESPECIAIS': 'show_boletins_especiais',
            
            # Submenus - Escalas de Servi√ßo
            'SUBMENU_ESCALAS_DASHBOARD': 'show_escalas_dashboard',
            'SUBMENU_ESCALAS_LISTA': 'show_escalas_lista',
            'SUBMENU_ESCALAS_CONFIGURACAO': 'show_escalas_configuracao',
            'SUBMENU_ESCALAS_BANCO_HORAS': 'show_escalas_banco_horas',
            'SUBMENU_ESCALAS_OPERACOES': 'show_escalas_operacoes',
            
            # Submenus - Configura√ß√µes/Sistema
            'SUBMENU_USUARIOS': 'show_usuarios',
            'SUBMENU_PERMISSOES': 'show_permissoes',
            'SUBMENU_ORGAOS': 'show_orgaos',
            'SUBMENU_ORGANOGRAMA': 'show_organograma',
            'SUBMENU_LOGS': 'show_logs',
            'SUBMENU_TITULOS_PUBLICACAO': 'show_titulos_publicacao',
            'SUBMENU_ADMINISTRACAO': 'show_administracao',
            'SUBMENU_GRANDES_COMANDOS': 'show_grandes_comandos',
            'SUBMENU_UNIDADES': 'show_unidades',
            'SUBMENU_SUB_UNIDADES': 'show_sub_unidades',
            
            # Submenus - Relat√≥rios
            'SUBMENU_RELATORIOS_MILITARES': 'show_relatorios_militares',
            'SUBMENU_RELATORIOS_PROMOCOES': 'show_relatorios_promocoes',
            'SUBMENU_RELATORIOS_MEDALHAS': 'show_relatorios_medalhas',
            'SUBMENU_RELATORIOS_PUBLICACOES': 'show_relatorios_publicacoes',
            'SUBMENU_RELATORIOS_GERAIS': 'show_relatorios_gerais',
            
                # Submenus - Planejadas
                'MENU_PLANEJADAS': 'show_planejadas',
                'SUBMENU_OPERADOR_PLANEJADAS': 'show_operador_planejadas',
                'SUBMENU_FISCAL_PLANEJADAS': 'show_fiscal_planejadas',
                'SUBMENU_LIQUIDACAO': 'show_liquidacao',
                
                # Menus e Submenus - Frota
                'MENU_FROTA': 'show_viaturas',
                'SUBMENU_VIATURAS': 'show_viaturas',
                'SUBMENU_CONTROLE_COMBUSTIVEL': 'show_controle_combustivel',
                
                # Menus e Submenus - Equipamentos Operacionais
                'MENU_EQUIPAMENTOS_OPERACIONAIS': 'show_equipamentos_operacionais',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS': 'show_equipamentos_operacionais',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_COMBUSTIVEL': 'show_equipamentos_operacionais_combustivel',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_MANUTENCOES': 'show_equipamentos_operacionais_manutencoes',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TROCAS_OLEO': 'show_equipamentos_operacionais_trocas_oleo',
                'SUBMENU_EQUIPAMENTOS_OPERACIONAIS_TEMPOS_USO': 'show_equipamentos_operacionais_tempos_uso',
                'SUBMENU_MANUTENCOES': 'show_manutencoes',
                'SUBMENU_TROCAS_OLEO': 'show_trocas_oleo',
                'SUBMENU_LICENCIAMENTOS': 'show_licenciamentos',
                'SUBMENU_RODAGENS': 'show_rodagens',
                'SUBMENU_PAINEL_GUARDA': 'show_painel_guarda',
                
                # Menus e Submenus - Material B√©lico
                'MENU_MATERIAL_BELICO': 'show_material_belico',
                'SUBMENU_ARMAS_INSTITUICAO': 'show_armas_instituicao',
                'SUBMENU_ARMAS_PARTICULARES': 'show_armas_particulares',
                'SUBMENU_CAUTELAS_ARMAS': 'show_cautelas_armas',
                'SUBMENU_CONTROLE_MOVIMENTACOES': 'show_controle_movimentacoes',
                'SUBMENU_CONTROLE_MUNICAO': 'show_controle_municao',
                'SUBMENU_CAUTELAS_MUNICOES': 'show_cautelas_municoes',
                
                # Menus e Submenus - Bens M√≥veis
                'MENU_BENS_MOVEIS': 'show_bens_moveis',
                
                # Menus e Submenus - Almoxarifado
                'MENU_ALMOXARIFADO': 'show_almoxarifado',
                'MENU_PROCESSOS': 'show_processos',
                
                # Menus e Submenus - Ensino
                'MENU_ENSINO': 'show_ensino',
                'SUBMENU_ENSINO_DASHBOARD': 'show_ensino_dashboard',
                'SUBMENU_ENSINO_CURSOS': 'show_ensino_cursos',
                'SUBMENU_ENSINO_TURMAS': 'show_ensino_turmas',
                'SUBMENU_ENSINO_DISCIPLINAS': 'show_ensino_disciplinas',
                'SUBMENU_ENSINO_ALUNOS': 'show_ensino_alunos',
                'SUBMENU_ENSINO_INSTRUTORES': 'show_ensino_instrutores',
                'SUBMENU_ENSINO_MONITORES': 'show_ensino_monitores',
                'SUBMENU_ENSINO_AULAS': 'show_ensino_aulas',
                'SUBMENU_ENSINO_FREQUENCIAS': 'show_ensino_frequencias',
                'SUBMENU_ENSINO_AVALIACOES': 'show_ensino_avaliacoes',
                'SUBMENU_ENSINO_CERTIFICADOS': 'show_ensino_certificados',
                'SUBMENU_ENSINO_QUADROS_TRABALHO_SEMANAL': 'show_ensino_quadros_trabalho_semanal',
        }
        
        # Converter para dicion√°rio para facilitar verifica√ß√£o no template
        permissoes_dict = {}
        for modulo, acesso in permissoes_atuais:
            # Adicionar sempre no formato {MODULO}_{ACESSO} para verifica√ß√£o direta no template
            # Ex: MENU_PESSOAL:VISUALIZAR -> 'MENU_PESSOAL_VISUALIZAR'
            chave_modulo_acesso = f"{modulo}_{acesso}"
            permissoes_dict[chave_modulo_acesso] = True
            
            # Adicionar tamb√©m apenas o m√≥dulo (sem sufixo de acesso) para casos onde o template verifica apenas o nome
            # Ex: 'MENU_PESSOAL'
            permissoes_dict[modulo] = True
            
            # Mapear m√≥dulo para campo do template (show_*)
            campo_template = modulo_to_template.get(modulo)
            if campo_template:
                permissoes_dict[campo_template] = True
                # Tamb√©m adicionar no formato show_*_ACESSO caso o template verifique dessa forma
                permissoes_dict[f"{campo_template}_{acesso}"] = True
                print(f"DEBUG: Mapeando permiss√£o - {modulo}:{acesso} -> {campo_template}, {chave_modulo_acesso}, {modulo}")
            else:
                print(f"DEBUG: M√≥dulo n√£o mapeado - {modulo}:{acesso}, adicionando {chave_modulo_acesso} e {modulo}")
        
        # IMPORTANTE: Adicionar tamb√©m as chaves que correspondem aos nomes dos campos no template
        # Quando salvamos MENU_PESSOAL com acesso VISUALIZAR, o template verifica 'MENU_PESSOAL_VISUALIZAR'
        # Mas tamb√©m pode verificar apenas 'MENU_PESSOAL' se o campo tem esse nome
        for modulo, acesso in permissoes_atuais:
            # Garantir que existe a chave {MODULO}_{ACESSO} para qualquer combina√ß√£o
            chave_full = f"{modulo}_{acesso}"
            if chave_full not in permissoes_dict:
                permissoes_dict[chave_full] = True
        
        # Debug: Verificar se as permiss√µes est√£o sendo carregadas corretamente
        print(f"DEBUG: Permiss√µes carregadas para exibi√ß√£o: {len(permissoes_dict)}")
        print(f"DEBUG: Verificando permiss√µes de reservados:")
        print(f"  - SUBMENU_NOTAS_RESERVADAS: {'SUBMENU_NOTAS_RESERVADAS' in permissoes_dict}")
        print(f"  - SUBMENU_BOLETINS_RESERVADOS: {'SUBMENU_BOLETINS_RESERVADOS' in permissoes_dict}")
        print(f"  - NOTAS_RESERVADAS_VISUALIZAR: {'NOTAS_RESERVADAS_VISUALIZAR' in permissoes_dict}")
        print(f"  - BOLETINS_RESERVADOS_VISUALIZAR: {'BOLETINS_RESERVADOS_VISUALIZAR' in permissoes_dict}")
        
        # Obter perfis de acesso dispon√≠veis
        perfis_disponiveis = PerfilAcesso.objects.filter(ativo=True).order_by('nome')
        
        # Estat√≠sticas
        total_permissoes = permissoes_atuais.count()
        usuarios_com_funcao = UsuarioFuncaoMilitar.objects.filter(
            funcao_militar=funcao,
            ativo=True
        ).count()
        
        print(f"DEBUG: Total de permiss√µes: {total_permissoes}")
        print(f"DEBUG: Usu√°rios com fun√ß√£o: {usuarios_com_funcao}")
        
        # Verificar especificamente permiss√µes de reservados para estat√≠sticas
        reservados_count = permissoes_atuais.filter(
            Q(modulo__contains='RESERVADOS') | Q(modulo__contains='NOTAS_RESERVADAS')
        ).count()
        print(f"DEBUG: Permiss√µes de reservados para estat√≠sticas: {reservados_count}")
        
        # Agrupar permiss√µes por m√≥dulo para exibi√ß√£o organizada
        permissoes_por_modulo = {}
        for modulo, acesso in permissoes_atuais:
            if modulo not in permissoes_por_modulo:
                permissoes_por_modulo[modulo] = []
            permissoes_por_modulo[modulo].append(acesso)
        
        # Log espec√≠fico para permiss√µes de reservados agrupadas
        print(f"DEBUG: Permiss√µes de reservados agrupadas:")
        for modulo, acessos in permissoes_por_modulo.items():
            if 'RESERVADOS' in modulo or 'NOTAS_RESERVADAS' in modulo:
                print(f"  - {modulo}: {acessos}")
        
        context = {
            'funcao': funcao,
            'menu_config': menu_config,
            'permissoes_dict': permissoes_dict,
            'permissoes_por_modulo': permissoes_por_modulo,
            'perfis_disponiveis': perfis_disponiveis,
            'total_permissoes': total_permissoes,
            'usuarios_com_funcao': usuarios_com_funcao,
            'titulo_pagina': f'Gerenciar Permiss√µes - {funcao.nome}',
        }
        
        print(f"DEBUG: Contexto enviado para o template:")
        print(f"  - Total de permiss√µes: {total_permissoes}")
        print(f"  - Permiss√µes de reservados: {reservados_count}")
        print(f"  - Permiss√µes no dict: {len(permissoes_dict)}")
        
        return render(request, 'militares/funcoes/gerenciar_permissoes_unificado.html', context)
        
    except Exception as e:
        messages.error(request, f'Erro ao carregar dados: {str(e)}')
        return redirect('militares:funcoes_militares_list')


@login_required
@administracao_required
def debug_permissoes(request, funcao_id):
    """View de debug para permiss√µes"""
    from .models import FuncaoMilitar, FuncaoMenuConfig, PermissaoFuncao
    from django.contrib import messages
    
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    if request.method == 'POST':
        print(f"üîç DEBUG DEBUG: Requisi√ß√£o POST recebida para fun√ß√£o {funcao.nome}")
        print(f"üîç DEBUG DEBUG: Dados POST: {dict(request.POST)}")
        print(f"üîç DEBUG DEBUG: Headers: {dict(request.headers)}")
        
        try:
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            # Testar campos simples
            campos_teste = ['teste_campo1', 'teste_campo2', 'teste_campo3']
            campos_reais = ['show_dashboard', 'show_efetivo', 'show_ativos']
            
            print(f"üîç DEBUG DEBUG: Campos de teste encontrados: {[c for c in campos_teste if c in request.POST]}")
            print(f"üîç DEBUG DEBUG: Campos reais encontrados: {[c for c in campos_reais if c in request.POST]}")
            
            # Salvar campos reais
            for campo in campos_reais:
                if campo in request.POST:
                    setattr(menu_config, campo, True)
                    print(f"‚úÖ DEBUG: {campo} = True")
                else:
                    setattr(menu_config, campo, False)
                    print(f"‚ùå DEBUG: {campo} = False")
            
            menu_config.save()
            print(f"‚úÖ DEBUG: Menu config salvo com sucesso!")
            
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'success': True,
                    'message': 'Debug salvo com sucesso!',
                    'campos_teste': [c for c in campos_teste if c in request.POST],
                    'campos_reais': [c for c in campos_reais if c in request.POST]
                })
            else:
                messages.success(request, 'Debug salvo com sucesso!')
                return redirect('militares:debug_permissoes', funcao_id=funcao.id)
                
        except Exception as e:
            print(f"‚ùå ERRO DEBUG: {str(e)}")
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({'success': False, 'error': str(e)})
            else:
                messages.error(request, f'Erro no debug: {str(e)}')
    
    try:
        menu_config, created = FuncaoMenuConfig.objects.get_or_create(
            funcao_militar=funcao,
            defaults={'ativo': True}
        )
        
        permissoes_dict = {}
        if menu_config.show_dashboard:
            permissoes_dict['show_dashboard'] = True
        if menu_config.show_efetivo:
            permissoes_dict['show_efetivo'] = True
        if menu_config.show_ativos:
            permissoes_dict['show_ativos'] = True
        
        context = {
            'funcao': funcao,
            'permissoes_dict': permissoes_dict,
            'total_permissoes': len(permissoes_dict),
            'permissoes_ativas': len([p for p in permissoes_dict.values() if p]),
        }
        
        return render(request, 'militares/funcoes/debug_permissoes.html', context)
        
    except Exception as e:
        messages.error(request, f'Erro ao carregar dados: {str(e)}')
        return redirect('militares:funcoes_militares_list')

@login_required
@administracao_required
def teste_permissoes_simples(request, funcao_id):
    """View de teste para permiss√µes granulares"""
    from .models import FuncaoMilitar, FuncaoMenuConfig, PermissaoFuncao
    from django.contrib import messages
    
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    if request.method == 'POST':
        print(f"üîç DEBUG TESTE: Requisi√ß√£o POST recebida para fun√ß√£o {funcao.nome}")
        print(f"üîç DEBUG TESTE: Dados POST: {dict(request.POST)}")
        
        try:
            # Processar configura√ß√µes de menu
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            # Atualizar configura√ß√µes de menu
            menu_fields = [
                'show_dashboard', 'show_efetivo', 'show_ativos', 'show_inativos', 'show_lotacoes'
            ]
            
            campos_marcados = []
            for field in menu_fields:
                if field in request.POST:
                    setattr(menu_config, field, True)
                    campos_marcados.append(field)
                else:
                    setattr(menu_config, field, False)
            
            menu_config.save()
            
            print(f"‚úÖ TESTE: {len(campos_marcados)} campos salvos: {campos_marcados}")
            
            # Limpar permiss√µes existentes
            PermissaoFuncao.objects.filter(funcao_militar=funcao).delete()
            
            # Criar permiss√µes de teste
            permissoes_teste = [
                ('MENU_DASHBOARD', 'VISUALIZAR'),
                ('MENU_EFETIVO', 'VISUALIZAR'),
                ('SUBMENU_ATIVOS', 'VISUALIZAR'),
                ('SUBMENU_INATIVOS', 'VISUALIZAR'),
                ('SUBMENU_LOTACOES', 'VISUALIZAR'),
            ]
            
            for modulo, acesso in permissoes_teste:
                if modulo.replace('MENU_', 'show_').replace('SUBMENU_', 'show_').lower() in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso=acesso,
                        ativo=True
                    )
            
            messages.success(request, f'Teste de permiss√µes salvo com sucesso! {len(campos_marcados)} campos configurados.')
            return redirect('militares:teste_permissoes_simples', funcao_id=funcao.id)
            
        except Exception as e:
            messages.error(request, f'Erro no teste: {str(e)}')
            print(f"‚ùå ERRO TESTE: {str(e)}")
    
    # Preparar dados para o template
    try:
        menu_config, created = FuncaoMenuConfig.objects.get_or_create(
            funcao_militar=funcao,
            defaults={'ativo': True}
        )
        
        # Obter permiss√µes atuais
        permissoes = PermissaoFuncao.objects.filter(funcao_militar=funcao, ativo=True)
        # Incluir tanto MODULO_ACESSO quanto apenas MODULO para facilitar checagens no template
        permissoes_dict = {}
        for p in permissoes:
            permissoes_dict[f"{p.modulo}_{p.acesso}"] = True
            permissoes_dict[p.modulo] = True
        
        # Adicionar permiss√µes de menu
        if menu_config.show_dashboard:
            permissoes_dict['show_dashboard'] = True
        if menu_config.show_efetivo:
            permissoes_dict['show_efetivo'] = True
        if menu_config.show_ativos:
            permissoes_dict['show_ativos'] = True
        if menu_config.show_inativos:
            permissoes_dict['show_inativos'] = True
        if menu_config.show_lotacoes:
            permissoes_dict['show_lotacoes'] = True
        
        context = {
            'funcao': funcao,
            'permissoes_dict': permissoes_dict,
            'total_permissoes': len(permissoes_dict),
            'permissoes_ativas': len([p for p in permissoes_dict.values() if p]),
        }
        
        return render(request, 'militares/funcoes/teste_permissoes_simples.html', context)
        
    except Exception as e:
        messages.error(request, f'Erro ao carregar dados: {str(e)}')
        return redirect('militares:funcoes_militares_list')

@login_required
@administracao_required
def configurar_permissoes_automaticas(request, funcao_id):
    """Configurar permiss√µes autom√°ticas baseadas no tipo de fun√ß√£o"""
    from .models import FuncaoMilitar, PermissaoFuncao, FuncaoMenuConfig
    from django.contrib import messages
    
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    if request.method == 'POST':
        try:
            # Limpar permiss√µes existentes
            PermissaoFuncao.objects.filter(funcao_militar=funcao).delete()
            
            # Aplicar permiss√µes baseadas no tipo de fun√ß√£o
            permissoes_aplicadas = 0
            
            # Configura√ß√µes baseadas no nome da fun√ß√£o
            nome_funcao = funcao.nome.upper()
            
            if 'COMANDANTE' in nome_funcao or 'COMANDO' in nome_funcao:
                # Permiss√µes para comandantes
                permissoes_comandante = [
                    ('MENU_DASHBOARD', 'VISUALIZAR'),
                    ('MENU_EFETIVO', 'VISUALIZAR'),
                    ('MENU_PUBLICACOES', 'VISUALIZAR'),
                    ('MENU_SECAO_PROMOCOES', 'VISUALIZAR'),
                    ('MENU_MEDALHAS', 'VISUALIZAR'),
                    ('MILITARES', 'VISUALIZAR'),
                    ('MILITARES', 'EDITAR'),
                    ('MILITARES', 'PROMOVER'),
                    ('NOTAS', 'VISUALIZAR'),
                    ('NOTAS', 'APROVAR'),
                    ('BOLETINS_OSTENSIVOS', 'VISUALIZAR'),
                    ('BOLETINS_OSTENSIVOS', 'APROVAR'),
                ]
                
                for modulo, acesso in permissoes_comandante:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso=acesso,
                        ativo=True
                    )
                    permissoes_aplicadas += 1
                    
            elif 'SARGENTEANTE' in nome_funcao or 'SARGENTE' in nome_funcao:
                # Permiss√µes para sargenteantes
                permissoes_sargenteante = [
                    ('MENU_DASHBOARD', 'VISUALIZAR'),
                    ('MENU_EFETIVO', 'VISUALIZAR'),
                    ('MENU_PUBLICACOES', 'VISUALIZAR'),
                    ('MILITARES', 'VISUALIZAR'),
                    ('MILITARES', 'EDITAR'),
                    ('NOTAS', 'VISUALIZAR'),
                    ('NOTAS', 'CRIAR'),
                    ('NOTAS', 'EDITAR'),
                ]
                
                for modulo, acesso in permissoes_sargenteante:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso=acesso,
                        ativo=True
                    )
                    permissoes_aplicadas += 1
                    
            elif 'ADMINISTRADOR' in nome_funcao or 'ADMIN' in nome_funcao:
                # Permiss√µes para administradores
                permissoes_admin = [
                    ('MENU_DASHBOARD', 'VISUALIZAR'),
                    ('MENU_EFETIVO', 'VISUALIZAR'),
                    ('MENU_PUBLICACOES', 'VISUALIZAR'),
                    ('MENU_SECAO_PROMOCOES', 'VISUALIZAR'),
                    ('MENU_MEDALHAS', 'VISUALIZAR'),
                    ('MENU_CONFIGURACOES', 'VISUALIZAR'),
                    ('MENU_RELATORIOS', 'VISUALIZAR'),
                    ('MILITARES', 'VISUALIZAR'),
                    ('MILITARES', 'CRIAR'),
                    ('MILITARES', 'EDITAR'),
                    ('MILITARES', 'EXCLUIR'),
                    ('USUARIOS', 'VISUALIZAR'),
                    ('USUARIOS', 'CRIAR'),
                    ('USUARIOS', 'EDITAR'),
                    ('USUARIOS', 'EXCLUIR'),
                ]
                
                for modulo, acesso in permissoes_admin:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso=acesso,
                        ativo=True
                    )
                    permissoes_aplicadas += 1
            
            # Atualizar configura√ß√£o de menu
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            # Configurar menus baseados nas permiss√µes aplicadas
            if 'COMANDANTE' in nome_funcao or 'COMANDO' in nome_funcao:
                menu_config.show_dashboard = True
                menu_config.show_efetivo = True
                menu_config.show_publicacoes = True
                menu_config.show_secao_promocoes = True
                menu_config.show_medalhas = True
                menu_config.show_configuracoes = False
            elif 'SARGENTEANTE' in nome_funcao or 'SARGENTE' in nome_funcao:
                menu_config.show_dashboard = True
                menu_config.show_efetivo = True
                menu_config.show_publicacoes = True
                menu_config.show_secao_promocoes = False
                menu_config.show_medalhas = False
                menu_config.show_configuracoes = False
            elif 'ADMINISTRADOR' in nome_funcao or 'ADMIN' in nome_funcao:
                menu_config.show_dashboard = True
                menu_config.show_efetivo = True
                menu_config.show_publicacoes = True
                menu_config.show_secao_promocoes = True
                menu_config.show_medalhas = True
                menu_config.show_configuracoes = True
                menu_config.show_administracao = True
                menu_config.show_logs = True
            
            menu_config.save()
            
            messages.success(
                request, 
                f'Permiss√µes autom√°ticas aplicadas com sucesso! {permissoes_aplicadas} permiss√µes configuradas.'
            )
            
        except Exception as e:
            messages.error(request, f'Erro ao aplicar permiss√µes autom√°ticas: {str(e)}')
    
    return redirect('militares:gerenciar_permissoes_unificado', funcao_id=funcao_id)


@login_required
def funcoes_militares_sincronizar(request):
    """Sincronizar fun√ß√µes militares com usu√°rios"""
    from .models import FuncaoMilitar, UsuarioFuncaoMilitar
    from django.contrib import messages
    
    try:
        # Obter todas as fun√ß√µes militares
        funcoes = FuncaoMilitar.objects.filter(ativo=True)
        total_sincronizado = 0
        
        for funcao in funcoes:
            # Verificar se j√° existe configura√ß√£o de menu
            from .models import FuncaoMenuConfig
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            if created:
                total_sincronizado += 1
        
        messages.success(
            request, 
            f'Sincroniza√ß√£o conclu√≠da! {total_sincronizado} fun√ß√µes sincronizadas.'
        )
        
    except Exception as e:
        messages.error(request, f'Erro durante a sincroniza√ß√£o: {str(e)}')
    
    return redirect('militares:funcoes_militares_list')


@login_required
def funcoes_militares_tempo_atual(request):
    """Gera relat√≥rio de tempo atual na fun√ß√£o"""
    from django.http import HttpResponse
    from datetime import datetime, date
    import io
    import xlsxwriter
    
    # Criar arquivo Excel em mem√≥ria
    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    worksheet = workbook.add_worksheet('Tempo Atual na Fun√ß√£o')
    
    # Cabe√ßalhos
    headers = ['Militar', 'Fun√ß√£o Atual', 'Data In√≠cio', 'Tempo Atual (dias)']
    for col, header in enumerate(headers):
        worksheet.write(0, col, header)
    
    # Obter dados
    from .models import UsuarioFuncaoMilitar
    funcoes_ativas = UsuarioFuncaoMilitar.objects.filter(
        ativo=True,
        funcao_militar__isnull=False
    ).select_related('usuario', 'funcao_militar')
    
    row = 1
    for funcao_usuario in funcoes_ativas:
        if funcao_usuario.data_inicio:
            tempo_atual = (date.today() - funcao_usuario.data_inicio).days
            worksheet.write(row, 0, funcao_usuario.usuario.get_full_name() or funcao_usuario.usuario.username)
            worksheet.write(row, 1, funcao_usuario.funcao_militar.nome)
            worksheet.write(row, 2, funcao_usuario.data_inicio.strftime('%d/%m/%Y'))
            worksheet.write(row, 3, tempo_atual)
            row += 1
    
    workbook.close()
    output.seek(0)
    
    # Preparar resposta
    response = HttpResponse(
        output.read(),
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = f'attachment; filename="tempo_atual_funcoes_{date.today().strftime("%Y%m%d")}.xlsx"'
    
    return response


@login_required
def funcoes_militares_media_tempo(request):
    """Gera relat√≥rio de tempo m√©dio nas fun√ß√µes"""
    from django.http import HttpResponse
    from datetime import datetime, date
    import io
    import xlsxwriter
    
    # Criar arquivo Excel em mem√≥ria
    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    worksheet = workbook.add_worksheet('Tempo M√©dio nas Fun√ß√µes')
    
    # Cabe√ßalhos
    headers = ['Fun√ß√£o', 'Tempo M√©dio (dias)', 'Total de Usu√°rios', '√öltima Atualiza√ß√£o']
    for col, header in enumerate(headers):
        worksheet.write(0, col, header)
    
    # Obter dados
    from .models import FuncaoMilitar, UsuarioFuncaoMilitar
    from django.db.models import Avg, Count
    
    funcoes = FuncaoMilitar.objects.filter(ativo=True).annotate(
        tempo_medio=Avg('usuario_funcao_militar__tempo_funcao'),
        total_usuarios=Count('usuario_funcao_militar', filter=Q(usuario_funcao_militar__ativo=True))
    )
    
    row = 1
    for funcao in funcoes:
        worksheet.write(row, 0, funcao.nome)
        worksheet.write(row, 1, funcao.tempo_medio or 0)
        worksheet.write(row, 2, funcao.total_usuarios)
        worksheet.write(row, 3, funcao.data_atualizacao.strftime('%d/%m/%Y %H:%M'))
        row += 1
    
    workbook.close()
    output.seek(0)
    
    # Preparar resposta
    response = HttpResponse(
        output.read(),
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = f'attachment; filename="tempo_medio_funcoes_{date.today().strftime("%Y%m%d")}.xlsx"'
    
    return response


# =============================================================================
# LOGS DO SISTEMA
# =============================================================================


@login_required
@administracao_required
def logs_sistema_marcar_processado(request, pk):
    """Marcar log como processado"""
    from .models import LogSistema
    from django.contrib import messages
    
    log = get_object_or_404(LogSistema, pk=pk)
    log.processado = True
    log.save()
    
    messages.success(request, 'Log marcado como processado!')
    return redirect('militares:logs_sistema_detail', pk=pk)


@login_required
@administracao_required
def logs_sistema_marcar_notificado(request, pk):
    """Marcar log como notificado"""
    from .models import LogSistema
    from django.contrib import messages
    
    log = get_object_or_404(LogSistema, pk=pk)
    log.notificado = True
    log.save()
    
    messages.success(request, 'Log marcado como notificado!')
    return redirect('militares:logs_sistema_detail', pk=pk)


@login_required
@administracao_required
def logs_sistema_limpar_antigos(request):
    """Limpar logs antigos do sistema"""
    from .models import LogSistema
    from django.contrib import messages
    from datetime import datetime, timedelta
    
    try:
        # Limpar logs com mais de 90 dias
        data_limite = datetime.now() - timedelta(days=90)
        logs_removidos = LogSistema.objects.filter(
            data_criacao__lt=data_limite
        ).delete()[0]
        
        messages.success(
            request, 
            f'{logs_removidos} logs antigos foram removidos com sucesso!'
        )
        
    except Exception as e:
        messages.error(request, f'Erro ao limpar logs antigos: {str(e)}')
    
    return redirect('militares:logs_sistema_list')


@login_required
@administracao_required
def logs_sistema_estatisticas(request):
    """Estat√≠sticas dos logs do sistema"""
    from .models import LogSistema
    from django.db.models import Count
    from datetime import datetime, timedelta
    
    # Estat√≠sticas gerais
    total_logs = LogSistema.objects.count()
    logs_hoje = LogSistema.objects.filter(
        data_criacao__date=datetime.now().date()
    ).count()
    
    # Logs por n√≠vel
    logs_por_nivel = LogSistema.objects.values('nivel').annotate(
        total=Count('id')
    ).order_by('nivel')
    
    # Logs por usu√°rio (top 10)
    logs_por_usuario = LogSistema.objects.values(
        'usuario__username', 'usuario__first_name', 'usuario__last_name'
    ).annotate(
        total=Count('id')
    ).order_by('-total')[:10]
    
    # Logs por dia (√∫ltimos 30 dias)
    data_inicio = datetime.now() - timedelta(days=30)
    logs_por_dia = LogSistema.objects.filter(
        data_criacao__gte=data_inicio
    ).extra(
        select={'dia': 'date(data_criacao)'}
    ).values('dia').annotate(
        total=Count('id')
    ).order_by('dia')
    
    context = {
        'total_logs': total_logs,
        'logs_hoje': logs_hoje,
        'logs_por_nivel': logs_por_nivel,
        'logs_por_usuario': logs_por_usuario,
        'logs_por_dia': logs_por_dia,
    }
    
    return render(request, 'militares/logs/logs_sistema_estatisticas.html', context)


@login_required
@administracao_required
def logs_sistema_exportar(request):
    """Exportar logs do sistema para Excel"""
    from .models import LogSistema
    from django.http import HttpResponse
    from datetime import datetime, timedelta
    import io
    import xlsxwriter
    
    # Filtros
    data_inicio = request.GET.get('data_inicio', '')
    data_fim = request.GET.get('data_fim', '')
    nivel = request.GET.get('nivel', '')
    
    # Query base
    logs = LogSistema.objects.all().order_by('-data_criacao')
    
    # Aplicar filtros
    if data_inicio:
        logs = logs.filter(data_criacao__date__gte=data_inicio)
    
    if data_fim:
        logs = logs.filter(data_criacao__date__lte=data_fim)
    
    if nivel:
        logs = logs.filter(nivel=nivel)
    
    # Limitar a 10000 registros para evitar problemas de mem√≥ria
    logs = logs[:10000]
    
    # Criar arquivo Excel em mem√≥ria
    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    worksheet = workbook.add_worksheet('Logs do Sistema')
    
    # Cabe√ßalhos
    headers = ['ID', 'Usu√°rio', 'A√ß√£o', 'N√≠vel', 'Data', 'Processado', 'Notificado', 'Detalhes']
    for col, header in enumerate(headers):
        worksheet.write(0, col, header)
    
    # Dados
    row = 1
    for log in logs:
        worksheet.write(row, 0, log.id)
        worksheet.write(row, 1, log.usuario.username if log.usuario else 'Sistema')
        worksheet.write(row, 2, log.acao)
        worksheet.write(row, 3, log.get_nivel_display())
        worksheet.write(row, 4, log.data_criacao.strftime('%d/%m/%Y %H:%M:%S'))
        worksheet.write(row, 5, 'Sim' if log.processado else 'N√£o')
        worksheet.write(row, 6, 'Sim' if log.notificado else 'N√£o')
        worksheet.write(row, 7, log.detalhes or '')
        row += 1
    
    workbook.close()
    output.seek(0)
    
    # Preparar resposta
    response = HttpResponse(
        output.read(),
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = f'attachment; filename="logs_sistema_{datetime.now().strftime("%Y%m%d_%H%M%S")}.xlsx"'
    
    return response


# ==================== VIEWS PARA ESCALAS DE SERVI√áO ====================



@login_required
def gerar_escalas_mes(request):
    """Gerar escalas de servi√ßo para um m√™s espec√≠fico"""
    from .models import EscalaServico, Militar
    from django.contrib import messages
    from datetime import datetime, date
    import calendar
    
    if request.method == 'POST':
        try:
            mes = int(request.POST.get('mes'))
            ano = int(request.POST.get('ano'))
            nome_escala = request.POST.get('nome_escala', f'Escala {mes}/{ano}')
            
            # Verificar se j√° existe escala para o m√™s
            if EscalaServico.objects.filter(
                data_inicio__month=mes,
                data_inicio__year=ano
            ).exists():
                messages.warning(request, f'J√° existe uma escala para {mes}/{ano}!')
                return redirect('militares:escalas_list')
            
            # Calcular datas do m√™s
            primeiro_dia = date(ano, mes, 1)
            ultimo_dia = date(ano, mes, calendar.monthrange(ano, mes)[1])
            
            # Criar escala
            escala = EscalaServico.objects.create(
                nome=nome_escala,
                data_inicio=primeiro_dia,
                data_fim=ultimo_dia,
                descricao=f'Escala de servi√ßo para {mes}/{ano}',
                ativo=True
            )
            
            messages.success(request, f'Escala "{nome_escala}" criada com sucesso!')
            return redirect('militares:escala_detail', pk=escala.pk)
            
        except Exception as e:
            messages.error(request, f'Erro ao gerar escala: {str(e)}')
    
    context = {
        'meses': [
            (1, 'Janeiro'), (2, 'Fevereiro'), (3, 'Mar√ßo'), (4, 'Abril'),
            (5, 'Maio'), (6, 'Junho'), (7, 'Julho'), (8, 'Agosto'),
            (9, 'Setembro'), (10, 'Outubro'), (11, 'Novembro'), (12, 'Dezembro')
        ],
        'anos': range(2020, datetime.now().year + 2),
    }
    
    return render(request, 'militares/escalas/gerar_escalas_mes.html', context)






def calcular_estatisticas_banco_horas(banco_horas, periodo='todos', data_inicio=None, data_fim=None, militar_id=None, search=None):
    """Fun√ß√£o auxiliar para calcular estat√≠sticas do banco de horas"""
    from decimal import Decimal
    from datetime import datetime, timedelta
    from django.db.models import Sum
    from .models import BancoHoras
    
    estatisticas = {}
    
    if banco_horas.exists():
        # Total de horas por tipo
        estatisticas['entradas'] = banco_horas.filter(tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']).aggregate(
            total=Sum('horas')
        )['total'] or Decimal('0')
        
        estatisticas['saidas'] = banco_horas.filter(tipo_movimentacao__in=['SAIDA', 'AJUSTE']).aggregate(
            total=Sum('horas')
        )['total'] or Decimal('0')
        
        estatisticas['saldo_periodo'] = estatisticas['entradas'] - estatisticas['saidas']
        estatisticas['total_movimentacoes'] = banco_horas.count()
    
    return estatisticas


@login_required
def escalas_banco_horas(request):
    """Banco de horas das escalas de servi√ßo"""
    from .models import BancoHoras, Militar
    from django.contrib import messages
    from django.core.paginator import Paginator
    from django.http import JsonResponse
    from django.db import transaction
    from decimal import Decimal
    from datetime import datetime, timedelta
    from django.db.models import Sum, Q
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_militares, aplicar_filtro_hierarquico_lotacoes, aplicar_filtro_hierarquico_escala_abonar, obter_opcoes_filtro_hierarquico_escalas_abonar
    from .permissoes_simples import obter_funcao_militar_ativa
    
    if request.method == 'POST':
        try:
            # Processar adi√ß√£o de nova movimenta√ß√£o
            militar_id = request.POST.get('militar')
            data_movimentacao = request.POST.get('data_movimentacao')
            tipo_movimentacao = request.POST.get('tipo_movimentacao')
            horas = Decimal(request.POST.get('horas', 0))
            observacoes = request.POST.get('observacoes', '')
            
            if not all([militar_id, data_movimentacao, tipo_movimentacao, horas]):
                return JsonResponse({'success': False, 'error': 'Todos os campos obrigat√≥rios devem ser preenchidos'})
            
            militar = Militar.objects.get(id=militar_id)
            
            # Calcular saldo anterior
            saldo_anterior = BancoHoras.calcular_saldo_militar(militar, data_movimentacao)
            
            # Calcular saldo atual
            if tipo_movimentacao in ['ENTRADA', 'COMPENSACAO']:
                saldo_atual = saldo_anterior + horas
            else:  # SAIDA, AJUSTE
                saldo_atual = saldo_anterior - horas
            
            with transaction.atomic():
                # Criar movimenta√ß√£o
                movimentacao = BancoHoras.objects.create(
                    militar=militar,
                    data_movimentacao=data_movimentacao,
                    tipo_movimentacao=tipo_movimentacao,
                    horas=horas,
                    saldo_anterior=saldo_anterior,
                    saldo_atual=saldo_atual,
                    observacoes=observacoes,
                    criado_por=request.user
                )
                
                # Atualizar saldos de movimenta√ß√µes posteriores
                movimentacoes_posteriores = BancoHoras.objects.filter(
                    militar=militar,
                    data_movimentacao__gt=data_movimentacao
                ).order_by('data_movimentacao', 'id')
                
                saldo_atual_geral = saldo_atual
                for mov in movimentacoes_posteriores:
                    mov.saldo_anterior = saldo_atual_geral
                    if mov.tipo_movimentacao in ['ENTRADA', 'COMPENSACAO']:
                        saldo_atual_geral += mov.horas
                    else:
                        saldo_atual_geral -= mov.horas
                    mov.saldo_atual = saldo_atual_geral
                    mov.save()
            
            return JsonResponse({'success': True, 'message': 'Movimenta√ß√£o adicionada com sucesso'})
            
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    # GET - Listar movimenta√ß√µes
    # Filtros
    search = request.GET.get('search', '')
    organizacao_filtro = request.GET.get('organizacao_filtro', '')
    mes = request.GET.get('mes', '')
    ano = request.GET.get('ano', '')
    data_inicio = request.GET.get('data_inicio', '')
    data_fim = request.GET.get('data_fim', '')
    
    # Query base
    banco_horas = BancoHoras.objects.select_related('militar', 'escala').order_by('-data_movimentacao', '-id')
    
    # Aplicar filtro hier√°rquico baseado na fun√ß√£o do usu√°rio (mesmo princ√≠pio das notas)
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    if request.user.is_superuser:
        # Superusu√°rio v√™ todos os dados
        pass
    elif funcao_usuario:
        # Verificar se h√° filtro de organiza√ß√£o espec√≠fico selecionado
        if organizacao_filtro:
            # Se h√° organiza√ß√£o selecionada no filtro, mostrar apenas dados dessa organiza√ß√£o espec√≠fica
            from .filtros_hierarquicos_pesquisa import aplicar_filtro_hierarquico_banco_horas_especifico
            banco_horas = aplicar_filtro_hierarquico_banco_horas_especifico(banco_horas, funcao_usuario, request.user, organizacao_filtro)
        else:
            # Sem filtro espec√≠fico, usar filtro restritivo (apenas o pr√≥prio n√≠vel)
            from .filtros_hierarquicos_pesquisa import aplicar_filtro_hierarquico_banco_horas_restritivo
            banco_horas = aplicar_filtro_hierarquico_banco_horas_restritivo(banco_horas, funcao_usuario, request.user)
    else:
        # Se n√£o h√° fun√ß√£o ativa, n√£o mostrar dados
        banco_horas = banco_horas.none()
    
    # Aplicar filtros
    if search:
        from django.db.models import Q
        banco_horas = banco_horas.filter(
            Q(militar__nome_completo__icontains=search) |
            Q(militar__nome_guerra__icontains=search) |
            Q(militar__matricula__icontains=search) |
            Q(militar__cpf__icontains=search)
        )
    
    
    if mes:
        banco_horas = banco_horas.filter(data_movimentacao__month=mes)
    
    if ano:
        banco_horas = banco_horas.filter(data_movimentacao__year=ano)
    
    # Filtro por data personalizada
    if data_inicio and data_fim:
        try:
            data_inicio_periodo = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            data_fim_periodo = datetime.strptime(data_fim, '%Y-%m-%d').date()
            banco_horas = banco_horas.filter(
                data_movimentacao__gte=data_inicio_periodo,
                data_movimentacao__lte=data_fim_periodo
            )
        except ValueError:
            pass
    
    # Calcular estat√≠sticas usando fun√ß√£o auxiliar
    estatisticas = calcular_estatisticas_banco_horas(banco_horas, 'todos', data_inicio, data_fim, None, search)
    
    # Lista de todos os militares (com e sem horas trabalhadas)
    militares_com_saldo = []
    
    # Buscar todos os militares ativos (situa√ß√£o diferente de INATIVO)
    todos_militares = Militar.objects.exclude(classificacao='INATIVO').order_by('nome_completo')
    
    # Aplicar filtro hier√°rquico baseado na fun√ß√£o do usu√°rio - APENAS organiza√ß√£o principal da fun√ß√£o
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        todos_militares = aplicar_filtro_hierarquico_escala_abonar(todos_militares, funcao_usuario, request.user)
        
        # Aplicar filtro de organiza√ß√£o se especificado
        if organizacao_filtro:
            from .models import Orgao, GrandeComando, Unidade, SubUnidade
            
            # Determinar o tipo de organiza√ß√£o baseado no ID
            if organizacao_filtro.startswith('orgao_'):
                orgao_id = organizacao_filtro.replace('orgao_', '')
                try:
                    orgao = Orgao.objects.get(id=orgao_id)
                    todos_militares = todos_militares.filter(
                        lotacoes__orgao=orgao,
                        lotacoes__status='ATUAL',
                        lotacoes__ativo=True
                    )
                except Orgao.DoesNotExist:
                    pass
            elif organizacao_filtro.startswith('gc_'):
                gc_id = organizacao_filtro.replace('gc_', '')
                try:
                    grande_comando = GrandeComando.objects.get(id=gc_id)
                    todos_militares = todos_militares.filter(
                        lotacoes__grande_comando=grande_comando,
                        lotacoes__status='ATUAL',
                        lotacoes__ativo=True
                    )
                except GrandeComando.DoesNotExist:
                    pass
            elif organizacao_filtro.startswith('unidade_'):
                unidade_id = organizacao_filtro.replace('unidade_', '')
                try:
                    unidade = Unidade.objects.get(id=unidade_id)
                    todos_militares = todos_militares.filter(
                        lotacoes__unidade=unidade,
                        lotacoes__status='ATUAL',
                        lotacoes__ativo=True
                    )
                except Unidade.DoesNotExist:
                    pass
            elif organizacao_filtro.startswith('sub_'):
                sub_id = organizacao_filtro.replace('sub_', '')
                try:
                    subunidade = SubUnidade.objects.get(id=sub_id)
                    todos_militares = todos_militares.filter(
                        lotacoes__sub_unidade=subunidade,
                        lotacoes__status='ATUAL',
                        lotacoes__ativo=True
                    )
                except SubUnidade.DoesNotExist:
                    pass
    
    # Aplicar filtros adicionais aos militares
    if search:
        from django.db.models import Q
        todos_militares = todos_militares.filter(
            Q(nome_completo__icontains=search) |
            Q(nome_guerra__icontains=search) |
            Q(matricula__icontains=search) |
            Q(cpf__icontains=search)
        )
    
    
    # Calcular per√≠odo do m√™s atual para verificar quem n√£o tem horas
    hoje = datetime.now().date()
    inicio_mes_atual = datetime(hoje.year, hoje.month, 1).date()
    fim_mes_atual = hoje
    
    for militar in todos_militares:
        # Calcular saldo total do militar
        saldo_atual = BancoHoras.calcular_saldo_militar(militar)
        
        # Calcular acumulado do ano atual
        inicio_ano_atual = datetime(hoje.year, 1, 1).date()
        fim_ano_atual = datetime(hoje.year, 12, 31).date()
        
        movimentacoes_ano_atual = banco_horas.filter(
            militar=militar,
            data_movimentacao__gte=inicio_ano_atual,
            data_movimentacao__lte=fim_ano_atual
        )
        
        # Calcular horas acumuladas no ano (entradas - sa√≠das)
        entradas_ano = movimentacoes_ano_atual.filter(
            tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        saidas_ano = movimentacoes_ano_atual.filter(
            tipo_movimentacao__in=['SAIDA', 'AJUSTE']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        acumulado_ano = entradas_ano - saidas_ano
        
        # Verificar se tem movimenta√ß√µes no m√™s atual
        movimentacoes_mes_atual = banco_horas.filter(
            militar=militar,
            data_movimentacao__gte=inicio_mes_atual,
            data_movimentacao__lte=fim_mes_atual
        )
        
        # Calcular horas do m√™s atual (entradas - sa√≠das)
        entradas_mes = movimentacoes_mes_atual.filter(
            tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        saidas_mes = movimentacoes_mes_atual.filter(
            tipo_movimentacao__in=['SAIDA', 'AJUSTE']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        horas_mes = entradas_mes - saidas_mes
        
        # Verificar se tem horas trabalhadas no m√™s atual
        tem_horas_mes_atual = movimentacoes_mes_atual.filter(
            tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
        ).exists()
        
        # Buscar √∫ltima movimenta√ß√£o geral
        ultima_movimentacao = banco_horas.filter(militar=militar).first()
        
        militares_com_saldo.append({
            'militar': militar,
            'saldo_atual': saldo_atual,
            'horas_mes': horas_mes,
            'acumulado_ano': acumulado_ano,
            'ultima_movimentacao': ultima_movimentacao,
            'tem_horas_mes_atual': tem_horas_mes_atual,
            'movimentacoes_mes_atual': movimentacoes_mes_atual.count()
        })
    
    # Definir hierarquia de postos para ordena√ß√£o
    HIERARQUIA_POSTOS = {
        'CB': 1,    # Coronel
        'TC': 2,    # Tenente Coronel
        'MJ': 3,    # Major
        'CP': 4,    # Capit√£o
        '1T': 5,    # 1¬∫ Tenente
        '2T': 6,    # 2¬∫ Tenente
        'AS': 7,    # Aspirante a Oficial
        'AA': 8,    # Aluno de Adapta√ß√£o
        'NVRR': 9,  # Navegador
        'ST': 10,   # Subtenente
        '1S': 11,   # 1¬∫ Sargento
        '2S': 12,   # 2¬∫ Sargento
        '3S': 13,   # 3¬∫ Sargento
        'CAB': 14,  # Cabo
        'SD': 15,   # Soldado
    }
    
    # Ordenar por hierarquia: primeiro por posto (menor n√∫mero = maior hierarquia), 
    # depois por numera√ß√£o de antiguidade (menor n√∫mero = maior antiguidade),
    # depois por nome completo
    militares_com_saldo.sort(key=lambda x: (
        HIERARQUIA_POSTOS.get(x['militar'].posto_graduacao, 999),  # Posto (hierarquia)
        x['militar'].numeracao_antiguidade or 999,  # Numera√ß√£o de antiguidade
        x['militar'].nome_completo  # Nome completo
    ))
    
    # Buscar dados para os filtros
    from .models import Lotacao
    from django.db.models import Count
    
    # Usar organograma hier√°rquico para o filtro de lota√ß√£o
    lotacoes = []
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        # Obter op√ß√µes hier√°rquicas baseadas na fun√ß√£o do usu√°rio
        opcoes_hierarquicas = obter_opcoes_filtro_hierarquico_escalas_abonar(funcao_usuario, request.user)
        
        # Converter para formato de lota√ß√µes
        for opcao in opcoes_hierarquicas:
            lotacoes.append({
                'id': opcao['id'],
                'lotacao': opcao['nome'],
                'nivel': opcao['nivel']
            })
    else:
        # Se n√£o tem fun√ß√£o, buscar todas as lota√ß√µes
        from .models import Militar
        militares_permitidos = Militar.objects.exclude(classificacao='INATIVO')
        
        lotacoes_distintas = Lotacao.objects.filter(
            militar__in=militares_permitidos,
            status='ATUAL',
            ativo=True
        ).values('lotacao').distinct().order_by('lotacao')
        
        # Adicionar IDs √∫nicos para cada lota√ß√£o
        for lotacao in lotacoes_distintas:
            primeiro_id = Lotacao.objects.filter(
                lotacao=lotacao['lotacao'],
                militar__in=militares_permitidos,
                status='ATUAL',
                ativo=True
            ).first().id
            lotacoes.append({
                'id': primeiro_id,
                'lotacao': lotacao['lotacao']
            })
    
    # Gerar lista de anos dispon√≠veis de 2015 at√© 2050
    anos_disponiveis = list(range(2015, 2051))
    
    # Obter op√ß√µes de filtro hier√°rquico para banco de horas
    opcoes_filtro_hierarquico = []
    if funcao_usuario:
        from .filtros_hierarquicos_pesquisa import obter_opcoes_filtro_hierarquico_notas
        opcoes_filtro_hierarquico = obter_opcoes_filtro_hierarquico_notas(funcao_usuario, request.user)
    
    context = {
        'search': search,
        'organizacao_filtro': organizacao_filtro,
        'mes': mes,
        'ano': ano,
        'data_inicio': data_inicio,
        'data_fim': data_fim,
        'estatisticas': estatisticas,
        'militares_com_saldo': militares_com_saldo,
        'opcoes_filtro_hierarquico': opcoes_filtro_hierarquico,
        'anos_disponiveis': anos_disponiveis,
        'title': 'Banco de Horas',
        'page_title': 'Banco de Horas - Escalas de Servi√ßo',
        'data_inicio_padrao': datetime.now().strftime('%Y-%m-%d'),
        'data_fim_padrao': datetime.now().strftime('%Y-%m-%d'),
    }
    
    return render(request, 'militares/escalas/escalas_banco_horas.html', context)


@login_required
def banco_horas_editar(request, pk):
    """Editar movimenta√ß√£o do banco de horas"""
    from .models import BancoHoras, Militar
    from django.http import JsonResponse
    from django.db import transaction
    from decimal import Decimal
    from django.shortcuts import get_object_or_404
    
    movimentacao = get_object_or_404(BancoHoras, pk=pk)
    
    if request.method == 'POST':
        try:
            militar_id = request.POST.get('militar')
            data_movimentacao = request.POST.get('data_movimentacao')
            tipo_movimentacao = request.POST.get('tipo_movimentacao')
            horas = Decimal(request.POST.get('horas', 0))
            observacoes = request.POST.get('observacoes', '')
            
            if not all([militar_id, data_movimentacao, tipo_movimentacao, horas]):
                return JsonResponse({'success': False, 'error': 'Todos os campos obrigat√≥rios devem ser preenchidos'})
            
            militar = Militar.objects.get(id=militar_id)
            
            with transaction.atomic():
                # Atualizar movimenta√ß√£o
                movimentacao.militar = militar
                movimentacao.data_movimentacao = data_movimentacao
                movimentacao.tipo_movimentacao = tipo_movimentacao
                movimentacao.horas = horas
                movimentacao.observacoes = observacoes
                movimentacao.save()
                
                # Recalcular todos os saldos do militar
                movimentacoes = BancoHoras.objects.filter(
                    militar=militar
                ).order_by('data_movimentacao', 'id')
                
                saldo_atual = Decimal('0')
                for mov in movimentacoes:
                    mov.saldo_anterior = saldo_atual
                    if mov.tipo_movimentacao in ['ENTRADA', 'COMPENSACAO']:
                        saldo_atual += mov.horas
                    else:
                        saldo_atual -= mov.horas
                    mov.saldo_atual = saldo_atual
                    mov.save()
            
            return JsonResponse({'success': True, 'message': 'Movimenta√ß√£o atualizada com sucesso'})
            
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    # GET - Retornar dados da movimenta√ß√£o
    return JsonResponse({
        'success': True,
        'data': {
            'militar_id': movimentacao.militar.id,
            'data_movimentacao': movimentacao.data_movimentacao.strftime('%Y-%m-%d'),
            'tipo_movimentacao': movimentacao.tipo_movimentacao,
            'horas': float(movimentacao.horas),
            'observacoes': movimentacao.observacoes or ''
        }
    })


@login_required
def api_banco_horas_detalhes_militar(request):
    """Retorna detalhes do banco de horas de um militar (JSON)"""
    from .models import BancoHoras, Militar
    from django.http import JsonResponse
    from django.db.models import Sum
    from decimal import Decimal
    from datetime import datetime
    
    try:
        militar_id = request.GET.get('militar_id')
        ano = request.GET.get('ano')
        mes = request.GET.get('mes')
        data_inicio = request.GET.get('data_inicio')
        data_fim = request.GET.get('data_fim')
        
        if not militar_id:
            return JsonResponse({'success': False, 'message': 'Par√¢metro militar_id √© obrigat√≥rio'}, status=400)
        
        militar = Militar.objects.get(id=militar_id)
        qs = BancoHoras.objects.select_related('escala', 'escala_militar').filter(militar=militar).order_by('-data_movimentacao', '-id')
        
        # Filtros opcionais
        if ano:
            qs = qs.filter(data_movimentacao__year=ano)
        if mes:
            qs = qs.filter(data_movimentacao__month=mes)
        if data_inicio and data_fim:
            try:
                di = datetime.strptime(data_inicio, '%Y-%m-%d').date()
                df = datetime.strptime(data_fim, '%Y-%m-%d').date()
                qs = qs.filter(data_movimentacao__gte=di, data_movimentacao__lte=df)
            except ValueError:
                pass
        
        # Montar lista de movimenta√ß√µes
        movimentacoes = []
        for mov in qs[:300]:  # limitar para evitar payload grande
            movimentacoes.append({
                'data': mov.data_movimentacao.strftime('%d/%m/%Y'),
                'tipo': mov.get_tipo_movimentacao_display(),
                'horas': float(mov.horas),
                'saldo_anterior': float(mov.saldo_anterior),
                'saldo_atual': float(mov.saldo_atual),
                'escala': str(mov.escala) if mov.escala else None,
                'turno': f"{mov.escala_militar.hora_inicio.strftime('%H:%M')} - {mov.escala_militar.hora_fim.strftime('%H:%M')}" if mov.escala_militar and mov.escala_militar.hora_inicio and mov.escala_militar.hora_fim else None,
                'observacoes': mov.observacoes or ''
            })
        
        # Estat√≠sticas
        entradas = qs.filter(tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        saidas = qs.filter(tipo_movimentacao__in=['SAIDA', 'AJUSTE']).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        saldo_periodo = entradas - saidas
        
        # Saldo atual geral
        saldo_atual = BancoHoras.calcular_saldo_militar(militar)
        
        return JsonResponse({
            'success': True,
            'militar': {
                'id': militar.id,
                'nome': militar.nome_completo,
                'posto_graduacao': militar.get_posto_graduacao_display(),
            },
            'estatisticas': {
                'entradas': float(entradas),
                'saidas': float(saidas),
                'saldo_periodo': float(saldo_periodo),
                'saldo_atual': float(saldo_atual),
                'total_movimentacoes': qs.count(),
            },
            'movimentacoes': movimentacoes
        })
    except Militar.DoesNotExist:
        return JsonResponse({'success': False, 'message': 'Militar n√£o encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)}, status=500)

@login_required
def banco_horas_excluir(request, pk):
    """Excluir movimenta√ß√£o do banco de horas"""
    from .models import BancoHoras
    from django.http import JsonResponse
    from django.db import transaction
    from django.shortcuts import get_object_or_404
    from decimal import Decimal
    
    movimentacao = get_object_or_404(BancoHoras, pk=pk)
    
    if request.method == 'POST':
        try:
            with transaction.atomic():
                militar = movimentacao.militar
                # Excluir movimenta√ß√£o
                movimentacao.delete()
                
                # Recalcular todos os saldos do militar
                movimentacoes = BancoHoras.objects.filter(
                    militar=militar
                ).order_by('data_movimentacao', 'id')
                
                saldo_atual = Decimal('0')
                for mov in movimentacoes:
                    mov.saldo_anterior = saldo_atual
                    if mov.tipo_movimentacao in ['ENTRADA', 'COMPENSACAO']:
                        saldo_atual += mov.horas
                    else:
                        saldo_atual -= mov.horas
                    mov.saldo_atual = saldo_atual
                    mov.save()
            
            return JsonResponse({'success': True, 'message': 'Movimenta√ß√£o exclu√≠da com sucesso'})
            
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    return JsonResponse({'success': False, 'error': 'M√©todo n√£o permitido'})


@login_required
def banco_horas_relatorio_pdf(request):
    """Gerar relat√≥rio PDF do banco de horas por per√≠odo"""
    from .models import BancoHoras
    from django.http import HttpResponse
    from django.template.loader import get_template
    from django.template import Context
    from datetime import datetime, timedelta
    from django.db.models import Sum
    from decimal import Decimal
    import io
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_CENTER, TA_LEFT
    from .permissoes_simples import obter_funcao_militar_ativa
    from django.utils import timezone
    import pytz
    import locale
    
    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass
    
    # Par√¢metros
    periodo = request.GET.get('periodo', 'todos')
    data_inicio = request.GET.get('data_inicio', '')
    data_fim = request.GET.get('data_fim', '')
    tipo = request.GET.get('tipo', '')
    ano = request.GET.get('ano', '')
    mes = request.GET.get('mes', '')
    funcao = request.GET.get('funcao', '')  # Fun√ß√£o para assinatura
    
    # Se for relat√≥rio completo, usar l√≥gica espec√≠fica
    if tipo == 'completo':
        return gerar_relatorio_pdf_completo(request, ano, mes)
    
    # Query base
    banco_horas = BancoHoras.objects.select_related('militar', 'escala').order_by('-data_movimentacao', '-id')
    
    # Aplicar filtros de per√≠odo
    hoje = datetime.now().date()
    
    if periodo == 'semanal':
        data_inicio_periodo = hoje - timedelta(days=7)
        banco_horas = banco_horas.filter(data_movimentacao__gte=data_inicio_periodo)
        titulo_periodo = f"Relat√≥rio Semanal - {data_inicio_periodo.strftime('%d/%m/%Y')} a {hoje.strftime('%d/%m/%Y')}"
    elif periodo == 'mensal':
        if hoje.month == 1:
            data_inicio_periodo = datetime(hoje.year - 1, 12, 1).date()
        else:
            data_inicio_periodo = datetime(hoje.year, hoje.month - 1, 1).date()
        banco_horas = banco_horas.filter(data_movimentacao__gte=data_inicio_periodo)
        titulo_periodo = f"Relat√≥rio Mensal - {data_inicio_periodo.strftime('%m/%Y')}"
    elif periodo == 'anual':
        data_inicio_periodo = datetime(hoje.year - 1, 1, 1).date()
        banco_horas = banco_horas.filter(data_movimentacao__gte=data_inicio_periodo)
        titulo_periodo = f"Relat√≥rio Anual - {hoje.year - 1}"
    elif data_inicio and data_fim:
        try:
            data_inicio_periodo = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            data_fim_periodo = datetime.strptime(data_fim, '%Y-%m-%d').date()
            banco_horas = banco_horas.filter(
                data_movimentacao__gte=data_inicio_periodo,
                data_movimentacao__lte=data_fim_periodo
            )
            titulo_periodo = f"Relat√≥rio Personalizado - {data_inicio_periodo.strftime('%d/%m/%Y')} a {data_fim_periodo.strftime('%d/%m/%Y')}"
        except ValueError:
            titulo_periodo = "Relat√≥rio - Todos os Per√≠odos"
    else:
        titulo_periodo = "Relat√≥rio - Todos os Per√≠odos"
    
    # Calcular estat√≠sticas usando fun√ß√£o auxiliar
    estatisticas = calcular_estatisticas_banco_horas(banco_horas, periodo, data_inicio, data_fim)
    
    # Criar PDF
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'inline; filename="banco_horas_{periodo}_{datetime.now().strftime("%Y%m%d_%H%M%S")}.pdf"'
    
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=1.5*cm, leftMargin=1.5*cm, topMargin=2*cm, bottomMargin=2*cm)
    
    # Estilos
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=16,
        spaceAfter=20,
        alignment=TA_CENTER,
        textColor=colors.black
    )
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=12)
    
    # Conte√∫do do PDF
    story = []
    
    # Logo/Bras√£o centralizado
    import os
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        from reportlab.platypus import Image
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Determinar local de gera√ß√£o baseado na fun√ß√£o do usu√°rio (hierarquia completa)
    local_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario and funcao_usuario.funcao_militar:
        hierarquia = []
        
        # Construir hierarquia completa at√© a inst√¢ncia mais espec√≠fica
        if hasattr(funcao_usuario, 'orgao') and funcao_usuario.orgao:
            hierarquia.append(funcao_usuario.orgao.nome.upper())
        if hasattr(funcao_usuario, 'grande_comando') and funcao_usuario.grande_comando:
            hierarquia.append(funcao_usuario.grande_comando.nome.upper())
        if hasattr(funcao_usuario, 'unidade') and funcao_usuario.unidade:
            hierarquia.append(funcao_usuario.unidade.nome.upper())
        if hasattr(funcao_usuario, 'sub_unidade') and funcao_usuario.sub_unidade:
            hierarquia.append(funcao_usuario.sub_unidade.nome.upper())
        
        # Se encontrou alguma inst√¢ncia, usar a mais espec√≠fica (√∫ltima da lista)
        if hierarquia:
            local_geracao = hierarquia[-1]
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        local_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))
    
    # T√≠tulo principal centralizado e sublinhado
    story.append(Paragraph("<u>BANCO DE HORAS - ESCALAS DE SERVI√áO</u>", title_style))
    story.append(Paragraph(titulo_periodo, styles['Heading2']))
    story.append(Spacer(1, 20))
    
    # Estat√≠sticas
    if estatisticas:
        stats_data = [
            ['Estat√≠sticas do Per√≠odo', ''],
            ['Total de Entradas', f"{estatisticas['entradas']}h"],
            ['Total de Sa√≠das', f"{estatisticas['saidas']}h"],
            ['Saldo do Per√≠odo', f"{estatisticas['saldo_periodo']}h"],
            ['Total de Movimenta√ß√µes', str(estatisticas['total_movimentacoes'])],
        ]
        
        stats_table = Table(stats_data, colWidths=[3*inch, 2*inch])
        stats_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))
        
        story.append(stats_table)
        story.append(Spacer(1, 20))
    
    # Tabela de movimenta√ß√µes
    if banco_horas.exists():
        # Cabe√ßalho da tabela
        data = [['Militar', 'Data', 'Tipo', 'Horas', 'Saldo Anterior', 'Saldo Atual', 'Observa√ß√µes']]
        
        # Dados das movimenta√ß√µes
        for mov in banco_horas[:100]:  # Limitar a 100 registros por PDF
            data.append([
                mov.militar.nome_completo,
                mov.data_movimentacao.strftime('%d/%m/%Y'),
                mov.get_tipo_movimentacao_display(),
                f"{mov.horas}h",
                f"{mov.saldo_anterior}h",
                f"{mov.saldo_atual}h",
                mov.observacoes or '-'
            ])
        
        # Criar tabela
        table = Table(data, colWidths=[1.5*inch, 0.8*inch, 0.8*inch, 0.6*inch, 0.8*inch, 0.8*inch, 1.5*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 8),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('FONTSIZE', (0, 1), (-1, -1), 7),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))
        
        story.append(Paragraph("Movimenta√ß√µes do Banco de Horas", styles['Heading3']))
        story.append(Spacer(1, 12))
        story.append(table)
        
        if banco_horas.count() > 100:
            story.append(Spacer(1, 12))
            story.append(Paragraph(f"* Mostrando apenas os primeiros 100 registros de {banco_horas.count()} total", styles['Normal']))
    else:
        story.append(Paragraph("Nenhuma movimenta√ß√£o encontrada para o per√≠odo selecionado.", styles['Normal']))
    
    # Rodap√©
    story.append(Spacer(1, 20))
    story.append(Paragraph(f"Relat√≥rio gerado em: {datetime.now().strftime('%d/%m/%Y √†s %H:%M')}", styles['Normal']))
    
    # Adicionar assinatura eletr√¥nica se fun√ß√£o fornecida
    if funcao:
        story.append(Spacer(1, 1*cm))
        
        # Obter assinante (usu√°rio logado)
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            nome_assinante = militar_logado.nome_completo if militar_logado else request.user.get_full_name() or request.user.username
        except:
            nome_assinante = request.user.get_full_name() or request.user.username
        
        # Data por extenso - usar timezone de Bras√≠lia
        brasilia_tz = pytz.timezone('America/Sao_Paulo')
        data_atual = timezone.now().astimezone(brasilia_tz) if timezone.is_aware(timezone.now()) else brasilia_tz.localize(timezone.now())
        
        meses_extenso = {
            1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
            5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
            9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
        }
        data_formatada_extenso = f"{data_atual.day} de {meses_extenso[data_atual.month]} de {data_atual.year}"
        
        # Fun√ß√£o selecionada
        funcao_display = funcao if funcao else "Operador de Banco de Horas"
        
        # Construir texto
        texto_info = f"Teresina - PI, {data_formatada_extenso}.<br/><br/>{nome_assinante}<br/>{funcao_display}"
        
        # Estilo para o texto
        style_info = ParagraphStyle('info', parent=styles['Normal'], fontSize=9, fontName='Helvetica', 
                                     alignment=1, textColor=colors.HexColor('#2c3e50'), spaceAfter=8,
                                     leading=12)
        
        story.append(Paragraph(texto_info, style_info))
        
        # Adicionar assinatura eletr√¥nica
        from .utils import obter_caminho_assinatura_eletronica
        
        story.append(Spacer(1, 0.5*cm))
        
        # Obter assinante (usu√°rio logado)
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            nome_assinante = militar_logado.nome_completo if militar_logado else request.user.get_full_name() or request.user.username
        except:
            nome_assinante = request.user.get_full_name() or request.user.username
        
        # Data e hora formatadas
        from .utils import formatar_data_assinatura
        data_formatada, hora_formatada = formatar_data_assinatura(data_atual)
        
        # Texto da assinatura eletr√¥nica
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_assinante}, em {data_formatada} {hora_formatada}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Estilo para texto justificado
        style_assinatura_texto = ParagraphStyle('assinatura_texto', parent=styles['Normal'], fontSize=10, fontName='Helvetica', alignment=4, spaceAfter=1, spaceBefore=1, leading=14)
        
        # Tabela das assinaturas: Logo + Texto de assinatura
        # Largura ajustada para ter margem de 0,02cm de cada lado (largura total - 0,04cm)
        largura_disponivel = A4[0] - (1.5*inch * 2) - 0.04*inch  # total - margens documento - margem extra 0,02cm cada lado
        largura_texto = largura_disponivel - 2.5*inch  # menos logo
        
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=2.5*inch, height=1.8*inch), Paragraph(texto_assinatura, style_assinatura_texto)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[2.5*inch, largura_texto])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('LEFTPADDING', (0, 0), (0, -1), 0),  # Logo sem padding esquerdo
            ('LEFTPADDING', (1, 0), (1, -1), 15),  # Texto com padding esquerdo para afastar da logo
            ('RIGHTPADDING', (0, 0), (-1, -1), 0),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
        ]))
        
        story.append(assinatura_table)
    
    # Construir PDF
    doc.build(story)
    
    # Retornar PDF
    pdf = buffer.getvalue()
    buffer.close()
    response.write(pdf)
    
    return response


@login_required
def banco_horas_sincronizar(request):
    """Sincronizar banco de horas com as escalas de servi√ßo"""
    from .models import BancoHoras
    from datetime import datetime, timedelta
    from django.contrib import messages
    from django.http import JsonResponse
    
    if request.method == 'POST':
        try:
            # Par√¢metros do per√≠odo
            data_inicio = request.POST.get('data_inicio')
            data_fim = request.POST.get('data_fim')
            
            # Converter datas se fornecidas
            if data_inicio:
                data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            if data_fim:
                data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
            
            # Sincronizar banco de horas
            resultado = BancoHoras.sincronizar_banco_horas_escalas(data_inicio, data_fim)
            
            # Verificar se √© uma requisi√ß√£o AJAX
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest' or 'application/json' in request.headers.get('Accept', ''):
                return JsonResponse({
                    'success': True,
                    'message': f'Sincroniza√ß√£o conclu√≠da! {resultado["movimentacoes_criadas"]} movimenta√ß√µes criadas, {resultado["movimentacoes_atualizadas"]} atualizadas.',
                    'resultado': resultado
                })
            else:
                messages.success(request, f'Sincroniza√ß√£o conclu√≠da! {resultado["movimentacoes_criadas"]} movimenta√ß√µes criadas, {resultado["movimentacoes_atualizadas"]} atualizadas.')
                return redirect('militares:escalas_banco_horas')
                
        except Exception as e:
            # Verificar se √© uma requisi√ß√£o AJAX
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest' or 'application/json' in request.headers.get('Accept', ''):
                return JsonResponse({
                    'success': False,
                    'error': str(e)
                })
            else:
                messages.error(request, f'Erro na sincroniza√ß√£o: {str(e)}')
                return redirect('militares:escalas_banco_horas')
    
    # GET - Mostrar formul√°rio de sincroniza√ß√£o
    context = {
        'title': 'Sincronizar Banco de Horas',
        'data_inicio_padrao': (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d'),
        'data_fim_padrao': datetime.now().strftime('%Y-%m-%d'),
    }
    return render(request, 'militares/escalas/banco_horas_sincronizar.html', context)


def consolidar_banco_horas_militar_escala(militar, escala):
    """
    Registra cada turno do militar separadamente no banco de horas.
    Retorna o n√∫mero de movimenta√ß√µes criadas/atualizadas.
    """
    from .models import BancoHoras
    from datetime import datetime, timedelta
    from decimal import Decimal
    
    try:
        # Buscar todas as escalas do militar nesta data
        escalas_militares = EscalaMilitar.objects.filter(
            militar=militar,
            escala__data=escala.data
        )
        
        movimentacoes_processadas = 0
        
        # Processar cada turno individualmente
        for escala_militar in escalas_militares:
            if escala_militar.hora_fim and escala_militar.hora_inicio:
                inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                fim = datetime.combine(escala.data, escala_militar.hora_fim)
                
                # Se a hora fim for menor que a hora in√≠cio, assumir que √© no dia seguinte
                if fim <= inicio:
                    fim += timedelta(days=1)
                
                duracao = fim - inicio
                horas_turno = Decimal(str(duracao.total_seconds() / 3600))
                
                if horas_turno <= 0:
                    continue
                
                # Verificar se j√° existe movimenta√ß√£o para este turno espec√≠fico
                movimentacao_existente = BancoHoras.objects.filter(
                    militar=militar,
                    data_movimentacao=escala.data,
                    tipo_movimentacao='ENTRADA',
                    escala_militar=escala_militar
                ).first()
                
                if movimentacao_existente:
                    # Atualizar movimenta√ß√£o existente
                    saldo_anterior = BancoHoras.calcular_saldo_militar(militar, escala.data)
                    saldo_atual = saldo_anterior + horas_turno
                    
                    movimentacao_existente.horas = horas_turno
                    movimentacao_existente.saldo_anterior = saldo_anterior
                    movimentacao_existente.saldo_atual = saldo_atual
                    movimentacao_existente.observacoes = f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}"
                    movimentacao_existente.save()
                else:
                    # Criar nova movimenta√ß√£o para este turno
                    saldo_anterior = BancoHoras.calcular_saldo_militar(militar, escala.data)
                    saldo_atual = saldo_anterior + horas_turno
                    
                    BancoHoras.objects.create(
                        militar=militar,
                        data_movimentacao=escala.data,
                        tipo_movimentacao='ENTRADA',
                        horas=horas_turno,
                        saldo_anterior=saldo_anterior,
                        saldo_atual=saldo_atual,
                        escala=escala,
                        escala_militar=escala_militar,
                        observacoes=f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}",
                        criado_por=escala.criado_por
                    )
                
                movimentacoes_processadas += 1
        
        return movimentacoes_processadas
        
    except Exception as e:
        print(f"Erro ao consolidar banco de horas para {militar.nome_completo}: {str(e)}")
        return 0


@login_required
def sincronizar_escala_abonar(request, pk):
    """Sincronizar escala de abonar com base nas escalas de servi√ßo"""
    from .models import EscalaServico, BancoHoras
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.contrib import messages
    from datetime import datetime
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    try:
        escala = get_object_or_404(EscalaServico, pk=pk)
        
        # Verificar se a escala tem militares
        if not escala.militares.exists():
            return JsonResponse({
                'success': False, 
                'message': 'Esta escala n√£o possui militares para sincronizar.'
            })
        
        # Sincronizar banco de horas para esta escala espec√≠fica
        movimentacoes_criadas = 0
        movimentacoes_atualizadas = 0
        
        # Processar cada turno individualmente
        for escala_militar in escala.militares.all():
            try:
                if escala_militar.hora_fim and escala_militar.hora_inicio:
                    from datetime import datetime, timedelta
                    from decimal import Decimal
                    
                    inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                    fim = datetime.combine(escala.data, escala_militar.hora_fim)
                    
                    # Se a hora fim for menor que a hora in√≠cio, assumir que √© no dia seguinte
                    if fim <= inicio:
                        fim += timedelta(days=1)
                    
                    duracao = fim - inicio
                    horas_turno = Decimal(str(duracao.total_seconds() / 3600))
                    
                    if horas_turno > 0:
                        # Verificar se j√° existe movimenta√ß√£o para este turno espec√≠fico
                        movimentacao_existente = BancoHoras.objects.filter(
                            militar=escala_militar.militar,
                            data_movimentacao=escala.data,
                            tipo_movimentacao='ENTRADA',
                            escala_militar=escala_militar
                        ).first()
                        
                        if movimentacao_existente:
                            # Atualizar movimenta√ß√£o existente
                            saldo_anterior = BancoHoras.calcular_saldo_militar(escala_militar.militar, escala.data)
                            saldo_atual = saldo_anterior + horas_turno
                            
                            movimentacao_existente.horas = horas_turno
                            movimentacao_existente.saldo_anterior = saldo_anterior
                            movimentacao_existente.saldo_atual = saldo_atual
                            movimentacao_existente.observacoes = f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}"
                            movimentacao_existente.save()
                            movimentacoes_atualizadas += 1
                        else:
                            # Criar nova movimenta√ß√£o para este turno
                            saldo_anterior = BancoHoras.calcular_saldo_militar(escala_militar.militar, escala.data)
                            saldo_atual = saldo_anterior + horas_turno
                            
                            BancoHoras.objects.create(
                                militar=escala_militar.militar,
                                data_movimentacao=escala.data,
                                tipo_movimentacao='ENTRADA',
                                horas=horas_turno,
                                saldo_anterior=saldo_anterior,
                                saldo_atual=saldo_atual,
                                escala=escala,
                                escala_militar=escala_militar,
                                observacoes=f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}",
                                criado_por=escala.criado_por
                            )
                            movimentacoes_criadas += 1
                        
            except Exception as e:
                print(f"Erro ao sincronizar turno para {escala_militar.militar.nome_completo}: {str(e)}")
                continue
        
        # Recalcular todos os saldos
        BancoHoras.recalcular_todos_saldos()
        
        total_movimentacoes = movimentacoes_criadas + movimentacoes_atualizadas
        
        return JsonResponse({
            'success': True,
            'message': f'Escala de abonar sincronizada com sucesso! {movimentacoes_criadas} movimenta√ß√µes criadas, {movimentacoes_atualizadas} atualizadas. Total: {total_movimentacoes} movimenta√ß√µes.',
            'resultado': {
                'movimentacoes_criadas': movimentacoes_criadas,
                'movimentacoes_atualizadas': movimentacoes_atualizadas,
                'total': total_movimentacoes
            }
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao sincronizar escala de abonar: {str(e)}'
        })


@login_required
def banco_horas_relatorio_pdf_militar(request):
    """Gerar relat√≥rio PDF do banco de horas por militar e ano"""
    from .models import BancoHoras, Militar
    from django.http import HttpResponse
    from django.template.loader import get_template
    from django.template import Context
    from datetime import datetime, timedelta
    from django.db.models import Sum
    from decimal import Decimal
    import io
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_militares
    from .permissoes_simples import obter_funcao_militar_ativa
    
    # Par√¢metros
    militar_id = request.GET.get('militar_id', '')
    ano = request.GET.get('ano', '')
    mes = request.GET.get('mes', '')
    funcao = request.GET.get('funcao', '')  # Fun√ß√£o para assinatura
    
    if not militar_id or not ano:
        return HttpResponse("Par√¢metros militar_id e ano s√£o obrigat√≥rios", status=400)
    
    try:
        militar = Militar.objects.get(id=militar_id)
        ano = int(ano)
    except (Militar.DoesNotExist, ValueError):
        return HttpResponse("Militar ou ano inv√°lido", status=400)
    
    # Aplicar filtro hier√°rquico
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        militares_permitidos = Militar.objects.exclude(situacao='INATIVO')
        militares_permitidos = aplicar_filtro_hierarquico_militares(militares_permitidos, funcao_usuario, request.user)
        if militar not in militares_permitidos:
            return HttpResponse("Acesso negado para este militar", status=403)
    
    # Buscar movimenta√ß√µes do militar no ano
    data_inicio_ano = datetime(ano, 1, 1).date()
    data_fim_ano = datetime(ano, 12, 31).date()
    
    # Se m√™s especificado, filtrar apenas esse m√™s
    if mes:
        try:
            mes_int = int(mes)
            data_inicio_ano = datetime(ano, mes_int, 1).date()
            if mes_int == 12:
                data_fim_ano = datetime(ano, 12, 31).date()
            else:
                data_fim_ano = datetime(ano, mes_int + 1, 1).date() - timedelta(days=1)
        except ValueError:
            pass  # Usar filtro do ano inteiro se m√™s inv√°lido
    
    movimentacoes = BancoHoras.objects.filter(
        militar=militar,
        data_movimentacao__gte=data_inicio_ano,
        data_movimentacao__lte=data_fim_ano
    ).order_by('data_movimentacao', 'id')
    
    # Calcular estat√≠sticas do ano
    entradas = movimentacoes.filter(
        tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
    ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
    
    saidas = movimentacoes.filter(
        tipo_movimentacao__in=['SAIDA', 'AJUSTE']
    ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
    
    saldo_ano = entradas - saidas
    
    # Calcular saldo por m√™s
    meses_stats = []
    
    if mes:
        # Se m√™s espec√≠fico foi selecionado, mostrar apenas esse m√™s
        mes_int = int(mes)
        data_inicio_mes = datetime(ano, mes_int, 1).date()
        if mes_int == 12:
            data_fim_mes = datetime(ano, 12, 31).date()
        else:
            data_fim_mes = datetime(ano, mes_int + 1, 1).date() - timedelta(days=1)
        
        mov_mes = movimentacoes.filter(
            data_movimentacao__gte=data_inicio_mes,
            data_movimentacao__lte=data_fim_mes
        )
        
        entradas_mes = mov_mes.filter(
            tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        saidas_mes = mov_mes.filter(
            tipo_movimentacao__in=['SAIDA', 'AJUSTE']
        ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
        
        saldo_mes = entradas_mes - saidas_mes
        
        meses_stats.append({
            'mes': mes_int,
            'nome_mes': datetime(ano, mes_int, 1).strftime('%B').title(),
            'entradas': entradas_mes,
            'saidas': saidas_mes,
            'saldo': saldo_mes,
            'movimentacoes': mov_mes.count()
        })
    else:
        # Se n√£o especificou m√™s, mostrar todos os 12 meses
        for mes in range(1, 13):
            data_inicio_mes = datetime(ano, mes, 1).date()
            if mes == 12:
                data_fim_mes = datetime(ano, 12, 31).date()
            else:
                data_fim_mes = datetime(ano, mes + 1, 1).date() - timedelta(days=1)
            
            mov_mes = movimentacoes.filter(
                data_movimentacao__gte=data_inicio_mes,
                data_movimentacao__lte=data_fim_mes
            )
            
            entradas_mes = mov_mes.filter(
                tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
            ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
            
            saidas_mes = mov_mes.filter(
                tipo_movimentacao__in=['SAIDA', 'AJUSTE']
            ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
            
            saldo_mes = entradas_mes - saidas_mes
            
            meses_stats.append({
                'mes': mes,
                'nome_mes': datetime(ano, mes, 1).strftime('%B').title(),
                'entradas': entradas_mes,
                'saidas': saidas_mes,
                'saldo': saldo_mes,
                'movimentacoes': mov_mes.count()
            })
    
    # Criar PDF
    response = HttpResponse(content_type='application/pdf')
    if mes:
        nome_mes = datetime(ano, int(mes), 1).strftime('%B').title()
        filename = f"banco_horas_{militar.nome_completo.replace(' ', '_')}_{nome_mes}_{ano}.pdf"
    else:
        filename = f"banco_horas_{militar.nome_completo.replace(' ', '_')}_{ano}.pdf"
    response['Content-Disposition'] = f'inline; filename="{filename}"'
    
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=1.5*cm, leftMargin=1.5*cm, topMargin=2*cm, bottomMargin=2*cm)
    
    # Estilos
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=16,
        spaceAfter=20,
        alignment=TA_CENTER,
        textColor=colors.black
    )
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=12)
    
    # Conte√∫do do PDF
    story = []
    
    # Logo/Bras√£o centralizado
    import os
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        from reportlab.platypus import Image
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Determinar lota√ß√£o do usu√°rio que est√° gerando o relat√≥rio
    lotacao_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        # Usar o n√≠vel de acesso da fun√ß√£o para determinar a lota√ß√£o
        if funcao_usuario.nivel_acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
            lotacao_geracao = funcao_usuario.sub_unidade.nome.upper()
        elif funcao_usuario.nivel_acesso == 'UNIDADE' and funcao_usuario.unidade:
            lotacao_geracao = funcao_usuario.unidade.nome.upper()
        elif funcao_usuario.nivel_acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
            lotacao_geracao = funcao_usuario.grande_comando.nome.upper()
        elif funcao_usuario.nivel_acesso == 'ORGAO' and funcao_usuario.orgao:
            lotacao_geracao = funcao_usuario.orgao.nome.upper()
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        lotacao_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))
    
    # T√≠tulo principal centralizado e sublinhado
    story.append(Paragraph("<u>BANCO DE HORAS</u>", title_style))
    story.append(Spacer(1, 20))
    
    # Dados do militar
    story.append(Paragraph(f"<b>Nome Completo:</b> {militar.nome_completo}", styles['Normal']))
    story.append(Paragraph(f"<b>Posto/Gradua√ß√£o:</b> {militar.get_posto_graduacao_display()} BM", styles['Normal']))
    story.append(Paragraph(f"<b>Matr√≠cula:</b> {militar.matricula}", styles['Normal']))
    story.append(Paragraph(f"<b>Situa√ß√£o:</b> {militar.get_situacao_display()}", styles['Normal']))
    
    if militar.lotacao_atual():
        story.append(Paragraph(f"<b>Lota√ß√£o Atual:</b> {militar.lotacao_atual().lotacao}", styles['Normal']))
    
    story.append(Spacer(1, 20))
    story.append(Spacer(1, 20))
    
    # Ano centralizado
    story.append(Paragraph(f"<b>Ano:</b> {ano}", style_center))
    story.append(Spacer(1, 10))
    
    # Calcular total de horas
    total_horas = sum(mes_stat['entradas'] for mes_stat in meses_stats)
    
    meses_data = [['M√™s', 'Horas']]
    for mes_stat in meses_stats:
        # Remover n√∫meros depois da v√≠rgula
        horas_sem_decimal = str(mes_stat['entradas']).split('.')[0]
        meses_data.append([
            mes_stat['nome_mes'],
            f"{horas_sem_decimal}h"
        ])
    
    # Adicionar linha de total
    total_horas_sem_decimal = str(total_horas).split('.')[0]
    meses_data.append([
        'TOTAL',
        f"{total_horas_sem_decimal}h"
    ])
    
    meses_table = Table(meses_data, colWidths=[3*inch, 2*inch])
    meses_table.setStyle(TableStyle([
        ('ALIGN', (0, 0), (0, -1), 'LEFT'),  # Justificar meses √† esquerda
        ('ALIGN', (1, 0), (1, -1), 'CENTER'),  # Centralizar horas
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, -1), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 8),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        # Destacar linha de total
        ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
        ('FONTSIZE', (0, -1), (-1, -1), 12)
    ]))
    
    story.append(meses_table)
    story.append(Spacer(1, 20))
    
    
    # Rodap√©
    story.append(Spacer(1, 30))
    story.append(Paragraph(f"Relat√≥rio gerado em: {datetime.now().strftime('%d/%m/%Y √†s %H:%M')}", 
                          ParagraphStyle('Footer', parent=styles['Normal'], fontSize=8, alignment=TA_RIGHT)))
    
    # Adicionar assinatura eletr√¥nica se fun√ß√£o fornecida
    if funcao:
        story.append(Spacer(1, 1*cm))
        
        # Obter assinante (usu√°rio logado)
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            nome_assinante = militar_logado.nome_completo if militar_logado else request.user.get_full_name() or request.user.username
        except:
            nome_assinante = request.user.get_full_name() or request.user.username
        
        # Data por extenso - usar timezone de Bras√≠lia
        from django.utils import timezone
        import pytz
        brasilia_tz = pytz.timezone('America/Sao_Paulo')
        data_atual = timezone.now().astimezone(brasilia_tz) if timezone.is_aware(timezone.now()) else brasilia_tz.localize(timezone.now())
        
        meses_extenso = {
            1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
            5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
            9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
        }
        data_formatada_extenso = f"{data_atual.day} de {meses_extenso[data_atual.month]} de {data_atual.year}"
        
        # Fun√ß√£o selecionada
        funcao_display = funcao if funcao else "Operador de Banco de Horas"
        
        # Construir texto
        texto_info = f"Teresina - PI, {data_formatada_extenso}.<br/><br/>{nome_assinante}<br/>{funcao_display}"
        
        # Estilo para o texto
        style_info = ParagraphStyle('info', parent=styles['Normal'], fontSize=9, fontName='Helvetica', 
                                     alignment=1, textColor=colors.HexColor('#2c3e50'), spaceAfter=8,
                                     leading=12)
        
        story.append(Paragraph(texto_info, style_info))
        
        # Adicionar assinatura eletr√¥nica
        from .utils import obter_caminho_assinatura_eletronica
        
        story.append(Spacer(1, 0.5*cm))
        
        # Data e hora formatadas
        from .utils import formatar_data_assinatura
        data_formatada, hora_formatada = formatar_data_assinatura(data_atual)
        
        # Texto da assinatura eletr√¥nica
        texto_assinatura = (
            f"Documento assinado eletronicamente por {nome_assinante}, em {data_formatada} {hora_formatada}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Estilo para texto justificado
        style_assinatura_texto = ParagraphStyle('assinatura_texto', parent=styles['Normal'], fontSize=10, fontName='Helvetica', alignment=4, spaceAfter=1, spaceBefore=1, leading=14)
        
        # Tabela das assinaturas: Logo + Texto de assinatura
        # Largura ajustada para ter margem de 0,02cm de cada lado (largura total - 0,04cm)
        largura_disponivel = A4[0] - (1.5*inch * 2) - 0.04*inch  # total - margens documento - margem extra 0,02cm cada lado
        largura_texto = largura_disponivel - 2.5*inch  # menos logo
        
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=2.5*inch, height=1.8*inch), Paragraph(texto_assinatura, style_assinatura_texto)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[2.5*inch, largura_texto])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('LEFTPADDING', (0, 0), (0, -1), 0),  # Logo sem padding esquerdo
            ('LEFTPADDING', (1, 0), (1, -1), 15),  # Texto com padding esquerdo para afastar da logo
            ('RIGHTPADDING', (0, 0), (-1, -1), 0),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('BOX', (0, 0), (-1, -1), 1, colors.grey),  # Borda do ret√¢ngulo
        ]))
        
        story.append(assinatura_table)
    
    # Construir PDF
    doc.build(story)
    pdf = buffer.getvalue()
    buffer.close()
    response.write(pdf)
    
    return response


def gerar_relatorio_pdf_completo(request, ano, mes):
    """Gerar relat√≥rio PDF completo do banco de horas - todos os militares por m√™s"""
    from .models import BancoHoras, Militar
    from django.http import HttpResponse
    from datetime import datetime, timedelta
    from django.db.models import Sum
    from decimal import Decimal
    import io
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_militares
    from .permissoes_simples import obter_funcao_militar_ativa
    
    if not ano:
        return HttpResponse("Par√¢metro ano √© obrigat√≥rio", status=400)
    
    try:
        ano = int(ano)
    except ValueError:
        return HttpResponse("Ano inv√°lido", status=400)
    
    # Definir hierarquia de postos para ordena√ß√£o
    HIERARQUIA_POSTOS = {
        'CB': 1,    # Coronel
        'TC': 2,    # Tenente Coronel
        'MJ': 3,    # Major
        'CP': 4,    # Capit√£o
        '1T': 5,    # 1¬∫ Tenente
        '2T': 6,    # 2¬∫ Tenente
        'AS': 7,    # Aspirante a Oficial
        'AA': 8,    # Aluno de Adapta√ß√£o
        'NVRR': 9,  # Navegador
        'ST': 10,   # Subtenente
        '1S': 11,   # 1¬∫ Sargento
        '2S': 12,   # 2¬∫ Sargento
        '3S': 13,   # 3¬∫ Sargento
        'CAB': 14,  # Cabo
        'SD': 15,   # Soldado
    }
    
    # Buscar todos os militares ativos
    todos_militares = Militar.objects.exclude(situacao='INATIVO')
    
    # Aplicar filtro hier√°rquico
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        todos_militares = aplicar_filtro_hierarquico_militares(todos_militares, funcao_usuario, request.user)
    
    # Ordenar militares por hierarquia
    militares_ordenados = sorted(todos_militares, key=lambda m: (
        HIERARQUIA_POSTOS.get(m.posto_graduacao, 999),
        m.numeracao_antiguidade or 999,
        m.nome_completo
    ))
    
    # Criar PDF
    response = HttpResponse(content_type='application/pdf')
    if mes:
        nome_mes = datetime(ano, int(mes), 1).strftime('%B').title()
        filename = f"banco_horas_completo_{nome_mes}_{ano}.pdf"
        titulo_periodo = f"Relat√≥rio Completo - {nome_mes} de {ano}"
    else:
        filename = f"banco_horas_completo_{ano}.pdf"
        titulo_periodo = f"Relat√≥rio Completo - Ano {ano}"
    
    response['Content-Disposition'] = f'inline; filename="{filename}"'
    
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=1.5*cm, leftMargin=1.5*cm, topMargin=2*cm, bottomMargin=2*cm)
    
    # Estilos
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=16,
        spaceAfter=20,
        alignment=TA_CENTER,
        textColor=colors.black
    )
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=1, fontSize=12)
    
    # Conte√∫do do PDF
    story = []
    
    # Logo/Bras√£o centralizado
    import os
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        from reportlab.platypus import Image
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Determinar lota√ß√£o do usu√°rio que est√° gerando o relat√≥rio
    lotacao_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    if funcao_usuario:
        # Usar o n√≠vel de acesso da fun√ß√£o para determinar a lota√ß√£o
        if funcao_usuario.nivel_acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
            lotacao_geracao = funcao_usuario.sub_unidade.nome.upper()
        elif funcao_usuario.nivel_acesso == 'UNIDADE' and funcao_usuario.unidade:
            lotacao_geracao = funcao_usuario.unidade.nome.upper()
        elif funcao_usuario.nivel_acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
            lotacao_geracao = funcao_usuario.grande_comando.nome.upper()
        elif funcao_usuario.nivel_acesso == 'ORGAO' and funcao_usuario.orgao:
            lotacao_geracao = funcao_usuario.orgao.nome.upper()
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        lotacao_geracao,
        "Av. Miguel Rosa, 3515 - Bairro Pi√ßarra, Teresina/PI, CEP 64001-490",
        "Telefone: (86)3216-1264 - http://www.cbm.pi.gov.br"
    ]
    
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    
    story.append(Spacer(1, 10))
    
    # T√≠tulo principal centralizado e sublinhado
    story.append(Paragraph(f"<u>{titulo_periodo}</u>", title_style))
    story.append(Spacer(1, 16))
    
    if mes:
        # Relat√≥rio de m√™s espec√≠fico
        mes_int = int(mes)
        data_inicio_mes = datetime(ano, mes_int, 1).date()
        if mes_int == 12:
            data_fim_mes = datetime(ano, 12, 31).date()
        else:
            data_fim_mes = datetime(ano, mes_int + 1, 1).date() - timedelta(days=1)
        
        # Tabela de militares para o m√™s
        dados_tabela = [['POSTO', 'NOME', 'H/M√äS']]
        
        for militar in militares_ordenados:
            # Buscar movimenta√ß√µes do militar no m√™s
            movimentacoes_mes = BancoHoras.objects.filter(
                militar=militar,
                data_movimentacao__gte=data_inicio_mes,
                data_movimentacao__lte=data_fim_mes
            )
            
            # Calcular horas do m√™s
            entradas_mes = movimentacoes_mes.filter(
                tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
            ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
            
            saidas_mes = movimentacoes_mes.filter(
                tipo_movimentacao__in=['SAIDA', 'AJUSTE']
            ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
            
            horas_mes = entradas_mes - saidas_mes
            
            dados_tabela.append([
                militar.get_posto_graduacao_display(),
                militar.nome_completo,
                f"{horas_mes:.0f}h"
            ])
        
        # Criar tabela
        tabela = Table(dados_tabela, colWidths=[4*cm, 8*cm, 3*cm])
        tabela.setStyle(TableStyle([
            ('ALIGN', (0, 0), (0, -1), 'LEFT'),  # POSTO - justificado √† esquerda
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),  # NOME - justificado √† esquerda
            ('ALIGN', (2, 0), (2, -1), 'CENTER'), # H/M√äS - centralizado
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 10),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTSIZE', (0, 1), (-1, -1), 8),
        ]))
        
        story.append(tabela)
        
    else:
        # Relat√≥rio de ano todo - mostrar por m√™s
        meses_nomes = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ]
        
        for mes_num in range(1, 13):
            # Cabe√ßalho do m√™s
            story.append(PageBreak() if mes_num > 1 else Spacer(1, 20))
            story.append(Paragraph(f"<b>{meses_nomes[mes_num-1]} de {ano}</b>", title_style))
            story.append(Spacer(1, 10))
            
            # Calcular per√≠odo do m√™s
            data_inicio_mes = datetime(ano, mes_num, 1).date()
            if mes_num == 12:
                data_fim_mes = datetime(ano, 12, 31).date()
            else:
                data_fim_mes = datetime(ano, mes_num + 1, 1).date() - timedelta(days=1)
            
            # Tabela de militares para o m√™s
            dados_tabela = [['POSTO', 'NOME', 'H/M√äS']]
            
            for militar in militares_ordenados:
                # Buscar movimenta√ß√µes do militar no m√™s
                movimentacoes_mes = BancoHoras.objects.filter(
                    militar=militar,
                    data_movimentacao__gte=data_inicio_mes,
                    data_movimentacao__lte=data_fim_mes
                )
                
                # Calcular horas do m√™s
                entradas_mes = movimentacoes_mes.filter(
                    tipo_movimentacao__in=['ENTRADA', 'COMPENSACAO']
                ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
                
                saidas_mes = movimentacoes_mes.filter(
                    tipo_movimentacao__in=['SAIDA', 'AJUSTE']
                ).aggregate(total=Sum('horas'))['total'] or Decimal('0')
                
                horas_mes = entradas_mes - saidas_mes
                
                dados_tabela.append([
                    militar.get_posto_graduacao_display(),
                    militar.nome_completo,
                    f"{horas_mes:.0f}h"
                ])
            
            # Criar tabela
            tabela = Table(dados_tabela, colWidths=[4*cm, 8*cm, 3*cm])
            tabela.setStyle(TableStyle([
                ('ALIGN', (0, 0), (0, -1), 'LEFT'),  # POSTO - justificado √† esquerda
                ('ALIGN', (1, 0), (1, -1), 'LEFT'),  # NOME - justificado √† esquerda
                ('ALIGN', (2, 0), (2, -1), 'CENTER'), # H/M√äS - centralizado
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('FONTSIZE', (0, 1), (-1, -1), 8),
            ]))
            
            story.append(tabela)
    
    # Rodap√©
    story.append(Spacer(1, 30))
    story.append(Paragraph(f"Relat√≥rio gerado em: {datetime.now().strftime('%d/%m/%Y √†s %H:%M')}", 
                          ParagraphStyle('Footer', parent=styles['Normal'], fontSize=8, alignment=TA_RIGHT)))
    
    # Construir PDF
    doc.build(story)
    pdf = buffer.getvalue()
    buffer.close()
    response.write(pdf)
    
    return response


@login_required
def escalas_operacoes(request):
    """Opera√ß√µes das escalas de servi√ßo"""
    from .models import OperacaoEscala
    from django.contrib import messages
    from django.core.paginator import Paginator
    
    # Filtros
    search = request.GET.get('search', '')
    tipo = request.GET.get('tipo', '')
    
    # Query base
    operacoes = OperacaoEscala.objects.all().order_by('-data_inicio')
    
    # Aplicar filtros
    if search:
        operacoes = operacoes.filter(
            nome__icontains=search
        )
    
    if tipo:
        operacoes = operacoes.filter(tipo=tipo)
    
    # Pagina√ß√£o
    paginator = Paginator(operacoes, 31)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'page_obj': page_obj,
        'search': search,
        'tipo': tipo,
        'tipos': OperacaoEscala.TIPO_CHOICES,
    }
    
    return render(request, 'militares/escalas/escalas_operacoes.html', context)


@login_required
def funcoes_militares_list(request):
    """Lista todas as fun√ß√µes militares"""
    funcoes = FuncaoMilitar.objects.all().order_by('ordem', 'nome')
    
    # Aplicar filtros
    grupo_filtro = request.GET.get('grupo')
    if grupo_filtro:
        funcoes = funcoes.filter(grupo=grupo_filtro)
    
    status_filtro = request.GET.get('status')
    if status_filtro == 'ativo':
        funcoes = funcoes.filter(ativo=True)
    elif status_filtro == 'inativo':
        funcoes = funcoes.filter(ativo=False)
    
    # Pesquisa por nome
    pesquisa = request.GET.get('pesquisa')
    if pesquisa:
        funcoes = funcoes.filter(nome__icontains=pesquisa)
    
    # Estat√≠sticas
    total_funcoes = FuncaoMilitar.objects.count()
    funcoes_ativas = FuncaoMilitar.objects.filter(ativo=True).count()
    funcoes_inativas = FuncaoMilitar.objects.filter(ativo=False).count()
    
    context = {
        'funcoes': funcoes,
        'total_funcoes': total_funcoes,
        'funcoes_ativas': funcoes_ativas,
        'funcoes_inativas': funcoes_inativas,
        'grupo_filtro': grupo_filtro,
        'status_filtro': status_filtro,
        'pesquisa': pesquisa,
        'title': 'Fun√ß√µes Militares',
    }
    return render(request, 'militares/funcoes/funcoes_militares_list.html', context)


@login_required
@administracao_required
def funcoes_militares_create(request):
    """Cria uma nova fun√ß√£o militar com sistema de permiss√µes - apenas administradores do sistema"""
    from .models import PermissaoFuncao, FuncaoMenuConfig
    
    if request.method == 'POST':
        form = FuncaoMilitarForm(request.POST)
        if form.is_valid():
            funcao = form.save()
            
            # Criar configura√ß√£o de menu padr√£o baseada no grupo
            menu_config = FuncaoMenuConfig.objects.create(
                funcao_militar=funcao,
                ativo=True
            )
            
            # Processar permiss√µes do formul√°rio
            # Campos de menu principal
            menu_fields = [
                'show_dashboard', 'show_efetivo', 'show_secao_promocoes', 
                'show_medalhas', 'show_administracao', 'show_notas'
            ]
            
            # Atualizar campos de menu
            for field in menu_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            menu_config.save()
            
            # Limpar permiss√µes de submenu existentes
            PermissaoFuncao.objects.filter(funcao_militar=funcao).delete()
            
            # Mapear campos do formul√°rio para m√≥dulos
            submenu_mapping = {
                'show_ativos': 'SUBMENU_ATIVOS',
                'show_inativos': 'SUBMENU_INATIVOS',
                'show_lotacoes': 'SUBMENU_LOTACOES',
                'show_fichas_oficiais': 'SUBMENU_FICHAS_OFICIAIS',
                'show_fichas_pracas': 'SUBMENU_FICHAS_PRACAS',
                'show_quadros_acesso': 'SUBMENU_QUADROS_ACESSO',
                'show_quadros_fixacao': 'SUBMENU_QUADROS_FIXACAO',
                'show_almanaques': 'SUBMENU_ALMANAQUES',
                'show_promocoes': 'SUBMENU_PROMOCOES',
                'show_calendarios': 'SUBMENU_CALENDARIOS',
                'show_comissoes': 'SUBMENU_COMISSOES',
                'show_meus_votos': 'SUBMENU_MEUS_VOTOS',
                'show_intersticios': 'SUBMENU_INTERSTICIOS',
                'show_gerenciar_intersticios': 'SUBMENU_GERENCIAR_INTERSTICIOS',
                'show_gerenciar_previsao': 'SUBMENU_GERENCIAR_PREVISAO',
                'show_medalhas_concessoes': 'SUBMENU_MEDALHAS_CONCESSOES',
                'show_medalhas_propostas': 'SUBMENU_MEDALHAS_PROPOSTAS',
                'show_elegiveis': 'SUBMENU_ELEGIVEIS',
                'show_propostas': 'SUBMENU_PROPOSTAS',
                'notas_visualizar': 'NOTAS_VISUALIZAR',
                'notas_criar': 'NOTAS_CRIAR',
                'notas_editar': 'NOTAS_EDITAR',
                'notas_lista': 'SUBMENU_NOTAS_LISTA',
                'notas_excluir': 'NOTAS_EXCLUIR',
                'show_usuarios': 'SUBMENU_USUARIOS',
                'show_permissoes': 'SUBMENU_PERMISSOES',
                'show_logs': 'SUBMENU_LOGS',
                'show_administracao': 'SUBMENU_ADMINISTRACAO',
                'show_planejadas': 'MENU_PLANEJADAS',
                'show_operador_planejadas': 'SUBMENU_OPERADOR_PLANEJADAS',
                'show_fiscal_planejadas': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Mapear permiss√µes espec√≠ficas de a√ß√µes
            acoes_mapping = {
                # Ativos
                'ativos_visualizar': 'ATIVOS_VISUALIZAR',
                'ativos_criar': 'ATIVOS_CRIAR',
                'ativos_editar': 'ATIVOS_EDITAR',
                'ativos_excluir': 'ATIVOS_EXCLUIR',
                'ativos_transferir': 'ATIVOS_TRANSFERIR',
                'ativos_promover': 'ATIVOS_PROMOVER',
                'ativos_inativar': 'ATIVOS_INATIVAR',
                'ativos_ficha_conceito': 'ATIVOS_FICHA_CONCEITO',
                'ativos_exportar': 'ATIVOS_EXPORTAR',
                'ativos_dashboard': 'ATIVOS_DASHBOARD',
                'ativos_reordenar': 'ATIVOS_REORDENAR',
                
                # Inativos
                'inativos_visualizar': 'INATIVOS_VISUALIZAR',
                'inativos_editar': 'INATIVOS_EDITAR',
                'inativos_excluir': 'INATIVOS_EXCLUIR',
                'inativos_reativar': 'INATIVOS_REATIVAR',
                
                # Lota√ß√µes
                'lotacoes_visualizar': 'LOTACOES_VISUALIZAR',
                'lotacoes_criar': 'LOTACOES_CRIAR',
                'lotacoes_editar': 'LOTACOES_EDITAR',
                'lotacoes_excluir': 'LOTACOES_EXCLUIR',
                
                # Bot√µes granulares - Lota√ß√µes
                'botao_lotacao_nova': 'BOTAO_LOTACAO_NOVA',
                'botao_lotacao_editar': 'BOTAO_LOTACAO_EDITAR',
                'botao_lotacao_excluir': 'BOTAO_LOTACAO_EXCLUIR',
                'botao_lotacao_estatisticas': 'BOTAO_LOTACAO_ESTATISTICAS',
                
                
                # Bot√µes granulares - Publica√ß√µes
                'botao_publicacao_nova': 'BOTAO_PUBLICACAO_NOVA',
                'botao_publicacao_editar': 'BOTAO_PUBLICACAO_EDITAR',
                'botao_publicacao_publicar': 'BOTAO_PUBLICACAO_PUBLICAR',
                'botao_publicacao_assinar': 'BOTAO_PUBLICACAO_ASSINAR',
                
                # Detalhes do Militar
                'detail_fichas_conceito': 'DETAIL_FICHAS_CONCEITO',
                'detail_punicoes': 'DETAIL_PUNICOES',
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Oficiais
                'fichas_oficiais_visualizar': 'FICHAS_OFICIAIS_VISUALIZAR',
                'fichas_oficiais_criar': 'FICHAS_OFICIAIS_CRIAR',
                'fichas_oficiais_editar': 'FICHAS_OFICIAIS_EDITAR',
                'fichas_oficiais_excluir': 'FICHAS_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Pra√ßas
                'fichas_pracas_visualizar': 'FICHAS_PRACAS_VISUALIZAR',
                'fichas_pracas_criar': 'FICHAS_PRACAS_CRIAR',
                'fichas_pracas_editar': 'FICHAS_PRACAS_EDITAR',
                'fichas_pracas_excluir': 'FICHAS_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Calend√°rios
                'calendarios_visualizar': 'CALENDARIOS_VISUALIZAR',
                'calendarios_criar': 'CALENDARIOS_CRIAR',
                'calendarios_editar': 'CALENDARIOS_EDITAR',
                'calendarios_excluir': 'CALENDARIOS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Fixa√ß√£o
                'quadros_fixacao_visualizar': 'QUADROS_FIXACAO_VISUALIZAR',
                'quadros_fixacao_criar': 'QUADROS_FIXACAO_CRIAR',
                'quadros_fixacao_editar': 'QUADROS_FIXACAO_EDITAR',
                'quadros_fixacao_excluir': 'QUADROS_FIXACAO_EXCLUIR',
                'quadros_fixacao_assinar': 'QUADROS_FIXACAO_ASSINAR',
                'quadros_fixacao_gerar_pdf': 'QUADROS_FIXACAO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Acesso
                'quadros_acesso_visualizar': 'QUADROS_ACESSO_VISUALIZAR',
                'quadros_acesso_criar': 'QUADROS_ACESSO_CRIAR',
                'quadros_acesso_editar': 'QUADROS_ACESSO_EDITAR',
                'quadros_acesso_excluir': 'QUADROS_ACESSO_EXCLUIR',
                'quadros_acesso_assinar': 'QUADROS_ACESSO_ASSINAR',
                'quadros_acesso_homologar': 'QUADROS_ACESSO_HOMOLOGAR',
                'quadros_acesso_deshomologar': 'QUADROS_ACESSO_DESHOMOLOGAR',
                'quadros_acesso_elaborar': 'QUADROS_ACESSO_ELABORAR',
                'quadros_acesso_regenerar': 'QUADROS_ACESSO_REGENERAR',
                'quadros_acesso_gerar_pdf': 'QUADROS_ACESSO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes (gen√©ricas)
                'comissoes_visualizar': 'COMISSOES_VISUALIZAR',
                'comissoes_criar': 'COMISSOES_CRIAR',
                'comissoes_editar': 'COMISSOES_EDITAR',
                'comissoes_excluir': 'COMISSOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Oficiais
                'comissoes_oficiais_visualizar': 'COMISSOES_OFICIAIS_VISUALIZAR',
                'comissoes_oficiais_criar': 'COMISSOES_OFICIAIS_CRIAR',
                'comissoes_oficiais_editar': 'COMISSOES_OFICIAIS_EDITAR',
                'comissoes_oficiais_excluir': 'COMISSOES_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Pra√ßas
                'comissoes_pracas_visualizar': 'COMISSOES_PRACAS_VISUALIZAR',
                'comissoes_pracas_criar': 'COMISSOES_PRACAS_CRIAR',
                'comissoes_pracas_editar': 'COMISSOES_PRACAS_EDITAR',
                'comissoes_pracas_excluir': 'COMISSOES_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Meus Votos
                'meus_votos_visualizar': 'MEUS_VOTOS_VISUALIZAR',
                'meus_votos_votar': 'MEUS_VOTOS_VOTAR',
                
                # Se√ß√£o de Promo√ß√µes - Promo√ß√µes
                'promocoes_visualizar': 'PROMOCOES_VISUALIZAR',
                'promocoes_criar': 'PROMOCOES_CRIAR',
                'promocoes_editar': 'PROMOCOES_EDITAR',
                'promocoes_excluir': 'PROMOCOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Almanaques
                'almanaques_visualizar': 'ALMANAQUES_VISUALIZAR',
                'almanaques_criar': 'ALMANAQUES_CRIAR',
                'almanaques_editar': 'ALMANAQUES_EDITAR',
                'almanaques_excluir': 'ALMANAQUES_EXCLUIR',
                'almanaques_assinar': 'ALMANAQUES_ASSINAR',
                'almanaques_gerar_pdf': 'ALMANAQUES_GERAR_PDF',
                
                # Medalhas - Concess√µes
                'medalhas_concessoes_visualizar': 'MEDALHAS_CONCESSOES_VISUALIZAR',
                'medalhas_concessoes_criar': 'MEDALHAS_CONCESSOES_CRIAR',
                'medalhas_concessoes_editar': 'MEDALHAS_CONCESSOES_EDITAR',
                'medalhas_concessoes_excluir': 'MEDALHAS_CONCESSOES_EXCLUIR',
                
                # Medalhas - Propostas
                'medalhas_propostas_visualizar': 'MEDALHAS_PROPOSTAS_VISUALIZAR',
                'medalhas_propostas_criar': 'MEDALHAS_PROPOSTAS_CRIAR',
                'medalhas_propostas_editar': 'MEDALHAS_PROPOSTAS_EDITAR',
                'medalhas_propostas_excluir': 'MEDALHAS_PROPOSTAS_EXCLUIR',
                
                # Medalhas - Eleg√≠veis
                'elegiveis_visualizar': 'ELEGIVEIS_VISUALIZAR',
                'elegiveis_gerar': 'ELEGIVEIS_GERAR',
                'elegiveis_exportar': 'ELEGIVEIS_EXPORTAR',
                
                # Medalhas - Propostas (Lista)
                'propostas_visualizar': 'PROPOSTAS_VISUALIZAR',
                'propostas_criar': 'PROPOSTAS_CRIAR',
                'propostas_editar': 'PROPOSTAS_EDITAR',
                'propostas_excluir': 'PROPOSTAS_EXCLUIR',
                
                # Configura√ß√µes - Usu√°rios
                'usuarios_visualizar': 'USUARIOS_VISUALIZAR',
                'usuarios_criar': 'USUARIOS_CRIAR',
                'usuarios_editar': 'USUARIOS_EDITAR',
                'usuarios_excluir': 'USUARIOS_EXCLUIR',
                
                # Configura√ß√µes - Permiss√µes
                'permissoes_visualizar': 'PERMISSOES_VISUALIZAR',
                'permissoes_editar': 'PERMISSOES_EDITAR',
                'permissoes_administrar': 'PERMISSOES_ADMINISTRAR',
                
                # Configura√ß√µes - Logs
                'logs_visualizar': 'LOGS_VISUALIZAR',
                'logs_exportar': 'LOGS_EXPORTAR',
                'logs_limpar': 'LOGS_LIMPAR',
                
                # Planejadas
                'PLANEJADAS_VISUALIZAR': 'PLANEJADAS_VISUALIZAR',
                'PLANEJADAS_CRIAR': 'PLANEJADAS_CRIAR',
                'PLANEJADAS_EDITAR': 'PLANEJADAS_EDITAR',
                'PLANEJADAS_EXCLUIR': 'PLANEJADAS_EXCLUIR',
                'PLANEJADAS_ADICIONAR_MILITAR': 'PLANEJADAS_ADICIONAR_MILITAR',
                'PLANEJADAS_REMOVER_MILITAR': 'PLANEJADAS_REMOVER_MILITAR',
                'PLANEJADAS_ASSINAR_OPERADOR': 'PLANEJADAS_ASSINAR_OPERADOR',
                'PLANEJADAS_ASSINAR_FISCAL': 'PLANEJADAS_ASSINAR_FISCAL',
                'MENU_PLANEJADAS': 'MENU_PLANEJADAS',
                'SUBMENU_PLANEJADAS': 'SUBMENU_PLANEJADAS',
                'SUBMENU_OPERADOR_PLANEJADAS': 'SUBMENU_OPERADOR_PLANEJADAS',
                'SUBMENU_FISCAL_PLANEJADAS': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Criar permiss√µes de submenu
            permissoes_criadas = 0
            for campo_form, modulo in submenu_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='VISUALIZAR',
                        ativo=True
                    )
                    permissoes_criadas += 1
            
            # Criar permiss√µes espec√≠ficas de a√ß√µes
            acoes_criadas = 0
            for campo_form, modulo in acoes_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='EXECUTAR',
                        ativo=True
                    )
                    acoes_criadas += 1
            
            # Se n√£o foram selecionadas permiss√µes espec√≠ficas, aplicar configura√ß√£o padr√£o por grupo
            if permissoes_criadas == 0:
                aplicar_configuracoes_por_grupo(funcao, menu_config)
            
            messages.success(
                request, 
                f'Fun√ß√£o militar "{funcao.nome}" criada com sucesso! '
                f'Configurados {len([f for f in menu_fields if f in request.POST])} menus principais '
                f'e {permissoes_criadas} submenus com {acoes_criadas} a√ß√µes espec√≠ficas.'
            )
            return redirect('militares:funcoes_militares_list')
        else:
            messages.error(request, 'Por favor, corrija os erros no formul√°rio.')
    else:
        form = FuncaoMilitarForm()
    
    context = {
        'form': form,
        'action': 'Nova',
        'title': 'Nova Fun√ß√£o Militar',
    }
    return render(request, 'militares/funcoes/funcoes_militares_form.html', context)


def funcoes_militares_detail(request, funcao_id):
    """Exibe os detalhes de uma fun√ß√£o militar"""
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    # Buscar usu√°rios que possuem esta fun√ß√£o
    usuarios_com_funcao = UsuarioFuncaoMilitar.objects.filter(
        funcao_militar__nome__icontains=funcao.nome
    ).select_related('usuario', 'funcao_militar')
    
    # Estat√≠sticas da fun√ß√£o
    total_usuarios = usuarios_com_funcao.count()
    usuarios_ativos = usuarios_com_funcao.filter(ativo=True).count()
    usuarios_inativos = usuarios_com_funcao.filter(ativo=False).count()
    
    # Hist√≥rico de altera√ß√µes (se houver)
    historico_alteracoes = []
    if funcao.data_atualizacao != funcao.data_criacao:
        historico_alteracoes.append({
            'data': funcao.data_atualizacao,
            'acao': '√öltima atualiza√ß√£o',
            'descricao': 'Fun√ß√£o foi modificada'
        })
    
    # Buscar militares que t√™m esta fun√ß√£o e seus afastamentos
    from .models import MilitarFuncao, Afastamento
    militares_com_funcao = Militar.objects.filter(
        funcoes__funcao_militar=funcao,
        funcoes__ativo=True,
        funcoes__status='ATUAL'
    ).distinct()
    
    # Buscar todos os afastamentos dos militares que t√™m esta fun√ß√£o
    afastamentos_funcao = Afastamento.objects.filter(
        militar__in=militares_com_funcao
    ).order_by('-data_inicio', '-data_cadastro')
    
    # Separar afastamentos ativos dos encerrados
    afastamentos_ativos = afastamentos_funcao.filter(status='ATIVO')
    afastamentos_encerrados = afastamentos_funcao.filter(status='ENCERRADO')
    afastamentos_cancelados = afastamentos_funcao.filter(status='CANCELADO')
    
    context = {
        'funcao': funcao,
        'usuarios_com_funcao': usuarios_com_funcao[:10],  # Limitar a 10 para performance
        'total_usuarios': total_usuarios,
        'usuarios_ativos': usuarios_ativos,
        'usuarios_inativos': usuarios_inativos,
        'historico_alteracoes': historico_alteracoes,
        'militares_com_funcao': militares_com_funcao,
        'afastamentos_funcao': afastamentos_funcao[:20],  # Limitar a 20 mais recentes
        'afastamentos_ativos': afastamentos_ativos,
        'afastamentos_encerrados': afastamentos_encerrados,
        'afastamentos_cancelados': afastamentos_cancelados,
        'total_afastamentos': afastamentos_funcao.count(),
        'title': f'Detalhes da Fun√ß√£o: {funcao.nome}',
    }
    return render(request, 'militares/funcoes/funcoes_militares_detail.html', context)


@login_required
@administracao_required
def funcoes_militares_update(request, funcao_id):
    """Edita uma fun√ß√£o militar com sistema de permiss√µes integrado - apenas administradores do sistema"""
    from .models import PermissaoFuncao, FuncaoMenuConfig
    
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    if request.method == 'POST':
        form = FuncaoMilitarForm(request.POST, instance=funcao)
        if form.is_valid():
            funcao = form.save()
            
            # Criar ou atualizar configura√ß√£o de menu
            menu_config, created = FuncaoMenuConfig.objects.get_or_create(
                funcao_militar=funcao,
                defaults={'ativo': True}
            )
            
            # Processar permiss√µes do formul√°rio
            # Campos de menu principal
            menu_principal_fields = [
                'show_dashboard', 'show_efetivo', 'show_publicacoes', 
                'show_escalas', 'show_secao_promocoes', 'show_medalhas', 'show_configuracoes'
            ]
            
            # Campos de submenu - Efetivo
            submenu_efetivo_fields = [
                'show_ativos', 'show_inativos', 'show_lotacoes'
            ]
            
            # Campos de submenu - Publica√ß√µes
            submenu_publicacoes_fields = [
                'show_notas', 'show_boletins_ostensivos', 'show_boletins_reservados',
                'show_boletins_especiais'
            ]
            
            # Campos de submenu - Escalas de Servi√ßo
            submenu_escalas_fields = [
                'show_escalas_dashboard', 'show_escalas_lista', 'show_escalas_configuracao',
                'show_escalas_banco_horas', 'show_escalas_operacoes'
            ]
            
            # Campos de submenu - Se√ß√£o de Promo√ß√µes
            submenu_promocoes_fields = [
                'show_fichas_oficiais', 'show_fichas_pracas', 'show_calendarios',
                'show_quadros_fixacao', 'show_quadros_acesso', 'show_comissoes',
                'show_meus_votos', 'show_promocoes', 'show_almanaques'
            ]
            
            # Campos de submenu - Medalhas
            submenu_medalhas_fields = [
                'show_medalhas_concessoes', 'show_medalhas_propostas', 
                'show_elegiveis', 'show_propostas'
            ]
            
            # Campos de submenu - Configura√ß√µes
            submenu_configuracoes_fields = [
                'show_intersticios', 'show_gerenciar_intersticios', 'show_gerenciar_previsao',
                'show_usuarios', 'show_permissoes', 'show_logs', 
                'show_titulos_publicacao', 'show_administracao'
            ]
            
            # Campos de submenu - Planejadas
            submenu_planejadas_fields = [
                'show_planejadas', 'show_operador_planejadas', 'show_fiscal_planejadas'
            ]
            
            # Atualizar campos de menu principal
            for field in menu_principal_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Efetivo
            for field in submenu_efetivo_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Publica√ß√µes
            for field in submenu_publicacoes_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Escalas de Servi√ßo
            for field in submenu_escalas_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Se√ß√£o de Promo√ß√µes
            for field in submenu_promocoes_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Medalhas
            for field in submenu_medalhas_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Configura√ß√µes
            for field in submenu_configuracoes_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            # Atualizar campos de submenu - Planejadas
            for field in submenu_planejadas_fields:
                valor = field in request.POST
                setattr(menu_config, field, valor)
            
            menu_config.save()
            
            # Verificar se h√° campos de permiss√µes granulares no formul√°rio
            # Se houver, processar permiss√µes (adicionar/remover/manter)
            campos_permissoes_granulares = [
                # Campos de submenu
                'show_ativos', 'show_inativos', 'show_lotacoes',
                'show_efetivo_elogios', 'show_efetivo_punicoes',
                'show_escalas_dashboard', 'show_escalas_lista', 'show_escalas_configuracao',
                'show_escalas_banco_horas', 'show_escalas_operacoes',
                'show_fichas_oficiais', 'show_fichas_pracas', 'show_calendarios',
                'show_quadros_fixacao', 'show_quadros_acesso', 'show_comissoes',
                'show_meus_votos', 'show_promocoes', 'show_almanaques',
                'show_medalhas_concessoes', 'show_medalhas_propostas', 
                'show_elegiveis', 'show_propostas',
                'show_intersticios', 'show_gerenciar_intersticios', 'show_gerenciar_previsao',
                'show_usuarios', 'show_permissoes', 'show_logs', 
                'show_titulos_publicacao', 'show_administracao',
                'show_planejadas', 'show_operador_planejadas', 'show_fiscal_planejadas',
                'notas_visualizar', 'notas_criar', 'notas_editar', 'notas_lista', 'notas_excluir',
                # Permiss√µes de Planejadas
                'PLANEJADAS_VISUALIZAR', 'PLANEJADAS_CRIAR', 'PLANEJADAS_EDITAR', 'PLANEJADAS_EXCLUIR',
                'PLANEJADAS_ADICIONAR_MILITAR', 'PLANEJADAS_REMOVER_MILITAR',
                'PLANEJADAS_ASSINAR_OPERADOR', 'PLANEJADAS_ASSINAR_FISCAL',
                'MENU_PLANEJADAS', 'SUBMENU_PLANEJADAS', 'SUBMENU_OPERADOR_PLANEJADAS', 'SUBMENU_FISCAL_PLANEJADAS',
                # Novos menus Elogios/Puni√ß√µes
                'MENU_ELOGIOS', 'SUBMENU_ELOGIOS_OFICIAIS', 'SUBMENU_ELOGIOS_PRACAS',
                'MENU_PUNICOES', 'SUBMENU_PUNICOES_OFICIAIS', 'SUBMENU_PUNICOES_PRACAS',
                # Campos de a√ß√µes espec√≠ficas
                'ativos_visualizar', 'ativos_criar', 'ativos_editar', 'ativos_excluir',
                'inativos_visualizar', 'inativos_editar', 'inativos_excluir',
                'lotacoes_visualizar', 'lotacoes_criar', 'lotacoes_editar',
                'usuarios_visualizar', 'usuarios_criar', 'usuarios_editar',
                'permissoes_visualizar', 'permissoes_editar', 'permissoes_administrar',
                'logs_visualizar', 'logs_exportar', 'logs_limpar',
                # Elogios/Puni√ß√µes
                'elogios_visualizar', 'elogios_criar', 'elogios_editar',
                'punicoes_visualizar', 'punicoes_criar', 'punicoes_editar'
            ]
            
            # Verificar se h√° campos de permiss√µes granulares no POST
            tem_permissoes_granulares = any(field in request.POST for field in campos_permissoes_granulares)
            
            # Se houver campos de permiss√µes granulares no formul√°rio, processar
            # Isso permite adicionar, remover ou manter permiss√µes conforme necess√°rio
            if tem_permissoes_granulares:
                # Limpar permiss√µes existentes para recriar com base no formul√°rio
                PermissaoFuncao.objects.filter(funcao_militar=funcao).delete()
            
            # Mapear campos do formul√°rio para m√≥dulos
            submenu_mapping = {
                'show_ativos': 'SUBMENU_ATIVOS',
                'show_inativos': 'SUBMENU_INATIVOS',
                'show_lotacoes': 'SUBMENU_LOTACOES',
                'show_efetivo_elogios': 'MENU_EFETIVO_ELOGIOS',
                'show_efetivo_punicoes': 'MENU_EFETIVO_PUNICOES',
                # Novos menus diretos
                'MENU_ELOGIOS': 'MENU_ELOGIOS',
                'SUBMENU_ELOGIOS_OFICIAIS': 'SUBMENU_ELOGIOS_OFICIAIS',
                'SUBMENU_ELOGIOS_PRACAS': 'SUBMENU_ELOGIOS_PRACAS',
                'MENU_PUNICOES': 'MENU_PUNICOES',
                'SUBMENU_PUNICOES_OFICIAIS': 'SUBMENU_PUNICOES_OFICIAIS',
                'SUBMENU_PUNICOES_PRACAS': 'SUBMENU_PUNICOES_PRACAS',
                'show_escalas_dashboard': 'SUBMENU_ESCALAS_DASHBOARD',
                'show_escalas_lista': 'SUBMENU_ESCALAS_LISTA',
                'show_escalas_configuracao': 'SUBMENU_ESCALAS_CONFIGURACAO',
                'show_escalas_banco_horas': 'SUBMENU_ESCALAS_BANCO_HORAS',
                'show_escalas_operacoes': 'SUBMENU_ESCALAS_OPERACOES',
                'show_fichas_oficiais': 'SUBMENU_FICHAS_OFICIAIS',
                'show_fichas_pracas': 'SUBMENU_FICHAS_PRACAS',
                'show_quadros_acesso': 'SUBMENU_QUADROS_ACESSO',
                'show_quadros_fixacao': 'SUBMENU_QUADROS_FIXACAO',
                'show_almanaques': 'SUBMENU_ALMANAQUES',
                'show_promocoes': 'SUBMENU_PROMOCOES',
                'show_calendarios': 'SUBMENU_CALENDARIOS',
                'show_comissoes': 'SUBMENU_COMISSOES',
                'show_meus_votos': 'SUBMENU_MEUS_VOTOS',
                'show_intersticios': 'SUBMENU_INTERSTICIOS',
                'show_gerenciar_intersticios': 'SUBMENU_GERENCIAR_INTERSTICIOS',
                'show_gerenciar_previsao': 'SUBMENU_GERENCIAR_PREVISAO',
                'show_medalhas_concessoes': 'SUBMENU_MEDALHAS_CONCESSOES',
                'show_medalhas_propostas': 'SUBMENU_MEDALHAS_PROPOSTAS',
                'show_elegiveis': 'SUBMENU_ELEGIVEIS',
                'show_propostas': 'SUBMENU_PROPOSTAS',
                'notas_visualizar': 'NOTAS_VISUALIZAR',
                'notas_criar': 'NOTAS_CRIAR',
                'notas_editar': 'NOTAS_EDITAR',
                'notas_lista': 'SUBMENU_NOTAS_LISTA',
                'notas_excluir': 'NOTAS_EXCLUIR',
                'show_usuarios': 'SUBMENU_USUARIOS',
                'show_permissoes': 'SUBMENU_PERMISSOES',
                'show_logs': 'SUBMENU_LOGS',
                'show_administracao': 'SUBMENU_ADMINISTRACAO',
                'show_planejadas': 'MENU_PLANEJADAS',
                'show_operador_planejadas': 'SUBMENU_OPERADOR_PLANEJADAS',
                'show_fiscal_planejadas': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Mapear permiss√µes espec√≠ficas de a√ß√µes
            acoes_mapping = {
                # Ativos
                'ativos_visualizar': 'ATIVOS_VISUALIZAR',
                'ativos_criar': 'ATIVOS_CRIAR',
                'ativos_editar': 'ATIVOS_EDITAR',
                'ativos_excluir': 'ATIVOS_EXCLUIR',
                'ativos_transferir': 'ATIVOS_TRANSFERIR',
                'ativos_promover': 'ATIVOS_PROMOVER',
                'ativos_inativar': 'ATIVOS_INATIVAR',
                'ativos_ficha_conceito': 'ATIVOS_FICHA_CONCEITO',
                'ativos_exportar': 'ATIVOS_EXPORTAR',
                'ativos_dashboard': 'ATIVOS_DASHBOARD',
                'ativos_reordenar': 'ATIVOS_REORDENAR',
                
                # Inativos
                'inativos_visualizar': 'INATIVOS_VISUALIZAR',
                'inativos_editar': 'INATIVOS_EDITAR',
                'inativos_excluir': 'INATIVOS_EXCLUIR',
                'inativos_reativar': 'INATIVOS_REATIVAR',
                
                # Lota√ß√µes
                'lotacoes_visualizar': 'LOTACOES_VISUALIZAR',
                'lotacoes_criar': 'LOTACOES_CRIAR',
                'lotacoes_editar': 'LOTACOES_EDITAR',
                'lotacoes_excluir': 'LOTACOES_EXCLUIR',
                
                # Bot√µes granulares - Lota√ß√µes
                'botao_lotacao_nova': 'BOTAO_LOTACAO_NOVA',
                'botao_lotacao_editar': 'BOTAO_LOTACAO_EDITAR',
                'botao_lotacao_excluir': 'BOTAO_LOTACAO_EXCLUIR',
                'botao_lotacao_estatisticas': 'BOTAO_LOTACAO_ESTATISTICAS',
                
                
                # Bot√µes granulares - Publica√ß√µes
                'botao_publicacao_nova': 'BOTAO_PUBLICACAO_NOVA',
                'botao_publicacao_editar': 'BOTAO_PUBLICACAO_EDITAR',
                'botao_publicacao_publicar': 'BOTAO_PUBLICACAO_PUBLICAR',
                'botao_publicacao_assinar': 'BOTAO_PUBLICACAO_ASSINAR',
                
                # Detalhes do Militar
                'detail_fichas_conceito': 'DETAIL_FICHAS_CONCEITO',
                'detail_punicoes': 'DETAIL_PUNICOES',
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Oficiais
                'fichas_oficiais_visualizar': 'FICHAS_OFICIAIS_VISUALIZAR',
                'fichas_oficiais_criar': 'FICHAS_OFICIAIS_CRIAR',
                'fichas_oficiais_editar': 'FICHAS_OFICIAIS_EDITAR',
                'fichas_oficiais_excluir': 'FICHAS_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Fichas de Pra√ßas
                'fichas_pracas_visualizar': 'FICHAS_PRACAS_VISUALIZAR',
                'fichas_pracas_criar': 'FICHAS_PRACAS_CRIAR',
                'fichas_pracas_editar': 'FICHAS_PRACAS_EDITAR',
                'fichas_pracas_excluir': 'FICHAS_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Calend√°rios
                'calendarios_visualizar': 'CALENDARIOS_VISUALIZAR',
                'calendarios_criar': 'CALENDARIOS_CRIAR',
                'calendarios_editar': 'CALENDARIOS_EDITAR',
                'calendarios_excluir': 'CALENDARIOS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Fixa√ß√£o
                'quadros_fixacao_visualizar': 'QUADROS_FIXACAO_VISUALIZAR',
                'quadros_fixacao_criar': 'QUADROS_FIXACAO_CRIAR',
                'quadros_fixacao_editar': 'QUADROS_FIXACAO_EDITAR',
                'quadros_fixacao_excluir': 'QUADROS_FIXACAO_EXCLUIR',
                'quadros_fixacao_assinar': 'QUADROS_FIXACAO_ASSINAR',
                'quadros_fixacao_gerar_pdf': 'QUADROS_FIXACAO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Quadros de Acesso
                'quadros_acesso_visualizar': 'QUADROS_ACESSO_VISUALIZAR',
                'quadros_acesso_criar': 'QUADROS_ACESSO_CRIAR',
                'quadros_acesso_editar': 'QUADROS_ACESSO_EDITAR',
                'quadros_acesso_excluir': 'QUADROS_ACESSO_EXCLUIR',
                'quadros_acesso_assinar': 'QUADROS_ACESSO_ASSINAR',
                'quadros_acesso_homologar': 'QUADROS_ACESSO_HOMOLOGAR',
                'quadros_acesso_deshomologar': 'QUADROS_ACESSO_DESHOMOLOGAR',
                'quadros_acesso_elaborar': 'QUADROS_ACESSO_ELABORAR',
                'quadros_acesso_regenerar': 'QUADROS_ACESSO_REGENERAR',
                'quadros_acesso_gerar_pdf': 'QUADROS_ACESSO_GERAR_PDF',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes (gen√©ricas)
                'comissoes_visualizar': 'COMISSOES_VISUALIZAR',
                'comissoes_criar': 'COMISSOES_CRIAR',
                'comissoes_editar': 'COMISSOES_EDITAR',
                'comissoes_excluir': 'COMISSOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Oficiais
                'comissoes_oficiais_visualizar': 'COMISSOES_OFICIAIS_VISUALIZAR',
                'comissoes_oficiais_criar': 'COMISSOES_OFICIAIS_CRIAR',
                'comissoes_oficiais_editar': 'COMISSOES_OFICIAIS_EDITAR',
                'comissoes_oficiais_excluir': 'COMISSOES_OFICIAIS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Comiss√µes de Pra√ßas
                'comissoes_pracas_visualizar': 'COMISSOES_PRACAS_VISUALIZAR',
                'comissoes_pracas_criar': 'COMISSOES_PRACAS_CRIAR',
                'comissoes_pracas_editar': 'COMISSOES_PRACAS_EDITAR',
                'comissoes_pracas_excluir': 'COMISSOES_PRACAS_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Meus Votos
                'meus_votos_visualizar': 'MEUS_VOTOS_VISUALIZAR',
                'meus_votos_votar': 'MEUS_VOTOS_VOTAR',
                
                # Se√ß√£o de Promo√ß√µes - Promo√ß√µes
                'promocoes_visualizar': 'PROMOCOES_VISUALIZAR',
                'promocoes_criar': 'PROMOCOES_CRIAR',
                'promocoes_editar': 'PROMOCOES_EDITAR',
                'promocoes_excluir': 'PROMOCOES_EXCLUIR',
                
                # Se√ß√£o de Promo√ß√µes - Almanaques
                'almanaques_visualizar': 'ALMANAQUES_VISUALIZAR',
                'almanaques_criar': 'ALMANAQUES_CRIAR',
                'almanaques_editar': 'ALMANAQUES_EDITAR',
                'almanaques_excluir': 'ALMANAQUES_EXCLUIR',
                'almanaques_assinar': 'ALMANAQUES_ASSINAR',
                'almanaques_gerar_pdf': 'ALMANAQUES_GERAR_PDF',
                
                # Medalhas - Concess√µes
                'medalhas_concessoes_visualizar': 'MEDALHAS_CONCESSOES_VISUALIZAR',
                'medalhas_concessoes_criar': 'MEDALHAS_CONCESSOES_CRIAR',
                'medalhas_concessoes_editar': 'MEDALHAS_CONCESSOES_EDITAR',
                'medalhas_concessoes_excluir': 'MEDALHAS_CONCESSOES_EXCLUIR',
                
                # Medalhas - Propostas
                'medalhas_propostas_visualizar': 'MEDALHAS_PROPOSTAS_VISUALIZAR',
                'medalhas_propostas_criar': 'MEDALHAS_PROPOSTAS_CRIAR',
                'medalhas_propostas_editar': 'MEDALHAS_PROPOSTAS_EDITAR',
                'medalhas_propostas_excluir': 'MEDALHAS_PROPOSTAS_EXCLUIR',
                
                # Medalhas - Eleg√≠veis
                'elegiveis_visualizar': 'ELEGIVEIS_VISUALIZAR',
                'elegiveis_gerar': 'ELEGIVEIS_GERAR',
                'elegiveis_exportar': 'ELEGIVEIS_EXPORTAR',
                
                # Medalhas - Propostas (Lista)
                'propostas_visualizar': 'PROPOSTAS_VISUALIZAR',
                'propostas_criar': 'PROPOSTAS_CRIAR',
                'propostas_editar': 'PROPOSTAS_EDITAR',
                'propostas_excluir': 'PROPOSTAS_EXCLUIR',
                
                # Configura√ß√µes - Usu√°rios
                'usuarios_visualizar': 'USUARIOS_VISUALIZAR',
                'usuarios_criar': 'USUARIOS_CRIAR',
                'usuarios_editar': 'USUARIOS_EDITAR',
                'usuarios_excluir': 'USUARIOS_EXCLUIR',
                
                # Configura√ß√µes - Permiss√µes
                'permissoes_visualizar': 'PERMISSOES_VISUALIZAR',
                'permissoes_editar': 'PERMISSOES_EDITAR',
                'permissoes_administrar': 'PERMISSOES_ADMINISTRAR',
                
                # Configura√ß√µes - Logs
                'logs_visualizar': 'LOGS_VISUALIZAR',
                'logs_exportar': 'LOGS_EXPORTAR',
                'logs_limpar': 'LOGS_LIMPAR',
                
                # Planejadas
                'PLANEJADAS_VISUALIZAR': 'PLANEJADAS_VISUALIZAR',
                'PLANEJADAS_CRIAR': 'PLANEJADAS_CRIAR',
                'PLANEJADAS_EDITAR': 'PLANEJADAS_EDITAR',
                'PLANEJADAS_EXCLUIR': 'PLANEJADAS_EXCLUIR',
                'PLANEJADAS_ADICIONAR_MILITAR': 'PLANEJADAS_ADICIONAR_MILITAR',
                'PLANEJADAS_REMOVER_MILITAR': 'PLANEJADAS_REMOVER_MILITAR',
                'PLANEJADAS_ASSINAR_OPERADOR': 'PLANEJADAS_ASSINAR_OPERADOR',
                'PLANEJADAS_ASSINAR_FISCAL': 'PLANEJADAS_ASSINAR_FISCAL',
                'MENU_PLANEJADAS': 'MENU_PLANEJADAS',
                'SUBMENU_PLANEJADAS': 'SUBMENU_PLANEJADAS',
                'SUBMENU_OPERADOR_PLANEJADAS': 'SUBMENU_OPERADOR_PLANEJADAS',
                'SUBMENU_FISCAL_PLANEJADAS': 'SUBMENU_FISCAL_PLANEJADAS',
            }
            
            # Criar permiss√µes de submenu
            permissoes_criadas = 0
            for campo_form, modulo in submenu_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='VISUALIZAR',
                        ativo=True
                    )
                    permissoes_criadas += 1
            
            # Criar permiss√µes espec√≠ficas de a√ß√µes
            acoes_criadas = 0
            for campo_form, modulo in acoes_mapping.items():
                if campo_form in request.POST:
                    PermissaoFuncao.objects.create(
                        funcao_militar=funcao,
                        modulo=modulo,
                        acesso='EXECUTAR',
                        ativo=True
                    )
                    acoes_criadas += 1
            
            # Contar permiss√µes configuradas
            menus_principais_configurados = len([f for f in menu_principal_fields if f in request.POST])
            submenus_efetivo_configurados = len([f for f in submenu_efetivo_fields if f in request.POST])
            submenus_publicacoes_configurados = len([f for f in submenu_publicacoes_fields if f in request.POST])
            submenus_promocoes_configurados = len([f for f in submenu_promocoes_fields if f in request.POST])
            submenus_medalhas_configurados = len([f for f in submenu_medalhas_fields if f in request.POST])
            submenus_configuracoes_configurados = len([f for f in submenu_configuracoes_fields if f in request.POST])
            submenus_planejadas_configurados = len([f for f in submenu_planejadas_fields if f in request.POST])
            
            total_submenus = (submenus_efetivo_configurados + submenus_publicacoes_configurados + 
                            submenus_promocoes_configurados + submenus_medalhas_configurados + 
                            submenus_configuracoes_configurados + submenus_planejadas_configurados)
            
            messages.success(
                request, 
                f'Fun√ß√£o militar "{funcao.nome}" atualizada com sucesso! '
                f'Configurados {menus_principais_configurados} menus principais '
                f'e {total_submenus} submenus granulares.'
            )
            return redirect('militares:funcoes_militares_list')
        else:
            messages.error(request, 'Por favor, corrija os erros no formul√°rio.')
    else:
        form = FuncaoMilitarForm(instance=funcao)
    
    # Obter configura√ß√µes atuais para pr√©-popular o formul√°rio
    try:
        menu_config = FuncaoMenuConfig.objects.get(funcao_militar=funcao, ativo=True)
    except FuncaoMenuConfig.DoesNotExist:
        menu_config = None
    
    # Obter permiss√µes atuais
    permissoes = PermissaoFuncao.objects.filter(funcao_militar=funcao, ativo=True)
    permissoes_dict = {p.modulo: p.acesso for p in permissoes}
    
    context = {
        'form': form,
        'funcao': funcao,
        'menu_config': menu_config,
        'permissoes': permissoes_dict,
        'action': 'Editar',
        'title': f'Editar Fun√ß√£o: {funcao.nome}',
    }
    return render(request, 'militares/funcoes/funcoes_militares_form.html', context)


@login_required
@administracao_required
def funcoes_militares_delete(request, funcao_id):
    """Exclui uma fun√ß√£o militar - apenas administradores do sistema"""
    funcao = get_object_or_404(FuncaoMilitar, pk=funcao_id)
    
    # Verificar se h√° usu√°rios associados a esta fun√ß√£o
    usuarios_associados = UsuarioFuncaoMilitar.objects.filter(
        funcao_militar__nome__icontains=funcao.nome
    ).count()
    
    if request.method == 'POST':
        # Verificar novamente se h√° usu√°rios associados
        if usuarios_associados > 0:
            messages.error(request, f'N√£o √© poss√≠vel excluir esta fun√ß√£o pois ela est√° associada a {usuarios_associados} usu√°rio(s).')
            return redirect('militares:funcoes_militares_detail', funcao_id=funcao_id)
        
        try:
            funcao.delete()
            messages.success(request, 'Fun√ß√£o militar exclu√≠da com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao excluir fun√ß√£o: {str(e)}')
        
        return redirect('militares:funcoes_militares_list')
    
    context = {
        'funcao': funcao,
        'usuarios_associados': usuarios_associados,
        'pode_excluir': usuarios_associados == 0,
        'title': f'Excluir Fun√ß√£o: {funcao.nome}',
    }
    return render(request, 'militares/funcoes/funcoes_militares_delete.html', context)


@login_required
def funcoes_militares_sincronizar(request):
    """Sincroniza a tabela de fun√ß√µes militares"""
    from django.db import transaction
    
    try:
        with transaction.atomic():
            # Reordenar fun√ß√µes por ordem e nome
            funcoes = FuncaoMilitar.objects.all().order_by('ordem', 'nome')
            
            # Atualizar ordens sequenciais
            for index, funcao in enumerate(funcoes):
                if funcao.ordem != index:
                    funcao.ordem = index
                    funcao.save(update_fields=['ordem'])
            
            # Verificar e corrigir inconsist√™ncias
            funcoes_sem_nome = FuncaoMilitar.objects.filter(nome__isnull=True).count()
            if funcoes_sem_nome > 0:
                messages.warning(request, f'Encontradas {funcoes_sem_nome} fun√ß√µes sem nome. Verifique os dados.')
            
            # Estat√≠sticas da sincroniza√ß√£o
            total_funcoes = FuncaoMilitar.objects.count()
            funcoes_ativas = FuncaoMilitar.objects.filter(ativo=True).count()
            funcoes_inativas = FuncaoMilitar.objects.filter(ativo=False).count()
            
            messages.success(request, 
                f'Sincroniza√ß√£o realizada com sucesso! '
                f'Total: {total_funcoes} fun√ß√µes | '
                f'Ativas: {funcoes_ativas} | '
                f'Inativas: {funcoes_inativas}'
            )
            
    except Exception as e:
        messages.error(request, f'Erro durante a sincroniza√ß√£o: {str(e)}')
    
    return redirect('militares:funcoes_militares_list')


@login_required
def funcoes_militares_tempo_atual(request):
    """Gera relat√≥rio de tempo atual na fun√ß√£o"""
    from django.http import HttpResponse
    from datetime import datetime, date
    import io
    import xlsxwriter
    
    # Buscar todas as fun√ß√µes militares ativas
    funcoes = FuncaoMilitar.objects.filter(ativo=True).order_by('ordem', 'nome')
    
    # Criar arquivo Excel
    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    worksheet = workbook.add_worksheet('Tempo Atual na Fun√ß√£o')
    
    # Formata√ß√£o
    header_format = workbook.add_format({
        'bold': True,
        'bg_color': '#4472C4',
        'font_color': 'white',
        'border': 1
    })
    
    cell_format = workbook.add_format({'border': 1})
    date_format = workbook.add_format({'num_format': 'dd/mm/yyyy', 'border': 1})
    
    # Cabe√ßalhos
    headers = [
        'ID', 'Nome da Fun√ß√£o', 'Grupo', 'N√≠vel', 'Acesso', 
        'Acesso/Sigilo', 'Data Cria√ß√£o', 'Data Atualiza√ß√£o', 'Status'
    ]
    
    for col, header in enumerate(headers):
        worksheet.write(0, col, header, header_format)
    
    # Dados
    row = 1
    for funcao in funcoes:
        worksheet.write(row, 0, funcao.id, cell_format)
        worksheet.write(row, 1, funcao.nome, cell_format)
        worksheet.write(row, 2, funcao.get_grupo_display(), cell_format)
        worksheet.write(row, 3, funcao.nivel, cell_format)
        worksheet.write(row, 4, funcao.get_acesso_display(), cell_format)
        worksheet.write(row, 5, funcao.get_acesso_sigilo_display(), cell_format)
        worksheet.write(row, 6, funcao.data_criacao.date(), date_format)
        worksheet.write(row, 7, funcao.data_atualizacao.date(), date_format)
        worksheet.write(row, 8, 'Ativo' if funcao.ativo else 'Inativo', cell_format)
        row += 1
    
    # Ajustar largura das colunas
    worksheet.set_column('A:A', 8)
    worksheet.set_column('B:B', 30)
    worksheet.set_column('C:C', 15)
    worksheet.set_column('D:D', 8)
    worksheet.set_column('E:E', 15)
    worksheet.set_column('F:F', 15)
    worksheet.set_column('G:H', 12)
    worksheet.set_column('I:I', 10)
    
    workbook.close()
    output.seek(0)
    
    # Preparar resposta
    response = HttpResponse(
        output.read(),
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = f'attachment; filename="tempo_atual_funcoes_{timezone.localtime(timezone.now()).strftime("%Y%m%d_%H%M%S")}.xlsx"'
    
    return response


@login_required
def funcoes_militares_media_tempo(request):
    """Gera relat√≥rio de m√©dia de tempo na fun√ß√£o"""
    from django.http import HttpResponse
    from datetime import datetime, date, timedelta
    from django.db.models import Avg, Count
    import io
    import xlsxwriter
    
    # Buscar fun√ß√µes com estat√≠sticas de usu√°rios
    funcoes = FuncaoMilitar.objects.filter(ativo=True).order_by('ordem', 'nome')
    
    # Criar arquivo Excel
    output = io.BytesIO()
    workbook = xlsxwriter.Workbook(output)
    worksheet = workbook.add_worksheet('M√©dia Tempo na Fun√ß√£o')
    
    # Formata√ß√£o
    header_format = workbook.add_format({
        'bold': True,
        'bg_color': '#4472C4',
        'font_color': 'white',
        'border': 1
    })
    
    cell_format = workbook.add_format({'border': 1})
    number_format = workbook.add_format({'num_format': '0.00', 'border': 1})
    date_format = workbook.add_format({'num_format': 'dd/mm/yyyy', 'border': 1})
    
    # Cabe√ßalhos
    headers = [
        'ID', 'Nome da Fun√ß√£o', 'Grupo', 'N√≠vel', 'Total Usu√°rios',
        'Usu√°rios Ativos', 'Usu√°rios Inativos', 'Data Cria√ß√£o', 
        'Tempo M√©dio (dias)', 'Status'
    ]
    
    for col, header in enumerate(headers):
        worksheet.write(0, col, header, header_format)
    
    # Dados
    row = 1
    for funcao in funcoes:
        # Contar usu√°rios associados
        usuarios_total = UsuarioFuncaoMilitar.objects.filter(
            funcao_militar__nome__icontains=funcao.nome
        ).count()
        
        usuarios_ativos = UsuarioFuncaoMilitar.objects.filter(
            funcao_militar__nome__icontains=funcao.nome,
            ativo=True
        ).count()
        
        usuarios_inativos = usuarios_total - usuarios_ativos
        
        # Calcular tempo m√©dio (simulado - voc√™ pode implementar l√≥gica real)
        tempo_medio_dias = 365 if usuarios_total > 0 else 0
        
        worksheet.write(row, 0, funcao.id, cell_format)
        worksheet.write(row, 1, funcao.nome, cell_format)
        worksheet.write(row, 2, funcao.get_grupo_display(), cell_format)
        worksheet.write(row, 3, funcao.nivel, cell_format)
        worksheet.write(row, 4, usuarios_total, cell_format)
        worksheet.write(row, 5, usuarios_ativos, cell_format)
        worksheet.write(row, 6, usuarios_inativos, cell_format)
        worksheet.write(row, 7, funcao.data_criacao.date(), date_format)
        worksheet.write(row, 8, tempo_medio_dias, number_format)
        worksheet.write(row, 9, 'Ativo' if funcao.ativo else 'Inativo', cell_format)
        row += 1
    
    # Adicionar estat√≠sticas gerais
    row += 2
    worksheet.write(row, 0, 'ESTAT√çSTICAS GERAIS', header_format)
    row += 1
    
    total_funcoes = funcoes.count()
    total_usuarios = UsuarioFuncaoMilitar.objects.count()
    
    worksheet.write(row, 0, 'Total de Fun√ß√µes:', cell_format)
    worksheet.write(row, 1, total_funcoes, cell_format)
    row += 1
    
    worksheet.write(row, 0, 'Total de Usu√°rios:', cell_format)
    worksheet.write(row, 1, total_usuarios, cell_format)
    row += 1
    
    worksheet.write(row, 0, 'Data do Relat√≥rio:', cell_format)
    worksheet.write(row, 1, timezone.localtime(timezone.now()).date(), date_format)
    
    # Ajustar largura das colunas
    worksheet.set_column('A:A', 8)
    worksheet.set_column('B:B', 30)
    worksheet.set_column('C:C', 15)
    worksheet.set_column('D:D', 8)
    worksheet.set_column('E:F', 12)
    worksheet.set_column('G:G', 15)
    worksheet.set_column('H:H', 12)
    worksheet.set_column('I:I', 15)
    worksheet.set_column('J:J', 10)
    
    workbook.close()
    output.seek(0)
    
    # Preparar resposta
    response = HttpResponse(
        output.read(),
        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
    response['Content-Disposition'] = f'attachment; filename="media_tempo_funcoes_{timezone.localtime(timezone.now()).strftime("%Y%m%d_%H%M%S")}.xlsx"'
    
    return response


# ==================== VIEWS PARA √ìRG√ÉOS ====================

@login_required
@requer_perm_configuracoes_visualizar
def orgao_list(request):
    """Lista todos os √≥rg√£os"""
    orgaos = Orgao.objects.all().order_by('ordem', 'nome')
    
    # Estat√≠sticas
    total_orgaos = orgaos.count()
    orgaos_ativos = orgaos.filter(ativo=True).count()
    orgaos_inativos = orgaos.filter(ativo=False).count()
    
    context = {
        'orgaos': orgaos,
        'total_orgaos': total_orgaos,
        'orgaos_ativos': orgaos_ativos,
        'orgaos_inativos': orgaos_inativos,
    }
    
    return render(request, 'militares/orgaos/orgao_list.html', context)


@login_required
@requer_perm_configuracoes_editar
def orgao_create(request):
    """Cria novo √≥rg√£o"""
    if request.method == 'POST':
        form = OrgaoForm(request.POST)
        if form.is_valid():
            orgao = form.save()
            messages.success(request, f'√ìrg√£o "{orgao.nome_completo}" criado com sucesso!')
            return redirect('militares:orgao_list')
    else:
        form = OrgaoForm()
    
    context = {
        'form': form,
        'title': 'Novo √ìrg√£o',
        'action': 'Criar'
    }
    
    return render(request, 'militares/orgaos/orgao_form.html', context)


@login_required
@requer_perm_configuracoes_editar
def orgao_update(request, pk):
    """Atualiza √≥rg√£o existente"""
    orgao = get_object_or_404(Orgao, pk=pk)
    
    if request.method == 'POST':
        form = OrgaoForm(request.POST, instance=orgao)
        if form.is_valid():
            orgao = form.save()
            messages.success(request, f'√ìrg√£o "{orgao.nome_completo}" atualizado com sucesso!')
            return redirect('militares:orgao_list')
    else:
        form = OrgaoForm(instance=orgao)
    
    context = {
        'form': form,
        'orgao': orgao,
        'title': f'Editar √ìrg√£o - {orgao.nome_completo}',
        'action': 'Atualizar'
    }
    
    return render(request, 'militares/orgaos/orgao_form.html', context)


@login_required
@requer_perm_configuracoes_visualizar
def orgao_detail(request, pk):
    """Visualiza detalhes do √≥rg√£o"""
    orgao = get_object_or_404(Orgao, pk=pk)
    
    context = {
        'orgao': orgao,
    }
    
    return render(request, 'militares/orgaos/orgao_detail.html', context)


@login_required
@requer_perm_configuracoes_admin
def orgao_delete(request, pk):
    """Exclui √≥rg√£o"""
    orgao = get_object_or_404(Orgao, pk=pk)
    
    if request.method == 'POST':
        nome_orgao = orgao.nome_completo
        orgao.delete()
        messages.success(request, f'√ìrg√£o "{nome_orgao}" exclu√≠do com sucesso!')
        return redirect('militares:orgao_list')
    
    context = {
        'orgao': orgao,
    }
    
    return render(request, 'militares/orgaos/orgao_delete.html', context)


# ==================== VIEWS PARA ORGANOGRAMA ====================

@login_required
@requer_perm_configuracoes_visualizar
def organograma_view(request):
    """Visualiza o organograma completo"""
    orgaos = Orgao.objects.filter(ativo=True).prefetch_related(
        'grandes_comandos__unidades__sub_unidades'
    ).order_by('ordem', 'nome')
    
    # Estat√≠sticas
    total_orgaos = orgaos.count()
    total_grandes_comandos = GrandeComando.objects.filter(ativo=True).count()
    total_unidades = Unidade.objects.filter(ativo=True).count()
    total_sub_unidades = SubUnidade.objects.filter(ativo=True).count()
    
    context = {
        'orgaos': orgaos,
        'total_orgaos': total_orgaos,
        'total_grandes_comandos': total_grandes_comandos,
        'total_unidades': total_unidades,
        'total_sub_unidades': total_sub_unidades,
    }
    
    return render(request, 'militares/organograma/organograma.html', context)


# ==================== VIEWS PARA GRANDES COMANDOS ====================

@login_required
@requer_perm_configuracoes_visualizar
def grande_comando_list(request):
    """Lista todos os grandes comandos"""
    grandes_comandos = GrandeComando.objects.select_related('orgao').all().order_by('orgao__ordem', 'ordem', 'nome')
    
    # Estat√≠sticas
    total_grandes_comandos = grandes_comandos.count()
    grandes_comandos_ativos = grandes_comandos.filter(ativo=True).count()
    grandes_comandos_inativos = grandes_comandos.filter(ativo=False).count()
    
    context = {
        'grandes_comandos': grandes_comandos,
        'total_grandes_comandos': total_grandes_comandos,
        'grandes_comandos_ativos': grandes_comandos_ativos,
        'grandes_comandos_inativos': grandes_comandos_inativos,
    }
    
    return render(request, 'militares/organograma/grande_comando_list.html', context)


@login_required
@requer_perm_configuracoes_editar
def grande_comando_create(request):
    """Cria novo grande comando"""
    if request.method == 'POST':
        form = GrandeComandoForm(request.POST)
        if form.is_valid():
            grande_comando = form.save()
            messages.success(request, f'Grande Comando "{grande_comando.nome_completo}" criado com sucesso!')
            return redirect('militares:grande_comando_list')
    else:
        form = GrandeComandoForm()
    
    context = {
        'form': form,
        'title': 'Novo Grande Comando',
        'action': 'Criar'
    }
    
    return render(request, 'militares/organograma/grande_comando_form.html', context)


@login_required
@requer_perm_configuracoes_editar
def grande_comando_update(request, pk):
    """Atualiza grande comando existente"""
    grande_comando = get_object_or_404(GrandeComando, pk=pk)
    
    if request.method == 'POST':
        form = GrandeComandoForm(request.POST, instance=grande_comando)
        if form.is_valid():
            grande_comando = form.save()
            messages.success(request, f'Grande Comando "{grande_comando.nome_completo}" atualizado com sucesso!')
            return redirect('militares:grande_comando_list')
    else:
        form = GrandeComandoForm(instance=grande_comando)
    
    context = {
        'form': form,
        'grande_comando': grande_comando,
        'title': f'Editar Grande Comando - {grande_comando.nome_completo}',
        'action': 'Atualizar'
    }
    
    return render(request, 'militares/organograma/grande_comando_form.html', context)


@login_required
@requer_perm_configuracoes_visualizar
def grande_comando_detail(request, pk):
    """Visualiza detalhes do grande comando"""
    grande_comando = get_object_or_404(GrandeComando, pk=pk)
    
    context = {
        'grande_comando': grande_comando,
    }
    
    return render(request, 'militares/organograma/grande_comando_detail.html', context)


@login_required
@requer_perm_configuracoes_admin
def grande_comando_delete(request, pk):
    """Exclui grande comando"""
    grande_comando = get_object_or_404(GrandeComando, pk=pk)
    
    if request.method == 'POST':
        nome_grande_comando = grande_comando.nome_completo
        grande_comando.delete()
        messages.success(request, f'Grande Comando "{nome_grande_comando}" exclu√≠do com sucesso!')
        return redirect('militares:grande_comando_list')
    
    context = {
        'grande_comando': grande_comando,
    }
    
    return render(request, 'militares/organograma/grande_comando_delete.html', context)


# ==================== VIEWS PARA UNIDADES ====================

@login_required
@requer_perm_configuracoes_visualizar
def unidade_list(request):
    """Lista todas as unidades"""
    unidades = Unidade.objects.select_related('grande_comando__orgao').all().order_by('grande_comando__orgao__ordem', 'grande_comando__ordem', 'ordem', 'nome')
    
    # Estat√≠sticas
    total_unidades = unidades.count()
    unidades_ativas = unidades.filter(ativo=True).count()
    unidades_inativas = unidades.filter(ativo=False).count()
    
    context = {
        'unidades': unidades,
        'total_unidades': total_unidades,
        'unidades_ativas': unidades_ativas,
        'unidades_inativas': unidades_inativas,
    }
    
    return render(request, 'militares/organograma/unidade_list.html', context)


@login_required
@requer_perm_configuracoes_editar
def unidade_create(request):
    """Cria nova unidade"""
    if request.method == 'POST':
        form = UnidadeForm(request.POST)
        if form.is_valid():
            unidade = form.save()
            messages.success(request, f'Unidade "{unidade.nome_completo}" criada com sucesso!')
            return redirect('militares:unidade_list')
    else:
        form = UnidadeForm()
    
    context = {
        'form': form,
        'title': 'Nova Unidade',
        'action': 'Criar'
    }
    
    return render(request, 'militares/organograma/unidade_form.html', context)


@login_required
@requer_perm_configuracoes_editar
def unidade_update(request, pk):
    """Atualiza unidade existente"""
    unidade = get_object_or_404(Unidade, pk=pk)
    
    if request.method == 'POST':
        form = UnidadeForm(request.POST, instance=unidade)
        if form.is_valid():
            unidade = form.save()
            messages.success(request, f'Unidade "{unidade.nome_completo}" atualizada com sucesso!')
            return redirect('militares:unidade_list')
    else:
        form = UnidadeForm(instance=unidade)
    
    context = {
        'form': form,
        'unidade': unidade,
        'title': f'Editar Unidade - {unidade.nome_completo}',
        'action': 'Atualizar'
    }
    
    return render(request, 'militares/organograma/unidade_form.html', context)


@login_required
@requer_perm_configuracoes_visualizar
def unidade_detail(request, pk):
    """Visualiza detalhes da unidade"""
    unidade = get_object_or_404(Unidade, pk=pk)
    
    context = {
        'unidade': unidade,
    }
    
    return render(request, 'militares/organograma/unidade_detail.html', context)


@login_required
@requer_perm_configuracoes_admin
def unidade_delete(request, pk):
    """Exclui unidade"""
    unidade = get_object_or_404(Unidade, pk=pk)
    
    if request.method == 'POST':
        nome_unidade = unidade.nome_completo
        unidade.delete()
        messages.success(request, f'Unidade "{nome_unidade}" exclu√≠da com sucesso!')
        return redirect('militares:unidade_list')
    
    context = {
        'unidade': unidade,
    }
    
    return render(request, 'militares/organograma/unidade_delete.html', context)


# ==================== VIEWS PARA SUB-UNIDADES ====================

@login_required
@requer_perm_configuracoes_visualizar
def sub_unidade_list(request):
    """Lista todas as sub-unidades"""
    sub_unidades = SubUnidade.objects.select_related('unidade__grande_comando__orgao').all().order_by('unidade__grande_comando__orgao__ordem', 'unidade__grande_comando__ordem', 'unidade__ordem', 'ordem', 'nome')
    
    # Estat√≠sticas
    total_sub_unidades = sub_unidades.count()
    sub_unidades_ativas = sub_unidades.filter(ativo=True).count()
    sub_unidades_inativas = sub_unidades.filter(ativo=False).count()
    
    context = {
        'sub_unidades': sub_unidades,
        'total_sub_unidades': total_sub_unidades,
        'sub_unidades_ativas': sub_unidades_ativas,
        'sub_unidades_inativas': sub_unidades_inativas,
    }
    
    return render(request, 'militares/organograma/sub_unidade_list.html', context)


@login_required
@requer_perm_configuracoes_editar
def sub_unidade_create(request):
    """Cria nova sub-unidade"""
    if request.method == 'POST':
        form = SubUnidadeForm(request.POST)
        if form.is_valid():
            sub_unidade = form.save()
            messages.success(request, f'Sub-Unidade "{sub_unidade.nome_completo}" criada com sucesso!')
            return redirect('militares:sub_unidade_list')
    else:
        form = SubUnidadeForm()
    
    context = {
        'form': form,
        'title': 'Nova Sub-Unidade',
        'action': 'Criar'
    }
    
    return render(request, 'militares/organograma/sub_unidade_form.html', context)


@login_required
@requer_perm_configuracoes_editar
def sub_unidade_update(request, pk):
    """Atualiza sub-unidade existente"""
    sub_unidade = get_object_or_404(SubUnidade, pk=pk)
    
    if request.method == 'POST':
        form = SubUnidadeForm(request.POST, instance=sub_unidade)
        if form.is_valid():
            sub_unidade = form.save()
            messages.success(request, f'Sub-Unidade "{sub_unidade.nome_completo}" atualizada com sucesso!')
            return redirect('militares:sub_unidade_list')
    else:
        form = SubUnidadeForm(instance=sub_unidade)
    
    context = {
        'form': form,
        'sub_unidade': sub_unidade,
        'title': f'Editar Sub-Unidade - {sub_unidade.nome_completo}',
        'action': 'Atualizar'
    }
    
    return render(request, 'militares/organograma/sub_unidade_form.html', context)


@login_required
@requer_perm_configuracoes_visualizar
def sub_unidade_detail(request, pk):
    """Visualiza detalhes da sub-unidade"""
    sub_unidade = get_object_or_404(SubUnidade, pk=pk)
    
    context = {
        'sub_unidade': sub_unidade,
    }
    
    return render(request, 'militares/organograma/sub_unidade_detail.html', context)


@login_required
@requer_perm_configuracoes_admin
def sub_unidade_delete(request, pk):
    """Exclui sub-unidade"""
    sub_unidade = get_object_or_404(SubUnidade, pk=pk)
    
    if request.method == 'POST':
        nome_sub_unidade = sub_unidade.nome_completo
        sub_unidade.delete()
        messages.success(request, f'Sub-Unidade "{nome_sub_unidade}" exclu√≠da com sucesso!')
        return redirect('militares:sub_unidade_list')
    
    context = {
        'sub_unidade': sub_unidade,
    }
    
    return render(request, 'militares/organograma/sub_unidade_delete.html', context)


# Views AJAX para carregamento hier√°rquico do organograma
@login_required
def ajax_grandes_comandos(request):
    """Retorna grandes comandos baseado no √≥rg√£o selecionado"""
    orgao_id = request.GET.get('orgao')
    
    if not orgao_id:
        return JsonResponse({'grandes_comandos': []})
    
    try:
        from .models import GrandeComando
        grandes_comandos = GrandeComando.objects.filter(
            orgao_id=orgao_id,
            ativo=True
        ).order_by('sigla').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'grandes_comandos': list(grandes_comandos)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


@login_required
def ajax_unidades(request):
    """Retorna unidades baseado no grande comando selecionado"""
    grande_comando_id = request.GET.get('grande_comando')
    
    if not grande_comando_id:
        return JsonResponse({'unidades': []})
    
    try:
        from .models import Unidade
        unidades = Unidade.objects.filter(
            grande_comando_id=grande_comando_id,
            ativo=True
        ).order_by('sigla').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'unidades': list(unidades)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


@login_required
def ajax_sub_unidades(request):
    """Retorna sub-unidades baseado na unidade selecionada"""
    unidade_id = request.GET.get('unidade')
    
    if not unidade_id:
        return JsonResponse({'sub_unidades': []})
    
    try:
        from .models import SubUnidade
        sub_unidades = SubUnidade.objects.filter(
            unidade_id=unidade_id,
            ativo=True
        ).order_by('sigla').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'sub_unidades': list(sub_unidades)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


@login_required
def ajax_grandes_comandos(request):
    """View AJAX para carregar grandes comandos de um √≥rg√£o"""
    from django.http import JsonResponse
    from militares.models import GrandeComando
    
    orgao_id = request.GET.get('orgao_id')
    if not orgao_id:
        return JsonResponse({'error': '√ìrg√£o n√£o especificado'}, status=400)
    
    try:
        grandes_comandos = GrandeComando.objects.filter(
            orgao_id=orgao_id, 
            ativo=True
        ).order_by('ordem', 'nome').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'grandes_comandos': list(grandes_comandos)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


def ajax_unidades(request):
    """View AJAX para carregar unidades de um grande comando"""
    from django.http import JsonResponse
    from militares.models import Unidade
    
    grande_comando_id = request.GET.get('grande_comando_id')
    if not grande_comando_id:
        return JsonResponse({'error': 'Grande comando n√£o especificado'}, status=400)
    
    try:
        unidades = Unidade.objects.filter(
            grande_comando_id=grande_comando_id, 
            ativo=True
        ).order_by('ordem', 'nome').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'unidades': list(unidades)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


def ajax_sub_unidades(request):
    """View AJAX para carregar subunidades de uma unidade"""
    from django.http import JsonResponse
    from militares.models import SubUnidade
    
    unidade_id = request.GET.get('unidade_id')
    if not unidade_id:
        return JsonResponse({'error': 'Unidade n√£o especificada'}, status=400)
    
    try:
        sub_unidades = SubUnidade.objects.filter(
            unidade_id=unidade_id, 
            ativo=True
        ).order_by('ordem', 'nome').values('id', 'sigla', 'nome')
        
        return JsonResponse({
            'sub_unidades': list(sub_unidades)
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


def ajax_organograma_completo(request):
    """Retorna a hierarquia do organograma filtrada por acesso do usu√°rio para sele√ß√£o √∫nica"""
    try:
        from .models import Orgao, GrandeComando, Unidade, SubUnidade
        from .permissoes_militares import obter_sessao_ativa_usuario
        from .filtros_hierarquicos_pesquisa import obter_opcoes_filtro_hierarquico_itens_almoxarifado

        # Obter sess√£o ativa do usu√°rio
        sessao = obter_sessao_ativa_usuario(request.user) if request.user.is_authenticated else None
        
        # Se houver sess√£o, usar filtros hier√°rquicos
        if sessao and sessao.funcao_militar_usuario:
            opcoes = obter_opcoes_filtro_hierarquico_itens_almoxarifado(sessao.funcao_militar_usuario, request.user)
            
            # Converter op√ß√µes para formato esperado
            hierarquia = []
            for opcao in opcoes:
                # Extrair IDs do formato 'tipo_id'
                tipo = opcao['tipo']
                opcao_id = opcao['id'].split('_', 1)[1] if '_' in opcao['id'] else opcao['id']
                
                # Construir valor baseado no tipo
                valor = {
                    'orgao_id': None,
                    'grande_comando_id': None,
                    'unidade_id': None,
                    'sub_unidade_id': None
                }
                
                if tipo == 'orgao':
                    valor['orgao_id'] = int(opcao_id)
                elif tipo == 'grande_comando':
                    # Buscar grande comando para obter orgao_id
                    try:
                        gc = GrandeComando.objects.get(pk=int(opcao_id))
                        valor['orgao_id'] = gc.orgao.id if gc.orgao else None
                        valor['grande_comando_id'] = gc.id
                    except GrandeComando.DoesNotExist:
                        continue
                elif tipo == 'unidade':
                    # Buscar unidade para obter orgao_id e grande_comando_id
                    try:
                        u = Unidade.objects.get(pk=int(opcao_id))
                        valor['orgao_id'] = u.grande_comando.orgao.id if u.grande_comando and u.grande_comando.orgao else None
                        valor['grande_comando_id'] = u.grande_comando.id if u.grande_comando else None
                        valor['unidade_id'] = u.id
                    except Unidade.DoesNotExist:
                        continue
                elif tipo == 'sub_unidade':
                    # Buscar sub-unidade para obter todos os IDs
                    try:
                        s = SubUnidade.objects.get(pk=int(opcao_id))
                        if s.unidade and s.unidade.grande_comando:
                            valor['orgao_id'] = s.unidade.grande_comando.orgao.id if s.unidade.grande_comando.orgao else None
                            valor['grande_comando_id'] = s.unidade.grande_comando.id
                        valor['unidade_id'] = s.unidade.id if s.unidade else None
                        valor['sub_unidade_id'] = s.id
                    except SubUnidade.DoesNotExist:
                        continue
                
                hierarquia.append({
                    'id': opcao['id'],
                    'tipo': tipo,
                    'nivel': opcao['nivel'],
                    'texto': opcao['nome'],
                    'valor': valor
                })
            
            return JsonResponse({
                'hierarquia': hierarquia
            })
        
        # Se n√£o houver sess√£o ou for superusu√°rio, retornar organograma completo
        # Buscar todos os √≥rg√£os com suas hierarquias
        orgaos = Orgao.objects.filter(ativo=True).prefetch_related(
            'grandes_comandos__unidades__sub_unidades'
        ).order_by('nome')

        hierarquia = []

        for orgao in orgaos:
            # Adicionar √≥rg√£o
            hierarquia.append({
                'id': f'orgao_{orgao.id}',
                'tipo': 'orgao',
                'nivel': 1,
                'texto': f"{orgao.nome}",
                'valor': {
                    'orgao_id': orgao.id,
                    'grande_comando_id': None,
                    'unidade_id': None,
                    'sub_unidade_id': None
                }
            })

            # Adicionar grandes comandos
            for gc in orgao.grandes_comandos.filter(ativo=True).order_by('nome'):
                hierarquia.append({
                    'id': f'gc_{gc.id}',
                    'tipo': 'grande_comando',
                    'nivel': 2,
                    'texto': f"{orgao.nome} | {gc.nome}",
                    'valor': {
                        'orgao_id': orgao.id,
                        'grande_comando_id': gc.id,
                        'unidade_id': None,
                        'sub_unidade_id': None
                    }
                })

                # Adicionar unidades
                for unidade in gc.unidades.filter(ativo=True).order_by('nome'):
                    hierarquia.append({
                        'id': f'unidade_{unidade.id}',
                        'tipo': 'unidade',
                        'nivel': 3,
                        'texto': f"{orgao.nome} | {gc.nome} | {unidade.nome}",
                        'valor': {
                            'orgao_id': orgao.id,
                            'grande_comando_id': gc.id,
                            'unidade_id': unidade.id,
                            'sub_unidade_id': None
                        }
                    })

                    # Adicionar sub-unidades
                    for sub_unidade in unidade.sub_unidades.filter(ativo=True).order_by('nome'):
                        hierarquia.append({
                            'id': f'sub_{sub_unidade.id}',
                            'tipo': 'sub_unidade',
                            'nivel': 4,
                            'texto': f"{orgao.nome} | {gc.nome} | {unidade.nome} | {sub_unidade.nome}",
                            'valor': {
                                'orgao_id': orgao.id,
                                'grande_comando_id': gc.id,
                                'unidade_id': unidade.id,
                                'sub_unidade_id': sub_unidade.id
                            }
                        })

        return JsonResponse({
            'hierarquia': hierarquia
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


@login_required
def ajax_organograma_completo_sem_filtro(request):
    """Retorna a hierarquia completa do organograma SEM filtros hier√°rquicos (para destino de transfer√™ncias)"""
    try:
        from .models import Orgao, GrandeComando, Unidade, SubUnidade

        # Sempre retornar organograma completo, sem filtros
        orgaos = Orgao.objects.filter(ativo=True).prefetch_related(
            'grandes_comandos__unidades__sub_unidades'
        ).order_by('nome')

        hierarquia = []

        for orgao in orgaos:
            # Adicionar √≥rg√£o
            hierarquia.append({
                'id': f'orgao_{orgao.id}',
                'tipo': 'orgao',
                'nivel': 1,
                'texto': f"{orgao.nome}",
                'valor': {
                    'orgao_id': orgao.id,
                    'grande_comando_id': None,
                    'unidade_id': None,
                    'sub_unidade_id': None
                }
            })

            # Adicionar grandes comandos
            for gc in orgao.grandes_comandos.filter(ativo=True).order_by('nome'):
                hierarquia.append({
                    'id': f'gc_{gc.id}',
                    'tipo': 'grande_comando',
                    'nivel': 2,
                    'texto': f"{orgao.nome} | {gc.nome}",
                    'valor': {
                        'orgao_id': orgao.id,
                        'grande_comando_id': gc.id,
                        'unidade_id': None,
                        'sub_unidade_id': None
                    }
                })

                # Adicionar unidades
                for unidade in gc.unidades.filter(ativo=True).order_by('nome'):
                    hierarquia.append({
                        'id': f'unidade_{unidade.id}',
                        'tipo': 'unidade',
                        'nivel': 3,
                        'texto': f"{orgao.nome} | {gc.nome} | {unidade.nome}",
                        'valor': {
                            'orgao_id': orgao.id,
                            'grande_comando_id': gc.id,
                            'unidade_id': unidade.id,
                            'sub_unidade_id': None
                        }
                    })

                    # Adicionar sub-unidades
                    for sub_unidade in unidade.sub_unidades.filter(ativo=True).order_by('nome'):
                        hierarquia.append({
                            'id': f'sub_{sub_unidade.id}',
                            'tipo': 'sub_unidade',
                            'nivel': 4,
                            'texto': f"{orgao.nome} | {gc.nome} | {unidade.nome} | {sub_unidade.nome}",
                            'valor': {
                                'orgao_id': orgao.id,
                                'grande_comando_id': gc.id,
                                'unidade_id': unidade.id,
                                'sub_unidade_id': sub_unidade.id
                            }
                        })

        return JsonResponse({
            'hierarquia': hierarquia
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)


# Views para Fun√ß√µes dos Militares
@login_required
def militar_funcao_list(request, militar_id):
    """Lista as fun√ß√µes de um militar espec√≠fico"""
    militar = get_object_or_404(Militar, pk=militar_id)
    funcoes = MilitarFuncao.objects.filter(militar=militar).order_by('-data_inicio')
    
    context = {
        'militar': militar,
        'funcoes': funcoes,
        # menu_permissions j√° est√° dispon√≠vel via context processor
    }
    return render(request, 'militares/funcoes/militar_funcao_list.html', context)


@login_required
def militar_funcao_create(request, militar_id):
    """Cria uma nova fun√ß√£o para um militar"""
    militar = get_object_or_404(Militar, pk=militar_id)
    
    if request.method == 'POST':
        form = MilitarFuncaoForm(request.POST)
        if form.is_valid():
            funcao = form.save(commit=False)
            funcao.militar = militar
            # Definir posto inicial se n√£o foi definido
            if not funcao.posto_inicial:
                funcao.posto_inicial = militar.posto_graduacao
            funcao.save()
            messages.success(request, 'Fun√ß√£o adicionada com sucesso!')
            return redirect('militares:militar_funcao_list', militar_id=militar_id)
    else:
        form = MilitarFuncaoForm()
    
    context = {
        'militar': militar,
        'form': form,
        'title': 'Adicionar Fun√ß√£o',
        'action': 'Adicionar',
        # menu_permissions j√° est√° dispon√≠vel via context processor
    }
    return render(request, 'militares/funcoes/militar_funcao_form.html', context)


@login_required
def militar_funcao_update(request, militar_id, funcao_id):
    """Atualiza uma fun√ß√£o de um militar"""
    militar = get_object_or_404(Militar, pk=militar_id)
    funcao = get_object_or_404(MilitarFuncao, pk=funcao_id, militar=militar)
    
    if request.method == 'POST':
        form = MilitarFuncaoForm(request.POST, instance=funcao)
        form.militar = militar  # Passar o militar para o formul√°rio
        if form.is_valid():
            funcao_atualizada = form.save(commit=False)
            
            # Se a fun√ß√£o est√° sendo encerrada (status mudou para ANTERIOR) e n√£o tem posto final
            if funcao_atualizada.status == 'ANTERIOR' and not funcao_atualizada.posto_final:
                funcao_atualizada.posto_final = militar.posto_graduacao
            
            funcao_atualizada.save()
            messages.success(request, 'Fun√ß√£o atualizada com sucesso!')
            return redirect('militares:militar_funcao_list', militar_id=militar_id)
    else:
        form = MilitarFuncaoForm(instance=funcao)
        form.militar = militar  # Passar o militar para o formul√°rio
    
    context = {
        'militar': militar,
        'funcao': funcao,
        'form': form,
        'title': 'Editar Fun√ß√£o',
        'action': 'Atualizar',
        # menu_permissions j√° est√° dispon√≠vel via context processor
    }
    return render(request, 'militares/funcoes/militar_funcao_form.html', context)


@login_required
def militar_funcao_delete(request, militar_id, funcao_id):
    """Remove uma fun√ß√£o de um militar"""
    militar = get_object_or_404(Militar, pk=militar_id)
    funcao = get_object_or_404(MilitarFuncao, pk=funcao_id, militar=militar)
    
    if request.method == 'POST':
        funcao.delete()
        messages.success(request, 'Fun√ß√£o removida com sucesso!')
        return redirect('militares:militar_funcao_list', militar_id=militar_id)
    
    context = {
        'militar': militar,
        'funcao': funcao,
        # menu_permissions j√° est√° dispon√≠vel via context processor
    }
    return render(request, 'militares/funcoes/militar_funcao_delete.html', context)


# ==================== SISTEMA DE LOGIN E SESS√ÉO ====================

@login_required
def selecionar_funcao_lotacao(request):
    """View para sele√ß√£o de fun√ß√£o militar ap√≥s login - REDIRECIONA PARA LOGIN"""
    # Superusu√°rios n√£o precisam de fun√ß√£o militar
    if request.user.is_superuser:
        messages.info(request, 'Superusu√°rios n√£o precisam selecionar fun√ß√£o militar.')
        return redirect('militares:home')
    
    # Como agora a sele√ß√£o de fun√ß√£o √© feita no login, redirecionar para login
    messages.info(request, 'Para trocar de fun√ß√£o, fa√ßa logout e login novamente selecionando a nova fun√ß√£o.')
    return redirect('logout')


@login_required
def trocar_funcao_lotacao(request):
    """View para trocar fun√ß√£o durante a sess√£o - REDIRECIONA PARA LOGIN"""
    # Superusu√°rios n√£o precisam de fun√ß√£o militar
    if request.user.is_superuser:
        messages.info(request, 'Superusu√°rios n√£o precisam trocar fun√ß√£o militar.')
        return redirect('militares:home')
    
    # Como agora a sele√ß√£o de fun√ß√£o √© feita no login, redirecionar para login
    messages.info(request, 'Para trocar de fun√ß√£o, fa√ßa logout e login novamente selecionando a nova fun√ß√£o.')
    return redirect('logout')


# ==================== ELOGIOS ====================

@login_required
def elogio_create(request, militar_pk):
    """Cria um novo elogio para um militar"""
    militar = get_object_or_404(Militar, pk=militar_pk)
    
    # Verificar se pode editar elogios
    from militares.permissoes_simples import pode_editar_punicoes_elogios
    if not pode_editar_punicoes_elogios(request.user, militar):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para criar elogios. Apenas administradores podem criar elogios.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        form = ElogioForm(request.POST)
        if form.is_valid():
            elogio = form.save(commit=False)
            elogio.militar = militar
            elogio.save()
            
            messages.success(request, f'Elogio registrado com sucesso para {militar.nome_completo}!')
            return redirect('militares:militar_detail', pk=militar.pk)
    else:
        form = ElogioForm()
    
    context = {
        'form': form,
        'militar': militar,
        'title': 'Novo Elogio',
        'action': 'create'
    }
    return render(request, 'militares/elogios/elogio_form.html', context)


@login_required
def elogio_update(request, pk):
    """Edita um elogio existente"""
    elogio = get_object_or_404(Elogio, pk=pk)
    militar = elogio.militar
    
    # Verificar se pode editar elogios
    from militares.permissoes_simples import pode_editar_punicoes_elogios
    if not pode_editar_punicoes_elogios(request.user, militar):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar elogios. Apenas administradores podem editar elogios.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        form = ElogioForm(request.POST, instance=elogio)
        if form.is_valid():
            form.save()
            messages.success(request, 'Elogio atualizado com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
    else:
        form = ElogioForm(instance=elogio)
    
    context = {
        'form': form,
        'militar': militar,
        'elogio': elogio,
        'title': 'Editar Elogio',
        'action': 'update'
    }
    return render(request, 'militares/elogios/elogio_form.html', context)


@login_required
def elogio_delete(request, pk):
    """Exclui um elogio"""
    elogio = get_object_or_404(Elogio, pk=pk)
    militar = elogio.militar
    
    # Exclus√£o restrita a superusu√°rio
    if not request.user.is_superuser:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir elogios. Apenas superusu√°rios podem excluir elogios.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        elogio.delete()
        messages.success(request, 'Elogio exclu√≠do com sucesso!')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    context = {
        'militar': militar,
        'elogio': elogio,
    }
    return render(request, 'militares/elogios/elogio_delete.html', context)


# ==================== PUNI√á√ïES ====================

@login_required
def punicao_create(request, militar_pk):
    """Cria uma nova puni√ß√£o para um militar"""
    militar = get_object_or_404(Militar, pk=militar_pk)
    
    # Verificar se pode criar puni√ß√µes (agora apenas superusu√°rio)
    from militares.permissoes_militares import pode_editar_punicoes_elogios as pode_editar_punicoes_elogios_mm
    if not pode_editar_punicoes_elogios_mm(request.user, militar):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para criar puni√ß√µes. Apenas administradores podem criar puni√ß√µes.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        form = PunicaoForm(request.POST)
        if form.is_valid():
            punicao = form.save(commit=False)
            punicao.militar = militar
            punicao.save()
            
            messages.success(request, f'Puni√ß√£o registrada com sucesso para {militar.nome_completo}!')
            return redirect('militares:militar_detail', pk=militar.pk)
    else:
        form = PunicaoForm()
    
    context = {
        'form': form,
        'militar': militar,
        'title': 'Nova Puni√ß√£o',
        'action': 'create'
    }
    return render(request, 'militares/punicoes/punicao_form.html', context)


@login_required
def punicao_update(request, pk):
    """Edita uma puni√ß√£o existente"""
    punicao = get_object_or_404(Punicao, pk=pk)
    militar = punicao.militar
    
    # Verificar se pode editar puni√ß√µes (agora apenas superusu√°rio)
    from militares.permissoes_militares import pode_editar_punicoes_elogios as pode_editar_punicoes_elogios_mm
    if not pode_editar_punicoes_elogios_mm(request.user, militar):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar puni√ß√µes. Apenas administradores podem editar puni√ß√µes.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        form = PunicaoForm(request.POST, instance=punicao)
        if form.is_valid():
            form.save()
            messages.success(request, 'Puni√ß√£o atualizada com sucesso!')
            return redirect('militares:militar_detail', pk=militar.pk)
    else:
        form = PunicaoForm(instance=punicao)
    
    context = {
        'form': form,
        'militar': militar,
        'punicao': punicao,
        'title': 'Editar Puni√ß√£o',
        'action': 'update'
    }
    return render(request, 'militares/punicoes/punicao_form.html', context)


@login_required
def punicao_delete(request, pk):
    """Exclui uma puni√ß√£o"""
    punicao = get_object_or_404(Punicao, pk=pk)
    militar = punicao.militar
    
    # Exclus√£o restrita a superusu√°rio
    if not request.user.is_superuser:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para excluir puni√ß√µes. Apenas superusu√°rios podem excluir puni√ß√µes.')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    if request.method == 'POST':
        punicao.delete()
        messages.success(request, 'Puni√ß√£o exclu√≠da com sucesso!')
        return redirect('militares:militar_detail', pk=militar.pk)
    
    context = {
        'militar': militar,
        'punicao': punicao,
    }
    return render(request, 'militares/punicoes/punicao_delete.html', context)


# Views para gerenciar fun√ß√µes de usu√°rios
@login_required
@administracao_required
def sincronizar_funcoes_todos_militares(request):
    """
    View para sincronizar fun√ß√µes de todos os militares
    """
    from .sincronizar_funcoes_militar import sincronizar_todos_militares
    
    if request.method == 'POST':
        resultados = sincronizar_todos_militares()
        
        # Calcular estat√≠sticas
        total_usuarios = len(resultados)
        sucessos = len([r for r in resultados if r['sucesso']])
        total_criadas = sum([r['funcoes_criadas'] for r in resultados])
        total_atualizadas = sum([r['funcoes_atualizadas'] for r in resultados])
        total_desativadas = sum([r.get('funcoes_desativadas', 0) for r in resultados])
        
        messages.success(request, 
            f'Sincroniza√ß√£o conclu√≠da! '
            f'Usu√°rios processados: {total_usuarios}, '
            f'Sucessos: {sucessos}, '
            f'Fun√ß√µes criadas: {total_criadas}, '
            f'Fun√ß√µes atualizadas: {total_atualizadas}, '
            f'Fun√ß√µes desativadas: {total_desativadas}'
        )
        
        context = {
            'resultados': resultados,
            'total_usuarios': total_usuarios,
            'sucessos': sucessos,
            'total_criadas': total_criadas,
            'total_atualizadas': total_atualizadas,
            'total_desativadas': total_desativadas,
        }
        
        return render(request, 'militares/admin/sincronizar_funcoes_resultado.html', context)
    
    return render(request, 'militares/admin/sincronizar_funcoes.html')


def usuario_funcao_add(request, pk):
    """Adiciona uma nova fun√ß√£o militar a um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    
    if request.method == 'POST':
        funcao_id = request.POST.get('funcao_militar')
        ativo = request.POST.get('ativo', 'on') == 'on'
        
        try:
            funcao_militar = FuncaoMilitar.objects.get(pk=funcao_id)
            
            # Verificar se o usu√°rio j√° tem essa fun√ß√£o
            if UsuarioFuncaoMilitar.objects.filter(usuario=usuario, funcao_militar=funcao_militar).exists():
                messages.error(request, 'Este usu√°rio j√° possui esta fun√ß√£o.')
            else:
                # Criar fun√ß√£o do usu√°rio marcando que foi adicionada via interface
                usuario_funcao = UsuarioFuncaoMilitar.objects.create(
                    usuario=usuario,
                    funcao_militar=funcao_militar,
                    ativo=ativo
                )
                
                # Se o usu√°rio tem militar associado, criar MilitarFuncao marcando como adicionada via usu√°rio
                if hasattr(usuario, 'militar') and usuario.militar:
                    from militares.models import MilitarFuncao
                    from datetime import date
                    
                    # Verificar se j√° existe uma MilitarFuncao com a mesma combina√ß√£o
                    data_inicio = date.today()
                    if MilitarFuncao.objects.filter(
                        militar=usuario.militar,
                        funcao_militar=funcao_militar,
                        data_inicio=data_inicio
                    ).exists():
                        messages.warning(request, 'Este militar j√° possui esta fun√ß√£o com a data de in√≠cio de hoje.')
                    else:
                        militar_funcao = MilitarFuncao.objects.create(
                            militar=usuario.militar,
                            funcao_militar=funcao_militar,
                            tipo_funcao='PRINCIPAL',
                            status='ATUAL',
                            data_inicio=data_inicio,
                            ativo=ativo
                        )
                        # Marcar que foi adicionada via usu√°rio para n√£o remover fun√ß√£o padr√£o
                        militar_funcao._adicionada_via_usuario = True
                        militar_funcao.save()
                
                messages.success(request, f'Fun√ß√£o "{funcao_militar.nome}" adicionada com sucesso!')
                return redirect('militares:usuario_funcoes_list', pk=usuario.pk)
                
        except FuncaoMilitar.DoesNotExist:
            messages.error(request, 'Fun√ß√£o militar n√£o encontrada.')
    
    # Buscar fun√ß√µes dispon√≠veis (que o usu√°rio ainda n√£o possui e est√£o ativas)
    funcoes_existentes = UsuarioFuncaoMilitar.objects.filter(usuario=usuario).values_list('funcao_militar_id', flat=True)
    funcoes_disponiveis = FuncaoMilitar.objects.filter(ativo=True).exclude(id__in=funcoes_existentes).order_by('nome')
    
    context = {
        'usuario': usuario,
        'funcoes_disponiveis': funcoes_disponiveis,
    }
    return render(request, 'militares/usuarios/funcoes/add.html', context)


@login_required
@administracao_required
def usuario_funcao_edit(request, pk, funcao_id):
    """Edita uma fun√ß√£o militar de um usu√°rio"""
    usuario = get_object_or_404(User, pk=pk)
    usuario_funcao = get_object_or_404(UsuarioFuncaoMilitar, pk=funcao_id, usuario=usuario)
    
    if request.method == 'POST':
        ativo = request.POST.get('ativo', 'on') == 'on'
        nivel_acesso = request.POST.get('nivel_acesso', 'NENHUM')
        
        usuario_funcao.ativo = ativo
        usuario_funcao.nivel_acesso = nivel_acesso
        usuario_funcao.save()
        
        messages.success(request, f'Fun√ß√£o "{usuario_funcao.funcao_militar.nome}" atualizada com sucesso!')
        return redirect('militares:usuario_funcoes_list', pk=usuario.pk)
    
    context = {
        'usuario': usuario,
        'usuario_funcao': usuario_funcao,
    }
    return render(request, 'militares/usuarios/funcoes/edit.html', context)


@login_required
@administracao_required
def usuario_funcao_delete(request, pk, funcao_id):
    """Remove uma fun√ß√£o militar de um usu√°rio - Apenas administradores do sistema"""
    
    usuario = get_object_or_404(User, pk=pk)
    usuario_funcao = get_object_or_404(UsuarioFuncaoMilitar, pk=funcao_id, usuario=usuario)
    
    if request.method == 'POST':
        funcao_nome = usuario_funcao.funcao_militar.nome
        usuario_funcao.delete()
        messages.success(request, f'Fun√ß√£o "{funcao_nome}" removida com sucesso!')
        return redirect('militares:usuario_funcoes_list', pk=usuario.pk)
    
    context = {
        'usuario': usuario,
        'usuario_funcao': usuario_funcao,
    }
    return render(request, 'militares/usuarios/funcoes/delete.html', context)


@login_required
@csrf_exempt
def transferir_militar_ajax(request, militar_id):
    """
    View AJAX para transferir militar para nova lota√ß√£o
    """
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    try:
        from .models import Militar, Lotacao
        from django.utils import timezone
        
        # Buscar militar
        militar = get_object_or_404(Militar, pk=militar_id)
        
        # Verificar apenas permiss√£o granular de transfer√™ncia
        from .permissoes_simples import tem_permissao
        if not tem_permissao(request.user, 'militares', 'transferir'):
            return JsonResponse({'success': False, 'message': 'Voc√™ n√£o tem permiss√£o para transferir militares'})
        
        # Removida verifica√ß√£o hier√°rquica para permitir transfer√™ncias para qualquer estrutura
        
        # Obter dados do POST
        data = json.loads(request.body)
        nova_lotacao = data.get('nova_lotacao', '').strip()
        observacoes = data.get('observacoes', '').strip()
        
        # Limpar apenas caracteres problem√°ticos, preservando acentos
        import re
        
        # Remover apenas setas e caracteres de controle, preservando acentos
        nova_lotacao = nova_lotacao.replace('‚Üí', '').replace('|', '').strip()
        # Remover espa√ßos extras
        nova_lotacao = re.sub(r'\s+', ' ', nova_lotacao).strip()
        
        if not nova_lotacao:
            return JsonResponse({'success': False, 'message': 'Nova lota√ß√£o √© obrigat√≥ria'})
        
        # Finalizar lota√ß√£o atual
        lotacao_atual = militar.lotacoes.filter(status='ATUAL', ativo=True).first()
        if lotacao_atual:
            lotacao_atual.status = 'ANTERIOR'
            lotacao_atual.data_fim = timezone.now().date()
            lotacao_atual.save()
        
        # Criar nova lota√ß√£o
        nova_lotacao_obj = Lotacao.objects.create(
            militar=militar,
            lotacao=nova_lotacao,
            data_inicio=timezone.now().date(),
            status='ATUAL',
            ativo=True,
            observacoes=observacoes
        )
        
        # Tentar vincular automaticamente ao organograma se poss√≠vel
        try:
            # Buscar correspond√™ncia exata na estrutura organizacional
            from .models import Orgao, GrandeComando, Unidade, SubUnidade
            
            # Limpar o nome da lota√ß√£o para busca
            nome_limpo = nova_lotacao.replace('‚Üí', '').replace('|', '').strip()
            nome_limpo = ' '.join(nome_limpo.split())  # Remove espa√ßos extras
            
            # Tentar encontrar correspond√™ncia exata
            sub_unidade = SubUnidade.objects.filter(nome__iexact=nome_limpo, ativo=True).first()
            if sub_unidade:
                nova_lotacao_obj.sub_unidade = sub_unidade
                nova_lotacao_obj.unidade = sub_unidade.unidade
                nova_lotacao_obj.grande_comando = sub_unidade.unidade.grande_comando
                nova_lotacao_obj.orgao = sub_unidade.unidade.grande_comando.orgao
                nova_lotacao_obj.save(update_fields=['orgao', 'grande_comando', 'unidade', 'sub_unidade'])
            else:
                unidade = Unidade.objects.filter(nome__iexact=nome_limpo, ativo=True).first()
                if unidade:
                    nova_lotacao_obj.unidade = unidade
                    nova_lotacao_obj.grande_comando = unidade.grande_comando
                    nova_lotacao_obj.orgao = unidade.grande_comando.orgao
                    nova_lotacao_obj.save(update_fields=['orgao', 'grande_comando', 'unidade'])
                else:
                    grande_comando = GrandeComando.objects.filter(nome__iexact=nome_limpo, ativo=True).first()
                    if grande_comando:
                        nova_lotacao_obj.grande_comando = grande_comando
                        nova_lotacao_obj.orgao = grande_comando.orgao
                        nova_lotacao_obj.save(update_fields=['orgao', 'grande_comando'])
                    else:
                        orgao = Orgao.objects.filter(nome__iexact=nome_limpo, ativo=True).first()
                        if orgao:
                            nova_lotacao_obj.orgao = orgao
                            nova_lotacao_obj.save(update_fields=['orgao'])
        except Exception as e:
            # Se houver erro na vincula√ß√£o, apenas loga e continua
            print(f"Aviso: Erro ao vincular ao organograma: {e}")
        
        return JsonResponse({
            'success': True, 
            'message': f'Militar {militar.nome_guerra} transferido para {nova_lotacao} com sucesso!',
            'nova_lotacao': nova_lotacao
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro ao transferir militar: {str(e)}'})


@login_required
def obter_estruturas_organizacionais(request):
    """
    View AJAX para obter estruturas organizacionais para o modal de transfer√™ncia
    SEM RESTRI√á√ïES - Mostra TODA a estrutura organizacional com hierarquia completa
    """
    try:
        from .models import Orgao, GrandeComando, Unidade, SubUnidade
        
        estruturas = []
        
        # ESTRUTURA HIER√ÅRQUICA COMPLETA
        # 1. √ìRG√ÉOS (N√≠vel 1)
        orgaos = Orgao.objects.filter(ativo=True).order_by('nome')
        for orgao in orgaos:
            estruturas.append({
                'id': f"orgao_{orgao.id}",
                'nome': f"{orgao.nome}",
                'nome_completo': f"{orgao.nome}",
                'tipo': 'orgao',
                'nivel': 1,
                'pai': None,
                'pai_nome': None
            })
            
            # 2. GRANDES COMANDOS do √≥rg√£o (N√≠vel 2)
            grandes_comandos = GrandeComando.objects.filter(orgao=orgao, ativo=True).order_by('nome')
            for gc in grandes_comandos:
                estruturas.append({
                    'id': f"gc_{gc.id}",
                    'nome': f"{gc.nome}",
                    'nome_completo': f"{orgao.nome} ‚Üí {gc.nome}",
                    'tipo': 'grande_comando',
                    'nivel': 2,
                    'pai': f"orgao_{orgao.id}",
                    'pai_nome': orgao.nome
                })
                
                # 3. UNIDADES do grande comando (N√≠vel 3)
                unidades = Unidade.objects.filter(grande_comando=gc, ativo=True).order_by('nome')
                for unidade in unidades:
                    estruturas.append({
                        'id': f"unidade_{unidade.id}",
                        'nome': f"{unidade.nome}",
                        'nome_completo': f"{orgao.nome} ‚Üí {gc.nome} ‚Üí {unidade.nome}",
                        'tipo': 'unidade',
                        'nivel': 3,
                        'pai': f"gc_{gc.id}",
                        'pai_nome': gc.nome
                    })
                    
                    # 4. SUB-UNIDADES da unidade (N√≠vel 4)
                    sub_unidades = SubUnidade.objects.filter(unidade=unidade, ativo=True).order_by('nome')
                    for sub_unidade in sub_unidades:
                        estruturas.append({
                            'id': f"sub_unidade_{sub_unidade.id}",
                            'nome': f"{sub_unidade.nome}",
                            'nome_completo': f"{orgao.nome} ‚Üí {gc.nome} ‚Üí {unidade.nome} ‚Üí {sub_unidade.nome}",
                            'tipo': 'sub_unidade',
                            'nivel': 4,
                            'pai': f"unidade_{unidade.id}",
                            'pai_nome': unidade.nome
                        })
        
        return JsonResponse({'estruturas': estruturas})
        
    except Exception as e:
        return JsonResponse({'estruturas': [], 'error': str(e)})


# ==================== COMISS√ÉO - FICHAS DE CONCEITO ====================

@login_required
def comissao_fichas_oficiais(request):
    """Lista fichas de conceito de oficiais para membros de comiss√£o"""
    # Verificar se o usu√°rio tem fun√ß√£o de comiss√£o
    from .models import UsuarioFuncaoMilitar
    funcoes_comissao = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True,
        funcao_militar__nome__in=['CPO', 'CPP']
    )
    
    if not funcoes_comissao.exists():
        messages.error(request, 'Acesso negado. Apenas membros de comiss√£o podem acessar esta √°rea.')
        return redirect('militares:home')
    
    # Verificar se √© oficial (CPO) ou pra√ßa (CPP)
    funcao_cpo = funcoes_comissao.filter(funcao_militar__nome='CPO').exists()
    funcao_cpp = funcoes_comissao.filter(funcao_militar__nome='CPP').exists()
    
    # Apenas oficiais (CPO) podem ver fichas de oficiais
    if not funcao_cpo:
        messages.error(request, 'Acesso negado. Apenas membros CPO podem visualizar fichas de oficiais.')
        return redirect('militares:home')
    
    # Filtrar apenas oficiais (CB, TC, MJ, CP, 1T, 2T, AS, AA)
    oficiais = Militar.objects.filter(
        classificacao='ATIVO',
        posto_graduacao__in=['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'AA']
    )
    
    # Buscar fichas de oficiais
    fichas = FichaConceitoOficiais.objects.filter(militar__in=oficiais)
    
    # Recalcular pontos para todas as fichas
    for ficha in fichas:
        ficha.pontos = ficha.calcular_pontos()
        ficha.save(update_fields=['pontos'])
    
    # Hierarquia para ordena√ß√£o
    hierarquia_oficiais = {
        'CB': 1,   # Coronel
        'TC': 2,   # Tenente Coronel
        'MJ': 3,   # Major
        'CP': 4,   # Capit√£o
        '1T': 5,   # 1¬∫ Tenente
        '2T': 6,   # 2¬∫ Tenente
        'AS': 7,   # Aspirante a Oficial
        'AA': 8,   # Aluno de Adapta√ß√£o
    }
    
    fichas_list = list(fichas)
    fichas_list.sort(key=lambda x: (
        hierarquia_oficiais.get(x.militar.posto_graduacao, 999),  # Primeiro por hierarquia
        x.militar.nome_completo                                    # Depois por nome
    ))
    
    # Estat√≠sticas
    total_oficiais_ativos = oficiais.count()
    total_fichas_oficiais = len(fichas_list)
    
    # Buscar oficiais sem ficha
    oficiais_sem_ficha = oficiais.exclude(fichaconceitooficiais__isnull=False)
    oficiais_sem_ficha_list = list(oficiais_sem_ficha)
    oficiais_sem_ficha_list.sort(key=lambda x: (
        hierarquia_oficiais.get(x.posto_graduacao, 999),
        x.nome_completo
    ))
    
    context = {
        'fichas': fichas_list,
        'oficiais_sem_ficha': oficiais_sem_ficha_list,
        'total_oficiais_ativos': total_oficiais_ativos,
        'total_fichas_oficiais': total_fichas_oficiais,
        'total_sem_ficha': len(oficiais_sem_ficha_list),
        'title': 'Fichas de Conceito - Oficiais (Comiss√£o)',
        'is_comissao': True,
        'tipo_comissao': 'CPO',
    }
    
    return render(request, 'militares/comissao/fichas_oficiais.html', context)


@login_required
def comissao_fichas_pracas(request):
    """Lista fichas de conceito de pra√ßas para membros de comiss√£o"""
    # Verificar se o usu√°rio tem fun√ß√£o de comiss√£o
    from .models import UsuarioFuncaoMilitar
    funcoes_comissao = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True,
        funcao_militar__nome__in=['CPO', 'CPP']
    )
    
    if not funcoes_comissao.exists():
        messages.error(request, 'Acesso negado. Apenas membros de comiss√£o podem acessar esta √°rea.')
        return redirect('militares:home')
    
    # Verificar se √© oficial (CPO) ou pra√ßa (CPP)
    funcao_cpo = funcoes_comissao.filter(funcao_militar__nome='CPO').exists()
    funcao_cpp = funcoes_comissao.filter(funcao_militar__nome='CPP').exists()
    
    # Apenas pra√ßas (CPP) podem ver fichas de pra√ßas
    if not funcao_cpp:
        messages.error(request, 'Acesso negado. Apenas membros CPP podem visualizar fichas de pra√ßas.')
        return redirect('militares:home')
    
    # Filtrar apenas pra√ßas (SD, CAB, 3S, 2S, 1S, ST)
    pracas = Militar.objects.filter(
        classificacao='ATIVO',
        posto_graduacao__in=['SD', 'CAB', '3S', '2S', '1S', 'ST']
    )
    
    # Buscar fichas de pra√ßas
    fichas = FichaConceitoPracas.objects.filter(militar__in=pracas)
    
    # Recalcular pontos para todas as fichas
    for ficha in fichas:
        ficha.pontos = ficha.calcular_pontos()
        ficha.save(update_fields=['pontos'])
    
    # Hierarquia para ordena√ß√£o
    hierarquia_pracas = {
        'ST': 1,   # Subtenente
        '1S': 2,   # 1¬∫ Sargento
        '2S': 3,   # 2¬∫ Sargento
        '3S': 4,   # 3¬∫ Sargento
        'CAB': 5,  # Cabo
        'SD': 6,   # Soldado
    }
    
    fichas_list = list(fichas)
    fichas_list.sort(key=lambda x: (
        hierarquia_pracas.get(x.militar.posto_graduacao, 999),  # Primeiro por hierarquia
        x.militar.nome_completo                                  # Depois por nome
    ))
    
    # Estat√≠sticas
    total_pracas_ativas = pracas.count()
    total_fichas_pracas = len(fichas_list)
    
    # Buscar pra√ßas sem ficha
    pracas_sem_ficha = pracas.exclude(fichaconceitopracas__isnull=False)
    pracas_sem_ficha_list = list(pracas_sem_ficha)
    pracas_sem_ficha_list.sort(key=lambda x: (
        hierarquia_pracas.get(x.posto_graduacao, 999),
        x.nome_completo
    ))
    
    context = {
        'fichas': fichas_list,
        'pracas_sem_ficha': pracas_sem_ficha_list,
        'total_pracas_ativas': total_pracas_ativas,
        'total_fichas_pracas': total_fichas_pracas,
        'total_sem_ficha': len(pracas_sem_ficha_list),
        'title': 'Fichas de Conceito - Pra√ßas (Comiss√£o)',
        'is_comissao': True,
        'tipo_comissao': 'CPP',
    }
    
    return render(request, 'militares/comissao/fichas_pracas.html', context)

@login_required
def ajudante_geral_ajax(request):
    """Retorna informa√ß√µes do ajudante geral via AJAX"""
    try:
        from .models import UsuarioFuncaoMilitar
        from django.http import JsonResponse
        
        # Buscar usu√°rio com fun√ß√£o de Ajudante Geral
        ajudante_geral = UsuarioFuncaoMilitar.objects.filter(
            funcao_militar__nome='Ajudante Geral',
            ativo=True
        ).select_related('usuario', 'usuario__militar').first()
        
        if ajudante_geral and ajudante_geral.usuario.militar:
            militar = ajudante_geral.usuario.militar
            return JsonResponse({
                'ajudante_geral': {
                    'nome': militar.nome_guerra or militar.nome,
                    'posto': militar.posto_graduacao.abreviacao if militar.posto_graduacao else '',
                    'telefone': militar.telefone or '',
                }
            })
        else:
            return JsonResponse({
                'ajudante_geral': {
                    'nome': 'N√£o definido',
                    'posto': '',
                    'telefone': '',
                }
            })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)

@login_required
def buscar_nota_por_numero_ajax(request, numero):
    """Buscar ID da nota pelo n√∫mero via AJAX"""
    try:
        from .models import Publicacao
        from django.http import JsonResponse
        
        nota = Publicacao.objects.filter(
            tipo='NOTA',
            numero=numero
        ).first()
        
        if not nota:
            return JsonResponse({
                'success': False,
                'error': f'Nota {numero} n√£o encontrada'
            })
        
        return JsonResponse({
            'success': True,
            'nota_id': nota.pk,
            'nota_numero': nota.numero,
            'nota_titulo': nota.titulo
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        })


# ==================== VIEWS PARA ESCALAS DE SERVI√áO ====================

@login_required
def escalas_list(request):
    """Lista de escalas de servi√ßo"""
    print("DEBUG: Iniciando escalas_list")
    from .models import EscalaServico, EscalaMilitar
    from django.core.paginator import Paginator
    from django.db.models import Q, Count
    from datetime import datetime, date
    from calendar import monthrange
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_escalas, obter_opcoes_filtro_hierarquico_escalas, obter_opcoes_filtro_hierarquico_notas
    from .permissoes_simples import obter_funcao_militar_ativa
    
    # Obter fun√ß√£o atual do usu√°rio
    funcao_atual = obter_funcao_militar_ativa(request.user)
    print(f"DEBUG: funcao_atual = {funcao_atual}")
    
    # Verificar se h√° filtros de data personalizados
    data_inicio = request.GET.get('data_inicio', '')
    data_fim = request.GET.get('data_fim', '')
    
    # Definir per√≠odo padr√£o para o contexto (m√™s atual)
    hoje = date.today()
    primeiro_dia_mes = date(hoje.year, hoje.month, 1)
    ultimo_dia_mes = date(hoje.year, hoje.month, monthrange(hoje.year, hoje.month)[1])
    
    # Se n√£o h√° filtros de data, usar padr√£o: escalas do m√™s atual
    if not data_inicio and not data_fim:
        # Buscar escalas com filtros (padr√£o: m√™s atual)
        escalas_base = EscalaServico.objects.filter(
            data__gte=primeiro_dia_mes,
            data__lte=ultimo_dia_mes
        )
    else:
        # Se h√° filtros de data, buscar todas as escalas primeiro
        escalas_base = EscalaServico.objects.all()
    
    # Aplicar filtro hier√°rquico baseado no acesso da fun√ß√£o
    print(f"DEBUG: escalas_base.count() = {escalas_base.count()}")
    if request.user.is_superuser:
        # Superusu√°rio v√™ todas as escalas do m√™s atual
        escalas = escalas_base
        print("DEBUG: Usu√°rio √© superusu√°rio")
    elif funcao_atual:
        escalas = aplicar_filtro_hierarquico_escalas(escalas_base, funcao_atual, request.user)
        print(f"DEBUG: Aplicado filtro hier√°rquico, escalas.count() = {escalas.count()}")
    else:
        # Se n√£o h√° fun√ß√£o ativa, mostrar escalas do m√™s atual (sem filtro hier√°rquico)
        escalas = escalas_base
        print("DEBUG: Sem fun√ß√£o ativa, usando escalas_base")
    
    
    # Obter op√ß√µes de filtro hier√°rquico (igual √†s notas)
    opcoes_filtro_hierarquico = obter_opcoes_filtro_hierarquico_notas(funcao_atual, request.user)
    
    # Filtro hier√°rquico
    hierarquia = request.GET.get('hierarquia', '')
    print(f"DEBUG: Par√¢metro hierarquia recebido: '{hierarquia}'")
    if hierarquia:
        print(f"DEBUG: Aplicando filtro hier√°rquico: {hierarquia}")
        from .models import Orgao, GrandeComando, Unidade, SubUnidade
        
        if hierarquia.startswith('orgao_'):
            orgao_id = hierarquia.replace('orgao_', '')
            try:
                orgao = Orgao.objects.get(id=orgao_id)
                escalas = escalas.filter(organizacao__icontains=orgao.nome)
                print(f"DEBUG: Filtrado por √≥rg√£o: {orgao.nome}")
            except Orgao.DoesNotExist:
                pass
                
        elif hierarquia.startswith('gc_'):
            gc_id = hierarquia.replace('gc_', '')
            try:
                gc = GrandeComando.objects.get(id=gc_id)
                escalas = escalas.filter(organizacao__icontains=gc.nome)
                print(f"DEBUG: Filtrado por grande comando: {gc.nome}")
            except GrandeComando.DoesNotExist:
                pass
                
        elif hierarquia.startswith('unidade_'):
            unidade_id = hierarquia.replace('unidade_', '')
            try:
                unidade = Unidade.objects.get(id=unidade_id)
                escalas = escalas.filter(organizacao__icontains=unidade.nome)
                print(f"DEBUG: Filtrado por unidade: {unidade.nome}")
            except Unidade.DoesNotExist:
                pass
                
        elif hierarquia.startswith('sub_'):
            sub_id = hierarquia.replace('sub_', '')
            try:
                sub = SubUnidade.objects.get(id=sub_id)
                escalas = escalas.filter(organizacao__icontains=sub.nome)
                print(f"DEBUG: Filtrado por subunidade: {sub.nome}")
            except SubUnidade.DoesNotExist:
                pass
        
        print(f"DEBUG: Escalas ap√≥s filtro hier√°rquico: {escalas.count()}")
    
    # Aplicar filtros de data (se n√£o foram aplicados no inicial)
    if data_inicio or data_fim:
        if data_inicio:
            try:
                from datetime import datetime
                data_inicio_obj = datetime.strptime(data_inicio, '%Y-%m-%d').date()
                escalas = escalas.filter(data__gte=data_inicio_obj)
                print(f"DEBUG: Filtro data_inicio aplicado: {data_inicio_obj}")
            except ValueError:
                pass  # Ignorar data inv√°lida
        
        if data_fim:
            try:
                from datetime import datetime
                data_fim_obj = datetime.strptime(data_fim, '%Y-%m-%d').date()
                escalas = escalas.filter(data__lte=data_fim_obj)
                print(f"DEBUG: Filtro data_fim aplicado: {data_fim_obj}")
            except ValueError:
                pass  # Ignorar data inv√°lida
        
        print(f"DEBUG: Total de escalas ap√≥s filtros de data: {escalas.count()}")
    
    # Ordenar com escalas da data atual no topo, depois por tipo de servi√ßo, organiza√ß√£o e data
    from django.db.models import Case, When, Value, IntegerField, Max as models_Max
    
    hoje = date.today()
    escalas = escalas.annotate(
        prioridade_data=Case(
            When(data=hoje, then=Value(0)),  # Escalas de hoje t√™m prioridade 0
            default=Value(1),  # Outras escalas t√™m prioridade 1
            output_field=IntegerField()
        )
    ).order_by('prioridade_data', 'tipo_servico', 'organizacao', 'data')
    
    # Pagina√ß√£o por OM (Organiza√ß√£o Militar) - 1 OM por p√°gina
    organizacoes_unicas = escalas.values_list('organizacao', flat=True).distinct().order_by('organizacao')
    
    # Se h√° filtro de data, aplicar ordena√ß√£o especial para organiza√ß√µes
    if data_inicio or data_fim:
        # Para per√≠odos espec√≠ficos, ordenar por data da escala mais recente de cada OM
        organizacoes_ordenadas = []
        for org in organizacoes_unicas:
            escalas_org = escalas.filter(organizacao=org)
            data_mais_recente = escalas_org.aggregate(
                data_max=models_Max('data')
            )['data_max']
            organizacoes_ordenadas.append((org, data_mais_recente))
        
        # Ordenar por data mais recente (descendente)
        organizacoes_ordenadas.sort(key=lambda x: x[1] or date.min, reverse=True)
        organizacoes_unicas = [org[0] for org in organizacoes_ordenadas]
    
    # Pagina√ß√£o das organiza√ß√µes
    paginator_orgs = Paginator(organizacoes_unicas, 1)  # 1 OM por p√°gina
    page_number = request.GET.get('page', 1)
    page_obj_orgs = paginator_orgs.get_page(page_number)
    
    # Obter escalas da organiza√ß√£o da p√°gina atual
    if page_obj_orgs:
        organizacao_atual = page_obj_orgs[0]
        escalas_pagina = escalas.filter(organizacao=organizacao_atual)
    else:
        escalas_pagina = escalas.none()
    
    # Criar objeto page_obj compat√≠vel com o template
    class PageObj:
        def __init__(self, escalas, paginator_orgs, page_obj_orgs):
            self.object_list = escalas
            self.paginator = paginator_orgs
            self.number = page_obj_orgs.number
            self.has_other_pages = paginator_orgs.num_pages > 1
            self.has_previous = page_obj_orgs.has_previous()
            self.has_next = page_obj_orgs.has_next()
            self.previous_page_number = page_obj_orgs.previous_page_number if self.has_previous else None
            self.next_page_number = page_obj_orgs.next_page_number if self.has_next else None
        
        def __iter__(self):
            """Torna o objeto iter√°vel para compatibilidade com templates"""
            return iter(self.object_list)
        
        def __len__(self):
            """Retorna o n√∫mero de escalas na p√°gina atual"""
            return len(self.object_list)
    
    page_obj = PageObj(escalas_pagina, paginator_orgs, page_obj_orgs)
    
    # Estat√≠sticas
    total_escalas = EscalaServico.objects.count()
    escalas_ativas = EscalaServico.objects.filter(status='ativa').count()
    escalas_pendentes = EscalaServico.objects.filter(status='pendente').count()
    escalas_concluidas = EscalaServico.objects.filter(status='concluida').count()
    
    # Contar militares indexados
    total_militares_indexados = EscalaMilitar.objects.count()
    
    # Buscar informa√ß√µes detalhadas dos militares escalados para cada escala
    escalas_com_militares = []
    
    for escala in page_obj:
        militares_escalados = EscalaMilitar.objects.filter(escala=escala).select_related('militar')
        
        # Organizar militares por tipo de servi√ßo
        militares_operacionais = []
        militares_administrativos = []
        equipes = {}
        
        for escala_militar in militares_escalados:
            militar_info = {
                'id': escala_militar.id,
                'nome_completo': escala_militar.militar.nome_completo,
                'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
                'funcao_display': escala_militar.get_funcao_display(),
                'tipo_servico': escala_militar.tipo_servico,
                'tipo_servico_display': escala_militar.get_tipo_servico_display(),
                'turno_display': escala_militar.get_turno_display(),
                'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
                'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
                'observacoes': escala_militar.observacoes or '',
                'funcao_operacional': escala_militar.funcao_operacional or '',
                'equipe': escala_militar.equipe or '',
                'viatura': escala_militar.viatura or '',
                'secao': escala_militar.secao or ''
            }
            
            if escala_militar.tipo_servico == 'operacional':
                militares_operacionais.append(militar_info)
                # Organizar por equipes
                equipe_nome = escala_militar.equipe or 'Sem Equipe Definida'
                if equipe_nome not in equipes:
                    equipes[equipe_nome] = {
                        'nome': equipe_nome,
                        'militares': [],
                        'viatura': escala_militar.viatura or '',
                        'total_militares': 0
                    }
                equipes[equipe_nome]['militares'].append(militar_info)
                equipes[equipe_nome]['total_militares'] += 1
            else:
                # Para administrativos, manter a lista simples para o regroup por hora_inicio
                militares_administrativos.append(militar_info)
        
        # Converter equipes para lista
        equipes_lista = list(equipes.values())
        
        # Determinar permiss√µes de revis√£o e aprova√ß√£o usando os m√©todos do modelo
        pode_revisar = escala.pode_revisar(request.user)
        pode_aprovar = escala.pode_aprovar(request.user)
        
        # Verificar se a escala j√° foi revisada ou aprovada
        tem_revisao = escala.revisado_por is not None
        tem_aprovacao = escala.aprovado_por is not None
        
        escalas_com_militares.append({
            'escala': escala,
            'militares_operacionais': militares_operacionais,
            'militares_administrativos': militares_administrativos,
            'equipes': equipes_lista,
            'total_operacionais': len(militares_operacionais),
            'total_administrativos': len(militares_administrativos),
            'total_militares': len(militares_operacionais) + len(militares_administrativos),
            'pode_revisar': pode_revisar,
            'pode_aprovar': pode_aprovar,
            'tem_revisao': tem_revisao,
            'tem_aprovacao': tem_aprovacao
        })
    
    print(f"DEBUG: escalas_com_militares count = {len(escalas_com_militares)}")
    print(f"DEBUG: page_obj count = {len(page_obj.object_list) if hasattr(page_obj, 'object_list') else 'N/A'}")
    
    # Anos dispon√≠veis para o modal de gera√ß√£o de escalas
    anos_disponiveis = list(range(2015, 2051))
    
    context = {
        'escalas': escalas_com_militares,
        'page_obj': page_obj,
        'organizacao_atual': organizacao_atual if page_obj_orgs else None,
        'total_organizacoes': paginator_orgs.count,
        'total_escalas': total_escalas,
        'escalas_ativas': escalas_ativas,
        'escalas_pendentes': escalas_pendentes,
        'escalas_concluidas': escalas_concluidas,
        'total_militares_indexados': total_militares_indexados,
        'opcoes_filtro_hierarquico': opcoes_filtro_hierarquico,
        'funcao_atual': funcao_atual,
        'hoje': hoje,
        'mostrando_todas': False,  # Por padr√£o, mostra apenas escalas do m√™s atual
        'periodo_atual': {
            'primeiro_dia': primeiro_dia_mes,
            'ultimo_dia': ultimo_dia_mes,
            'mes_ano': primeiro_dia_mes.strftime('%B de %Y')
        },
        'filtros': {
            'data_inicio': data_inicio,
            'data_fim': data_fim,
        },
        'is_paginated': page_obj.has_other_pages,
        'anos_disponiveis': anos_disponiveis,
    }
    
    print("DEBUG: Retornando template escalas_list.html")
    return render(request, 'militares/escalas_list.html', context)


@login_required
def escalas_configuracao(request):
    """Configura√ß√£o de Escalas - Interface para gerenciar configura√ß√µes de escalas de servi√ßo"""
    from .models import Militar, EscalaServico, EscalaMilitar, Lotacao, Orgao, GrandeComando, Unidade, SubUnidade, AbonoPlanejada
    from django.db.models import Q, Count, Sum
    from datetime import datetime, timedelta
    from calendar import monthrange
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_militares
    from .permissoes_hierarquicas import obter_funcao_militar_ativa

    # Par√¢metros de filtro
    mes = int(request.GET.get('mes', datetime.now().month))
    ano = int(request.GET.get('ano', datetime.now().year))
    search = request.GET.get('search', '')
    organizacao_id = request.GET.get('organizacao_id', '')
    status_filtro = request.GET.get('status', '')
    
    # Calcular datas do m√™s
    primeiro_dia = datetime(ano, mes, 1).date()
    ultimo_dia = datetime(ano, mes, monthrange(ano, mes)[1]).date()
    # Feriados fixos nacionais (MM-DD) com nomes
    feriados_fixos = {
        '01-01': 'Confraterniza√ß√£o Universal',
        '04-21': 'Tiradentes',
        '05-01': 'Dia do Trabalho',
        '09-07': 'Independ√™ncia do Brasil',
        '10-12': 'Nossa Senhora Aparecida',
        '11-02': 'Finados',
        '11-15': 'Proclama√ß√£o da Rep√∫blica',
        '11-20': 'Dia da Consci√™ncia Negra',
        '12-25': 'Natal',
    }
    # Feriados ESTADUAIS do Piau√≠ (MM-DD) com nomes
    feriados_piaui = {
        '03-13': 'Batalha do Jenipapo',
        '10-19': 'Dia do Piau√≠',
    }

    # Feriados municipais removidos

    # Feriados m√≥veis (calculados por ano) ‚Äì Sexta-feira Santa e Corpus Christi
    def calcular_pascoa(y):
        # Algoritmo de Butcher para calend√°rio gregoriano
        a = y % 19
        b = y // 100
        c = y % 100
        d = b // 4
        e = b % 4
        f = (b + 8) // 25
        g = (b - f + 1) // 3
        h = (19 * a + b - d - g + 15) % 30
        i = c // 4
        k = c % 4
        l = (32 + 2 * e + 2 * i - h - k) % 7
        m = (a + 11 * h + 22 * l) // 451
        month = (h + l - 7 * m + 114) // 31
        day = ((h + l - 7 * m + 114) % 31) + 1
        return datetime(y, month, day).date()

    pascoa = calcular_pascoa(ano)
    sexta_santa = pascoa - timedelta(days=2)
    corpus_christi = pascoa + timedelta(days=60)
    feriados_moveis = {
        sexta_santa: 'Sexta-feira Santa',
        corpus_christi: 'Corpus Christi'
    }
    # Obter fun√ß√£o do usu√°rio para controle de acesso
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    # Fun√ß√£o para obter cidade da lota√ß√£o de um militar
    def obter_cidade_lotacao_militar(militar):
        lotacao_atual = militar.lotacao_atual()  # Chamar o m√©todo
        if lotacao_atual:
            if lotacao_atual.orgao:
                return lotacao_atual.orgao.cidade
            elif lotacao_atual.grande_comando:
                return lotacao_atual.grande_comando.cidade
            elif lotacao_atual.unidade:
                return lotacao_atual.unidade.cidade
            elif lotacao_atual.sub_unidade:
                return lotacao_atual.sub_unidade.cidade
        return None

    dias_mes = []
    for dia in range(1, ultimo_dia.day + 1):
        data_dia = datetime(ano, mes, dia).date()
        mm_dd = data_dia.strftime('%m-%d')
        # Determinar nome do feriado (nacionais, estaduais e m√≥veis)
        nome_feriado = None
        tipo_feriado = None
        if mm_dd in feriados_fixos:
            nome_feriado = feriados_fixos[mm_dd]
            tipo_feriado = 'nacional'
        elif mm_dd in feriados_piaui:
            nome_feriado = feriados_piaui[mm_dd]
            tipo_feriado = 'estadual'
        elif data_dia in feriados_moveis:
            nome_feriado = feriados_moveis[data_dia]
            tipo_feriado = 'nacional'
        # Feriados municipais removidos - n√£o mostrar feriados municipais
        
        # Mapear dias da semana para portugu√™s
        dias_semana_pt = {
            0: 'Segunda', 1: 'Ter√ßa', 2: 'Quarta', 3: 'Quinta', 
            4: 'Sexta', 5: 'S√°bado', 6: 'Domingo'
        }
        
        dias_mes.append({
            'dia': dia,
            'dia_semana': dias_semana_pt[data_dia.weekday()],
            'data': data_dia,
            'is_weekend': data_dia.weekday() >= 5,
            'is_holiday': nome_feriado is not None,
            'nome_feriado': nome_feriado,
            'tipo_feriado': tipo_feriado
        })

    # Buscar militares (excluir inativos para n√£o esconder PRONTO/FERIAS etc.)
    militares = Militar.objects.exclude(classificacao='INATIVO').select_related().prefetch_related('lotacoes')
    
    # Aplicar filtro hier√°rquico baseado no acesso da fun√ß√£o
    # Se n√£o houver filtro de organiza√ß√£o selecionado, mostrar apenas a OM do acesso (sem descend√™ncia)
    # Se houver filtro, a l√≥gica abaixo (no filtro de organiza√ß√£o) mostrar√° a descend√™ncia
    if not organizacao_id:
        # Sem filtro: mostrar apenas a OM do acesso (sem descend√™ncia)
        if funcao_usuario and funcao_usuario.funcao_militar:
            acesso = funcao_usuario.funcao_militar.acesso
            
            if acesso == 'TOTAL':
                # Acesso total - pode ver todos os militares inicialmente
                pass
            elif acesso == 'ORGAO' and funcao_usuario.orgao:
                # Acesso ao √≥rg√£o - mostrar APENAS militares lotados diretamente no √≥rg√£o (sem descend√™ncia)
                militares = militares.filter(
                    lotacoes__orgao=funcao_usuario.orgao,
                    lotacoes__grande_comando__isnull=True,
                    lotacoes__unidade__isnull=True,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
            elif acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
                # Acesso ao grande comando - mostrar APENAS militares lotados diretamente no GC (sem descend√™ncia)
                militares = militares.filter(
                    lotacoes__grande_comando=funcao_usuario.grande_comando,
                    lotacoes__unidade__isnull=True,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
            elif acesso == 'UNIDADE' and funcao_usuario.unidade:
                # Acesso √† unidade - mostrar APENAS militares lotados diretamente na unidade (sem descend√™ncia)
                militares = militares.filter(
                    lotacoes__unidade=funcao_usuario.unidade,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
            elif acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
                # Acesso √† sub-unidade - mostrar apenas militares lotados na sub-unidade
                militares = militares.filter(
                    lotacoes__sub_unidade=funcao_usuario.sub_unidade,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
            else:
                # Se n√£o tem acesso definido, n√£o mostrar nenhum militar
                militares = militares.none()
        else:
            # Se n√£o tem fun√ß√£o ativa, manter militares ATIVOS (restri√ß√£o ser√° feita pelo filtro de organiza√ß√£o, se fornecido)
            # Superusu√°rio tamb√©m mant√©m visualiza√ß√£o ampla
            if not request.user.is_superuser:
                pass  # mant√©m filtro padr√£o de ATIVO j√° aplicado acima

    # Aplicar filtros adicionais
    if search:
        militares = militares.filter(
            Q(nome_completo__icontains=search) |
            Q(matricula__icontains=search) |
            Q(nome_guerra__icontains=search)
        )

    # Aplicar filtro secund√°rio por organiza√ß√£o (dentro do escopo permitido)
    if organizacao_id:
        if organizacao_id.startswith('orgao_'):
            orgao_id = organizacao_id.replace('orgao_', '')
            # Aplicar filtro do √≥rg√£o: permitir se superusu√°rio, sem fun√ß√£o ativa, ou dentro do escopo da fun√ß√£o
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or (funcao_usuario.orgao and str(funcao_usuario.orgao.id) == orgao_id)
                ))):
                # Filtrar militares lotados no √≥rg√£o E SUA DESCEND√äNCIA (GC, Unidades, Sub-Unidades)
                militares = militares.filter(
                    lotacoes__orgao_id=orgao_id,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('gc_'):
            gc_id = organizacao_id.replace('gc_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or
                    (funcao_usuario.grande_comando and str(funcao_usuario.grande_comando.id) == gc_id) or
                    (funcao_usuario.funcao_militar.acesso == 'ORGAO')
                ))):
                # Filtrar militares lotados no GC E SUA DESCEND√äNCIA (Unidades, Sub-Unidades)
                militares = militares.filter(
                    lotacoes__grande_comando_id=gc_id,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('unidade_'):
            unidade_id = organizacao_id.replace('unidade_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or 
                    (funcao_usuario.unidade and str(funcao_usuario.unidade.id) == unidade_id) or
                    (funcao_usuario.funcao_militar.acesso in ['ORGAO', 'GRANDE_COMANDO'])
                ))):
                # Filtrar militares lotados na Unidade E SUA DESCEND√äNCIA (Sub-Unidades)
                militares = militares.filter(
                    lotacoes__unidade_id=unidade_id,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('sub_'):
            sub_id = organizacao_id.replace('sub_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or 
                    (funcao_usuario.sub_unidade and str(funcao_usuario.sub_unidade.id) == sub_id) or
                    (funcao_usuario.funcao_militar.acesso in ['ORGAO', 'GRANDE_COMANDO', 'UNIDADE'])
                ))):
                # Somente lota√ß√µes da Subunidade selecionada (n√£o tem descend√™ncia)
                militares = militares.filter(
                    lotacoes__sub_unidade_id=sub_id,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()

    if status_filtro:
        militares = militares.filter(situacao=status_filtro)

    # Ordenar por hierarquia
    HIERARQUIA_POSTOS = {
        'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8, 'NVRR': 9,
        'ST': 10, '1S': 11, '2S': 12, '3S': 13, 'CAB': 14, 'SD': 15,
    }

    def ordenar_militar(militar):
        return HIERARQUIA_POSTOS.get(militar.posto_graduacao, 99)

    militares = sorted(militares, key=ordenar_militar)

    # Carregar abonos de planejadas para o m√™s/ano ANTES do loop dos militares
    abonos_planejadas = AbonoPlanejada.objects.filter(
        data_operacao__year=ano,
        data_operacao__month=mes
    ).select_related('militar', 'planejada')
    
    # Processar dados dos militares
    militares_data = []
    for militar in militares:
        # Buscar lota√ß√£o atual
        lotacao_atual = Lotacao.objects.filter(
            militar=militar,
            status='ATUAL',
            ativo=True
        ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').first()

        # Buscar escalas do militar no m√™s - buscar diretamente as escalas onde o militar foi inserido
        escalas_militar = EscalaServico.objects.filter(
            militares__militar=militar,
            data__gte=primeiro_dia,
            data__lte=ultimo_dia
        ).distinct()
        
        # N√£o aplicar filtro organizacional - mostrar todas as escalas onde o militar foi inserido

        # Calcular estat√≠sticas
        total_horas = 0
        turnos_por_dia = {}
        
        for escala in escalas_militar:
            escalas_militar_obj = EscalaMilitar.objects.filter(
                escala=escala,
                militar=militar
            )
            
            for escala_militar in escalas_militar_obj:
                # Calcular diferen√ßa de tempo (considerando virada do dia e turnos 24h)
                inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                fim = datetime.combine(escala.data, escala_militar.hora_fim)
                
                # Se termina no mesmo hor√°rio ou antes, considerar dia seguinte
                if fim <= inicio:
                    fim += timedelta(days=1)
                
                diferenca = fim - inicio
                horas = diferenca.total_seconds() / 3600
                
                # Se por algum motivo ainda for 0h, e o campo turno indicar 24h, ajustar
                if horas == 0 and getattr(escala_militar, 'turno', '') == '24h':
                    horas = 24
                total_horas += horas
                
                # Agrupar por dia (usar chave inteira do dia)
                dia_int = escala.data.day
                if dia_int not in turnos_por_dia:
                    turnos_por_dia[dia_int] = {
                        'turnos': [],
                        'total_horas': 0
                    }
                
                turnos_por_dia[dia_int]['turnos'].append({
                    'hora_inicio': escala_militar.hora_inicio,
                    'hora_fim': escala_militar.hora_fim,
                    'horas': round(horas, 1),
                    'funcao': escala_militar.funcao,
                    'tipo_servico': escala_militar.tipo_servico
                })
                turnos_por_dia[dia_int]['total_horas'] += horas

        # Arredondar totais
        for dia_k in turnos_por_dia:
            turnos_por_dia[dia_k]['total_horas'] = round(turnos_por_dia[dia_k]['total_horas'], 1)

        # Calcular contador de planejadas para este militar no m√™s
        planejadas_count = 0
        for abono in abonos_planejadas:
            if abono.militar.id == militar.id:
                tipo_planejada = abono.tipo_planejada
                if tipo_planejada == 'P1':
                    planejadas_count += 1
                elif tipo_planejada == 'P2':
                    planejadas_count += 2
                elif tipo_planejada == 'P3':
                    planejadas_count += 3
                elif tipo_planejada == 'P4':
                    planejadas_count += 4
                elif tipo_planejada == 'P5':
                    planejadas_count += 5

        militar_data = {
            'militar': militar,
            'lotacao_atual': lotacao_atual,
            'total_horas': round(total_horas, 1),
            'escalas_count': escalas_militar.count(),  # Usar escalas j√° filtradas por inst√¢ncia
            'planejadas_count': planejadas_count,
            'turnos_por_dia': turnos_por_dia
        }
        
        militares_data.append(militar_data)

    # Agrupar por lota√ß√£o
    from collections import defaultdict
    militares_por_lotacao = defaultdict(list)
    
    for militar_data in militares_data:
        lotacao_atual = militar_data['lotacao_atual']
        if lotacao_atual:
            # Mostrar apenas a OM espec√≠fica (sem ascend√™ncia)
            if lotacao_atual.sub_unidade:
                lotacao_nome = lotacao_atual.sub_unidade.nome
            elif lotacao_atual.unidade:
                lotacao_nome = lotacao_atual.unidade.nome
            elif lotacao_atual.grande_comando:
                lotacao_nome = lotacao_atual.grande_comando.nome
            elif lotacao_atual.orgao:
                lotacao_nome = lotacao_atual.orgao.nome
            else:
                lotacao_nome = 'Sem √≥rg√£o'
        else:
            lotacao_nome = "Sem lota√ß√£o"
            
        militares_por_lotacao[lotacao_nome].append(militar_data)

    # Ordenar militares dentro de cada lota√ß√£o
    for lotacao_nome in militares_por_lotacao:
        militares_por_lotacao[lotacao_nome].sort(
            key=lambda x: HIERARQUIA_POSTOS.get(x['militar'].posto_graduacao, 99)
        )

    # Converter para lista ordenada
    lotacoes_ordenadas = sorted(militares_por_lotacao.items())
    
    # Pagina√ß√£o
    from django.core.paginator import Paginator
    paginator = Paginator(lotacoes_ordenadas, 10)  # 10 lota√ß√µes por p√°gina
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    # Gerar op√ß√µes de filtro hier√°rquico baseadas no acesso do usu√°rio
    opcoes_filtro_hierarquico = []
    
    if funcao_usuario and funcao_usuario.funcao_militar:
        acesso = funcao_usuario.funcao_militar.acesso
        
        if acesso == 'TOTAL':
            # Acesso total - mostrar todas as organiza√ß√µes
            from .models import Orgao, GrandeComando, Unidade, SubUnidade
            
            # √ìrg√£os
            orgaos = Orgao.objects.filter(ativo=True).order_by('nome')
            for orgao in orgaos:
                opcoes_filtro_hierarquico.append({
                    'id': f'orgao_{orgao.id}',
                    'nome': orgao.nome,
                    'tipo': '√ìrg√£o',
                    'nivel': 1
                })
            
            # Grandes Comandos
            grandes_comandos = GrandeComando.objects.filter(ativo=True).select_related('orgao').order_by('orgao__nome', 'nome')
            for gc in grandes_comandos:
                opcoes_filtro_hierarquico.append({
                    'id': f'gc_{gc.id}',
                    'nome': f"{gc.orgao.nome} - {gc.nome}" if gc.orgao else gc.nome,
                    'tipo': 'Grande Comando',
                    'nivel': 2
                })
            
            # Unidades
            unidades = Unidade.objects.filter(ativo=True).select_related('grande_comando__orgao').order_by('grande_comando__orgao__nome', 'grande_comando__nome', 'nome')
            for unidade in unidades:
                nome_completo = unidade.nome
                if unidade.grande_comando:
                    nome_completo = f"{unidade.grande_comando.nome} - {nome_completo}"
                    if unidade.grande_comando.orgao:
                        nome_completo = f"{unidade.grande_comando.orgao.nome} - {nome_completo}"
                opcoes_filtro_hierarquico.append({
                    'id': f'unidade_{unidade.id}',
                    'nome': nome_completo,
                    'tipo': 'Unidade',
                    'nivel': 3
                })
            
            # Sub-Unidades
            sub_unidades = SubUnidade.objects.filter(ativo=True).select_related('unidade__grande_comando__orgao').order_by('unidade__grande_comando__orgao__nome', 'unidade__grande_comando__nome', 'unidade__nome', 'nome')
            for sub in sub_unidades:
                nome_completo = sub.nome
                if sub.unidade:
                    nome_completo = f"{sub.unidade.nome} - {nome_completo}"
                    if sub.unidade.grande_comando:
                        nome_completo = f"{sub.unidade.grande_comando.nome} - {nome_completo}"
                        if sub.unidade.grande_comando.orgao:
                            nome_completo = f"{sub.unidade.grande_comando.orgao.nome} - {nome_completo}"
                opcoes_filtro_hierarquico.append({
                    'id': f'sub_{sub.id}',
                    'nome': nome_completo,
                    'tipo': 'Sub-Unidade',
                    'nivel': 4
                })
                
        elif acesso == 'ORGAO' and funcao_usuario.orgao:
            # Acesso ao √≥rg√£o - mostrar √≥rg√£o e suas depend√™ncias
            opcoes_filtro_hierarquico.append({
                'id': f'orgao_{funcao_usuario.orgao.id}',
                'nome': funcao_usuario.orgao.nome,
                'tipo': '√ìrg√£o',
                'nivel': 1
            })
            
            # Grandes Comandos do √≥rg√£o
            grandes_comandos = GrandeComando.objects.filter(
                orgao=funcao_usuario.orgao,
                ativo=True
            ).order_by('nome')
            for gc in grandes_comandos:
                opcoes_filtro_hierarquico.append({
                    'id': f'gc_{gc.id}',
                    'nome': f"{funcao_usuario.orgao.nome} - {gc.nome}",
                    'tipo': 'Grande Comando',
                    'nivel': 2
                })
                
        elif acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
            # Acesso ao grande comando - mostrar GC e suas depend√™ncias
            opcoes_filtro_hierarquico.append({
                'id': f'gc_{funcao_usuario.grande_comando.id}',
                'nome': f"{funcao_usuario.grande_comando.orgao.nome if funcao_usuario.grande_comando.orgao else 'Sem √≥rg√£o'} - {funcao_usuario.grande_comando.nome}",
                'tipo': 'Grande Comando',
                'nivel': 2
            })
            
            # Unidades do grande comando
            unidades = Unidade.objects.filter(
                grande_comando=funcao_usuario.grande_comando,
                ativo=True
            ).order_by('nome')
            for unidade in unidades:
                opcoes_filtro_hierarquico.append({
                    'id': f'unidade_{unidade.id}',
                    'nome': f"{funcao_usuario.grande_comando.nome} - {unidade.nome}",
                    'tipo': 'Unidade',
                    'nivel': 3
                })
                
        elif acesso == 'UNIDADE' and funcao_usuario.unidade:
            # Acesso √† unidade - mostrar unidade e suas sub-unidades
            opcoes_filtro_hierarquico.append({
                'id': f'unidade_{funcao_usuario.unidade.id}',
                'nome': f"{funcao_usuario.unidade.grande_comando.nome if funcao_usuario.unidade.grande_comando else 'Sem GC'} - {funcao_usuario.unidade.nome}",
                'tipo': 'Unidade',
                'nivel': 3
            })
            
            # Sub-Unidades da unidade
            sub_unidades = SubUnidade.objects.filter(
                unidade=funcao_usuario.unidade,
                ativo=True
            ).order_by('nome')
            for sub in sub_unidades:
                opcoes_filtro_hierarquico.append({
                    'id': f'sub_{sub.id}',
                    'nome': f"{funcao_usuario.unidade.nome} - {sub.nome}",
                    'tipo': 'Sub-Unidade',
                    'nivel': 4
                })
                
        elif acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
            # Acesso √† sub-unidade - mostrar apenas a sub-unidade
            opcoes_filtro_hierarquico.append({
                'id': f'sub_{funcao_usuario.sub_unidade.id}',
                'nome': f"{funcao_usuario.sub_unidade.unidade.nome if funcao_usuario.sub_unidade.unidade else 'Sem unidade'} - {funcao_usuario.sub_unidade.nome}",
                'tipo': 'Sub-Unidade',
                'nivel': 4
            })
    
    # Ordenar op√ß√µes por n√≠vel e nome
    opcoes_filtro_hierarquico.sort(key=lambda x: (x['nivel'], x['nome']))

    # Estat√≠sticas gerais
    total_militares = len(militares_data)
    total_horas_mes = sum(militar['total_horas'] for militar in militares_data)
    total_escalas_mes = sum(militar['escalas_count'] for militar in militares_data)
    

    # Gerar anos dispon√≠veis de 2015 at√© 2050
    anos_disponiveis = list(range(2015, 2051))
    
    # Criar dicion√°rio de abonos por militar e dia para facilitar a verifica√ß√£o no template
    abonos_por_militar_dia = {}
    for abono in abonos_planejadas:
        militar_id = abono.militar.id
        dia = abono.data_operacao.day
        if militar_id not in abonos_por_militar_dia:
            abonos_por_militar_dia[militar_id] = {}
        abonos_por_militar_dia[militar_id][dia] = abono
    
    # Calcular total de planejadas do m√™s (P1=1, P2=2, P3=3, P4=4)
    total_planejadas_mes = 0
    for abono in abonos_planejadas:
        tipo_planejada = abono.tipo_planejada
        if tipo_planejada == 'P1':
            total_planejadas_mes += 1
        elif tipo_planejada == 'P2':
            total_planejadas_mes += 2
        elif tipo_planejada == 'P3':
            total_planejadas_mes += 3
        elif tipo_planejada == 'P4':
            total_planejadas_mes += 4
        elif tipo_planejada == 'P5':
            total_planejadas_mes += 5
    

    # Buscar fun√ß√µes do usu√°rio para o modal de assinatura
    from .models import UsuarioFuncaoMilitar
    funcoes_usuario = UsuarioFuncaoMilitar.objects.filter(
        usuario=request.user,
        ativo=True
    ).select_related('funcao_militar').order_by('funcao_militar__nome')

    context = {
        'militares_por_lotacao': page_obj.object_list,
        'page_obj': page_obj,
        'mes': mes,
        'ano': ano,
        'primeiro_dia': primeiro_dia,
        'ultimo_dia': ultimo_dia,
        'dias_mes': dias_mes,
        'search': search,
        'organizacao_id': organizacao_id,
        'status_filtro': status_filtro,
        'opcoes_filtro_hierarquico': opcoes_filtro_hierarquico,
        'funcao_usuario': funcao_usuario,
        'funcoes_usuario': funcoes_usuario,
        'is_paginated': page_obj.has_other_pages,
        'total_militares': total_militares,
        'total_horas_mes': total_horas_mes,
        'total_escalas_mes': total_escalas_mes,
        'total_planejadas_mes': total_planejadas_mes,
        'anos_disponiveis': anos_disponiveis,
        'abonos_planejadas': abonos_planejadas,
        'abonos_por_militar_dia': abonos_por_militar_dia,
    }

    return render(request, 'militares/escalas_configuracao.html', context)


@login_required
def escalas_abono_pdf(request):
    """Gerar PDF de escalas de abono por OM - replicando exatamente a estrutura da p√°gina"""
    # Receber par√¢metro de fun√ß√£o para assinatura (opcional)
    funcao_assinatura = request.GET.get('funcao', '')
    from .models import Militar, EscalaServico, EscalaMilitar, Lotacao, Orgao, GrandeComando, Unidade, SubUnidade, AbonoPlanejada
    from django.http import HttpResponse
    from datetime import datetime, timedelta
    from django.db.models import Q, Count, Sum
    from calendar import monthrange
    from .filtros_hierarquicos import aplicar_filtro_hierarquico_militares
    from .permissoes_hierarquicas import obter_funcao_militar_ativa
    import io
    from reportlab.lib.pagesizes import A4, landscape
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
    
    # Par√¢metros de filtro
    mes = int(request.GET.get('mes', datetime.now().month))
    ano = int(request.GET.get('ano', datetime.now().year))
    search = request.GET.get('search', '')
    organizacao_id = request.GET.get('organizacao_id', '')
    status_filtro = request.GET.get('status', '')
    
    # Mapeamento de siglas dos postos
    SIGLAS_POSTOS = {
        'CB': 'CEL',  # Coronel
        'TC': 'TC',   # Tenente Coronel
        'MJ': 'MJ',   # Major
        'CP': 'CP',   # Capit√£o
        '1T': '1¬∫ TEN', # 1¬∫ Tenente
        '2T': '2¬∫ TEN', # 2¬∫ Tenente
        'AS': 'ASP',  # Aspirante
        'AA': 'AA',   # Aluno Aspirante
        'NVRR': 'NVRR', # N√£o Vinculado ao Registro de Reservistas
        'ST': 'ST',   # Subtenente
        '1S': '1¬∫ SGT', # 1¬∫ Sargento
        '2S': '2¬∫ SGT', # 2¬∫ Sargento
        '3S': '3¬∫ SGT', # 3¬∫ Sargento
        'CAB': 'CAB', # Cabo
        'SD': 'SD',   # Soldado
    }
    
    # Calcular datas do m√™s
    primeiro_dia = datetime(ano, mes, 1).date()
    ultimo_dia = datetime(ano, mes, monthrange(ano, mes)[1]).date()
    
    # Feriados fixos nacionais (MM-DD) com nomes
    feriados_fixos = {
        '01-01': 'Confraterniza√ß√£o Universal',
        '04-21': 'Tiradentes',
        '05-01': 'Dia do Trabalho',
        '09-07': 'Independ√™ncia do Brasil',
        '10-12': 'Nossa Senhora Aparecida',
        '11-02': 'Finados',
        '11-15': 'Proclama√ß√£o da Rep√∫blica',
        '11-20': 'Dia da Consci√™ncia Negra',
        '12-25': 'Natal',
    }
    # Feriados ESTADUAIS do Piau√≠ (MM-DD) com nomes
    feriados_piaui = {
        '03-13': 'Batalha do Jenipapo',
        '10-19': 'Dia do Piau√≠',
    }

    # Feriados m√≥veis (calculados por ano) ‚Äì Sexta-feira Santa e Corpus Christi
    def calcular_pascoa(y):
        # Algoritmo de Butcher para calend√°rio gregoriano
        a = y % 19
        b = y // 100
        c = y % 100
        d = b // 4
        e = b % 4
        f = (b + 8) // 25
        g = (b - f + 1) // 3
        h = (19 * a + b - d - g + 15) % 30
        i = c // 4
        k = c % 4
        l = (32 + 2 * e + 2 * i - h - k) % 7
        m = (a + 11 * h + 22 * l) // 451
        month = (h + l - 7 * m + 114) // 31
        day = ((h + l - 7 * m + 114) % 31) + 1
        return datetime(y, month, day).date()

    pascoa = calcular_pascoa(ano)
    sexta_santa = pascoa - timedelta(days=2)
    corpus_christi = pascoa + timedelta(days=60)
    feriados_moveis = {
        sexta_santa: 'Sexta-feira Santa',
        corpus_christi: 'Corpus Christi'
    }
    
    # Obter fun√ß√£o do usu√°rio para controle de acesso
    funcao_usuario = obter_funcao_militar_ativa(request.user)
    
    # Gerar lista de dias do m√™s com feriados
    dias_mes = []
    for dia in range(1, ultimo_dia.day + 1):
        data_dia = datetime(ano, mes, dia).date()
        mm_dd = data_dia.strftime('%m-%d')
        # Determinar nome do feriado (nacionais, estaduais e m√≥veis)
        nome_feriado = None
        tipo_feriado = None
        if mm_dd in feriados_fixos:
            nome_feriado = feriados_fixos[mm_dd]
            tipo_feriado = 'nacional'
        elif mm_dd in feriados_piaui:
            nome_feriado = feriados_piaui[mm_dd]
            tipo_feriado = 'estadual'
        elif data_dia in feriados_moveis:
            nome_feriado = feriados_moveis[data_dia]
            tipo_feriado = 'nacional'
        
        # Mapear dias da semana para portugu√™s
        dias_semana_pt = {
            0: 'Segunda', 1: 'Ter√ßa', 2: 'Quarta', 3: 'Quinta', 
            4: 'Sexta', 5: 'S√°bado', 6: 'Domingo'
        }
        
        dias_mes.append({
            'dia': dia,
            'dia_semana': dias_semana_pt[data_dia.weekday()],
            'data': data_dia,
            'is_weekend': data_dia.weekday() >= 5,
            'is_holiday': nome_feriado is not None,
            'nome_feriado': nome_feriado,
            'tipo_feriado': tipo_feriado
        })
    
    # Buscar militares (excluir inativos para n√£o esconder PRONTO/FERIAS etc.)
    militares = Militar.objects.exclude(classificacao='INATIVO').select_related().prefetch_related('lotacoes')
    
    # Aplicar filtro hier√°rquico baseado no acesso da fun√ß√£o
    if funcao_usuario and funcao_usuario.funcao_militar:
        acesso = funcao_usuario.funcao_militar.acesso
        
        if acesso == 'TOTAL':
            # Acesso total - pode ver todos os militares
            pass
        elif acesso == 'ORGAO' and funcao_usuario.orgao:
            # Acesso ao √≥rg√£o - mostrar militares lotados no √≥rg√£o e suas depend√™ncias
            militares = militares.filter(
                lotacoes__orgao=funcao_usuario.orgao,
                lotacoes__status='ATUAL',
                lotacoes__ativo=True
            ).distinct()
        elif acesso == 'GRANDE_COMANDO' and funcao_usuario.grande_comando:
            # Acesso ao grande comando - mostrar militares lotados no GC e suas depend√™ncias
            militares = militares.filter(
                lotacoes__grande_comando=funcao_usuario.grande_comando,
                lotacoes__status='ATUAL',
                lotacoes__ativo=True
            ).distinct()
        elif acesso == 'UNIDADE' and funcao_usuario.unidade:
            # Acesso √† unidade - mostrar militares lotados na unidade e suas sub-unidades
            militares = militares.filter(
                lotacoes__unidade=funcao_usuario.unidade,
                lotacoes__status='ATUAL',
                lotacoes__ativo=True
            ).distinct()
        elif acesso == 'SUBUNIDADE' and funcao_usuario.sub_unidade:
            # Acesso √† sub-unidade - mostrar apenas militares lotados na sub-unidade
            militares = militares.filter(
                lotacoes__sub_unidade=funcao_usuario.sub_unidade,
                lotacoes__status='ATUAL',
                lotacoes__ativo=True
            ).distinct()
        else:
            # Se n√£o tem acesso definido, n√£o mostrar nenhum militar
            militares = militares.none()
    else:
        # Se n√£o tem fun√ß√£o ativa, manter militares ATIVOS (restri√ß√£o ser√° feita pelo filtro de organiza√ß√£o, se fornecido)
        # Superusu√°rio tamb√©m mant√©m visualiza√ß√£o ampla
        if not request.user.is_superuser:
            pass  # mant√©m filtro padr√£o de ATIVO j√° aplicado acima

    # Aplicar filtros adicionais
    if search:
        militares = militares.filter(
            Q(nome_completo__icontains=search) |
            Q(matricula__icontains=search) |
            Q(nome_guerra__icontains=search)
        )

    # Aplicar filtro secund√°rio por organiza√ß√£o (dentro do escopo permitido)
    if organizacao_id:
        if organizacao_id.startswith('orgao_'):
            orgao_id = organizacao_id.replace('orgao_', '')
            # Aplicar filtro do √≥rg√£o: permitir se superusu√°rio, sem fun√ß√£o ativa, ou dentro do escopo da fun√ß√£o
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or (funcao_usuario.orgao and str(funcao_usuario.orgao.id) == orgao_id)
                ))):
                # Filtrar APENAS militares lotados diretamente no √≥rg√£o (sem GC/Unidade/Sub)
                militares = militares.filter(
                    lotacoes__orgao_id=orgao_id,
                    lotacoes__grande_comando__isnull=True,
                    lotacoes__unidade__isnull=True,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('gc_'):
            gc_id = organizacao_id.replace('gc_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or
                    (funcao_usuario.grande_comando and str(funcao_usuario.grande_comando.id) == gc_id) or
                    (funcao_usuario.funcao_militar.acesso == 'ORGAO')
                ))):
                # Filtrar APENAS militares lotados diretamente no GC (sem Unidade/Sub)
                militares = militares.filter(
                    lotacoes__grande_comando_id=gc_id,
                    lotacoes__unidade__isnull=True,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('unidade_'):
            unidade_id = organizacao_id.replace('unidade_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or 
                    (funcao_usuario.unidade and str(funcao_usuario.unidade.id) == unidade_id) or
                    (funcao_usuario.funcao_militar.acesso in ['ORGAO', 'GRANDE_COMANDO'])
                ))):
                # Filtrar APENAS militares lotados diretamente na Unidade (sem Sub)
                militares = militares.filter(
                    lotacoes__unidade_id=unidade_id,
                    lotacoes__sub_unidade__isnull=True,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()
        elif organizacao_id.startswith('sub_'):
            sub_id = organizacao_id.replace('sub_', '')
            if (request.user.is_superuser or not funcao_usuario or
                (funcao_usuario and funcao_usuario.funcao_militar and (
                    funcao_usuario.funcao_militar.acesso == 'TOTAL' or 
                    (funcao_usuario.sub_unidade and str(funcao_usuario.sub_unidade.id) == sub_id) or
                    (funcao_usuario.funcao_militar.acesso in ['ORGAO', 'GRANDE_COMANDO', 'UNIDADE'])
                ))):
                # Somente lota√ß√µes da Subunidade selecionada
                militares = militares.filter(
                    lotacoes__sub_unidade_id=sub_id,
                    lotacoes__status='ATUAL',
                    lotacoes__ativo=True
                ).distinct()

    if status_filtro:
        militares = militares.filter(situacao=status_filtro)

    # Ordenar por hierarquia
    HIERARQUIA_POSTOS = {
        'CB': 1, 'TC': 2, 'MJ': 3, 'CP': 4, '1T': 5, '2T': 6, 'AS': 7, 'AA': 8, 'NVRR': 9,
        'ST': 10, '1S': 11, '2S': 12, '3S': 13, 'CAB': 14, 'SD': 15,
    }

    def ordenar_militar(militar):
        return HIERARQUIA_POSTOS.get(militar.posto_graduacao, 99)

    militares = sorted(militares, key=ordenar_militar)

    # Carregar abonos de planejadas para o m√™s/ano ANTES do loop dos militares
    abonos_planejadas = AbonoPlanejada.objects.filter(
        data_operacao__year=ano,
        data_operacao__month=mes
    ).select_related('militar', 'planejada')
    
    # Processar dados dos militares
    militares_data = []
    for militar in militares:
        # Buscar lota√ß√£o atual
        lotacao_atual = Lotacao.objects.filter(
            militar=militar,
            status='ATUAL',
            ativo=True
        ).select_related('orgao', 'grande_comando', 'unidade', 'sub_unidade').first()

        # Buscar escalas do militar no m√™s - buscar diretamente as escalas onde o militar foi inserido
        escalas_militar = EscalaServico.objects.filter(
            militares__militar=militar,
            data__gte=primeiro_dia,
            data__lte=ultimo_dia
        ).distinct()
        
        # Calcular estat√≠sticas
        total_horas = 0
        turnos_por_dia = {}
        
        for escala in escalas_militar:
            escalas_militar_obj = EscalaMilitar.objects.filter(
                escala=escala,
                militar=militar
            )
            
            for escala_militar in escalas_militar_obj:
                # Calcular diferen√ßa de tempo (considerando virada do dia e turnos 24h)
                inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                fim = datetime.combine(escala.data, escala_militar.hora_fim)
                
                # Se termina no mesmo hor√°rio ou antes, considerar dia seguinte
                if fim <= inicio:
                    fim += timedelta(days=1)
                
                diferenca = fim - inicio
                horas = diferenca.total_seconds() / 3600
                
                # Se por algum motivo ainda for 0h, e o campo turno indicar 24h, ajustar
                if horas == 0 and getattr(escala_militar, 'turno', '') == '24h':
                    horas = 24
                total_horas += horas
                
                # Agrupar por dia (usar chave inteira do dia)
                dia_int = escala.data.day
                if dia_int not in turnos_por_dia:
                    turnos_por_dia[dia_int] = {
                        'turnos': [],
                        'total_horas': 0
                    }
                
                turnos_por_dia[dia_int]['turnos'].append({
                    'hora_inicio': escala_militar.hora_inicio,
                    'hora_fim': escala_militar.hora_fim,
                    'horas': round(horas, 1),
                    'funcao': escala_militar.funcao,
                    'tipo_servico': escala_militar.tipo_servico
                })
                turnos_por_dia[dia_int]['total_horas'] += horas

        # Arredondar totais
        for dia_k in turnos_por_dia:
            turnos_por_dia[dia_k]['total_horas'] = round(turnos_por_dia[dia_k]['total_horas'], 1)

        # Calcular contador de planejadas para este militar no m√™s
        planejadas_count = 0
        for abono in abonos_planejadas:
            if abono.militar.id == militar.id:
                tipo_planejada = abono.tipo_planejada
                if tipo_planejada == 'P1':
                    planejadas_count += 1
                elif tipo_planejada == 'P2':
                    planejadas_count += 2
                elif tipo_planejada == 'P3':
                    planejadas_count += 3
                elif tipo_planejada == 'P4':
                    planejadas_count += 4
                elif tipo_planejada == 'P5':
                    planejadas_count += 5

        militar_data = {
            'militar': militar,
            'lotacao_atual': lotacao_atual,
            'total_horas': round(total_horas, 1),
            'escalas_count': escalas_militar.count(),  # Usar escalas j√° filtradas por inst√¢ncia
            'planejadas_count': planejadas_count,
            'turnos_por_dia': turnos_por_dia
        }
        
        militares_data.append(militar_data)

    # Agrupar por lota√ß√£o
    from collections import defaultdict
    militares_por_lotacao = defaultdict(list)
    
    for militar_data in militares_data:
        lotacao_atual = militar_data['lotacao_atual']
        if lotacao_atual:
            # Construir nome hier√°rquico da lota√ß√£o
            lotacao_nome = lotacao_atual.orgao.nome if lotacao_atual.orgao else 'Sem √≥rg√£o'
            if lotacao_atual.grande_comando:
                lotacao_nome += f" - {lotacao_atual.grande_comando.nome}"
            if lotacao_atual.unidade:
                lotacao_nome += f" - {lotacao_atual.unidade.nome}"
            if lotacao_atual.sub_unidade:
                lotacao_nome += f" - {lotacao_atual.sub_unidade.nome}"
        else:
            lotacao_nome = "Sem lota√ß√£o"
            
        militares_por_lotacao[lotacao_nome].append(militar_data)

    # Ordenar militares dentro de cada lota√ß√£o
    for lotacao_nome in militares_por_lotacao:
        militares_por_lotacao[lotacao_nome].sort(
            key=lambda x: HIERARQUIA_POSTOS.get(x['militar'].posto_graduacao, 99)
        )

    # Converter para lista ordenada
    lotacoes_ordenadas = sorted(militares_por_lotacao.items())
    
    # Criar dicion√°rio de abonos por militar e dia para facilitar a verifica√ß√£o
    abonos_por_militar_dia = {}
    for abono in abonos_planejadas:
        militar_id = abono.militar.id
        dia = abono.data_operacao.day
        if militar_id not in abonos_por_militar_dia:
            abonos_por_militar_dia[militar_id] = {}
        abonos_por_militar_dia[militar_id][dia] = abono
    
    # Criar PDF em landscape para caber mais colunas
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=landscape(A4), rightMargin=0.3*cm, leftMargin=0.3*cm, topMargin=0.5*cm, bottomMargin=0.5*cm)
    
    # Estilos
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=12,
        spaceAfter=15,
        alignment=TA_CENTER,
        textColor=colors.black
    )
    
    org_style = ParagraphStyle(
        'OrgTitle',
        parent=styles['Heading3'],
        fontSize=9,
        spaceAfter=8,
        spaceBefore=0,
        textColor=colors.black,
        alignment=TA_CENTER
    )
    
    # Estilo para X centralizado
    x_style = ParagraphStyle(
        'XStyle',
        parent=styles['Normal'],
        fontSize=8,
        alignment=TA_CENTER,
        textColor=colors.grey
    )
    
    # Estilo centralizado para c√©lulas da tabela
    cell_style = ParagraphStyle(
        'CellStyle',
        parent=styles['Normal'],
        fontSize=5,
        alignment=TA_CENTER
    )
    
    # Estilo para cabe√ßalho centralizado
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10)
    
    # Conte√∫do do PDF
    story = []
    
    # Logo/Bras√£o centralizado
    import os
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        from reportlab.platypus import Image
        story.append(Image(logo_path, width=2*cm, height=2*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Determinar local de gera√ß√£o e endere√ßo baseado na organiza√ß√£o militar que est√° gerando o PDF
    local_geracao = "DIRETORIA DE GEST√ÉO DE PESSOAS"
    endereco_organizacao = None
    
    # Se houver filtro por organiza√ß√£o, buscar essa organiza√ß√£o espec√≠fica e seu endere√ßo
    if organizacao_id:
        if organizacao_id.startswith('orgao_'):
            orgao_id = organizacao_id.replace('orgao_', '')
            try:
                orgao = Orgao.objects.get(id=orgao_id)
                local_geracao = orgao.nome.upper()
                endereco_organizacao = orgao.endereco
            except Orgao.DoesNotExist:
                pass
        elif organizacao_id.startswith('gc_'):
            gc_id = organizacao_id.replace('gc_', '')
            try:
                gc = GrandeComando.objects.get(id=gc_id)
                # Buscar o √≥rg√£o pai
                if gc.orgao:
                    local_geracao = f"{gc.orgao.nome.upper()} - {gc.nome.upper()}"
                else:
                    local_geracao = gc.nome.upper()
                endereco_organizacao = gc.endereco if gc.endereco else (gc.orgao.endereco if gc.orgao and gc.orgao.endereco else None)
            except GrandeComando.DoesNotExist:
                pass
        elif organizacao_id.startswith('unidade_'):
            unidade_id = organizacao_id.replace('unidade_', '')
            try:
                unidade = Unidade.objects.get(id=unidade_id)
                hierarquia = []
                if unidade.orgao:
                    hierarquia.append(unidade.orgao.nome.upper())
                if unidade.grande_comando:
                    hierarquia.append(unidade.grande_comando.nome.upper())
                hierarquia.append(unidade.nome.upper())
                local_geracao = " - ".join(hierarquia)
                endereco_organizacao = unidade.endereco if unidade.endereco else (unidade.grande_comando.endereco if unidade.grande_comando and unidade.grande_comando.endereco else (unidade.orgao.endereco if unidade.orgao and unidade.orgao.endereco else None))
            except Unidade.DoesNotExist:
                pass
        elif organizacao_id.startswith('sub_'):
            sub_id = organizacao_id.replace('sub_', '')
            try:
                sub = SubUnidade.objects.get(id=sub_id)
                hierarquia = []
                if sub.unidade and sub.unidade.orgao:
                    hierarquia.append(sub.unidade.orgao.nome.upper())
                if sub.unidade and sub.unidade.grande_comando:
                    hierarquia.append(sub.unidade.grande_comando.nome.upper())
                if sub.unidade:
                    hierarquia.append(sub.unidade.nome.upper())
                hierarquia.append(sub.nome.upper())
                local_geracao = " - ".join(hierarquia)
                # Tentar buscar endere√ßo da sub-unidade, depois unidade, depois grande comando, depois √≥rg√£o
                endereco_organizacao = sub.endereco if sub.endereco else (sub.unidade.endereco if sub.unidade and sub.unidade.endereco else (sub.unidade.grande_comando.endereco if sub.unidade and sub.unidade.grande_comando and sub.unidade.grande_comando.endereco else (sub.unidade.orgao.endereco if sub.unidade and sub.unidade.orgao and sub.unidade.orgao.endereco else None)))
            except SubUnidade.DoesNotExist:
                pass
    
    # Se n√£o houver filtro espec√≠fico, usar a primeira organiza√ß√£o do PDF
    if local_geracao == "DIRETORIA DE GEST√ÉO DE PESSOAS" and lotacoes_ordenadas:
        # Pegar a primeira organiza√ß√£o do PDF
        primeira_lotacao_nome = lotacoes_ordenadas[0][0]
        if primeira_lotacao_nome and primeira_lotacao_nome != "Sem lota√ß√£o":
            local_geracao = primeira_lotacao_nome.upper()
            # Tentar buscar endere√ßo da primeira lota√ß√£o
            primeira_lotacao_data = lotacoes_ordenadas[0][1]
            if primeira_lotacao_data:
                primeiro_militar_data = primeira_lotacao_data[0] if primeira_lotacao_data else None
                if primeiro_militar_data and primeiro_militar_data.get('lotacao_atual'):
                    lotacao_atual = primeiro_militar_data['lotacao_atual']
                    # Buscar endere√ßo da organiza√ß√£o da lota√ß√£o
                    if lotacao_atual.sub_unidade and lotacao_atual.sub_unidade.endereco:
                        endereco_organizacao = lotacao_atual.sub_unidade.endereco
                    elif lotacao_atual.unidade and lotacao_atual.unidade.endereco:
                        endereco_organizacao = lotacao_atual.unidade.endereco
                    elif lotacao_atual.grande_comando and lotacao_atual.grande_comando.endereco:
                        endereco_organizacao = lotacao_atual.grande_comando.endereco
                    elif lotacao_atual.orgao and lotacao_atual.orgao.endereco:
                        endereco_organizacao = lotacao_atual.orgao.endereco
    
    # Cabe√ßalho institucional
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        local_geracao
    ]
    
    # Adicionar endere√ßo se existir
    if endereco_organizacao:
        cabecalho.append(endereco_organizacao)
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))
    story.append(Spacer(1, 10))
    
    # Mapear meses em portugu√™s
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    # T√≠tulo principal (em uma √∫nica linha)
    nome_mes = meses_pt[mes].upper()
    titulo = f"ESCALA DE ABONAR DO M√äS DE {nome_mes} DE {ano}"
    story.append(Paragraph(titulo, title_style))
    
    # Lista por organiza√ß√£o
    for lotacao_nome, militares_lotacao in lotacoes_ordenadas:
        # Obter apenas a OM espec√≠fica (sem hierarquia)
        om_especifica = lotacao_nome.split(' - ')[-1] if ' - ' in lotacao_nome else lotacao_nome
        # T√≠tulo da organiza√ß√£o em mai√∫sculas, centralizado e preto
        titulo_om = f"{om_especifica.upper()} ({len(militares_lotacao)} MILITAR{'ES' if len(militares_lotacao) != 1 else ''})"
        story.append(Paragraph(titulo_om, org_style))
        
        # Estilo centralizado para cabe√ßalho
        header_style = ParagraphStyle(
            'HeaderStyle',
            parent=styles['Normal'],
            fontSize=6,
            alignment=TA_CENTER
        )
        
        # Cabe√ßalho da tabela principal
        header_data = [Paragraph('Militar', header_style)]
        
        # Adicionar cabe√ßalhos dos dias
        for d in dias_mes:
            dia_texto = f"{d['dia_semana'][:1]}<br/>{d['dia']:02d}"
            header_data.append(Paragraph(dia_texto, header_style))
        
        # Criar tabela de dados
        table_data = [header_data]
        # Rastrear tipos de c√©lulas para aplicar backgrounds
        cell_types = []  # Lista de listas: 'folga', 'turno', 'planejada', 'turno_planejada'
        
        for militar_data in militares_lotacao:
            militar = militar_data['militar']
            
            # Obter sigla do posto (ou usar o pr√≥prio c√≥digo se n√£o houver mapeamento)
            posto_sigla = SIGLAS_POSTOS.get(militar.posto_graduacao, militar.posto_graduacao)
            # Criar estilo centralizado para nome do militar
            nome_style = ParagraphStyle(
                'NomeStyle',
                parent=styles['Normal'],
                fontSize=5,
                alignment=TA_CENTER
            )
            row = [Paragraph(f"{posto_sigla} {militar.nome_guerra}", nome_style)]
            row_types = []
            
            # Adicionar dados de cada dia
            for d in dias_mes:
                dia_content = []
                has_turnos = False
                has_planejadas = False
                
                # Turnos de escala
                if d['dia'] in militar_data['turnos_por_dia']:
                    turnos_dia = militar_data['turnos_por_dia'][d['dia']]
                    for turno in turnos_dia['turnos']:
                        # Mostrar apenas o n√∫mero inteiro antes do ponto + h
                        horas_int = int(turno['horas'])
                        dia_content.append(f"{horas_int}h")
                        has_turnos = True
                
                # Abonos de planejadas
                militar_id = militar.id
                if militar_id in abonos_por_militar_dia and d['dia'] in abonos_por_militar_dia[militar_id]:
                    abono = abonos_por_militar_dia[militar_id][d['dia']]
                    dia_content.append(f"{abono.tipo_planejada}")
                    has_planejadas = True
                
                # Criar par√°grafo com formata√ß√µes
                if has_turnos and has_planejadas:
                    # Mistura de turnos e planejadas
                    content_text = "<br/>".join(dia_content)
                    para = Paragraph(f'<b>{content_text}</b>', cell_style)
                    row_types.append('turno_planejada')
                elif has_turnos:
                    # Apenas turnos - negrito preto
                    content_text = "<br/>".join(dia_content)
                    para = Paragraph(f'<b>{content_text}</b>', cell_style)
                    row_types.append('turno')
                elif has_planejadas:
                    # Apenas planejadas
                    content_text = "<br/>".join(dia_content)
                    para = Paragraph(content_text, cell_style)
                    row_types.append('planejada')
                else:
                    # Folga - "F" em negrito
                    para = Paragraph('<b>F</b>', cell_style)
                    row_types.append('folga')
                
                row.append(para)
            
            table_data.append(row)
            cell_types.append(row_types)
        
        # Criar tabela
        col_widths = [2.5*cm] + [0.8*cm] * len(dias_mes)
        militares_table = Table(table_data, colWidths=col_widths)
        
        # Estilo da tabela
        militares_table.setStyle(TableStyle([
            # Cabe√ßalho
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 6),
            ('FONTSIZE', (0, 1), (-1, -1), 5),
            
            # Bordas
            ('GRID', (0, 0), (-1, -1), 0.2, colors.black),
            
            # Altura das linhas
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            
            # Padding reduzido para otimizar espa√ßo
            ('LEFTPADDING', (0, 0), (-1, -1), 1),
            ('RIGHTPADDING', (0, 0), (-1, -1), 1),
            ('TOPPADDING', (0, 0), (-1, -1), 2),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 2),
        ]))
        
        # Cores modernas usando HexColor
        from reportlab.lib.colors import HexColor
        
        # Folga: Verde moderno (verde menta suave)
        verde_folga = HexColor('#90EE90')  # Light Green mais moderno
        
        # Turno: Vermelho moderno (coral/salm√£o suave)
        vermelho_turno = HexColor('#FF6B6B')  # Coral moderno
        
        # Planejada: Amarelo moderno (dourado/amber suave)
        amarelo_planejada = HexColor('#FFD93D')  # Amber moderno
        
        # Aplicar backgrounds nas c√©lulas baseado no tipo
        for row_idx, row_types in enumerate(cell_types):
            # row_idx + 1 porque a linha 0 √© o cabe√ßalho
            row_num = row_idx + 1
            for col_idx, cell_type in enumerate(row_types):
                # col_idx + 1 porque a coluna 0 √© o nome do militar
                col_num = col_idx + 1
                if cell_type == 'folga':
                    militares_table.setStyle(TableStyle([
                        ('BACKGROUND', (col_num, row_num), (col_num, row_num), verde_folga),
                    ]))
                elif cell_type == 'turno':
                    militares_table.setStyle(TableStyle([
                        ('BACKGROUND', (col_num, row_num), (col_num, row_num), vermelho_turno),
                    ]))
                elif cell_type == 'planejada':
                    militares_table.setStyle(TableStyle([
                        ('BACKGROUND', (col_num, row_num), (col_num, row_num), amarelo_planejada),
                    ]))
                elif cell_type == 'turno_planejada':
                    # Mistura: vermelho como turno tem prioridade visual
                    militares_table.setStyle(TableStyle([
                        ('BACKGROUND', (col_num, row_num), (col_num, row_num), vermelho_turno),
                    ]))
        
        # Aplicar cor vermelha para fins de semana e feriados nas colunas dos dias
        for i, d in enumerate(dias_mes):
            col_index = 1 + i  # Coluna do dia (1 √© o √≠ndice da primeira coluna de dias)
            if d['is_holiday'] or d['is_weekend']:
                militares_table.setStyle(TableStyle([
                    ('TEXTCOLOR', (col_index, 0), (col_index, -1), colors.red),
                ]))
        
        story.append(militares_table)
        story.append(Spacer(1, 15))
    
    # Adicionar assinatura eletr√¥nica se fun√ß√£o fornecida
    if funcao_assinatura:
        story.append(Spacer(1, 1*cm))
        
        # Obter informa√ß√µes do assinante e cidade
        from django.utils import timezone
        import pytz
        
        try:
            militar_logado = request.user.militar if hasattr(request.user, 'militar') else None
            
            # Obter cidade
            if militar_logado and militar_logado.cidade:
                cidade_doc = militar_logado.cidade
            else:
                cidade_doc = "Teresina"
            cidade_estado = f"{cidade_doc} - PI"
            
            # Obter posto completo
            if militar_logado:
                posto_abreviado = militar_logado.posto_graduacao or ''
                posto_completo = militar_logado.get_posto_graduacao_display() or posto_abreviado
                if "BM" not in posto_completo:
                    posto_completo = f"{posto_completo} BM"
                nome_posto = f"{posto_completo}<br/>{militar_logado.nome_completo}"
            else:
                nome_posto = request.user.get_full_name() or request.user.username
            
        except:
            cidade_estado = "Teresina - PI"
            nome_posto = request.user.get_full_name() or request.user.username
        
        # Data por extenso - usar timezone de Bras√≠lia
        brasilia_tz = pytz.timezone('America/Sao_Paulo')
        data_atual = timezone.now().astimezone(brasilia_tz) if timezone.is_aware(timezone.now()) else brasilia_tz.localize(timezone.now())
        
        meses_extenso = {
            1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril',
            5: 'maio', 6: 'junho', 7: 'julho', 8: 'agosto',
            9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
        }
        data_formatada_extenso = f"{data_atual.day} de {meses_extenso[data_atual.month]} de {data_atual.year}"
        
        # Fun√ß√£o selecionada
        funcao_display = funcao_assinatura if funcao_assinatura else ""
        
        # Construir texto - cidade, data, nome com posto, fun√ß√£o
        texto_info = f"{cidade_estado}, {data_formatada_extenso}.<br/><br/>{nome_posto}<br/>{funcao_display}"
        
        # Estilo para o texto (centralizado)
        style_info = ParagraphStyle('info', parent=styles['Normal'], fontSize=9, fontName='Helvetica', 
                                     alignment=TA_CENTER, textColor=colors.HexColor('#2c3e50'), spaceAfter=8,
                                     leading=12)
        
        story.append(Paragraph(texto_info, style_info))
        
        # Adicionar assinatura eletr√¥nica
        from .utils import obter_caminho_assinatura_eletronica
        
        story.append(Spacer(1, 1*cm))
        
        # Obter assinante (usu√°rio logado) com posto
        try:
            militar_logado_assinatura = request.user.militar if hasattr(request.user, 'militar') else None
            if militar_logado_assinatura:
                nome_assinante = militar_logado_assinatura.nome_completo
                posto_abreviado_assinatura = militar_logado_assinatura.posto_graduacao or ''
                posto_completo_assinatura = militar_logado_assinatura.get_posto_graduacao_display() or posto_abreviado_assinatura
                if "BM" not in posto_completo_assinatura:
                    posto_completo_assinatura = f"{posto_completo_assinatura} BM"
                assinante_com_posto = f"{nome_assinante} - {posto_completo_assinatura}"
            else:
                nome_assinante = request.user.get_full_name() or request.user.username
                assinante_com_posto = nome_assinante
        except:
            nome_assinante = request.user.get_full_name() or request.user.username
            assinante_com_posto = nome_assinante
        
        # Usar a fun√ß√£o formatar_data_assinatura para garantir timezone correto
        from .utils import formatar_data_assinatura
        data_hora = timezone.now()
        data_formatada, hora_formatada = formatar_data_assinatura(data_hora)
        
        # Incluir posto e fun√ß√£o na assinatura
        assinante_com_posto_funcao = f"{assinante_com_posto}"
        
        # Texto da assinatura eletr√¥nica seguindo o padr√£o dos outros PDFs
        texto_assinatura = (
            f"Documento assinado eletronicamente por {assinante_com_posto_funcao}, em {data_formatada} {hora_formatada}, "
            f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
        )
        
        # Estilo para texto alinhado √† esquerda
        style_assinatura_texto = ParagraphStyle('assinatura_texto', parent=styles['Normal'], fontSize=9, fontName='Helvetica', alignment=0, spaceAfter=1, spaceBefore=1, leading=12)
        
        # Calcular larguras dispon√≠veis
        largura_disponivel = landscape(A4)[0] - (1*cm * 2) - 0.04*cm
        largura_texto = largura_disponivel - 2.5*cm
        
        # Tabela de assinatura: Logo + Texto
        assinatura_data = [
            [Image(obter_caminho_assinatura_eletronica(), width=2.5*cm, height=1.8*cm), Paragraph(texto_assinatura, style_assinatura_texto)]
        ]
        
        assinatura_table = Table(assinatura_data, colWidths=[2.5*cm, largura_texto])
        assinatura_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # Logo centralizado
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('BOX', (0, 0), (-1, -1), 1, colors.grey),
        ]))
        
        story.append(assinatura_table)
    
    # Adicionar autenticador QR Code NO FINAL
    from .utils import gerar_autenticador_veracidade
    
    story.append(Spacer(1, 1*cm))
    
    # Criar um objeto fake com as informa√ß√µes do relat√≥rio de abono
    class RelatorioAbonoFake:
        def __init__(self):
            self.id = f"escala_abono_{mes:02d}_{ano}"
            self.pk = abs(hash(f"escala_abono_{mes:02d}_{ano}")) % 100000000  # Gera um pk num√©rico positivo a partir do hash
            self.tipo_documento = 'escala_abono'
    
    relatorio_fake = RelatorioAbonoFake()
    
    autenticador = gerar_autenticador_veracidade(relatorio_fake, request, tipo_documento='escala_abono')
    
    # Estilo para o texto do autenticador
    style_field_value = ParagraphStyle('field_value', parent=styles['Normal'], fontSize=8, fontName='Helvetica', alignment=0)
    
    # Largura dispon√≠vel para QR Code
    largura_disponivel_qr = landscape(A4)[0] - (1*cm * 2) - 0.04*cm
    largura_texto_qr = largura_disponivel_qr - 3*cm
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_field_value)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, largura_texto_qr])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (0, 0), 0),    # QR sem padding esquerdo
        ('RIGHTPADDING', (0, 0), (0, 0), 0),   # QR sem padding direito
        ('LEFTPADDING', (1, 0), (1, 0), 3),    # Texto com pouco padding esquerdo
        ('RIGHTPADDING', (1, 0), (1, 0), 0),   # Texto sem padding direito
        ('TOPPADDING', (0, 0), (-1, -1), 3),   # Reduzido de 6 para 3
        ('BOTTOMPADDING', (0, 0), (-1, -1), 3), # Reduzido de 6 para 3
        ('BOX', (0, 0), (-1, -1), 1, colors.grey),
    ]))
    
    story.append(rodape_table)
    
    # Construir PDF
    doc.build(story)
    pdf = buffer.getvalue()
    buffer.close()
    
    # Resposta HTTP
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'inline; filename="escala_abono_{mes:02d}_{ano}.pdf"'
    response.write(pdf)
    
    return response


@login_required
def escalas_create(request):
    """Criar nova escala de servi√ßo"""
    from .models import EscalaServico, EscalaMilitar
    from .forms import EscalaServicoForm
    from django.contrib import messages
    from django.shortcuts import redirect
    from django.db import transaction
    
    if request.method == 'POST':
        form = EscalaServicoForm(request.POST)
        if form.is_valid():
            try:
                with transaction.atomic():
                    escala = form.save(commit=False)
                    escala.criado_por = request.user
                    escala.save()
                    
                    messages.success(request, 'Escala de servi√ßo criada com sucesso!')
                    return redirect('militares:escalas_list')
            except Exception as e:
                messages.error(request, f'Erro ao criar escala: {str(e)}')
    else:
        form = EscalaServicoForm()
    
    context = {
        'form': form,
        'title': 'Criar Escala de Servi√ßo',
        'page_title': 'Criar Escala de Servi√ßo',
    }
    
    return render(request, 'militares/escalas_create.html', context)


@login_required
def escalas_edit(request, pk):
    """Editar escala de servi√ßo"""
    from .models import EscalaServico
    from .forms import EscalaServicoForm
    from django.contrib import messages
    from django.shortcuts import get_object_or_404, redirect
    from django.db import transaction
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    if request.method == 'POST':
        form = EscalaServicoForm(request.POST, instance=escala)
        if form.is_valid():
            try:
                with transaction.atomic():
                    form.save()
                    messages.success(request, 'Escala de servi√ßo atualizada com sucesso!')
                    return redirect('militares:escalas_list')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar escala: {str(e)}')
    else:
        form = EscalaServicoForm(instance=escala)
    
    context = {
        'form': form,
        'escala': escala,
        'title': 'Editar Escala de Servi√ßo',
        'page_title': 'Editar Escala de Servi√ßo',
    }
    
    return render(request, 'militares/escalas_edit.html', context)


@login_required
def escalas_delete(request, pk):
    """Deletar escala de servi√ßo"""
    from .models import EscalaServico
    from django.contrib import messages
    from django.shortcuts import get_object_or_404, redirect
    from django.db import transaction
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    if request.method == 'POST':
        try:
            with transaction.atomic():
                escala.delete()
                messages.success(request, 'Escala de servi√ßo deletada com sucesso!')
                return redirect('militares:escalas_list')
        except Exception as e:
            messages.error(request, f'Erro ao deletar escala: {str(e)}')
    
    context = {
        'escala': escala,
        'title': 'Deletar Escala de Servi√ßo',
        'page_title': 'Deletar Escala de Servi√ßo',
    }
    
    return render(request, 'militares/escalas_confirm_delete.html', context)


@login_required
def escalas_operacoes(request):
    """Opera√ß√µes das escalas de servi√ßo"""
    context = {
        'title': 'Opera√ß√µes Escalas',
        'page_title': 'Opera√ß√µes - Escalas de Servi√ßo',
    }
    return render(request, 'militares/escalas_operacoes.html', context)


@login_required
def escala_detail(request, pk):
    """Visualizar detalhes de uma escala espec√≠fica"""
    from .models import EscalaServico, EscalaMilitar
    from django.shortcuts import get_object_or_404
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    # Buscar militares escalados nesta escala ordenados por data de cria√ß√£o (primeira inserida para a √∫ltima)
    militares_escalados = EscalaMilitar.objects.filter(escala=escala).select_related('militar').order_by('id')
    
    # Organizar militares por equipe
    equipes = {}
    
    for escala_militar in militares_escalados:
        militar_info = {
            'id': escala_militar.id,
            'nome_completo': escala_militar.militar.nome_completo,
            'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
            'funcao_display': escala_militar.get_funcao_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'turno_display': escala_militar.get_turno_display(),
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'observacoes': escala_militar.observacoes or '',
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or ''
        }
        
        # Agrupar por equipe (todos os operacionais)
        if escala_militar.tipo_servico == 'operacional':
            equipe_nome = escala_militar.equipe or 'Sem Equipe Definida'
            if equipe_nome not in equipes:
                equipes[equipe_nome] = {
                    'nome': equipe_nome,
                    'militares': [],
                    'viatura': escala_militar.viatura or '',
                    'total_militares': 0
                }
            equipes[equipe_nome]['militares'].append(militar_info)
            equipes[equipe_nome]['total_militares'] += 1
    
    # Organizar militares por hor√°rio - agrupar quando o mesmo militar tem m√∫ltiplos turnos
    militares_por_horario = {}
    militares_operacionais = []
    militares_administrativos = []
    
    for escala_militar in militares_escalados:
        militar_info = {
            'id': escala_militar.id,
            'nome_completo': escala_militar.militar.nome_completo,
            'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
            'funcao_display': escala_militar.get_funcao_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'turno_display': escala_militar.get_turno_display(),
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'observacoes': escala_militar.observacoes or '',
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or ''
        }
        
        # Criar chave √∫nica para o militar + hor√°rio
        chave_militar_horario = f"{escala_militar.militar.id}_{escala_militar.hora_inicio}_{escala_militar.hora_fim}"
        
        if chave_militar_horario not in militares_por_horario:
            militares_por_horario[chave_militar_horario] = {
                'militar': militar_info,
                'turnos': []
            }
        
        # Adicionar informa√ß√µes do turno
        turno_info = {
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'turno_display': escala_militar.get_turno_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or '',
            'observacoes': escala_militar.observacoes or ''
        }
        
        militares_por_horario[chave_militar_horario]['turnos'].append(turno_info)
    
    # Converter para listas organizadas
    for chave, dados in militares_por_horario.items():
        militar_info = dados['militar']
        militar_info['turnos'] = dados['turnos']
        militar_info['total_turnos'] = len(dados['turnos'])
        
        if militar_info['tipo_servico'] == 'operacional':
            militares_operacionais.append(militar_info)
        else:
            militares_administrativos.append(militar_info)
    
    
    # Buscar assinaturas da escala
    assinaturas = escala.assinaturas.all().order_by('data_assinatura')
    
    # Verificar status das assinaturas
    tem_revisao = assinaturas.filter(tipo_assinatura='REVISAO').exists()
    tem_aprovacao = assinaturas.filter(tipo_assinatura='APROVACAO').exists()
    
    # Controle de altera√ß√µes para escalas aprovadas
    pode_alterar = False
    motivo_restricao = ""
    alteracoes = []
    
    # Superusu√°rios sempre podem alterar
    if request.user.is_superuser:
        pode_alterar = True
    elif escala.status == 'aprovada':
        from django.utils import timezone
        from .models import AlteracaoEscala
        
        # Verificar se o usu√°rio tem assinatura de aprova√ß√£o
        tem_assinatura_aprovacao = assinaturas.filter(
            tipo_assinatura='APROVACAO',
            assinado_por=request.user
        ).exists()
        
        # Verificar se pode alterar (apenas quem assinou como aprovador e at√© a data da escala)
        if tem_assinatura_aprovacao:
            if timezone.now().date() <= escala.data:
                pode_alterar = True
            else:
                motivo_restricao = f"Altera√ß√µes s√≥ s√£o permitidas at√© a data da escala ({escala.data.strftime('%d/%m/%Y')})"
        else:
            motivo_restricao = "Apenas quem assinou como aprovador pode fazer altera√ß√µes"
        
        # Buscar altera√ß√µes registradas
        alteracoes = AlteracaoEscala.objects.filter(escala=escala).order_by('-data_alteracao')
    
    # Criar lista simplificada de todos os militares escalados para exibi√ß√£o
    todos_militares_escalados = []
    try:
        for escala_militar in militares_escalados:
            try:
                militar_dict = {
                    'id': escala_militar.id,
                    'militar_id': escala_militar.militar.id,
                    'nome_completo': escala_militar.militar.nome_completo,
                    'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
                    'posto_graduacao_codigo': escala_militar.militar.posto_graduacao,
                    'foto_url': escala_militar.militar.foto.url if escala_militar.militar.foto else None,
                    'cpf': escala_militar.militar.cpf,
                    'funcao': escala_militar.funcao,
                    'funcao_display': escala_militar.get_funcao_display(),
                    'tipo_servico': escala_militar.tipo_servico,
                    'tipo_servico_display': escala_militar.get_tipo_servico_display(),
                    'turno': escala_militar.turno,
                    'turno_display': escala_militar.get_turno_display(),
                    'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M') if escala_militar.hora_inicio else '',
                    'hora_fim': escala_militar.hora_fim.strftime('%H:%M') if escala_militar.hora_fim else '',
                    'funcao_operacional': escala_militar.funcao_operacional or '',
                    'equipe': escala_militar.equipe or '',
                    'viatura': escala_militar.viatura or '',
                    'secao': escala_militar.secao or '',
                    'observacoes': escala_militar.observacoes or ''
                }
                todos_militares_escalados.append(militar_dict)
            except Exception as e:
                print(f"üîç DEBUG: Erro ao processar militar {escala_militar.id}: {e}")
                import traceback
                traceback.print_exc()
                continue
    except Exception as e:
        print(f"üîç DEBUG: Erro ao criar lista de militares escalados: {e}")
        import traceback
        traceback.print_exc()
    
    # Debug: Verificar dados antes de passar para o template
    print(f"üîç DEBUG Escala {escala.pk}:")
    print(f"  - Total militares escalados (QuerySet): {militares_escalados.count()}")
    print(f"  - Total militares escalados (Lista): {len(militares_escalados)}")
    print(f"  - Lista simplificada criada: {len(todos_militares_escalados)}")
    print(f"  - Militares administrativos: {len(militares_administrativos)}")
    print(f"  - Militares operacionais: {len(militares_operacionais)}")
    print(f"  - Equipes: {len(equipes)}")
    if todos_militares_escalados:
        print(f"  - Primeiro militar: {todos_militares_escalados[0]['nome_completo']}")
    
    escala_info = {
        'escala': escala,
        'todos_militares_escalados': todos_militares_escalados,
        'militares_operacionais': militares_operacionais,
        'militares_administrativos': militares_administrativos,
        'equipes': list(equipes.values()),
        'total_militares': len(militares_escalados),
        'total_operacionais': len(militares_operacionais),
        'total_administrativos': len(militares_administrativos),
        'total_equipes': len(equipes),
        'assinaturas': assinaturas,
        'tem_revisao': tem_revisao,
        'tem_aprovacao': tem_aprovacao,
        'total_assinaturas': len(assinaturas),
        'pode_alterar': pode_alterar,
        'motivo_restricao': motivo_restricao,
        'alteracoes': alteracoes
    }
    
    context = {
        'title': f'Escala - {escala.data.strftime("%d/%m/%Y")}',
        'page_title': f'Escala de Servi√ßo - {escala.data.strftime("%d/%m/%Y")}',
        'escala': escala,
        'militares_escalados': militares_escalados,
        'escala_info': escala_info,
    }
    
    # Verificar se deve renderizar como modal
    if request.GET.get('modal') == '1':
        return render(request, 'militares/escala_detail_modal.html', context)
    
    return render(request, 'militares/escala_detail.html', context)


@login_required
def api_verificar_disponibilidade_militar(request):
    """API para verificar disponibilidade de militar em um dia espec√≠fico"""
    from .models import EscalaMilitar, Militar
    from datetime import datetime, time
    import json
    
    if request.method != 'POST':
        return JsonResponse({'error': 'M√©todo n√£o permitido'}, status=405)
    
    try:
        data = json.loads(request.body)
        militar_id = data.get('militar_id')
        data_escala = data.get('data')
        hora_inicio = data.get('hora_inicio')
        hora_fim = data.get('hora_fim')
        
        if not militar_id or not data_escala:
            return JsonResponse({'error': 'Dados obrigat√≥rios n√£o fornecidos'}, status=400)
        
        # Converter data
        data_escala = datetime.strptime(data_escala, '%Y-%m-%d').date()
        
        # Buscar militar
        try:
            militar = Militar.objects.get(id=militar_id)
        except Militar.DoesNotExist:
            return JsonResponse({'error': 'Militar n√£o encontrado'}, status=404)
        
        # Converter hor√°rios se fornecidos
        hora_inicio_obj = None
        hora_fim_obj = None
        
        if hora_inicio:
            hora_inicio_obj = datetime.strptime(hora_inicio, '%H:%M').time()
        
        if hora_fim:
            hora_fim_obj = datetime.strptime(hora_fim, '%H:%M').time()
        
        # Verificar disponibilidade
        disponivel, horas_atuais, horas_restantes, mensagem = EscalaMilitar.verificar_disponibilidade_militar_dia(
            militar, data_escala, hora_inicio_obj, hora_fim_obj
        )
        
        return JsonResponse({
            'disponivel': disponivel,
            'horas_atuais': round(horas_atuais, 1),
            'horas_restantes': round(horas_restantes, 1),
            'mensagem': mensagem,
            'militar_nome': militar.nome_completo,
            'data': data_escala.strftime('%d/%m/%Y')
        })
        
    except json.JSONDecodeError:
        return JsonResponse({'error': 'JSON inv√°lido'}, status=400)
    except Exception as e:
        return JsonResponse({'error': f'Erro interno: {str(e)}'}, status=500)


@login_required
def api_registrar_alteracao_escala(request, pk):
    """API para registrar altera√ß√µes em escalas aprovadas"""
    from .models import EscalaServico, AlteracaoEscala, EscalaMilitar
    from django.shortcuts import get_object_or_404
    from django.utils import timezone
    from django.http import JsonResponse
    from django.views.decorators.csrf import csrf_exempt
    from django.views.decorators.http import require_http_methods
    import json
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    # Verificar se √© permitido fazer altera√ß√µes na escala (inclui verifica√ß√£o de superusu√°rio e data)
    pode_alterar, mensagem_validacao = escala.pode_adicionar_militares(request.user)
    if not pode_alterar:
        return JsonResponse({
            'success': False,
            'message': mensagem_validacao
        })
    
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            
            tipo_alteracao = data.get('tipo_alteracao')
            justificativa = data.get('justificativa', '').strip()
            militar_id = data.get('militar_id')
            dados_anteriores = data.get('dados_anteriores', {})
            dados_novos = data.get('dados_novos', {})
            
            # Validar campos obrigat√≥rios
            if not tipo_alteracao:
                return JsonResponse({
                    'success': False,
                    'message': 'Tipo de altera√ß√£o √© obrigat√≥rio'
                })
            
            if not justificativa:
                return JsonResponse({
                    'success': False,
                    'message': 'Justificativa √© obrigat√≥ria para altera√ß√µes'
                })
            
            # Buscar militar se fornecido
            militar_afetado = None
            if militar_id:
                try:
                    militar_afetado = EscalaMilitar.objects.get(id=militar_id, escala=escala).militar
                except EscalaMilitar.DoesNotExist:
                    return JsonResponse({
                        'success': False,
                        'message': 'Militar n√£o encontrado nesta escala'
                    })
            
            # Criar registro de altera√ß√£o
            alteracao = AlteracaoEscala.objects.create(
                escala=escala,
                alterado_por=request.user,
                tipo_alteracao=tipo_alteracao,
                justificativa=justificativa,
                militar_afetado=militar_afetado,
                dados_anteriores=dados_anteriores,
                dados_novos=dados_novos,
                valida_ate_data=escala.data
            )
            
            return JsonResponse({
                'success': True,
                'message': 'Altera√ß√£o registrada com sucesso',
                'alteracao_id': alteracao.id
            })
            
        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'message': 'Dados inv√°lidos'
            })
        except Exception as e:
            return JsonResponse({
                'success': False,
                'message': f'Erro ao registrar altera√ß√£o: {str(e)}'
            })
    
    return JsonResponse({
        'success': False,
        'message': 'M√©todo n√£o permitido'
    })


@login_required
def escala_pdf(request, pk):
    """Gerar PDF de uma escala espec√≠fica no padr√£o institucional"""
    from .models import EscalaServico, EscalaMilitar
    from django.shortcuts import get_object_or_404
    from django.http import HttpResponse
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import cm
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, Image, HRFlowable
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_CENTER, TA_LEFT
    from io import BytesIO
    import os
    import locale
    from datetime import datetime
    
    # Configurar locale para portugu√™s brasileiro
    try:
        locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
    except:
        try:
            locale.setlocale(locale.LC_TIME, 'Portuguese_Brazil.1252')
        except:
            pass  # Usar formato padr√£o se n√£o conseguir configurar
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    militares_escalados = EscalaMilitar.objects.filter(escala=escala).select_related('militar')
    
    # Fun√ß√£o para truncar textos muito longos
    def truncar_texto(texto, max_chars=50):
        if len(texto) <= max_chars:
            return texto
        return texto[:max_chars-3] + "..."
    
    # Fun√ß√£o para ordenar militares: respons√°vel primeiro, depois substituto, depois militar
    def ordenar_por_funcao(militar_dict):
        funcao = militar_dict.get('funcao', 'militar')
        if funcao == 'responsavel':
            return 0
        elif funcao == 'substituto':
            return 1
        else:
            return 2
    
    # Organizar militares por hor√°rio - agrupar quando o mesmo militar tem m√∫ltiplos turnos
    militares_por_horario = {}
    militares_administrativos = []
    militares_operacionais = []
    equipes = {}
    
    for escala_militar in militares_escalados:
        militar_info = {
            'nome_completo': escala_militar.militar.nome_completo,
            'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
            'funcao': escala_militar.funcao,  # Adicionar campo funcao para ordena√ß√£o
            'funcao_display': escala_militar.get_funcao_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'turno_display': escala_militar.get_turno_display(),
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'observacoes': escala_militar.observacoes or '',
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or ''
        }
        
        # Criar chave √∫nica para o militar + hor√°rio
        chave_militar_horario = f"{escala_militar.militar.id}_{escala_militar.hora_inicio}_{escala_militar.hora_fim}"
        
        if chave_militar_horario not in militares_por_horario:
            militares_por_horario[chave_militar_horario] = {
                'militar': militar_info,
                'turnos': []
            }
        
        # Adicionar informa√ß√µes do turno
        turno_info = {
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'turno_display': escala_militar.get_turno_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or '',
            'observacoes': escala_militar.observacoes or ''
        }
        
        militares_por_horario[chave_militar_horario]['turnos'].append(turno_info)
    
    # Converter para listas organizadas
    equipes_administrativas = {}
    
    for chave, dados in militares_por_horario.items():
        militar_info = dados['militar']
        militar_info['turnos'] = dados['turnos']
        militar_info['total_turnos'] = len(dados['turnos'])
        
        if militar_info['tipo_servico'] == 'operacional':
            # Organizar por equipes
            equipe_nome = militar_info['equipe'] or 'Sem Equipe Definida'
            if equipe_nome not in equipes:
                equipes[equipe_nome] = []
            equipes[equipe_nome].append(militar_info)
        else:
            # Organizar administrativos por turno (hor√°rio)
            turno_key = f"{militar_info['hora_inicio']}-{militar_info['hora_fim']}"
            if turno_key not in equipes_administrativas:
                equipes_administrativas[turno_key] = {
                    'horario': f"{militar_info['hora_inicio']} √†s {militar_info['hora_fim']}",
                    'turno_display': militar_info['turno_display'],
                    'militares': []
                }
            equipes_administrativas[turno_key]['militares'].append(militar_info)
    
    # Converter dicion√°rios em listas ordenadas
    # Ordenar militares dentro de cada equipe/turno: respons√°vel primeiro
    for equipe_nome, militares_equipe in equipes.items():
        equipes[equipe_nome] = sorted(militares_equipe, key=ordenar_por_funcao)
    
    for turno_key, turno_data in equipes_administrativas.items():
        turno_data['militares'] = sorted(turno_data['militares'], key=ordenar_por_funcao)
    
    # Fun√ß√£o para ordenar equipes: equipe com respons√°vel primeiro
    def ordenar_equipes(equipe_militares):
        # Verificar se algum militar da equipe √© respons√°vel
        tem_responsavel = any(m.get('funcao') == 'responsavel' for m in equipe_militares)
        # Verificar se o nome da equipe cont√©m "coordena√ß√£o" (case insensitive)
        equipe_nome = equipe_militares[0].get('equipe', '').lower() if equipe_militares else ''
        tem_coordenacao_no_nome = 'coordena√ß√£o' in equipe_nome or 'coordenacao' in equipe_nome or 'coord' in equipe_nome
        
        if tem_responsavel or tem_coordenacao_no_nome:
            return 0  # Primeiro
        else:
            return 1  # Depois
    
    # Ordenar as equipes: equipe com respons√°vel/coordena√ß√£o primeiro
    militares_operacionais = sorted(list(equipes.values()), key=ordenar_equipes)
    militares_administrativos = list(equipes_administrativas.values())
    
    # Criar buffer para o PDF
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4, rightMargin=0.5*cm, leftMargin=0.5*cm, topMargin=1.5*cm, bottomMargin=1.5*cm)
    
    # Estilos customizados
    styles = getSampleStyleSheet()
    style_center = ParagraphStyle('center', parent=styles['Normal'], alignment=TA_CENTER, fontSize=11)
    style_bold = ParagraphStyle('bold', parent=styles['Normal'], fontName='Helvetica-Bold', fontSize=11)
    style_title = ParagraphStyle('title', parent=styles['Heading1'], alignment=TA_CENTER, fontSize=14, spaceAfter=10, underlineProportion=0.1)
    style_subtitle = ParagraphStyle('subtitle', parent=styles['Heading2'], alignment=TA_CENTER, fontSize=12, spaceAfter=8)
    style_small = ParagraphStyle('small', parent=styles['Normal'], fontSize=9)
    style_just = ParagraphStyle('just', parent=styles['Normal'], alignment=4, fontSize=11)
    
    story = []
    
    # Logo/Bras√£o centralizado
    logo_path = os.path.join('staticfiles', 'logo_cbmepi.png')
    if os.path.exists(logo_path):
        story.append(Image(logo_path, width=2.5*cm, height=2.5*cm, hAlign='CENTER'))
        story.append(Spacer(1, 6))
    
    # Cabe√ßalho institucional
    # Extrair apenas o nome da organiza√ß√£o (antes da sigla)
    nome_organizacao = escala.organizacao.split(' - ')[0].strip().upper()
    
    cabecalho = [
        "GOVERNO DO ESTADO DO PIAU√ç",
        "CORPO DE BOMBEIROS MILITAR DO ESTADO DO PIAU√ç",
        nome_organizacao
    ]
    for linha in cabecalho:
        story.append(Paragraph(linha, style_center))
    story.append(Spacer(1, 10))
    
    # Dados da escala formatados
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    
    dias_semana_pt = {
        0: 'segunda-feira', 1: 'ter√ßa-feira', 2: 'quarta-feira', 3: 'quinta-feira',
        4: 'sexta-feira', 5: 's√°bado', 6: 'domingo'
    }
    
    data_formatada = f"{escala.data.day} de {meses_pt[escala.data.month]} de {escala.data.year}"
    dia_semana = dias_semana_pt[escala.data.weekday()]
    
    # T√≠tulo com data e dia da semana
    titulo = f'<u>ESCALA DE SERVI√áO PARA O DIA {escala.data.day} DE {meses_pt[escala.data.month].upper()} DE {escala.data.year} ({dia_semana.upper()})</u>'
    story.append(Paragraph(titulo, style_title))
    story.append(Spacer(1, 3))
    
    # Apenas observa√ß√µes se houver
    if escala.observacoes:
        info_escala = f"<b>Observa√ß√µes:</b> {escala.observacoes}"
        story.append(Paragraph(info_escala, style_just))
        story.append(Spacer(1, 8))
    else:
        story.append(Spacer(1, 8))
    
    # Lista de militares escalados organizados como nos cards
    if militares_administrativos or militares_operacionais:
        
        # 1. SERVI√áO ADMINISTRATIVO
        if militares_administrativos:
            story.append(Paragraph("SERVI√áO ADMINISTRATIVO", style_subtitle))
            
            # Verificar se √© ter√ßa ou quinta-feira para adicionar descri√ß√£o especial
            if escala.data.weekday() in [1, 3]:  # 1 = ter√ßa-feira, 3 = quinta-feira
                descricao_especial = "EDUCA√á√ÉO F√çSICA DE 07:30 √ÄS 08:45, SERVI√áO ADMINISTRATIVO 09:00 √ÄS 13:30"
                descricao_style = ParagraphStyle('descricao_especial', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10, spaceAfter=8)
                story.append(Paragraph(descricao_especial, descricao_style))
            
            for turno_admin in militares_administrativos:
                if turno_admin['militares']:  # Verificar se o turno tem militares
                    # Nome do turno com hor√°rio
                    turno_nome = f"Turno: {turno_admin['turno_display']} {turno_admin['horario']}"
                    turno_style = ParagraphStyle('turno_admin', parent=styles['Heading3'], alignment=TA_CENTER, fontSize=12, spaceAfter=4)
                    story.append(Paragraph(turno_nome, turno_style))
                    
                    story.append(Spacer(1, 5))
                    
                    dados_admin = [['Posto/Gradua√ß√£o', 'Nome', 'Se√ß√£o']]
                    for militar in turno_admin['militares']:
                        dados_admin.append([
                            truncar_texto(militar['posto_graduacao'], 20),
                            truncar_texto(militar['nome_completo'], 40),
                            truncar_texto(militar['secao'] or '-', 30)
                        ])
                    
                    tabela_admin = Table(dados_admin, colWidths=[4*cm, 8*cm, 7.5*cm])
                    tabela_admin.setStyle(TableStyle([
                        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),
                        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                        ('FONTSIZE', (0, 0), (-1, -1), 8),
                        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                        ('TOPPADDING', (0, 0), (-1, -1), 6),
                        ('LEFTPADDING', (0, 0), (-1, -1), 3),
                        ('RIGHTPADDING', (0, 0), (-1, -1), 3),
                        ('GRID', (0, 0), (-1, -1), 1, colors.black),
                        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                        ('WORDWRAP', (0, 0), (-1, -1), 'CJK')
                    ]))
                    
                    story.append(tabela_admin)
                    story.append(Spacer(1, 12))
        
        # 2. SERVI√áO OPERACIONAL
        if militares_operacionais:
            story.append(Paragraph("SERVI√áO OPERACIONAL", style_subtitle))
            story.append(Spacer(1, 8))
            
            for equipe_militares in militares_operacionais:
                if equipe_militares:  # Verificar se a equipe tem militares
                    # Nome da equipe (primeiro militar da equipe) - centralizado e sem prefixo
                    equipe_nome = equipe_militares[0]['equipe'] or 'Sem Equipe'
                    equipe_style = ParagraphStyle('equipe', parent=styles['Heading3'], alignment=TA_CENTER, fontSize=12, spaceAfter=4)
                    story.append(Paragraph(equipe_nome, equipe_style))
                    
                    # Informa√ß√µes da equipe (viatura)
                    viatura_equipe = equipe_militares[0]['viatura'] or 'N/A'
                    
                    info_equipe = f"<b>Viatura:</b> {viatura_equipe}"
                    info_style = ParagraphStyle('info_equipe', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10, spaceAfter=8)
                    story.append(Paragraph(info_equipe, info_style))
                    story.append(Spacer(1, 5))
                    
                    dados_equipe = [['Posto/Gradua√ß√£o', 'Nome', 'Fun√ß√£o']]
                    for militar in equipe_militares:
                        dados_equipe.append([
                            truncar_texto(militar['posto_graduacao'], 20),
                            truncar_texto(militar['nome_completo'], 40),
                            truncar_texto(militar['funcao_operacional'] or militar['funcao_display'], 50)
                        ])
                    
                    # Tabela expandida para usar quase toda a largura
                    tabela_equipe = Table(dados_equipe, colWidths=[4*cm, 8*cm, 7.5*cm])
                    tabela_equipe.setStyle(TableStyle([
                        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),
                        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                        ('FONTSIZE', (0, 0), (-1, -1), 8),
                        ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
                        ('TOPPADDING', (0, 0), (-1, -1), 6),
                        ('LEFTPADDING', (0, 0), (-1, -1), 3),
                        ('RIGHTPADDING', (0, 0), (-1, -1), 3),
                        ('GRID', (0, 0), (-1, -1), 1, colors.black),
                        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                        ('WORDWRAP', (0, 0), (-1, -1), 'CJK')
                    ]))
                    
                    story.append(tabela_equipe)
                    story.append(Spacer(1, 12))
    else:
        story.append(Paragraph("Nenhum militar escalado nesta data.", style_just))
    
    # Assinaturas eletr√¥nicas reais do sistema
    story.append(Spacer(1, 30))
    
    # Buscar assinaturas eletr√¥nicas reais
    from .models import AssinaturaEscala
    assinaturas_eletronicas = AssinaturaEscala.objects.filter(
        escala=escala,
        tipo_midia='ELETRONICA',
        assinado_por__isnull=False
    ).order_by('-data_assinatura')
    
    # Adicionar local e data no final (padr√£o dos outros documentos)
    story.append(Spacer(1, 20))
    
    # Local e data
    from datetime import datetime
    data_atual = datetime.now().strftime('%d de %B de %Y')
    meses_pt = {
        1: 'janeiro', 2: 'fevereiro', 3: 'mar√ßo', 4: 'abril', 5: 'maio', 6: 'junho',
        7: 'julho', 8: 'agosto', 9: 'setembro', 10: 'outubro', 11: 'novembro', 12: 'dezembro'
    }
    data_atual = datetime.now().strftime(f'%d de {meses_pt[datetime.now().month]} de %Y')
    
    local_data = f"Teresina, {data_atual}"
    story.append(Paragraph(local_data, ParagraphStyle('local_data', parent=styles['Normal'], alignment=TA_CENTER, fontSize=11, spaceAfter=12, fontName='Times-Roman')))
    
    # Adicionar espa√ßo para assinaturas
    story.append(Spacer(1, 0.5*cm))
    
    if assinaturas_eletronicas.exists():
        # Adicionar assinaturas f√≠sicas primeiro (at√© 3)
        assinaturas_fisicas = assinaturas_eletronicas[:3]
        for assinatura in assinaturas_fisicas:
            # Nome e posto
            if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
                militar = assinatura.assinado_por.militar
                posto = militar.get_posto_graduacao_display()
                if "BM" not in posto:
                    posto = f"{posto} BM"
                nome_completo = f"{militar.nome_completo} - {posto}"
            else:
                nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
            
            # Fun√ß√£o
            funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
            
            # Tipo de assinatura
            tipo = assinatura.get_tipo_assinatura_display() or "Tipo n√£o registrado"
            
            # Adicionar assinatura f√≠sica
            story.append(Spacer(1, 8))
            story.append(Paragraph(f"<b>{nome_completo}</b>", ParagraphStyle('Assinante', parent=styles['Normal'], alignment=TA_CENTER, fontSize=11, spaceAfter=4, fontName='Times-Roman')))
            story.append(Paragraph(f"{funcao}", ParagraphStyle('Funcao', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10, spaceAfter=4, fontName='Times-Roman')))
            story.append(Paragraph(f"<b>{tipo}</b>", ParagraphStyle('TipoAssinatura', parent=styles['Normal'], alignment=TA_CENTER, fontSize=9, spaceAfter=8, fontName='Times-Roman')))
        
        # Adicionar TODAS as assinaturas como eletr√¥nicas
        if len(assinaturas_eletronicas) > 0:
            story.append(Spacer(1, 1*cm))  # Espa√ßo antes das assinaturas eletr√¥nicas
            
            for assinatura in assinaturas_eletronicas:  # TODAS as assinaturas
                # Nome e posto
                if hasattr(assinatura.assinado_por, 'militar') and assinatura.assinado_por.militar:
                    militar = assinatura.assinado_por.militar
                    posto = militar.get_posto_graduacao_display()
                    if "BM" not in posto:
                        posto = f"{posto} BM"
                    nome_completo = f"{militar.nome_completo} - {posto}"
                else:
                    nome_completo = assinatura.assinado_por.get_full_name() or assinatura.assinado_por.username
                
                # Fun√ß√£o
                funcao = assinatura.funcao_assinatura or "Fun√ß√£o n√£o registrada"
                
                # Formatar data e hora
                data_formatada = assinatura.data_assinatura.strftime('%d/%m/%Y')
                hora_formatada = assinatura.data_assinatura.strftime('%H:%M:%S')
                
                # Texto da assinatura
                texto_assinatura = (
                    f"Documento assinado eletronicamente por {nome_completo}, em {data_formatada} {hora_formatada}, "
                    f"conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021"
                )
                
                # Adicionar logo da assinatura eletr√¥nica
                from .utils import obter_caminho_assinatura_eletronica
                logo_assinatura_path = obter_caminho_assinatura_eletronica()
                
                # Tabela das assinaturas: Logo + Texto de assinatura
                assinatura_data = [
                    [Image(logo_assinatura_path, width=1.8*cm, height=1.2*cm), Paragraph(texto_assinatura, ParagraphStyle('assinatura_texto', parent=styles['Normal'], fontSize=9, spaceAfter=1, spaceBefore=1, leading=8, alignment=TA_JUSTIFY))]
                ]
                
                assinatura_table = Table(assinatura_data, colWidths=[2.5*cm, 13.5*cm])
                assinatura_table.setStyle(TableStyle([
                    ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                    ('ALIGN', (0, 0), (0, 0), 'CENTER'),
                    ('ALIGN', (1, 0), (1, 0), 'LEFT'),
                    ('LEFTPADDING', (0, 0), (-1, -1), 1),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 1),
                    ('TOPPADDING', (0, 0), (-1, -1), 1),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
                    ('BOX', (0, 0), (-1, -1), 1, colors.black),
                ]))
                
                story.append(assinatura_table)
                # Espa√ßamento m√≠nimo entre assinaturas eletr√¥nicas
                story.append(Spacer(1, 0.2*cm))  # Espa√ßamento bem curto
    else:
        # Quando n√£o h√° assinaturas eletr√¥nicas, adicionar espa√ßo para assinatura f√≠sica
        story.append(Spacer(1, 2*cm))  # Espa√ßo para assinatura f√≠sica manual
        
        # Adicionar linha para assinatura f√≠sica
        story.append(Paragraph("_" * 50, ParagraphStyle('linha_assinatura', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10, spaceAfter=0.5*cm, fontName='Times-Roman')))
        story.append(Paragraph("Assinatura F√≠sica", ParagraphStyle('assinatura_fisica', parent=styles['Normal'], alignment=TA_CENTER, fontSize=10, spaceAfter=1*cm, fontName='Times-Roman')))
    
    # Adicionar autenticador de veracidade
    story.append(Spacer(1, 20))
    story.append(HRFlowable(width="100%", thickness=1, spaceAfter=10, spaceBefore=10, color=colors.grey))
    
    # Usar a fun√ß√£o utilit√°ria para gerar o autenticador
    from .utils import gerar_autenticador_veracidade
    autenticador = gerar_autenticador_veracidade(escala, request, tipo_documento='escala')
    
    # Tabela do rodap√©: QR + Texto de autentica√ß√£o
    rodape_data = [
        [autenticador['qr_img'], Paragraph(autenticador['texto_autenticacao'], style_small)]
    ]
    
    rodape_table = Table(rodape_data, colWidths=[3*cm, 16.5*cm])
    rodape_table.setStyle(TableStyle([
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (0, 0), (0, 0), 'CENTER'),  # QR centralizado
        ('ALIGN', (1, 0), (1, 0), 'LEFT'),    # Texto alinhado √† esquerda
        ('LEFTPADDING', (0, 0), (-1, -1), 2),
        ('RIGHTPADDING', (0, 0), (-1, -1), 2),
        ('TOPPADDING', (0, 0), (-1, -1), 2),
        ('BOTTOMPADDING', (0, 0), (-1, -1), 2),
    ]))
    
    story.append(rodape_table)
    
    # Gerar PDF
    doc.build(story)
    
    # Configurar resposta para visualiza√ß√£o inline (n√£o download autom√°tico)
    buffer.seek(0)
    response = HttpResponse(buffer.read(), content_type='application/pdf')
    response['Content-Disposition'] = f'inline; filename="escala_{escala.data.strftime("%Y%m%d")}_{escala.organizacao.replace(" ", "_")}.pdf"'
    
    return response




@login_required
def api_militares_disponiveis(request, pk):
    """API para buscar militares dispon√≠veis para a escala"""
    from .models import EscalaServico, EscalaMilitar, Militar, Lotacao
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.db.models import Q
    from .permissoes_simples import tem_acesso_total_secao_promocoes, pode_gerenciar_escalas
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    militares_escalados = EscalaMilitar.objects.filter(escala=escala).values_list('militar_id', flat=True)
    
    # Verificar se √© permitido adicionar militares √† escala
    pode_adicionar, mensagem_permissao = escala.pode_adicionar_militares(request.user)
    
    # Verificar se o usu√°rio tem acesso total ou pode gerenciar escalas
    tem_acesso_total = tem_acesso_total_secao_promocoes(request.user) or pode_gerenciar_escalas(request.user)
    
    # Verificar se h√° termo de pesquisa
    termo_pesquisa = request.GET.get('q', '').strip()
    
    # SEMPRE filtrar inicialmente pela organiza√ß√£o da escala, independente do tipo de acesso
    organizacao_escala = escala.organizacao
    
    # Debug: Log da organiza√ß√£o da escala
    print(f"üîç DEBUG: Buscando militares para organiza√ß√£o: '{organizacao_escala}'")
    print(f"üîç DEBUG: Termo de pesquisa: '{termo_pesquisa}'")
    
    # Se houver termo de pesquisa, buscar em TODOS os militares ativos
    if termo_pesquisa:
        print(f"üîç DEBUG: Buscando em TODOS os militares ativos com termo: '{termo_pesquisa}'")
        militares_organizacao = Militar.objects.filter(
            classificacao='ATIVO'
        ).filter(
            Q(nome_completo__icontains=termo_pesquisa) |
            Q(nome_guerra__icontains=termo_pesquisa) |
            Q(matricula__icontains=termo_pesquisa)
        ).distinct()
        # Quando h√° termo de pesquisa, n√£o filtrar por organiza√ß√£o
        print(f"üîç DEBUG: Busca com termo encontrou {militares_organizacao.count()} militares (todos os ativos)")
    else:
        # Sem termo de pesquisa: listar apenas os militares da organiza√ß√£o da escala
        print(f"üîç DEBUG: Listando militares da organiza√ß√£o: '{organizacao_escala}'")
        
        # Dividir a organiza√ß√£o em partes (pode usar " | " ou " - ")
        partes_org = organizacao_escala.split(' | ')
        if len(partes_org) < 2:
            partes_org = organizacao_escala.split(' - ')
        
        # Pegar a √∫ltima parte (unidade mais espec√≠fica) - ex: "1¬∫ Grupamento de Bombeiros Militar"
        todas_partes = [p.strip() for p in partes_org if p.strip()]
        ultima_parte = todas_partes[-1] if todas_partes else organizacao_escala
        
        print(f"üîç DEBUG: Partes da organiza√ß√£o: {todas_partes}, √öltima parte (unidade espec√≠fica): '{ultima_parte}'")
        
        # PRIORIDADE 1: Busca EXATA com a √∫ltima parte (unidade mais espec√≠fica) - mais restritiva
        # Focar APENAS em unidade (n√£o incluir sub_unidades/depend√™ncias)
        print(f"üîç DEBUG: PRIORIDADE 1 - Busca EXATA com √∫ltima parte (SEM depend√™ncias): '{ultima_parte}'")
        militares_organizacao = Militar.objects.filter(
            classificacao='ATIVO',
            lotacoes__status='ATUAL',
            lotacoes__ativo=True,
            lotacoes__sub_unidade__isnull=True  # Excluir militares de sub_unidades (depend√™ncias)
        ).filter(
            Q(lotacoes__unidade__nome=ultima_parte) |
            Q(lotacoes__lotacao=ultima_parte)
        ).distinct()
        
        print(f"üîç DEBUG: Busca EXATA com √∫ltima parte encontrou {militares_organizacao.count()} militares")
        
        # PRIORIDADE 2: Se n√£o encontrou, tentar busca EXATA com organiza√ß√£o completa
        # Mas APENAS em unidade (n√£o incluir sub_unidades/depend√™ncias)
        if not militares_organizacao.exists():
            print(f"üîç DEBUG: PRIORIDADE 2 - Busca EXATA com organiza√ß√£o completa (SEM depend√™ncias): '{organizacao_escala}'")
            militares_organizacao = Militar.objects.filter(
                classificacao='ATIVO',
                lotacoes__status='ATUAL',
                lotacoes__ativo=True,
                lotacoes__sub_unidade__isnull=True  # Excluir militares de sub_unidades (depend√™ncias)
            ).filter(
                Q(lotacoes__orgao__nome=organizacao_escala) |
                Q(lotacoes__grande_comando__nome=organizacao_escala) |
                Q(lotacoes__unidade__nome=organizacao_escala) |
                Q(lotacoes__lotacao=organizacao_escala)
            ).distinct()
            
            print(f"üîç DEBUG: Busca EXATA com organiza√ß√£o completa encontrou {militares_organizacao.count()} militares")
        
        # PRIORIDADE 3: Se ainda n√£o encontrou, tentar busca PARCIAL (icontains) apenas com √∫ltima parte
        # Focar APENAS em unidade (n√£o incluir sub_unidades/depend√™ncias)
        if not militares_organizacao.exists():
            print(f"üîç DEBUG: PRIORIDADE 3 - Busca PARCIAL (icontains) com √∫ltima parte (SEM depend√™ncias): '{ultima_parte}'")
            militares_organizacao = Militar.objects.filter(
                classificacao='ATIVO',
                lotacoes__status='ATUAL',
                lotacoes__ativo=True,
                lotacoes__sub_unidade__isnull=True  # Excluir militares de sub_unidades (depend√™ncias)
            ).filter(
                Q(lotacoes__unidade__nome__icontains=ultima_parte) |
                Q(lotacoes__lotacao__icontains=ultima_parte)
            ).distinct()
            
            print(f"üîç DEBUG: Busca PARCIAL com √∫ltima parte encontrou {militares_organizacao.count()} militares")
        
        # PRIORIDADE 4: Se ainda n√£o encontrou, tentar busca PARCIAL com todas as partes
        # Mas APENAS em unidade (n√£o incluir sub_unidades/depend√™ncias)
        if not militares_organizacao.exists() and len(todas_partes) > 1:
            print(f"üîç DEBUG: PRIORIDADE 4 - Busca PARCIAL com todas as partes (SEM depend√™ncias): {todas_partes}")
            query_todas_partes = Q()
            for parte in todas_partes:
                # Apenas unidade (sem sub_unidades)
                query_todas_partes |= (
                    Q(lotacoes__unidade__nome__icontains=parte) |
                    Q(lotacoes__lotacao__icontains=parte)
                )
            
            militares_organizacao = Militar.objects.filter(
                classificacao='ATIVO',
                lotacoes__status='ATUAL',
                lotacoes__ativo=True,
                lotacoes__sub_unidade__isnull=True  # Excluir militares de sub_unidades (depend√™ncias)
            ).filter(query_todas_partes).distinct()
            print(f"üîç DEBUG: Busca PARCIAL com todas as partes encontrou {militares_organizacao.count()} militares")
    
    # Ordenar por hierarquia militar e antiguidade
    # Hierarquia: Oficiais (CB, TC, MJ, CP, 1T, 2T), Aspirantes (AS), Subtenentes (ST), Sargentos (1S, 2S, 3S), Cabos (CAB), Soldados (SD)
    ordem_hierarquica = ['CB', 'TC', 'MJ', 'CP', '1T', '2T', 'AS', 'ST', '1S', '2S', '3S', 'CAB', 'SD']
    
    # Criar express√£o Case para ordena√ß√£o hier√°rquica
    from django.db.models import Case, When, Value, IntegerField
    hierarquia_ordem = Case(
        *[When(posto_graduacao=posto, then=Value(i)) for i, posto in enumerate(ordem_hierarquica)],
        default=Value(len(ordem_hierarquica)),
        output_field=IntegerField()
    )
    
    # Ordenar por hierarquia (mais graduado primeiro) e depois por antiguidade (mais antigo primeiro)
    militares_organizacao = militares_organizacao.order_by(
        hierarquia_ordem,  # Hierarquia militar
        'data_promocao_atual',  # Data de promo√ß√£o (mais antiga primeiro)
        'numeracao_antiguidade'  # Numera√ß√£o de antiguidade como desempate
    ).values('id', 'nome_completo', 'posto_graduacao', 'data_promocao_atual', 'numeracao_antiguidade', 'situacao', 'cpf')
    
    # Converter para lista e marcar quais j√° est√£o escalados
    militares = []
    for militar in militares_organizacao:
        ja_escalado = militar['id'] in militares_escalados
        
        # Verificar disponibilidade do militar (limite de 24h por dia)
        # Sempre verificar disponibilidade, mesmo se j√° estiver escalado (para permitir m√∫ltiplos turnos)
        militar_obj = Militar.objects.get(id=militar['id'])
        disponivel_24h, horas_atuais, horas_restantes, mensagem_disponibilidade = EscalaMilitar.verificar_disponibilidade_militar_dia(
            militar_obj, escala.data
        )
        
        # Calcular tempo no posto atual
        tempo_posto = ""
        if militar['data_promocao_atual']:
            from datetime import date
            hoje = date.today()
            dias_no_posto = (hoje - militar['data_promocao_atual']).days
            anos = dias_no_posto // 365
            meses = (dias_no_posto % 365) // 30
            if anos > 0:
                tempo_posto = f"{anos}a {meses}m"
            elif meses > 0:
                tempo_posto = f"{meses}m"
            else:
                tempo_posto = f"{dias_no_posto}d"
        
        # Obter o nome completo do posto/gradua√ß√£o
        posto_display = militar['posto_graduacao']
        posto_choices = {
            'CB': 'Coronel',
            'TC': 'Tenente-Coronel',
            'MJ': 'Major',
            'CP': 'Capit√£o',
            '1T': '1¬∫ Tenente',
            '2T': '2¬∫ Tenente',
            'AS': 'Aspirante',
            'ST': 'Subtenente',
            '1S': '1¬∫ Sargento',
            '2S': '2¬∫ Sargento',
            '3S': '3¬∫ Sargento',
            'CAB': 'Cabo',
            'SD': 'Soldado'
        }
        posto_graduacao_display = posto_choices.get(militar['posto_graduacao'], militar['posto_graduacao'])
        
        # Obter a lota√ß√£o atual do militar - mostrar apenas a inst√¢ncia mais espec√≠fica
        lotacao_display = ''
        try:
            # Buscar lota√ß√£o atual com select_related para carregar rela√ß√µes
            lotacao_atual = Lotacao.objects.filter(
                militar=militar_obj,
                status='ATUAL',
                ativo=True
            ).select_related('unidade', 'sub_unidade', 'grande_comando', 'orgao').first()
            
            if lotacao_atual:
                # Mostrar apenas a inst√¢ncia mais espec√≠fica (prioridade: sub_unidade > unidade > lotacao > grande_comando > orgao)
                if lotacao_atual.sub_unidade:
                    lotacao_display = lotacao_atual.sub_unidade.nome
                elif lotacao_atual.unidade:
                    lotacao_display = lotacao_atual.unidade.nome
                elif lotacao_atual.lotacao:
                    lotacao_display = lotacao_atual.lotacao
                elif lotacao_atual.grande_comando:
                    lotacao_display = lotacao_atual.grande_comando.nome
                elif lotacao_atual.orgao:
                    lotacao_display = lotacao_atual.orgao.nome
        except Exception as e:
            import traceback
            print(f"üîç DEBUG: Erro ao obter lota√ß√£o do militar {militar['id']}: {e}")
            print(f"üîç DEBUG: Traceback: {traceback.format_exc()}")
            lotacao_display = ''
        
        # Obter situa√ß√£o do militar
        situacao_militar = militar.get('situacao', 'PRONTO')
        situacao_display = militar_obj.get_situacao_display() if hasattr(militar_obj, 'get_situacao_display') else situacao_militar
        
        # Verificar se o militar est√° com situa√ß√£o PRONTO
        situacao_pronto = (situacao_militar == 'PRONTO')
        
        # Buscar informa√ß√µes de afastamento (f√©rias, licen√ßa ou outros) na data da escala para orienta√ß√£o do escalante
        situacao_com_datas = situacao_display
        situacao_datas_texto = None
        try:
            from .models import Afastamento, Ferias, LicencaEspecial
            from datetime import date
            data_escala = escala.data if hasattr(escala, 'data') else date.today()
            
            # Verificar se √© situa√ß√£o de F√âRIAS
            if 'FERIAS' in situacao_militar or 'F√âRIAS' in situacao_display.upper():
                # Buscar f√©rias ativa na data da escala
                ferias_ativa = Ferias.objects.filter(
                    militar=militar_obj
                ).exclude(status__in=['CANCELADA', 'REPROGRAMADA', 'GOZADA']).filter(
                    data_inicio__lte=data_escala,
                    data_fim__gte=data_escala
                ).order_by('-data_inicio').first()
                
                if ferias_ativa:
                    situacao_com_datas = f"{situacao_display} ({ferias_ativa.data_inicio.strftime('%d/%m/%Y')} a {ferias_ativa.data_fim.strftime('%d/%m/%Y')})"
                    situacao_datas_texto = f"{ferias_ativa.data_inicio.strftime('%d/%m/%Y')} a {ferias_ativa.data_fim.strftime('%d/%m/%Y')}"
            
            # Verificar se √© situa√ß√£o de LICEN√áA
            elif 'LICENCA' in situacao_militar or 'LICEN√áA' in situacao_display.upper():
                # Buscar licen√ßa especial ativa na data da escala
                licenca_ativa = LicencaEspecial.objects.filter(
                    militar=militar_obj
                ).exclude(status='CANCELADA').filter(
                    data_inicio__lte=data_escala
                ).filter(
                    Q(data_fim__gte=data_escala) | 
                    Q(data_fim__isnull=True)
                ).order_by('-data_inicio').first()
                
                if licenca_ativa and licenca_ativa.data_fim:
                    situacao_com_datas = f"{situacao_display} ({licenca_ativa.data_inicio.strftime('%d/%m/%Y')} a {licenca_ativa.data_fim.strftime('%d/%m/%Y')})"
                    situacao_datas_texto = f"{licenca_ativa.data_inicio.strftime('%d/%m/%Y')} a {licenca_ativa.data_fim.strftime('%d/%m/%Y')}"
                elif licenca_ativa:
                    situacao_com_datas = f"{situacao_display} (desde {licenca_ativa.data_inicio.strftime('%d/%m/%Y')})"
                    situacao_datas_texto = f"desde {licenca_ativa.data_inicio.strftime('%d/%m/%Y')}"
            
            # Outros afastamentos
            elif not situacao_pronto:
                # Buscar afastamento ativo que inclua a data da escala
                afastamento_ativo = Afastamento.objects.filter(
                    militar=militar_obj,
                    status='ATIVO'
                ).filter(
                    data_inicio__lte=data_escala
                ).filter(
                    Q(data_fim_prevista__gte=data_escala) | 
                    Q(data_fim_real__gte=data_escala) | 
                    Q(data_fim_prevista__isnull=True, data_fim_real__isnull=True)
                ).order_by('-data_inicio').first()
                
                if afastamento_ativo:
                    data_fim = afastamento_ativo.data_fim_real or afastamento_ativo.data_fim_prevista
                    if data_fim:
                        situacao_com_datas = f"{situacao_display} ({afastamento_ativo.data_inicio.strftime('%d/%m/%Y')} a {data_fim.strftime('%d/%m/%Y')})"
                        situacao_datas_texto = f"{afastamento_ativo.data_inicio.strftime('%d/%m/%Y')} a {data_fim.strftime('%d/%m/%Y')}"
                    else:
                        situacao_com_datas = f"{situacao_display} (desde {afastamento_ativo.data_inicio.strftime('%d/%m/%Y')})"
                        situacao_datas_texto = f"desde {afastamento_ativo.data_inicio.strftime('%d/%m/%Y')}"
        except Exception as e:
            import traceback
            print(f"üîç DEBUG: Erro ao obter informa√ß√µes de afastamento do militar {militar['id']}: {e}")
            print(f"üîç DEBUG: Traceback: {traceback.format_exc()}")
        
        # Determinar status de disponibilidade
        # Se n√£o estiver PRONTO, n√£o pode estar dispon√≠vel
        if not situacao_pronto:
            status_disponibilidade = "indisponivel_situacao"
            mensagem_status = f"Indispon√≠vel - Situa√ß√£o: {situacao_display}"
        # Priorizar disponibilidade de 24h sobre status de "j√° escalado" para permitir m√∫ltiplos turnos
        elif not disponivel_24h:
            status_disponibilidade = "indisponivel_24h"
            mensagem_status = f"Indispon√≠vel - {mensagem_disponibilidade}"
        elif ja_escalado:
            status_disponibilidade = "ja_escalado"
            mensagem_status = f"J√° escalado - {mensagem_disponibilidade}"
        else:
            status_disponibilidade = "disponivel"
            mensagem_status = f"Dispon√≠vel - {mensagem_disponibilidade}"
        
        # Obter URL da foto do militar
        foto_url = None
        if militar_obj.foto:
            foto_url = militar_obj.foto.url
        
        militares.append({
            'id': militar['id'],
            'nome_completo': militar['nome_completo'],
            'cpf': militar.get('cpf', ''),
            'posto_graduacao': militar['posto_graduacao'],
            'posto_graduacao_display': posto_graduacao_display,
            'data_promocao_atual': militar['data_promocao_atual'].strftime('%d/%m/%Y') if militar['data_promocao_atual'] else '',
            'numeracao_antiguidade': militar['numeracao_antiguidade'] or 0,
            'tempo_posto': tempo_posto,
            'lotacao': lotacao_display,
            'foto_url': foto_url,
            'situacao': situacao_militar,
            'situacao_display': situacao_display,
            'situacao_com_datas': situacao_com_datas,
            'situacao_datas_texto': situacao_datas_texto,
            'situacao_pronto': situacao_pronto,
            'ja_escalado': ja_escalado,
            'disponivel_24h': disponivel_24h,
            'horas_atuais': round(horas_atuais, 1),
            'horas_restantes': round(horas_restantes, 1),
            'status_disponibilidade': status_disponibilidade,
            'mensagem_disponibilidade': mensagem_status
        })
    
    print(f"üîç DEBUG: Total de militares encontrados: {len(militares)}")
    print(f"üîç DEBUG: J√° escalados: {sum(1 for m in militares if m['ja_escalado'])}")
    print(f"üîç DEBUG: Indispon√≠veis (24h): {sum(1 for m in militares if m['status_disponibilidade'] == 'indisponivel_24h')}")
    print(f"üîç DEBUG: Dispon√≠veis: {sum(1 for m in militares if m['status_disponibilidade'] == 'disponivel')}")
    for militar in militares[:5]:  # Mostrar apenas os primeiros 5
        if militar['ja_escalado']:
            status = "‚úì ESCALADO"
        elif militar['status_disponibilidade'] == 'indisponivel_24h':
            status = f"‚ùå INDISPON√çVEL ({militar['horas_atuais']:.1f}h)"
        else:
            status = f"‚óã DISPON√çVEL ({militar['horas_restantes']:.1f}h restantes)"
        print(f"üîç DEBUG: - {militar['nome_completo']} ({militar['posto_graduacao']}) - {status}")
    
    return JsonResponse({
        'militares': militares,
        'organizacao': escala.organizacao,
        'total_militares': len(militares),
        'total_escalados': sum(1 for m in militares if m['ja_escalado']),
        'total_indisponiveis_24h': sum(1 for m in militares if m['status_disponibilidade'] == 'indisponivel_24h'),
        'total_disponiveis': sum(1 for m in militares if m['status_disponibilidade'] == 'disponivel'),
        'acesso_total': tem_acesso_total,
        'pode_adicionar_militares': pode_adicionar,
        'mensagem_permissao': mensagem_permissao
    })


@login_required
def api_militares_escalados(request, pk):
    """API para buscar militares escalados na escala"""
    from .models import EscalaServico, EscalaMilitar
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    militares_escalados = EscalaMilitar.objects.filter(escala=escala).select_related('militar')
    
    militares = []
    for escala_militar in militares_escalados:
        militares.append({
            'id': escala_militar.id,
            'nome_completo': escala_militar.militar.nome_completo,
            'posto_graduacao': escala_militar.militar.get_posto_graduacao_display(),
            'funcao_display': escala_militar.get_funcao_display(),
            'tipo_servico_display': escala_militar.get_tipo_servico_display(),
            'tipo_servico': escala_militar.tipo_servico,
            'turno_display': escala_militar.get_turno_display(),
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'observacoes': escala_militar.observacoes or '',
            'secao': escala_militar.secao or '',
            'funcao_operacional': escala_militar.funcao_operacional or '',
            'equipe': escala_militar.equipe or '',
            'viatura': escala_militar.viatura or '',
            'secao': escala_militar.secao or ''
        })
    
    return JsonResponse({'militares': militares})


@login_required
def api_adicionar_militar(request, pk):
    """API para adicionar militar individual √† escala"""
    from .models import EscalaServico, EscalaMilitar, Militar
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.contrib import messages
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    # Verificar se √© permitido adicionar militares √† escala
    pode_adicionar, mensagem_validacao = escala.pode_adicionar_militares(request.user)
    if not pode_adicionar:
        return JsonResponse({'success': False, 'message': mensagem_validacao})
    
    try:
        militar_id = request.POST.get('militar_id')
        funcao = request.POST.get('funcao')
        tipo_servico = request.POST.get('tipo_servico')
        turno = request.POST.get('turno')
        hora_inicio = request.POST.get('hora_inicio')
        hora_fim = request.POST.get('hora_fim')
        observacoes = request.POST.get('observacoes', '')
        
        if not militar_id:
            return JsonResponse({'success': False, 'message': 'Militar √© obrigat√≥rio'})
        
        militar = Militar.objects.get(id=militar_id)
        
        # Verifica√ß√£o removida para permitir m√∫ltiplos turnos do mesmo militar na mesma escala
        
        # Verificar disponibilidade do militar (limite de 24h por dia)
        if hora_inicio and hora_fim:
            from datetime import datetime, time
            hora_inicio_obj = datetime.strptime(hora_inicio, '%H:%M').time()
            hora_fim_obj = datetime.strptime(hora_fim, '%H:%M').time()
            
            # Verificar conflitos com opera√ß√µes planejadas
            tem_conflito, planejadas_conflitantes, mensagem_conflito = EscalaMilitar.verificar_conflitos_planejadas(
                militar, escala.data, hora_inicio_obj, hora_fim_obj
            )
            
            if tem_conflito:
                return JsonResponse({
                    'success': False,
                    'message': mensagem_conflito,
                    'conflitos_planejadas': planejadas_conflitantes,
                    'tipo_erro': 'conflito_planejadas'
                })
            
            disponivel, horas_atuais, horas_restantes, mensagem = EscalaMilitar.verificar_disponibilidade_militar_dia(
                militar, escala.data, hora_inicio_obj, hora_fim_obj
            )
            
            if not disponivel:
                return JsonResponse({
                    'success': False, 
                    'message': mensagem,
                    'horas_atuais': horas_atuais,
                    'horas_restantes': horas_restantes,
                    'tipo_erro': 'limite_horas'
                })
        
        escala_militar = EscalaMilitar.objects.create(
            escala=escala,
            militar=militar,
            funcao=funcao,
            tipo_servico=tipo_servico,
            turno=turno,
            hora_inicio=hora_inicio,
            hora_fim=hora_fim,
            observacoes=observacoes
        )
        
        # Atualizar automaticamente o banco de horas (cada turno separadamente)
        try:
            from .models import BancoHoras
            from datetime import datetime, timedelta
            from decimal import Decimal
            
            if escala_militar.hora_fim and escala_militar.hora_inicio:
                inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                fim = datetime.combine(escala.data, escala_militar.hora_fim)
                
                # Se a hora fim for menor que a hora in√≠cio, assumir que √© no dia seguinte
                if fim <= inicio:
                    fim += timedelta(days=1)
                
                duracao = fim - inicio
                horas_turno = Decimal(str(duracao.total_seconds() / 3600))
                
                if horas_turno > 0:
                    # Verificar se j√° existe movimenta√ß√£o para este turno espec√≠fico
                    movimentacao_existente = BancoHoras.objects.filter(
                        militar=militar,
                        data_movimentacao=escala.data,
                        tipo_movimentacao='ENTRADA',
                        escala_militar=escala_militar
                    ).first()
                    
                    if movimentacao_existente:
                        # Atualizar movimenta√ß√£o existente
                        saldo_anterior = BancoHoras.calcular_saldo_militar(militar, escala.data)
                        saldo_atual = saldo_anterior + horas_turno
                        
                        movimentacao_existente.horas = horas_turno
                        movimentacao_existente.saldo_anterior = saldo_anterior
                        movimentacao_existente.saldo_atual = saldo_atual
                        movimentacao_existente.observacoes = f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}"
                        movimentacao_existente.save()
                    else:
                        # Criar nova movimenta√ß√£o para este turno
                        saldo_anterior = BancoHoras.calcular_saldo_militar(militar, escala.data)
                        saldo_atual = saldo_anterior + horas_turno
                        
                        BancoHoras.objects.create(
                            militar=militar,
                            data_movimentacao=escala.data,
                            tipo_movimentacao='ENTRADA',
                            horas=horas_turno,
                            saldo_anterior=saldo_anterior,
                            saldo_atual=saldo_atual,
                            escala=escala,
                            escala_militar=escala_militar,
                            observacoes=f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}",
                            criado_por=escala.criado_por
                        )
        except Exception as e:
            # Log do erro mas n√£o falha a opera√ß√£o principal
            print(f"Erro ao atualizar banco de horas para {militar.nome_completo}: {str(e)}")
        
        return JsonResponse({
            'success': True, 
            'message': f'Militar {militar.nome_completo} adicionado √† escala com sucesso! Banco de horas atualizado automaticamente.'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro ao adicionar militar: {str(e)}'})


@login_required
def api_adicionar_coletivo(request, pk):
    """API para adicionar militares coletivamente √† escala"""
    from .models import EscalaServico, EscalaMilitar, Militar
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    # Verificar se √© permitido adicionar militares √† escala
    pode_adicionar, mensagem_validacao = escala.pode_adicionar_militares(request.user)
    if not pode_adicionar:
        return JsonResponse({'success': False, 'message': mensagem_validacao})
    
    try:
        # Receber militares como string separada por v√≠rgula
        militares_str = request.POST.get('militares_coletivo', '')
        if militares_str:
            militares_ids = [int(id.strip()) for id in militares_str.split(',') if id.strip().isdigit()]
        else:
            militares_ids = []
            
        funcao = request.POST.get('funcao_coletivo')
        tipo_servico = request.POST.get('tipo_servico_coletivo')
        turno = request.POST.get('turno_coletivo')
        hora_inicio = request.POST.get('hora_inicio_coletivo')
        hora_fim = request.POST.get('hora_fim_coletivo')
        observacoes = request.POST.get('observacoes_coletivo', '')
        
        # Campos espec√≠ficos para escalas operacionais (dados individuais)
        dados_operacionais = {}
        dados_operacionais_str = request.POST.get('dados_operacionais', '')
        if dados_operacionais_str:
            import json
            try:
                dados_operacionais = json.loads(dados_operacionais_str)
            except json.JSONDecodeError:
                dados_operacionais = {}
        
        # Campos espec√≠ficos para escalas administrativas (dados individuais)
        dados_administrativos = {}
        dados_administrativos_str = request.POST.get('dados_administrativos', '')
        if dados_administrativos_str:
            import json
            try:
                dados_administrativos = json.loads(dados_administrativos_str)
            except json.JSONDecodeError:
                dados_administrativos = {}
        
        if not militares_ids:
            return JsonResponse({'success': False, 'message': 'Selecione pelo menos um militar'})
        
        adicionados = 0
        indisponiveis = 0
        
        for militar_id in militares_ids:
            try:
                militar = Militar.objects.get(id=militar_id)
                
                # Verifica√ß√£o removida para permitir m√∫ltiplos turnos do mesmo militar na mesma escala
                
                # Verificar disponibilidade do militar (limite de 24h por dia)
                if hora_inicio and hora_fim:
                    from datetime import datetime, time
                    hora_inicio_obj = datetime.strptime(hora_inicio, '%H:%M').time()
                    hora_fim_obj = datetime.strptime(hora_fim, '%H:%M').time()
                    
                    disponivel, horas_atuais, horas_restantes, mensagem = EscalaMilitar.verificar_disponibilidade_militar_dia(
                        militar, escala.data, hora_inicio_obj, hora_fim_obj
                    )
                    
                    if not disponivel:
                        # Pular este militar se n√£o estiver dispon√≠vel
                        indisponiveis += 1
                        continue
                
                # Buscar dados operacionais espec√≠ficos para este militar
                dados_militar = next((d for d in dados_operacionais if str(d.get('militar_id')) == str(militar_id)), {})
                
                # Buscar dados administrativos espec√≠ficos para este militar
                dados_admin = next((d for d in dados_administrativos if str(d.get('militar_id')) == str(militar_id)), {})
                
                escala_militar = EscalaMilitar.objects.create(
                    escala=escala,
                    militar=militar,
                    funcao=funcao,
                    tipo_servico=tipo_servico,
                    turno=turno,
                    hora_inicio=hora_inicio,
                    hora_fim=hora_fim,
                    secao=dados_admin.get('secao_administrativa', ''),
                    observacoes=observacoes,
                    funcao_operacional=dados_militar.get('funcao_operacional', ''),
                    equipe=dados_militar.get('equipe', ''),
                    viatura=dados_militar.get('viatura', '')
                )
                
                adicionados += 1
                
            except Militar.DoesNotExist:
                continue
        
        # Atualizar banco de horas para cada turno individualmente
        if adicionados > 0:
            try:
                from .models import BancoHoras
                from datetime import datetime, timedelta
                from decimal import Decimal
                
                # Processar cada escala_militar individualmente
                for escala_militar in escala.militares.all():
                    try:
                        if escala_militar.hora_fim and escala_militar.hora_inicio:
                            inicio = datetime.combine(escala.data, escala_militar.hora_inicio)
                            fim = datetime.combine(escala.data, escala_militar.hora_fim)
                            
                            # Se a hora fim for menor que a hora in√≠cio, assumir que √© no dia seguinte
                            if fim <= inicio:
                                fim += timedelta(days=1)
                            
                            duracao = fim - inicio
                            horas_turno = Decimal(str(duracao.total_seconds() / 3600))
                            
                            if horas_turno > 0:
                                # Verificar se j√° existe movimenta√ß√£o para este turno espec√≠fico
                                movimentacao_existente = BancoHoras.objects.filter(
                                    militar=escala_militar.militar,
                                    data_movimentacao=escala.data,
                                    tipo_movimentacao='ENTRADA',
                                    escala_militar=escala_militar
                                ).first()
                                
                                if movimentacao_existente:
                                    # Atualizar movimenta√ß√£o existente
                                    saldo_anterior = BancoHoras.calcular_saldo_militar(escala_militar.militar, escala.data)
                                    saldo_atual = saldo_anterior + horas_turno
                                    
                                    movimentacao_existente.horas = horas_turno
                                    movimentacao_existente.saldo_anterior = saldo_anterior
                                    movimentacao_existente.saldo_atual = saldo_atual
                                    movimentacao_existente.observacoes = f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}"
                                    movimentacao_existente.save()
                                else:
                                    # Criar nova movimenta√ß√£o para este turno
                                    saldo_anterior = BancoHoras.calcular_saldo_militar(escala_militar.militar, escala.data)
                                    saldo_atual = saldo_anterior + horas_turno
                                    
                                    BancoHoras.objects.create(
                                        militar=escala_militar.militar,
                                        data_movimentacao=escala.data,
                                        tipo_movimentacao='ENTRADA',
                                        horas=horas_turno,
                                        saldo_anterior=saldo_anterior,
                                        saldo_atual=saldo_atual,
                                        escala=escala,
                                        escala_militar=escala_militar,
                                        observacoes=f"Turno {escala_militar.hora_inicio} - {escala_militar.hora_fim} da escala {escala}",
                                        criado_por=escala.criado_por
                                    )
                    except Exception as e:
                        print(f"Erro ao processar turno para {escala_militar.militar.nome_completo}: {str(e)}")
                        continue
            except Exception as e:
                print(f"Erro ao atualizar banco de horas: {str(e)}")
        
        if adicionados > 0:
            message = f'{adicionados} militar(es) adicionado(s) com sucesso! Banco de horas atualizado automaticamente.'
            if indisponiveis > 0:
                message += f' {indisponiveis} n√£o puderam ser adicionados (indispon√≠veis).'
            return JsonResponse({'success': True, 'message': message})
        else:
            return JsonResponse({'success': False, 'message': 'Nenhum militar foi adicionado. Todos estavam indispon√≠veis.'})
        
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro ao adicionar militares: {str(e)}'})


@login_required
def api_remover_militar(request, pk):
    """API para remover militar da escala"""
    from .models import EscalaServico, EscalaMilitar, AlteracaoEscala
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.utils import timezone
    import json
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    # Verificar se √© permitido fazer altera√ß√µes na escala (inclui verifica√ß√£o de superusu√°rio)
    pode_alterar, mensagem_validacao = escala.pode_adicionar_militares(request.user)
    if not pode_alterar:
        return JsonResponse({'success': False, 'message': mensagem_validacao})
    
    try:
        # Verificar se √© requisi√ß√£o com FormData (upload de arquivo)
        if request.content_type and 'multipart/form-data' in request.content_type:
            escala_militar_id = request.POST.get('escala_militar_id')
            justificativa = request.POST.get('justificativa', '').strip()
            observacoes = request.POST.get('observacoes', '').strip()
            arquivo = request.FILES.get('arquivo')
        else:
            # Requisi√ß√£o JSON (compatibilidade)
            data = json.loads(request.body)
            escala_militar_id = data.get('escala_militar_id')
            justificativa = data.get('justificativa', '').strip()
            observacoes = data.get('observacoes', '').strip()
            arquivo = None
        
        if not escala_militar_id:
            return JsonResponse({'success': False, 'message': 'ID do militar √© obrigat√≥rio'})
        
        # Se a escala est√° aprovada, justificativa √© obrigat√≥ria
        if escala.status == 'aprovada' and not justificativa:
            return JsonResponse({
                'success': False, 
                'message': 'Justificativa √© obrigat√≥ria para altera√ß√µes em escalas aprovadas'
            })
        
        escala_militar = EscalaMilitar.objects.get(id=escala_militar_id, escala=escala)
        militar_nome = escala_militar.militar.nome_completo
        
        # Salvar dados anteriores para o registro de altera√ß√£o
        dados_anteriores = {
            'militar_id': escala_militar.militar.id,
            'militar_nome': militar_nome,
            'funcao': escala_militar.funcao,
            'tipo_servico': escala_militar.tipo_servico,
            'turno': escala_militar.turno,
            'hora_inicio': escala_militar.hora_inicio.strftime('%H:%M'),
            'hora_fim': escala_militar.hora_fim.strftime('%H:%M'),
            'funcao_operacional': escala_militar.funcao_operacional,
            'equipe': escala_militar.equipe,
            'viatura': escala_militar.viatura,
            'observacoes': escala_militar.observacoes
        }
        
        # Remover movimenta√ß√µes do banco de horas antes de remover o militar
        from .models import BancoHoras
        try:
            # Buscar e remover movimenta√ß√µes relacionadas a este turno espec√≠fico
            movimentacoes_banco = BancoHoras.objects.filter(
                militar=escala_militar.militar,
                data_movimentacao=escala.data,
                tipo_movimentacao='ENTRADA',
                escala_militar=escala_militar
            )
            
            for movimentacao in movimentacoes_banco:
                movimentacao.delete()
            
            # Recalcular saldos ap√≥s remo√ß√£o
            BancoHoras.recalcular_todos_saldos()
            
        except Exception as e:
            print(f"Erro ao atualizar banco de horas na remo√ß√£o: {str(e)}")
        
        # Remover o militar
        escala_militar.delete()
        
        # Registrar altera√ß√£o se a escala estiver aprovada
        if escala.status == 'aprovada':
            # Combinar justificativa e observa√ß√µes
            justificativa_completa = justificativa
            if observacoes:
                justificativa_completa += f"\n\nObserva√ß√µes: {observacoes}"
            
            alteracao = AlteracaoEscala.objects.create(
                escala=escala,
                alterado_por=request.user,
                tipo_alteracao='REMOVER_MILITAR',
                justificativa=justificativa_completa,
                militar_afetado=escala_militar.militar,
                dados_anteriores=dados_anteriores,
                dados_novos={},
                valida_ate_data=escala.data
            )
            
            # Salvar arquivo se fornecido
            if arquivo:
                from django.core.files.storage import default_storage
                from django.core.files.base import ContentFile
                import os
                from datetime import datetime
                
                # Gerar nome √∫nico para o arquivo
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                nome_arquivo = f"alteracao_{alteracao.id}_{timestamp}_{arquivo.name}"
                
                # Salvar arquivo
                caminho_arquivo = default_storage.save(f'alteracoes_escalas/{nome_arquivo}', arquivo)
                
                # Atualizar registro com caminho do arquivo
                alteracao.dados_anteriores['arquivo_anexo'] = caminho_arquivo
                alteracao.dados_anteriores['nome_arquivo_original'] = arquivo.name
                alteracao.save()
        
        return JsonResponse({
            'success': True, 
            'message': f'Militar {militar_nome} removido da escala com sucesso!'
        })
        
    except EscalaMilitar.DoesNotExist:
        return JsonResponse({'success': False, 'message': 'Militar n√£o encontrado na escala'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro ao remover militar: {str(e)}'})


@login_required
def visualizar_documento_alteracao(request, alteracao_id):
    """Visualizar documento anexado em altera√ß√£o de escala"""
    from .models import AlteracaoEscala
    from django.shortcuts import get_object_or_404
    from django.http import FileResponse, Http404
    from django.core.files.storage import default_storage
    import os
    
    try:
        alteracao = get_object_or_404(AlteracaoEscala, id=alteracao_id)
        
        # Verificar se h√° arquivo anexado
        if not alteracao.dados_anteriores or 'arquivo_anexo' not in alteracao.dados_anteriores:
            raise Http404("Documento n√£o encontrado")
        
        caminho_arquivo = alteracao.dados_anteriores['arquivo_anexo']
        nome_original = alteracao.dados_anteriores.get('nome_arquivo_original', 'documento')
        
        # Verificar se o arquivo existe
        if not default_storage.exists(caminho_arquivo):
            raise Http404("Arquivo n√£o encontrado no servidor")
        
        # Abrir arquivo
        arquivo = default_storage.open(caminho_arquivo, 'rb')
        
        # Determinar content type baseado na extens√£o
        extensao = os.path.splitext(nome_original)[1].lower()
        content_types = {
            '.pdf': 'application/pdf',
            '.doc': 'application/msword',
            '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.png': 'image/png'
        }
        
        content_type = content_types.get(extensao, 'application/octet-stream')
        
        # Configurar headers para visualiza√ß√£o inline
        response = FileResponse(arquivo, content_type=content_type)
        response['Content-Disposition'] = f'inline; filename="{nome_original}"'
        
        return response
        
    except Exception as e:
        raise Http404(f"Erro ao carregar documento: {str(e)}")

@login_required
def api_secoes_disponiveis(request):
    """API para buscar se√ß√µes dispon√≠veis baseadas nas escalas existentes"""
    from .models import EscalaMilitar
    from django.http import JsonResponse
    from django.db.models import Q
    
    try:
        # Buscar se√ß√µes √∫nicas de escalas administrativas
        secoes = EscalaMilitar.objects.filter(
            tipo_servico='administrativo',
            secao__isnull=False
        ).exclude(
            secao=''
        ).values_list('secao', flat=True).distinct().order_by('secao')
        
        # Converter para lista e filtrar por termo de busca se fornecido
        termo_busca = request.GET.get('q', '').strip()
        secoes_lista = list(secoes)
        
        if termo_busca:
            secoes_lista = [s for s in secoes_lista if termo_busca.lower() in s.lower()]
        
        return JsonResponse({
            'success': True,
            'secoes': secoes_lista[:20]  # Limitar a 20 resultados
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao buscar se√ß√µes: {str(e)}'
        })

@login_required
def api_equipes_disponiveis(request):
    """API para buscar equipes dispon√≠veis baseadas nas escalas existentes"""
    from .models import EscalaMilitar
    from django.http import JsonResponse
    from django.db.models import Q
    
    try:
        # Buscar todas as equipes √∫nicas das escalas
        equipes = EscalaMilitar.objects.filter(
            equipe__isnull=False,
            equipe__gt=''
        ).values_list('equipe', flat=True).distinct().order_by('equipe')
        
        # Buscar tamb√©m viaturas associadas √†s equipes
        equipes_com_viatura = {}
        for equipe in equipes:
            viatura = EscalaMilitar.objects.filter(
                equipe=equipe,
                viatura__isnull=False,
                viatura__gt=''
            ).values_list('viatura', flat=True).first()
            
            if viatura:
                equipes_com_viatura[equipe] = viatura
        
        # Formatar dados para autocomplete
        equipes_data = []
        for equipe in equipes:
            equipes_data.append({
                'nome': equipe,
                'viatura': equipes_com_viatura.get(equipe, ''),
                'label': equipe  # Apenas o nome da equipe, sem viatura
            })
        
        return JsonResponse({
            'success': True,
            'equipes': equipes_data
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao buscar equipes: {str(e)}'
        })


@login_required
def api_funcoes_operacionais_disponiveis(request):
    """API para buscar fun√ß√µes operacionais dispon√≠veis baseadas nas escalas existentes"""
    from .models import EscalaMilitar
    from django.http import JsonResponse
    
    try:
        # Buscar todas as fun√ß√µes operacionais √∫nicas das escalas
        funcoes = EscalaMilitar.objects.filter(
            funcao_operacional__isnull=False,
            funcao_operacional__gt=''
        ).values_list('funcao_operacional', flat=True).distinct().order_by('funcao_operacional')
        
        # Formatar dados para autocomplete
        funcoes_data = []
        for funcao in funcoes:
            funcoes_data.append({
                'nome': funcao,
                'label': funcao
            })
        
        return JsonResponse({
            'success': True,
            'funcoes': funcoes_data
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao buscar fun√ß√µes operacionais: {str(e)}'
        })


@login_required
def api_revisar_escala(request, pk):
    """API para revisar uma escala"""
    from .models import EscalaServico
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.utils import timezone
    import json
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    try:
        data = json.loads(request.body)
        observacoes = data.get('observacoes', '')
        
        # Atualizar escala
        escala.status = 'em_revisao'
        escala.revisado_por = request.user
        escala.data_revisao = timezone.now()
        escala.observacoes_revisao = observacoes
        escala.save()
        
        return JsonResponse({
            'success': True,
            'message': 'Escala enviada para revis√£o com sucesso!'
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao revisar escala: {str(e)}'
        })


@login_required
def api_aprovar_escala(request, pk):
    """API para aprovar uma escala"""
    from .models import EscalaServico
    from django.shortcuts import get_object_or_404
    from django.http import JsonResponse
    from django.utils import timezone
    import json
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    escala = get_object_or_404(EscalaServico, pk=pk)
    
    try:
        data = json.loads(request.body)
        observacoes = data.get('observacoes', '')
        
        # Atualizar escala
        escala.status = 'aprovada'
        escala.aprovado_por = request.user
        escala.data_aprovacao = timezone.now()
        escala.observacoes_aprovacao = observacoes
        escala.save()
        
        return JsonResponse({
            'success': True,
            'message': 'Escala aprovada com sucesso!'
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao aprovar escala: {str(e)}'
        })


@login_required
def api_viaturas_disponiveis(request):
    """API para buscar viaturas dispon√≠veis baseadas nas escalas existentes"""
    from .models import EscalaMilitar
    from django.http import JsonResponse
    
    try:
        # Buscar todas as viaturas √∫nicas das escalas
        viaturas = EscalaMilitar.objects.filter(
            viatura__isnull=False,
            viatura__gt=''
        ).values_list('viatura', flat=True).distinct().order_by('viatura')
        
        # Formatar dados para autocomplete
        viaturas_data = []
        for viatura in viaturas:
            viaturas_data.append({
                'nome': viatura,
                'label': viatura
            })
        
        return JsonResponse({
            'success': True,
            'viaturas': viaturas_data
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'Erro ao buscar viaturas: {str(e)}'
        })


@login_required
def api_organizacoes_disponiveis(request):
    """API para buscar organiza√ß√µes dispon√≠veis baseado no acesso hier√°rquico do usu√°rio"""
    from django.http import JsonResponse
    from .permissoes_simples import obter_funcao_militar_ativa
    from .models import UsuarioFuncaoMilitar, Orgao, GrandeComando, Unidade, SubUnidade
    
    try:
        print(f"DEBUG: Iniciando api_organizacoes_disponiveis para usu√°rio: {request.user}")
        # Obter fun√ß√£o atual do usu√°rio
        funcao_atual = obter_funcao_militar_ativa(request.user)
        print(f"DEBUG: Fun√ß√£o atual obtida: {funcao_atual}")
        
        # Se n√£o h√° fun√ß√£o ativa na sess√£o, buscar a primeira fun√ß√£o ativa do usu√°rio
        if not funcao_atual:
            funcao_atual = UsuarioFuncaoMilitar.objects.filter(
                usuario=request.user,
                ativo=True
            ).select_related('funcao_militar').first()
            print(f"DEBUG: Fun√ß√£o ativa buscada no banco: {funcao_atual}")
        
        # BYPASS COMPLETO PARA SUPERUSU√ÅRIOS
        if request.user.is_superuser:
            print(f"DEBUG: Usu√°rio superusu√°rio - carregando todas as organiza√ß√µes")
            organizacoes = []
            
            # Adicionar √≥rg√£os
            for orgao in Orgao.objects.filter(ativo=True).order_by('nome'):
                organizacoes.append({
                    'id': f'orgao_{orgao.id}',
                    'nome': orgao.nome,
                    'tipo': 'orgao',
                    'nivel': 1
                })
            
            # Adicionar grandes comandos
            for gc in GrandeComando.objects.filter(ativo=True).order_by('nome'):
                organizacoes.append({
                    'id': f'gc_{gc.id}',
                    'nome': f"{gc.orgao.nome} | {gc.nome}",
                    'tipo': 'grande_comando',
                    'nivel': 2
                })
            
            # Adicionar unidades
            for u in Unidade.objects.filter(ativo=True).order_by('nome'):
                organizacoes.append({
                    'id': f'unidade_{u.id}',
                    'nome': f"{u.grande_comando.orgao.nome} | {u.grande_comando.nome} | {u.nome}",
                    'tipo': 'unidade',
                    'nivel': 3
                })
            
            # Adicionar subunidades
            for s in SubUnidade.objects.filter(ativo=True).order_by('nome'):
                organizacoes.append({
                    'id': f'sub_{s.id}',
                    'nome': f"{s.unidade.grande_comando.orgao.nome} | {s.unidade.grande_comando.nome} | {s.unidade.nome} | {s.nome}",
                    'tipo': 'subunidade',
                    'nivel': 4
                })
        
            print(f"DEBUG: Retornando {len(organizacoes)} organiza√ß√µes para superusu√°rio")
            return JsonResponse({
                'success': True,
                'organizacoes': organizacoes,
                'total': len(organizacoes)
            })
        
        # Para usu√°rios com fun√ß√£o militar, usar o sistema hier√°rquico
        if funcao_atual and funcao_atual.funcao_militar:
            funcao_militar = funcao_atual.funcao_militar
            print(f"DEBUG: Usu√°rio com fun√ß√£o - acesso: {funcao_militar.acesso}")
            print(f"DEBUG: Fun√ß√£o militar: {funcao_militar}")
            print(f"DEBUG: Fun√ß√£o atual: {funcao_atual}")
            organizacoes = []
            
            # TIPO DE ACESSO = TOTAL: Acesso total
            if funcao_militar.acesso == 'TOTAL':
                # Adicionar √≥rg√£os
                for orgao in Orgao.objects.filter(ativo=True).order_by('nome'):
                    organizacoes.append({
                        'id': f'orgao_{orgao.id}',
                        'nome': orgao.nome,
                        'tipo': 'orgao',
                        'nivel': 1
                    })
                
                # Adicionar grandes comandos
                for gc in GrandeComando.objects.filter(ativo=True).order_by('nome'):
                    organizacoes.append({
                        'id': f'gc_{gc.id}',
                        'nome': f"{gc.orgao.nome} | {gc.nome}",
                        'tipo': 'grande_comando',
                        'nivel': 2
                    })
                
                # Adicionar unidades
                for u in Unidade.objects.filter(ativo=True).order_by('nome'):
                    organizacoes.append({
                        'id': f'unidade_{u.id}',
                        'nome': f"{u.grande_comando.orgao.nome} | {u.grande_comando.nome} | {u.nome}",
                        'tipo': 'unidade',
                        'nivel': 3
                    })
                
                # Adicionar subunidades
                for s in SubUnidade.objects.filter(ativo=True).order_by('nome'):
                    organizacoes.append({
                        'id': f'sub_{s.id}',
                        'nome': f"{s.unidade.grande_comando.orgao.nome} | {s.unidade.grande_comando.nome} | {s.unidade.nome} | {s.nome}",
                        'tipo': 'subunidade',
                        'nivel': 4
                    })
            
            # TIPO DE ACESSO = ORGAO: Acesso ao √≥rg√£o + TODAS suas descend√™ncias
            elif funcao_militar.acesso == 'ORGAO':
                if funcao_atual.orgao:
                    # Adicionar √≥rg√£o
                    organizacoes.append({
                        'id': f'orgao_{funcao_atual.orgao.id}',
                        'nome': funcao_atual.orgao.nome,
                        'tipo': 'orgao',
                        'nivel': 1
                    })
                    
                    # Adicionar grandes comandos
                    grandes_comandos = GrandeComando.objects.filter(orgao=funcao_atual.orgao, ativo=True)
                    for gc in grandes_comandos.order_by('nome'):
                        organizacoes.append({
                            'id': f'gc_{gc.id}',
                            'nome': f"{funcao_atual.orgao.nome} | {gc.nome}",
                            'tipo': 'grande_comando',
                            'nivel': 2
                        })
                    
                    # Adicionar unidades
                    unidades = Unidade.objects.filter(grande_comando__in=grandes_comandos, ativo=True)
                    for u in unidades.order_by('nome'):
                        organizacoes.append({
                            'id': f'unidade_{u.id}',
                            'nome': f"{funcao_atual.orgao.nome} | {u.grande_comando.nome} | {u.nome}",
                            'tipo': 'unidade',
                            'nivel': 3
                        })
                    
                    # Adicionar subunidades
                    subunidades = SubUnidade.objects.filter(unidade__in=unidades, ativo=True)
                    for s in subunidades.order_by('nome'):
                        organizacoes.append({
                            'id': f'sub_{s.id}',
                            'nome': f"{funcao_atual.orgao.nome} | {s.unidade.grande_comando.nome} | {s.unidade.nome} | {s.nome}",
                            'tipo': 'subunidade',
                            'nivel': 4
                        })
            
            # TIPO DE ACESSO = GRANDE_COMANDO: Acesso ao grande comando + TODAS suas descend√™ncias
            elif funcao_militar.acesso == 'GRANDE_COMANDO':
                if funcao_atual.grande_comando:
                    # Adicionar grande comando
                    organizacoes.append({
                        'id': f'gc_{funcao_atual.grande_comando.id}',
                        'nome': f"{funcao_atual.grande_comando.orgao.nome} | {funcao_atual.grande_comando.nome}",
                        'tipo': 'grande_comando',
                        'nivel': 2
                    })
                    
                    # Adicionar unidades
                    unidades = Unidade.objects.filter(grande_comando=funcao_atual.grande_comando, ativo=True)
                    for u in unidades.order_by('nome'):
                        organizacoes.append({
                            'id': f'unidade_{u.id}',
                            'nome': f"{funcao_atual.grande_comando.orgao.nome} | {funcao_atual.grande_comando.nome} | {u.nome}",
                            'tipo': 'unidade',
                            'nivel': 3
                        })
                    
                    # Adicionar subunidades
                    subunidades = SubUnidade.objects.filter(unidade__in=unidades, ativo=True)
                    for s in subunidades.order_by('nome'):
                        organizacoes.append({
                            'id': f'sub_{s.id}',
                            'nome': f"{funcao_atual.grande_comando.orgao.nome} | {s.unidade.grande_comando.nome} | {s.unidade.nome} | {s.nome}",
                            'tipo': 'subunidade',
                            'nivel': 4
                        })
            
            # TIPO DE ACESSO = UNIDADE: Acesso √† unidade + TODAS suas subunidades
            elif funcao_militar.acesso == 'UNIDADE':
                if funcao_atual.unidade:
                    # Adicionar unidade
                    organizacoes.append({
                        'id': f'unidade_{funcao_atual.unidade.id}',
                        'nome': f"{funcao_atual.unidade.grande_comando.orgao.nome} | {funcao_atual.unidade.grande_comando.nome} | {funcao_atual.unidade.nome}",
                        'tipo': 'unidade',
                        'nivel': 3
                    })
                    
                    # Adicionar subunidades
                    subunidades = SubUnidade.objects.filter(unidade=funcao_atual.unidade, ativo=True)
                    for s in subunidades.order_by('nome'):
                        organizacoes.append({
                            'id': f'sub_{s.id}',
                            'nome': f"{funcao_atual.unidade.grande_comando.orgao.nome} | {funcao_atual.unidade.grande_comando.nome} | {funcao_atual.unidade.nome} | {s.nome}",
                            'tipo': 'subunidade',
                            'nivel': 4
                        })
            
            # TIPO DE ACESSO = SUBUNIDADE: Acesso apenas √† subunidade
            elif funcao_militar.acesso == 'SUBUNIDADE':
                if funcao_atual.sub_unidade:
                    organizacoes.append({
                        'id': f'sub_{funcao_atual.sub_unidade.id}',
                        'nome': f"{funcao_atual.sub_unidade.unidade.grande_comando.orgao.nome} | {funcao_atual.sub_unidade.unidade.grande_comando.nome} | {funcao_atual.sub_unidade.unidade.nome} | {funcao_atual.sub_unidade.nome}",
                        'tipo': 'subunidade',
                        'nivel': 4
                    })
            
            print(f"DEBUG: Retornando {len(organizacoes)} organiza√ß√µes para usu√°rio com fun√ß√£o")
            return JsonResponse({
                'success': True,
                'organizacoes': organizacoes,
                'total': len(organizacoes)
            })
        
        # Se n√£o tem fun√ß√£o ativa, retornar lista vazia
        print(f"DEBUG: Usu√°rio sem fun√ß√£o ativa - retornando lista vazia")
        print(f"DEBUG: funcao_atual: {funcao_atual}")
        if funcao_atual:
            print(f"DEBUG: funcao_atual.funcao_militar: {funcao_atual.funcao_militar}")
        return JsonResponse({
            'success': True,
            'organizacoes': [],
            'total': 0
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': f'Erro ao buscar organiza√ß√µes: {str(e)}'
        })


@login_required
def gerar_escalas_mes(request):
    """Gerar escalas do m√™s via AJAX"""
    if request.method == 'POST':
        try:
            from datetime import datetime, timedelta, time
            from django.http import JsonResponse
            from .models import EscalaServico, EscalaMilitar
            
            # Obter dados do formul√°rio
            organizacao = request.POST.get('organizacao')
            mes = int(request.POST.get('mes'))
            ano = int(request.POST.get('ano'))
            sobrescrever_existentes = request.POST.get('sobrescrever_existentes') == 'on'
            
            # Configura√ß√µes ser√£o definidas individualmente para cada escala
            # N√£o usar valores padr√£o fixos
            
            # Validar dados obrigat√≥rios
            if not all([organizacao, mes, ano]):
                return JsonResponse({
                    'success': False,
                    'error': 'Todos os campos obrigat√≥rios devem ser preenchidos'
                })
            
            # Validar faixa do m√™s
            if mes < 1 or mes > 12:
                return JsonResponse({
                    'success': False,
                    'error': 'M√™s inv√°lido: deve estar entre 1 e 12'
                })

            # Calcular dias do m√™s sem estourar o limite (12 -> 13)
            import calendar
            primeiro_dia = datetime(ano, mes, 1)
            dias_no_mes = calendar.monthrange(ano, mes)[1]
            ultimo_dia = datetime(ano, mes, dias_no_mes)
            
            # Usar o nome da organiza√ß√£o diretamente (j√° vem formatado da API)
            nome_organizacao = organizacao
            
            # Mapear c√≥digos para nomes dos meses
            meses_nomes = {
                1: 'Janeiro', 2: 'Fevereiro', 3: 'Mar√ßo', 4: 'Abril',
                5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
            }
            
            # Configura√ß√µes padr√£o para escalas (ser√£o definidas individualmente depois)
            tipo_servico_padrao = 'operacional'
            turno_padrao = '8h'
            hora_inicio_padrao = time(8, 0)  # 08:00
            hora_fim_padrao = time(16, 0)   # 16:00
            
            # Lista de escalas criadas
            escalas_criadas = []
            escalas_existentes = 0
            
            # Verificar se j√° existem escalas para esta organiza√ß√£o no m√™s
            escalas_existentes_mes = EscalaServico.objects.filter(
                data__year=ano,
                data__month=mes,
                organizacao=nome_organizacao
            )
            
            if escalas_existentes_mes.exists() and not sobrescrever_existentes:
                return JsonResponse({
                    'success': False,
                    'error': f'J√° existem escalas para {nome_organizacao} em {meses_nomes[mes]}/{ano}. Marque a op√ß√£o "Sobrescrever escalas existentes" para continuar.'
                })
            
            # Gerar escalas para cada dia do m√™s (TODOS os dias)
            for dia in range(1, dias_no_mes + 1):
                data_escala = datetime(ano, mes, dia).date()
                
                # Verificar se j√° existe escala para esta data/organiza√ß√£o
                escala_existente = EscalaServico.objects.filter(
                    data=data_escala,
                    organizacao=nome_organizacao
                ).first()
                
                if escala_existente:
                    if sobrescrever_existentes:
                        # Atualizar escala existente
                        escala_existente.tipo_servico = tipo_servico_padrao
                        escala_existente.turno = turno_padrao
                        escala_existente.hora_inicio = hora_inicio_padrao
                        escala_existente.hora_fim = hora_fim_padrao
                        escala_existente.status = 'pendente'
                        escala_existente.save()
                        escalas_criadas.append(escala_existente)
                    else:
                        escalas_existentes += 1
                else:
                    # Criar nova escala
                    nova_escala = EscalaServico.objects.create(
                        data=data_escala,
                        organizacao=nome_organizacao,
                        tipo_servico=tipo_servico_padrao,
                        turno=turno_padrao,
                        hora_inicio=hora_inicio_padrao,
                        hora_fim=hora_fim_padrao,
                        status='pendente',
                        criado_por=request.user
                    )
                    escalas_criadas.append(nova_escala)
            
            # Sincronizar banco de horas automaticamente ap√≥s criar escalas
            if escalas_criadas:
                try:
                    from .models import BancoHoras
                    resultado_sincronizacao = BancoHoras.sincronizar_banco_horas_escalas(
                        data_inicio=primeiro_dia.date(),
                        data_fim=ultimo_dia.date()
                    )
                    print(f"Sincroniza√ß√£o autom√°tica: {resultado_sincronizacao}")
                except Exception as e:
                    print(f"Erro na sincroniza√ß√£o autom√°tica: {str(e)}")
            
            return JsonResponse({
                'success': True,
                'message': f'Escalas geradas com sucesso!',
                'detalhes': {
                    'organizacao': nome_organizacao,
                    'mes': meses_nomes.get(mes, mes),
                    'ano': ano,
                    'total_escalas': len(escalas_criadas),
                    'escalas_existentes': escalas_existentes,
                    'dias_no_mes': dias_no_mes,
                    'escalas_geradas': [
                        {
                            'data': escala.data.strftime('%d/%m/%Y'),
                            'organizacao': escala.organizacao,
                            'status': escala.get_status_display()
                        } for escala in escalas_criadas[:5]  # Mostrar apenas as primeiras 5
                    ]
                }
            })
            
        except Exception as e:
            return JsonResponse({
                'success': False,
                'error': f'Erro ao gerar escalas: {str(e)}'
            })
    
    return JsonResponse({
        'success': False,
        'error': 'M√©todo n√£o permitido'
    })


@login_required
def escalas_controle(request):
    """Controle de escalas - listar todas as inst√¢ncias organizacionais com estat√≠sticas"""
    from .models import Militar, EscalaServico, Orgao, GrandeComando, Unidade, SubUnidade
    from django.db.models import Count, Q
    from datetime import datetime
    
    def contar_militares_escalas(escalas_instancia):
        """Fun√ß√£o auxiliar para contar militares escalados"""
        militares_escalados = set()
        
        for escala in escalas_instancia:
            for escala_militar in escala.militares.all():
                militar = escala_militar.militar
                militares_escalados.add(militar.id)
        
        return len(militares_escalados)
    
    # Obter m√™s e ano atual
    hoje = datetime.now()
    mes_atual = hoje.month
    ano_atual = hoje.year
    
    # Listas para separar inst√¢ncias com e sem escalas
    instancias_com_escalas = []
    instancias_sem_escalas = []
    
    # Estat√≠sticas gerais
    total_instancias = 0
    total_efetivo_geral = 0
    total_prontos_geral = 0
    total_escalados_geral = 0
    
    # Conjuntos para evitar duplica√ß√£o de militares
    militares_unicos_geral = set()
    militares_prontos_unicos = set()
    militares_afastados_unicos = set()
    militares_escalados_unicos = set()
    
    # 1. PROCESSAR √ìRG√ÉOS
    orgaos = Orgao.objects.filter(ativo=True).order_by('nome')
    for orgao in orgaos:
        total_instancias += 1
        
        # Buscar militares lotados diretamente no √≥rg√£o (sem depend√™ncias)
        militares_orgao = Militar.objects.filter(
            lotacoes__orgao=orgao,
            lotacoes__grande_comando__isnull=True,
            lotacoes__unidade__isnull=True,
            lotacoes__sub_unidade__isnull=True,
            lotacoes__status='ATUAL',
            lotacoes__ativo=True
        ).distinct()
        
        # Estat√≠sticas do √≥rg√£o
        total_efetivo = militares_orgao.count()
        # Todos os tipos de afastamento (exceto PRONTO e ATIVO)
        afastados = militares_orgao.exclude(
            situacao__in=['PRONTO', 'ATIVO']
        ).count()
        # Prontos = Efetivo Total - Afastados (matem√°tica correta)
        prontos = total_efetivo - afastados
        
        # Adicionar militares √∫nicos aos conjuntos gerais
        for militar in militares_orgao:
            militares_unicos_geral.add(militar.id)
            # Considerar prontos todos os que n√£o est√£o afastados (PRONTO + ATIVO)
            if militar.situacao in ['PRONTO', 'ATIVO']:
                militares_prontos_unicos.add(militar.id)
            # Considerar afastados todos os que n√£o est√£o prontos
            else:
                militares_afastados_unicos.add(militar.id)
        
        # Buscar escalas do √≥rg√£o no m√™s
        escalas_orgao = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=orgao.nome) |
            Q(organizacao__icontains=orgao.sigla) |
            Q(organizacao__icontains=orgao.nome_completo)
        )
        
        # Contar militares escalados
        militares_escalados = contar_militares_escalas(escalas_orgao)
        
        # Verificar se h√° escalas para o √≥rg√£o
        escalas_mes = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=orgao.nome) |
            Q(organizacao__icontains=orgao.sigla)
        ).exists()
        
        quantidade_escalas = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=orgao.nome) |
            Q(organizacao__icontains=orgao.sigla)
        ).count()
        
        dados_instancia = {
            'tipo': '√ìrg√£o',
            'nome': orgao.nome_completo,
            'sigla': orgao.sigla,
            'total_efetivo': total_efetivo,
            'prontos': prontos,
            'afastados': afastados,
            'operacionais': militares_escalados,
            'escalas_mes': escalas_mes,
            'quantidade_escalas': quantidade_escalas
        }
        
        if escalas_mes:
            instancias_com_escalas.append(dados_instancia)
        else:
            instancias_sem_escalas.append(dados_instancia)
        
        # Adicionar militares escalados √∫nicos
        for escala in escalas_orgao:
            for escala_militar in escala.militares.all():
                militar = escala_militar.militar
                militares_escalados_unicos.add(militar.id)
    
    # 2. PROCESSAR GRANDES COMANDOS
    grandes_comandos = GrandeComando.objects.filter(ativo=True).order_by('orgao__nome', 'nome')
    for gc in grandes_comandos:
        total_instancias += 1
        
        # Buscar militares lotados diretamente no grande comando (sem depend√™ncias)
        militares_gc = Militar.objects.filter(
            lotacoes__grande_comando=gc,
            lotacoes__unidade__isnull=True,
            lotacoes__sub_unidade__isnull=True,
            lotacoes__status='ATUAL',
            lotacoes__ativo=True
        ).distinct()
        
        # Estat√≠sticas do grande comando
        total_efetivo = militares_gc.count()
        # Todos os tipos de afastamento (exceto PRONTO e ATIVO)
        afastados = militares_gc.exclude(
            situacao__in=['PRONTO', 'ATIVO']
        ).count()
        # Prontos = Efetivo Total - Afastados (matem√°tica correta)
        prontos = total_efetivo - afastados
        
        # Adicionar militares √∫nicos aos conjuntos gerais
        for militar in militares_gc:
            militares_unicos_geral.add(militar.id)
            # Considerar prontos todos os que n√£o est√£o afastados (PRONTO + ATIVO)
            if militar.situacao in ['PRONTO', 'ATIVO']:
                militares_prontos_unicos.add(militar.id)
            # Considerar afastados todos os que n√£o est√£o prontos
            else:
                militares_afastados_unicos.add(militar.id)
        
        # Buscar escalas do grande comando no m√™s
        escalas_gc = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=gc.nome) |
            Q(organizacao__icontains=gc.sigla) |
            Q(organizacao__icontains=gc.nome_completo)
        )
        
        # Contar militares escalados
        militares_escalados = contar_militares_escalas(escalas_gc)
        
        # Verificar se h√° escalas para o grande comando
        escalas_mes = escalas_gc.exists()
        quantidade_escalas = escalas_gc.count()
        
        dados_instancia = {
            'tipo': 'Grande Comando',
            'nome': gc.nome_completo,
            'sigla': gc.sigla,
            'total_efetivo': total_efetivo,
            'prontos': prontos,
            'afastados': afastados,
            'operacionais': militares_escalados,
            'escalas_mes': escalas_mes,
            'quantidade_escalas': quantidade_escalas
        }
        
        if escalas_mes:
            instancias_com_escalas.append(dados_instancia)
        else:
            instancias_sem_escalas.append(dados_instancia)
        
        # Adicionar militares escalados √∫nicos
        for escala in escalas_gc:
            for escala_militar in escala.militares.all():
                militar = escala_militar.militar
                militares_escalados_unicos.add(militar.id)
    
    # 3. PROCESSAR UNIDADES
    unidades = Unidade.objects.filter(ativo=True).order_by('grande_comando__orgao__nome', 'grande_comando__nome', 'nome')
    for unidade in unidades:
        total_instancias += 1
        
        # Buscar militares lotados diretamente na unidade (sem depend√™ncias)
        militares_unidade = Militar.objects.filter(
            lotacoes__unidade=unidade,
            lotacoes__sub_unidade__isnull=True,
            lotacoes__status='ATUAL',
            lotacoes__ativo=True
        ).distinct()
        
        # Estat√≠sticas da unidade
        total_efetivo = militares_unidade.count()
        # Todos os tipos de afastamento (exceto PRONTO e ATIVO)
        afastados = militares_unidade.exclude(
            situacao__in=['PRONTO', 'ATIVO']
        ).count()
        # Prontos = Efetivo Total - Afastados (matem√°tica correta)
        prontos = total_efetivo - afastados
        
        # Adicionar militares √∫nicos aos conjuntos gerais
        for militar in militares_unidade:
            militares_unicos_geral.add(militar.id)
            # Considerar prontos todos os que n√£o est√£o afastados (PRONTO + ATIVO)
            if militar.situacao in ['PRONTO', 'ATIVO']:
                militares_prontos_unicos.add(militar.id)
            # Considerar afastados todos os que n√£o est√£o prontos
            else:
                militares_afastados_unicos.add(militar.id)
        
        # Buscar escalas da unidade no m√™s (apenas da inst√¢ncia espec√≠fica)
        escalas_unidade = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=unidade.nome) |
            Q(organizacao__icontains=unidade.sigla)
        ).exclude(
            organizacao__icontains='Subgrupamento'  # Excluir escalas de subunidades
        )
        
        # Contar militares escalados
        militares_escalados = contar_militares_escalas(escalas_unidade)
        
        # Verificar se h√° escalas para a unidade
        escalas_mes = escalas_unidade.exists()
        quantidade_escalas = escalas_unidade.count()
        
        dados_instancia = {
            'tipo': 'Unidade',
            'nome': unidade.nome,
            'sigla': unidade.sigla,
            'total_efetivo': total_efetivo,
            'prontos': prontos,
            'afastados': afastados,
            'operacionais': militares_escalados,
            'escalas_mes': escalas_mes,
            'quantidade_escalas': quantidade_escalas
        }
        
        if escalas_mes:
            instancias_com_escalas.append(dados_instancia)
        else:
            instancias_sem_escalas.append(dados_instancia)
        
        # Adicionar militares escalados √∫nicos
        for escala in escalas_unidade:
            for escala_militar in escala.militares.all():
                militar = escala_militar.militar
                militares_escalados_unicos.add(militar.id)
    
    # 4. PROCESSAR SUBUNIDADES
    subunidades = SubUnidade.objects.filter(ativo=True).order_by('unidade__grande_comando__orgao__nome', 'unidade__grande_comando__nome', 'unidade__nome', 'nome')
    for sub in subunidades:
        total_instancias += 1
        
        # Buscar militares lotados na subunidade
        militares_sub = Militar.objects.filter(
            lotacoes__sub_unidade=sub,
            lotacoes__status='ATUAL',
            lotacoes__ativo=True
        ).distinct()
        
        # Estat√≠sticas da subunidade
        total_efetivo = militares_sub.count()
        # Todos os tipos de afastamento (exceto PRONTO e ATIVO)
        afastados = militares_sub.exclude(
            situacao__in=['PRONTO', 'ATIVO']
        ).count()
        # Prontos = Efetivo Total - Afastados (matem√°tica correta)
        prontos = total_efetivo - afastados
        
        # Adicionar militares √∫nicos aos conjuntos gerais
        for militar in militares_sub:
            militares_unicos_geral.add(militar.id)
            # Considerar prontos todos os que n√£o est√£o afastados (PRONTO + ATIVO)
            if militar.situacao in ['PRONTO', 'ATIVO']:
                militares_prontos_unicos.add(militar.id)
            # Considerar afastados todos os que n√£o est√£o prontos
            else:
                militares_afastados_unicos.add(militar.id)
        
        # Buscar escalas da subunidade no m√™s
        escalas_subunidade = EscalaServico.objects.filter(
            data__month=mes_atual,
            data__year=ano_atual
        ).filter(
            Q(organizacao__icontains=sub.nome) |
            Q(organizacao__icontains=sub.sigla)
        )
        
        # Contar militares escalados
        militares_escalados = contar_militares_escalas(escalas_subunidade)
        
        # Verificar se h√° escalas para a subunidade
        escalas_mes = escalas_subunidade.exists()
        quantidade_escalas = escalas_subunidade.count()
        
        dados_instancia = {
            'tipo': 'Subunidade',
            'nome': sub.nome,
            'sigla': sub.sigla,
            'total_efetivo': total_efetivo,
            'prontos': prontos,
            'afastados': afastados,
            'operacionais': militares_escalados,
            'escalas_mes': escalas_mes,
            'quantidade_escalas': quantidade_escalas
        }
        
        if escalas_mes:
            instancias_com_escalas.append(dados_instancia)
        else:
            instancias_sem_escalas.append(dados_instancia)
        
        # Adicionar militares escalados √∫nicos
        for escala in escalas_subunidade:
            for escala_militar in escala.militares.all():
                militar = escala_militar.militar
                militares_escalados_unicos.add(militar.id)
    
    # Calcular taxa de conformidade
    taxa_conformidade = (len(instancias_com_escalas) / total_instancias * 100) if total_instancias > 0 else 0
    
    # Calcular estat√≠sticas gerais √∫nicas (sem duplica√ß√£o)
    total_efetivo_geral = len(militares_unicos_geral)
    total_prontos_geral = len(militares_prontos_unicos)
    total_afastados_geral = len(militares_afastados_unicos)
    total_escalados_geral = len(militares_escalados_unicos)
    
    context = {
        'title': 'Controle de Escalas',
        'page_title': 'Controle de Escalas',
        'instancias_com_escalas': instancias_com_escalas,
        'instancias_sem_escalas': instancias_sem_escalas,
        'total_instancias': total_instancias,
        'total_efetivo_geral': total_efetivo_geral,
        'total_prontos_geral': total_prontos_geral,
        'total_afastados_geral': total_afastados_geral,
        'total_escalados_geral': total_escalados_geral,
        'taxa_conformidade': taxa_conformidade,
        'mes_atual': mes_atual,
        'ano_atual': ano_atual
    }
    
    return render(request, 'militares/escalas_controle.html', context)


@login_required
def api_verificar_conflitos_planejadas(request):
    """API para verificar conflitos com opera√ß√µes planejadas antes de adicionar militar √† escala"""
    from .models import Militar, EscalaMilitar
    from django.http import JsonResponse
    from datetime import datetime
    
    if request.method != 'GET':
        return JsonResponse({'success': False, 'message': 'M√©todo n√£o permitido'})
    
    militar_id = request.GET.get('militar_id')
    data = request.GET.get('data')
    hora_inicio = request.GET.get('hora_inicio')
    hora_fim = request.GET.get('hora_fim')
    
    if not all([militar_id, data, hora_inicio, hora_fim]):
        return JsonResponse({'success': False, 'message': 'Par√¢metros obrigat√≥rios: militar_id, data, hora_inicio, hora_fim'})
    
    try:
        militar = Militar.objects.get(id=militar_id)
        data_obj = datetime.strptime(data, '%Y-%m-%d').date()
        hora_inicio_obj = datetime.strptime(hora_inicio, '%H:%M').time()
        hora_fim_obj = datetime.strptime(hora_fim, '%H:%M').time()
        
        # Verificar conflitos com opera√ß√µes planejadas
        tem_conflito, planejadas_conflitantes, mensagem = EscalaMilitar.verificar_conflitos_planejadas(
            militar, data_obj, hora_inicio_obj, hora_fim_obj
        )
        
        return JsonResponse({
            'success': True,
            'tem_conflito': tem_conflito,
            'conflitos': planejadas_conflitantes,
            'mensagem': mensagem
        })
        
    except Militar.DoesNotExist:
        return JsonResponse({'success': False, 'message': 'Militar n√£o encontrado'})
    except ValueError as e:
        return JsonResponse({'success': False, 'message': f'Erro de formato de data/hora: {str(e)}'})
    except Exception as e:
        return JsonResponse({'success': False, 'message': f'Erro interno: {str(e)}'})
