{% load static %}

<style>
/* Garantir que Select2 não apareça como link */
.select2-container--default .select2-selection--single {
    height: 38px !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
    background-color: #fff !important;
}

.select2-container--default .select2-selection--single:hover {
    border-color: #86b7fe !important;
    background-color: #fff !important;
}

.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #86b7fe !important;
    background-color: #fff !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px !important;
    padding-left: 12px !important;
    color: #212529 !important;
    text-decoration: none !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered:hover {
    text-decoration: none !important;
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.select2-container--default .select2-selection--single:hover .select2-selection__rendered {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.select2-container--default .select2-selection--single:hover .select2-selection__rendered * {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered span {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
    display: inline !important;
}

/* Garantir que o texto selecionado seja sempre visível */
.select2-container--default .select2-selection--single .select2-selection__rendered,
.select2-container--default .select2-selection--single .select2-selection__rendered * {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
    display: block !important;
}

/* Garantir que o texto selecionado não fique invisível após seleção */
.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered::before,
.select2-container--default .select2-selection--single .select2-selection__rendered::after {
    display: none !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
}

.select2-results__option {
    text-decoration: none !important;
    cursor: pointer !important;
    color: #212529 !important;
}

.select2-results__option:hover {
    text-decoration: none !important;
    background-color: #f8f9fa !important;
    color: #212529 !important;
}

.select2-results__option:hover * {
    color: #212529 !important;
}

.select2-results__option--highlighted {
    text-decoration: none !important;
    background-color: #0d6efd !important;
    color: #fff !important;
}

.select2-results__option--highlighted * {
    color: #fff !important;
}

/* Garantir que itens da lista não fiquem brancos no hover */
.select2-results__option[style*="color"],
.select2-results__option:hover[style*="color"],
.select2-results__option[style*="white"],
.select2-results__option:hover[style*="white"] {
    color: #212529 !important;
}

/* Exceto quando está destacado (highlighted) */
.select2-results__option--highlighted[style*="color"],
.select2-results__option--highlighted:hover[style*="color"] {
    color: #fff !important;
}

/* Sobrescrever qualquer CSS global que possa estar aplicando cor branca aos itens da lista */
.select2-results__option a,
.select2-results__option a:hover,
.select2-results__option a:focus,
.select2-results__option:hover a,
.select2-results__option:hover a:hover {
    color: #212529 !important;
    text-decoration: none !important;
}

/* Garantir que elementos dentro dos itens também mantenham cor escura */
.select2-results__option *,
.select2-results__option:hover * {
    color: #212529 !important;
}

.select2-results__option--highlighted *,
.select2-results__option--highlighted:hover * {
    color: #fff !important;
}

/* Garantir que o campo de busca do Select2 seja editável */
.select2-search__field {
    width: 100% !important;
    border: none !important;
    outline: none !important;
    padding: 8px !important;
    font-size: 14px !important;
    color: #212529 !important;
    background-color: transparent !important;
}

.select2-search__field:focus {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
}

.select2-search__field[disabled],
.select2-search__field[readonly] {
    background-color: transparent !important;
    opacity: 1 !important;
    cursor: text !important;
}

/* Garantir que o texto seja sempre visível em todos os estados - FORÇAR COR ESCURA */
.select2-container--default .select2-selection--single .select2-selection__rendered,
.select2-container--default .select2-selection--single .select2-selection__rendered:hover,
.select2-container--default .select2-selection--single:hover .select2-selection__rendered,
.select2-container--default .select2-selection--single:hover .select2-selection__rendered *,
.select2-container--default.select2-container--focus .select2-selection--single .select2-selection__rendered,
.select2-container--default.select2-container--open .select2-selection--single .select2-selection__rendered,
.select2-container--default.select2-container--open .select2-selection--single:hover .select2-selection__rendered {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
    display: block !important;
    text-shadow: none !important;
    background-color: transparent !important;
}

/* Sobrescrever qualquer cor branca ou clara - MUITO ESPECÍFICO */
.select2-container--default .select2-selection--single .select2-selection__rendered[style*="color"],
.select2-container--default .select2-selection--single:hover .select2-selection__rendered[style*="color"],
.select2-container--default .select2-selection--single .select2-selection__rendered[style*="white"],
.select2-container--default .select2-selection--single:hover .select2-selection__rendered[style*="white"],
.select2-container--default .select2-selection--single .select2-selection__rendered[style*="#fff"],
.select2-container--default .select2-selection--single:hover .select2-selection__rendered[style*="#fff"] {
    color: #212529 !important;
}

/* Sobrescrever qualquer CSS global que possa estar aplicando cor branca */
a.select2-selection--single,
a.select2-selection--single:hover,
a.select2-selection--single:focus,
.select2-container--default a.select2-selection--single,
.select2-container--default a.select2-selection--single:hover,
.select2-container--default a.select2-selection--single:focus {
    color: #212529 !important;
}

.select2-container--default a.select2-selection--single .select2-selection__rendered,
.select2-container--default a.select2-selection--single:hover .select2-selection__rendered,
.select2-container--default a.select2-selection--single:focus .select2-selection__rendered {
    color: #212529 !important;
}

/* Garantir que elementos filhos também sejam visíveis */
.select2-container--default .select2-selection--single .select2-selection__rendered *,
.select2-container--default .select2-selection--single:hover .select2-selection__rendered *,
.select2-container--default.select2-container--focus .select2-selection--single .select2-selection__rendered * {
    color: #212529 !important;
    visibility: visible !important;
    opacity: 1 !important;
    display: inline !important;
}
</style>

<div class="modal-header bg-warning text-dark">
    <h5 class="modal-title" id="modalAfastamentoLabel">
        <i class="fas fa-ban me-2"></i>
        {% if object %}Editar Afastamento{% else %}Novo Afastamento{% endif %}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="formAfastamento" method="post" action="{% if object %}{% url 'militares:afastamento_update' object.pk %}{% else %}{% url 'militares:afastamento_create' %}{% endif %}" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Erro de Validação</strong>
            </h6>
            <hr>
            {% for error in form.non_field_errors %}
                <div class="mb-2 text-danger">{{ error|safe }}</div>
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.militar.id_for_label }}" class="form-label">
                    Militar <span class="text-danger">*</span>
                </label>
                {{ form.militar }}
                {% if form.militar.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.militar.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.tipo_afastamento.id_for_label }}" class="form-label">
                    Situação <span class="text-danger">*</span>
                </label>
                {{ form.tipo_afastamento }}
                {% if form.tipo_afastamento.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.tipo_afastamento.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                    Data de Início <span class="text-danger">*</span>
                </label>
                {{ form.data_inicio }}
                {% if form.data_inicio.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.data_inicio.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.data_fim_prevista.id_for_label }}" class="form-label">
                    Data de Fim Prevista
                </label>
                {{ form.data_fim_prevista }}
                {% if form.data_fim_prevista.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.data_fim_prevista.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.data_fim_real.id_for_label }}" class="form-label">
                    Data de Fim Real
                </label>
                {{ form.data_fim_real }}
                {% if form.data_fim_real.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.data_fim_real.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-12 mb-3">
                <div class="alert alert-info">
                    <strong><i class="fas fa-calendar-day me-2"></i>Duração do Afastamento:</strong>
                    <span id="duracao-dias" class="fw-bold text-primary ms-2">-</span>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Status <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.status.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.documento_referencia.id_for_label }}" class="form-label">
                    Documento de Referência
                </label>
                {{ form.documento_referencia }}
                {% if form.documento_referencia.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.documento_referencia.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                    Número do Documento
                </label>
                {{ form.numero_documento }}
                {% if form.numero_documento.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.numero_documento.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-12 mb-3">
                <label for="{{ form.motivo.id_for_label }}" class="form-label">
                    Motivo do Afastamento <span class="text-danger">*</span>
                </label>
                {{ form.motivo }}
                {% if form.motivo.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.motivo.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    Observações
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Seção de Documentos -->
        <div class="mt-4 pt-4 border-top">
            <h6 class="mb-3">
                <i class="fas fa-file-upload me-2 text-primary"></i>Documentos do Afastamento
            </h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo do Documento</label>
                    {{ documento_form.tipo }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Título do Documento</label>
                    {{ documento_form.titulo }}
                </div>
                <div class="col-md-12 mb-3">
                    <label class="form-label">Descrição</label>
                    {{ documento_form.descricao }}
                </div>
                <div class="col-md-12 mb-3">
                    <label class="form-label">Arquivo</label>
                    {{ documento_form.arquivo }}
                    <small class="form-text text-muted">Formatos aceitos: PDF, JPG, PNG, DOC, DOCX (máx. 10MB)</small>
                </div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <small>Você pode anexar documentos agora ou depois. Eles aparecerão na página de detalhes.</small>
            </div>
            {% if object and documentos %}
            <div class="mt-3">
                <h6 class="mb-2">
                    <i class="fas fa-file-alt me-2"></i>Documentos Já Anexados ({{ documentos|length }})
                </h6>
                <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                    {% for doc in documentos %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ doc.get_tipo_display }}</strong> - {{ doc.titulo }}
                            {% if doc.descricao %}
                            <br><small class="text-muted">{{ doc.descricao }}</small>
                            {% endif %}
                            <br><small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ doc.data_upload|date:"d/m/Y H:i" }}
                                <i class="fas fa-user me-1 ms-2"></i>{{ doc.upload_por.get_full_name|default:doc.upload_por.username }}
                            </small>
                        </div>
                        <div>
                            <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
function calcularDias() {
    const dataInicio = document.getElementById('id_data_inicio');
    const dataFimReal = document.getElementById('id_data_fim_real');
    const dataFimPrevista = document.getElementById('id_data_fim_prevista');
    const duracaoSpan = document.getElementById('duracao-dias');
    
    if (!dataInicio || !duracaoSpan) return;
    
    const dataInicioVal = dataInicio.value;
    if (!dataInicioVal) {
        duracaoSpan.textContent = '-';
        return;
    }
    
    let dataFim = null;
    if (dataFimReal && dataFimReal.value) {
        dataFim = new Date(dataFimReal.value);
    } else if (dataFimPrevista && dataFimPrevista.value) {
        dataFim = new Date(dataFimPrevista.value);
    } else {
        dataFim = new Date();
    }
    
    const inicio = new Date(dataInicioVal);
    const diffTime = Math.abs(dataFim - inicio);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 30) {
        duracaoSpan.textContent = `${diffDays} dia${diffDays !== 1 ? 's' : ''}`;
    } else if (diffDays < 365) {
        const meses = Math.floor(diffDays / 30);
        const dias = diffDays % 30;
        if (dias === 0) {
            duracaoSpan.textContent = `${meses} ${meses === 1 ? 'mês' : 'meses'}`;
        } else {
            duracaoSpan.textContent = `${meses} ${meses === 1 ? 'mês' : 'meses'} e ${dias} dia${dias !== 1 ? 's' : ''}`;
        }
    } else {
        const anos = Math.floor(diffDays / 365);
        const diasResto = diffDays % 365;
        const meses = Math.floor(diasResto / 30);
        if (meses === 0) {
            duracaoSpan.textContent = `${anos} ${anos === 1 ? 'ano' : 'anos'}`;
        } else {
            duracaoSpan.textContent = `${anos} ${anos === 1 ? 'ano' : 'anos'} e ${meses} ${meses === 1 ? 'mês' : 'meses'}`;
        }
    }
    
    duracaoSpan.innerHTML += ` <span class="badge bg-secondary ms-2">${diffDays} dias</span>`;
}

(function() {
    // Inicializar Select2 no campo militar - versão igual aos outros modais
    function inicializarSelect2Militar() {
        // Verificar se jQuery e Select2 estão disponíveis
        if (typeof jQuery === 'undefined' && typeof $ === 'undefined') {
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        const $ = jQuery || window.$;
        
        if (typeof $.fn.select2 === 'undefined') {
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        // Tentar encontrar o campo de várias formas
        let militarSelect = $('#id_militar');
        
        // Se não encontrar pelo ID, tentar pelo name
        if (militarSelect.length === 0) {
            militarSelect = $('select[name="militar"]');
        }
        
        // Se ainda não encontrar, buscar no formulário
        if (militarSelect.length === 0) {
            const form = document.getElementById('formAfastamento');
            if (form) {
                const selects = form.querySelectorAll('select');
                for (let i = 0; i < selects.length; i++) {
                    const select = selects[i];
                    if (select.id && select.id.includes('militar')) {
                        militarSelect = $(select);
                        break;
                    } else if (select.name && select.name.includes('militar')) {
                        militarSelect = $(select);
                        break;
                    }
                }
            }
        }
        
        // Se o campo não existe, tentar novamente
        if (militarSelect.length === 0) {
            setTimeout(inicializarSelect2Militar, 100);
            return;
        }
        
        // Se já está inicializado, destruir e reinicializar
        if (militarSelect.hasClass('select2-hidden-accessible')) {
            try {
                militarSelect.select2('destroy');
            } catch (e) {
                // Ignorar erro
            }
        }
        
        // Inicializar Select2
        try {
            militarSelect.select2({
                placeholder: 'Digite o nome, matrícula ou posto do militar...',
                allowClear: true,
                minimumInputLength: 2,
                width: '100%',
                dropdownParent: militarSelect.closest('.modal-body').length ? militarSelect.closest('.modal') : $(document.body),
                language: {
                    inputTooShort: function () {
                        return 'Digite pelo menos 2 caracteres...';
                    },
                    noResults: function () {
                        return 'Nenhum militar encontrado';
                    },
                    searching: function () {
                        return 'Buscando...';
                    }
                },
                ajax: {
                    url: '{% url "militares:militar-autocomplete" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term || ''
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results || []
                        };
                    },
                    cache: true
                },
                templateSelection: function(data) {
                    // Garantir que o texto selecionado seja sempre visível
                    if (data.text) {
                        return data.text;
                    }
                    return data.id || '';
                }
            });
            
            // Garantir que o texto selecionado seja visível após seleção
            militarSelect.on('select2:select', function(e) {
                setTimeout(function() {
                    const rendered = militarSelect.next('.select2-container').find('.select2-selection__rendered');
                    if (rendered.length) {
                        rendered.css({
                            'color': '#212529 !important',
                            'visibility': 'visible !important',
                            'opacity': '1 !important',
                            'display': 'block !important'
                        });
                        rendered.find('*').css({
                            'color': '#212529 !important',
                            'visibility': 'visible !important',
                            'opacity': '1 !important'
                        });
                        // Forçar atualização do texto
                        const selectedData = militarSelect.select2('data')[0];
                        if (selectedData && selectedData.text) {
                            rendered.text(selectedData.text);
                        }
                    }
                }, 50);
            });
            
            // Também garantir após mudança
            militarSelect.on('change', function() {
                setTimeout(function() {
                    const rendered = militarSelect.next('.select2-container').find('.select2-selection__rendered');
                    if (rendered.length) {
                        rendered.css({
                            'color': '#212529 !important',
                            'visibility': 'visible !important',
                            'opacity': '1 !important'
                        });
                    }
                }, 50);
            });
            
            // Garantir que o texto seja visível no hover - aplicar após Select2 ser criado
            setTimeout(function() {
                const select2Container = militarSelect.next('.select2-container');
                if (select2Container.length) {
                    // Aplicar CSS inicial - FORÇAR COR ESCURA
                    const rendered = select2Container.find('.select2-selection__rendered');
                    rendered.css({
                        'color': '#212529 !important',
                        'visibility': 'visible',
                        'opacity': '1'
                    });
                    rendered.attr('style', rendered.attr('style') + '; color: #212529 !important;');
                    
                    // Eventos de hover - FORÇAR COR ESCURA
                    select2Container.on('mouseenter mouseover', function() {
                        const rendered = $(this).find('.select2-selection__rendered');
                        rendered.css({
                            'color': '#212529 !important',
                            'visibility': 'visible',
                            'opacity': '1'
                        });
                        rendered.attr('style', rendered.attr('style') + '; color: #212529 !important;');
                        rendered.find('*').css({
                            'color': '#212529 !important',
                            'visibility': 'visible',
                            'opacity': '1'
                        });
                    });
                    
                    select2Container.on('mouseleave mouseout', function() {
                        const rendered = $(this).find('.select2-selection__rendered');
                        rendered.css({
                            'color': '#212529 !important',
                            'visibility': 'visible',
                            'opacity': '1'
                        });
                        rendered.attr('style', rendered.attr('style') + '; color: #212529 !important;');
                    });
                    
                    // Observar mudanças de estilo e forçar cor escura
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                const rendered = select2Container.find('.select2-selection__rendered');
                                if (rendered.length) {
                                    let currentStyle = rendered.attr('style') || '';
                                    if (!currentStyle.includes('color: #212529') && !currentStyle.includes('color:#212529')) {
                                        rendered.css('color', '#212529 !important');
                                    }
                                }
                            }
                        });
                    });
                    
                    observer.observe(select2Container[0], {
                        attributes: true,
                        attributeFilter: ['style', 'class']
                    });
                }
            }, 200);
            
            // Garantir que os itens da lista dropdown mantenham cor escura no hover
            militarSelect.on('select2:open', function() {
                setTimeout(function() {
                    function aplicarCorEscura() {
                        // Aplicar cor escura a todos os itens da lista
                        $('.select2-results__option').each(function() {
                            const $option = $(this);
                            // Só aplicar se não estiver destacado (highlighted)
                            if (!$option.hasClass('select2-results__option--highlighted')) {
                                $option.css('color', '#212529 !important');
                                $option.find('*').css('color', '#212529 !important');
                            }
                        });
                    }
                    
                    // Aplicar imediatamente
                    aplicarCorEscura();
                    
                    // Observar mudanças na lista de resultados
                    const resultsContainer = $('.select2-results');
                    if (resultsContainer.length) {
                        const listObserver = new MutationObserver(function() {
                            aplicarCorEscura();
                        });
                        
                        listObserver.observe(resultsContainer[0], {
                            childList: true,
                            subtree: true,
                            attributes: true,
                            attributeFilter: ['class']
                        });
                    }
                    
                    // Adicionar eventos de hover aos itens da lista
                    $(document).off('mouseenter', '.select2-results__option').on('mouseenter', '.select2-results__option', function() {
                        const $option = $(this);
                        if (!$option.hasClass('select2-results__option--highlighted')) {
                            $option.css('color', '#212529 !important');
                            $option.find('*').css('color', '#212529 !important');
                        }
                    });
                    
                    // Observar mudanças de classe (highlighted)
                    $(document).on('DOMSubtreeModified', '.select2-results', function() {
                        aplicarCorEscura();
                    });
                }, 100);
            });
            
            // Se há um militar já selecionado (na edição), carregar os dados
            {% if object and object.militar %}
            const militarId = {{ object.militar.id }};
            const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
            if (militarId) {
                const option = new Option(militarText, militarId, true, true);
                militarSelect.append(option).trigger('change');
            }
            {% endif %}
        } catch (e) {
            console.error('Erro ao inicializar Select2:', e);
        }
    }
    
    // Função para inicializar tudo
    function inicializarTudo() {
        calcularDias();
        
        // Adicionar listeners para mudanças nas datas
        const dataInicio = document.getElementById('id_data_inicio');
        const dataFimPrevista = document.getElementById('id_data_fim_prevista');
        const dataFimReal = document.getElementById('id_data_fim_real');
        
        if (dataInicio) {
            dataInicio.removeEventListener('change', calcularDias);
            dataInicio.addEventListener('change', calcularDias);
        }
        if (dataFimPrevista) {
            dataFimPrevista.removeEventListener('change', calcularDias);
            dataFimPrevista.addEventListener('change', calcularDias);
        }
        if (dataFimReal) {
            dataFimReal.removeEventListener('change', calcularDias);
            dataFimReal.addEventListener('change', calcularDias);
        }
        
        inicializarSelect2Militar();
    }
    
    // Executar quando o script for carregado
    inicializarTudo();
    
    // Executar após delays para garantir que funcione com conteúdo dinâmico
    setTimeout(inicializarTudo, 50);
    setTimeout(inicializarTudo, 100);
    setTimeout(inicializarTudo, 200);
    setTimeout(inicializarTudo, 300);
    setTimeout(inicializarTudo, 500);
    setTimeout(inicializarTudo, 800);
    setTimeout(inicializarTudo, 1000);
    setTimeout(inicializarTudo, 1500);
    
    // Também executar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarTudo);
    } else {
        // DOM já está pronto, executar novamente
        setTimeout(inicializarTudo, 0);
    }
    
    // Executar quando o modal for mostrado (evento do Bootstrap)
    const modal = document.getElementById('modalAfastamento');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            setTimeout(inicializarTudo, 100);
        });
    }
})();

// Submeter formulário via AJAX - usar IIFE para evitar redeclaração
(function() {
    'use strict';
    const formAfastamento = document.getElementById('formAfastamento');
    if (formAfastamento) {
        // Remover listeners anteriores se existirem
        const newForm = formAfastamento.cloneNode(true);
        formAfastamento.parentNode.replaceChild(newForm, formAfastamento);
        
        const form = document.getElementById('formAfastamento');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Verificar se o CSRF token está presente
                const csrfToken = formData.get('csrfmiddlewaretoken');
                if (!csrfToken) {
                    console.error('CSRF token não encontrado no formulário');
                    alert('Erro: Token de segurança não encontrado. Recarregue a página e tente novamente.');
                    return;
                }
                
                // Log dos dados sendo enviados (apenas em modo debug)
                if (console && console.log) {
                    console.log('Enviando formulário para:', this.action);
                    console.log('CSRF Token presente:', csrfToken ? 'Sim' : 'Não');
                    for (let [key, value] of formData.entries()) {
                        if (key !== 'csrfmiddlewaretoken') {
                            console.log(key + ':', value);
                        }
                    }
                }
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    // Verificar se a resposta é JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            return { ok: response.ok, status: response.status, data: data };
                        });
                    } else {
                        // Se não for JSON, retornar texto
                        return response.text().then(text => {
                            return { ok: response.ok, status: response.status, text: text };
                        });
                    }
                })
                .then(result => {
                    if (result.ok && result.data && result.data.success) {
                        // Sucesso
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAfastamento'));
                        if (modal) modal.hide();
                        
                        // Mostrar mensagem de sucesso
                        if (typeof showMessage === 'function') {
                            showMessage('success', result.data.message);
                        } else {
                            alert(result.data.message);
                        }
                        
                        // Recarregar página após 500ms
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    } else {
                        // Erro de validação ou outro erro
                        if (result.data && result.data.html) {
                            // Atualizar conteúdo do modal com erros
                            const modalContent = document.querySelector('#modalAfastamento .modal-content');
                            if (modalContent) {
                                modalContent.innerHTML = result.data.html;
                                
                                // Re-executar scripts
                                setTimeout(() => {
                                    const scripts = modalContent.querySelectorAll('script');
                                    scripts.forEach(oldScript => {
                                        const newScript = document.createElement('script');
                                        Array.from(oldScript.attributes).forEach(attr => {
                                            newScript.setAttribute(attr.name, attr.value);
                                        });
                                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                                        oldScript.parentNode.replaceChild(newScript, oldScript);
                                    });
                                }, 100);
                            }
                        } else {
                            // Mostrar mensagem de erro genérica
                            let errorMsg = 'Erro ao salvar afastamento.';
                            if (result.data && result.data.message) {
                                errorMsg = result.data.message;
                            } else if (result.data && result.data.errors) {
                                errorMsg = 'Erro de validação: ' + JSON.stringify(result.data.errors);
                            } else if (result.text) {
                                errorMsg = 'Erro: ' + result.text.substring(0, 200);
                            }
                            alert(errorMsg);
                        }
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar afastamento:', error);
                    alert('Erro ao salvar afastamento: ' + (error.message || 'Erro desconhecido'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        }
    }
})();
</script>

