{% extends 'base.html' %}
{% load static %}
{% load nota_filters %}
{% load origem_tags %}
<!-- Template atualizado para mostrar √∫ltima inst√¢ncia da origem -->

{% block title %}Notas{% endblock %}

{% block extra_css %}
<style>
/* Estilos para o dropdown de busca de origem */
#sugestoes_origem {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    background: white;
    margin-top: 0;
    top: 100%;
    position: absolute;
    z-index: 1050;
    width: 100%;
    left: 0;
    display: none; /* Inicialmente oculto */
    max-height: 400px; /* Altura m√°xima para scroll */
}


.sugestao-origem {
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border: none;
    border-bottom: 1px solid #f8f9fa;
}

.sugestao-origem:hover {
    background-color: #f8f9fa;
}

.sugestao-origem:last-child {
    border-bottom: none;
}

.sugestao-origem.bg-primary {
    background-color: #007bff !important;
    color: white !important;
}

.sugestao-origem.bg-primary:hover {
    background-color: #0056b3 !important;
    color: white !important;
}

/* Estilo para o bot√£o da seta */
#toggle_dropdown {
    right: 10px;
    padding: 0.375rem 0.5rem;
    color: #6c757d;
    transition: transform 0.2s ease;
}

#toggle_dropdown:hover {
    color: #495057;
}

#toggle_dropdown:focus {
    box-shadow: none;
    outline: none;
}

/* Rota√ß√£o da seta quando dropdown est√° aberto */
#dropdown_arrow.rotated {
    transform: rotate(180deg);
}

.sugestao-origem h6 {
    margin: 0;
    font-size: 0.9rem;
    color: #495057;
}

.sugestao-origem:hover h6 {
    color: #007bff;
}

/* Destacar texto pesquisado */
.sugestao-origem .highlight {
    background-color: #fff3cd;
    font-weight: bold;
}

/* Estilos para o modal de visualiza√ß√£o de notas */
#visualizarNotaModal .modal-dialog {
    max-width: 95% !important;
    width: 95% !important;
}

@media (min-width: 1200px) {
    #visualizarNotaModal .modal-dialog {
        max-width: 90% !important;
        width: 90% !important;
    }
}

@media (min-width: 1400px) {
    #visualizarNotaModal .modal-dialog {
        max-width: 85% !important;
        width: 85% !important;
    }
}

/* Estilos para o modal de visualiza√ß√£o simplificado */
.conteudo-nota {
    min-height: 200px;
    padding: 20px;
    text-align: justify;
    line-height: 1.8;
    font-family: 'Times New Roman', serif;
}

.conteudo-nota h1, .conteudo-nota h2, .conteudo-nota h3, .conteudo-nota h4, .conteudo-nota h5, .conteudo-nota h6 {
    color: #333;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: bold;
}

.conteudo-nota p {
    margin-bottom: 1rem;
    line-height: 1.8;
    text-indent: 40px;
}

.conteudo-nota ul, .conteudo-nota ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.conteudo-nota li {
    margin-bottom: 0.5rem;
}

.conteudo-nota blockquote {
    border-left: 4px solid #333;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #666;
}

.conteudo-nota table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
}

.conteudo-nota table th,
.conteudo-nota table td {
    padding: 0.75rem;
    border: 1px solid #333;
    text-align: left;
}

.conteudo-nota table th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* Cabe√ßalho oficial */
.documento-header h1, .documento-header h2, .documento-header h3, 
.documento-header h4, .documento-header h5, .documento-header h6 {
    margin: 2px 0;
    font-weight: bold;
    text-transform: uppercase;
}

/* N√∫mero da nota */
.numero-nota {
    font-weight: bold;
    font-size: 16px;
}

/* T√≠tulo da nota */
.titulo-nota {
    font-weight: bold;
    font-size: 18px;
    text-transform: uppercase;
    margin: 20px 0;
}

/* Assinatura */
.assinatura {
    margin-top: 50px;
}

.assinatura p {
    margin: 5px 0;
    text-indent: 0;
}

/* Assinatura eletr√¥nica */
.assinatura-eletronica {
    font-size: 12px;
    color: #666;
    line-height: 1.4;
}

/* Loading spinner */
.fa-spinner {
    color: #007bff;
}

/* Responsividade */
@media (max-width: 768px) {
    .modal-xl {
        max-width: 95%;
    }
    
    .conteudo-nota {
        padding: 15px;
    }
    
    .documento-header h1 { font-size: 16px; }
    .documento-header h2 { font-size: 14px; }
    .documento-header h3 { font-size: 12px; }
    .documento-header h4 { font-size: 11px; }
    .documento-header h5 { font-size: 10px; }
    .documento-header h6 { font-size: 9px; }
}

/* Cores espec√≠ficas para boletim especial */
.text-purple {
    color: #6f42c1 !important;
}

.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}

.btn-purple:hover {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
}

.btn-purple:focus {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-file-alt text-primary"></i>
                        Notas
                    </h3>
                    <div class="btn-group" role="group">
                        {% if user.is_superuser %}
                        <a href="{% url 'militares:reordenar_notas' %}" class="btn btn-warning">
                            <i class="fas fa-sort-numeric-up"></i>
                            Reordenar N√∫meros
                        </a>
                        <a href="{% url 'militares:corrigir_formatos_notas' %}" class="btn btn-info">
                            <i class="fas fa-tools"></i>
                            Corrigir Formatos
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Pesquisa Avan√ßada -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-search text-primary"></i>
                                Pesquisa Avan√ßada
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="GET" id="formPesquisaAvancada">
                                <!-- Manter outros par√¢metros de pesquisa -->
                                {% for key, value in request.GET.items %}
                                    {% if key not in 'pesquisa_origem_dropdown,pesquisa_titulo,pesquisa_numero,pesquisa_data_inicial,pesquisa_data_final,pesquisa_status,pesquisa_tipo_boletim' %}
                                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                                    {% endif %}
                                {% endfor %}
                                
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="pesquisa_origem_dropdown" class="form-label">Origem da Nota</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="pesquisa_origem_dropdown" name="pesquisa_origem_dropdown" 
                                                   value="{{ request.GET.pesquisa_origem_dropdown }}" 
                                                   placeholder="Digite para buscar origem..." 
                                                   autocomplete="off">
                                            <button type="button" class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y" 
                                                    id="toggle_dropdown" style="border: none; background: none; z-index: 1001;">
                                                <i class="fas fa-chevron-down" id="dropdown_arrow"></i>
                                            </button>
                                            <div id="sugestoes_origem" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 400px; overflow-y: auto;">
                                                <!-- Sugest√µes ser√£o carregadas via JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="pesquisa_titulo" class="form-label">T√≠tulo da Nota</label>
                                        <input type="text" class="form-control" id="pesquisa_titulo" name="pesquisa_titulo" 
                                               value="{{ request.GET.pesquisa_titulo }}" placeholder="Digite o t√≠tulo da nota">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="pesquisa_numero" class="form-label">N√∫mero da Nota</label>
                                        <input type="text" class="form-control" id="pesquisa_numero" name="pesquisa_numero" 
                                               value="{{ request.GET.pesquisa_numero }}" placeholder="Digite o n√∫mero da nota">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pesquisa_data_inicial" class="form-label">Data Inicial</label>
                                        <input type="date" class="form-control" id="pesquisa_data_inicial" name="pesquisa_data_inicial" 
                                               value="{{ request.GET.pesquisa_data_inicial }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pesquisa_data_final" class="form-label">Data Final</label>
                                        <input type="date" class="form-control" id="pesquisa_data_final" name="pesquisa_data_final" 
                                               value="{{ request.GET.pesquisa_data_final }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pesquisa_status" class="form-label">Status</label>
                                        <select class="form-select" id="pesquisa_status" name="pesquisa_status">
                                            <option value="">Todos os status</option>
                                            <option value="RASCUNHO" {% if request.GET.pesquisa_status == 'RASCUNHO' %}selected{% endif %}>Rascunho</option>
                                            <option value="PUBLICADA" {% if request.GET.pesquisa_status == 'PUBLICADA' %}selected{% endif %}>Publicada</option>
                                            <option value="ARQUIVADA" {% if request.GET.pesquisa_status == 'ARQUIVADA' %}selected{% endif %}>Arquivada</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pesquisa_tipo_boletim" class="form-label">Tipo de Boletim</label>
                                        <select class="form-select" id="pesquisa_tipo_boletim" name="pesquisa_tipo_boletim">
                                            <option value="">Todos os tipos</option>
                                            <option value="Ostensivo" {% if request.GET.pesquisa_tipo_boletim == 'Ostensivo' %}selected{% endif %}>Ostensivo</option>
                                            <option value="Reservado" {% if request.GET.pesquisa_tipo_boletim == 'Reservado' %}selected{% endif %}>Reservado</option>
                                            <option value="Especial" {% if request.GET.pesquisa_tipo_boletim == 'Especial' %}selected{% endif %}>Especial</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i>
                                                Pesquisar
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="limparPesquisaAvancada()">
                                                <i class="fas fa-times"></i>
                                                Limpar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Exibir Filtros Ativos -->
                    {% if request.GET.pesquisa_origem_dropdown or request.GET.pesquisa_titulo or request.GET.pesquisa_numero or request.GET.pesquisa_data_inicial or request.GET.pesquisa_data_final or request.GET.pesquisa_status %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-filter text-primary"></i>
                                Filtros Ativos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="d-flex flex-wrap gap-2">
                                        {% if request.GET.pesquisa_origem_dropdown %}
                                        <span class="badge bg-primary d-flex align-items-center">
                                            <i class="fas fa-building me-1"></i>
                                            Origem: {{ request.GET.pesquisa_origem_dropdown }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroOrigem()" title="Remover filtro de origem"></button>
                                        </span>
                                        {% endif %}
                                        
                                        {% if request.GET.pesquisa_titulo %}
                                        <span class="badge bg-info d-flex align-items-center">
                                            <i class="fas fa-heading me-1"></i>
                                            T√≠tulo: {{ request.GET.pesquisa_titulo }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroTitulo()" title="Remover filtro de t√≠tulo"></button>
                                        </span>
                                        {% endif %}
                                        
                                        
                                        {% if request.GET.pesquisa_numero %}
                                        <span class="badge bg-warning d-flex align-items-center">
                                            <i class="fas fa-hashtag me-1"></i>
                                            N√∫mero: {{ request.GET.pesquisa_numero }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroNumero()" title="Remover filtro de n√∫mero"></button>
                                        </span>
                                        {% endif %}
                                        
                                        {% if request.GET.pesquisa_data_inicial %}
                                        <span class="badge bg-secondary d-flex align-items-center">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Data Inicial: {{ request.GET.pesquisa_data_inicial }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroDataInicial()" title="Remover filtro de data inicial"></button>
                                        </span>
                                        {% endif %}
                                        
                                        {% if request.GET.pesquisa_data_final %}
                                        <span class="badge bg-secondary d-flex align-items-center">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Data Final: {{ request.GET.pesquisa_data_final }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroDataFinal()" title="Remover filtro de data final"></button>
                                        </span>
                                        {% endif %}
                                        
                                        {% if request.GET.pesquisa_status %}
                                        <span class="badge bg-dark d-flex align-items-center">
                                            <i class="fas fa-flag me-1"></i>
                                            Status: {{ request.GET.pesquisa_status }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="limparFiltroStatus()" title="Remover filtro de status"></button>
                                        </span>
                                        {% endif %}
                                        
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="limparTodosFiltros()">
                                            <i class="fas fa-times"></i>
                                            Limpar Todos os Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    
                    <!-- Bot√£o Nova Nota -->
                    <div class="row mb-3">
                        <div class="col-md-12 text-end">
                            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#novaNotaModal" onclick="console.log('üñ±Ô∏è Bot√£o Nova Nota clicado!')">
                            <i class="fas fa-plus"></i>
                            Nova Nota
                        </button>
                    </div>
                </div>
                    
                    {% if publicacoes %}
                        <!-- Alerta para notas devolvidas -->
                        <div id="alertaNotasDevolvidas" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o!</strong> Existem <span id="quantidadeNotasDevolvidas">0</span> nota(s) devolvida(s) que precisam de corre√ß√£o imediata.
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th style="width: 80px;">Bol.</th>
                                        <th style="width: 80px;">Nota</th>
                                        <th style="width: 100px;">Dia/hora</th>
                                        <th>Origem</th>
                                        <th>T√≠tulo</th>
                                        <th style="width: 150px;">T√≥picos</th>
                                        <th style="width: 120px;">boletim</th>
                                        <th style="width: 80px;">Bombeiros</th>
                                        <th style="width: 80px;">Anexos</th>
                                        <th style="width: 80px;">Revisor</th>
                                        <th style="width: 80px;">Aprovador</th>
                                        <th style="width: 80px;">Editor</th>
                                        <th style="width: 100px;">Status</th>
                                        <th style="width: 100px;">Controles</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for publicacao in publicacoes %}
                                    <tr>
                                        <!-- Bol. -->
                                        <td>
                                            {% if publicacao.status == 'PUBLICADA' and publicacao.numero_boletim or publicacao.numero_boletim_reservado %}
                                                {% if publicacao.tipo_publicacao == 'Reservado' or publicacao.numero_boletim_reservado %}
                                                    <span class="badge bg-danger text-white">
                                                        <i class="fas fa-lock me-1"></i>
                                                        {{ publicacao.numero_boletim_reservado|default:publicacao.numero_boletim }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success text-white">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        {{ publicacao.numero_boletim }}
                                                    </span>
                                                {% endif %}
                                            {% elif can_publish %}
                                                {% if publicacao.tipo_publicacao == 'Reservado' %}
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="enviarNotaParaBoletim({{ publicacao.pk }}, '{{ publicacao.tipo_publicacao|default:'Ostensivo'|escapejs }}')"
                                                        title="Publicar nota no boletim {{ publicacao.tipo_publicacao|default:'Ostensivo' }}">
                                                    <i class="fas fa-newspaper"></i>
                                                </button>
                                                {% elif publicacao.tipo_publicacao == 'Especial' %}
                                                <button class="btn btn-sm btn-purple" 
                                                        onclick="enviarNotaParaBoletim({{ publicacao.pk }}, '{{ publicacao.tipo_publicacao|default:'Ostensivo'|escapejs }}')"
                                                        title="Publicar nota no boletim {{ publicacao.tipo_publicacao|default:'Ostensivo' }}">
                                                    <i class="fas fa-gem"></i>
                                                </button>
                                                {% else %}
                                                <button class="btn btn-sm btn-success" 
                                                        onclick="enviarNotaParaBoletim({{ publicacao.pk }}, '{{ publicacao.tipo_publicacao|default:'Ostensivo'|escapejs }}')"
                                                        title="Publicar nota no boletim {{ publicacao.tipo_publicacao|default:'Ostensivo' }}">
                                                    <i class="fas fa-newspaper"></i>
                                                </button>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">
                                                    <i class="fas fa-lock"></i>
                                                </span>
                                            {% endif %}
                                        </td>
                                        <!-- Nota -->
                                        <td>
                                            {% if publicacao.tipo_publicacao == 'Reservado' %}
                                            <span class="badge bg-danger text-white">{{ publicacao.numero }}</span>
                                            {% else %}
                                            <span class="badge bg-info text-white">{{ publicacao.numero }}</span>
                                            {% endif %}
                                        </td>
                                        <!-- Dia/hora -->
                                        <td>
                                            <small>{{ publicacao.data_criacao|date:"d/m/Y H:i" }}</small>
                                        </td>
                                        <!-- Origem -->
                                        <td>
                                            <small class="text-muted" title="{{ publicacao.origem_publicacao }}">
                                                {{ publicacao.origem_publicacao|ultima_instancia_origem|truncatechars:30 }}
                                            </small>
                                        </td>
                                        <!-- T√≠tulo -->
                                        <td>
                                            <strong>{{ publicacao.titulo|truncatechars:30 }}</strong>
                                        </td>
                                        <!-- T√≥picos -->
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-list text-info me-1"></i>
                                                <small>{{ publicacao.topicos|default:"-"|truncatechars:30 }}</small>
                                            </div>
                                        </td>
                                        <!-- boletim -->
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if publicacao.tipo_publicacao == 'Reservado' %}
                                                    <i class="fas fa-tag text-danger me-1"></i>
                                                    <small class="text-danger fw-bold">{{ publicacao.tipo_publicacao|default:"-" }}</small>
                                                {% elif publicacao.tipo_publicacao == 'Especial' %}
                                                    <i class="fas fa-gem text-purple me-1"></i>
                                                    <small class="text-purple fw-bold">{{ publicacao.tipo_publicacao|default:"-" }}</small>
                                                {% else %}
                                                    <i class="fas fa-tag text-primary me-1"></i>
                                                    <small>{{ publicacao.tipo_publicacao|default:"-" }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                            {% if not user.is_superuser %}
                                                {% load permissoes_tags %}
                                                {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                    {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                        {% comment %} Operador de planejadas - mostrar apenas contador {% endcomment %}
                                                        <span class="badge bg-info text-white">
                                                            <i class="fas fa-users me-1"></i>{{ publicacao.militares_indexados.count }}
                                                        </span>
                                                    {% else %}
                                                        {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                        <button class="btn btn-sm btn-outline-info" 
                                                                onclick="abrirModalIndexacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}')"
                                                                title="Indexar Militares - {{ publicacao.militares_indexados.count }} indexados">
                                                            <i class="fas fa-users me-1"></i>{{ publicacao.militares_indexados.count }}
                                                        </button>
                                                    {% endif %}
                                                {% endwith %}
                                            {% else %}
                                                {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="abrirModalIndexacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}')"
                                                        title="Indexar Militares - {{ publicacao.militares_indexados.count }} indexados">
                                                    <i class="fas fa-users me-1"></i>{{ publicacao.militares_indexados.count }}
                                                </button>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if publicacao.anexos.count > 0 %}
                                                {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                {% if not user.is_superuser %}
                                                    {% load permissoes_tags %}
                                                    {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                        {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                            {% comment %} Operador de planejadas - mostrar apenas contador {% endcomment %}
                                                            <span class="badge bg-primary text-white">
                                                                <i class="fas fa-file-pdf me-1"></i>{{ publicacao.anexos.count }}
                                                            </span>
                                                        {% else %}
                                                            {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                    onclick="mostrarAnexosNota({{ publicacao.pk }})" 
                                                                    title="Ver {{ publicacao.anexos.count }} anexo(s) PDF">
                                                                <i class="fas fa-file-pdf me-1"></i>{{ publicacao.anexos.count }}
                                                            </button>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="mostrarAnexosNota({{ publicacao.pk }})" 
                                                            title="Ver {{ publicacao.anexos.count }} anexo(s) PDF">
                                                        <i class="fas fa-file-pdf me-1"></i>{{ publicacao.anexos.count }}
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-light text-muted" title="Nenhum anexo">
                                                <i class="fas fa-paperclip me-1"></i>0
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if publicacao.status == 'REVISADA' or publicacao.status == 'APROVADA' or publicacao.status == 'EDITADA' or publicacao.status == 'PUBLICADA' or publicacao.status == 'EM_EDICAO' %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                {% if not user.is_superuser %}
                                                    {% load permissoes_tags %}
                                                    {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                        {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                            {% comment %} Operador de planejadas - mostrar apenas √≠cone {% endcomment %}
                                                            <i class="fas fa-clock text-warning"></i>
                                                        {% else %}
                                                            {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                            <button class="btn btn-sm btn-outline-info" 
                                                                    onclick="assinarRevisao({{ publicacao.pk }})"
                                                                    title="Assinar como Revisor">
                                                                <i class="fas fa-signature"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            onclick="assinarRevisao({{ publicacao.pk }})"
                                                            title="Assinar como Revisor">
                                                        <i class="fas fa-signature"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if publicacao.status == 'APROVADA' or publicacao.status == 'EDITADA' or publicacao.status == 'PUBLICADA' or publicacao.status == 'EM_EDICAO' %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                {% if not user.is_superuser %}
                                                    {% load permissoes_tags %}
                                                    {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                        {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                            {% comment %} Operador de planejadas - mostrar apenas √≠cone {% endcomment %}
                                                            <i class="fas fa-clock text-warning"></i>
                                                        {% else %}
                                                            {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                    onclick="assinarAprovacao({{ publicacao.pk }})"
                                                                    title="Assinar como Aprovador">
                                                                <i class="fas fa-signature"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="assinarAprovacao({{ publicacao.pk }})"
                                                            title="Assinar como Aprovador">
                                                        <i class="fas fa-signature"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if publicacao.status == 'EDITADA' or publicacao.status == 'PUBLICADA' or publicacao.status == 'EM_EDICAO' %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                {% if not user.is_superuser %}
                                                    {% load permissoes_tags %}
                                                    {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                        {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                            {% comment %} Operador de planejadas - mostrar apenas √≠cone {% endcomment %}
                                                            <i class="fas fa-clock text-warning"></i>
                                                        {% else %}
                                                            {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                            <button class="btn btn-sm btn-outline-warning" 
                                                                    onclick="assinarEdicao({{ publicacao.pk }})"
                                                                    title="Assinar como Editor">
                                                                <i class="fas fa-signature"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                    <button class="btn btn-sm btn-outline-warning" 
                                                            onclick="assinarEdicao({{ publicacao.pk }})"
                                                            title="Assinar como Editor">
                                                        <i class="fas fa-signature"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if publicacao.status == 'RASCUNHO' %}
                                                <span class="badge bg-secondary text-white">
                                                    <i class="fas fa-edit me-1"></i>
                                                    Rascunho
                                                </span>
                                            {% elif publicacao.status == 'REVISADA' %}
                                                <span class="badge bg-info text-white">
                                                    <i class="fas fa-search me-1"></i>
                                                    Revisada
                                                </span>
                                            {% elif publicacao.status == 'APROVADA' %}
                                                <span class="badge bg-primary text-white">
                                                    <i class="fas fa-check me-1"></i>
                                                    Aprovada
                                                </span>
                                            {% elif publicacao.status == 'EDITADA' %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-pen me-1"></i>
                                                    Editada
                                                </span>
                                            {% elif publicacao.status == 'PUBLICADA' %}
                                                <span class="badge bg-success text-white">
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    Publicada
                                                </span>
                                            {% elif publicacao.status == 'ARQUIVADA' %}
                                                <span class="badge bg-dark text-white">
                                                    <i class="fas fa-archive me-1"></i>
                                                    Arquivada
                                                </span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">
                                                    <i class="fas fa-question me-1"></i>
                                                    {{ publicacao.get_status_display }}
                                                </span>
                                            {% endif %}
                                            
                                            <!-- Indicador de nota devolvida -->
                                            {% if publicacao.assinaturas.count == 0 and publicacao.status == 'RASCUNHO' and publicacao.data_atualizacao > publicacao.data_criacao %}
                                                <!-- Verificar se foi devolvida mas n√£o editada ap√≥s devolu√ß√£o -->
                                                {% if not publicacao.editada_apos_devolucao %}
                                                    <br>
                                                    {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                    {% if not user.is_superuser %}
                                                        {% load permissoes_tags %}
                                                        {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                            {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                                {% comment %} Operador de planejadas - mostrar apenas badge {% endcomment %}
                                                                <span class="badge bg-danger text-white mt-1">
                                                                    <i class="fas fa-undo me-1"></i>
                                                                    Devolvida
                                                                </span>
                                                            {% else %}
                                                                {% comment %} Outros usu√°rios - mostrar bot√£o completo {% endcomment %}
                                                                <button class="btn btn-sm btn-outline-danger mt-1" 
                                                                        onclick="mostrarMotivoDevolucao({{ publicacao.pk }})"
                                                                        title="Ver motivo da devolu√ß√£o">
                                                                    <i class="fas fa-undo me-1"></i>
                                                                    Devolvida
                                                                </button>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        {% comment %} Superusu√°rio - mostrar bot√£o completo {% endcomment %}
                                                        <button class="btn btn-sm btn-outline-danger mt-1" 
                                                                onclick="mostrarMotivoDevolucao({{ publicacao.pk }})"
                                                                title="Ver motivo da devolu√ß√£o">
                                                            <i class="fas fa-undo me-1"></i>
                                                            Devolvida
                                                        </button>
                                                    {% endif %}
                                                {% else %}
                                                    <!-- Nota foi editada ap√≥s devolu√ß√£o - mostrar status normal -->
                                                    <br>
                                                    <span class="badge bg-info text-white mt-1">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Aguardando Revis√£o
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-primary visualizar-nota-btn" 
                                                        data-nota-id="{{ publicacao.pk }}"
                                                        title="Visualizar Publica√ß√£o">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-info" 
                                                        onclick="copiarLinkPDF({{ publicacao.pk }})"
                                                        title="Copiar Link PDF">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger" 
                                                        onclick="gerarPDF({{ publicacao.pk }})"
                                                        title="Gerar PDF">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                                {% comment %} Verificar se √© operador de planejadas {% endcomment %}
                                                {% if not user.is_superuser %}
                                                    {% load permissoes_tags %}
                                                    {% with funcao_usuario=user|obter_funcao_militar_ativa %}
                                                        {% if funcao_usuario and funcao_usuario.funcao_militar.publicacao == 'OPERADOR_PLANEJADAS' %}
                                                            {% comment %} Operador de planejadas - apenas visualizar e copiar link {% endcomment %}
                                                        {% else %}
                                                            {% comment %} Outros usu√°rios - mostrar bot√µes completos {% endcomment %}
                                                            {% if publicacao.status != 'PUBLICADA' %}
                                                            <button class="btn btn-sm btn-outline-info" 
                                                                    onclick="abrirModalEdicao({{ publicacao.pk }})"
                                                                    title="Editar Nota">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            {% endif %}
                                                            {% if publicacao.status != 'PUBLICADA' and publicacao.can_publish %}
                                                                {% if publicacao.tipo_publicacao == 'Reservado' %}
                                                                <button class="btn btn-sm btn-outline-danger" 
                                                                        onclick="abrirModalPublicacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}', '{{ publicacao.topicos|escapejs }}', '{{ publicacao.tipo_publicacao|default:"Ostensivo"|escapejs }}')"
                                                                        title="Enviar para Boletim">
                                                                    <i class="fas fa-paper-plane"></i>
                                                                </button>
                                                                {% else %}
                                                                <button class="btn btn-sm btn-outline-success" 
                                                                        onclick="abrirModalPublicacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}', '{{ publicacao.topicos|escapejs }}', '{{ publicacao.tipo_publicacao|default:"Ostensivo"|escapejs }}')"
                                                                        title="Enviar para Boletim">
                                                                    <i class="fas fa-paper-plane"></i>
                                                                </button>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    {% comment %} Superusu√°rio - mostrar todos os bot√µes {% endcomment %}
                                                    {% if publicacao.status != 'PUBLICADA' %}
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            onclick="abrirModalEdicao({{ publicacao.pk }})"
                                                            title="Editar Nota">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if publicacao.status != 'PUBLICADA' and publicacao.can_publish %}
                                                        {% if publicacao.tipo_publicacao == 'Reservado' %}
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                onclick="abrirModalPublicacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}', '{{ publicacao.topicos|escapejs }}', '{{ publicacao.tipo_publicacao|default:"Ostensivo"|escapejs }}')"
                                                                title="Enviar para Boletim">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                        {% else %}
                                                        <button class="btn btn-sm btn-outline-success" 
                                                                onclick="abrirModalPublicacao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}', '{{ publicacao.topicos|escapejs }}', '{{ publicacao.tipo_publicacao|default:"Ostensivo"|escapejs }}')"
                                                                title="Enviar para Boletim">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if publicacao.status != 'PUBLICADA' %}
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="abrirModalExclusao({{ publicacao.pk }}, '{{ publicacao.titulo|escapejs }}')"
                                                            title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        
                        <!-- Seletor de itens por p√°gina -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="perPageSelect" class="form-label me-2 mb-0">
                                        <small>Itens por p√°gina:</small>
                                    </label>
                                    <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                                        <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    {% if page_obj.paginator.count > 0 %}
                                        Total: {{ page_obj.paginator.count }} notas
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <!-- Pagina√ß√£o -->
                        {% load pagination_tags %}
                        <div class="mt-3">
                        <nav aria-label="Pagina√ß√£o das Notas">
                            <ul class="pagination justify-content-center">
                                {% if page_obj and page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="{% build_pagination_url 1 request %}">
                                            <i class="fas fa-angle-double-left"></i> Primeira
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="{% build_pagination_url page_obj.previous_page_number request %}">
                                            <i class="fas fa-angle-left"></i> Anterior
                                        </a>
                                    </li>
                                {% endif %}
                                
                                <!-- N√∫meros de p√°gina -->
                                {% if page_obj and page_obj.paginator.page_range %}
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="{% build_pagination_url num request %}">{{ num }}</a>
                                            </li>
                                        {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                            <li class="page-item">
                                                <a class="page-link" href="{% build_pagination_url num request %}">{{ num }}</a>
                                            </li>
                                        {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback: Mostrar apenas p√°gina 1 -->
                                    <li class="page-item active">
                                        <span class="page-link">1</span>
                                    </li>
                                {% endif %}
                                
                                {% if page_obj and page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{% build_pagination_url page_obj.next_page_number request %}">
                                            Pr√≥xima <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="{% build_pagination_url page_obj.paginator.num_pages request %}">
                                            √öltima <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                            
                            <!-- Informa√ß√µes da pagina√ß√£o -->
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    {% if page_obj and page_obj.start_index and page_obj.end_index and page_obj.paginator.count %}
                                        Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} notas
                                    {% elif page_obj and page_obj.number and page_obj.paginator.num_pages %}
                                        P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    {% else %}
                                        Nenhuma nota encontrada
                        {% endif %}
                                </small>
                            </div>
                        </nav>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhuma nota encontrada</h5>
                            <p class="text-muted">Clique em "Nova Nota" para criar a primeira nota.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Nova Nota -->
{% include 'militares/nota_form_modal.html' %}

<!-- Modal de Exclus√£o de Nota -->
<div class="modal fade" id="excluirNotaModal" tabindex="-1" aria-labelledby="excluirNotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="excluirNotaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-trash-alt text-danger" style="font-size: 3rem;"></i>
                </div>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Aten√ß√£o!</strong> Esta a√ß√£o n√£o pode ser desfeita.
                </div>
                <p class="mb-3">Tem certeza que deseja excluir a nota:</p>
                <div class="bg-light p-3 rounded">
                    <h6 class="mb-1" id="notaTituloExclusao"></h6>
                    <small class="text-muted" id="notaDetalhesExclusao"></small>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        A nota ser√° permanentemente removida do sistema.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">
                    <i class="fas fa-trash me-1"></i>
                    Sim, Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Publica√ß√£o de Nota -->
<div class="modal fade" id="publicarNotaModal" tabindex="-1" aria-labelledby="publicarNotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="publicarNotaModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Nota para Boletim
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-newspaper text-success" style="font-size: 3rem;"></i>
                </div>
                <p class="mb-3">Esta nota ser√° enviada para o boletim do dia atual:</p>
                <div class="bg-light p-3 rounded mb-3">
                    <h6 class="mb-1" id="notaTituloPublicacao"></h6>
                    <small class="text-muted" id="notaTopicosPublicacao"></small>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Informa√ß√£o:</strong> A nota ser√° automaticamente inclu√≠da no boletim ostensivo correspondente ao seu t√≥pico.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="publicarNoBoletim()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar para o Boletim
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Feedback de Sucesso -->
<div class="modal fade" id="feedbackSucessoModal" tabindex="-1" aria-labelledby="feedbackSucessoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div class="mx-auto d-flex align-items-center justify-content-center bg-success bg-opacity-10 rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-check-circle text-success" style="font-size: 2.5rem;"></i>
        </div>
                </div>
                <h4 class="modal-title text-success mb-3" id="feedbackSucessoModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    Sucesso!
                </h4>
                <p class="text-muted mb-4" id="feedbackSucessoMensagem">
                    Opera√ß√£o realizada com sucesso.
                </p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">
                        <i class="fas fa-check me-2"></i>
                        Entendi
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Feedback de Erro -->
<div class="modal fade" id="feedbackErroModal" tabindex="-1" aria-labelledby="feedbackErroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div class="mx-auto d-flex align-items-center justify-content-center bg-danger bg-opacity-10 rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <h4 class="modal-title text-danger mb-3" id="feedbackErroModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ops! Algo deu errado
                </h4>
                <p class="text-muted mb-4" id="feedbackErroMensagem">
                    Ocorreu um erro inesperado. Tente novamente.
                </p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-danger px-4" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o √© criado dinamicamente pela fun√ß√£o mostrarModalConfirmacao em base.html -->

<!-- Modal de Assinatura de Revis√£o -->
<div class="modal fade" id="modalAssinarRevisao" tabindex="-1" aria-labelledby="modalAssinarRevisaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white border-0">
                <h5 class="modal-title" id="modalAssinarRevisaoLabel">
                    <i class="fas fa-signature me-2"></i>
                    Assinar Nota como Revisor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Nota -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informa√ß√µes da Nota</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>N√∫mero:</strong> <span id="notaNumero">-</span></p>
                                        <p class="mb-2"><strong>T√≠tulo:</strong> <span id="notaTitulo">-</span></p>
                </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Status:</strong> <span id="notaStatus" class="badge">-</span></p>
                                        <p class="mb-2"><strong>Criado por:</strong> <span id="notaCriadoPor">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de Assinatura -->
                <form id="formAssinaturaRevisao">
                    {% csrf_token %}
                    <input type="hidden" id="notaId" name="nota_id">
                    
                    <!-- Campo para selecionar fun√ß√£o -->
                    <div class="mb-3">
                        <label for="funcao_assinatura_modal" class="form-label"><strong>Fun√ß√£o para Assinatura *</strong></label>
                        <select class="form-select" id="funcao_assinatura_modal" name="funcao_assinatura" required>
                            <option value="">Selecione uma fun√ß√£o...</option>
                        </select>
                        <div class="form-text">Selecione a fun√ß√£o que ser√° exibida na assinatura da nota.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_modal" class="form-label">Observa√ß√µes (opcional)</label>
                        <textarea name="observacoes" id="observacoes_modal" class="form-control" rows="3" placeholder="Observa√ß√µes sobre a assinatura..."></textarea>
                    </div>


                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica. 
                        Certifique-se de que todas as informa√ß√µes est√£o corretas antes de assinar.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                    </button>
                <button type="button" class="btn btn-info" id="btnConfirmarAssinatura">
                    <i class="fas fa-signature me-1"></i>
                    Assinar como Revisor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Assinatura de Aprova√ß√£o -->
<div class="modal fade" id="modalAssinarAprovacao" tabindex="-1" aria-labelledby="modalAssinarAprovacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title" id="modalAssinarAprovacaoLabel">
                    <i class="fas fa-signature me-2"></i>
                    Assinar Nota como Aprovador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Nota -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informa√ß√µes da Nota</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>N√∫mero:</strong> <span id="notaNumeroAprovacao">-</span></p>
                                        <p class="mb-2"><strong>T√≠tulo:</strong> <span id="notaTituloAprovacao">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Status:</strong> <span id="notaStatusAprovacao" class="badge">-</span></p>
                                        <p class="mb-2"><strong>Criado por:</strong> <span id="notaCriadoPorAprovacao">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de Assinatura -->
                <form id="formAssinaturaAprovacao">
                    {% csrf_token %}
                    <input type="hidden" id="notaIdAprovacao" name="nota_id">
                    
                    <!-- Campo para selecionar fun√ß√£o -->
                    <div class="mb-3">
                        <label for="funcao_assinatura_modal_aprovacao" class="form-label"><strong>Fun√ß√£o para Assinatura *</strong></label>
                        <select class="form-select" id="funcao_assinatura_modal_aprovacao" name="funcao_assinatura" required>
                            <option value="">Selecione uma fun√ß√£o...</option>
                        </select>
                        <div class="form-text">Selecione a fun√ß√£o que ser√° exibida na assinatura da nota.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_modal_aprovacao" class="form-label">Observa√ß√µes (opcional)</label>
                        <textarea name="observacoes" id="observacoes_modal_aprovacao" class="form-control" rows="3" placeholder="Observa√ß√µes sobre a assinatura..."></textarea>
                    </div>


                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica. 
                        Certifique-se de que todas as informa√ß√µes est√£o corretas antes de assinar.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                <button type="button" class="btn btn-success" id="btnConfirmarAssinaturaAprovacao">
                    <i class="fas fa-signature me-1"></i>
                    Assinar como Aprovador
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Assinatura de Edi√ß√£o -->
<div class="modal fade" id="modalAssinarEdicao" tabindex="-1" aria-labelledby="modalAssinarEdicaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title" id="modalAssinarEdicaoLabel">
                    <i class="fas fa-signature me-2"></i>
                    Assinar Nota como Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Nota -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informa√ß√µes da Nota</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>N√∫mero:</strong> <span id="notaNumeroEdicao">-</span></p>
                                        <p class="mb-2"><strong>T√≠tulo:</strong> <span id="notaTituloEdicao">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Status:</strong> <span id="notaStatusEdicao" class="badge">-</span></p>
                                        <p class="mb-2"><strong>Criado por:</strong> <span id="notaCriadoPorEdicao">-</span></p>
                                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de Assinatura -->
                <form id="formAssinaturaEdicao">
                    {% csrf_token %}
                    <input type="hidden" id="notaIdEdicao" name="nota_id">
                    
                    <!-- Campo para selecionar fun√ß√£o -->
                    <div class="mb-3">
                        <label for="funcao_assinatura_modal_edicao" class="form-label"><strong>Fun√ß√£o para Assinatura *</strong></label>
                        <select class="form-select" id="funcao_assinatura_modal_edicao" name="funcao_assinatura" required>
                            <option value="">Selecione uma fun√ß√£o...</option>
                        </select>
                        <div class="form-text">Selecione a fun√ß√£o que ser√° exibida na assinatura da nota.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_modal_edicao" class="form-label">Observa√ß√µes (opcional)</label>
                        <textarea name="observacoes" id="observacoes_modal_edicao" class="form-control" rows="3" placeholder="Observa√ß√µes sobre a assinatura..."></textarea>
                    </div>


                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica. 
                        Certifique-se de que todas as informa√ß√µes est√£o corretas antes de assinar.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnConfirmarAssinaturaEdicao">
                    <i class="fas fa-signature me-1"></i>
                    Assinar como Editor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Devolver Nota -->
<div class="modal fade" id="modalDevolverNota" tabindex="-1" aria-labelledby="modalDevolverNotaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" style="z-index: 1060;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title" id="modalDevolverNotaLabel">
                    <i class="fas fa-undo me-2"></i>
                    Devolver Nota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Nota -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informa√ß√µes da Nota</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>N√∫mero:</strong> <span id="notaNumeroDevolver">-</span></p>
                                        <p class="mb-2"><strong>T√≠tulo:</strong> <span id="notaTituloDevolver">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Status:</strong> <span id="notaStatusDevolver" class="badge">-</span></p>
                                        <p class="mb-2"><strong>Criado por:</strong> <span id="notaCriadoPorDevolver">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aviso sobre devolu√ß√£o -->
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Aten√ß√£o:</strong> Ao devolver esta nota, todas as assinaturas ser√£o removidas e a nota retornar√° ao status de rascunho.
                </div>

                <!-- Formul√°rio de Devolu√ß√£o -->
                <form id="formDevolverNota">
                    {% csrf_token %}
                    <input type="hidden" id="notaIdDevolver" name="nota_id">
                    
                    <div class="mb-3">
                        <label for="motivo_devolucao" class="form-label"><strong>Motivo da Devolu√ß√£o *</strong></label>
                        <textarea class="form-control" id="motivo_devolucao" name="motivo_devolucao" rows="4" 
                                  placeholder="Descreva o motivo da devolu√ß√£o da nota..." required></textarea>
                        <div class="form-text">Seja espec√≠fico sobre os motivos que levaram √† devolu√ß√£o da nota.</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Informa√ß√£o:</strong> A devolu√ß√£o ser√° registrada no hist√≥rico da nota e notificar√° o criador.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" onclick="voltarParaVisualizacao()">
                    <i class="fas fa-arrow-left me-1"></i>
                    Voltar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarDevolucao">
                    <i class="fas fa-undo me-1"></i>
                    Devolver Nota
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Mostrar Motivo da Devolu√ß√£o -->
<div class="modal fade" id="modalMotivoDevolucao" tabindex="-1" aria-labelledby="modalMotivoDevolucaoLabel" aria-hidden="true" style="z-index: 1080;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title" id="modalMotivoDevolucaoLabel">
                    <i class="fas fa-undo me-2"></i>
                    Motivo da Devolu√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes da Nota -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Informa√ß√µes da Nota</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>N√∫mero:</strong> <span id="notaNumeroMotivo">-</span></p>
                                        <p class="mb-2"><strong>T√≠tulo:</strong> <span id="notaTituloMotivo">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Status:</strong> <span id="notaStatusMotivo" class="badge">-</span></p>
                                        <p class="mb-2"><strong>Criado por:</strong> <span id="notaCriadoPorMotivo">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivo da Devolu√ß√£o -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Motivo da Devolu√ß√£o</h6>
                        <div class="card border-danger">
                            <div class="card-body">
                                <div class="alert alert-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Detalhes da Devolu√ß√£o:</strong>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded">
                                    <div id="motivoDevolucaoTexto" class="mb-0">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Carregando motivo da devolu√ß√£o...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes Adicionais -->
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Informa√ß√£o:</strong> Esta nota foi devolvida e todas as assinaturas foram removidas. 
                            A nota retornou ao status de rascunho e pode ser editada novamente.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="abrirModalEdicao(notaIdMotivo)">
                    <i class="fas fa-edit me-1"></i>
                    Editar Nota
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para Salvar Modelo (Edi√ß√£o) -->
<div class="modal fade" id="salvarModeloEdicaoModal" tabindex="-1" aria-labelledby="salvarModeloEdicaoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="salvarModeloEdicaoModalLabel">
                    <i class="fas fa-save me-2"></i>
                    Salvar Modelo de Nota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formSalvarModeloEdicao">
                    <div class="mb-3">
                        <label for="nomeModeloEdicao" class="form-label">Nome do Modelo</label>
                        <input type="text" class="form-control" id="nomeModeloEdicao" name="nome" 
                               placeholder="Ex: Escala de Servi√ßos, Portaria de Designa√ß√£o..." required>
                    </div>
                    <div class="mb-3">
                        <label for="descricaoModeloEdicao" class="form-label">Descri√ß√£o (opcional)</label>
                        <textarea class="form-control" id="descricaoModeloEdicao" name="descricao" rows="3" 
                                  placeholder="Descreva quando usar este modelo..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conte√∫do do Modelo</label>
                        <div class="border p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
                            <div id="previewModeloEdicao"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="confirmarSalvarModeloEdicao()">
                    <i class="fas fa-save me-1"></i>
                    Salvar Modelo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Carregar Modelo (Edi√ß√£o) -->
<div class="modal fade" id="carregarModeloEdicaoModal" tabindex="-1" aria-labelledby="carregarModeloEdicaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="carregarModeloEdicaoModalLabel">
                    <i class="fas fa-folder-open me-2"></i>
                    Carregar Modelo de Nota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="buscarModeloEdicao" placeholder="Buscar modelo..." 
                           onkeyup="filtrarModelosEdicao()">
                </div>
                <div id="listaModelosEdicao" class="row">
                    <!-- Modelos ser√£o carregados aqui via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>


 <!-- Modal de Indexa√ß√£o de Militares -->
 <div class="modal fade" id="indexarMilitaresModal" tabindex="-1" aria-labelledby="indexarMilitaresModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-xl">
         <div class="modal-content">
             <div class="modal-header bg-secondary text-white">
                 <h5 class="modal-title" id="indexarMilitaresModalLabel">
                     <i class="fas fa-users me-2"></i>Indexar Militares
                 </h5>
                 <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
                 <div class="mb-3">
                     <label class="form-label"><strong>Nota:</strong></label>
                     <p id="notaTituloIndexacao" class="text-muted"></p>
                 </div>
                 
                        <!-- Filtro de Busca -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="filtroMilitares" class="form-label">
                                    <i class="fas fa-search me-1"></i>Buscar militares:
                                </label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="filtroMilitares" 
                                           placeholder="Digite nome, nome de guerra, posto, matr√≠cula..." 
                                           onkeyup="buscarMilitaresDinamico()"
                                           autocomplete="off">
                                    <div class="position-absolute top-50 end-0 translate-middle-y pe-3">
                                        <i class="fas fa-spinner fa-spin" id="loadingBusca" style="display: none;"></i>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Digite para buscar militares em tempo real (m√≠nimo 2 caracteres)
                                </small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">A√ß√µes:</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-sm btn-success" onclick="selecionarTodos()">
                                        <i class="fas fa-check-double me-1"></i>Selecionar Todos
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" onclick="limparSelecao()">
                                        <i class="fas fa-times me-1"></i>Limpar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparFiltro()">
                                        <i class="fas fa-eraser me-1"></i>Limpar Filtro
                                    </button>
                                </div>
                            </div>
                        </div>
                 
                         <!-- Lista de Militares Dispon√≠veis -->
                         <div class="row">
                             <div class="col-md-6">
                                 <div class="d-flex justify-content-between align-items-center mb-2">
                                     <h6 class="text-primary mb-0">
                                         <i class="fas fa-list me-1"></i>Militares Dispon√≠veis
                                     </h6>
                                     <div>
                                         <span class="badge bg-primary" id="contadorDisponiveis">0</span>
                                         <small class="text-muted ms-2" id="totalMilitares">de 0</small>
                                     </div>
                                 </div>
                                 <div class="border rounded p-2" style="max-height: 450px; overflow-y: auto;">
                                     <div id="listaMilitaresDisponiveis">
                                         <!-- Lista ser√° carregada via JavaScript -->
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="col-md-6">
                                 <div class="d-flex justify-content-between align-items-center mb-2">
                                     <h6 class="text-success mb-0">
                                         <i class="fas fa-check-circle me-1"></i>Militares Indexados
                                     </h6>
                                     <span class="badge bg-success" id="contadorIndexados">0</span>
                                 </div>
                                 <div class="border rounded p-2" style="max-height: 450px; overflow-y: auto;">
                                     <div id="militaresIndexados">
                                         <!-- Lista de militares j√° indexados -->
                                     </div>
                                 </div>
                             </div>
                         </div>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                     <i class="fas fa-times me-1"></i>Cancelar
                 </button>
                 <button type="button" class="btn btn-primary" onclick="salvarIndexacao()">
                     <i class="fas fa-save me-1"></i>Salvar Altera√ß√µes
                 </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Anexos da Nota -->
<div class="modal fade" id="anexosNotaModal" tabindex="-1" aria-labelledby="anexosNotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="anexosNotaModalLabel">
                    <i class="fas fa-file-pdf me-2"></i>
                    Anexos da Nota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="anexos-loading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Carregando anexos...</p>
                </div>
                
                <!-- Lista de Anexos -->
                <div id="anexos-lista-modal" style="display: none;">
                    <!-- Anexos ser√£o carregados aqui -->
                </div>
                
                <!-- Mensagem quando n√£o h√° anexos -->
                <div id="anexos-vazios" class="text-center py-4" style="display: none;">
                    <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum anexo encontrado</h5>
                    <p class="text-muted">Esta nota n√£o possui anexos PDF.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                 </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block ckeditor_media %}
    <!-- CKEditor 5 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
{% endblock %}

{% block extra_js %}
<script>
// ==================== BUSCA DIN√ÇMICA DE ORIGEM ====================

// Aguardar o DOM estar carregado
document.addEventListener('DOMContentLoaded', function() {
    // Dados das origens dispon√≠veis (passados do backend)
    const origensDisponiveis = [
        {% for origem in origens_unicas %}
            "{{ origem|escapejs }}",
        {% endfor %}
    ];

    // Elementos do DOM
    const inputOrigem = document.getElementById('pesquisa_origem_dropdown');
    const sugestoesDiv = document.getElementById('sugestoes_origem');
    const toggleButton = document.getElementById('toggle_dropdown');
    const dropdownArrow = document.getElementById('dropdown_arrow');
    
    // Vari√°vel para debounce
    let searchTimeout;
    
    // Fun√ß√£o para abrir dropdown
    function abrirDropdown() {
        mostrarSugestoesOrigem(inputOrigem.value);
        sugestoesDiv.style.display = 'block';
        dropdownArrow.classList.add('rotated');
    }
    
    // Fun√ß√£o para fechar dropdown
    function fecharDropdown() {
        sugestoesDiv.style.display = 'none';
        dropdownArrow.classList.remove('rotated');
    }
    
    // Fun√ß√£o para alternar dropdown
    function alternarDropdown() {
        if (sugestoesDiv.style.display === 'none' || sugestoesDiv.style.display === '') {
            abrirDropdown();
        } else {
            fecharDropdown();
        }
    }

// Fun√ß√£o para mostrar sugest√µes
function mostrarSugestoesOrigem(texto) {
    // Limpar dropdown anterior
    sugestoesDiv.innerHTML = '';
    
    // Se n√£o h√° texto, mostrar todas as op√ß√µes
    if (!texto || texto.trim() === '') {
        texto = '';
    }
    
    // Filtrar origens baseado no texto
    let origensFiltradas;
    if (texto.trim() === '') {
        // Se n√£o h√° texto, mostrar todas as op√ß√µes
        origensFiltradas = origensDisponiveis;
    } else {
        // Filtrar baseado no texto digitado (busca mais inteligente)
        const textoBusca = texto.toLowerCase().trim();
        origensFiltradas = origensDisponiveis.filter(origem => {
            const origemLower = origem.toLowerCase();
            // Busca exata no in√≠cio
            if (origemLower.startsWith(textoBusca)) {
                return true;
            }
            // Busca por palavras-chave (separadas por espa√ßos)
            const palavrasOrigem = origemLower.split(/\s+/);
            const palavrasBusca = textoBusca.split(/\s+/);
            
            // Verificar se todas as palavras de busca est√£o na origem
            return palavrasBusca.every(palavraBusca => 
                palavrasOrigem.some(palavraOrigem => 
                    palavraOrigem.includes(palavraBusca)
                )
            );
        });
    }
    
    // Sempre mostrar o dropdown se h√° origens dispon√≠veis
    if (origensDisponiveis.length > 0) {
        if (origensFiltradas.length > 0) {
            // Adicionar cabe√ßalho se n√£o h√° filtro
            if (texto.trim() === '') {
                const header = document.createElement('div');
                header.className = 'list-group-item text-muted small bg-light d-flex justify-content-between align-items-center';
                header.innerHTML = `
                    <span><i class="fas fa-list me-1"></i>Todas as origens dispon√≠veis</span>
                    <button type="button" class="btn-close btn-close-sm" aria-label="Fechar" style="font-size: 0.7rem;"></button>
                `;
                sugestoesDiv.appendChild(header);
                
                // Adicionar evento de fechar
                const closeBtn = header.querySelector('.btn-close');
                closeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    sugestoesDiv.style.display = 'none';
                });
            }
            
            // Mostrar at√© 15 origens (aumentado para mostrar mais op√ß√µes)
            origensFiltradas.slice(0, 15).forEach((origem, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action sugestao-origem';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${origem}</h6>
                    </div>
                `;
                
                // Destacar a primeira op√ß√£o que corresponde ao texto digitado
                if (texto.trim() !== '' && index === 0) {
                    item.classList.add('bg-primary', 'text-white');
                }
                
                item.addEventListener('click', function() {
                    inputOrigem.value = origem;
                    sugestoesDiv.style.display = 'none';
                });
                
                sugestoesDiv.appendChild(item);
            });
            
            // Scroll autom√°tico para a primeira op√ß√£o se h√° texto digitado
            if (texto.trim() !== '' && origensFiltradas.length > 0) {
                setTimeout(() => {
                    const firstItem = sugestoesDiv.querySelector('.sugestao-origem');
                    if (firstItem) {
                        // Scroll para o topo do dropdown para mostrar a primeira op√ß√£o
                        sugestoesDiv.scrollTop = 0;
                        // Destacar visualmente a primeira op√ß√£o
                        firstItem.style.backgroundColor = '#007bff';
                        firstItem.style.color = 'white';
                    }
                }, 100);
            }
        } else {
            sugestoesDiv.innerHTML = `
                <div class="list-group-item text-muted small">
                    <i class="fas fa-search me-1"></i>
                    Nenhuma origem encontrada
                </div>
            `;
        }
    }
}

// Event listeners
if (inputOrigem) {
    inputOrigem.addEventListener('input', function() {
        // Limpar timeout anterior
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Mostrar dropdown imediatamente
        sugestoesDiv.style.display = 'block';
        dropdownArrow.classList.add('rotated');
        
        // Debounce para pesquisa em tempo real
        searchTimeout = setTimeout(() => {
            mostrarSugestoesOrigem(this.value);
        }, 100);
    });
    
    inputOrigem.addEventListener('focus', function() {
        abrirDropdown();
    });
    
    inputOrigem.addEventListener('click', function() {
        abrirDropdown();
    });
    
    // Navega√ß√£o por teclado
    inputOrigem.addEventListener('keydown', function(e) {
        const items = sugestoesDiv.querySelectorAll('.sugestao-origem');
        const currentActive = sugestoesDiv.querySelector('.sugestao-origem.active');
        let currentIndex = -1;
        
        if (currentActive) {
            currentIndex = Array.from(items).indexOf(currentActive);
        }
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (items.length > 0) {
                    // Remover destaque anterior
                    items.forEach(item => {
                        item.classList.remove('active', 'bg-primary');
                        item.style.backgroundColor = '';
                        item.style.color = '';
                    });
                    
                    // Destacar pr√≥ximo item
                    const nextIndex = (currentIndex + 1) % items.length;
                    const nextItem = items[nextIndex];
                    nextItem.classList.add('active', 'bg-primary');
                    nextItem.style.backgroundColor = '#007bff';
                    nextItem.style.color = 'white';
                    
                    // Scroll para o item ativo
                    nextItem.scrollIntoView({ block: 'nearest' });
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (items.length > 0) {
                    // Remover destaque anterior
                    items.forEach(item => {
                        item.classList.remove('active', 'bg-primary');
                        item.style.backgroundColor = '';
                        item.style.color = '';
                    });
                    
                    // Destacar item anterior
                    const prevIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                    const prevItem = items[prevIndex];
                    prevItem.classList.add('active', 'bg-primary');
                    prevItem.style.backgroundColor = '#007bff';
                    prevItem.style.color = 'white';
                    
                    // Scroll para o item ativo
                    prevItem.scrollIntoView({ block: 'nearest' });
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                if (currentActive) {
                    const origem = currentActive.querySelector('h6').textContent;
                    inputOrigem.value = origem;
                    sugestoesDiv.style.display = 'none';
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                sugestoesDiv.style.display = 'none';
                break;
        }
    });
    
}

// Event listener para o bot√£o da seta
if (toggleButton) {
    toggleButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        alternarDropdown();
    });
}

// Event listener para sele√ß√£o de op√ß√£o
if (sugestoesDiv) {
    sugestoesDiv.addEventListener('click', function(e) {
        if (e.target.closest('.sugestao-origem')) {
            // Selecionar o valor e fechar o dropdown
            const origem = e.target.closest('.sugestao-origem').querySelector('h6').textContent;
            inputOrigem.value = origem;
            fecharDropdown();
        }
    });
    
    // Manter dropdown aberto quando clicar nele
    sugestoesDiv.addEventListener('mousedown', function(e) {
        e.preventDefault();
    });
}

// Fechar dropdown quando clicar fora
document.addEventListener('click', function(e) {
    if (!inputOrigem.contains(e.target) && !sugestoesDiv.contains(e.target) && !toggleButton.contains(e.target)) {
        fecharDropdown();
    }
});

}); // Fechamento do DOMContentLoaded

// ==================== FUN√á√ïES EXISTENTES ====================

// Fun√ß√£o para alterar itens por p√°gina
function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    // Manter a p√°gina atual ou ir para p√°gina 1 se n√£o houver p√°gina espec√≠fica
    if (!url.searchParams.get('page')) {
        url.searchParams.set('page', '1');
    }
    window.location.href = url.toString();
}

function enviarNotaParaBoletim(notaId, tipoBoletim) {
    mostrarModalConfirmacao(
        'Confirmar Publica√ß√£o',
        `Deseja enviar esta nota para publicar no boletim ${tipoBoletim}?`,
        function() {
            // Aqui voc√™ pode implementar a l√≥gica para enviar a nota
            // Por exemplo, fazer uma requisi√ß√£o AJAX para uma view espec√≠fica
            fetch(`/militares/notas/${notaId}/publicar-boletim/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'tipo_boletim': tipoBoletim
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarModalSucesso('Nota Enviada!', 'Nota enviada para o boletim com sucesso!');
                    // Recarregar a p√°gina ou atualizar a tabela
                    location.reload();
                } else {
                    mostrarModalErro('Erro ao Enviar', 'Erro ao enviar nota: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarModalErro('Erro de Conex√£o', 'Erro ao enviar nota. Tente novamente.');
            });
        }
    );
}

function assinarRevisao(notaId) {
    // Buscar dados da nota via AJAX
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informa√ß√µes da nota no modal
                document.getElementById('notaId').value = notaId;
                document.getElementById('notaNumero').textContent = data.nota.numero || '-';
                document.getElementById('notaTitulo').textContent = data.nota.titulo || '-';
                document.getElementById('notaCriadoPor').textContent = data.nota.criado_por || '-';
                
                // Atualizar status com badge
                const statusElement = document.getElementById('notaStatus');
                const statusClass = getStatusBadgeClass(data.nota.status);
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = data.nota.status_display || '-';
                
                // Preencher op√ß√µes de fun√ß√£o
                const funcaoSelect = document.getElementById('funcao_assinatura_modal');
                funcaoSelect.innerHTML = '<option value="">Selecione uma fun√ß√£o...</option>';
                data.funcoes_usuario.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.nome;
                    option.textContent = funcao.nome;
                    if (funcao.ativo) {
                        option.selected = true;
                    }
                    funcaoSelect.appendChild(option);
                });
                
                // Limpar campos do formul√°rio
                document.getElementById('observacoes_modal').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAssinarRevisao'));
                modal.show();
            } else {
                mostrarModalErro('Erro', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota. Tente novamente.');
        });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'RASCUNHO': return 'bg-secondary';
        case 'REVISADA': return 'bg-info';
        case 'APROVADA': return 'bg-success';
        case 'EDITADA': return 'bg-warning';
        case 'PUBLICADA': return 'bg-primary';
        default: return 'bg-light text-dark';
    }
}

function assinarAprovacao(notaId) {
    // Buscar dados da nota via AJAX
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informa√ß√µes da nota no modal
                document.getElementById('notaIdAprovacao').value = notaId;
                document.getElementById('notaNumeroAprovacao').textContent = data.nota.numero || '-';
                document.getElementById('notaTituloAprovacao').textContent = data.nota.titulo || '-';
                document.getElementById('notaCriadoPorAprovacao').textContent = data.nota.criado_por || '-';
                
                // Atualizar status com badge
                const statusElement = document.getElementById('notaStatusAprovacao');
                const statusClass = getStatusBadgeClass(data.nota.status);
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = data.nota.status_display || '-';
                
                // Preencher op√ß√µes de fun√ß√£o
                const funcaoSelect = document.getElementById('funcao_assinatura_modal_aprovacao');
                funcaoSelect.innerHTML = '<option value="">Selecione uma fun√ß√£o...</option>';
                data.funcoes_usuario.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.nome;
                    option.textContent = funcao.nome;
                    if (funcao.ativo) {
                        option.selected = true;
                    }
                    funcaoSelect.appendChild(option);
                });
                
                // Limpar campos do formul√°rio
                document.getElementById('observacoes_modal_aprovacao').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAssinarAprovacao'));
                modal.show();
            } else {
                mostrarModalErro('Erro', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota. Tente novamente.');
        });
}

function assinarEdicao(notaId) {
    // Buscar dados da nota via AJAX
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informa√ß√µes da nota no modal
                document.getElementById('notaIdEdicao').value = notaId;
                document.getElementById('notaNumeroEdicao').textContent = data.nota.numero || '-';
                document.getElementById('notaTituloEdicao').textContent = data.nota.titulo || '-';
                document.getElementById('notaCriadoPorEdicao').textContent = data.nota.criado_por || '-';
                
                // Atualizar status com badge
                const statusElement = document.getElementById('notaStatusEdicao');
                const statusClass = getStatusBadgeClass(data.nota.status);
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = data.nota.status_display || '-';
                
                // Preencher op√ß√µes de fun√ß√£o
                const funcaoSelect = document.getElementById('funcao_assinatura_modal_edicao');
                funcaoSelect.innerHTML = '<option value="">Selecione uma fun√ß√£o...</option>';
                data.funcoes_usuario.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.nome;
                    option.textContent = funcao.nome;
                    if (funcao.ativo) {
                        option.selected = true;
                    }
                    funcaoSelect.appendChild(option);
                });
                
                // Limpar campos do formul√°rio
                document.getElementById('observacoes_modal_edicao').value = '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalAssinarEdicao'));
                modal.show();
            } else {
                mostrarModalErro('Erro', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota. Tente novamente.');
        });
}

function abrirModalEdicao(notaId) {
    console.log('Abrindo modal de edi√ß√£o para nota ID:', notaId);
    console.log('Tipo do notaId:', typeof notaId);
    
    // Verificar se o modal existe
    const modal = document.getElementById('novaNotaModal');
    console.log('Modal encontrado:', modal);
    
    if (!modal) {
        console.error('Modal novaNotaModal n√£o encontrado');
        mostrarModalErro('Erro de Interface', 'Erro: Modal n√£o encontrado');
        return;
    }
    
    // Salvar conte√∫do original do modal se ainda n√£o foi salvo
    if (!window.originalModalContent) {
        const modalBody = document.querySelector('#novaNotaModal .modal-body');
        console.log('Modal body encontrado:', modalBody);
        if (modalBody) {
            window.originalModalContent = modalBody.innerHTML;
            console.log('Conte√∫do original do modal salvo');
            } else {
            console.error('Modal body n√£o encontrado');
        }
    }
    
    // Mostrar loading no modal se existir
    const modalElement = document.getElementById('novaNotaModal');
    if (modalElement) {
        const modalBody = modalElement.querySelector('.modal-body');
        if (modalBody) {
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando dados da nota...</p></div>';
        }
    }
    
    // Buscar dados da nota via AJAX
    console.log('üì§ Fazendo requisi√ß√£o AJAX para:', `/militares/ajax/nota-detail/${notaId}/`);
    
    fetch(`/militares/ajax/nota-detail/${notaId}/`)
        .then(response => {
            console.log('Resposta AJAX recebida:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                console.error('Erro na resposta:', response.status, response.statusText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            if (data.success) {
                // Restaurar conte√∫do original do modal
                const modalBody = document.querySelector('#novaNotaModal .modal-body');
                if (modalBody && window.originalModalContent) {
                    modalBody.innerHTML = window.originalModalContent;
                }
                
                       // Aguardar um pouco para o DOM ser atualizado
                       setTimeout(() => {
                           // Definir ID da nota atual para anexos (vari√°vel global)
                           window.notaIdAtual = notaId;
                           console.log('üîç notaIdAtual definida como:', window.notaIdAtual);
                
                // Carregar conte√∫do da nota no editor
                           const editorContent = document.getElementById('editor-content');
                           if (editorContent) {
                               editorContent.innerHTML = data.nota.conteudo || '';
                // Sincronizar conte√∫do do editor com o textarea hidden
                               const conteudoField = document.getElementById('conteudo');
                               if (conteudoField) {
                                   conteudoField.value = editorContent.innerHTML;
                               }
                           }
                           
                           // Carregar anexos da nota
                           if (typeof carregarAnexos === 'function') {
                               carregarAnexos(notaId);
                           }
                    
                    // Preencher campos do formul√°rio
                    const tituloField = document.getElementById('titulo');
                    const origemField = document.getElementById('origem_publicacao');
                    const tipoField = document.getElementById('tipo_publicacao');
                    const topicosField = document.getElementById('topicos');
                    
                    if (tituloField) tituloField.value = data.nota.titulo || '';
                    if (origemField) origemField.value = data.nota.origem_publicacao || '';
                    if (tipoField) tipoField.value = data.nota.tipo_publicacao || '';
                    if (topicosField) topicosField.value = data.nota.topicos || '';
                
                // Alterar o t√≠tulo do modal para 'Editar Nota'
                    const modalLabel = document.getElementById('novaNotaModalLabel');
                    if (modalLabel) {
                        modalLabel.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Nota';
                    }
                    
                    // Alterar o bot√£o de salvar - usar o ID correto
                    const btnSalvar = document.getElementById('salvarNota');
                    console.log('Bot√£o encontrado por ID:', btnSalvar);
                    console.log('ID do bot√£o:', btnSalvar ? btnSalvar.id : 'n√£o encontrado');
                    
                    if (btnSalvar) {
                btnSalvar.innerHTML = '<i class="fas fa-save me-1"></i>Salvar Altera√ß√µes';
                        btnSalvar.setAttribute('data-edit-mode', 'true');
                        btnSalvar.setAttribute('data-nota-id', notaId);
                        console.log('Bot√£o configurado com atributos de edi√ß√£o - ID:', notaId);
                        console.log('Atributos configurados:', {
                            editMode: btnSalvar.getAttribute('data-edit-mode'),
                            notaId: btnSalvar.getAttribute('data-nota-id')
                        });
                    } else {
                        console.error('Bot√£o salvarNota n√£o encontrado no modal');
                    }
                
                // Configurar o formul√°rio para edi√ß√£o
                    const form = document.getElementById('notaForm'); // Corrigir ID do formul√°rio
                    console.log('Procurando formul√°rio notaForm:', form);
                    
                    if (form) {
                        // Adicionar event listener ao formul√°rio
                        form.addEventListener('submit', function(e) {
                    e.preventDefault();
                            console.log('üîß Formul√°rio submetido em modo de edi√ß√£o');
                    salvarEdicaoNota(notaId);
                });
                        
                        console.log('Event listener adicionado ao formul√°rio');
            } else {
                        console.error('Formul√°rio notaForm n√£o encontrado ap√≥s restaura√ß√£o');
                    }
                }, 100);
                
                // Mostrar o modal
                console.log('Abrindo modal de edi√ß√£o');
                const modalElement = document.getElementById('novaNotaModal');
                console.log('Elemento do modal:', modalElement);
                
                if (modalElement) {
                    const modalInstance = new bootstrap.Modal(modalElement);
                    console.log('Inst√¢ncia do modal criada:', modalInstance);
                    modalInstance.show();
                    console.log('Modal mostrado com sucesso');
                } else {
                    console.error('Elemento do modal n√£o encontrado para mostrar');
                }
            } else {
                console.error('Erro nos dados:', data.error);
                // Restaurar conte√∫do original do modal
                const modalBody = document.querySelector('#novaNotaModal .modal-body');
                if (modalBody && window.originalModalContent) {
                    modalBody.innerHTML = window.originalModalContent;
                }
                mostrarModalErro('Erro ao Carregar', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro na requisi√ß√£o:', error);
            // Restaurar conte√∫do original do modal
            const modalBody = document.querySelector('#novaNotaModal .modal-body');
            if (modalBody && window.originalModalContent) {
                modalBody.innerHTML = window.originalModalContent;
            }
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota: ' + error.message);
        });
}

function salvarEdicaoNota(notaId) {
    console.log('üîß Iniciando edi√ß√£o da nota ID:', notaId);
    
    // Coletar dados do formul√°rio
    const tituloElement = document.getElementById('titulo');
    const origemElement = document.getElementById('origem_publicacao');
    const tipoElement = document.getElementById('tipo_publicacao');
    const topicosElement = document.getElementById('topicos');
    const conteudoElement = document.getElementById('editor-content');
    
    if (!tituloElement || !origemElement || !tipoElement || !topicosElement || !conteudoElement) {
        console.error('Elementos do formul√°rio n√£o encontrados');
        mostrarModalErro('Erro de Formul√°rio', 'Elementos do formul√°rio n√£o foram encontrados. Recarregue a p√°gina e tente novamente.');
        return;
    }
    
    const titulo = tituloElement.value;
    const origem = origemElement.value;
    const tipo = tipoElement.value;
    const topicos = topicosElement.value;
    const conteudo = conteudoElement.innerHTML;
    
    console.log('üìù Dados coletados:');
    console.log('  - T√≠tulo:', titulo);
    console.log('  - Origem:', origem);
    console.log('  - Tipo:', tipo);
    console.log('  - T√≥picos:', topicos);
    console.log('  - Conte√∫do (primeiros 100 chars):', conteudo.substring(0, 100) + '...');
    
    const formData = new FormData();
    formData.append('titulo', titulo);
    formData.append('origem_publicacao', origem);
    formData.append('tipo_publicacao', tipo);
    formData.append('topicos', topicos);
    formData.append('conteudo', conteudo);
    
    console.log('üì§ Enviando dados para edi√ß√£o...');
    
    // Verificar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token n√£o encontrado');
        mostrarModalErro('Erro de Seguran√ßa', 'Token de seguran√ßa n√£o encontrado. Recarregue a p√°gina e tente novamente.');
        return;
    }
    
    console.log('üîê CSRF token encontrado:', csrfToken.value.substring(0, 10) + '...');
    
    // Enviar dados
    fetch(`/militares/notas/${notaId}/editar-ajax/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken.value,
        },
        body: formData
    })
    .then(response => {
        console.log('Resposta recebida:', response.status);
        console.log('Headers da resposta:', response.headers);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text().then(text => {
            console.log('üìÑ Resposta bruta:', text);
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('Erro ao fazer parse do JSON:', e);
                console.error('Texto recebido:', text);
                throw new Error('Resposta n√£o √© um JSON v√°lido');
            }
        });
    })
    .then(data => {
        console.log('Dados da resposta:', data);
        if (data.success) {
            console.log('Nota atualizada com sucesso!');
            
            // Mostrar modal de sucesso
            console.log('Tentando mostrar modal de sucesso...');
            if (typeof mostrarModalSucesso === 'function') {
                mostrarModalSucesso('Nota Atualizada!', 'A nota foi atualizada com sucesso no sistema.');
                console.log('Modal de sucesso chamado');
            } else {
                console.error('Fun√ß√£o mostrarModalSucesso n√£o encontrada');
            mostrarModalSucesso('Nota Atualizada!', 'A nota foi atualizada com sucesso!');
            }
            
            // Fechar modal de forma segura
            const modalElement = document.getElementById('novaNotaModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    // Remover foco de todos os elementos antes de fechar
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.blur) {
                        activeElement.blur();
                    }
                    
                    // Aguardar um pouco antes de fechar
                    setTimeout(() => {
            modal.hide();
                    }, 100);
                }
            }
            
            // Restaurar t√≠tulo e bot√£o do modal
            const modalLabel = document.getElementById('novaNotaModalLabel');
            if (modalLabel) {
                modalLabel.innerHTML = '<i class="fas fa-plus me-2"></i>Nova Nota';
            }
            
            const btnSalvar = document.querySelector('#novaNotaModal .btn-primary');
            if (btnSalvar) {
            btnSalvar.innerHTML = '<i class="fas fa-save me-1"></i>Salvar Nota';
                btnSalvar.removeAttribute('data-edit-mode');
                btnSalvar.removeAttribute('data-nota-id');
            }
            
            // Recarregar p√°gina ap√≥s um pequeno delay
            setTimeout(() => {
            location.reload();
            }, 2000);
        } else {
            console.error('Erro ao atualizar nota:', data.error);
            if (typeof mostrarModalErro === 'function') {
                mostrarModalErro('Erro ao Atualizar', 'N√£o foi poss√≠vel atualizar a nota: ' + data.error);
        } else {
            mostrarModalErro('Erro ao Atualizar', 'Erro ao atualizar nota: ' + data.error);
            }
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        console.error('Stack trace:', error.stack);
        console.error('Tipo do erro:', typeof error);
        console.error('Mensagem do erro:', error.message);
        
        if (typeof mostrarModalErro === 'function') {
            mostrarModalErro('Erro de Conex√£o', `Erro ao atualizar nota: ${error.message}. Verifique o console para mais detalhes.`);
        } else {
            mostrarModalErro('Erro de Conex√£o', `Erro ao atualizar nota: ${error.message}. Verifique o console para mais detalhes.`);
        }
    });
}


// ==================== PESQUISA AVAN√áADA ROBUSTA ====================

// Valida√ß√£o simplificada para pesquisa por origem
document.addEventListener('DOMContentLoaded', function() {
    const formPesquisa = document.getElementById('formPesquisaAvancada');
    if (formPesquisa) {
        formPesquisa.addEventListener('submit', function(e) {
            // Valida√ß√£o b√°sica - apenas verificar se o formul√°rio est√° sendo enviado
            console.log('Pesquisa por origem enviada');
        });
    }
    
    // Configurar eventos dos bot√µes de confirma√ß√£o de assinatura
    // Contar notas devolvidas para exibir no alerta
    contarNotasDevolvidas();
    const btnConfirmarAssinatura = document.getElementById('btnConfirmarAssinatura');
    if (btnConfirmarAssinatura) {
        btnConfirmarAssinatura.addEventListener('click', function() {
            confirmarAssinaturaRevisao();
        });
    }
    
    const btnConfirmarAprovacao = document.getElementById('btnConfirmarAssinaturaAprovacao');
    if (btnConfirmarAprovacao) {
        btnConfirmarAprovacao.addEventListener('click', function() {
            confirmarAssinaturaAprovacao();
        });
    }
    
    const btnConfirmarEdicao = document.getElementById('btnConfirmarAssinaturaEdicao');
    if (btnConfirmarEdicao) {
        btnConfirmarEdicao.addEventListener('click', function() {
            confirmarAssinaturaEdicao();
        });
    }
    
    const btnConfirmarDevolucao = document.getElementById('btnConfirmarDevolucao');
    if (btnConfirmarDevolucao) {
        btnConfirmarDevolucao.addEventListener('click', function() {
            confirmarDevolucaoNota();
        });
    }
    
    // Limpar modal quando fechado
    const modalAssinarRevisao = document.getElementById('modalAssinarRevisao');
    if (modalAssinarRevisao) {
        modalAssinarRevisao.addEventListener('hidden.bs.modal', function() {
            // Limpar campos do formul√°rio
            document.getElementById('formAssinaturaRevisao').reset();
            document.getElementById('notaId').value = '';
            document.getElementById('notaNumero').textContent = '-';
            document.getElementById('notaTitulo').textContent = '-';
            document.getElementById('notaStatus').textContent = '-';
            document.getElementById('notaCriadoPor').textContent = '-';
            document.getElementById('funcao_assinatura_modal').innerHTML = '<option value="">Selecione uma fun√ß√£o...</option>';
        });
    }
    
    // Limpar modal de devolu√ß√£o quando fechado
    const modalDevolverNota = document.getElementById('modalDevolverNota');
    if (modalDevolverNota) {
        modalDevolverNota.addEventListener('hidden.bs.modal', function() {
            // Limpar campo de motivo
            document.getElementById('motivo_devolucao').value = '';
        });
    }
});

// Fun√ß√£o para limpar pesquisa avan√ßada (redireciona para a p√°gina sem par√¢metros)
function limparPesquisaAvancada() {
    // Redirecionar para a p√°gina sem par√¢metros de pesquisa
    window.location.href = window.location.pathname;
}

// ==================== BUSCA R√ÅPIDA NO DROPDOWN ====================

// Implementar busca r√°pida no dropdown de origem
document.addEventListener('DOMContentLoaded', function() {
    const dropdownOrigem = document.getElementById('pesquisa_origem_dropdown');
    
    if (dropdownOrigem) {
        let ultimaTecla = '';
        let tempoUltimaTecla = 0;
        
        dropdownOrigem.addEventListener('keydown', function(e) {
            const agora = Date.now();
            const tecla = e.key.toLowerCase();
            
            // Se a tecla for a mesma da anterior e passou menos de 1 segundo, concatenar
            if (tecla === ultimaTecla && (agora - tempoUltimaTecla) < 1000) {
                ultimaTecla += tecla;
            } else {
                ultimaTecla = tecla;
            }
            
            tempoUltimaTecla = agora;
            
            // Ignorar teclas especiais
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter' || e.key === 'Escape' || e.key === 'Tab') {
                return;
            }
            
            // Buscar op√ß√£o que come√ßa com a sequ√™ncia digitada
            const opcoes = Array.from(dropdownOrigem.options);
            let opcaoEncontrada = null;
            
            for (let i = 0; i < opcoes.length; i++) {
                const texto = opcoes[i].textContent.toLowerCase();
                if (texto.startsWith(ultimaTecla)) {
                    opcaoEncontrada = opcoes[i];
                    break;
                }
            }
            
            if (opcaoEncontrada) {
                dropdownOrigem.value = opcaoEncontrada.value;
                dropdownOrigem.focus();
                
                // Destacar visualmente a op√ß√£o encontrada
                opcaoEncontrada.style.backgroundColor = '#e3f2fd';
                setTimeout(() => {
                    opcaoEncontrada.style.backgroundColor = '';
                }, 500);
            }
        });
        
        // Limpar busca quando o dropdown perde o foco
        dropdownOrigem.addEventListener('blur', function() {
            ultimaTecla = '';
        });
    }
});

// ==================== FUN√á√ïES PARA LIMPAR FILTROS INDIVIDUAIS ====================


// Fun√ß√£o para limpar filtro de origem
function limparFiltroOrigem() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_origem_dropdown');
    window.location.href = url.toString();
}


// Fun√ß√£o para limpar todos os filtros
function limparTodosFiltros() {
    window.location.href = window.location.pathname;
}

// Fun√ß√£o para limpar pesquisa avan√ßada
function limparPesquisaAvancada() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_origem_dropdown');
    url.searchParams.delete('pesquisa_titulo');
    url.searchParams.delete('pesquisa_numero');
    url.searchParams.delete('pesquisa_data_inicial');
    url.searchParams.delete('pesquisa_data_final');
    url.searchParams.delete('pesquisa_status');
    window.location.href = url.toString();
}

// Fun√ß√µes para limpar filtros individuais
function limparFiltroTitulo() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_titulo');
    window.location.href = url.toString();
}


function limparFiltroNumero() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_numero');
    window.location.href = url.toString();
}

function limparFiltroDataInicial() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_data_inicial');
    window.location.href = url.toString();
}

function limparFiltroDataFinal() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_data_final');
    window.location.href = url.toString();
}

function limparFiltroStatus() {
    const url = new URL(window.location);
    url.searchParams.delete('pesquisa_status');
    window.location.href = url.toString();
}





// ==================== FILTRO HIER√ÅRQUICO √öNICO ====================



// Fun√ß√µes do Editor Personalizado para Edi√ß√£o
function execCommandEdicao(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('editor-content-edicao').focus();
}

function formatTextEdicao(command, value) {
    if (value) {
        document.execCommand(command, false, value);
    }
    document.getElementById('editor-content-edicao').focus();
}

// Sincronizar conte√∫do do editor de edi√ß√£o com o textarea hidden
function syncEditorContentEdicao() {
    const editorContent = document.getElementById('editor-content-edicao').innerHTML;
    document.getElementById('editar_conteudo').value = editorContent;
}

// Inicializar editor personalizado para edi√ß√£o
function inicializarEditorEdicao() {
    const editorContent = document.getElementById('editor-content-edicao');
    
    // Adicionar evento de input para sincronizar
    editorContent.addEventListener('input', syncEditorContentEdicao);
    
    // Adicionar evento de paste para limpar formata√ß√£o desnecess√°ria
    editorContent.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
    });
    
    console.log('Editor personalizado de edi√ß√£o inicializado');
}

// Fun√ß√£o para salvar modelo (edi√ß√£o)
function salvarModeloEdicao() {
    const conteudo = document.getElementById('editor-content-edicao').innerHTML;
    
    if (!conteudo.trim()) {
        mostrarModalErro('Editor Vazio', 'O editor est√° vazio. Digite algum conte√∫do antes de salvar o modelo.');
        return;
    }
    
    // Mostrar preview do conte√∫do
    document.getElementById('previewModeloEdicao').innerHTML = conteudo;
    
    // Abrir modal de salvar
    const modal = new bootstrap.Modal(document.getElementById('salvarModeloEdicaoModal'));
    modal.show();
}

// Fun√ß√£o para confirmar salvamento do modelo (edi√ß√£o)
function confirmarSalvarModeloEdicao() {
    const nome = document.getElementById('nomeModeloEdicao').value.trim();
    const descricao = document.getElementById('descricaoModeloEdicao').value.trim();
    const conteudo = document.getElementById('editor-content-edicao').innerHTML;
    
    if (!nome) {
        mostrarModalErro('Nome Obrigat√≥rio', 'Por favor, digite um nome para o modelo.');
        return;
    }
    
    // Salvar no localStorage
    const modelo = {
        id: Date.now(),
        nome: nome,
        descricao: descricao,
        conteudo: conteudo,
        dataCriacao: new Date().toLocaleString('pt-BR'),
        autor: '{{ user.get_full_name|default:user.username }}'
    };
    
    // Obter modelos existentes
    let modelos = JSON.parse(localStorage.getItem('modelosNotas') || '[]');
    
    // Verificar se j√° existe modelo com mesmo nome
    const modeloExistente = modelos.find(m => m.nome.toLowerCase() === nome.toLowerCase());
    if (modeloExistente) {
        mostrarModalConfirmacao(
            'Modelo Existente',
            `J√° existe um modelo com o nome "${nome}". Deseja substitu√≠-lo?`,
            function() {
                // Remover modelo existente
                modelos = modelos.filter(m => m.nome.toLowerCase() !== nome.toLowerCase());
                // Adicionar novo modelo
                modelos.push(modelo);
                // Salvar no localStorage
                localStorage.setItem('modelosNotas', JSON.stringify(modelos));
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('salvarModeloEdicaoModal')).hide();
                mostrarModalSucesso('Modelo Salvo!', 'O modelo foi salvo com sucesso!');
            }
        );
        return;
    }
    
    // Adicionar novo modelo
    modelos.push(modelo);
    
    // Salvar no localStorage
    localStorage.setItem('modelosNotas', JSON.stringify(modelos));
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('salvarModeloEdicaoModal')).hide();
    
    // Limpar formul√°rio
    document.getElementById('formSalvarModeloEdicao').reset();
    
    mostrarModalSucesso('Modelo Salvo!', 'O modelo foi salvo com sucesso!');
}

// Fun√ß√£o para carregar modelo (edi√ß√£o)
function carregarModeloEdicao() {
    // Carregar modelos do localStorage
    const modelos = JSON.parse(localStorage.getItem('modelosNotas') || '[]');
    
    if (modelos.length === 0) {
        mostrarModalErro('Nenhum Modelo', 'Nenhum modelo salvo encontrado.');
        return;
    }
    
    // Exibir modelos
    exibirModelosEdicao(modelos);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('carregarModeloEdicaoModal'));
    modal.show();
}

// Fun√ß√£o para exibir modelos (edi√ß√£o)
function exibirModelosEdicao(modelos) {
    const container = document.getElementById('listaModelosEdicao');
    
    if (modelos.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted">Nenhum modelo encontrado.</div>';
        return;
    }
    
    container.innerHTML = modelos.map(modelo => `
        <div class="col-md-6 mb-3 modelo-item" data-nome="${modelo.nome.toLowerCase()}">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        ${modelo.nome}
                    </h6>
                    <p class="card-text text-muted small">
                        ${modelo.descricao || 'Sem descri√ß√£o'}
                    </p>
                    <div class="text-muted small">
                        <i class="fas fa-user me-1"></i> ${modelo.autor}<br>
                        <i class="fas fa-calendar me-1"></i> ${modelo.dataCriacao}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-sm btn-primary" onclick="aplicarModeloEdicao(${modelo.id})">
                            <i class="fas fa-check me-1"></i>
                            Usar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirModeloEdicao(${modelo.id})">
                            <i class="fas fa-trash me-1"></i>
                            Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Fun√ß√£o para filtrar modelos (edi√ß√£o)
function filtrarModelosEdicao() {
    const termo = document.getElementById('buscarModeloEdicao').value.toLowerCase();
    const itens = document.querySelectorAll('#listaModelosEdicao .modelo-item');
    
    itens.forEach(item => {
        const nome = item.getAttribute('data-nome');
        if (nome.includes(termo)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Fun√ß√£o para aplicar modelo (edi√ß√£o)
function aplicarModeloEdicao(modeloId) {
    const modelos = JSON.parse(localStorage.getItem('modelosNotas') || '[]');
    const modelo = modelos.find(m => m.id === modeloId);
    
    if (modelo) {
        // Aplicar conte√∫do ao editor
        document.getElementById('editor-content-edicao').innerHTML = modelo.conteudo;
        
        // Sincronizar com textarea hidden
        syncEditorContentEdicao();
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('carregarModeloEdicaoModal')).hide();
        
        mostrarModalSucesso('Modelo Carregado!', `O modelo "${modelo.nome}" foi carregado com sucesso!`);
    }
}

// Fun√ß√£o para excluir modelo (edi√ß√£o)
function excluirModeloEdicao(modeloId) {
    mostrarModalConfirmacao(
        'Confirmar Exclus√£o',
        'Tem certeza que deseja excluir este modelo?',
        function() {
            const modelos = JSON.parse(localStorage.getItem('modelosNotas') || '[]');
            const modelosAtualizados = modelos.filter(m => m.id !== modeloId);
            
            localStorage.setItem('modelosNotas', JSON.stringify(modelosAtualizados));
            
            // Recarregar lista
            exibirModelosEdicao(modelosAtualizados);
            
            mostrarModalSucesso('Modelo Exclu√≠do!', 'O modelo foi exclu√≠do com sucesso!');
        }
    );
}

// Fun√ß√£o para limpar editor (edi√ß√£o)
function limparEditorEdicao() {
    mostrarModalConfirmacao(
        'Confirmar Limpeza',
        'Tem certeza que deseja limpar todo o conte√∫do do editor?',
        function() {
            document.getElementById('editor-content-edicao').innerHTML = '';
            syncEditorContentEdicao();
        }
    );
}


// Fun√ß√£o para abrir modal de exclus√£o
function abrirModalExclusao(notaId, tituloNota) {
    console.log('üóëÔ∏è Abrindo modal de exclus√£o para nota ID:', notaId, 'T√≠tulo:', tituloNota);
    
    // Preencher informa√ß√µes da nota no modal
    const tituloElement = document.getElementById('notaTituloExclusao');
    const detalhesElement = document.getElementById('notaDetalhesExclusao');
    
    if (tituloElement) {
        tituloElement.textContent = tituloNota;
        console.log('T√≠tulo preenchido:', tituloNota);
    } else {
        console.error('Elemento notaTituloExclusao n√£o encontrado');
    }
    
    if (detalhesElement) {
        detalhesElement.textContent = `ID: ${notaId}`;
        console.log('Detalhes preenchidos: ID', notaId);
    } else {
        console.error('Elemento notaDetalhesExclusao n√£o encontrado');
    }
    
    // Mostrar modal
    const modalElement = document.getElementById('excluirNotaModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Modal de exclus√£o aberto');
    } else {
        console.error('Modal excluirNotaModal n√£o encontrado');
    }
    
    // Configurar evento do bot√£o de confirma√ß√£o
    const btnConfirmar = document.getElementById('confirmarExclusaoBtn');
    if (btnConfirmar) {
        btnConfirmar.onclick = function() {
            console.log('Bot√£o de confirma√ß√£o clicado, excluindo nota ID:', notaId);
            excluirNota(notaId);
        };
        console.log('Evento do bot√£o de confirma√ß√£o configurado');
    } else {
        console.error('Bot√£o confirmarExclusaoBtn n√£o encontrado');
    }
}

// Fun√ß√£o para excluir nota
function excluirNota(notaId) {
    // Mostrar loading no bot√£o
    const btnExcluir = document.getElementById('confirmarExclusaoBtn');
    const textoOriginal = btnExcluir.innerHTML;
    btnExcluir.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Excluindo...';
    btnExcluir.disabled = true;
    
    // Fazer requisi√ß√£o de exclus√£o
    fetch(`/militares/notas/${notaId}/excluir/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('excluirNotaModal'));
            modal.hide();
            
            // Mostrar modal de sucesso
            mostrarModalSucesso('Nota Exclu√≠da!', data.message || 'A nota foi permanentemente removida do sistema.');
            
            // Recarregar p√°gina ap√≥s um pequeno delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('Erro detalhado:', error);
        
        // Restaurar bot√£o
        btnExcluir.innerHTML = textoOriginal;
        btnExcluir.disabled = false;
        
        // Mostrar modal de erro com mais detalhes
        mostrarModalErro('Erro ao Excluir Nota', `Erro: ${error.message}. Verifique o console para mais detalhes.`);
    });
}


// Fun√ß√£o para mostrar modal de sucesso moderno
function mostrarModalSucesso(titulo, mensagem) {
    console.log('üéâ Mostrando modal de sucesso:', titulo, mensagem);
    
    // Atualizar conte√∫do do modal
    const modalLabel = document.getElementById('feedbackSucessoModalLabel');
    const modalMensagem = document.getElementById('feedbackSucessoMensagem');
    
    if (modalLabel) {
        modalLabel.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${titulo}
        `;
    } else {
        console.error('Elemento feedbackSucessoModalLabel n√£o encontrado');
    }
    
    if (modalMensagem) {
        modalMensagem.textContent = mensagem;
    } else {
        console.error('Elemento feedbackSucessoMensagem n√£o encontrado');
    }
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('feedbackSucessoModal'));
    modal.show();
    
    // Auto-fechar ap√≥s 3 segundos
    setTimeout(() => {
        const modalElement = document.getElementById('feedbackSucessoModal');
        if (modalElement) {
            // Remover foco de todos os elementos antes de fechar
            const activeElement = document.activeElement;
            if (activeElement && activeElement.blur) {
                activeElement.blur();
            }
            
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            } else {
                // Se n√£o h√° inst√¢ncia, criar uma nova e fechar
                const newModal = new bootstrap.Modal(modalElement);
                newModal.hide();
            }
        }
    }, 3000);
}

// Fun√ß√£o para mostrar modal de erro moderno
function mostrarModalErro(titulo, mensagem) {
    
    // Criar modal dinamicamente (mais confi√°vel)
    const modalHtml = `
        <div class="modal fade" id="modalErroDinamico" tabindex="-1" aria-labelledby="modalErroDinamicoLabel" aria-hidden="true" style="z-index: 1070;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-danger text-white border-0">
                        <h5 class="modal-title" id="modalErroDinamicoLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>${titulo}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <div class="fs-5">${mensagem}</div>
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const existingModal = document.getElementById('modalErroDinamico');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Adicionar novo modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalErroDinamico'));
    modal.show();
}

// Fun√ß√£o mostrarModalConfirmacao est√° definida em base.html

// Configurar eventos dos bot√µes de confirma√ß√£o de assinatura
// Mover para dentro do primeiro DOMContentLoaded para evitar duplica√ß√£o

function confirmarAssinaturaRevisao() {
    // Validar campos obrigat√≥rios
    const funcao = document.getElementById('funcao_assinatura_modal').value;
    
    if (!funcao) {
        mostrarModalErro('Campo Obrigat√≥rio', 'Por favor, selecione uma fun√ß√£o para a assinatura.');
        return;
    }
    
    // Obter dados do formul√°rio
    const formData = new FormData(document.getElementById('formAssinaturaRevisao'));
    const notaId = formData.get('nota_id');
    const observacoes = formData.get('observacoes');
    const funcaoText = document.getElementById('funcao_assinatura_modal').selectedOptions[0].text;
    
    // Criar mensagem de confirma√ß√£o
    const mensagem = `
        <div class="text-start">
            <p><strong>Fun√ß√£o:</strong> ${funcaoText}</p>
            ${observacoes ? `<p><strong>Observa√ß√µes:</strong> ${observacoes}</p>` : ''}
            <p class="text-warning mt-3">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica.
            </p>
        </div>
    `;
    
    // Mostrar modal de confirma√ß√£o
    mostrarModalConfirmacao(
        'Confirmar Assinatura Eletr√¥nica',
        mensagem,
        function() {
            // Submeter assinatura via AJAX
            submeterAssinaturaRevisao(notaId, formData);
        }
    );
}

function submeterAssinaturaRevisao(notaId, formData) {
    // Mostrar loading no bot√£o
    const btnConfirmar = document.getElementById('btnConfirmarAssinatura');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Assinando...';
    btnConfirmar.disabled = true;
    
    // Fazer requisi√ß√£o AJAX
    fetch(`/militares/notas/${notaId}/assinar-revisao/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(text => {
        try {
            const data = JSON.parse(text);
            
            if (data.success) {
                // Fechar modal usando jQuery (mais confi√°vel)
                $('#modalAssinarRevisao').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarModalSucesso('Assinatura Realizada!', 'Nota assinada como Revisor com sucesso!');
                
                // Recarregar a p√°gina para atualizar a tabela
                setTimeout(() => {
                    location.reload();
                }, 1500);
    } else {
                mostrarModalErro('Erro na Assinatura', data.error || 'Erro ao assinar nota. Tente novamente.');
            }
        } catch (e) {
            mostrarModalErro('Erro de Resposta', 'Resposta inv√°lida do servidor. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        console.error('Stack trace:', error.stack);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao assinar nota: ' + error.message);
    })
    .finally(() => {
        // Restaurar bot√£o
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
}

// Fun√ß√£o de confirma√ß√£o para assinatura de aprova√ß√£o
function confirmarAssinaturaAprovacao() {
    // Validar campos obrigat√≥rios
    const funcao = document.getElementById('funcao_assinatura_modal_aprovacao').value;
    
    if (!funcao) {
        mostrarModalErro('Campo Obrigat√≥rio', 'Por favor, selecione uma fun√ß√£o para a assinatura.');
        return;
    }
    
    // Obter dados do formul√°rio
    const formData = new FormData(document.getElementById('formAssinaturaAprovacao'));
    const notaId = formData.get('nota_id');
    const observacoes = formData.get('observacoes');
    const funcaoText = document.getElementById('funcao_assinatura_modal_aprovacao').selectedOptions[0].text;
    
    // Criar mensagem de confirma√ß√£o
    const mensagem = `
        <div class="text-start">
            <p><strong>Fun√ß√£o:</strong> ${funcaoText}</p>
            ${observacoes ? `<p><strong>Observa√ß√µes:</strong> ${observacoes}</p>` : ''}
            <p class="text-warning mt-3">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica.
            </p>
        </div>
    `;
    
    // Mostrar modal de confirma√ß√£o
    mostrarModalConfirmacao(
        'Confirmar Assinatura Eletr√¥nica',
        mensagem,
        function() {
            // Submeter assinatura via AJAX
            submeterAssinaturaAprovacao(notaId, formData);
        }
    );
}

// Fun√ß√£o de confirma√ß√£o para assinatura de edi√ß√£o
function confirmarAssinaturaEdicao() {
    // Validar campos obrigat√≥rios
    const funcao = document.getElementById('funcao_assinatura_modal_edicao').value;
    
    if (!funcao) {
        mostrarModalErro('Campo Obrigat√≥rio', 'Por favor, selecione uma fun√ß√£o para a assinatura.');
        return;
    }
    
    // Obter dados do formul√°rio
    const formData = new FormData(document.getElementById('formAssinaturaEdicao'));
    const notaId = formData.get('nota_id');
    const observacoes = formData.get('observacoes');
    const funcaoText = document.getElementById('funcao_assinatura_modal_edicao').selectedOptions[0].text;
    
    // Criar mensagem de confirma√ß√£o
    const mensagem = `
        <div class="text-start">
            <p><strong>Fun√ß√£o:</strong> ${funcaoText}</p>
            ${observacoes ? `<p><strong>Observa√ß√µes:</strong> ${observacoes}</p>` : ''}
            <p class="text-warning mt-3">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Aten√ß√£o:</strong> A assinatura eletr√¥nica tem a mesma validade de uma assinatura f√≠sica.
            </p>
        </div>
    `;
    
    // Mostrar modal de confirma√ß√£o
    mostrarModalConfirmacao(
        'Confirmar Assinatura Eletr√¥nica',
        mensagem,
        function() {
            // Submeter assinatura via AJAX
            submeterAssinaturaEdicao(notaId, formData);
        }
    );
}

// Fun√ß√£o para submeter assinatura de aprova√ß√£o
function submeterAssinaturaAprovacao(notaId, formData) {
    // Mostrar loading no bot√£o
    const btnConfirmar = document.getElementById('btnConfirmarAssinaturaAprovacao');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Assinando...';
    btnConfirmar.disabled = true;
    
    // Fazer requisi√ß√£o AJAX
    fetch(`/militares/notas/${notaId}/assinar-aprovacao/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(text => {
        try {
            const data = JSON.parse(text);
            
            if (data.success) {
                // Fechar modal usando jQuery (mais confi√°vel)
                $('#modalAssinarAprovacao').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarModalSucesso('Assinatura Realizada!', 'Nota assinada como Aprovador com sucesso!');
                
                // Recarregar a p√°gina para atualizar a tabela
                setTimeout(() => {
                    location.reload();
                }, 1500);
    } else {
                mostrarModalErro('Erro na Assinatura', data.error || 'Erro ao assinar nota. Tente novamente.');
            }
        } catch (e) {
            mostrarModalErro('Erro de Resposta', 'Resposta inv√°lida do servidor. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao assinar nota: ' + error.message);
    })
    .finally(() => {
        // Restaurar bot√£o
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
}

// Fun√ß√£o para submeter assinatura de edi√ß√£o
function submeterAssinaturaEdicao(notaId, formData) {
    // Mostrar loading no bot√£o
    const btnConfirmar = document.getElementById('btnConfirmarAssinaturaEdicao');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Assinando...';
    btnConfirmar.disabled = true;
    
    // Fazer requisi√ß√£o AJAX
    fetch(`/militares/notas/${notaId}/assinar-edicao/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(text => {
        try {
            const data = JSON.parse(text);
            
            if (data.success) {
                // Fechar modal usando jQuery (mais confi√°vel)
                $('#modalAssinarEdicao').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarModalSucesso('Assinatura Realizada!', 'Nota assinada como Editor com sucesso!');
                
                // Recarregar a p√°gina para atualizar a tabela
                setTimeout(() => {
                    location.reload();
                }, 1500);
    } else {
                mostrarModalErro('Erro na Assinatura', data.error || 'Erro ao assinar nota. Tente novamente.');
            }
        } catch (e) {
            mostrarModalErro('Erro de Resposta', 'Resposta inv√°lida do servidor. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao assinar nota: ' + error.message);
    })
    .finally(() => {
        // Restaurar bot√£o
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
}

// Fun√ß√£o de confirma√ß√£o para devolver nota
function confirmarDevolucaoNota() {
    // Validar campo obrigat√≥rio
    const motivo = document.getElementById('motivo_devolucao').value.trim();
    
    if (!motivo) {
        mostrarModalErro('Campo Obrigat√≥rio', 'Por favor, descreva o motivo da devolu√ß√£o da nota.');
        return;
    }
    
    // Obter dados do formul√°rio
    const formData = new FormData(document.getElementById('formDevolverNota'));
    const notaId = formData.get('nota_id');
    
    // Criar mensagem de confirma√ß√£o
    const mensagem = `
        <div class="text-start">
            <p><strong>Motivo da Devolu√ß√£o:</strong></p>
            <p class="text-muted">${motivo}</p>
            <p class="text-warning mt-3">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Aten√ß√£o:</strong> Esta a√ß√£o remover√° todas as assinaturas e retornar√° a nota ao status de rascunho.
            </p>
        </div>
    `;
    
    // Mostrar modal de confirma√ß√£o
    mostrarModalConfirmacao(
        'Confirmar Devolu√ß√£o da Nota',
        mensagem,
        function() {
            // Submeter devolu√ß√£o via AJAX
            submeterDevolucaoNota(notaId, formData);
        }
    );
}

// Fun√ß√£o para submeter devolu√ß√£o da nota
function submeterDevolucaoNota(notaId, formData) {
    // Mostrar loading no bot√£o
    const btnConfirmar = document.getElementById('btnConfirmarDevolucao');
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Devolvendo...';
    btnConfirmar.disabled = true;
    
    // Fazer requisi√ß√£o AJAX
    fetch(`/militares/notas/${notaId}/devolver/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(text => {
        try {
            const data = JSON.parse(text);
            
            if (data.success) {
                // Fechar modais
                $('#modalDevolverNota').modal('hide');
                $('#visualizarPublicacaoModal').modal('hide');
                
                // Mostrar mensagem de sucesso
                mostrarModalSucesso('Nota Devolvida!', 'A nota foi devolvida com sucesso! Todas as assinaturas foram removidas.');
                
                // Recarregar a p√°gina para atualizar a tabela
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarModalErro('Erro na Devolu√ß√£o', data.error || 'Erro ao devolver nota. Tente novamente.');
            }
        } catch (e) {
            mostrarModalErro('Erro de Resposta', 'Resposta inv√°lida do servidor. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao devolver nota: ' + error.message);
    })
    .finally(() => {
        // Restaurar bot√£o
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
}

// Fun√ß√£o para voltar ao modal de visualiza√ß√£o
function voltarParaVisualizacao() {
    // Fechar modal de devolu√ß√£o
    const modalDevolucao = bootstrap.Modal.getInstance(document.getElementById('modalDevolverNota'));
    if (modalDevolucao) {
        modalDevolucao.hide();
    }
    
    // Aguardar um pouco e ent√£o abrir modal de visualiza√ß√£o
    setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById('visualizarPublicacaoModal'));
        modal.show();
    }, 300);
}

// Fun√ß√£o para mostrar motivo da devolu√ß√£o
function mostrarMotivoDevolucao(notaId) {
    // Armazenar ID da nota para uso no bot√£o de edi√ß√£o
    window.notaIdMotivo = notaId;
    
    // Buscar dados da nota via AJAX
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informa√ß√µes da nota no modal
                document.getElementById('notaNumeroMotivo').textContent = data.nota.numero || '-';
                document.getElementById('notaTituloMotivo').textContent = data.nota.titulo || '-';
                document.getElementById('notaCriadoPorMotivo').textContent = data.nota.criado_por || '-';
                
                // Atualizar status com badge
                const statusElement = document.getElementById('notaStatusMotivo');
                const statusClass = getStatusBadgeClass(data.nota.status);
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = data.nota.status_display || '-';
                
                // Buscar motivo da devolu√ß√£o
                console.log('üîç Buscando motivo da devolu√ß√£o para nota ID:', notaId);
                fetch(`/militares/notas/${notaId}/dados-devolucao/`)
                    .then(response => {
                        console.log('üì° Resposta da devolu√ß√£o:', response.status);
                        return response.json();
                    })
                    .then(devolucaoData => {
                        console.log('üìä Dados da devolu√ß√£o recebidos:', devolucaoData);
                        if (devolucaoData.success) {
                            // Preencher motivo da devolu√ß√£o
                            document.getElementById('motivoDevolucaoTexto').innerHTML = `
                                <strong>Motivo:</strong> ${devolucaoData.devolucao.motivo}<br><br>
                                <small class="text-muted">
                                    <strong>Devolvido por:</strong> ${devolucaoData.devolucao.devolvido_por}<br>
                                    <strong>Data da devolu√ß√£o:</strong> ${devolucaoData.devolucao.data_devolucao}<br>
                                    <strong>Assinaturas removidas:</strong> ${devolucaoData.devolucao.assinaturas_removidas}
                                </small>
                            `;
                            console.log('‚úÖ Motivo da devolu√ß√£o carregado com sucesso');
                        } else {
                            console.log('‚ùå Erro ao carregar motivo:', devolucaoData.error);
                            document.getElementById('motivoDevolucaoTexto').textContent = 
                                'Motivo da devolu√ß√£o n√£o encontrado.';
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao buscar motivo da devolu√ß√£o:', error);
                        document.getElementById('motivoDevolucaoTexto').textContent = 
                            'Erro ao carregar motivo da devolu√ß√£o.';
                    });
    
    // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalMotivoDevolucao'));
    modal.show();
            } else {
                mostrarModalErro('Erro', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota. Tente novamente.');
        });
}

// Fun√ß√£o para ordenar notas devolvidas primeiro
function contarNotasDevolvidas() {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    let quantidadeDevolvidas = 0;
    
    rows.forEach(row => {
        const devolvidaButton = row.querySelector('button[onclick*="mostrarMotivoDevolucao"]');
        if (devolvidaButton) {
            quantidadeDevolvidas++;
            
            // Adicionar classe para destacar a linha
            row.classList.add('table-warning');
            
            // Adicionar √≠cone de prioridade
            const primeiraColuna = row.querySelector('td:first-child');
            if (primeiraColuna && !primeiraColuna.querySelector('.prioridade-devolvida')) {
                const prioridadeIcon = document.createElement('span');
                prioridadeIcon.className = 'prioridade-devolvida text-danger me-1';
                prioridadeIcon.innerHTML = '<i class="fas fa-exclamation-triangle" title="Nota devolvida - prioridade para corre√ß√£o"></i>';
                primeiraColuna.insertBefore(prioridadeIcon, primeiraColuna.firstChild);
            }
        } else {
            // Remover indicadores visuais de notas que n√£o est√£o mais devolvidas
            row.classList.remove('table-warning');
            const prioridadeIcon = row.querySelector('.prioridade-devolvida');
            if (prioridadeIcon) {
                prioridadeIcon.remove();
            }
        }
    });
    
    // Mostrar/ocultar alerta de notas devolvidas
    const alerta = document.getElementById('alertaNotasDevolvidas');
    const quantidadeSpan = document.getElementById('quantidadeNotasDevolvidas');
    
    if (quantidadeDevolvidas > 0) {
        quantidadeSpan.textContent = quantidadeDevolvidas;
        alerta.classList.remove('d-none');
    } else {
        alerta.classList.add('d-none');
    }
}

// Fun√ß√£o para mostrar anexos da nota
function mostrarAnexosNota(notaId) {
    console.log('üìé Mostrando anexos da nota ID:', notaId);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('anexosNotaModal'));
    modal.show();
    
    // Mostrar loading e esconder outros elementos
    const loadingElement = document.getElementById('anexos-loading');
    const listaElement = document.getElementById('anexos-lista-modal');
    const vaziosElement = document.getElementById('anexos-vazios');
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (listaElement) listaElement.style.display = 'none';
    if (vaziosElement) vaziosElement.style.display = 'none';
    
    // Buscar anexos via AJAX
    fetch(`/militares/notas/${notaId}/anexos/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Resposta dos anexos:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados dos anexos:', data);
        
        if (loadingElement) loadingElement.style.display = 'none';
        
        if (data.success && data.anexos && data.anexos.length > 0) {
            // Mostrar lista de anexos
            if (listaElement) {
                listaElement.style.display = 'block';
                listaElement.innerHTML = '';
                
                data.anexos.forEach(anexo => {
                    const anexoCard = document.createElement('div');
                    anexoCard.className = 'card mb-3 border-0 shadow-sm';
                    anexoCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="${anexo.icone_tipo} text-danger"></i>
                                    </div>
                                </div>
                                <div class="col">
                                    <h6 class="card-title mb-1 text-truncate" title="${anexo.nome_original}">
                                        ${anexo.nome_original}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-weight-hanging me-1"></i>${anexo.tamanho}
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-calendar me-1"></i>${anexo.data_upload}
                                    </small>
                                    ${anexo.descricao ? `<br><small class="text-info"><i class="fas fa-comment me-1"></i>${anexo.descricao}</small>` : ''}
                                    <br><small class="text-secondary"><i class="fas fa-user me-1"></i>Enviado por: ${anexo.upload_por}</small>
                                </div>
                                <div class="col-auto">
                                    <a href="${anexo.url_download}" target="_blank" class="btn btn-outline-primary btn-sm" title="Download">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
        </div>
    `;
                    listaElement.appendChild(anexoCard);
                });
            }
        } else {
            // Mostrar mensagem de anexos vazios
            if (vaziosElement) {
                vaziosElement.style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Erro ao carregar anexos:', error);
        
        if (loadingElement) loadingElement.style.display = 'none';
        
        // Mostrar erro
        if (listaElement) {
            listaElement.style.display = 'block';
            listaElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar anexos: ${error.message}
                </div>
            `;
        }
    });
}


// Fun√ß√£o removida - modal de visualiza√ß√£o substitu√≠do por p√°gina dedicada

// Fun√ß√£o para carregar assinaturas eletr√¥nicas
function carregarAssinaturas(notaId) {
    console.log('üîç Carregando assinaturas para nota ID:', notaId);
    
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => {
            console.log('üì° Resposta HTTP:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Dados completos recebidos:', data);
            console.log('üìä Assinaturas encontradas:', data.assinaturas);
            console.log('üìä Quantidade de assinaturas:', data.assinaturas ? data.assinaturas.length : 0);
            console.log('üìä Dados da nota:', data.nota);
            
            if (data.success && data.assinaturas && data.assinaturas.length > 0) {
                console.log('‚úÖ Exibindo assinaturas');
                exibirAssinaturas(data.assinaturas, data.nota);
            } else {
                console.log('‚ÑπÔ∏è Nenhuma assinatura encontrada ou dados inv√°lidos');
                console.log('‚ÑπÔ∏è Success:', data.success);
                console.log('‚ÑπÔ∏è Assinaturas:', data.assinaturas);
                exibirAssinaturas([], data.nota);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar assinaturas:', error);
            exibirAssinaturas([]);
        });
}

// Fun√ß√£o para exibir assinaturas no modal (estilo igual aos quadros de acesso e fixa√ß√£o)
function exibirAssinaturas(assinaturas, dadosNota = null) {
    console.log('üé® Exibindo assinaturas:', assinaturas);
    console.log('üé® Quantidade de assinaturas:', assinaturas.length);
    console.log('üé® Dados da nota:', dadosNota);
    
    const assinaturasSection = document.getElementById('visualizar_assinaturas');
    const listaAssinaturas = document.getElementById('visualizar_lista_assinaturas');
    
    if (!assinaturasSection || !listaAssinaturas) {
        console.error('‚ùå Elementos de assinaturas n√£o encontrados');
        console.error('‚ùå assinaturasSection:', assinaturasSection);
        console.error('‚ùå listaAssinaturas:', listaAssinaturas);
        return;
    }
    
    console.log('‚úÖ Elementos encontrados, processando assinaturas...');
    
    if (assinaturas.length > 0) {
        console.log('‚úÖ Exibindo', assinaturas.length, 'assinaturas');
        
        // Mostrar se√ß√£o de assinaturas
        assinaturasSection.style.display = 'block';
        
        // Gerar HTML das assinaturas no estilo dos quadros (igual ao quadro_acesso_visualizar.html)
        let assinaturasHtml = '<div class="mt-3">';
        
        assinaturas.forEach((assinatura, index) => {
            console.log(`üé® Processando assinatura ${index + 1}:`, assinatura);
            
            // Formatar data e hora no padr√£o brasileiro
            const dataFormatada = formatarDataHora(assinatura.data_assinatura);
            const [data, hora] = dataFormatada.split(' ');
            
            assinaturasHtml += `
                <div style="display: flex; align-items: flex-start; border: 1px solid #888; border-radius: 6px; margin-bottom: 10px; background: #fafafa;">
                    <div style="padding: 8px;">
                        <img src="/static/assinasyspro.png" width="100" height="70" alt="Logo AssinaSysPro" style="background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="padding: 8px; font-size: 15px; text-align: justify; display: flex; align-items: center; justify-content: space-between;">
                            <div style="flex-grow: 1;">
                                Documento assinado eletronicamente por <b>${assinatura.assinado_por}</b>, em ${data} ${hora}, conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Adicionar identificador de documento com QR Code se dispon√≠vel
        if (dadosNota && dadosNota.codigo_verificador && dadosNota.codigo_crc) {
            console.log('üîç Adicionando identificador de documento com QR Code');
            
            // Gerar URL de verifica√ß√£o
            const urlVerificacao = window.location.origin + '/militares/verificar-autenticidade/';
            
            // Gerar QR Code usando API externa (QR Server)
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(urlVerificacao)}`;
            
            assinaturasHtml += `
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
                    <h6 style="margin-bottom: 15px; color: #495057;">
                        <i class="fas fa-shield-alt me-2"></i>
                        Identificador de Documento
                    </h6>
                    
                    <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                        <!-- QR Code -->
                        <div style="flex-shrink: 0;">
                            <img src="${qrCodeUrl}" 
                                 alt="QR Code para verifica√ß√£o" 
                                 style="width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        </div>
                        
                        <!-- Informa√ß√µes de verifica√ß√£o -->
                        <div style="flex-grow: 1; min-width: 200px;">
                            <div style="margin-bottom: 10px;">
                                <strong>C√≥digo Verificador:</strong> 
                                <span style="font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">${dadosNota.codigo_verificador}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>C√≥digo CRC:</strong> 
                                <span style="font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">${dadosNota.codigo_crc}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Link de Verifica√ß√£o:</strong><br>
                                <a href="${urlVerificacao}" target="_blank" style="font-size: 12px; color: #007bff; text-decoration: none;">
                                    ${urlVerificacao}
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 0 4px 4px 0;">
                        <p style="margin: 0; font-size: 12px; color: #1976d2;">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Como verificar:</strong> Escaneie o QR Code ou acesse o link acima e informe os c√≥digos para confirmar a autenticidade deste documento.
                        </p>
                    </div>
                </div>
            `;
        }
        
        assinaturasHtml += '</div>';
        console.log('üé® HTML gerado:', assinaturasHtml);
        listaAssinaturas.innerHTML = assinaturasHtml;
        
    } else {
        console.log('‚ÑπÔ∏è Nenhuma assinatura para exibir');
        
        // Mostrar mensagem quando n√£o h√° assinaturas
        assinaturasSection.style.display = 'block';
        listaAssinaturas.innerHTML = `
            <div class="mt-3">
                <p class="text-muted">Nenhuma assinatura eletr√¥nica registrada.</p>
            </div>
        `;
    }
}


// Fun√ß√£o para formatar data e hora
function formatarDataHora(dataString) {
    const data = new Date(dataString);
    const dia = data.getDate().toString().padStart(2, '0');
    const mes = (data.getMonth() + 1).toString().padStart(2, '0');
    const ano = data.getFullYear();
    const hora = data.getHours().toString().padStart(2, '0');
    const minuto = data.getMinutes().toString().padStart(2, '0');
    const segundo = data.getSeconds().toString().padStart(2, '0');
    
    return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
}



// Fun√ß√£o para obter classe CSS do badge baseada no status
function getStatusBadgeClass(status) {
    const statusClasses = {
        'RASCUNHO': 'bg-secondary',
        'REVISADA': 'bg-info',
        'APROVADA': 'bg-warning',
        'EDITADA': 'bg-primary',
        'PUBLICADA': 'bg-success',
        'ARQUIVADA': 'bg-dark'
    };
    return statusClasses[status] || 'bg-secondary';
}

// Fun√ß√£o para formatar conte√∫do no molde da imagem
function formatarConteudoParaVisualizacao(publicacao) {
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const horaAtual = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    return `
        <div class="documento-header">
            <h1>CORPO DE BOMBEIROS MILITAR DO PIAU√ç</h1>
            <h2>QUARTEL DO COMANDO GERAL</h2>
            <h3>COMANDO OPERACIONAL DE BOMBEIROS - COB/COMANDO OPERACIONAL DE BOMBEIROS</h3>
        </div>
        
        <div class="documento-numero">
            ${publicacao.numero_boletim ? `NOTA N¬∫ ${publicacao.numero_boletim}` : 'NOTA N¬∫ 00000/2025'}
        </div>
        
        <div class="documento-titulo">
            ${publicacao.titulo || 'T√çTULO DA PUBLICA√á√ÉO'}
        </div>
        
        <div class="documento-conteudo">
            ${publicacao.conteudo || '<p>Conte√∫do da publica√ß√£o n√£o dispon√≠vel.</p>'}
        </div>
        
        <div class="documento-assinatura">
            <div class="local-data">
                Teresina - PI, ${dataAtual}.
            </div>
            <div class="assinatura">
                ${publicacao.criado_por || 'NOME DO COMANDANTE'}
            </div>
            <div class="cargo">
                Comandante Operacional do CBMEPI
            </div>
        </div>
        
        <div class="documento-anexos">
            Anexos:
        </div>
        
        <div class="documento-rodape">
            <div class="logo">
                <strong>SIKAD</strong><br>
                Sistema Integrado de Gest√£o
            </div>
            <div class="info-verificacao">
                Verifica√ß√£o: ${dataAtual}, ${horaAtual}<br>
                Boletim: ${publicacao.numero_boletim || 'N/A'} | Status: ${publicacao.status_display || 'N/A'}
            </div>
        </div>
    `;
}

// Fun√ß√£o para imprimir publica√ß√£o
// Fun√ß√£o removida - modal de visualiza√ß√£o substitu√≠do por p√°gina dedicada
function imprimirPublicacaoRemovida() {
    const conteudoElement = document.getElementById('visualizar_conteudo');
    if (!conteudoElement) {
        console.error('Elemento visualizar_conteudo n√£o encontrado');
        return;
    }
    const conteudo = conteudoElement.innerHTML;
    
    // Criar janela de impress√£o
    const janelaImpressao = window.open('', '_blank');
    janelaImpressao.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Publica√ß√£o - Visualiza√ß√£o</title>
            <style>
                body { 
                    font-family: 'Times New Roman', serif; 
                    margin: 0; 
                    padding: 40px; 
                    line-height: 1.6; 
                    color: #333;
                    background: white;
                }
                
                .documento-header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                }
                
                .documento-header h1 {
                    font-size: 18px;
                    font-weight: bold;
                    margin: 0;
                    text-transform: uppercase;
                }
                
                .documento-header h2 {
                    font-size: 16px;
                    font-weight: bold;
                    margin: 5px 0;
                    text-transform: uppercase;
                }
                
                .documento-header h3 {
                    font-size: 14px;
                    font-weight: bold;
                    margin: 5px 0;
                    text-transform: uppercase;
                }
                
                .documento-numero {
                    text-align: center;
                    margin: 20px 0;
                    font-weight: bold;
                    font-size: 16px;
                }
                
                .documento-titulo {
                    text-align: center;
                    margin: 20px 0;
                    font-weight: bold;
                    font-size: 18px;
                    text-transform: uppercase;
                }
                
                .documento-conteudo {
                    text-align: justify;
                    margin: 20px 0;
                }
                
                .documento-conteudo p {
                    margin-bottom: 15px;
                    text-indent: 40px;
                }
                
                .documento-conteudo .numero-item {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                
                .documento-conteudo .sub-item {
                    margin-left: 20px;
                    margin-bottom: 10px;
                }
                
                .documento-conteudo .sub-item strong {
                    font-weight: bold;
                }
                
                .documento-assinatura {
                    text-align: right;
                    margin-top: 40px;
                    margin-right: 50px;
                }
                
                .documento-assinatura .local-data {
                    margin-bottom: 20px;
                    font-style: italic;
                }
                
                .documento-assinatura .assinatura {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                
                .documento-assinatura .cargo {
                    font-size: 14px;
                    text-transform: uppercase;
                }
                
                .documento-anexos {
                    margin-top: 30px;
                    font-weight: bold;
                }
                
                .documento-rodape {
                    margin-top: 40px;
                    text-align: center;
                    font-size: 12px;
                    color: #666;
                }
                
                .documento-rodape .logo {
                    margin-bottom: 10px;
                }
                
                .documento-rodape .info-verificacao {
                    font-size: 10px;
                    color: #999;
                    margin-top: 10px;
                }
                
                @media print {
                    body { margin: 0; padding: 20px; }
                    .no-print { display: none; }
                }
                
                /* Estilos para notas devolvidas */
                .table-warning {
                    background-color: #fff3cd !important;
                    border-left: 4px solid #ffc107;
                }
                
                .prioridade-devolvida {
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
                
                .btn-outline-danger:hover {
                    background-color: #dc3545;
                    border-color: #dc3545;
                    color: white;
                }
            </style>
        </head>
        <body>
            ${conteudo}
        </body>
        </html>
    `);
    
    janelaImpressao.document.close();
    janelaImpressao.focus();
    janelaImpressao.print();
}

// Fun√ß√£o para devolver nota
// Fun√ß√£o removida - modal de visualiza√ß√£o substitu√≠do por p√°gina dedicada
function devolverNotaRemovida() {
    // Obter ID da nota do modal de visualiza√ß√£o
    const notaId = window.notaVisualizacaoId;
    if (!notaId) {
        mostrarModalErro('Erro', 'ID da nota n√£o encontrado.');
        return;
    }
    
    // Buscar dados da nota via AJAX
    fetch(`/militares/notas/${notaId}/dados-assinatura/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher informa√ß√µes da nota no modal
                document.getElementById('notaIdDevolver').value = notaId;
                document.getElementById('notaNumeroDevolver').textContent = data.nota.numero || '-';
                document.getElementById('notaTituloDevolver').textContent = data.nota.titulo || '-';
                document.getElementById('notaCriadoPorDevolver').textContent = data.nota.criado_por || '-';
                
                // Atualizar status com badge
                const statusElement = document.getElementById('notaStatusDevolver');
                const statusClass = getStatusBadgeClass(data.nota.status);
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = data.nota.status_display || '-';
                
                // Limpar campo de motivo
                document.getElementById('motivo_devolucao').value = '';
                
                // Fechar modal de visualiza√ß√£o primeiro
                const modalVisualizacao = bootstrap.Modal.getInstance(document.getElementById('visualizarPublicacaoModal'));
                if (modalVisualizacao) {
                    modalVisualizacao.hide();
                }
                
                // Aguardar um pouco e ent√£o abrir modal de devolu√ß√£o
                setTimeout(() => {
                    const modal = new bootstrap.Modal(document.getElementById('modalDevolverNota'));
                    modal.show();
                }, 300);
            } else {
                mostrarModalErro('Erro', 'Erro ao carregar dados da nota: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar dados da nota. Tente novamente.');
        });
}

// Fun√ß√£o para arquivar publica√ß√£o
// Fun√ß√£o removida - modal de visualiza√ß√£o substitu√≠do por p√°gina dedicada
function arquivarPublicacaoRemovida() {
    mostrarModalConfirmacao(
        'Confirmar Arquivamento',
        'Tem certeza que deseja arquivar esta publica√ß√£o?',
        function() {
            // Aqui voc√™ pode implementar a l√≥gica para arquivar a publica√ß√£o
            mostrarModalErro('Funcionalidade Indispon√≠vel', 'Funcionalidade de arquivamento ser√° implementada em breve.');
        }
    );
}

// Vari√°vel global para armazenar o ID da nota sendo indexada
let notaIdIndexacao = null;

// Fun√ß√£o para mostrar mensagem de erro
function mostrarMensagemErro(mensagem) {
    console.error('Erro:', mensagem);
    // Usar alert simples e claro
    alert('‚ùå ' + mensagem);
}

// Fun√ß√£o para mostrar mensagem de sucesso
function mostrarMensagemSucesso(mensagem) {
    console.log('Sucesso:', mensagem);
    // Usar alert simples e claro
    alert('‚úÖ ' + mensagem);
}


// Fun√ß√£o para abrir modal de indexa√ß√£o de militares
// Fun√ß√£o para abrir modal de publica√ß√£o
function abrirModalPublicacao(notaId, tituloNota, topicosNota, tipoPublicacao) {
    console.log('=== IN√çCIO: abrirModalPublicacao ===');
    console.log('Abrindo modal de publica√ß√£o para nota:', notaId, 'T√≠tulo:', tituloNota);
    
    // Verificar se existe boletim do dia atual antes de abrir o modal
    console.log('Fazendo chamada AJAX para verificar boletim do dia...');
    fetch('/militares/ajax/verificar-boletim-hoje/')
        .then(response => {
            console.log('Resposta recebida:', response);
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            if (data.success && data.existe_boletim) {
                console.log('‚úÖ Existe boletim do dia atual - Abrindo modal');
                // Existe boletim do dia atual, pode abrir o modal
                abrirModalPublicacaoInterno(notaId, tituloNota, topicosNota, tipoPublicacao);
            } else {
                console.log('‚ùå N√£o existe boletim do dia atual - Bloqueando modal');
                // N√£o existe boletim do dia atual, mostrar mensagem de erro
                mostrarMensagemErro('N√£o √© poss√≠vel enviar notas. N√£o existe boletim do dia atual. Crie um boletim para hoje antes de enviar notas.');
            }
        })
        .catch(error => {
            console.error('Erro ao verificar boletim do dia:', error);
            mostrarMensagemErro('Erro ao verificar disponibilidade do boletim.');
        });
    console.log('=== FIM: abrirModalPublicacao ===');
}

// Fun√ß√£o interna para abrir o modal (chamada ap√≥s verifica√ß√£o)
function abrirModalPublicacaoInterno(notaId, tituloNota, topicosNota, tipoPublicacao) {
    try {
        // Preencher informa√ß√µes da nota no modal
        const tituloElement = document.getElementById('notaTituloPublicacao');
        const topicosElement = document.getElementById('notaTopicosPublicacao');
        
        console.log('Elementos encontrados:', { tituloElement, topicosElement });
        
        if (tituloElement) {
            tituloElement.textContent = tituloNota;
            console.log('T√≠tulo preenchido:', tituloNota);
        } else {
            console.error('Elemento notaTituloPublicacao n√£o encontrado');
        }
        
        if (topicosElement) {
            topicosElement.textContent = `T√≥picos: ${topicosNota}`;
            console.log('T√≥picos preenchidos:', topicosNota);
        } else {
            console.error('Elemento notaTopicosPublicacao n√£o encontrado');
        }
        
        // Armazenar ID da nota para uso posterior
        window.notaIdPublicacao = notaId;
        console.log('ID da nota armazenado:', notaId);
        
        // Ajustar cor do bot√£o baseado no tipo de publica√ß√£o
        const botaoEnviar = document.querySelector('#publicarNotaModal .btn-danger');
        if (botaoEnviar) {
            if (tipoPublicacao === 'Reservado') {
                botaoEnviar.className = 'btn btn-danger';
                console.log('Bot√£o ajustado para vermelho (Reservado)');
            } else {
                botaoEnviar.className = 'btn btn-success';
                console.log('Bot√£o ajustado para verde (Ostensivo)');
            }
        }
        
        // Mostrar modal
        const modalElement = document.getElementById('publicarNotaModal');
        console.log('Elemento do modal encontrado:', modalElement);
        
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Modal mostrado com sucesso');
        } else {
            console.error('Elemento publicarNotaModal n√£o encontrado');
        }
    } catch (error) {
        console.error('Erro ao abrir modal de publica√ß√£o:', error);
        alert('Erro ao abrir modal: ' + error.message);
    }
}

// Fun√ß√£o para publicar nota no boletim
function publicarNoBoletim() {
    if (!window.notaIdPublicacao) {
        console.error('ID da nota n√£o encontrado');
        mostrarMensagemErro('Erro: ID da nota n√£o encontrado');
        return;
    }
    
    console.log('Enviando nota para o boletim:', window.notaIdPublicacao);
    
    // Fazer requisi√ß√£o para enviar para o boletim
    console.log('üöÄ Enviando nota para boletim:', window.notaIdPublicacao);
    fetch(`/militares/notas/${window.notaIdPublicacao}/publicar-boletim/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Status da resposta:', response.status);
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä Resposta do envio:', data);
        
        if (data && data.success === true) {
            console.log('‚úÖ Sucesso! Fechando modal e recarregando p√°gina...');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('publicarNotaModal'));
            if (modal) {
                modal.hide();
            }
            
            // Mostrar mensagem de sucesso
            mostrarMensagemSucesso('Nota enviada para o boletim com sucesso!');
            
            // Recarregar a p√°gina ap√≥s um pequeno delay
            setTimeout(() => {
                console.log('üîÑ Recarregando p√°gina...');
                window.location.reload();
            }, 1500);
        } else {
            console.log('‚ùå Erro na resposta:', data);
            // Tratar erro
            const mensagemErro = (data && data.message) ? data.message : 'Erro ao enviar nota para o boletim';
            mostrarMensagemErro(mensagemErro);
        }
    })
    .catch(error => {
        console.error('Erro ao enviar nota para o boletim:', error);
        mostrarMensagemErro('Erro de conex√£o. Tente novamente.');
    });
}

function abrirModalIndexacao(notaId, tituloNota) {
    console.log('Abrindo modal de indexa√ß√£o para nota:', notaId, 'T√≠tulo:', tituloNota);
    
    try {
        notaIdIndexacao = notaId;
        
        // Preencher t√≠tulo da nota
        const tituloElement = document.getElementById('notaTituloIndexacao');
        if (tituloElement) {
            tituloElement.textContent = tituloNota;
        } else {
            console.error('Elemento notaTituloIndexacao n√£o encontrado');
        }
        
        // Limpar sele√ß√µes anteriores
        const listaDisponiveis = document.getElementById('listaMilitaresDisponiveis');
        const listaIndexados = document.getElementById('militaresIndexados');
        
        if (listaDisponiveis) {
            listaDisponiveis.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        }
        
        if (listaIndexados) {
            listaIndexados.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        }
        
        // Limpar filtro
        const filtroElement = document.getElementById('filtroMilitares');
        if (filtroElement) {
            filtroElement.value = '';
        }
        
        // Carregar dados da nota e militares
        carregarDadosIndexacao(notaId);
        
        // Mostrar modal
        const modalElement = document.getElementById('indexarMilitaresModal');
        console.log('Elemento modal encontrado:', modalElement);
        
        if (modalElement) {
            console.log('Tentando abrir modal...');
            try {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('Modal aberto com sucesso');
            } catch (modalError) {
                console.error('Erro ao abrir modal:', modalError);
                mostrarModalErro('Erro ao Abrir Modal', 'Erro ao abrir modal: ' + modalError.message);
            }
        } else {
            console.error('Modal indexarMilitaresModal n√£o encontrado');
            mostrarModalErro('Modal N√£o Encontrado', 'Modal indexarMilitaresModal n√£o encontrado');
        }
        
    } catch (error) {
        console.error('Erro ao abrir modal:', error);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao abrir modal de indexa√ß√£o: ' + error.message);
    }
}

// Fun√ß√£o para carregar dados da indexa√ß√£o
function carregarDadosIndexacao(notaId) {
    console.log('[CARREGANDO] Dados para nota:', notaId);
    
    // Mostrar loading
    const container = document.getElementById('listaMilitaresDisponiveis');
    const contador = document.getElementById('contadorDisponiveis');
    
    if (container) {
        container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando militares...</div>';
    }
    if (contador) {
        contador.textContent = '0';
    }
    
    // Carregar todos os militares cadastrados no sistema
    fetch('/militares/ajax/militares-disponiveis/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Resposta recebida:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados recebidos:', data);
        if (data.success) {
            console.log('Militares carregados:', data.militares.length);
            exibirMilitaresDisponiveis(data.militares);
        } else {
            console.error('Erro ao carregar militares:', data.error);
            exibirMilitaresDisponiveis([]);
            mostrarModalErro('Erro ao Carregar', 'Erro ao carregar militares: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        exibirMilitaresDisponiveis([]);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar militares: ' + error.message);
    });
    
    // Carregar militares j√° indexados nesta publica√ß√£o
    carregarMilitaresIndexados(notaId);
}

// Fun√ß√£o para carregar militares j√° indexados
function carregarMilitaresIndexados(notaId) {
    console.log('[CARREGANDO] Militares indexados para nota:', notaId);
    
    fetch(`/militares/ajax/militares-indexados/${notaId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Resposta militares indexados:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Militares indexados recebidos:', data);
        if (data.success) {
            console.log('Militares indexados carregados:', data.militares_indexados.length);
            exibirMilitaresIndexados(data.militares_indexados);
        } else {
            console.error('Erro ao carregar militares indexados:', data.error);
            exibirMilitaresIndexados([]);
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o de militares indexados:', error);
        exibirMilitaresIndexados([]);
    });
}

// Fun√ß√£o para exibir militares dispon√≠veis
function exibirMilitaresDisponiveis(militares) {
    console.log('üìã Exibindo militares dispon√≠veis:', militares.length);
    
    const container = document.getElementById('listaMilitaresDisponiveis');
    const contador = document.getElementById('contadorDisponiveis');
    
    if (!container) {
        console.error('Container listaMilitaresDisponiveis n√£o encontrado');
        return;
    }
    
    if (!contador) {
        console.error('Contador contadorDisponiveis n√£o encontrado');
        return;
    }
    
    if (militares.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">Nenhum militar encontrado</div>';
        contador.textContent = '0';
        return;
    }
    
    // Log dos primeiros 3 militares para debug
    console.log('üìã Primeiros 3 militares:', militares.slice(0, 3));
    
    // Obter IDs dos militares j√° indexados
    const militaresIndexados = Array.from(document.querySelectorAll('#militaresIndexados .militar-indexado')).map(item => item.getAttribute('data-id'));
    console.log('Militares j√° indexados:', militaresIndexados);
    
    container.innerHTML = militares.map((militar, index) => {
        // Normalizar dados para trabalhar com ambos os formatos (busca AJAX e militares dispon√≠veis)
        const nomeCompleto = militar.nome_completo || militar.nome || '';
        const nomeGuerra = militar.nome_guerra || '';
        const postoGraduacao = militar.posto_graduacao || militar.posto || '';
        const postoDisplay = militar.posto_display || militar.posto || postoGraduacao;
        const matricula = militar.matricula || '';
        const classificacao = militar.classificacao || 'ATIVO';
        
        // Verificar se j√° est√° indexado
        const jaIndexado = militaresIndexados.includes(militar.id.toString());
        
        const nomeLower = nomeCompleto.toLowerCase();
        const nomeGuerraLower = nomeGuerra.toLowerCase();
        const postoLower = postoGraduacao.toLowerCase();
        const postoDisplayLower = postoDisplay.toLowerCase();
        const matriculaLower = matricula.toLowerCase();
        const classificacaoLower = classificacao.toLowerCase();
        
        // Log dos primeiros 3 para debug
        if (index < 3) {
            console.log(`üìã Militar ${index + 1} processado:`, {
                nomeOriginal: nomeCompleto,
                nomeLower,
                nomeGuerraLower,
                postoLower,
                postoDisplayLower,
                matriculaLower,
                classificacaoLower
            });
        }
        
        // Badge de classifica√ß√£o com cores
        let classificacaoBadge = '';
        switch(classificacao) {
            case 'ATIVO':
                classificacaoBadge = '<span class="badge bg-success">ATIVO</span>';
                break;
            case 'INATIVO':
                classificacaoBadge = '<span class="badge bg-secondary">INATIVO</span>';
                break;
            case 'RR':
                classificacaoBadge = '<span class="badge bg-warning">RR</span>';
                break;
            case 'NVRR':
                classificacaoBadge = '<span class="badge bg-info">NVRR</span>';
                break;
            case 'FALECIDO':
                classificacaoBadge = '<span class="badge bg-dark">FALECIDO</span>';
                break;
            default:
                classificacaoBadge = `<span class="badge bg-light text-dark">${classificacao}</span>`;
        }
        
        // Escapar aspas simples no nome para JavaScript
        const nomeEscapado = nomeCompleto.replace(/'/g, "\\'");
        const postoEscapado = postoGraduacao.replace(/'/g, "\\'");
        
        // Bot√£o baseado no status de indexa√ß√£o
        let botaoHtml = '';
        if (jaIndexado) {
            botaoHtml = `
                <button type="button" class="btn btn-sm btn-success ms-2" disabled title="J√° indexado">
                    <i class="fas fa-check"></i>
                </button>
            `;
        } else {
            botaoHtml = `
                <button type="button" class="btn btn-sm btn-outline-success ms-2" 
                        onclick="adicionarMilitar(${militar.id}, '${nomeEscapado}', '${postoEscapado}')"
                        title="Adicionar √† indexa√ß√£o">
                    <i class="fas fa-plus"></i>
                </button>
            `;
        }
        
        const html = `
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom militar-item" 
             data-id="${militar.id}"
             data-nome="${nomeLower}" 
             data-nome-guerra="${nomeGuerraLower}"
             data-posto="${postoLower}"
             data-posto-display="${postoDisplayLower}"
             data-matricula="${matriculaLower}"
             data-classificacao="${classificacaoLower}">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                    <strong class="text-primary me-2">${postoDisplay}</strong>
                    ${classificacaoBadge}
                </div>
                <div class="fw-bold text-dark">${nomeCompleto}</div>
                ${nomeGuerra ? `<div class="text-muted small"><i class="fas fa-user-tag me-1"></i>${nomeGuerra}</div>` : ''}
                <div class="text-muted small">
                    <i class="fas fa-id-card me-1"></i>${matricula}
                </div>
            </div>
            ${botaoHtml}
        </div>
    `;
    
    // Log do HTML gerado para os primeiros 3
    if (index < 3) {
        console.log(`üìã HTML gerado para militar ${index + 1}:`, html.substring(0, 200) + '...');
    }
    
    return html;
    }).join('');
    
    contador.textContent = militares.length;
    
    // Atualizar total de militares
    const totalElement = document.getElementById('totalMilitares');
    if (totalElement) {
        totalElement.textContent = `de ${militares.length}`;
    }
    
    console.log('Militares exibidos com sucesso');
}

// Fun√ß√£o para exibir militares indexados
function exibirMilitaresIndexados(militares) {
    console.log('üìã Exibindo militares indexados:', militares.length);
    
    const container = document.getElementById('militaresIndexados');
    const contador = document.getElementById('contadorIndexados');
    
    if (militares.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">Nenhum militar indexado</div>';
        if (contador) contador.textContent = '0';
        return;
    }
    
    container.innerHTML = militares.map(militar => {
        // Escapar aspas simples no nome para JavaScript
        const nomeEscapado = militar.nome_completo.replace(/'/g, "\\'");
        const postoEscapado = militar.posto_display.replace(/'/g, "\\'");
        
        return `
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom militar-indexado" data-id="${militar.id}">
            <div>
                <div class="fw-bold text-primary">${militar.posto_display}</div>
                <strong>${militar.nome_completo}</strong><br>
                <small class="text-muted">
                    <i class="fas fa-id-card me-1"></i>${militar.matricula}
                    ${militar.nome_guerra ? `<br><i class="fas fa-user-tag me-1"></i>${militar.nome_guerra}` : ''}
                </small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitarIndexado(${militar.id})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    }).join('');
    
    if (contador) contador.textContent = militares.length;
    
    console.log('Militares indexados exibidos com sucesso');
}

// Fun√ß√£o para filtrar militares
// Vari√°vel para controlar timeout da busca
let timeoutBusca = null;

function buscarMilitaresDinamico() {
    console.log('Iniciando busca din√¢mica...');
    
    const filtroInput = document.getElementById('filtroMilitares');
    if (!filtroInput) {
        console.error('Campo de filtro n√£o encontrado');
        mostrarModalErro('Campo N√£o Encontrado', 'Campo de filtro n√£o encontrado');
        return;
    }
    
    const termo = filtroInput.value.trim();
    console.log('Termo de busca:', `"${termo}"`);
    
    // Limpar timeout anterior
    if (timeoutBusca) {
        clearTimeout(timeoutBusca);
    }
    
    // Se termo estiver vazio, carregar todos os militares
    if (termo === '') {
        console.log('Termo vazio, carregando todos os militares');
        carregarTodosMilitares();
        return;
    }
    
    // Se termo for muito curto, n√£o fazer busca
    if (termo.length < 2) {
        console.log('Termo muito curto, aguardando...');
        return;
    }
    
    // Mostrar loading
    mostrarLoadingBusca(true);
    
    // Debounce: aguardar 300ms antes de fazer a busca
    timeoutBusca = setTimeout(() => {
        console.log('Executando busca AJAX ap√≥s debounce...');
        buscarMilitaresAjax(termo);
    }, 300);
}

function mostrarLoadingBusca(mostrar) {
    const loading = document.getElementById('loadingBusca');
    if (loading) {
        loading.style.display = mostrar ? 'block' : 'none';
    }
}

function buscarMilitaresAjax(termo) {
    console.log('Fazendo busca AJAX para termo:', termo);
    
    fetch(`/militares/busca-militares/?q=${encodeURIComponent(termo)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Resposta recebida:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados recebidos:', data);
        if (data.results) {
            console.log('Militares encontrados:', data.results.length);
            exibirMilitaresDisponiveis(data.results);
        } else {
            console.log('‚ö†Ô∏è Nenhum resultado encontrado');
            exibirMilitaresDisponiveis([]);
        }
    })
    .catch(error => {
        console.error('Erro na busca AJAX:', error);
        exibirMilitaresDisponiveis([]);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao buscar militares: ' + error.message);
    })
    .finally(() => {
        mostrarLoadingBusca(false);
    });
}

function carregarTodosMilitares() {
    console.log('[CARREGANDO] Todos os militares...');
    
    // Mostrar loading
    const container = document.getElementById('listaMilitaresDisponiveis');
    const contador = document.getElementById('contadorDisponiveis');
    
    if (container) {
        container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando militares...</div>';
    }
    if (contador) {
        contador.textContent = '0';
    }
    
    // Carregar todos os militares cadastrados no sistema
    fetch('/militares/ajax/militares-disponiveis/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Resposta recebida:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados recebidos:', data);
        if (data.success) {
            console.log('Militares carregados:', data.militares.length);
            exibirMilitaresDisponiveis(data.militares);
        } else {
            console.error('Erro ao carregar militares:', data.error);
            exibirMilitaresDisponiveis([]);
            mostrarModalErro('Erro ao Carregar', 'Erro ao carregar militares: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        exibirMilitaresDisponiveis([]);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao carregar militares: ' + error.message);
    });
}

// Fun√ß√£o de compatibilidade para manter funcionalidade existente
function filtrarMilitares() {
    buscarMilitaresDinamico();
}

// Fun√ß√£o para selecionar todos os militares vis√≠veis
function selecionarTodos() {
    const itensVisiveis = document.querySelectorAll('#listaMilitaresDisponiveis .militar-item[style*="flex"], #listaMilitaresDisponiveis .militar-item:not([style*="none"])');
    
    console.log('[SELECIONANDO] Todos os militares vis√≠veis:', itensVisiveis.length);
    
    itensVisiveis.forEach(item => {
        const botao = item.querySelector('button');
        if (botao && !botao.disabled) {
            botao.click();
        }
    });
}

// Fun√ß√£o para limpar sele√ß√£o
function limparSelecao() {
    const itensSelecionados = document.querySelectorAll('#militaresIndexados .militar-indexado');
    
    itensSelecionados.forEach(item => {
        const botao = item.querySelector('button');
        if (botao) {
            botao.click();
        }
    });
}

// Fun√ß√£o para limpar filtro
function limparFiltro() {
    const filtroInput = document.getElementById('filtroMilitares');
    if (filtroInput) {
        filtroInput.value = '';
        filtrarMilitares();
    }
}

// Fun√ß√£o para adicionar militar
function adicionarMilitar(id, nome, posto) {
    // Verificar se j√° est√° indexado
    const jaIndexado = document.querySelector(`#militaresIndexados .militar-indexado[data-id="${id}"]`);
    if (jaIndexado) {
        return;
    }
    
    // Buscar dados completos do militar na lista de dispon√≠veis
    const militarItem = document.querySelector(`#listaMilitaresDisponiveis .militar-item[data-id="${id}"]`);
    let militarData = { id: id, nome_completo: nome, posto_display: posto, matricula: '', nome_guerra: '' };
    
    if (militarItem) {
        // Extrair dados do elemento HTML
        const nomeElement = militarItem.querySelector('.fw-bold.text-dark');
        const matriculaElement = militarItem.querySelector('.text-muted.small');
        const nomeGuerraElement = militarItem.querySelector('.text-muted.small');
        
        if (nomeElement) militarData.nome_completo = nomeElement.textContent;
        if (matriculaElement) {
            const matriculaText = matriculaElement.textContent;
            const matriculaMatch = matriculaText.match(/\d+/);
            if (matriculaMatch) militarData.matricula = matriculaMatch[0];
        }
        if (nomeGuerraElement && nomeGuerraElement.textContent.includes('@')) {
            militarData.nome_guerra = nomeGuerraElement.textContent.replace('@ ', '');
        }
    }
    
    // Adicionar √† lista de indexados
    const container = document.getElementById('militaresIndexados');
    const novoItem = document.createElement('div');
    novoItem.className = 'd-flex justify-content-between align-items-center p-2 border-bottom militar-indexado';
    novoItem.setAttribute('data-id', id);
    novoItem.innerHTML = `
        <div>
            <div class="fw-bold text-primary">${militarData.posto_display}</div>
            <strong>${militarData.nome_completo}</strong><br>
            <small class="text-muted">
                <i class="fas fa-id-card me-1"></i>${militarData.matricula}
                ${militarData.nome_guerra ? `<br><i class="fas fa-user-tag me-1"></i>${militarData.nome_guerra}` : ''}
            </small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitarIndexado(${id})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(novoItem);
    
    // Desabilitar bot√£o na lista de dispon√≠veis
    const botaoDisponivel = document.querySelector(`#listaMilitaresDisponiveis .militar-item button[onclick*="${id}"]`);
    if (botaoDisponivel) {
        botaoDisponivel.disabled = true;
        botaoDisponivel.innerHTML = '<i class="fas fa-check"></i>';
        botaoDisponivel.className = 'btn btn-sm btn-success';
    }
    
    // Atualizar contadores
    atualizarContadores();
}

// Fun√ß√£o para remover militar indexado
function removerMilitarIndexado(id) {
    console.log('üóëÔ∏è Removendo militar indexado:', id);
    
    // Remover da lista de indexados
    const itemIndexado = document.querySelector(`#militaresIndexados .militar-indexado[data-id="${id}"]`);
    if (itemIndexado) {
        itemIndexado.remove();
        console.log('Militar removido da lista de indexados');
    } else {
        console.warn('‚ö†Ô∏è Militar n√£o encontrado na lista de indexados');
    }
    
    // Reabilitar bot√£o na lista de dispon√≠veis
    const botaoDisponivel = document.querySelector(`#listaMilitaresDisponiveis .militar-item button[onclick*="${id}"]`);
    if (botaoDisponivel) {
        botaoDisponivel.disabled = false;
        botaoDisponivel.innerHTML = '<i class="fas fa-plus"></i>';
        botaoDisponivel.className = 'btn btn-sm btn-outline-success';
        console.log('Bot√£o reabilitado na lista de dispon√≠veis');
    } else {
        console.warn('‚ö†Ô∏è Bot√£o n√£o encontrado na lista de dispon√≠veis');
    }
    
    // Verificar se n√£o h√° mais militares indexados
    const militaresIndexados = document.querySelectorAll('#militaresIndexados .militar-indexado');
    if (militaresIndexados.length === 0) {
        const container = document.getElementById('militaresIndexados');
        if (container) {
            container.innerHTML = '<div class="text-center text-muted py-3">Nenhum militar indexado</div>';
        }
    }
    
    // Atualizar contadores
    atualizarContadores();
    
    console.log('Remo√ß√£o conclu√≠da');
}

// Fun√ß√£o para atualizar contadores
function atualizarContadores() {
    const disponiveis = document.querySelectorAll('#listaMilitaresDisponiveis .militar-item:not([style*="none"])');
    const indexados = document.querySelectorAll('#militaresIndexados .militar-indexado');
    
    const contadorDisponiveis = document.getElementById('contadorDisponiveis');
    const contadorIndexados = document.getElementById('contadorIndexados');
    
    if (contadorDisponiveis) {
        contadorDisponiveis.textContent = disponiveis.length;
    }
    if (contadorIndexados) {
        contadorIndexados.textContent = indexados.length;
    }
}

// Fun√ß√£o para salvar indexa√ß√£o
function salvarIndexacao() {
    if (!notaIdIndexacao) return;
    
    // Coletar IDs dos militares indexados
    const militaresIndexados = Array.from(document.querySelectorAll('#militaresIndexados .militar-indexado')).map(item => item.getAttribute('data-id'));
    
    console.log('üíæ Salvando indexa√ß√£o para nota:', notaIdIndexacao, 'Militares:', militaresIndexados);
    
    // Verificar se h√° militares para indexar
    if (militaresIndexados.length === 0) {
        console.log('‚ö†Ô∏è Nenhum militar selecionado para indexa√ß√£o');
        mostrarModalErro('Nenhum Militar Selecionado', 'Nenhum militar selecionado para indexa√ß√£o.\n\nA nota ficar√° sem militares indexados.');
        
        // Mesmo sem militares, vamos salvar para limpar indexa√ß√µes anteriores
        console.log('[SALVANDO] Indexa√ß√£o vazia para limpar dados anteriores...');
    }
    
    // Mostrar loading
    const btnSalvar = document.querySelector('#indexarMilitaresModal .btn-primary');
    const textoOriginal = btnSalvar.innerHTML;
    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
    btnSalvar.disabled = true;
    
    // Preparar dados para envio
    const formData = new FormData();
    militaresIndexados.forEach(id => {
        formData.append('militares_ids[]', id);
    });
    
    // Fazer requisi√ß√£o AJAX para salvar
    fetch(`/militares/ajax/salvar-indexacao/${notaIdIndexacao}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta recebida:', data);
        
        if (data.success) {
            console.log('Indexa√ß√£o salva com sucesso!');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('indexarMilitaresModal'));
            modal.hide();
            
            // Mostrar mensagem de sucesso
            if (data.total_indexados > 0) {
                mostrarModalSucesso('Indexa√ß√£o Conclu√≠da!', `${data.message}\n\n${data.total_indexados} militar(es) indexado(s) com sucesso!`);
            } else {
                mostrarModalSucesso('Nota Salva!', `${data.message}\n\nA nota foi salva sem militares indexados.`);
            }
            
            // Recarregar p√°gina para atualizar a lista de notas
            location.reload();
        } else {
            console.error('Erro ao salvar indexa√ß√£o:', data.error);
            mostrarModalErro('Erro ao Salvar', 'Erro ao salvar indexa√ß√£o: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        mostrarModalErro('Erro de Conex√£o', 'Erro ao salvar indexa√ß√£o: ' + error.message);
    })
    .finally(() => {
        // Restaurar bot√£o
        btnSalvar.innerHTML = textoOriginal;
        btnSalvar.disabled = false;
    });
}

// Fun√ß√£o de teste para verificar o filtro (pode ser chamada no console)
function testarFiltro() {
    console.log('üß™ Testando filtro...');
    const itens = document.querySelectorAll('#listaMilitaresDisponiveis .militar-item');
    console.log('Total de itens encontrados:', itens.length);
    
    if (itens.length > 0) {
        const primeiroItem = itens[0];
        console.log('Primeiro item:', primeiroItem);
        console.log('Data-nome:', primeiroItem.getAttribute('data-nome'));
        console.log('Data-nome-guerra:', primeiroItem.getAttribute('data-nome-guerra'));
        console.log('Data-posto:', primeiroItem.getAttribute('data-posto'));
        console.log('Data-posto-display:', primeiroItem.getAttribute('data-posto-display'));
        console.log('Data-matricula:', primeiroItem.getAttribute('data-matricula'));
        console.log('Data-classificacao:', primeiroItem.getAttribute('data-classificacao'));
        
        // Testar filtro com "adoniram"
        console.log('üß™ Testando filtro com "adoniram"...');
        const filtroInput = document.getElementById('filtroMilitares');
        if (filtroInput) {
            filtroInput.value = 'adoniram';
            filtrarMilitares();
        }
    }
}

// Fun√ß√£o para testar filtro com termo espec√≠fico
function testarFiltroComTermo(termo) {
    console.log(`üß™ Testando filtro com termo: "${termo}"`);
    const filtroInput = document.getElementById('filtroMilitares');
    if (filtroInput) {
        filtroInput.value = termo;
        filtrarMilitares();
    }
}

// Fun√ß√£o para verificar se os nomes est√£o sendo exibidos
function verificarExibicaoNomes() {
    console.log('Verificando exibi√ß√£o dos nomes...');
    const itens = document.querySelectorAll('#listaMilitaresDisponiveis .militar-item');
    console.log('Total de itens encontrados:', itens.length);
    
    if (itens.length > 0) {
        const primeiroItem = itens[0];
        console.log('Primeiro item HTML:', primeiroItem.outerHTML.substring(0, 500));
        
        // Verificar se o nome est√° vis√≠vel no DOM
        const nomeElement = primeiroItem.querySelector('.fw-bold.text-dark');
        if (nomeElement) {
            console.log('Nome encontrado no DOM:', nomeElement.textContent);
        } else {
            console.log('‚ùå Nome N√ÉO encontrado no DOM');
        }
        
        // Verificar todos os elementos de nome
        const todosNomes = document.querySelectorAll('#listaMilitaresDisponiveis .fw-bold.text-dark');
        console.log('Total de elementos de nome encontrados:', todosNomes.length);
        if (todosNomes.length > 0) {
            console.log('Primeiros 3 nomes:', Array.from(todosNomes).slice(0, 3).map(el => el.textContent));
        }
    }
}

</script>

<style>
/* Estilos para o Modal de Visualiza√ß√£o */
.publicacao-conteudo-visualizacao {
    background: white;
    min-height: 100vh;
    padding: 40px;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    color: #333;
}

.publicacao-conteudo-visualizacao .documento-header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 2px solid #333;
    padding-bottom: 20px;
}

.publicacao-conteudo-visualizacao .documento-header h1 {
    font-size: 18px;
    font-weight: bold;
    margin: 0;
    text-transform: uppercase;
}

.publicacao-conteudo-visualizacao .documento-header h2 {
    font-size: 16px;
    font-weight: bold;
    margin: 5px 0;
    text-transform: uppercase;
}

.publicacao-conteudo-visualizacao .documento-header h3 {
    font-size: 14px;
    font-weight: bold;
    margin: 5px 0;
    text-transform: uppercase;
}

.publicacao-conteudo-visualizacao .documento-numero {
    text-align: center;
    margin: 20px 0;
    font-weight: bold;
    font-size: 16px;
}

.publicacao-conteudo-visualizacao .documento-titulo {
    text-align: center;
    margin: 20px 0;
    font-weight: bold;
    font-size: 18px;
    text-transform: uppercase;
}

.publicacao-conteudo-visualizacao .documento-conteudo {
    text-align: justify;
    margin: 20px 0;
}

.publicacao-conteudo-visualizacao .documento-conteudo p {
    margin-bottom: 15px;
    text-indent: 40px;
}

.publicacao-conteudo-visualizacao .documento-conteudo .numero-item {
    font-weight: bold;
    margin-bottom: 10px;
}

.publicacao-conteudo-visualizacao .documento-conteudo .sub-item {
    margin-left: 20px;
    margin-bottom: 10px;
}

.publicacao-conteudo-visualizacao .documento-conteudo .sub-item strong {
    font-weight: bold;
}

.publicacao-conteudo-visualizacao .documento-assinatura {
    text-align: right;
    margin-top: 40px;
    margin-right: 50px;
}

.publicacao-conteudo-visualizacao .documento-assinatura .local-data {
    margin-bottom: 20px;
    font-style: italic;
}

.publicacao-conteudo-visualizacao .documento-assinatura .assinatura {
    font-weight: bold;
    margin-bottom: 5px;
}

.publicacao-conteudo-visualizacao .documento-assinatura .cargo {
    font-size: 14px;
    text-transform: uppercase;
}

.publicacao-conteudo-visualizacao .documento-anexos {
    margin-top: 30px;
    font-weight: bold;
}

.publicacao-conteudo-visualizacao .documento-rodape {
    margin-top: 40px;
    text-align: center;
    font-size: 12px;
    color: #666;
}

.publicacao-conteudo-visualizacao .documento-rodape .logo {
    margin-bottom: 10px;
}

.publicacao-conteudo-visualizacao .documento-rodape .info-verificacao {
    font-size: 10px;
    color: #999;
    margin-top: 10px;
}

/* Estilos para elementos espec√≠ficos */
.publicacao-conteudo-visualizacao h1, 
.publicacao-conteudo-visualizacao h2, 
.publicacao-conteudo-visualizacao h3 {
    margin: 20px 0 10px 0;
    font-weight: bold;
}

.publicacao-conteudo-visualizacao ul, 
.publicacao-conteudo-visualizacao ol {
    margin: 15px 0;
    padding-left: 30px;
}

.publicacao-conteudo-visualizacao table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.publicacao-conteudo-visualizacao table th,
.publicacao-conteudo-visualizacao table td {
    border: 1px solid #333;
    padding: 8px;
    text-align: left;
}

.publicacao-conteudo-visualizacao table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.publicacao-conteudo-visualizacao blockquote {
    border-left: 4px solid #007bff;
    margin: 20px 0;
    padding-left: 20px;
    font-style: italic;
    color: #666;
}

/* Estilos para anexos na visualiza√ß√£o */
#visualizar_anexos .anexo-card {
    border-left: 4px solid #dc3545;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    transition: all 0.3s ease;
}

#visualizar_anexos .anexo-card:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

#visualizar_anexos .card-title {
    color: #333;
    font-weight: 600;
}

#visualizar_anexos .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Estilos para anexos no modal */
#anexos-lista-modal .card {
    transition: all 0.3s ease;
    border-left: 4px solid #dc3545;
}

#anexos-lista-modal .card:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

#anexos-lista-modal .card-title {
    color: #333;
    font-weight: 600;
    font-size: 0.95rem;
}

#anexos-lista-modal .btn-outline-primary {
    border-radius: 20px;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    transition: all 0.3s ease;
}

#anexos-lista-modal .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    transform: scale(1.05);
}

/* Anima√ß√µes para toast notifications */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>

<script>

// Fun√ß√£o para imprimir nota
function imprimirNota(notaId) {
    console.log('Imprimindo nota ID:', notaId);
    
    // Abrir PDF em nova aba
    const url = `/militares/notas/${notaId}/gerar-pdf/?v=${Date.now()}`;
    window.open(url, '_blank');
}

// Fun√ß√£o para ver motivo do arquivamento
function verMotivoArquivamento(notaId) {
    console.log('Verificando motivo do arquivamento para nota ID:', notaId);
    
    // Buscar motivo do arquivamento
    const url = `/militares/notas/${notaId}/dados-assinatura/`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Criar modal para mostrar motivo
                const modalHtml = `
                    <div class="modal fade" id="modalMotivoArquivamento" tabindex="-1" aria-labelledby="modalMotivoArquivamentoLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-dark text-white">
                                    <h5 class="modal-title" id="modalMotivoArquivamentoLabel">
                                        <i class="fas fa-info-circle me-2"></i>Motivo do Arquivamento
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <h6><strong>Nota:</strong> ${data.nota.numero}</h6>
                                        <h6><strong>T√≠tulo:</strong> ${data.nota.titulo}</h6>
                                        <h6><strong>Arquivada em:</strong> ${new Date(data.nota.data_atualizacao).toLocaleString('pt-BR')}</h6>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Motivo do Arquivamento:</strong></label>
                                        <div class="border p-3 bg-light">
                                            ${data.historico_arquivamento ? data.historico_arquivamento.motivo_arquivamento : 'Motivo n√£o dispon√≠vel'}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-2"></i>Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente se houver
                const modalExistente = document.getElementById('modalMotivoArquivamento');
                if (modalExistente) {
                    modalExistente.remove();
                }
                
                // Adicionar modal ao body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Mostrar o modal
                const modalElement = document.getElementById('modalMotivoArquivamento');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                alert('Erro ao carregar motivo do arquivamento: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar motivo do arquivamento');
        });
}

// Fun√ß√£o para visualizar nota em modal
function visualizarNota(notaId) {
    console.log('Abrindo nota ID:', notaId);
    
    // Prevenir comportamento padr√£o
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Definir a URL do iframe
    const iframe = document.getElementById('notaIframe');
    if (iframe) {
        iframe.src = `/militares/notas/${notaId}/visualizar/`;
        
        // Mostrar modal
        const modalElement = document.getElementById('visualizarNotaModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error('Modal n√£o encontrado!');
        }
    } else {
        console.error('Iframe n√£o encontrado!');
    }
    
    return false;
}

// Escutar mensagens do iframe para fechar o modal
window.addEventListener('message', function(event) {
    if (event.data === 'fecharModal') {
        const modal = document.getElementById('visualizarNotaModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        }
    }
});

// Event delegation para bot√µes de visualizar
document.addEventListener('click', function(e) {
    // Verificar se o clique √© em um bot√£o de visualizar nota
    const visualizarBtn = e.target.closest('.visualizar-nota-btn');
    if (visualizarBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const button = e.target.closest('.visualizar-nota-btn');
        const notaId = button.getAttribute('data-nota-id');
        
        if (notaId) {
            console.log('Event delegation - Abrindo nota ID:', notaId);
            
            // Verificar se Bootstrap est√° carregado
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap n√£o est√° carregado!');
                alert('Erro: Bootstrap n√£o est√° carregado. Recarregue a p√°gina.');
                return false;
            }
            
            // Mostrar modal primeiro
            const modalElement = document.getElementById('visualizarNotaModal');
            if (modalElement) {
                console.log('Modal encontrado, abrindo...');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Carregar conte√∫do da nota via AJAX
                carregarConteudoNota(notaId);
            } else {
                console.error('Modal n√£o encontrado!');
            }
        }
        
        return false;
    }
});

// Fun√ß√£o para carregar conte√∫do da nota via AJAX
function carregarConteudoNota(notaId) {
    const notaContent = document.getElementById('notaContent');
    
    // Mostrar loading
    notaContent.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3">Carregando nota...</p>
        </div>
    `;
    
    // Fazer requisi√ß√£o AJAX para o conte√∫do do modal
    fetch(`/militares/notas/${notaId}/modal-content/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao carregar nota');
            }
            return response.text();
        })
        .then(html => {
            console.log('DEBUG: Conte√∫do da nota carregado com sucesso');
            // Inserir o conte√∫do diretamente
            notaContent.innerHTML = html;
            // Testar se as fun√ß√µes est√£o dispon√≠veis
            console.log('DEBUG: Testando fun√ß√µes - imprimirNota:', typeof imprimirNota);
            console.log('DEBUG: Testando fun√ß√µes - devolverNota:', typeof devolverNota);
            console.log('DEBUG: Testando fun√ß√µes - arquivarNota:', typeof arquivarNota);
            
            // Teste direto dos bot√µes
            setTimeout(() => {
                const botoes = notaContent.querySelectorAll('button[onclick]');
                console.log('DEBUG: Bot√µes encontrados:', botoes.length);
                botoes.forEach((botao, index) => {
                    console.log(`DEBUG: Bot√£o ${index}:`, botao.onclick);
                });
                
                // Teste com event listeners
                const btnImprimir = notaContent.querySelector('#btnImprimir');
                const btnDevolver = notaContent.querySelector('#btnDevolver');
                const btnArquivar = notaContent.querySelector('#btnArquivar');
                
                console.log('DEBUG: Bot√µes por ID - Imprimir:', !!btnImprimir, 'Devolver:', !!btnDevolver, 'Arquivar:', !!btnArquivar);
                
                // Event listeners removidos - usando apenas os do modal
            }, 200);
        })
        .catch(error => {
            console.error('Erro ao carregar nota:', error);
            notaContent.innerHTML = `
                <div class="text-center p-5">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar a nota. Tente novamente.
                    </div>
                    <button type="button" class="btn btn-primary" onclick="fecharModalNota()">
                        Fechar
                    </button>
                </div>
            `;
        });
}

// Fun√ß√£o para fechar modal da nota
function fecharModalNota() {
    const modal = document.getElementById('visualizarNotaModal');
    if (modal) {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
            bsModal.hide();
        }
    }
}

// Fun√ß√£o para copiar link do PDF
function copiarLinkPDF(notaId) {
    const linkPDF = window.location.origin + `/militares/notas/${notaId}/gerar-pdf/`;
    
    // Usar a API moderna de clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(linkPDF).then(function() {
            mostrarToastSucesso('Link do PDF copiado para a √°rea de transfer√™ncia!');
        }).catch(function(err) {
            console.error('Erro ao copiar: ', err);
            copiarFallback(linkPDF);
        });
    } else {
        // Fallback para navegadores mais antigos
        copiarFallback(linkPDF);
    }
}

// Fun√ß√£o para gerar/download do PDF
function gerarPDF(notaId) {
    const url = `/militares/notas/${notaId}/gerar-pdf/`;
    // Abrir em nova aba para download
    window.open(url, '_blank');
}

// Fun√ß√£o fallback para copiar
function copiarFallback(texto) {
    const textArea = document.createElement('textarea');
    textArea.value = texto;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        mostrarToastSucesso('Link do PDF copiado para a √°rea de transfer√™ncia!');
    } catch (err) {
        console.error('Erro ao copiar: ', err);
        mostrarToastErro('Erro ao copiar link. Tente novamente.');
    }
    
    document.body.removeChild(textArea);
}

// Fun√ß√£o para mostrar toast de sucesso - DESABILITADA
function mostrarToastSucesso(mensagem) {
    // Sistema de toast desabilitado - usando modais modernos
    return;
}

// Fun√ß√£o para mostrar toast de erro - DESABILITADA
function mostrarToastErro(mensagem) {
    // Sistema de toast desabilitado - usando modais modernos
    return;
}
</script>

<!-- Modal de Visualiza√ß√£o de Nota -->
<div class="modal fade" id="visualizarNotaModal" tabindex="-1" aria-labelledby="visualizarNotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-centered modal-dialog-scrollable" style="max-width: 95%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-white p-2 me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                        <img src="{% static 'logo_cbmepi.png' %}" alt="CBMEPI" style="max-height: 35px; max-width: 35px;">
                    </div>
                    <h5 class="modal-title mb-0" id="visualizarNotaModalLabel">
                        <i class="fas fa-file-alt me-2"></i>
                        Visualizar Nota
                    </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="notaContent">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Carregando nota...</p>
                </div>
            </div>
            <div class="modal-footer bg-light d-flex align-items-center">
                <img src="{% static 'sysgabomlogo.png' %}" alt="Sysgabom" style="max-height: 50px; max-width: 200px;">
                <div class="ms-auto text-muted small">
                    <i class="fas fa-shield-alt me-1"></i>
                    Sistema de Gest√£o Administrativa do Corpo de Bombeiros Militar do Estado do Piau√≠
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}
