{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Arma{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-gun me-2 text-danger"></i>
                        {% if object %}Editar Arma{% else %}Nova Arma{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando arma {{ object.numero_serie }}{% else %}Cadastrar nova arma{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:arma_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados da Arma
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}
                                
                                <!-- Configuração de Arma -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Dica:</strong> Selecione uma configuração de arma para preencher automaticamente os campos tipo, calibre, marca e modelo.
                                            <a href="{% url 'militares:configuracao_arma_list' %}" target="_blank" class="ms-2">
                                                <i class="fas fa-external-link-alt"></i> Gerenciar configurações
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.configuracao_arma.id_for_label }}" class="form-label">
                                            {{ form.configuracao_arma.label }}
                                        </label>
                                        {{ form.configuracao_arma }}
                                        {% if form.configuracao_arma.help_text %}
                                            <small class="form-text text-muted">{{ form.configuracao_arma.help_text }}</small>
                                        {% endif %}
                                        {% if form.configuracao_arma.errors %}
                                            <div class="invalid-feedback d-block">{{ form.configuracao_arma.errors }}</div>
                                        {% endif %}
                                        <div id="configuracao-imagem-preview" class="mt-2" style="display: none;">
                                            <img id="configuracao-imagem" src="" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Identificação -->
                                <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Identificação</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                                            Número de Série <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_serie }}
                                        {% if form.numero_serie.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_serie.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                            Tipo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.tipo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.calibre.id_for_label }}" class="form-label">
                                            Calibre <span class="text-danger">*</span>
                                        </label>
                                        {{ form.calibre }}
                                        {% if form.calibre.errors %}
                                            <div class="invalid-feedback d-block">{{ form.calibre.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.situacao.id_for_label }}" class="form-label">
                                            Situação <span class="text-danger">*</span>
                                        </label>
                                        {{ form.situacao }}
                                        {% if form.situacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.situacao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.estado_conservacao.id_for_label }}" class="form-label">
                                            Estado de Conservação
                                        </label>
                                        {{ form.estado_conservacao }}
                                        {% if form.estado_conservacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.estado_conservacao.errors }}</div>
                                        {% endif %}
                                        {% if form.estado_conservacao.help_text %}
                                            <small class="form-text text-muted">{{ form.estado_conservacao.help_text }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.marca.id_for_label }}" class="form-label">
                                            Marca <span class="text-danger">*</span>
                                        </label>
                                        {{ form.marca }}
                                        {% if form.marca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.marca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.modelo.id_for_label }}" class="form-label">
                                            Modelo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.modelo }}
                                        {% if form.modelo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.modelo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.capacidade_carregador.id_for_label }}" class="form-label">
                                            Capacidade
                                        </label>
                                        {{ form.capacidade_carregador }}
                                        {% if form.capacidade_carregador.errors %}
                                            <div class="invalid-feedback d-block">{{ form.capacidade_carregador.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Alma Raiada -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check">
                                            {{ form.alma_raiada }}
                                            <label class="form-check-label" for="{{ form.alma_raiada.id_for_label }}">
                                                {{ form.alma_raiada.label }}
                                            </label>
                                            {% if form.alma_raiada.help_text %}
                                                <small class="form-text text-muted d-block">{{ form.alma_raiada.help_text }}</small>
                                            {% endif %}
                                        </div>
                                        {% if form.alma_raiada.errors %}
                                            <div class="invalid-feedback d-block">{{ form.alma_raiada.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Campos de Raias (apenas se alma raiada) -->
                                <div class="row" id="raias-campos" style="display: none;">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.quantidade_raias.id_for_label }}" class="form-label">
                                            Quantidade de Raias
                                        </label>
                                        {{ form.quantidade_raias }}
                                        {% if form.quantidade_raias.help_text %}
                                            <small class="form-text text-muted">{{ form.quantidade_raias.help_text }}</small>
                                        {% endif %}
                                        {% if form.quantidade_raias.errors %}
                                            <div class="invalid-feedback d-block">{{ form.quantidade_raias.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.direcao_raias.id_for_label }}" class="form-label">
                                            Direção das Raias
                                        </label>
                                        {{ form.direcao_raias }}
                                        {% if form.direcao_raias.help_text %}
                                            <small class="form-text text-muted">{{ form.direcao_raias.help_text }}</small>
                                        {% endif %}
                                        {% if form.direcao_raias.errors %}
                                            <div class="invalid-feedback d-block">{{ form.direcao_raias.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Organização -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-building me-2"></i>Organização Responsável</h5>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="organograma-select" class="form-label">
                                            Organização (Onde a arma está na carga) <span class="text-danger">*</span>
                                        </label>
                                        <select name="organograma-select" id="organograma-select" class="form-select" required>
                                            <option value="">Selecione uma organização do organograma...</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Selecione a organização onde a arma está na carga (Órgão, Grande Comando, Unidade ou Sub-Unidade).
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Campos ocultos para armazenar os valores da organização (preenchidos automaticamente pelo JavaScript) -->
                                {{ form.orgao.as_hidden }}
                                {{ form.grande_comando.as_hidden }}
                                {{ form.unidade.as_hidden }}
                                {{ form.sub_unidade.as_hidden }}
                                
                                {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
                                <div class="alert alert-danger">
                                    {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
                                    {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
                                    {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
                                    {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Responsável baseado na situação -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-user me-2"></i>Responsável</h5>
                                
                                <!-- Cautela Individual - Militar Responsável -->
                                <div class="row" id="cautela-individual-campos" style="display: none;">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.militar_responsavel.id_for_label }}" class="form-label">
                                            Militar Responsável <span class="text-danger">*</span>
                                        </label>
                                        {{ form.militar_responsavel }}
                                        {% if form.militar_responsavel.errors %}
                                            <div class="invalid-feedback d-block">{{ form.militar_responsavel.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Selecione o militar que está com a arma em cautela individual.</small>
                                    </div>
                                </div>
                                
                                <!-- Reserva de Armamento - Chefe da Organização -->
                                <div class="row" id="reserva-armamento-campos" style="display: none;">
                                    <div class="col-md-12 mb-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Responsável:</strong> Chefe da Organização onde a arma está na carga.
                                            <br>
                                            <small>A responsabilidade fica com o chefe da organização selecionada acima.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Inquérito PM -->
                                <div class="row" id="inquerito-pm-campos" style="display: none;">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_inquerito_pm.id_for_label }}" class="form-label">
                                            Nº Inquérito PM <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_inquerito_pm }}
                                        {% if form.numero_inquerito_pm.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_inquerito_pm.errors }}</div>
                                        {% endif %}
                                        {% if form.numero_inquerito_pm.help_text %}
                                            <small class="form-text text-muted">{{ form.numero_inquerito_pm.help_text }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.encarregado_inquerito_pm.id_for_label }}" class="form-label">
                                            Encarregado do Inquérito PM <span class="text-danger">*</span>
                                        </label>
                                        {{ form.encarregado_inquerito_pm }}
                                        {% if form.encarregado_inquerito_pm.errors %}
                                            <div class="invalid-feedback d-block">{{ form.encarregado_inquerito_pm.errors }}</div>
                                        {% endif %}
                                        {% if form.encarregado_inquerito_pm.help_text %}
                                            <small class="form-text text-muted">{{ form.encarregado_inquerito_pm.help_text }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Inquérito PC -->
                                <div class="row" id="inquerito-pc-campos" style="display: none;">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_inquerito_pc.id_for_label }}" class="form-label">
                                            Nº Inquérito PC <span class="text-danger">*</span>
                                        </label>
                                        {{ form.numero_inquerito_pc }}
                                        {% if form.numero_inquerito_pc.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_inquerito_pc.errors }}</div>
                                        {% endif %}
                                        {% if form.numero_inquerito_pc.help_text %}
                                            <small class="form-text text-muted">{{ form.numero_inquerito_pc.help_text }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.delegado_inquerito_pc.id_for_label }}" class="form-label">
                                            Delegado Responsável <span class="text-danger">*</span>
                                        </label>
                                        {{ form.delegado_inquerito_pc }}
                                        {% if form.delegado_inquerito_pc.errors %}
                                            <div class="invalid-feedback d-block">{{ form.delegado_inquerito_pc.errors }}</div>
                                        {% endif %}
                                        {% if form.delegado_inquerito_pc.help_text %}
                                            <small class="form-text text-muted">{{ form.delegado_inquerito_pc.help_text }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Outras situações (Extraviado, Em Manutenção) -->
                                <div class="row" id="outras-situacoes-campos" style="display: none;">
                                    <div class="col-md-12 mb-3">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Nenhum responsável específico.</strong>
                                            <br>
                                            <small>Para esta situação, não é necessário definir um responsável individual.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informações de Tombamento -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Informações de Tombamento</h5>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.nome_tombamento.id_for_label }}" class="form-label">
                                            Nome do Tombamento
                                        </label>
                                        {{ form.nome_tombamento }}
                                        {% if form.nome_tombamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.nome_tombamento.errors }}</div>
                                        {% endif %}
                                        {% if form.nome_tombamento.help_text %}
                                            <small class="form-text text-muted">{{ form.nome_tombamento.help_text }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.numero_tombamento.id_for_label }}" class="form-label">
                                            Nº Tombamento
                                        </label>
                                        {{ form.numero_tombamento }}
                                        {% if form.numero_tombamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_tombamento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.cod_tombamento.id_for_label }}" class="form-label">
                                            COD
                                        </label>
                                        {{ form.cod_tombamento }}
                                        {% if form.cod_tombamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.cod_tombamento.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.local_tombamento.id_for_label }}" class="form-label">
                                            Local
                                        </label>
                                        {{ form.local_tombamento }}
                                        {% if form.local_tombamento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.local_tombamento.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Documentação -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Documentação</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_registro_policia.id_for_label }}" class="form-label">
                                            Nº Registro no Exército Brasileiro
                                        </label>
                                        {{ form.numero_registro_policia }}
                                        {% if form.numero_registro_policia.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_registro_policia.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_guia_transito.id_for_label }}" class="form-label">
                                            Nº Guia de Trânsito
                                        </label>
                                        {{ form.numero_guia_transito }}
                                        {% if form.numero_guia_transito.errors %}
                                            <div class="invalid-feedback d-block">{{ form.numero_guia_transito.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Aquisição -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-dollar-sign me-2"></i>Aquisição</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="id_data_aquisicao" class="form-label">Data de Aquisição</label>
                                        {{ form.data_aquisicao }}
                                        {% if form.data_aquisicao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_aquisicao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="id_valor_aquisicao" class="form-label">Valor de Aquisição (R$)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" 
                                                   name="valor_aquisicao" 
                                                   id="id_valor_aquisicao" 
                                                   class="form-control" 
                                                   value=""
                                                   placeholder="0,00"
                                                   autocomplete="off">
                                        </div>
                                        {% if form.valor_aquisicao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_aquisicao.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Digite o valor - formatação automática em R$</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.fornecedor.id_for_label }}" class="form-label">Fornecedor</label>
                                        {{ form.fornecedor }}
                                        {% if form.fornecedor.errors %}
                                            <div class="invalid-feedback d-block">{{ form.fornecedor.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Observações -->
                                <hr>
                                <div class="mb-3">
                                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
                                    {{ form.observacoes }}
                                    {% if form.observacoes.errors %}
                                        <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Ativo -->
                                <div class="mb-3 form-check">
                                    {{ form.ativo }}
                                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                        Arma ativa
                                    </label>
                                </div>
                                
                                <!-- Informações do Sistema (apenas na edição) -->
                                {% if object %}
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações do Sistema</h5>
                                <div class="row">
                                    {% if object.criado_por %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Criado por</label>
                                        <input type="text" class="form-control" value="{{ object.criado_por.get_full_name|default:object.criado_por.username }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_criacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Data de Criação</label>
                                        <input type="text" class="form-control" value="{{ object.data_criacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_atualizacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Última Atualização</label>
                                        <input type="text" class="form-control" value="{{ object.data_atualizacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                    <a href="{% url 'militares:arma_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidade de seleção hierárquica única do organograma
    const organogramaSelect = document.getElementById('organograma-select');
    const orgaoHidden = document.getElementById('id_orgao');
    const grandeComandoHidden = document.getElementById('id_grande_comando');
    const unidadeHidden = document.getElementById('id_unidade');
    const subUnidadeHidden = document.getElementById('id_sub_unidade');
    
    // Função para carregar toda a hierarquia do organograma
    async function carregarOrganogramaCompleto() {
        try {
            const response = await fetch('{% url "militares:ajax_organograma_completo" %}');
            const data = await response.json();
            
            // Limpar opções existentes (exceto a primeira)
            organogramaSelect.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            // Adicionar opções da hierarquia
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                // Adicionar estilo baseado no nível
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                organogramaSelect.appendChild(option);
            });
            
            // Selecionar opção atual se estiver editando
            {% if object %}
            selecionarOpcaoAtual();
            {% elif organograma_selecionado %}
            organogramaSelect.value = '{{ organograma_selecionado }}';
            atualizarCamposOcultos();
            {% endif %}
            
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
        }
    }
    
    // Função para selecionar a opção atual baseada nos valores do objeto
    function selecionarOpcaoAtual() {
        {% if object %}
        const orgaoId = {% if object.orgao %}{{ object.orgao.id }}{% else %}null{% endif %};
        const grandeComandoId = {% if object.grande_comando %}{{ object.grande_comando.id }}{% else %}null{% endif %};
        const unidadeId = {% if object.unidade %}{{ object.unidade.id }}{% else %}null{% endif %};
        const subUnidadeId = {% if object.sub_unidade %}{{ object.sub_unidade.id }}{% else %}null{% endif %};
        
        // Encontrar a opção correspondente
        for (let option of organogramaSelect.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                
                // Verificar se corresponde aos valores atuais
                if (valor.orgao_id === orgaoId && 
                    valor.grande_comando_id === grandeComandoId && 
                    valor.unidade_id === unidadeId && 
                    valor.sub_unidade_id === subUnidadeId) {
                    
                    option.selected = true;
                    break;
                }
            }
        }
        {% endif %}
    }
    
    // Função para atualizar campos ocultos quando uma opção é selecionada
    function atualizarCamposOcultos() {
        const selectedOption = organogramaSelect.options[organogramaSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            
            // Atualizar campos do organograma
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            // Limpar todos os campos se nenhuma opção estiver selecionada
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    // Event listener para o select do organograma
    if (organogramaSelect) {
        organogramaSelect.addEventListener('change', atualizarCamposOcultos);
        
        // Carregar organograma completo
        carregarOrganogramaCompleto();
    }
    
    // Função para formatar número como moeda BRL
    function formatarMoedaBRL(valor) {
        if (!valor || valor === '') return '';
        let numeroString = valor.toString().replace(/\./g, '').replace(',', '.');
        numeroString = numeroString.replace(/[^\d.]/g, '');
        let numero = parseFloat(numeroString);
        if (isNaN(numero) || numero < 0) return '';
        
        let numeroStr = numero.toString();
        let partesStr = numeroStr.split('.');
        let parteInteiraStr = partesStr[0];
        let parteDecimalStr = partesStr[1] || '';
        
        if (parteDecimalStr.length > 2) {
            parteDecimalStr = parteDecimalStr.substring(0, 2);
        }
        while (parteDecimalStr.length < 2) {
            parteDecimalStr += '0';
        }
        
        parteInteiraStr = parteInteiraStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return parteInteiraStr + ',' + parteDecimalStr;
    }
    
    // Formatação automática do campo Valor de Aquisição
    const valorAquisicaoInput = document.getElementById('id_valor_aquisicao');
    
    if (valorAquisicaoInput) {
        valorAquisicaoInput.readOnly = false;
        valorAquisicaoInput.disabled = false;
        
        {% if object and object.valor_aquisicao %}
        const valorInicial = parseFloat('{{ object.valor_aquisicao }}');
        if (!isNaN(valorInicial) && valorInicial > 0) {
            valorAquisicaoInput.value = formatarMoedaBRL(valorInicial.toString());
        }
        {% else %}
        valorAquisicaoInput.value = '';
        {% endif %}
        
        valorAquisicaoInput.addEventListener('input', function(e) {
            let valor = e.target.value;
            let valorLimpo = valor.replace(/[^\d,]/g, '');
            let partes = valorLimpo.split(',');
            if (partes.length > 2) {
                valorLimpo = partes[0] + ',' + partes.slice(1).join('');
            }
            if (partes.length === 2 && partes[1].length > 2) {
                valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
            }
            
            if (valorLimpo !== valor) {
                let cursorPos = e.target.selectionStart;
                e.target.value = valorLimpo;
                setTimeout(() => {
                    let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
        });
        
        valorAquisicaoInput.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor || valor === '') {
                e.target.value = '';
                return;
            }
            
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                
                while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                    parteDecimal += '0';
                }
                if (parteDecimal === '') {
                    parteDecimal = '00';
                }
                
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = parteInteira + ',' + parteDecimal;
            } else {
                let numeroLimpo = valor.replace(/[^\d]/g, '');
                if (numeroLimpo !== '') {
                    numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = numeroLimpo + ',00';
                } else {
                    e.target.value = '';
                }
            }
        });
        
        const form = valorAquisicaoInput.closest('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let valor = valorAquisicaoInput.value;
                if (valor) {
                    let valorLimpo = valor.replace(/\./g, '').replace(',', '.');
                    valorAquisicaoInput.value = valorLimpo;
                }
            });
        }
    }
    
    // Garantir que a data de aquisição seja carregada corretamente na edição
    {% if object and object.data_aquisicao %}
    const dataAquisicaoInput = document.getElementById('id_data_aquisicao');
    if (dataAquisicaoInput) {
        const dataObj = '{{ object.data_aquisicao|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataAquisicaoInput.value = dataObj;
        }
    }
    {% endif %}
    
    
    // Mostrar/ocultar campos de raias baseado no checkbox
    const almaRaiadaCheckbox = document.getElementById('id_alma_raiada');
    const raiasCampos = document.getElementById('raias-campos');
    const quantidadeRaiasInput = document.getElementById('id_quantidade_raias');
    const direcaoRaiasSelect = document.getElementById('id_direcao_raias');
    
    function toggleRaiasCampos() {
        if (almaRaiadaCheckbox && raiasCampos) {
            if (almaRaiadaCheckbox.checked) {
                raiasCampos.style.display = 'block';
                if (quantidadeRaiasInput) {
                    quantidadeRaiasInput.required = true;
                }
                if (direcaoRaiasSelect) {
                    direcaoRaiasSelect.required = true;
                }
            } else {
                raiasCampos.style.display = 'none';
                if (quantidadeRaiasInput) {
                    quantidadeRaiasInput.required = false;
                    quantidadeRaiasInput.value = '';
                }
                if (direcaoRaiasSelect) {
                    direcaoRaiasSelect.required = false;
                    direcaoRaiasSelect.value = '';
                }
            }
        }
    }
    
    if (almaRaiadaCheckbox) {
        almaRaiadaCheckbox.addEventListener('change', toggleRaiasCampos);
        // Verificar estado inicial (útil quando editando uma arma existente)
        toggleRaiasCampos();
        
        // Se estiver editando e já houver valores, mostrar os campos
        {% if object and object.alma_raiada %}
        if (almaRaiadaCheckbox.checked) {
            raiasCampos.style.display = 'block';
        }
        {% endif %}
    }
    
    // Mostrar/ocultar campos de responsável baseado na situação
    const situacaoSelect = document.getElementById('id_situacao');
    const cautelaIndividualCampos = document.getElementById('cautela-individual-campos');
    const reservaArmamentoCampos = document.getElementById('reserva-armamento-campos');
    const inqueritoPmCampos = document.getElementById('inquerito-pm-campos');
    const inqueritoPcCampos = document.getElementById('inquerito-pc-campos');
    const outrasSituacoesCampos = document.getElementById('outras-situacoes-campos');
    const militarResponsavelSelect = document.getElementById('id_militar_responsavel');
    const numeroInqueritoPmInput = document.getElementById('id_numero_inquerito_pm');
    const encarregadoInqueritoPmSelect = document.getElementById('id_encarregado_inquerito_pm');
    const numeroInqueritoPcInput = document.getElementById('id_numero_inquerito_pc');
    const delegadoInqueritoPcInput = document.getElementById('id_delegado_inquerito_pc');
    
    function toggleCamposResponsavel() {
        const situacao = situacaoSelect ? situacaoSelect.value : '';
        
        // Ocultar todos os campos primeiro
        if (cautelaIndividualCampos) cautelaIndividualCampos.style.display = 'none';
        if (reservaArmamentoCampos) reservaArmamentoCampos.style.display = 'none';
        if (inqueritoPmCampos) inqueritoPmCampos.style.display = 'none';
        if (inqueritoPcCampos) inqueritoPcCampos.style.display = 'none';
        if (outrasSituacoesCampos) outrasSituacoesCampos.style.display = 'none';
        
        // Limpar campos obrigatórios quando não são necessários
        if (militarResponsavelSelect) {
            militarResponsavelSelect.required = false;
            if (situacao !== 'CAUTELA_INDIVIDUAL') {
                militarResponsavelSelect.value = '';
            }
        }
        if (numeroInqueritoPmInput) {
            numeroInqueritoPmInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PM') {
                numeroInqueritoPmInput.value = '';
            }
        }
        if (encarregadoInqueritoPmSelect) {
            encarregadoInqueritoPmSelect.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PM') {
                encarregadoInqueritoPmSelect.value = '';
            }
        }
        if (numeroInqueritoPcInput) {
            numeroInqueritoPcInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PC') {
                numeroInqueritoPcInput.value = '';
            }
        }
        if (delegadoInqueritoPcInput) {
            delegadoInqueritoPcInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PC') {
                delegadoInqueritoPcInput.value = '';
            }
        }
        
        // Mostrar campos baseado na situação
        if (situacao === 'CAUTELA_INDIVIDUAL') {
            if (cautelaIndividualCampos) cautelaIndividualCampos.style.display = 'block';
            if (militarResponsavelSelect) militarResponsavelSelect.required = true;
        } else if (situacao === 'RESERVA_ARMAMENTO') {
            if (reservaArmamentoCampos) reservaArmamentoCampos.style.display = 'block';
        } else if (situacao === 'ANEXADO_INQUERITO_PM') {
            if (inqueritoPmCampos) inqueritoPmCampos.style.display = 'block';
            if (numeroInqueritoPmInput) numeroInqueritoPmInput.required = true;
            if (encarregadoInqueritoPmSelect) encarregadoInqueritoPmSelect.required = true;
        } else if (situacao === 'ANEXADO_INQUERITO_PC') {
            if (inqueritoPcCampos) inqueritoPcCampos.style.display = 'block';
            if (numeroInqueritoPcInput) numeroInqueritoPcInput.required = true;
            if (delegadoInqueritoPcInput) delegadoInqueritoPcInput.required = true;
        } else {
            // Extraviado, Em Manutenção
            if (outrasSituacoesCampos) outrasSituacoesCampos.style.display = 'block';
        }
    }
    
    if (situacaoSelect) {
        situacaoSelect.addEventListener('change', toggleCamposResponsavel);
        // Verificar estado inicial
        toggleCamposResponsavel();
        
        // Se estiver editando, verificar situação inicial
        {% if object %}
        toggleCamposResponsavel();
        {% endif %}
    }
    
    // Inicializar Select2 para o campo de militar responsável (apenas quando visível)
    function inicializarSelect2Militar() {
        if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
            const militarSelect = $('#id_militar_responsavel');
            if (militarSelect.length && !militarSelect.hasClass('select2-hidden-accessible')) {
                militarSelect.select2({
                    placeholder: 'Digite o nome, matrícula ou posto do militar...',
                    allowClear: true,
                    minimumInputLength: 2,
                    language: {
                        inputTooShort: function () {
                            return 'Digite pelo menos 2 caracteres...';
                        },
                        noResults: function () {
                            return 'Nenhum militar encontrado';
                        },
                        searching: function () {
                            return 'Buscando...';
                        }
                    },
                    ajax: {
                        url: '{% url "militares:militar-autocomplete" %}',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term
                            };
                        },
                        processResults: function (data) {
                            return {
                                results: data.results
                            };
                        },
                        cache: true
                    }
                });
                
                // Se há um militar já selecionado (na edição), carregar os dados
                {% if object and object.militar_responsavel %}
                const militarId = {{ object.militar_responsavel.id }};
                const militarText = "{{ object.militar_responsavel.get_posto_graduacao_display }} {{ object.militar_responsavel.nome_completo }}{% if object.militar_responsavel.nome_guerra %} ({{ object.militar_responsavel.nome_guerra }}){% endif %} - Mat: {{ object.militar_responsavel.matricula }}";
                if (militarId) {
                    const option = new Option(militarText, militarId, true, true);
                    militarSelect.append(option).trigger('change');
                }
                {% endif %}
            }
        }
    }
    
    // Inicializar Select2 quando os campos de cautela individual forem mostrados
    if (situacaoSelect) {
        situacaoSelect.addEventListener('change', function() {
            if (this.value === 'CAUTELA_INDIVIDUAL') {
                setTimeout(inicializarSelect2Militar, 100);
            }
        });
        
        // Inicializar se já estiver em Cautela Individual
        if (situacaoSelect.value === 'CAUTELA_INDIVIDUAL') {
            setTimeout(inicializarSelect2Militar, 300);
        }
    }
    
    // Preencher campos automaticamente quando uma configuração de arma for selecionada
    const configuracaoSelect = document.getElementById('configuracao-arma-select');
    const tipoSelect = document.getElementById('id_tipo');
    const calibreSelect = document.getElementById('id_calibre');
    const marcaInput = document.getElementById('id_marca');
    const modeloInput = document.getElementById('id_modelo');
    const imagemPreview = document.getElementById('configuracao-imagem-preview');
    const imagemPreviewImg = document.getElementById('configuracao-imagem');
    
    if (configuracaoSelect) {
        configuracaoSelect.addEventListener('change', function() {
            const configuracaoId = this.value;
            
            // Limpar preview de imagem
            imagemPreview.style.display = 'none';
            
            if (!configuracaoId) {
                // Se nenhuma configuração selecionada, limpar campos (opcional)
                return;
            }
            
            // Buscar dados da configuração via AJAX
            const url = '{% url "militares:configuracao_arma_dados" 999 %}'.replace('999', configuracaoId);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Preencher campos
                        if (tipoSelect) {
                            tipoSelect.value = data.tipo;
                            // Disparar evento change para atualizar outros campos dependentes se necessário
                            tipoSelect.dispatchEvent(new Event('change'));
                        }
                        
                        if (calibreSelect) {
                            calibreSelect.value = data.calibre;
                            calibreSelect.dispatchEvent(new Event('change'));
                        }
                        
                        if (marcaInput) {
                            marcaInput.value = data.marca;
                        }
                        
                        if (modeloInput) {
                            modeloInput.value = data.modelo;
                        }
                        
                        // Mostrar preview da imagem se existir
                        if (data.imagem_url && imagemPreviewImg) {
                            imagemPreviewImg.src = data.imagem_url;
                            imagemPreview.style.display = 'block';
                        }
                        
                        // Feedback visual
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            Campos preenchidos automaticamente!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        configuracaoSelect.parentElement.appendChild(alertDiv);
                        
                        // Remover alerta após 3 segundos
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 3000);
                    } else {
                        console.error('Erro ao buscar configuração:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição:', error);
                });
        });
    }
});
</script>
{% endblock %}


