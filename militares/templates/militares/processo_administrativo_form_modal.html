<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarProcessoModalLabel">
        <i class="fas fa-folder-open me-2"></i>{% if is_create %}Criar Processo{% else %}Editar Processo{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formProcessoAdministrativo" method="post" action="{% if is_create %}{% url 'militares:processo_administrativo_create' %}{% else %}{% url 'militares:processo_administrativo_update' processo.pk %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                    {{ form.tipo.label }} <span class="text-danger">*</span>
                </label>
                {{ form.tipo }}
                {% if form.tipo.errors %}
                    <div class="text-danger small">{{ form.tipo.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero.id_for_label }}" class="form-label">
                    {{ form.numero.label }} <span class="text-danger">*</span>
                </label>
                {{ form.numero }}
                {% if form.numero.errors %}
                    <div class="text-danger small">{{ form.numero.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    {{ form.status.label }} <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.assunto.id_for_label }}" class="form-label">
                {{ form.assunto.label }} <span class="text-danger">*</span>
            </label>
            {{ form.assunto }}
            {% if form.assunto.errors %}
                <div class="text-danger small">{{ form.assunto.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.descricao.id_for_label }}" class="form-label">
                {{ form.descricao.label }} <span class="text-danger">*</span>
            </label>
            {{ form.descricao }}
            {% if form.descricao.errors %}
                <div class="text-danger small">{{ form.descricao.errors }}</div>
            {% endif %}
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.prioridade.id_for_label }}" class="form-label">
                    {{ form.prioridade.label }} <span class="text-danger">*</span>
                </label>
                {{ form.prioridade }}
                {% if form.prioridade.errors %}
                    <div class="text-danger small">{{ form.prioridade.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_abertura.id_for_label }}" class="form-label">
                    {{ form.data_abertura.label }} <span class="text-danger">*</span>
                </label>
                <input type="date" 
                       id="{{ form.data_abertura.id_for_label }}" 
                       name="{{ form.data_abertura.name }}" 
                       class="form-control"
                       value="{% if form.instance.pk and form.instance.data_abertura %}{{ form.instance.data_abertura|date:'Y-m-d' }}{% elif form.data_abertura.value %}{{ form.data_abertura.value }}{% endif %}"
                       required>
                {% if form.data_abertura.errors %}
                    <div class="text-danger small">{{ form.data_abertura.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_prazo.id_for_label }}" class="form-label">
                    {{ form.data_prazo.label }}
                </label>
                <input type="date" 
                       id="{{ form.data_prazo.id_for_label }}" 
                       name="{{ form.data_prazo.name }}" 
                       class="form-control"
                       value="{% if form.instance.pk and form.instance.data_prazo %}{{ form.instance.data_prazo|date:'Y-m-d' }}{% elif form.data_prazo.value %}{{ form.data_prazo.value }}{% endif %}">
                {% if form.data_prazo.errors %}
                    <div class="text-danger small">{{ form.data_prazo.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_conclusao.id_for_label }}" class="form-label">
                    {{ form.data_conclusao.label }}
                </label>
                <input type="date" 
                       id="{{ form.data_conclusao.id_for_label }}" 
                       name="{{ form.data_conclusao.name }}" 
                       class="form-control"
                       value="{% if form.instance.pk and form.instance.data_conclusao %}{{ form.instance.data_conclusao|date:'Y-m-d' }}{% elif form.data_conclusao.value %}{{ form.data_conclusao.value }}{% endif %}">
                {% if form.data_conclusao.errors %}
                    <div class="text-danger small">{{ form.data_conclusao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_arquivamento.id_for_label }}" class="form-label">
                    {{ form.data_arquivamento.label }}
                </label>
                <input type="date" 
                       id="{{ form.data_arquivamento.id_for_label }}" 
                       name="{{ form.data_arquivamento.name }}" 
                       class="form-control"
                       value="{% if form.instance.pk and form.instance.data_arquivamento %}{{ form.instance.data_arquivamento|date:'Y-m-d' }}{% elif form.data_arquivamento.value %}{{ form.data_arquivamento.value }}{% endif %}">
                {% if form.data_arquivamento.errors %}
                    <div class="text-danger small">{{ form.data_arquivamento.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Processos Relacionados -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.processo_origem.id_for_label }}" class="form-label">
                    <i class="fas fa-arrow-left me-2"></i>{{ form.processo_origem.label }}
                </label>
                <input type="text" 
                       id="{{ form.processo_origem.id_for_label }}" 
                       name="{{ form.processo_origem.name }}" 
                       class="form-control"
                       placeholder="Ex: PA-2025-001"
                       value="{% if form.processo_origem.value %}{{ form.processo_origem.value }}{% endif %}"
                       style="text-transform: uppercase;">
                {% if form.processo_origem.errors %}
                    <div class="text-danger small">{{ form.processo_origem.errors }}</div>
                {% endif %}
                <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Digite o número do processo que deu origem a este processo</small>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.processo_procedimento.id_for_label }}" class="form-label">
                    <i class="fas fa-link me-2"></i>{{ form.processo_procedimento.label }}
                </label>
                <input type="text" 
                       id="{{ form.processo_procedimento.id_for_label }}" 
                       name="{{ form.processo_procedimento.name }}" 
                       class="form-control"
                       placeholder="Ex: PA-2025-001"
                       value="{% if form.processo_procedimento.value %}{{ form.processo_procedimento.value }}{% endif %}"
                       style="text-transform: uppercase;">
                {% if form.processo_procedimento.errors %}
                    <div class="text-danger small">{{ form.processo_procedimento.errors }}</div>
                {% endif %}
                <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Digite o número do processo no qual foi realizado o procedimento relacionado</small>
            </div>
        </div>
        
        <!-- Militares Envolvidos -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-users me-2"></i>{{ form.militares_envolvidos.label }}
                </h6>
            </div>
            <div class="card-body">
                <!-- Campo de Pesquisa -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="pesquisaEnvolvidos" 
                               placeholder="Digite nome, nome de guerra ou matrícula..." 
                               onkeyup="pesquisarMilitares('envolvidos')">
                        <button class="btn btn-outline-secondary" type="button" onclick="limparPesquisa('envolvidos')">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- Campo hidden para armazenar IDs selecionados -->
                <div id="id_militares_envolvidos_container"></div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-list me-1"></i>Militares Disponíveis
                            </h6>
                            <span class="badge bg-primary" id="contadorDisponiveisEnvolvidos">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="listaMilitaresDisponiveisEnvolvidos">
                                <div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-success mb-0">
                                <i class="fas fa-check-circle me-1"></i>Militares Selecionados
                            </h6>
                            <span class="badge bg-success" id="contadorSelecionadosEnvolvidos">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="militaresSelecionadosEnvolvidos">
                                {% if form.instance.pk and form.instance.militares_envolvidos.exists %}
                                    {% for militar in form.instance.militares_envolvidos.all %}
                                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom militar-selecionado" data-id="{{ militar.id }}">
                                            <div>
                                                <div class="fw-bold text-primary">{{ militar.get_posto_graduacao_display }}</div>
                                                <strong>{{ militar.nome_completo }}</strong><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-id-card me-1"></i>{{ militar.matricula }}
                                                    {% if militar.nome_guerra %}<br><i class="fas fa-user-tag me-1"></i>{{ militar.nome_guerra }}{% endif %}
                                                </small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitar('envolvidos', {{ militar.id }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-muted py-3">Nenhum militar selecionado</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% if form.militares_envolvidos.errors %}
                    <div class="text-danger small mt-2">{{ form.militares_envolvidos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Militares Encarregados -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-user-tie me-2"></i>{{ form.militares_encarregados.label }}
                </h6>
            </div>
            <div class="card-body">
                <!-- Campo de Pesquisa -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="pesquisaEncarregados" 
                               placeholder="Digite nome, nome de guerra ou matrícula..." 
                               onkeyup="pesquisarMilitares('encarregados')">
                        <button class="btn btn-outline-secondary" type="button" onclick="limparPesquisa('encarregados')">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- Campo hidden para armazenar IDs selecionados -->
                <div id="id_militares_encarregados_container"></div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-list me-1"></i>Militares Disponíveis
                            </h6>
                            <span class="badge bg-primary" id="contadorDisponiveisEncarregados">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="listaMilitaresDisponiveisEncarregados">
                                <div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-success mb-0">
                                <i class="fas fa-check-circle me-1"></i>Militares Selecionados
                            </h6>
                            <span class="badge bg-success" id="contadorSelecionadosEncarregados">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="militaresSelecionadosEncarregados">
                                {% if form.instance.pk and form.instance.militares_encarregados.exists %}
                                    {% for militar in form.instance.militares_encarregados.all %}
                                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom militar-selecionado" data-id="{{ militar.id }}">
                                            <div>
                                                <div class="fw-bold text-primary">{{ militar.get_posto_graduacao_display }}</div>
                                                <strong>{{ militar.nome_completo }}</strong><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-id-card me-1"></i>{{ militar.matricula }}
                                                    {% if militar.nome_guerra %}<br><i class="fas fa-user-tag me-1"></i>{{ militar.nome_guerra }}{% endif %}
                                                </small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitar('encarregados', {{ militar.id }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-muted py-3">Nenhum militar selecionado</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% if form.militares_encarregados.errors %}
                    <div class="text-danger small mt-2">{{ form.militares_encarregados.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Escribões -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-pen-fancy me-2"></i>{{ form.escrivaos.label }}
                </h6>
            </div>
            <div class="card-body">
                <!-- Campo de Pesquisa -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="pesquisaEscribaos" 
                               placeholder="Digite nome, nome de guerra ou matrícula..." 
                               onkeyup="pesquisarMilitares('escrivaos')">
                        <button class="btn btn-outline-secondary" type="button" onclick="limparPesquisa('escrivaos')">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- Campo hidden para armazenar IDs selecionados -->
                <div id="id_escrivaos_container"></div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-list me-1"></i>Militares Disponíveis
                            </h6>
                            <span class="badge bg-primary" id="contadorDisponiveisEscribaos">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="listaMilitaresDisponiveisEscribaos">
                                <div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-success mb-0">
                                <i class="fas fa-check-circle me-1"></i>Militares Selecionados
                            </h6>
                            <span class="badge bg-success" id="contadorSelecionadosEscribaos">0</span>
                        </div>
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <div id="militaresSelecionadosEscribaos">
                                {% if form.instance.pk and form.instance.escrivaos.exists %}
                                    {% for militar in form.instance.escrivaos.all %}
                                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom militar-selecionado" data-id="{{ militar.id }}">
                                            <div>
                                                <div class="fw-bold text-primary">{{ militar.get_posto_graduacao_display }}</div>
                                                <strong>{{ militar.nome_completo }}</strong><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-id-card me-1"></i>{{ militar.matricula }}
                                                    {% if militar.nome_guerra %}<br><i class="fas fa-user-tag me-1"></i>{{ militar.nome_guerra }}{% endif %}
                                                </small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitar('escrivaos', {{ militar.id }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-muted py-3">Nenhum militar selecionado</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% if form.escrivaos.errors %}
                    <div class="text-danger small mt-2">{{ form.escrivaos.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Organograma (OM) - Campo único -->
        <div class="mb-3">
            <label for="organograma-select" class="form-label">
                <i class="fas fa-building me-2"></i>Organização Militar (OM)
            </label>
            <select id="organograma-select" class="form-select" style="width: 100%;">
                <option value="">Selecione uma opção do organograma...</option>
            </select>
            <!-- Campos ocultos para armazenar os valores do organograma -->
            {{ form.orgao.as_hidden }}
            {{ form.grande_comando.as_hidden }}
            {{ form.unidade.as_hidden }}
            {{ form.sub_unidade.as_hidden }}
            <small class="form-text text-muted">Selecione a organização militar</small>
            {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
                <div class="text-danger small">
                    {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
                    {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
                    {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
                    {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                {{ form.observacoes.label }}
            </label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="text-danger small">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                {{ form.ativo }}
                <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                    {{ form.ativo.label }}
                </label>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Variáveis globais para armazenar militares disponíveis
    let militaresDisponiveisEnvolvidos = [];
    let militaresDisponiveisEncarregados = [];
    let militaresDisponiveisEscribaos = [];
    
    // Função para carregar militares disponíveis
    async function carregarMilitaresDisponiveis(tipo, termoPesquisa = '') {
        try {
            let url = '{% url "militares:militares_disponiveis_ajax" %}';
            if (termoPesquisa) {
                url += `?q=${encodeURIComponent(termoPesquisa)}`;
            }
            
            const response = await fetch(url, {
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (tipo === 'envolvidos') {
                    militaresDisponiveisEnvolvidos = data.militares;
                    exibirMilitaresDisponiveis('envolvidos', data.militares);
                } else if (tipo === 'encarregados') {
                    militaresDisponiveisEncarregados = data.militares;
                    exibirMilitaresDisponiveis('encarregados', data.militares);
                } else if (tipo === 'escrivaos') {
                    militaresDisponiveisEscribaos = data.militares;
                    exibirMilitaresDisponiveis('escrivaos', data.militares);
                }
            } else {
                console.error('Erro ao carregar militares:', data.error);
                mostrarErro(tipo, 'Erro ao carregar militares: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro na requisição:', error);
            mostrarErro(tipo, 'Erro ao carregar militares: ' + error.message);
        }
    }
    
    // Função para exibir militares disponíveis
    function exibirMilitaresDisponiveis(tipo, militares) {
        // Mapear tipo para o ID correto
        let containerId, contadorId, selecionadosContainerId;
        if (tipo === 'envolvidos') {
            containerId = 'listaMilitaresDisponiveisEnvolvidos';
            contadorId = 'contadorDisponiveisEnvolvidos';
            selecionadosContainerId = 'militaresSelecionadosEnvolvidos';
        } else if (tipo === 'encarregados') {
            containerId = 'listaMilitaresDisponiveisEncarregados';
            contadorId = 'contadorDisponiveisEncarregados';
            selecionadosContainerId = 'militaresSelecionadosEncarregados';
        } else if (tipo === 'escrivaos') {
            containerId = 'listaMilitaresDisponiveisEscribaos';
            contadorId = 'contadorDisponiveisEscribaos';
            selecionadosContainerId = 'militaresSelecionadosEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const container = document.getElementById(containerId);
        const contador = document.getElementById(contadorId);
        
        if (!container) {
            console.error('Container não encontrado:', containerId);
            return;
        }
        
        // Obter IDs dos militares já selecionados
        const selecionados = Array.from(document.querySelectorAll(`#${selecionadosContainerId} .militar-selecionado`))
            .map(item => item.getAttribute('data-id'));
        
        if (militares.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">Nenhum militar encontrado</div>';
            if (contador) contador.textContent = '0';
            return;
        }
        
        container.innerHTML = militares.map(militar => {
            const jaSelecionado = selecionados.includes(militar.id.toString());
            const nomeEscapado = (militar.nome_completo || '').replace(/'/g, "\\'");
            const postoEscapado = (militar.posto_display || militar.posto_graduacao || '').replace(/'/g, "\\'");
            
            let botaoHtml = '';
            if (jaSelecionado) {
                botaoHtml = `
                    <button type="button" class="btn btn-sm btn-success ms-2" disabled title="Já selecionado">
                        <i class="fas fa-check"></i>
                    </button>
                `;
            } else {
                botaoHtml = `
                    <button type="button" class="btn btn-sm btn-outline-success ms-2" 
                            onclick="adicionarMilitar('${tipo}', ${militar.id}, '${nomeEscapado}', '${postoEscapado}')"
                            title="Adicionar">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
            }
            
            return `
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom militar-item" 
                     data-id="${militar.id}"
                     data-nome="${(militar.nome_completo || '').toLowerCase()}" 
                     data-nome-guerra="${(militar.nome_guerra || '').toLowerCase()}"
                     data-posto="${(militar.posto_graduacao || '').toLowerCase()}"
                     data-matricula="${(militar.matricula || '').toLowerCase()}">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="text-primary me-2">${militar.posto_display || militar.posto_graduacao || ''}</strong>
                        </div>
                        <div class="fw-bold text-dark">${militar.nome_completo || ''}</div>
                        ${militar.nome_guerra ? `<div class="text-muted small"><i class="fas fa-user-tag me-1"></i>${militar.nome_guerra}</div>` : ''}
                        <div class="text-muted small">
                            <i class="fas fa-id-card me-1"></i>${militar.matricula || ''}
                        </div>
                    </div>
                    ${botaoHtml}
                </div>
            `;
        }).join('');
        
        if (contador) contador.textContent = militares.length;
    }
    
    // Função para adicionar militar
    window.adicionarMilitar = function(tipo, militarId, nomeCompleto, postoDisplay) {
        // Mapear tipo para os IDs corretos
        let containerId, contadorId;
        if (tipo === 'envolvidos') {
            containerId = 'militaresSelecionadosEnvolvidos';
            contadorId = 'contadorSelecionadosEnvolvidos';
        } else if (tipo === 'encarregados') {
            containerId = 'militaresSelecionadosEncarregados';
            contadorId = 'contadorSelecionadosEncarregados';
        } else if (tipo === 'escrivaos') {
            containerId = 'militaresSelecionadosEscribaos';
            contadorId = 'contadorSelecionadosEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const containerSelecionados = document.getElementById(containerId);
        const contadorSelecionados = document.getElementById(contadorId);
        
        if (!containerSelecionados) {
            console.error('Container não encontrado:', containerId);
            return;
        }
        
        // Verificar se já está selecionado
        const jaSelecionado = containerSelecionados.querySelector(`.militar-selecionado[data-id="${militarId}"]`);
        if (jaSelecionado) return;
        
        // Buscar dados completos do militar
        let militarData = null;
        if (tipo === 'envolvidos') {
            militarData = militaresDisponiveisEnvolvidos.find(m => m.id === militarId);
        } else if (tipo === 'encarregados') {
            militarData = militaresDisponiveisEncarregados.find(m => m.id === militarId);
        } else if (tipo === 'escrivaos') {
            militarData = militaresDisponiveisEscribaos.find(m => m.id === militarId);
        }
        
        if (!militarData) {
            militarData = { id: militarId, nome_completo: nomeCompleto, posto_display: postoDisplay, matricula: '', nome_guerra: '' };
        }
        
        // Adicionar à lista de selecionados
        const novoItem = document.createElement('div');
        novoItem.className = 'd-flex justify-content-between align-items-center p-2 border-bottom militar-selecionado';
        novoItem.setAttribute('data-id', militarId);
        novoItem.innerHTML = `
            <div>
                <div class="fw-bold text-primary">${militarData.posto_display || postoDisplay}</div>
                <strong>${militarData.nome_completo || nomeCompleto}</strong><br>
                <small class="text-muted">
                    <i class="fas fa-id-card me-1"></i>${militarData.matricula || ''}
                    ${militarData.nome_guerra ? `<br><i class="fas fa-user-tag me-1"></i>${militarData.nome_guerra}` : ''}
                </small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMilitar('${tipo}', ${militarId})">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Remover mensagem de vazio se existir
        const mensagemVazia = containerSelecionados.querySelector('.text-center.text-muted');
        if (mensagemVazia) mensagemVazia.remove();
        
        containerSelecionados.appendChild(novoItem);
        
        // Atualizar campo hidden
        atualizarCampoHidden(tipo);
        
        // Atualizar contador
        const selecionados = containerSelecionados.querySelectorAll('.militar-selecionado');
        if (contadorSelecionados) contadorSelecionados.textContent = selecionados.length;
        
        // Atualizar lista de disponíveis para marcar como selecionado
        exibirMilitaresDisponiveis(tipo, tipo === 'envolvidos' ? militaresDisponiveisEnvolvidos : 
                                           tipo === 'encarregados' ? militaresDisponiveisEncarregados : 
                                           militaresDisponiveisEscribaos);
    };
    
    // Função para remover militar
    window.removerMilitar = function(tipo, militarId) {
        // Mapear tipo para os IDs corretos
        let containerId, contadorId;
        if (tipo === 'envolvidos') {
            containerId = 'militaresSelecionadosEnvolvidos';
            contadorId = 'contadorSelecionadosEnvolvidos';
        } else if (tipo === 'encarregados') {
            containerId = 'militaresSelecionadosEncarregados';
            contadorId = 'contadorSelecionadosEncarregados';
        } else if (tipo === 'escrivaos') {
            containerId = 'militaresSelecionadosEscribaos';
            contadorId = 'contadorSelecionadosEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const containerSelecionados = document.getElementById(containerId);
        const contadorSelecionados = document.getElementById(contadorId);
        
        if (!containerSelecionados) {
            console.error('Container não encontrado:', containerId);
            return;
        }
        
        const item = containerSelecionados.querySelector(`.militar-selecionado[data-id="${militarId}"]`);
        if (item) {
            item.remove();
            
            // Se não há mais selecionados, mostrar mensagem
            const selecionados = containerSelecionados.querySelectorAll('.militar-selecionado');
            if (selecionados.length === 0) {
                containerSelecionados.innerHTML = '<div class="text-center text-muted py-3">Nenhum militar selecionado</div>';
            }
            
            // Atualizar campo hidden
            atualizarCampoHidden(tipo);
            
            // Atualizar contador
            if (contadorSelecionados) contadorSelecionados.textContent = selecionados.length - 1;
            
            // Atualizar lista de disponíveis
            exibirMilitaresDisponiveis(tipo, tipo === 'envolvidos' ? militaresDisponiveisEnvolvidos : 
                                               tipo === 'encarregados' ? militaresDisponiveisEncarregados : 
                                               militaresDisponiveisEscribaos);
        }
    };
    
    // Função para atualizar campo hidden do formulário
    function atualizarCampoHidden(tipo) {
        // Mapear tipo para os IDs corretos
        let containerId, containerHiddenId, fieldName;
        if (tipo === 'envolvidos') {
            containerId = 'militaresSelecionadosEnvolvidos';
            containerHiddenId = 'id_militares_envolvidos_container';
            fieldName = 'militares_envolvidos';
        } else if (tipo === 'encarregados') {
            containerId = 'militaresSelecionadosEncarregados';
            containerHiddenId = 'id_militares_encarregados_container';
            fieldName = 'militares_encarregados';
        } else if (tipo === 'escrivaos') {
            containerId = 'militaresSelecionadosEscribaos';
            containerHiddenId = 'id_escrivaos_container';
            fieldName = 'escrivaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const containerSelecionados = document.getElementById(containerId);
        const containerHidden = document.getElementById(containerHiddenId);
        
        if (!containerSelecionados || !containerHidden) {
            console.error('Containers não encontrados:', containerId, containerHiddenId);
            return;
        }
        
        const selecionados = Array.from(containerSelecionados.querySelectorAll('.militar-selecionado'))
            .map(item => item.getAttribute('data-id'));
        
        // Limpar inputs anteriores
        containerHidden.innerHTML = '';
        
        // Criar inputs hidden para cada ID selecionado
        selecionados.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = fieldName;
            input.value = id;
            containerHidden.appendChild(input);
        });
    }
    
    // Variável para debounce da pesquisa
    let timeoutPesquisa = {};
    
    // Função para pesquisar militares
    window.pesquisarMilitares = function(tipo) {
        // Mapear tipo para o ID correto do input e container
        let inputId, containerId;
        if (tipo === 'envolvidos') {
            inputId = 'pesquisaEnvolvidos';
            containerId = 'listaMilitaresDisponiveisEnvolvidos';
        } else if (tipo === 'encarregados') {
            inputId = 'pesquisaEncarregados';
            containerId = 'listaMilitaresDisponiveisEncarregados';
        } else if (tipo === 'escrivaos') {
            inputId = 'pesquisaEscribaos';
            containerId = 'listaMilitaresDisponiveisEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const input = document.getElementById(inputId);
        if (!input) {
            console.error('Input não encontrado:', inputId);
            return;
        }
        
        // Limpar timeout anterior
        if (timeoutPesquisa[tipo]) {
            clearTimeout(timeoutPesquisa[tipo]);
        }
        
        // Mostrar loading
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</div>';
        }
        
        // Debounce: aguardar 300ms após parar de digitar
        timeoutPesquisa[tipo] = setTimeout(() => {
            const termo = input.value.trim();
            carregarMilitaresDisponiveis(tipo, termo);
        }, 300);
    };
    
    // Função para limpar pesquisa
    window.limparPesquisa = function(tipo) {
        // Mapear tipo para o ID correto do input
        let inputId;
        if (tipo === 'envolvidos') {
            inputId = 'pesquisaEnvolvidos';
        } else if (tipo === 'encarregados') {
            inputId = 'pesquisaEncarregados';
        } else if (tipo === 'escrivaos') {
            inputId = 'pesquisaEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            carregarMilitaresDisponiveis(tipo, '');
        }
    };
    
    // Função auxiliar para capitalizar
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    // Função para mostrar erro
    function mostrarErro(tipo, mensagem) {
        let containerId;
        if (tipo === 'envolvidos') {
            containerId = 'listaMilitaresDisponiveisEnvolvidos';
        } else if (tipo === 'encarregados') {
            containerId = 'listaMilitaresDisponiveisEncarregados';
        } else if (tipo === 'escrivaos') {
            containerId = 'listaMilitaresDisponiveisEscribaos';
        } else {
            console.error('Tipo inválido:', tipo);
            return;
        }
        
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `<div class="alert alert-danger">${mensagem}</div>`;
        }
    }
    
    // Inicializar carregamento de militares
    function inicializar() {
        // Verificar se os elementos existem antes de inicializar
        const elementosExistem = 
            document.getElementById('listaMilitaresDisponiveisEnvolvidos') &&
            document.getElementById('listaMilitaresDisponiveisEncarregados') &&
            document.getElementById('listaMilitaresDisponiveisEscribaos');
        
        if (!elementosExistem) {
            // Tentar novamente após um pequeno delay (para modais carregados via AJAX)
            setTimeout(inicializar, 100);
            return;
        }
        
        carregarMilitaresDisponiveis('envolvidos');
        carregarMilitaresDisponiveis('encarregados');
        carregarMilitaresDisponiveis('escrivaos');
        
        // Atualizar campos hidden iniciais
        atualizarCampoHidden('envolvidos');
        atualizarCampoHidden('encarregados');
        atualizarCampoHidden('escrivaos');
        
        // Atualizar contadores iniciais
        const tipos = [
            { tipo: 'envolvidos', containerId: 'militaresSelecionadosEnvolvidos', contadorId: 'contadorSelecionadosEnvolvidos' },
            { tipo: 'encarregados', containerId: 'militaresSelecionadosEncarregados', contadorId: 'contadorSelecionadosEncarregados' },
            { tipo: 'escrivaos', containerId: 'militaresSelecionadosEscribaos', contadorId: 'contadorSelecionadosEscribaos' }
        ];
        
        tipos.forEach(({ containerId, contadorId }) => {
            const container = document.getElementById(containerId);
            const contador = document.getElementById(contadorId);
            if (container && contador) {
                const selecionados = container.querySelectorAll('.militar-selecionado');
                contador.textContent = selecionados.length;
            }
        });
    }
    
    // Executar inicialização
    function tentarInicializar() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tentarInicializar);
        } else {
            inicializar();
        }
    }
    
    tentarInicializar();
    
    // Funcionalidade de numeração automática do processo
    (function() {
        const campoTipo = document.getElementById('id_tipo');
        const campoNumero = document.getElementById('id_numero');
        
        if (!campoTipo || !campoNumero) return;
        
        // Armazenar o tipo inicial para comparar mudanças
        let tipoAnterior = campoTipo.value;
        
        // Função para gerar número automático
        async function gerarNumeroAutomatico() {
            const tipo = campoTipo.value;
            
            // Só gerar se o tipo estiver selecionado
            if (!tipo) {
                return;
            }
            
            try {
                // Mostrar loading no campo número
                campoNumero.style.opacity = '0.6';
                campoNumero.disabled = true;
                
                const response = await fetch(`{% url "militares:processo_administrativo_proximo_numero" %}?tipo=${encodeURIComponent(tipo)}`, {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    campoNumero.value = data.numero;
                    tipoAnterior = tipo; // Atualizar tipo anterior
                }
            } catch (error) {
                console.error('Erro ao gerar número automático:', error);
            } finally {
                // Restaurar campo
                campoNumero.style.opacity = '1';
                campoNumero.disabled = false;
            }
        }
        
        // Observar mudanças no campo tipo
        campoTipo.addEventListener('change', function() {
            // Sempre atualizar o número quando o tipo mudar
            if (campoTipo.value && campoTipo.value !== tipoAnterior) {
                gerarNumeroAutomatico();
            }
        });
        
        // Se for criação e já tiver tipo, gerar número inicial
        {% if is_create %}
        if (campoTipo.value) {
            gerarNumeroAutomatico();
        }
        {% endif %}
    })();
    
    // Funcionalidade de seleção hierárquica única do organograma
    let organogramaSelect = document.getElementById('organograma-select');
    let orgaoHidden = document.getElementById('id_orgao');
    let grandeComandoHidden = document.getElementById('id_grande_comando');
    let unidadeHidden = document.getElementById('id_unidade');
    let subUnidadeHidden = document.getElementById('id_sub_unidade');
    
    // Função para carregar toda a hierarquia do organograma (tornada global para acesso externo)
    window.carregarOrganogramaCompleto = async function() {
        // Atualizar referências dos elementos
        organogramaSelect = document.getElementById('organograma-select');
        orgaoHidden = document.getElementById('id_orgao');
        grandeComandoHidden = document.getElementById('id_grande_comando');
        unidadeHidden = document.getElementById('id_unidade');
        subUnidadeHidden = document.getElementById('id_sub_unidade');
        
        if (!organogramaSelect) {
            console.warn('organogramaSelect não encontrado');
            return;
        }
        
        try {
            // Mostrar loading
            organogramaSelect.innerHTML = '<option value="">Carregando organograma...</option>';
            organogramaSelect.disabled = true;
            
            const url = '{% url "militares:ajax_organograma_completo" %}';
            console.log('Carregando organograma de:', url);
            
            const response = await fetch(url, {
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Dados do organograma recebidos:', data);
            
            if (!data.hierarquia || !Array.isArray(data.hierarquia)) {
                throw new Error('Resposta inválida: hierarquia não encontrada');
            }
            
            organogramaSelect.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                organogramaSelect.appendChild(option);
            });
            
            organogramaSelect.disabled = false;
            
            // Selecionar opção atual se estiver editando
            {% if form.instance.pk %}
            selecionarOpcaoAtual();
            {% endif %}
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
            organogramaSelect.innerHTML = '<option value="">Erro ao carregar organograma. Tente recarregar a página.</option>';
            organogramaSelect.disabled = false;
        }
    };
    
    // Função para selecionar a opção atual baseada nos valores dos campos ocultos
    function selecionarOpcaoAtual() {
        if (!organogramaSelect || !orgaoHidden) return;
        
        const orgaoId = orgaoHidden.value ? parseInt(orgaoHidden.value) : null;
        const grandeComandoId = grandeComandoHidden && grandeComandoHidden.value ? parseInt(grandeComandoHidden.value) : null;
        const unidadeId = unidadeHidden && unidadeHidden.value ? parseInt(unidadeHidden.value) : null;
        const subUnidadeId = subUnidadeHidden && subUnidadeHidden.value ? parseInt(subUnidadeHidden.value) : null;
        
        // Encontrar a opção correspondente
        for (let option of organogramaSelect.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                if (subUnidadeId && valor.sub_unidade_id === subUnidadeId) {
                    organogramaSelect.value = option.value;
                    return;
                } else if (unidadeId && !subUnidadeId && valor.unidade_id === unidadeId && !valor.sub_unidade_id) {
                    organogramaSelect.value = option.value;
                    return;
                } else if (grandeComandoId && !unidadeId && valor.grande_comando_id === grandeComandoId && !valor.unidade_id) {
                    organogramaSelect.value = option.value;
                    return;
                } else if (orgaoId && !grandeComandoId && valor.orgao_id === orgaoId && !valor.grande_comando_id) {
                    organogramaSelect.value = option.value;
                    return;
                }
            }
        }
    }
    
    // Função para atualizar campos ocultos
    function atualizarCamposOcultos() {
        if (!organogramaSelect) return;
        
        const selectedOption = organogramaSelect.options[organogramaSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    // Função para inicializar organograma
    function inicializarOrganograma() {
        organogramaSelect = document.getElementById('organograma-select');
        orgaoHidden = document.getElementById('id_orgao');
        grandeComandoHidden = document.getElementById('id_grande_comando');
        unidadeHidden = document.getElementById('id_unidade');
        subUnidadeHidden = document.getElementById('id_sub_unidade');
        
        if (organogramaSelect && orgaoHidden) {
            // Verificar se já tem listener para evitar duplicação
            if (!organogramaSelect.hasAttribute('data-inicializado')) {
                organogramaSelect.setAttribute('data-inicializado', 'true');
                organogramaSelect.addEventListener('change', atualizarCamposOcultos);
            }
            // Chamar a função global
            if (typeof window.carregarOrganogramaCompleto === 'function') {
                window.carregarOrganogramaCompleto();
            }
            return true;
        }
        return false;
    }
    
    // Função para tentar inicializar organograma com retry
    function tentarInicializarOrganograma(tentativas = 0) {
        const maxTentativas = 10;
        
        if (tentativas >= maxTentativas) {
            console.error('Não foi possível inicializar organograma após', maxTentativas, 'tentativas');
            return;
        }
        
        if (!inicializarOrganograma()) {
            setTimeout(() => {
                tentarInicializarOrganograma(tentativas + 1);
            }, 100);
        } else {
            console.log('Organograma inicializado com sucesso');
        }
    }
    
    // Inicializar organograma após um pequeno delay (para modais carregados via AJAX)
    // Tentar múltiplas vezes para garantir que funcione
    setTimeout(() => {
        tentarInicializarOrganograma();
    }, 50);
    
    // Também tentar quando o modal for aberto (evento do Bootstrap)
    // Usar event delegation no document para capturar eventos de modais carregados dinamicamente
    document.addEventListener('shown.bs.modal', function(event) {
        const modalId = event.target.id;
        if (modalId === 'criarProcessoModal' || modalId === 'editarProcessoModal') {
            setTimeout(() => {
                tentarInicializarOrganograma();
            }, 100);
        }
    });
    
    // Submissão do formulário via AJAX
    const form = document.getElementById('formProcessoAdministrativo');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message || 'Processo salvo com sucesso!'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.insertBefore(alertDiv, document.body.firstChild);
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('criarProcessoModal') || document.getElementById('editarProcessoModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    if (data.html) {
                        const modalContent = document.getElementById('criarProcessoModalContent') || document.getElementById('editarProcessoModalContent');
                        if (modalContent) {
                            modalContent.innerHTML = data.html;
                        }
                    } else {
                        alert(data.message || 'Erro ao salvar. Verifique os campos.');
                    }
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Erro ao salvar. Tente novamente.');
            });
        });
    }
})();
</script>

