{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Afastamento{% endblock %}

{% block extra_css %}
<style>
.select2-container {
    width: 100% !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-ban me-2 text-warning"></i>
                        {% if object %}Editar Afastamento{% else %}Novo Afastamento{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando afastamento de {{ object.militar.nome_guerra }}{% else %}Registrar novo afastamento{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:afastamento_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar para Lista
                    </a>
                </div>
            </div>
            
            {% if form.non_field_errors %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Erro de Validação</strong>
                        </h5>
                        <hr>
                        {% for error in form.non_field_errors %}
                            <div class="mb-2 text-danger">{{ error|safe }}</div>
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados do Afastamento
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" enctype="multipart/form-data" novalidate>
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.militar.id_for_label }}" class="form-label">
                                            Militar <span class="text-danger">*</span>
                                        </label>
                                        {{ form.militar }}
                                        {% if form.militar.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.militar.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tipo_afastamento.id_for_label }}" class="form-label">
                                            Situação <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo_afastamento }}
                                        {% if form.tipo_afastamento.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.tipo_afastamento.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                            Data de Início <span class="text-danger">*</span>
                                        </label>
                                        {{ form.data_inicio }}
                                        {% if form.data_inicio.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.data_inicio.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_fim_prevista.id_for_label }}" class="form-label">
                                            Data de Fim Prevista
                                        </label>
                                        {{ form.data_fim_prevista }}
                                        {% if form.data_fim_prevista.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.data_fim_prevista.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_fim_real.id_for_label }}" class="form-label">
                                            Data de Fim Real
                                        </label>
                                        {{ form.data_fim_real }}
                                        {% if form.data_fim_real.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.data_fim_real.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <div class="alert alert-info">
                                            <strong><i class="fas fa-calendar-day me-2"></i>Duração do Afastamento:</strong>
                                            <span id="duracao-dias" class="fw-bold text-primary ms-2">-</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            Status <span class="text-danger">*</span>
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.status.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.documento_referencia.id_for_label }}" class="form-label">
                                            Documento de Referência
                                        </label>
                                        {{ form.documento_referencia }}
                                        {% if form.documento_referencia.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.documento_referencia.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                                            Número do Documento
                                        </label>
                                        {{ form.numero_documento }}
                                        {% if form.numero_documento.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.numero_documento.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.motivo.id_for_label }}" class="form-label">
                                            Motivo do Afastamento <span class="text-danger">*</span>
                                        </label>
                                        {{ form.motivo }}
                                        {% if form.motivo.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.motivo.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Seção de Documentos -->
                                <div class="mt-4 pt-4 border-top">
                                    <h6 class="mb-3">
                                        <i class="fas fa-file-upload me-2 text-primary"></i>Documentos do Afastamento
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Tipo do Documento</label>
                                            {{ documento_form.tipo }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Título do Documento</label>
                                            {{ documento_form.titulo }}
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Descrição</label>
                                            {{ documento_form.descricao }}
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Arquivo</label>
                                            {{ documento_form.arquivo }}
                                            <small class="form-text text-muted">Formatos aceitos: PDF, JPG, PNG, DOC, DOCX (máx. 10MB)</small>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>Você pode anexar documentos agora ou depois. Eles aparecerão na página de detalhes.</small>
                                    </div>
                                    {% if object and documentos %}
                                    <div class="mt-3">
                                        <h6 class="mb-2">
                                            <i class="fas fa-file-alt me-2"></i>Documentos Já Anexados ({{ documentos|length }})
                                        </h6>
                                        <div class="list-group">
                                            {% for doc in documentos %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ doc.get_tipo_display }}</strong> - {{ doc.titulo }}
                                                    {% if doc.descricao %}
                                                    <br><small class="text-muted">{{ doc.descricao }}</small>
                                                    {% endif %}
                                                    <br><small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>{{ doc.data_upload|date:"d/m/Y H:i" }}
                                                        <i class="fas fa-user me-1 ms-2"></i>{{ doc.upload_por.get_full_name|default:doc.upload_por.username }}
                                                    </small>
                                                </div>
                                                <div>
                                                    <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{% url 'militares:afastamento_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Informações
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                <small>
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Atenção:</strong> Ao criar um afastamento ativo, a situação do militar será automaticamente atualizada.
                                </small>
                            </p>
                            <p class="text-muted">
                                <small>
                                    <i class="fas fa-calendar-check me-1"></i>
                                    A data de fim prevista é opcional e pode ser preenchida posteriormente.
                                </small>
                            </p>
                            <p class="text-muted">
                                <small>
                                    <i class="fas fa-file-alt me-1"></i>
                                    Documento de referência e número são opcionais, mas recomendados para rastreabilidade.
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function calcularDias() {
    const dataInicio = document.getElementById('id_data_inicio').value;
    const dataFimReal = document.getElementById('id_data_fim_real').value;
    const dataFimPrevista = document.getElementById('id_data_fim_prevista').value;
    const duracaoSpan = document.getElementById('duracao-dias');
    
    if (!dataInicio) {
        duracaoSpan.textContent = '-';
        return;
    }
    
    let dataFim = null;
    if (dataFimReal) {
        dataFim = new Date(dataFimReal);
    } else if (dataFimPrevista) {
        dataFim = new Date(dataFimPrevista);
    } else {
        // Se não tem data de fim, calcular até hoje
        dataFim = new Date();
    }
    
    const inicio = new Date(dataInicio);
    const diffTime = Math.abs(dataFim - inicio);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 30) {
        duracaoSpan.textContent = `${diffDays} dia${diffDays !== 1 ? 's' : ''}`;
    } else if (diffDays < 365) {
        const meses = Math.floor(diffDays / 30);
        const dias = diffDays % 30;
        if (dias === 0) {
            duracaoSpan.textContent = `${meses} ${meses === 1 ? 'mês' : 'meses'}`;
        } else {
            duracaoSpan.textContent = `${meses} ${meses === 1 ? 'mês' : 'meses'} e ${dias} dia${dias !== 1 ? 's' : ''}`;
        }
    } else {
        const anos = Math.floor(diffDays / 365);
        const diasResto = diffDays % 365;
        const meses = Math.floor(diasResto / 30);
        if (meses === 0) {
            duracaoSpan.textContent = `${anos} ${anos === 1 ? 'ano' : 'anos'}`;
        } else {
            duracaoSpan.textContent = `${anos} ${anos === 1 ? 'ano' : 'anos'} e ${meses} ${meses === 1 ? 'mês' : 'meses'}`;
        }
    }
    
    // Atualizar quando as datas mudarem
    duracaoSpan.innerHTML += ` <span class="badge bg-secondary ms-2">${diffDays} dias</span>`;
}

// Função para garantir que datas estejam no formato yyyy-MM-dd para input type="date"
function formatarDataParaInput(dataStr) {
    if (!dataStr) return '';
    // Se já estiver no formato yyyy-MM-dd, retornar como está
    if (/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) return dataStr;
    // Se estiver no formato dd/MM/yyyy, converter
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dataStr)) {
        const partes = dataStr.split('/');
        return `${partes[2]}-${partes[1]}-${partes[0]}`;
    }
    return dataStr;
}

// Chamar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que todos os campos de data estão no formato correto
    const camposData = ['id_data_inicio', 'id_data_fim_prevista', 'id_data_fim_real'];
    camposData.forEach(function(campoId) {
        const campo = document.getElementById(campoId);
        if (campo && campo.value) {
            campo.value = formatarDataParaInput(campo.value);
        }
    });
    
    calcularDias();
    
    // Adicionar listeners para mudanças nas datas
    document.getElementById('id_data_inicio').addEventListener('change', calcularDias);
    document.getElementById('id_data_fim_prevista').addEventListener('change', calcularDias);
    document.getElementById('id_data_fim_real').addEventListener('change', calcularDias);
    
    // Inicializar Select2 para o campo de militar
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um militar já selecionado (na edição), carregar os dados
        {% if object and object.militar %}
        const militarId = {{ object.militar.id }};
        const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
        if (militarId) {
            const option = new Option(militarText, militarId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
    }
});
</script>
{% endblock %}

