<div class="modal-header bg-danger text-white">
    <h5 class="modal-title" id="excluirProcessoModalLabel">
        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <p>Tem certeza que deseja excluir o processo <strong>{{ processo.numero }}</strong>?</p>
    <p class="mb-0"><strong>Assunto:</strong> {{ processo.assunto }}</p>
    <div class="alert alert-warning mt-3">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Atenção:</strong> Esta ação não pode ser desfeita!
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <form method="post" action="{% url 'militares:processo_administrativo_delete' processo.pk %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-2"></i>Excluir
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('#excluirProcessoModalContent form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...';
            
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                // Verificar status antes de fazer parse do JSON
                if (!response.ok) {
                    // Tentar fazer parse do JSON mesmo em caso de erro (pode conter mensagem)
                    return response.json().then(data => {
                        throw { status: response.status, data: data };
                    }).catch(() => {
                        // Se não conseguir fazer parse, lançar erro genérico
                        throw { status: response.status, data: { message: 'Erro ao processar resposta do servidor.' } };
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert(data.message || 'Erro ao excluir.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                // Tratar erro 403 especificamente
                if (error.status === 403) {
                    alert(error.data?.message || 'Acesso negado. Você não tem permissão para realizar esta ação.');
                } else {
                    alert(error.data?.message || 'Erro ao excluir. Tente novamente.');
                }
            });
        });
    }
});
</script>

