<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="modalTempoUsoLabel">
        <i class="fas fa-clock me-2"></i>{% if is_create %}Novo Tempo de Uso{% else %}Editar Tempo de Uso{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formTempoUso" method="post" action="{% if is_create %}{% url 'militares:tempo_uso_create' equipamento_id|default:0 %}{% else %}{% url 'militares:tempo_uso_update' tempo_uso.pk %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.equipamento.id_for_label }}" class="form-label">
                    Equipamento <span class="text-danger">*</span>
                </label>
                {{ form.equipamento }}
                {% if form.equipamento.errors %}
                    <div class="text-danger small">{{ form.equipamento.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.operador.id_for_label }}" class="form-label">
                    Operador
                </label>
                {{ form.operador }}
                {% if form.operador.errors %}
                    <div class="text-danger small">{{ form.operador.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                    Data de Início <span class="text-danger">*</span>
                </label>
                {{ form.data_inicio }}
                {% if form.data_inicio.errors %}
                    <div class="text-danger small">{{ form.data_inicio.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.hora_inicio.id_for_label }}" class="form-label">
                    Hora de Início <span class="text-danger">*</span>
                </label>
                {{ form.hora_inicio }}
                {% if form.hora_inicio.errors %}
                    <div class="text-danger small">{{ form.hora_inicio.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                    Data de Fim
                </label>
                {{ form.data_fim }}
                {% if form.data_fim.errors %}
                    <div class="text-danger small">{{ form.data_fim.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.hora_fim.id_for_label }}" class="form-label">
                    Hora de Fim
                </label>
                {{ form.hora_fim }}
                {% if form.hora_fim.errors %}
                    <div class="text-danger small">{{ form.hora_fim.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_inicial.id_for_label }}" class="form-label">
                    Horas Inicial <span class="text-danger">*</span>
                </label>
                {{ form.horas_inicial }}
                {% if form.horas_inicial.errors %}
                    <div class="text-danger small">{{ form.horas_inicial.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Horas de uso do equipamento no início
                </small>
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_final.id_for_label }}" class="form-label">
                    Horas Final
                </label>
                {{ form.horas_final }}
                {% if form.horas_final.errors %}
                    <div class="text-danger small">{{ form.horas_final.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Horas de uso do equipamento no fim
                </small>
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.objetivo.id_for_label }}" class="form-label">
                    Objetivo <span class="text-danger">*</span>
                </label>
                {{ form.objetivo }}
                {% if form.objetivo.errors %}
                    <div class="text-danger small">{{ form.objetivo.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.local_uso.id_for_label }}" class="form-label">
                    Local de Uso
                </label>
                {{ form.local_uso }}
                {% if form.local_uso.errors %}
                    <div class="text-danger small">{{ form.local_uso.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Status <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                Observações
            </label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="text-danger small">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregar últimas horas do equipamento ao selecionar
    const equipamentoSelect = document.getElementById('id_equipamento');
    const horasInicialInput = document.getElementById('id_horas_inicial');
    
    if (equipamentoSelect && horasInicialInput) {
        equipamentoSelect.addEventListener('change', function() {
            const equipamentoId = this.value;
            if (equipamentoId) {
                fetch(`{% url 'militares:equipamento_ultimas_horas' 0 %}`.replace('0', equipamentoId), {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.horas) {
                        horasInicialInput.value = data.horas;
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
            }
        });
    }
    
    // Submissão do formulário via AJAX
    const form = document.getElementById('formTempoUso');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const url = form.getAttribute('action');
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        location.reload();
                    }
                } else {
                    // Atualizar modal com erros
                    if (data.html) {
                        document.getElementById('modalTempoUsoContent').innerHTML = data.html;
                        // Re-executar scripts
                        const scripts = document.getElementById('modalTempoUsoContent').querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            newScript.textContent = script.textContent;
                            document.body.appendChild(newScript);
                            script.remove();
                        });
                    } else {
                        alert(data.message || 'Erro ao salvar tempo de uso');
                    }
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar tempo de uso');
            });
        });
    }
});
</script>

