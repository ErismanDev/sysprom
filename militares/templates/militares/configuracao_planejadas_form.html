{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">{{ page_title }}</h1>
                    <p class="text-muted mb-0">Configure os parâmetros para planejadas dos militares</p>
                </div>
                <div>
                    <a href="{% url 'militares:configuracao_planejadas_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Configurações de Flexibilização - PRIMEIRO PARA DESTAQUE -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-warning shadow-lg">
                                    <div class="card-header bg-warning text-dark">
                                        <h4 class="mb-0">
                                            <i class="fas fa-unlock-alt me-2"></i>Flexibilização de Validações por Tipo - Autorização de Exceções
                                        </h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-warning border-warning mb-4">
                                            <h6 class="alert-heading">
                                                <i class="fas fa-exclamation-triangle me-2"></i>Atenção Importante
                                            </h6>
                                            <p class="mb-2"><strong>Esta configuração permite que militares sejam autorizados a participar de planejadas específicas (P1, P2, P3 ou P4) mesmo que não atendam a qualificação por tipo de planejada.</strong></p>
                                            <p class="mb-2">Quando ativada para um tipo específico, o sistema permitirá adicionar militares ignorando APENAS a validação de qualificação por tipo.</p>
                                            <p class="mb-2"><strong>As seguintes validações NÃO são flexibilizadas e continuam sendo aplicadas:</strong></p>
                                            <ul class="mb-2">
                                                <li><strong>Voluntário:</strong> Militar deve estar marcado como voluntário para operações</li>
                                                <li><strong>Situação PRONTO:</strong> Militar deve estar com situação PRONTO</li>
                                                <li><strong>Sem Gratificação:</strong> Militar não pode ter gratificação ativa</li>
                                                <li><strong>Conflitos com escalas:</strong> Militar não pode estar escalado de serviço no mesmo dia</li>
                                                <li><strong>Conflitos de horário:</strong> Militar não pode ter conflito de horário com outras planejadas</li>
                                                <li><strong>Folga suficiente:</strong> Militar deve ter folga suficiente após última escala</li>
                                                <li><strong>Limites mensais:</strong> Militar não pode ultrapassar o limite mensal de planejadas</li>
                                            </ul>
                                            <div class="alert alert-danger mb-0">
                                                <i class="fas fa-shield-alt me-2"></i>
                                                <strong>Use esta opção apenas em situações excepcionais, com autorização formal e documentada. Esta configuração deve ser ativada temporariamente e desativada após o uso.</strong>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-primary">
                                                    <div class="card-body">
                                                        <div class="form-check form-switch form-switch-lg">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   id="permitir_flexibilizacao_p1" 
                                                                   name="permitir_flexibilizacao_p1" 
                                                                   style="width: 50px; height: 25px;"
                                                                   {% if configuracao and configuracao.permitir_flexibilizacao_p1 %}checked{% elif configuracao_padrao and configuracao_padrao.permitir_flexibilizacao_p1 %}checked{% endif %}>
                                                            <label class="form-check-label fs-5 ms-3" for="permitir_flexibilizacao_p1" style="cursor: pointer;">
                                                                <strong>
                                                                    <span class="badge bg-primary me-2">P1</span>
                                                                    Flexibilizar Validações para P1
                                                                </strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-text mt-2 ms-5">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Permite adicionar militares em planejadas P1 mesmo sem qualificação específica.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-success">
                                                    <div class="card-body">
                                                        <div class="form-check form-switch form-switch-lg">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   id="permitir_flexibilizacao_p2" 
                                                                   name="permitir_flexibilizacao_p2" 
                                                                   style="width: 50px; height: 25px;"
                                                                   {% if configuracao and configuracao.permitir_flexibilizacao_p2 %}checked{% elif configuracao_padrao and configuracao_padrao.permitir_flexibilizacao_p2 %}checked{% endif %}>
                                                            <label class="form-check-label fs-5 ms-3" for="permitir_flexibilizacao_p2" style="cursor: pointer;">
                                                                <strong>
                                                                    <span class="badge bg-success me-2">P2</span>
                                                                    Flexibilizar Validações para P2
                                                                </strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-text mt-2 ms-5">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Permite adicionar militares em planejadas P2 mesmo sem qualificação específica.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-info">
                                                    <div class="card-body">
                                                        <div class="form-check form-switch form-switch-lg">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   id="permitir_flexibilizacao_p3" 
                                                                   name="permitir_flexibilizacao_p3" 
                                                                   style="width: 50px; height: 25px;"
                                                                   {% if configuracao and configuracao.permitir_flexibilizacao_p3 %}checked{% elif configuracao_padrao and configuracao_padrao.permitir_flexibilizacao_p3 %}checked{% endif %}>
                                                            <label class="form-check-label fs-5 ms-3" for="permitir_flexibilizacao_p3" style="cursor: pointer;">
                                                                <strong>
                                                                    <span class="badge bg-info me-2">P3</span>
                                                                    Flexibilizar Validações para P3
                                                                </strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-text mt-2 ms-5">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Permite adicionar militares em planejadas P3 mesmo sem qualificação específica.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-warning">
                                                    <div class="card-body">
                                                        <div class="form-check form-switch form-switch-lg">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   id="permitir_flexibilizacao_p4" 
                                                                   name="permitir_flexibilizacao_p4" 
                                                                   style="width: 50px; height: 25px;"
                                                                   {% if configuracao and configuracao.permitir_flexibilizacao_p4 %}checked{% elif configuracao_padrao and configuracao_padrao.permitir_flexibilizacao_p4 %}checked{% endif %}>
                                                            <label class="form-check-label fs-5 ms-3" for="permitir_flexibilizacao_p4" style="cursor: pointer;">
                                                                <strong>
                                                                    <span class="badge bg-warning text-dark me-2">P4</span>
                                                                    Flexibilizar Validações para P4
                                                                </strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-text mt-2 ms-5">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Permite adicionar militares em planejadas P4 mesmo sem qualificação específica.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if configuracao %}
                                            {% if configuracao.permitir_flexibilizacao_p1 or configuracao.permitir_flexibilizacao_p2 or configuracao.permitir_flexibilizacao_p3 or configuracao.permitir_flexibilizacao_p4 %}
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Status Atual:</strong> Flexibilização <strong class="text-success">ATIVADA</strong> para:
                                                <ul class="mb-0 mt-2">
                                                    {% if configuracao.permitir_flexibilizacao_p1 %}<li><strong>P1</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao.permitir_flexibilizacao_p2 %}<li><strong>P2</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao.permitir_flexibilizacao_p3 %}<li><strong>P3</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao.permitir_flexibilizacao_p4 %}<li><strong>P4</strong> - Validações ignoradas</li>{% endif %}
                                                </ul>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-secondary mt-3">
                                                <i class="fas fa-lock me-2"></i>
                                                <strong>Status Atual:</strong> Flexibilização <strong class="text-muted">DESATIVADA</strong> para todos os tipos. 
                                                Todas as validações automáticas do sistema estão sendo aplicadas normalmente.
                                            </div>
                                            {% endif %}
                                        {% elif configuracao_padrao %}
                                            {% if configuracao_padrao.permitir_flexibilizacao_p1 or configuracao_padrao.permitir_flexibilizacao_p2 or configuracao_padrao.permitir_flexibilizacao_p3 or configuracao_padrao.permitir_flexibilizacao_p4 %}
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Status Atual (Configuração Padrão):</strong> Flexibilização <strong class="text-success">ATIVADA</strong> para:
                                                <ul class="mb-0 mt-2">
                                                    {% if configuracao_padrao.permitir_flexibilizacao_p1 %}<li><strong>P1</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao_padrao.permitir_flexibilizacao_p2 %}<li><strong>P2</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao_padrao.permitir_flexibilizacao_p3 %}<li><strong>P3</strong> - Validações ignoradas</li>{% endif %}
                                                    {% if configuracao_padrao.permitir_flexibilizacao_p4 %}<li><strong>P4</strong> - Validações ignoradas</li>{% endif %}
                                                </ul>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-secondary mt-3">
                                                <i class="fas fa-lock me-2"></i>
                                                <strong>Status Atual:</strong> Flexibilização <strong class="text-muted">DESATIVADA</strong> para todos os tipos. 
                                                Todas as validações automáticas do sistema estão sendo aplicadas normalmente.
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="alert alert-secondary mt-3">
                                                <i class="fas fa-lock me-2"></i>
                                                <strong>Status Atual:</strong> Flexibilização <strong class="text-muted">DESATIVADA</strong> para todos os tipos. 
                                                Todas as validações automáticas do sistema estão sendo aplicadas normalmente.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações Básicas -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-cog me-2"></i>Configurações Básicas
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="quantidade_planejadas_por_militar_mes" class="form-label">
                                        Quantidade de Planejadas por Militar/Mês *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="quantidade_planejadas_por_militar_mes" 
                                           name="quantidade_planejadas_por_militar_mes" 
                                           value="{% if configuracao %}{{ configuracao.quantidade_planejadas_por_militar_mes }}{% elif configuracao_padrao %}{{ configuracao_padrao.quantidade_planejadas_por_militar_mes }}{% else %}4{% endif %}"
                                           min="1" 
                                           max="31" 
                                           required>
                                    <div class="form-text">Número máximo de planejadas que um militar pode ter por mês</div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- Valores por Planejada -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-money-bill-wave me-2"></i>Valores por Planejada
                                </h5>
                                <p class="text-muted">Configure o valor fixo por planejada - o sistema calculará automaticamente baseado no tipo e data da operação</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_por_hora_normal" class="form-label">
                                        Valor por Planejada - Dias Normais (R$) *
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="valor_por_hora_normal" 
                                           name="valor_por_hora_normal" 
                                           value="{% if configuracao %}{{ configuracao.valor_por_hora_normal|floatformat:2 }}{% elif configuracao_padrao %}{{ configuracao_padrao.valor_por_hora_normal|floatformat:2 }}{% else %}0.00{% endif %}"
                                           step="0.01" 
                                           min="0" 
                                           required>
                                    <div class="form-text">Valor fixo por planejada em dias normais</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_por_hora_fds" class="form-label">
                                        Valor por Planejada - Fins de Semana (R$) *
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="valor_por_hora_fds" 
                                           name="valor_por_hora_fds" 
                                           value="{% if configuracao %}{{ configuracao.valor_por_hora_fds|floatformat:2 }}{% elif configuracao_padrao %}{{ configuracao_padrao.valor_por_hora_fds|floatformat:2 }}{% else %}0.00{% endif %}"
                                           step="0.01" 
                                           min="0" 
                                           required>
                                    <div class="form-text">Valor fixo por planejada em fins de semana e feriados</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Exemplo de Cálculo -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-calculator me-2"></i>Exemplo de Cálculo Automático
                                    </h6>
                                    <p class="mb-2">Com base no valor por planejada configurado, o sistema calculará:</p>
                                    <ul class="mb-0">
                                        <li><strong>P1:</strong> Valor por planejada × 1 = 1 planejada</li>
                                        <li><strong>P2:</strong> Valor por planejada × 2 = 2 planejadas</li>
                                        <li><strong>P3:</strong> Valor por planejada × 3 = 3 planejadas</li>
                                        <li><strong>P4:</strong> Valor por planejada × 4 = 4 planejadas</li>
                                    </ul>
                                    <small class="text-muted">O sistema detectará automaticamente se é dia normal ou fim de semana baseado na data da operação.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações de Tipos de Planejadas -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-clock me-2"></i>Configurações de Tipos de Planejadas
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="horas_planejada_p1" class="form-label">
                                        Horas da Planejada P1 *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="horas_planejada_p1" 
                                           name="horas_planejada_p1" 
                                           value="{% if configuracao %}{{ configuracao.horas_planejada_p1 }}{% elif configuracao_padrao %}{{ configuracao_padrao.horas_planejada_p1 }}{% else %}6{% endif %}"
                                           min="1" 
                                           max="24" 
                                           required>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="horas_planejada_p2" class="form-label">
                                        Horas da Planejada P2 *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="horas_planejada_p2" 
                                           name="horas_planejada_p2" 
                                           value="{% if configuracao %}{{ configuracao.horas_planejada_p2 }}{% elif configuracao_padrao %}{{ configuracao_padrao.horas_planejada_p2 }}{% else %}12{% endif %}"
                                           min="1" 
                                           max="24" 
                                           required>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="horas_planejada_p3" class="form-label">
                                        Horas da Planejada P3 *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="horas_planejada_p3" 
                                           name="horas_planejada_p3" 
                                           value="{% if configuracao %}{{ configuracao.horas_planejada_p3 }}{% elif configuracao_padrao %}{{ configuracao_padrao.horas_planejada_p3 }}{% else %}18{% endif %}"
                                           min="1" 
                                           max="24" 
                                           required>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="horas_planejada_p4" class="form-label">
                                        Horas da Planejada P4 *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="horas_planejada_p4" 
                                           name="horas_planejada_p4" 
                                           value="{% if configuracao %}{{ configuracao.horas_planejada_p4 }}{% elif configuracao_padrao %}{{ configuracao_padrao.horas_planejada_p4 }}{% else %}24{% endif %}"
                                           min="1" 
                                           max="24" 
                                           required>
                                </div>
                            </div>
                        </div>


                        <!-- Configurações de Intervalos por Turno -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-hourglass-half me-2"></i>Configurações de Intervalos por Turno
                                </h5>
                                <p class="text-muted">Configure o intervalo mínimo após cada tipo de turno para poder fazer planejada</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="intervalo_turno_6h" class="form-label">
                                        Intervalo após Turno de 6h *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="intervalo_turno_6h" 
                                           name="intervalo_turno_6h" 
                                           value="{% if configuracao %}{{ configuracao.intervalo_turno_6h }}{% elif configuracao_padrao %}{{ configuracao_padrao.intervalo_turno_6h }}{% else %}6{% endif %}"
                                           min="1" 
                                           max="168" 
                                           required>
                                    <div class="form-text">Horas de folga após turno de 6h</div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="intervalo_turno_12h" class="form-label">
                                        Intervalo após Turno de 12h *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="intervalo_turno_12h" 
                                           name="intervalo_turno_12h" 
                                           value="{% if configuracao %}{{ configuracao.intervalo_turno_12h }}{% elif configuracao_padrao %}{{ configuracao_padrao.intervalo_turno_12h }}{% else %}12{% endif %}"
                                           min="1" 
                                           max="168" 
                                           required>
                                    <div class="form-text">Horas de folga após turno de 12h</div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="intervalo_turno_18h" class="form-label">
                                        Intervalo após Turno de 18h *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="intervalo_turno_18h" 
                                           name="intervalo_turno_18h" 
                                           value="{% if configuracao %}{{ configuracao.intervalo_turno_18h }}{% elif configuracao_padrao %}{{ configuracao_padrao.intervalo_turno_18h }}{% else %}18{% endif %}"
                                           min="1" 
                                           max="168" 
                                           required>
                                    <div class="form-text">Horas de folga após turno de 18h</div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="intervalo_turno_24h" class="form-label">
                                        Intervalo após Turno de 24h *
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="intervalo_turno_24h" 
                                           name="intervalo_turno_24h" 
                                           value="{% if configuracao %}{{ configuracao.intervalo_turno_24h }}{% elif configuracao_padrao %}{{ configuracao_padrao.intervalo_turno_24h }}{% else %}24{% endif %}"
                                           min="1" 
                                           max="168" 
                                           required>
                                    <div class="form-text">Horas de folga após turno de 24h</div>
                                </div>
                            </div>
                        </div>


                        <!-- Status e Observações -->
                        {% if configuracao %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-toggle-on me-2"></i>Status e Observações
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="ativo" 
                                               name="ativo" 
                                               {% if configuracao.ativo %}checked{% endif %}>
                                        <label class="form-check-label" for="ativo">
                                            Configuração Ativa
                                        </label>
                                    </div>
                                    <div class="form-text">Marque para ativar esta configuração (desativará as outras)</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" 
                                              id="observacoes" 
                                              name="observacoes" 
                                              rows="3" 
                                              placeholder="Observações sobre esta configuração...">{% if configuracao %}{{ configuracao.observacoes }}{% elif configuracao_padrao %}{{ configuracao_padrao.observacoes }}{% endif %}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar Configuração
                                    </button>
                                    <a href="{% url 'militares:configuracao_planejadas_list' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
