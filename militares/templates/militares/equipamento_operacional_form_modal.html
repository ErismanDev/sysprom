<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="modalEquipamentoLabel">
        <i class="fas fa-cog me-2"></i>{% if is_create %}Novo Equipamento Operacional{% else %}Editar Equipamento Operacional{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formEquipamentoOperacional" method="post" action="{% if is_create %}{% url 'militares:equipamento_operacional_create' %}{% else %}{% url 'militares:equipamento_operacional_update' equipamento.pk %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <!-- Identificação -->
        <h6 class="mb-3"><i class="fas fa-id-card me-2"></i>Identificação</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.codigo.id_for_label }}" class="form-label">
                    Código <span class="text-danger">*</span>
                </label>
                {{ form.codigo }}
                {% if form.codigo.errors %}
                    <div class="text-danger small">{{ form.codigo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                    Tipo <span class="text-danger">*</span>
                </label>
                {{ form.tipo }}
                {% if form.tipo.errors %}
                    <div class="text-danger small">{{ form.tipo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Status <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.marca.id_for_label }}" class="form-label">
                    Marca <span class="text-danger">*</span>
                </label>
                {{ form.marca }}
                {% if form.marca.errors %}
                    <div class="text-danger small">{{ form.marca.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.modelo.id_for_label }}" class="form-label">
                    Modelo <span class="text-danger">*</span>
                </label>
                {{ form.modelo }}
                {% if form.modelo.errors %}
                    <div class="text-danger small">{{ form.modelo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                    Número de Série
                </label>
                {{ form.numero_serie }}
                {% if form.numero_serie.errors %}
                    <div class="text-danger small">{{ form.numero_serie.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.ano_fabricacao.id_for_label }}" class="form-label">
                    Ano de Fabricação
                </label>
                {{ form.ano_fabricacao }}
                {% if form.ano_fabricacao.errors %}
                    <div class="text-danger small">{{ form.ano_fabricacao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_uso.id_for_label }}" class="form-label">
                    Horas de Uso
                </label>
                {{ form.horas_uso }}
                {% if form.horas_uso.errors %}
                    <div class="text-danger small">{{ form.horas_uso.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Total de horas de uso do equipamento
                </small>
            </div>
        </div>
        
        <hr>
        <h6 class="mb-3"><i class="fas fa-sitemap me-2"></i>Organização</h6>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.organograma_select.id_for_label }}" class="form-label">
                    Organização Militar <span class="text-danger">*</span>
                </label>
                {{ form.organograma_select }}
                {% if form.organograma_select.errors %}
                    <div class="text-danger small">{{ form.organograma_select.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Selecione a organização onde o equipamento está lotado
                </small>
            </div>
        </div>
        {{ form.orgao }}
        {{ form.grande_comando }}
        {{ form.unidade }}
        {{ form.sub_unidade }}
        
        <hr>
        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações Adicionais</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.data_aquisicao.id_for_label }}" class="form-label">
                    Data de Aquisição
                </label>
                {{ form.data_aquisicao }}
                {% if form.data_aquisicao.errors %}
                    <div class="text-danger small">{{ form.data_aquisicao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_aquisicao.id_for_label }}" class="form-label">
                    Valor de Aquisição (R$)
                </label>
                {{ form.valor_aquisicao }}
                {% if form.valor_aquisicao.errors %}
                    <div class="text-danger small">{{ form.valor_aquisicao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.fornecedor.id_for_label }}" class="form-label">
                    Fornecedor
                </label>
                {{ form.fornecedor }}
                {% if form.fornecedor.errors %}
                    <div class="text-danger small">{{ form.fornecedor.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                Observações
            </label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="text-danger small">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                {{ form.ativo }}
                <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                    Equipamento Ativo
                </label>
            </div>
            {% if form.ativo.errors %}
                <div class="text-danger small">{{ form.ativo.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregar organograma dinâmico
    if (typeof carregarOrganograma === 'function') {
        carregarOrganograma('organograma-select', {
            orgao: '{{ form.orgao.value|default:"" }}',
            grande_comando: '{{ form.grande_comando.value|default:"" }}',
            unidade: '{{ form.unidade.value|default:"" }}',
            sub_unidade: '{{ form.sub_unidade.value|default:"" }}'
        });
    }
    
    // Máscara para valor de aquisição
    const valorAquisicao = document.getElementById('id_valor_aquisicao');
    if (valorAquisicao) {
        valorAquisicao.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value) {
                value = (parseInt(value) / 100).toFixed(2);
                value = value.replace('.', ',');
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = 'R$ ' + value;
            }
        });
    }
    
    // Submissão do formulário via AJAX
    const form = document.getElementById('formEquipamentoOperacional');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            
            // Processar organograma
            const organogramaSelect = document.getElementById('organograma-select');
            if (organogramaSelect && organogramaSelect.value) {
                formData.append('organograma-select', organogramaSelect.value);
            }
            
            const url = form.getAttribute('action');
            const method = 'POST';
            
            fetch(url, {
                method: method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        location.reload();
                    }
                } else {
                    // Atualizar modal com erros
                    if (data.html) {
                        document.getElementById('modalEquipamentoContent').innerHTML = data.html;
                        // Re-executar scripts
                        const scripts = document.getElementById('modalEquipamentoContent').querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            newScript.textContent = script.textContent;
                            document.body.appendChild(newScript);
                            script.remove();
                        });
                    } else {
                        alert(data.message || 'Erro ao salvar equipamento');
                    }
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar equipamento');
            });
        });
    }
});
</script>

