{% extends 'base.html' %}
{% load static %}

{% block title %}Voto Proferido - {{ sessao.comissao.nome }}{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .editor-button {
        padding: 5px 10px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    .editor-button:hover {
        background: #e9ecef;
    }
    .editor-button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    .editor-content {
        min-height: 300px;
        padding: 15px;
        outline: none;
        font-family: Arial, sans-serif;
        font-size: 14px;
        line-height: 1.6;
    }
    .editor-content:focus {
        background: #fff;
    }
    .font-size-selector {
        width: 80px;
        padding: 3px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    .color-picker {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
    }
    .alignment-group {
        display: flex;
        gap: 2px;
    }
    .alignment-button {
        padding: 5px 8px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
    }
    .editor-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 4px 4px;
        font-size: 12px;
        color: #6c757d;
    }
    .editor-stats span {
        margin-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-vote-yea me-2"></i>
                    Voto Proferido
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="{% url 'militares:comissao_list' %}">
                                <i class="fas fa-home me-1"></i>Comissões
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'militares:comissao_detail' sessao.comissao.pk %}">
                                {{ sessao.comissao.nome }}
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'militares:sessao_comissao_detail' sessao.pk %}">
                                Sessão {{ sessao.numero }}
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            Voto Proferido
                        </li>
                    </ol>
                </nav>
            </div>

            <form id="voto-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="voto" id="voto_hidden" value="">
                
                <!-- Informações da Sessão -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informações da Sessão
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Comissão:</strong> {{ sessao.comissao.nome }}</p>
                                <p><strong>Sessão:</strong> {{ sessao.numero }}</p>
                                <p><strong>Data:</strong> {{ sessao.data|date:"d/m/Y" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Membro:</strong> {{ membro_usuario.militar.nome_completo }}</p>
                                <p><strong>Função:</strong> {{ membro_usuario.funcao }}</p>
                                <p><strong>Status:</strong> 
                                    {% if voto_existente %}
                                        <span class="badge bg-success">Voto Registrado</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pendente</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opção de Voto -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Opção de Voto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="voto_radio" id="voto_favor" value="FAVOR" 
                                   {% if voto_existente and voto_existente.voto == 'FAVOR' %}checked{% endif %}>
                            <label class="form-check-label" for="voto_favor">
                                <i class="fas fa-thumbs-up text-success me-2"></i>
                                <strong>Favor</strong>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="voto_radio" id="voto_contra" value="CONTRA"
                                   {% if voto_existente and voto_existente.voto == 'CONTRA' %}checked{% endif %}>
                            <label class="form-check-label" for="voto_contra">
                                <i class="fas fa-thumbs-down text-danger me-2"></i>
                                <strong>Contra</strong>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="voto_radio" id="voto_abstencao" value="ABSTENCAO"
                                   {% if voto_existente and voto_existente.voto == 'ABSTENCAO' %}checked{% endif %}>
                            <label class="form-check-label" for="voto_abstencao">
                                <i class="fas fa-minus-circle text-secondary me-2"></i>
                                <strong>Abstenção</strong>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Editor de Voto Proferido -->
                <div class="card mb-4">
                                    <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Voto Proferido
                        <small class="text-muted ms-2">
                            <i class="fas fa-info-circle"></i>
                            Editor Personalizado - Formatação Avançada
                        </small>
                    </h5>
                </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Digite aqui o texto completo do voto que você proferiu durante a sessão. 
                            Utilize o editor personalizado para formatação avançada (negrito, itálico, listas, etc.).
                        </p>
                        
                        <!-- Editor Personalizado -->
                        <div class="editor-container">
                            <div class="editor-toolbar">
                                <!-- Formatação de Texto -->
                                <button type="button" class="editor-button" data-command="bold" title="Negrito">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="italic" title="Itálico">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="underline" title="Sublinhado">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="strikeThrough" title="Tachado">
                                    <i class="fas fa-strikethrough"></i>
                                </button>
                                
                                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                                
                                <!-- Tamanho da Fonte -->
                                <select class="font-size-selector" id="fontSize">
                                    <option value="12">12px</option>
                                    <option value="14" selected>14px</option>
                                    <option value="16">16px</option>
                                    <option value="18">18px</option>
                                    <option value="20">20px</option>
                                    <option value="24">24px</option>
                                    <option value="28">28px</option>
                                    <option value="32">32px</option>
                                </select>
                                
                                <!-- Cor da Fonte -->
                                <input type="color" class="color-picker" id="fontColor" value="#000000" title="Cor da Fonte">
                                
                                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                                
                                <!-- Alinhamento -->
                                <div class="alignment-group">
                                    <button type="button" class="alignment-button" data-command="justifyLeft" title="Alinhar à Esquerda">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button type="button" class="alignment-button" data-command="justifyCenter" title="Centralizar">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button type="button" class="alignment-button" data-command="justifyRight" title="Alinhar à Direita">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                    <button type="button" class="alignment-button" data-command="justifyFull" title="Justificar">
                                        <i class="fas fa-align-justify"></i>
                                    </button>
                                </div>
                                
                                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                                
                                <!-- Listas -->
                                <button type="button" class="editor-button" data-command="insertUnorderedList" title="Lista com Marcadores">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="insertOrderedList" title="Lista Numerada">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                
                                <!-- Recuo -->
                                <button type="button" class="editor-button" data-command="outdent" title="Diminuir Recuo">
                                    <i class="fas fa-outdent"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="indent" title="Aumentar Recuo">
                                    <i class="fas fa-indent"></i>
                                </button>
                                
                                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                                
                                <!-- Links e Citações -->
                                <button type="button" class="editor-button" id="createLink" title="Inserir Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="editor-button" data-command="formatBlock" data-value="blockquote" title="Citação">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                                
                                <!-- Limpar Formatação -->
                                <button type="button" class="editor-button" data-command="removeFormat" title="Limpar Formatação">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                
                                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                                
                                <!-- Modelos -->
                                <button type="button" class="editor-button" id="btnSalvarModelo" title="Salvar como Modelo">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button type="button" class="editor-button" id="btnAplicarModelo" title="Aplicar Modelo">
                                    <i class="fas fa-file-import"></i>
                                </button>
                            </div>
                            
                            <div class="editor-content" id="votoEditor" contenteditable="true" 
                                 placeholder="Digite aqui o texto do voto que você proferiu durante a sessão...">
                                {% if voto_existente and voto_existente.voto_proferido %}
                                    {{ voto_existente.voto_proferido|safe }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Campo hidden para enviar os dados -->
                        <textarea name="voto_proferido" id="voto_proferido_hidden" style="display: none;"></textarea>
                        
                        <!-- Estatísticas do Editor -->
                        <div class="editor-stats">
                            <span id="wordCount">0 palavras</span>
                            <span id="charCount">0 caracteres</span>
                            <span id="timeSpent">Tempo: 00:00</span>
                            <span id="lastSave">Último save: -</span>
                        </div>
                    </div>
                </div>
                
                <!-- Modal de Visualização do Voto -->
                <div class="modal fade" id="visualizarModal" tabindex="-1" aria-labelledby="visualizarModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="visualizarModalLabel">
                                    <i class="fas fa-eye me-2"></i>
                                    Visualizar Voto
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Opção de Voto:</h6>
                                        <p id="votoVisualizacao">-</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Membro:</h6>
                                        <p>{{ membro_usuario.militar.nome_completo }}</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6>Voto Proferido:</h6>
                                    <div id="votoProferidoVisualizacao" class="border p-3 rounded bg-light">
                                        <p class="text-muted">Nenhum texto digitado ainda.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal de Confirmação de Senha -->
                <div class="modal fade" id="senhaModal" tabindex="-1" aria-labelledby="senhaModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="senhaModalLabel">
                                    <i class="fas fa-lock me-2"></i>
                                    Confirmação de Senha
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Para confirmar seu voto, digite sua senha:</p>
                                <div class="mb-3">
                                    <label for="senhaVotante" class="form-label">Senha</label>
                                    <input type="password" class="form-control" id="senhaVotante" placeholder="Digite sua senha">
                                    <div class="invalid-feedback" id="senhaError" style="display:none;">
                                        Senha incorreta. Tente novamente.
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-warning" id="confirmarVoto">
                                    <i class="fas fa-check me-1"></i>
                                    Confirmar Voto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Barra de Botões -->
                <div class="card mt-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" id="btnSalvarVoto">
                                    <i class="fas fa-save me-1"></i>
                                    {% if voto_existente %}Atualizar Voto{% else %}Salvar Voto{% endif %}
                                </button>
                                
                                <button type="button" class="btn btn-success" id="btnVisualizarVoto">
                                    <i class="fas fa-eye me-1"></i>
                                    Visualizar Voto
                                </button>
                                
                                <button type="button" class="btn btn-info" id="btnLimparFormulario">
                                    <i class="fas fa-eraser me-1"></i>
                                    Limpar Formulário
                                </button>
                                
                                <button type="button" class="btn btn-warning" onclick="abrirEditorVoto()">
                                    <i class="fas fa-edit me-1"></i>
                                    Editor Avançado
                                </button>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <a href="{% url 'militares:sessao_comissao_detail' sessao.pk %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Voltar à Sessão
                                </a>
                                
                                <a href="{% url 'militares:sessao_comissao_detail' sessao.pk %}" class="btn btn-outline-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Ver Sessão
                                </a>
                                
                                {% if voto_existente %}
                                <button type="button" class="btn btn-outline-danger" id="btnExcluirVoto">
                                    <i class="fas fa-trash me-1"></i>
                                    Excluir Voto
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal de Confirmação de Exclusão -->
                <div class="modal fade" id="excluirModal" tabindex="-1" aria-labelledby="excluirModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="excluirModalLabel">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    Confirmar Exclusão
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Tem certeza que deseja excluir seu voto?</p>
                                <p class="text-muted"><small>Esta ação não pode ser desfeita.</small></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmarExclusao">
                                    <i class="fas fa-trash me-1"></i>
                                    Confirmar Exclusão
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Salvar Modelo -->
                <div class="modal fade" id="salvarModeloModal" tabindex="-1" aria-labelledby="salvarModeloModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="salvarModeloModalLabel">
                                    <i class="fas fa-save me-2"></i>
                                    Salvar como Modelo
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="nomeModelo" class="form-label">Nome do Modelo</label>
                                    <input type="text" class="form-control" id="nomeModelo" placeholder="Digite um nome para o modelo">
                                </div>
                                <div class="mb-3">
                                    <label for="descricaoModelo" class="form-label">Descrição (opcional)</label>
                                    <textarea class="form-control" id="descricaoModelo" rows="3" placeholder="Descreva o modelo..."></textarea>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    O modelo será salvo com todo o conteúdo atual do editor.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="confirmarSalvarModelo">
                                    <i class="fas fa-save me-1"></i>
                                    Salvar Modelo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Aplicar Modelo -->
                <div class="modal fade" id="aplicarModeloModal" tabindex="-1" aria-labelledby="aplicarModeloModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="aplicarModeloModalLabel">
                                    <i class="fas fa-file-import me-2"></i>
                                    Aplicar Modelo
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="selectModelo" class="form-label">Selecione um Modelo</label>
                                    <select class="form-control" id="selectModelo">
                                        <option value="">-- Selecione um modelo --</option>
                                    </select>
                                </div>
                                <div id="previewModelo" class="border rounded p-3 bg-light" style="display: none;">
                                    <h6>Prévia do Modelo:</h6>
                                    <div id="conteudoPreview"></div>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Atenção:</strong> Aplicar um modelo substituirá todo o conteúdo atual do editor.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-success" id="confirmarAplicarModelo" disabled>
                                    <i class="fas fa-file-import me-1"></i>
                                    Aplicar Modelo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('votoEditor');
    const hiddenField = document.getElementById('voto_proferido_hidden');
    
    // Função para executar comandos do editor
    function execCommand(command, value = null) {
        document.execCommand(command, false, value);
        editor.focus();
    }
    
    // Event listeners para botões da toolbar
    document.querySelectorAll('.editor-button').forEach(button => {
        button.addEventListener('click', function() {
            const command = this.getAttribute('data-command');
            const value = this.getAttribute('data-value');
            
            if (command) {
                execCommand(command, value);
            }
        });
    });
    
    // Tamanho da fonte
    document.getElementById('fontSize').addEventListener('change', function() {
        execCommand('fontSize', this.value);
    });
    
    // Cor da fonte
    document.getElementById('fontColor').addEventListener('change', function() {
        execCommand('foreColor', this.value);
    });
    
    // Alinhamento
    document.querySelectorAll('.alignment-button').forEach(button => {
        button.addEventListener('click', function() {
            const command = this.getAttribute('data-command');
            execCommand(command);
        });
    });
    
    // Link
    document.getElementById('createLink').addEventListener('click', function() {
        const url = prompt('Digite a URL do link:');
        if (url) {
            execCommand('createLink', url);
        }
    });
    
    // Sincronizar conteúdo com campo hidden
    editor.addEventListener('input', function() {
        hiddenField.value = this.innerHTML;
    });
    
    // Carregar conteúdo inicial
    if (editor.innerHTML.trim()) {
        hiddenField.value = editor.innerHTML;
    }
    
    // Placeholder
    editor.addEventListener('focus', function() {
        if (this.innerHTML === '') {
            this.innerHTML = '';
        }
    });
    
    editor.addEventListener('blur', function() {
        if (this.innerHTML === '') {
            this.innerHTML = '';
        }
    });

    const senhaModal = new bootstrap.Modal(document.getElementById('senhaModal'));
    const visualizarModal = new bootstrap.Modal(document.getElementById('visualizarModal'));
    const excluirModal = new bootstrap.Modal(document.getElementById('excluirModal'));
    const senhaInput = document.getElementById('senhaVotante');
    const senhaError = document.getElementById('senhaError');
    const btnSalvarVoto = document.getElementById('btnSalvarVoto');
    const btnVisualizarVoto = document.getElementById('btnVisualizarVoto');
    const btnLimparFormulario = document.getElementById('btnLimparFormulario');
    const btnExcluirVoto = document.getElementById('btnExcluirVoto');
    const confirmarVoto = document.getElementById('confirmarVoto');
    const confirmarExclusao = document.getElementById('confirmarExclusao');

    btnSalvarVoto.addEventListener('click', function() {
        senhaInput.value = '';
        senhaError.style.display = 'none';
        senhaInput.classList.remove('is-invalid');
        senhaModal.show();
        setTimeout(() => senhaInput.focus(), 500);
    });

    confirmarVoto.addEventListener('click', function() {
        const senha = senhaInput.value.trim();
        if (!senha) {
            senhaInput.classList.add('is-invalid');
            senhaError.style.display = 'block';
            return;
        }
        
        // Verificar se um voto foi selecionado
        const votoSelecionado = document.querySelector('input[name="voto_radio"]:checked');
        if (!votoSelecionado) {
            alert('Por favor, selecione uma opção de voto (Favor, Contra ou Abstenção).');
            senhaModal.hide();
            return;
        }
        
        const form = document.getElementById('voto-form');
        
        // Copiar o valor do voto selecionado para o campo hidden
        const votoHidden = document.getElementById('voto_hidden');
        votoHidden.value = votoSelecionado.value;
        
        let senhaField = form.querySelector('input[name="senha_votante"]');
        if (!senhaField) {
            senhaField = document.createElement('input');
            senhaField.type = 'hidden';
            senhaField.name = 'senha_votante';
            form.appendChild(senhaField);
        }
        senhaField.value = senha;
        
        // Garantir que o valor do editor seja copiado para o campo
        hiddenField.value = editor.innerHTML;
        
        form.submit();
    });

    senhaInput.addEventListener('input', function() {
        if (this.value.trim()) {
            this.classList.remove('is-invalid');
            senhaError.style.display = 'none';
        }
    });
    senhaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmarVoto.click();
        }
    });
    
    // Atualizar campo hidden quando um voto for selecionado
    document.querySelectorAll('input[name="voto_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const votoHidden = document.getElementById('voto_hidden');
            votoHidden.value = this.value;
        });
    });
    
    // Botão Visualizar Voto
    if (btnVisualizarVoto) {
        btnVisualizarVoto.addEventListener('click', function() {
            const votoSelecionado = document.querySelector('input[name="voto_radio"]:checked');
            const votoVisualizacao = document.getElementById('votoVisualizacao');
            const votoProferidoVisualizacao = document.getElementById('votoProferidoVisualizacao');
            
            if (votoSelecionado) {
                const opcoesVoto = {
                    'FAVOR': 'Favorável',
                    'CONTRA': 'Contrário',
                    'ABSTENCAO': 'Abstenção'
                };
                votoVisualizacao.textContent = opcoesVoto[votoSelecionado.value] || votoSelecionado.value;
            } else {
                votoVisualizacao.textContent = 'Nenhuma opção selecionada';
            }
            
            const conteudo = editor.innerHTML;
            if (conteudo.trim()) {
                votoProferidoVisualizacao.innerHTML = conteudo;
            } else {
                votoProferidoVisualizacao.innerHTML = '<p class="text-muted">Nenhum texto digitado ainda.</p>';
            }
            
            visualizarModal.show();
        });
    }
    
    // Botão Limpar Formulário
    if (btnLimparFormulario) {
        btnLimparFormulario.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja limpar o formulário? Todos os dados serão perdidos.')) {
                // Limpar radio buttons
                document.querySelectorAll('input[name="voto_radio"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Limpar campo hidden
                const votoHidden = document.getElementById('voto_hidden');
                votoHidden.value = '';
                
                // Limpar editor
                editor.innerHTML = '';
                hiddenField.value = '';
            }
        });
    }
    
    // Botão Excluir Voto
    if (btnExcluirVoto) {
        btnExcluirVoto.addEventListener('click', function() {
            excluirModal.show();
        });
    }
    
    // Confirmar Exclusão
    if (confirmarExclusao) {
        confirmarExclusao.addEventListener('click', function() {
            // Aqui você pode adicionar a lógica para excluir o voto
            // Por enquanto, apenas fechar o modal
            excluirModal.hide();
            alert('Funcionalidade de exclusão será implementada em breve.');
        });
    }
    
    // ===== FUNCIONALIDADE DE MODELOS =====
    
    // Modal para salvar modelo
    const salvarModeloModal = new bootstrap.Modal(document.getElementById('salvarModeloModal'));
    const aplicarModeloModal = new bootstrap.Modal(document.getElementById('aplicarModeloModal'));
    
    // Botão Salvar Modelo
    document.getElementById('btnSalvarModelo').addEventListener('click', function() {
        // Verificar se há conteúdo no editor
        if (!editor.innerHTML.trim()) {
            alert('Não há conteúdo para salvar como modelo. Digite algo no editor primeiro.');
            return;
        }
        
        // Limpar campos do modal
        document.getElementById('nomeModelo').value = '';
        document.getElementById('descricaoModelo').value = '';
        
        salvarModeloModal.show();
    });
    
    // Botão Aplicar Modelo
    document.getElementById('btnAplicarModelo').addEventListener('click', function() {
        // Carregar modelos disponíveis
        carregarModelos();
        aplicarModeloModal.show();
    });
    
    // Confirmar Salvar Modelo
    document.getElementById('confirmarSalvarModelo').addEventListener('click', function() {
        const nome = document.getElementById('nomeModelo').value.trim();
        const descricao = document.getElementById('descricaoModelo').value.trim();
        const conteudo = editor.innerHTML;
        
        if (!nome) {
            alert('Por favor, digite um nome para o modelo.');
            return;
        }
        
        // Salvar modelo no localStorage
        const modelos = JSON.parse(localStorage.getItem('modelosVoto') || '[]');
        const novoModelo = {
            id: Date.now(),
            nome: nome,
            descricao: descricao,
            conteudo: conteudo,
            dataCriacao: new Date().toISOString()
        };
        
        modelos.push(novoModelo);
        localStorage.setItem('modelosVoto', JSON.stringify(modelos));
        
        salvarModeloModal.hide();
        alert('Modelo salvo com sucesso!');
    });
    
    // Função para carregar modelos
    function carregarModelos() {
        const select = document.getElementById('selectModelo');
        const modelos = JSON.parse(localStorage.getItem('modelosVoto') || '[]');
        
        // Limpar opções existentes
        select.innerHTML = '<option value="">-- Selecione um modelo --</option>';
        
        // Adicionar modelos
        modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.id;
            option.textContent = modelo.nome;
            select.appendChild(option);
        });
    }
    
    // Selecionar modelo
    document.getElementById('selectModelo').addEventListener('change', function() {
        const modeloId = this.value;
        const btnAplicar = document.getElementById('confirmarAplicarModelo');
        const preview = document.getElementById('previewModelo');
        const conteudoPreview = document.getElementById('conteudoPreview');
        
        if (modeloId) {
            const modelos = JSON.parse(localStorage.getItem('modelosVoto') || '[]');
            const modelo = modelos.find(m => m.id == modeloId);
            
            if (modelo) {
                conteudoPreview.innerHTML = modelo.conteudo;
                preview.style.display = 'block';
                btnAplicar.disabled = false;
            }
        } else {
            preview.style.display = 'none';
            btnAplicar.disabled = true;
        }
    });
    
    // Confirmar Aplicar Modelo
    document.getElementById('confirmarAplicarModelo').addEventListener('click', function() {
        const modeloId = document.getElementById('selectModelo').value;
        
        if (!modeloId) {
            alert('Por favor, selecione um modelo.');
            return;
        }
        
        if (confirm('Tem certeza que deseja aplicar este modelo? O conteúdo atual do editor será substituído.')) {
            const modelos = JSON.parse(localStorage.getItem('modelosVoto') || '[]');
            const modelo = modelos.find(m => m.id == modeloId);
            
            if (modelo) {
                editor.innerHTML = modelo.conteudo;
                hiddenField.value = modelo.conteudo;
                aplicarModeloModal.hide();
                alert('Modelo aplicado com sucesso!');
            }
        }
    });
    
    // Função para abrir o editor avançado em modal
    function abrirEditorVoto() {
        const url = "{% url 'militares:voto_deliberacao_editor_popup' deliberacao.pk %}";
        const width = 1200;
        const height = 800;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            url,
            'editor_voto',
            `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no`
        );
        
        if (popup) {
            // Focar na nova janela
            popup.focus();
            
            // Verificar se a janela foi fechada
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    // Recarregar a página para atualizar os dados
                    location.reload();
                }
            }, 1000);
        } else {
            alert('Por favor, permita pop-ups para usar o editor avançado.');
        }
    }
});
</script>
{% endblock %} 