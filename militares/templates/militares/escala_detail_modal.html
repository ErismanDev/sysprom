{% load static %}
{% csrf_token %}
<style>
    .escala-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stats-card .number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stats-card .label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #667eea;
    }
    
    .info-item i {
        color: #667eea;
        width: 24px;
        margin-right: 12px;
        font-size: 1.1rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        min-width: 140px;
    }
    
    .info-value {
        color: #6c757d;
        flex: 1;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-ativa {
        background: #d4edda;
        color: #155724;
    }
    
    .status-pendente {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-concluida {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-cancelada {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-aprovada {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .equipe-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fff;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .equipe-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .equipe-title {
        margin: 0;
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
    }
    
    .equipe-militares {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
    }
    
    .militar-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.2s ease;
    }
    
    .militar-item:hover {
        background: #e9ecef;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
    }
    
    .militar-info {
        display: flex;
        align-items: flex-start;
    }
    
    .militar-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .militar-details {
        flex: 1;
    }
    
    .militar-nome {
        display: block;
        font-weight: 600;
        color: #212529;
        margin: 0 0 6px 0;
        font-size: 0.95rem;
    }
    
    .militar-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 6px;
        align-items: center;
    }
    
    .militar-meta .badge {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .militar-horario {
        color: #6c757d;
        font-size: 0.8rem;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }
    
    .militar-horario i {
        width: 16px;
        margin-right: 6px;
        color: #667eea;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .assinatura-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
    }
    
    .alteracao-item {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 12px;
    }
    
    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 2px solid transparent;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #667eea;
        color: #667eea;
    }
    
    .nav-tabs .nav-link.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
    }
    
    .tab-content {
        padding: 20px 0;
        min-height: 300px;
        max-height: 600px;
        overflow-y: auto;
    }
</style>

<div class="escala-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-1">
                <i class="fas fa-calendar-alt me-2"></i>
                Escala de Serviço - {{ escala.data|date:"d/m/Y" }}
            </h5>
            <p class="mb-0 opacity-75">
                <i class="fas fa-building me-1"></i>
                {{ escala.organizacao }}
            </p>
        </div>
        <span class="status-badge status-{{ escala.status }}">
            {{ escala.get_status_display }}
        </span>
    </div>
</div>

<!-- Estatísticas Resumidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number">{{ escala_info.total_militares }}</div>
            <div class="label">Total Escalados</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" style="color: #28a745;">{{ escala_info.total_operacionais }}</div>
            <div class="label">Operacionais</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" style="color: #17a2b8;">{{ escala_info.total_administrativos }}</div>
            <div class="label">Administrativos</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" style="color: #667eea;">{{ escala_info.total_equipes }}</div>
            <div class="label">Equipes</div>
        </div>
    </div>
</div>

<!-- Tabs para organizar conteúdo -->
<ul class="nav nav-tabs mb-3" id="escalaTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
            <i class="fas fa-info-circle me-2"></i>
            Informações
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="militares-tab" data-bs-toggle="tab" data-bs-target="#militares" type="button" role="tab">
            <i class="fas fa-users me-2"></i>
            Militares
            <span class="badge bg-primary ms-2">{{ escala_info.total_militares }}</span>
        </button>
    </li>
    {% if escala_info.assinaturas %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="assinaturas-tab" data-bs-toggle="tab" data-bs-target="#assinaturas" type="button" role="tab">
            <i class="fas fa-file-signature me-2"></i>
            Assinaturas
            <span class="badge bg-success ms-2">{{ escala_info.total_assinaturas }}</span>
        </button>
    </li>
    {% endif %}
    {% if escala_info.alteracoes %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="alteracoes-tab" data-bs-toggle="tab" data-bs-target="#alteracoes" type="button" role="tab">
            <i class="fas fa-edit me-2"></i>
            Alterações
            <span class="badge bg-warning ms-2">{{ escala_info.alteracoes|length }}</span>
        </button>
    </li>
    {% endif %}
</ul>

<div class="tab-content" id="escalaTabContent">
    <!-- Tab Informações -->
    <div class="tab-pane fade show active" id="info" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span class="info-label">Data:</span>
                    <span class="info-value">{{ escala.data|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-building"></i>
                    <span class="info-label">Organização:</span>
                    <span class="info-value">{{ escala.organizacao }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-info-circle"></i>
                    <span class="info-label">Status:</span>
                    <span class="info-value">
                        <span class="status-badge status-{{ escala.status }}">
                            {{ escala.get_status_display }}
                        </span>
                    </span>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="info-item">
                    <i class="fas fa-user"></i>
                    <span class="info-label">Criado por:</span>
                    <span class="info-value">{{ escala.criado_por.get_full_name|default:"Sistema" }}</span>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-calendar-plus"></i>
                    <span class="info-label">Data de Criação:</span>
                    <span class="info-value">{{ escala.data_criacao|date:"d/m/Y H:i" }}</span>
                </div>
                
                {% if escala_info.tem_revisao or escala_info.tem_aprovacao %}
                <div class="info-item">
                    <i class="fas fa-check-circle"></i>
                    <span class="info-label">Assinaturas:</span>
                    <span class="info-value">
                        {% if escala_info.tem_revisao %}
                            <span class="badge bg-info me-1">Revisada</span>
                        {% endif %}
                        {% if escala_info.tem_aprovacao %}
                            <span class="badge bg-success">Aprovada</span>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if escala.observacoes %}
        <div class="info-item mt-3">
            <i class="fas fa-sticky-note"></i>
            <span class="info-label">Observações:</span>
            <span class="info-value">{{ escala.observacoes }}</span>
        </div>
        {% endif %}
        
        {% if escala_info.escala.status == 'aprovada' and escala_info.motivo_restricao %}
        <div class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Restrição:</strong> {{ escala_info.motivo_restricao }}
        </div>
        {% endif %}
    </div>
    
    <!-- Tab Militares -->
    <div class="tab-pane fade" id="militares" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
                Militares Escalados
                <span class="badge bg-primary ms-2">{{ escala_info.total_militares|default:0 }}</span>
            </h6>
            <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalGerenciarMilitares()">
                <i class="fas fa-users me-1"></i>
                Adicionar Bombeiros
            </button>
        </div>
        
        {% if escala_info.total_militares > 0 %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th style="width: 60px; text-align: center;">#</th>
                            <th style="width: 80px; text-align: center;">Foto</th>
                            <th>Nome Completo</th>
                            <th style="width: 120px;">Posto/Grad.</th>
                            <th style="width: 120px;">Tipo Serviço</th>
                            <th style="width: 150px;">Horário</th>
                            <th style="width: 120px;">Equipe</th>
                            <th style="width: 120px;">Função</th>
                            <th style="width: 100px;">Viatura</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for militar in escala_info.todos_militares_escalados %}
                        <tr>
                            <td style="text-align: center; vertical-align: middle;">
                                <span class="badge bg-light text-dark">{{ forloop.counter }}</span>
                            </td>
                            <td style="text-align: center; vertical-align: middle;">
                                {% if militar.foto_url %}
                                    <img src="{{ militar.foto_url }}" 
                                         alt="{{ militar.nome_completo }}" 
                                         class="rounded-circle" 
                                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #dee2e6;">
                                {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 50px; height: 50px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                <div>
                                    <strong>{{ militar.nome_completo }}</strong>
                                    {% if militar.cpf %}
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-id-card me-1"></i>
                                        CPF: {{ militar.cpf }}
                                    </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="vertical-align: middle;">
                                <span class="badge bg-secondary">{{ militar.posto_graduacao }}</span>
                            </td>
                            <td style="vertical-align: middle;">
                                {% if militar.tipo_servico == 'operacional' %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-fire me-1"></i>
                                        {{ militar.tipo_servico_display }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-briefcase me-1"></i>
                                        {{ militar.tipo_servico_display }}
                                    </span>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                <small>
                                    <i class="fas fa-clock me-1"></i>
                                    {{ militar.hora_inicio }} - {{ militar.hora_fim }}
                                    <br>
                                    <span class="badge bg-light text-dark">{{ militar.turno_display }}</span>
                                </small>
                            </td>
                            <td style="vertical-align: middle;">
                                {% if militar.equipe %}
                                    <span class="badge bg-primary">{{ militar.equipe }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                {% if militar.funcao_operacional %}
                                    <span class="badge bg-success">{{ militar.funcao_operacional }}</span>
                                {% elif militar.funcao_display %}
                                    <span class="badge bg-secondary">{{ militar.funcao_display }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">
                                {% if militar.viatura %}
                                    <small>
                                        <i class="fas fa-truck me-1"></i>
                                        {{ militar.viatura }}
                                    </small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if militar.secao or militar.observacoes %}
                        <tr class="bg-light">
                            <td colspan="9" style="padding: 10px 15px;">
                                {% if militar.secao %}
                                <small class="text-muted me-3">
                                    <i class="fas fa-building me-1"></i>
                                    <strong>Seção:</strong> {{ militar.secao }}
                                </small>
                                {% endif %}
                                {% if militar.observacoes and militar.observacoes != "Adicionado via seleção múltipla" %}
                                <small class="text-muted">
                                    <i class="fas fa-sticky-note me-1"></i>
                                    <strong>Observações:</strong> {{ militar.observacoes }}
                                </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">Nenhum militar escalado</h6>
                <p class="text-muted mb-3">Esta escala ainda não possui militares escalados.</p>
                <button type="button" class="btn btn-primary" onclick="abrirModalGerenciarMilitares()">
                    <i class="fas fa-users me-1"></i>
                    Adicionar Bombeiros
                </button>
            </div>
        {% endif %}
    </div>
    
    <!-- Tab Assinaturas -->
    {% if escala_info.assinaturas %}
    <div class="tab-pane fade" id="assinaturas" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                {% if escala_info.tem_revisao %}
                <span class="badge bg-info me-2">
                    <i class="fas fa-check-circle me-1"></i>
                    Revisada
                </span>
                {% endif %}
                {% if escala_info.tem_aprovacao %}
                <span class="badge bg-success">
                    <i class="fas fa-check-circle me-1"></i>
                    Aprovada
                </span>
                {% endif %}
            </div>
        </div>
        
        {% for assinatura in escala_info.assinaturas %}
        <div class="assinatura-item">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    <img src="{% static 'assinasyspro.png' %}" width="80" height="60" alt="Logo" style="background: #fff; padding: 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>{{ assinatura.get_tipo_assinatura_display }}</strong>
                            <span class="badge bg-{{ assinatura.tipo_assinatura|yesno:'info,primary' }} ms-2">
                                {{ assinatura.get_tipo_assinatura_display }}
                            </span>
                        </div>
                    </div>
                    <p class="mb-1 small">
                        <strong>{{ assinatura.assinado_por.get_full_name|default:assinatura.assinado_por.username }}</strong>
                        {% if assinatura.funcao_assinatura %} - {{ assinatura.funcao_assinatura }}{% endif %}
                    </p>
                    <p class="mb-0 small text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        {{ assinatura.data_assinatura|date:"d/m/Y" }} às {{ assinatura.data_assinatura|date:"H:i" }}
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle me-2"></i>Validação</h6>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Protocolo:</strong> {{ escala.pk }}/{{ escala.data|date:"Y" }}</p>
                    <p class="mb-0"><strong>Total de Assinaturas:</strong> {{ escala_info.total_assinaturas }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Status:</strong> 
                        {% if escala_info.tem_aprovacao %}
                            <span class="badge bg-success">Aprovada</span>
                        {% elif escala_info.tem_revisao %}
                            <span class="badge bg-warning">Em Revisão</span>
                        {% else %}
                            <span class="badge bg-secondary">Pendente</span>
                        {% endif %}
                    </p>
                    <p class="mb-0"><strong>Validade:</strong> Assinaturas eletrônicas têm validade legal</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Tab Alterações -->
    {% if escala_info.alteracoes %}
    <div class="tab-pane fade" id="alteracoes" role="tabpanel">
        {% if escala_info.pode_alterar %}
        <div class="alert alert-success mb-3">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Alterações Permitidas</strong>
        </div>
        {% else %}
        <div class="alert alert-danger mb-3">
            <i class="fas fa-times-circle me-2"></i>
            <strong>Alterações Bloqueadas</strong>
        </div>
        {% endif %}
        
        {% for alteracao in escala_info.alteracoes %}
        <div class="alteracao-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-edit me-1"></i>
                        {{ alteracao.get_tipo_alteracao_display }}
                    </h6>
                    <small class="text-muted">
                        Por {{ alteracao.alterado_por.get_full_name|default:alteracao.alterado_por.username }} 
                        em {{ alteracao.data_alteracao|date:"d/m/Y H:i" }}
                    </small>
                </div>
                {% if alteracao.is_valida %}
                    <span class="badge bg-success">Válida</span>
                {% else %}
                    <span class="badge bg-secondary">Expirada</span>
                {% endif %}
            </div>
            <p class="mb-2"><strong>Justificativa:</strong> {{ alteracao.justificativa }}</p>
            {% if alteracao.observacoes %}
            <p class="mb-2"><strong>Observações:</strong> {{ alteracao.observacoes }}</p>
            {% endif %}
            {% if alteracao.dados_anteriores.arquivo_anexo %}
            <div class="mt-2">
                <a href="{% url 'militares:visualizar_documento_alteracao' alteracao.id %}" 
                   target="_blank" 
                   class="btn btn-sm btn-outline-success">
                    <i class="fas fa-file-alt me-1"></i>
                    Ver Documento
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Ações -->
<div class="d-flex gap-2 flex-wrap mt-4 pt-3 border-top">
    <a href="{% url 'militares:escala_pdf' escala.pk %}" class="btn btn-sm btn-outline-success" target="_blank">
        <i class="fas fa-file-pdf me-1"></i>
        Gerar PDF
    </a>
    <a href="{% url 'militares:escala_detail' escala.pk %}" class="btn btn-sm btn-primary">
        <i class="fas fa-external-link-alt me-1"></i>
        Ver Página Completa
    </a>
</div>

<!-- Modal Gerenciar Militares -->
<div class="modal fade" id="modalGerenciarMilitares" tabindex="-1" aria-labelledby="modalGerenciarMilitaresLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down" style="width: 90%; max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGerenciarMilitaresLabel">
                    <i class="fas fa-users me-2"></i>
                    Adicionar Bombeiros - {{ escala.data|date:"d/m/Y" }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="content-main">
                    <div id="content-organizacao">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-building me-2"></i>
                                    Militares da Organização: <strong>{{ escala.organizacao }}</strong>
                                </h6>
                                
                                <!-- Configurações da Escala -->
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cog me-2"></i>
                                            Configurações da Escala
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Tipo de Serviço</label>
                                                <select class="form-select" id="configTipoServico" onchange="controlarCamposOperacionais()">
                                                    <option value="operacional">Operacional</option>
                                                    <option value="administrativo">Administrativo</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Turno</label>
                                                <select class="form-select" id="configTurno" onchange="calcularHorarios()">
                                                    <option value="">Selecione o turno</option>
                                                    <option value="2h">2 horas</option>
                                                    <option value="4h">4 horas</option>
                                                    <option value="6h">6 horas</option>
                                                    <option value="8h">8 horas</option>
                                                    <option value="12h">12 horas</option>
                                                    <option value="18h">18 horas</option>
                                                    <option value="24h">24 horas</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Hora Início</label>
                                                <input type="time" class="form-control" id="configHoraInicio" value="" onchange="calcularHorarios()">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Hora Término</label>
                                                <input type="time" class="form-control" id="configHoraFim" value="" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Seleção de Militares -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-users me-2"></i>
                                            Selecionar Militares
                                        </h6>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodos()">
                                                <i class="fas fa-check-square me-1"></i>Selecionar Todos
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodos()">
                                                <i class="fas fa-square me-1"></i>Desmarcar Todos
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Campo de Pesquisa -->
                                        <div class="mb-3">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input 
                                                    type="text" 
                                                    class="form-control" 
                                                    id="campoPesquisaMilitar" 
                                                    placeholder="Digite nome, nome de guerra ou matrícula para buscar em todos os militares..." 
                                                    onkeyup="pesquisarMilitares()"
                                                />
                                                <button class="btn btn-outline-secondary" type="button" onclick="limparPesquisa()">
                                                    <i class="fas fa-times"></i> Limpar
                                                </button>
                                            </div>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Sem pesquisa: lista militares da organização. Com pesquisa: busca em todos os militares ativos.
                                            </small>
                                        </div>
                                        
                                        <div id="militaresOrganizacaoContainer">
                                            <!-- Será carregado via AJAX -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botão de Ação -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-success btn-lg" onclick="adicionarMilitaresSelecionados()">
                                        <i class="fas fa-plus me-2"></i>
                                        Adicionar na Escala
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="atualizarMilitaresEscalados()">
                    <i class="fas fa-sync me-1"></i>
                    Atualizar Lista
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alerta -->
<div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalAlertaHeader">
                <h5 class="modal-title" id="modalAlertaLabel">
                    <i id="modalAlertaIcon" class="fas fa-info-circle me-2"></i>
                    <span id="modalAlertaTitulo">Informação</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalAlertaMensagem" class="mb-0">Mensagem de alerta</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" id="modalAlertaConfirmar" style="display: none;">
                    <i class="fas fa-check me-1"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalConfirmacaoMensagem" class="mb-0">Tem certeza que deseja continuar?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="modalConfirmacaoConfirmar">
                    <i class="fas fa-check me-1"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
const escalaId = {{ escala.pk }};
let militaresDisponiveis = [];

// Função para carregar militares da organização
async function carregarMilitaresOrganizacao(termoPesquisa = '') {
    try {
        // Usar escalaId do escopo global se disponível
        const idEscala = typeof escalaId !== 'undefined' ? escalaId : (typeof window.escalaId !== 'undefined' ? window.escalaId : null);
        if (!idEscala) {
            console.error('escalaId não está definido');
            const container = document.getElementById('militaresOrganizacaoContainer');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro: ID da escala não encontrado. Recarregue a página.
                    </div>
                `;
            }
            return;
        }
        let url = `/militares/escalas/${idEscala}/api/militares-disponiveis/`;
        if (termoPesquisa) {
            url += `?q=${encodeURIComponent(termoPesquisa)}`;
        }
        const response = await fetch(url);
        const data = await response.json();
        
        const container = document.getElementById('militaresOrganizacaoContainer');
        if (!container) {
            console.error('Container militaresOrganizacaoContainer não encontrado');
            return;
        }
        console.log('Carregando militares para escala:', idEscala);
        
        if (data.militares.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum encontrado</h5>
                    <p class="text-muted">Não há na organização "${data.organizacao}".</p>
                </div>
            `;
        } else {
            let acessoTotalAlert = '';
            if (data.acesso_total) {
                acessoTotalAlert = `
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-crown me-2"></i>
                        <strong>Acesso Total:</strong> Você está visualizando TODOS os militares ativos do sistema.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
            
            const stats = `
                ${acessoTotalAlert}
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_militares}</h5>
                                <p class="card-text mb-0">Total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_disponiveis}</h5>
                                <p class="card-text mb-0">Disponíveis</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_escalados}</h5>
                                <p class="card-text mb-0">Já Escalados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.total_indisponiveis_24h || 0}</h5>
                                <p class="card-text mb-0">Indisponíveis (24h)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const militaresList = data.militares.map((militar, index) => {
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                let isDisabled = false;
                
                // Verificar primeiro se a situação não é PRONTO
                if (militar.status_disponibilidade === 'indisponivel_situacao') {
                    statusClass = 'table-danger';
                    statusIcon = 'fas fa-exclamation-triangle text-danger';
                    statusText = `Indisponível - ${militar.situacao_display || militar.situacao}`;
                    isDisabled = true;
                } else if (militar.status_disponibilidade === 'indisponivel_24h') {
                    statusClass = 'table-danger';
                    statusIcon = 'fas fa-times-circle text-danger';
                    statusText = `Indisponível (${militar.horas_atuais}h)`;
                    isDisabled = true;
                } else if (militar.ja_escalado) {
                    statusClass = 'table-warning';
                    statusIcon = 'fas fa-check-circle text-warning';
                    statusText = `Já Escalado (${militar.horas_restantes}h restantes)`;
                    isDisabled = false;
                } else {
                    statusClass = 'table-success';
                    statusIcon = 'fas fa-circle text-success';
                    statusText = `Disponível (${militar.horas_restantes}h restantes)`;
                    isDisabled = false;
                }
                
                return `
                    <tr class="militar-row ${statusClass}">
                        <td style="width: 50px; text-align: center; vertical-align: middle;">
                            <div class="form-check d-flex justify-content-center">
                                <input class="form-check-input militar-checkbox" type="checkbox" 
                                       value="${militar.id}" id="militar_${militar.id}"
                                       ${isDisabled ? 'disabled' : ''}
                                       onchange="toggleCamposOperacionais(${militar.id})">
                            </div>
                        </td>
                        <td style="width: 60px; text-align: center; vertical-align: middle;"><span class="badge bg-light text-dark">${index + 1}</span></td>
                        <td style="width: 80px; text-align: center; vertical-align: middle;">
                            ${militar.foto_url ? `
                                <img src="${militar.foto_url}" 
                                     alt="${militar.nome_completo}" 
                                     class="rounded-circle" 
                                     style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #dee2e6;">
                            ` : `
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 50px; height: 50px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                            `}
                        </td>
                        <td style="vertical-align: middle;">
                            <div class="d-flex align-items-center">
                                <div>
                                    <h6 class="militar-nome mb-0">
                                        <span class="badge bg-secondary me-2">${militar.posto_graduacao_display || militar.posto_graduacao}</span>
                                        ${militar.nome_completo}
                                    </h6>
                                    ${militar.cpf ? `
                                        <small class="text-muted">
                                            <i class="fas fa-id-card me-1"></i>
                                            CPF: ${militar.cpf}
                                        </small>
                                    ` : ''}
                                </div>
                            </div>
                        </td>
                        <td style="width: 200px; vertical-align: middle;">
                            <small class="text-muted">
                                <i class="fas fa-building me-1"></i>
                                ${militar.lotacao || 'Não informado'}
                            </small>
                        </td>
                        <td style="width: 250px; text-align: center; vertical-align: middle;">
                            <div class="d-flex flex-column align-items-center">
                                <span class="badge ${militar.situacao_pronto ? 'bg-success' : 'bg-danger'} mb-1">
                                    <i class="fas ${militar.situacao_pronto ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-1"></i>
                                    ${militar.situacao_display || militar.situacao || 'PRONTO'}
                                </span>
                                ${militar.situacao_datas_texto ? `
                                    <small class="text-muted mt-1" style="font-size: 0.75rem; line-height: 1.2;">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        ${militar.situacao_datas_texto}
                                    </small>
                                ` : ''}
                            </div>
                        </td>
                        <td style="width: 150px; text-align: center; vertical-align: middle;">
                            <span class="badge bg-${militar.ja_escalado ? 'warning' : (militar.status_disponibilidade === 'indisponivel_24h' || militar.status_disponibilidade === 'indisponivel_situacao' ? 'danger' : 'success')}">
                                <i class="${statusIcon} me-1"></i>
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                    <tr id="campos_operacionais_${militar.id}" class="campos-operacionais-row" style="display: none;">
                        <td colspan="7">
                            <div class="card border-primary bg-light">
                                <div class="card-body py-3">
                                    <h6 class="text-primary mb-3">Configurações Operacionais - ${militar.nome_completo}</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="funcao_operacional_${militar.id}" 
                                                       placeholder="Ex: Comandante de Viatura" list="funcoes_disponiveis" autocomplete="off">
                                                <label for="funcao_operacional_${militar.id}">
                                                    <i class="fas fa-user-tie me-1"></i> Função Operacional
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="equipe_${militar.id}" 
                                                       placeholder="Ex: Equipe Alpha" list="equipes_disponiveis" autocomplete="off">
                                                <label for="equipe_${militar.id}">
                                                    <i class="fas fa-users me-1"></i> Equipe
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="viatura_${militar.id}" 
                                                       placeholder="Ex: Viatura 01" list="viaturas_disponiveis" autocomplete="off">
                                                <label for="viatura_${militar.id}">
                                                    <i class="fas fa-truck me-1"></i> Viatura
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="campos_administrativos_${militar.id}" class="campos-administrativos-row" style="display: none;">
                        <td colspan="7">
                            <div class="card border-info bg-light">
                                <div class="card-body py-3">
                                    <h6 class="text-info mb-3">Configurações Administrativas - ${militar.nome_completo}</h6>
                                    <div class="row g-3">
                                        <div class="col-md-12">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="secao_administrativa_${militar.id}" 
                                                       placeholder="Ex: Seção Administrativa" list="secoes_admin_disponiveis" autocomplete="off">
                                                <label for="secao_administrativa_${militar.id}">
                                                    <i class="fas fa-building me-1"></i> Seção Administrativa
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = stats + `
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th style="width: 50px; text-align: center; vertical-align: middle;">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                                    </div>
                                </th>
                                <th style="width: 60px; text-align: center; vertical-align: middle;">#</th>
                                <th style="width: 80px; text-align: center; vertical-align: middle;">Foto</th>
                                <th style="vertical-align: middle;">Nome Completo</th>
                                <th style="width: 200px; vertical-align: middle;">Lotação</th>
                                <th style="width: 250px; text-align: center; vertical-align: middle;">Situação</th>
                                <th style="width: 150px; text-align: center; vertical-align: middle;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${militaresList}
                        </tbody>
                    </table>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar militares da organização:', error);
        mostrarAlerta('Erro ao carregar militares da organização', 'danger');
    }
}

// Função para calcular horários
function calcularHorarios() {
    const turno = document.getElementById('configTurno').value;
    const horaInicio = document.getElementById('configHoraInicio').value;
    const horaFim = document.getElementById('configHoraFim');
    
    if (!turno || !horaInicio) {
        horaFim.value = '';
        return;
    }
    
    const [hora, minuto] = horaInicio.split(':').map(Number);
    const inicioMinutos = hora * 60 + minuto;
    
    let duracaoMinutos;
    switch(turno) {
        case '2h': duracaoMinutos = 120; break;
        case '4h': duracaoMinutos = 240; break;
        case '6h': duracaoMinutos = 360; break;
        case '8h': duracaoMinutos = 480; break;
        case '12h': duracaoMinutos = 720; break;
        case '18h': duracaoMinutos = 1080; break;
        case '24h': duracaoMinutos = 1440; break;
        default: return;
    }
    
    const fimMinutos = inicioMinutos + duracaoMinutos;
    const fimHora = Math.floor(fimMinutos / 60) % 24;
    const fimMinuto = fimMinutos % 60;
    
    horaFim.value = `${fimHora.toString().padStart(2, '0')}:${fimMinuto.toString().padStart(2, '0')}`;
}

// Função para controlar campos operacionais
function toggleCamposOperacionais(militarId) {
    const checkbox = document.getElementById(`militar_${militarId}`);
    const camposOperacionaisRow = document.getElementById(`campos_operacionais_${militarId}`);
    const camposAdministrativosRow = document.getElementById(`campos_administrativos_${militarId}`);
    const tipoServico = document.getElementById('configTipoServico').value;
    
    if (checkbox.checked) {
        if (tipoServico === 'operacional') {
            if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'table-row';
            if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
        } else if (tipoServico === 'administrativo') {
            if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
            if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'table-row';
        }
    } else {
        if (camposOperacionaisRow) camposOperacionaisRow.style.display = 'none';
        if (camposAdministrativosRow) camposAdministrativosRow.style.display = 'none';
    }
}

// Função para controlar visibilidade dos campos
function controlarCamposOperacionais() {
    const tipoServico = document.getElementById('configTipoServico').value;
    const checkboxes = document.querySelectorAll('.militar-checkbox:checked');
    
    if (tipoServico === 'administrativo') {
        carregarSecoesDisponiveis();
    }
    
    checkboxes.forEach(checkbox => {
        const militarId = checkbox.value;
        toggleCamposOperacionais(militarId);
    });
}

// Função para selecionar todos
function selecionarTodos() {
    const checkboxes = document.querySelectorAll('.militar-checkbox:not(:disabled)');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        toggleCamposOperacionais(checkbox.value);
    });
    const selectAll = document.getElementById('selectAll');
    if (selectAll) selectAll.checked = true;
}

// Função para desmarcar todos
function desmarcarTodos() {
    const checkboxes = document.querySelectorAll('.militar-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        const camposRow = document.getElementById(`campos_operacionais_${checkbox.value}`);
        if (camposRow) camposRow.style.display = 'none';
        const camposAdminRow = document.getElementById(`campos_administrativos_${checkbox.value}`);
        if (camposAdminRow) camposAdminRow.style.display = 'none';
    });
    const selectAll = document.getElementById('selectAll');
    if (selectAll) selectAll.checked = false;
}

// Função para pesquisar militares
let timeoutPesquisa = null;
function pesquisarMilitares() {
    if (timeoutPesquisa) clearTimeout(timeoutPesquisa);
    timeoutPesquisa = setTimeout(() => {
        const termo = document.getElementById('campoPesquisaMilitar').value.trim();
        carregarMilitaresOrganizacao(termo);
    }, 500);
}

// Função para limpar pesquisa
function limparPesquisa() {
    document.getElementById('campoPesquisaMilitar').value = '';
    carregarMilitaresOrganizacao();
}

// Função para controlar checkbox "Selecionar Todos"
function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.militar-checkbox:not(:disabled)');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            toggleCamposOperacionais(checkbox.value);
        }
    });
}

// Função para adicionar militares selecionados
async function adicionarMilitaresSelecionados() {
    const checkboxes = document.querySelectorAll('.militar-checkbox:checked');
    
    if (checkboxes.length === 0) {
        mostrarAlerta('Selecione pelo menos um militar para adicionar à escala', 'warning');
        return;
    }
    
    const militaresIds = Array.from(checkboxes).map(cb => cb.value);
    const tipoServico = document.getElementById('configTipoServico').value;
    const turno = document.getElementById('configTurno').value;
    const horaInicio = document.getElementById('configHoraInicio').value;
    const horaFim = document.getElementById('configHoraFim').value;
    
    if (!turno || !horaInicio || !horaFim) {
        mostrarAlerta('Preencha todos os campos de configuração (Turno, Hora Início e Hora Término)', 'warning');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('militares_coletivo', militaresIds.join(','));
        formData.append('funcao_coletivo', 'militar');
        formData.append('tipo_servico_coletivo', tipoServico);
        formData.append('turno_coletivo', turno);
        formData.append('hora_inicio_coletivo', horaInicio);
        formData.append('hora_fim_coletivo', horaFim);
        formData.append('observacoes_coletivo', 'Adicionado via seleção múltipla');
        
        // Coletar dados operacionais ou administrativos
        if (tipoServico === 'operacional') {
            const dadosOperacionais = [];
            militaresIds.forEach(militarId => {
                const funcao = document.getElementById(`funcao_operacional_${militarId}`)?.value || '';
                const equipe = document.getElementById(`equipe_${militarId}`)?.value || '';
                const viatura = document.getElementById(`viatura_${militarId}`)?.value || '';
                
                dadosOperacionais.push({
                    militar_id: militarId,
                    funcao_operacional: funcao,
                    equipe: equipe,
                    viatura: viatura
                });
            });
            formData.append('dados_operacionais', JSON.stringify(dadosOperacionais));
        } else if (tipoServico === 'administrativo') {
            const dadosAdministrativos = [];
            militaresIds.forEach(militarId => {
                const secao = document.getElementById(`secao_administrativa_${militarId}`)?.value || '';
                
                if (!secao.trim()) {
                    mostrarAlerta(`Seção administrativa é obrigatória para o militar ${militarId}`, 'warning');
                    return;
                }
                
                dadosAdministrativos.push({
                    militar_id: militarId,
                    secao_administrativa: secao
                });
            });
            formData.append('dados_administrativos', JSON.stringify(dadosAdministrativos));
        }
        
        // Obter CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                         getCookie('csrftoken');
        
        // Usar escalaId do escopo global se disponível
        const idEscala = typeof escalaId !== 'undefined' ? escalaId : (typeof window.escalaId !== 'undefined' ? window.escalaId : null);
        if (!idEscala) {
            mostrarAlerta('Erro: ID da escala não encontrado. Recarregue a página.', 'danger');
            return;
        }
        
        const response = await fetch(`/militares/escalas/${idEscala}/api/adicionar-coletivo/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            desmarcarTodos();
            // Fechar modal e recarregar
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalGerenciarMilitares'));
            if (modal) modal.hide();
            
            // Recarregar o conteúdo do modal principal
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            mostrarAlerta(data.message, 'danger');
        }
    } catch (error) {
        console.error('Erro ao adicionar militares:', error);
        mostrarAlerta('Erro ao adicionar militares à escala', 'danger');
    }
}

// Função para obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Função para mostrar alerta
function mostrarAlerta(mensagem, tipo = 'info') {
    const modal = document.getElementById('modalAlerta');
    if (!modal) {
        alert(mensagem);
        return;
    }
    
    const header = document.getElementById('modalAlertaHeader');
    const icon = document.getElementById('modalAlertaIcon');
    const titulo = document.getElementById('modalAlertaTitulo');
    const mensagemEl = document.getElementById('modalAlertaMensagem');
    
    const configs = {
        'success': { icon: 'fas fa-check-circle', titulo: 'Sucesso', headerClass: 'bg-success text-white', iconClass: 'text-success' },
        'error': { icon: 'fas fa-times-circle', titulo: 'Erro', headerClass: 'bg-danger text-white', iconClass: 'text-danger' },
        'warning': { icon: 'fas fa-exclamation-triangle', titulo: 'Atenção', headerClass: 'bg-warning text-dark', iconClass: 'text-warning' },
        'info': { icon: 'fas fa-info-circle', titulo: 'Informação', headerClass: 'bg-info text-white', iconClass: 'text-info' },
        'danger': { icon: 'fas fa-times-circle', titulo: 'Erro', headerClass: 'bg-danger text-white', iconClass: 'text-danger' }
    };
    
    const config = configs[tipo] || configs['info'];
    
    header.className = `modal-header ${config.headerClass}`;
    icon.className = `${config.icon} me-2 ${config.iconClass}`;
    titulo.textContent = config.titulo;
    mensagemEl.textContent = mensagem;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Função para mostrar confirmação
function mostrarConfirmacao(mensagem, callback) {
    const modal = document.getElementById('modalConfirmacao');
    if (!modal) {
        if (confirm(mensagem)) callback();
        return;
    }
    
    const mensagemEl = document.getElementById('modalConfirmacaoMensagem');
    const confirmarBtn = document.getElementById('modalConfirmacaoConfirmar');
    
    mensagemEl.textContent = mensagem;
    
    const novoConfirmarBtn = confirmarBtn.cloneNode(true);
    confirmarBtn.parentNode.replaceChild(novoConfirmarBtn, confirmarBtn);
    
    novoConfirmarBtn.addEventListener('click', function() {
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        if (callback) callback();
    });
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Função para atualizar militares escalados
function atualizarMilitaresEscalados() {
    carregarMilitaresOrganizacao();
    mostrarAlerta('Lista atualizada com sucesso!', 'success');
}

// Carregar seções disponíveis
async function carregarSecoesDisponiveis() {
    try {
        const response = await fetch('/militares/api/secoes-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            let datalist = document.getElementById('secoes_admin_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'secoes_admin_disponiveis';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            data.secoes.forEach(secao => {
                const option = document.createElement('option');
                option.value = secao;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar seções administrativas:', error);
    }
}

// Carregar equipes disponíveis
async function carregarEquipesDisponiveis() {
    try {
        const response = await fetch('/militares/api/equipes-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            let datalist = document.getElementById('equipes_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'equipes_disponiveis';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            data.equipes.forEach(equipe => {
                const option = document.createElement('option');
                option.value = equipe.nome;
                option.textContent = equipe.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar equipes:', error);
    }
}

// Carregar funções operacionais disponíveis
async function carregarFuncoesDisponiveis() {
    try {
        const response = await fetch('/militares/api/funcoes-operacionais-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            let datalist = document.getElementById('funcoes_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'funcoes_disponiveis';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            data.funcoes.forEach(funcao => {
                const option = document.createElement('option');
                option.value = funcao.nome;
                option.textContent = funcao.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar funções:', error);
    }
}

// Carregar viaturas disponíveis
async function carregarViaturasDisponiveis() {
    try {
        const response = await fetch('/militares/api/viaturas-disponiveis/');
        const data = await response.json();
        
        if (data.success) {
            let datalist = document.getElementById('viaturas_disponiveis');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'viaturas_disponiveis';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            data.viaturas.forEach(viatura => {
                const option = document.createElement('option');
                option.value = viatura.nome;
                option.textContent = viatura.label;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar viaturas:', error);
    }
}

// Função para abrir modal de gerenciar militares
function abrirModalGerenciarMilitares() {
    // Verificar se o modal já existe no body principal
    let modal = document.getElementById('modalGerenciarMilitares');
    
    // Se não existir no body, buscar dentro do modal principal e mover para o body
    if (!modal || !document.body.contains(modal)) {
        // Buscar o modal dentro do conteúdo do modal principal
        const modalContent = document.querySelector('#modalEscalaDetailBody #modalGerenciarMilitares') || 
                            document.querySelector('#modalEscalaDetailAutoBody #modalGerenciarMilitares') ||
                            document.querySelector('#modalGerenciarMilitares');
        
        if (modalContent) {
            // Se já existe no body mas não está acessível, remover primeiro
            if (modal && document.body.contains(modal)) {
                modal.remove();
            }
            
            // Mover o modal para o body principal (não clonar, mover de fato)
            if (modalContent.parentNode !== document.body) {
                document.body.appendChild(modalContent);
            }
            modal = modalContent;
        } else {
            console.error('Modal de gerenciar militares não encontrado');
            alert('Erro: Modal de gerenciar militares não encontrado. Recarregue a página.');
            return;
        }
    }
    
    // Configurar event listener se ainda não tiver
    if (!modal.hasAttribute('data-listener-attached')) {
        modal.setAttribute('data-listener-attached', 'true');
        modal.addEventListener('show.bs.modal', function() {
            // Carregar militares imediatamente quando o modal abrir
            if (typeof carregarMilitaresOrganizacao === 'function') {
                carregarMilitaresOrganizacao();
            }
            if (typeof controlarCamposOperacionais === 'function') {
                controlarCamposOperacionais();
            }
            if (typeof carregarEquipesDisponiveis === 'function') {
                carregarEquipesDisponiveis();
            }
            if (typeof carregarFuncoesDisponiveis === 'function') {
                carregarFuncoesDisponiveis();
            }
            if (typeof carregarViaturasDisponiveis === 'function') {
                carregarViaturasDisponiveis();
            }
        });
    }
    
    // Mostrar loading no container antes de abrir o modal
    const container = document.getElementById('militaresOrganizacaoContainer');
    if (container) {
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando militares da organização...</p>
            </div>
        `;
    }
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Carregar militares imediatamente após abrir o modal (garantir que carregue)
    // Usar múltiplos timeouts para garantir que carregue
    setTimeout(() => {
        if (typeof carregarMilitaresOrganizacao === 'function') {
            carregarMilitaresOrganizacao();
        } else {
            console.error('Função carregarMilitaresOrganizacao não encontrada');
        }
    }, 50);
    
    setTimeout(() => {
        if (typeof controlarCamposOperacionais === 'function') {
            controlarCamposOperacionais();
        }
        if (typeof carregarEquipesDisponiveis === 'function') {
            carregarEquipesDisponiveis();
        }
        if (typeof carregarFuncoesDisponiveis === 'function') {
            carregarFuncoesDisponiveis();
        }
        if (typeof carregarViaturasDisponiveis === 'function') {
            carregarViaturasDisponiveis();
        }
    }, 150);
}

// Mover modal para o body principal quando o conteúdo for carregado
function moverModalParaBody() {
    const modal = document.querySelector('#modalEscalaDetailBody #modalGerenciarMilitares') || 
                  document.querySelector('#modalEscalaDetailAutoBody #modalGerenciarMilitares');
    
    if (modal && modal.parentNode !== document.body) {
        // Verificar se já existe no body
        const existingModal = document.getElementById('modalGerenciarMilitares');
        if (existingModal && document.body.contains(existingModal)) {
            existingModal.remove();
        }
        
        // Mover para o body
        document.body.appendChild(modal);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Mover modal para o body principal
    moverModalParaBody();
    
    // Event listener para o modal de gerenciar militares (se já estiver no DOM)
    const modal = document.getElementById('modalGerenciarMilitares');
    if (modal) {
        if (!modal.hasAttribute('data-listener-dom-attached')) {
            modal.setAttribute('data-listener-dom-attached', 'true');
            modal.addEventListener('show.bs.modal', function() {
                // Mostrar loading
                const container = document.getElementById('militaresOrganizacaoContainer');
                if (container && (!container.innerHTML || container.innerHTML.trim() === '' || container.innerHTML.includes('<!-- Será carregado via AJAX -->'))) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-3 text-muted">Carregando militares da organização...</p>
                        </div>
                    `;
                }
                
                // Carregar militares imediatamente quando o modal abrir
                setTimeout(() => {
                    if (typeof carregarMilitaresOrganizacao === 'function') {
                        carregarMilitaresOrganizacao();
                    } else {
                        console.error('Função carregarMilitaresOrganizacao não encontrada');
                    }
                }, 50);
                
                setTimeout(() => {
                    if (typeof controlarCamposOperacionais === 'function') {
                        controlarCamposOperacionais();
                    }
                    if (typeof carregarEquipesDisponiveis === 'function') {
                        carregarEquipesDisponiveis();
                    }
                    if (typeof carregarFuncoesDisponiveis === 'function') {
                        carregarFuncoesDisponiveis();
                    }
                    if (typeof carregarViaturasDisponiveis === 'function') {
                        carregarViaturasDisponiveis();
                    }
                }, 150);
            });
        }
    }
});

// Executar imediatamente (caso o DOM já esteja carregado)
moverModalParaBody();
</script>
