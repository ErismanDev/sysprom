<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-gas-pump me-2"></i>{% if abastecimento %}Editar Abastecimento{% else %}Novo Abastecimento{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formAbastecimentoEquipamento" method="post" action="{% if abastecimento %}{% url 'militares:equipamento_abastecimento_update' abastecimento.pk %}{% else %}{% url 'militares:equipamento_abastecimento_create' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.equipamento.id_for_label }}" class="form-label">
                    Equipamento <span class="text-danger">*</span>
                </label>
                {{ form.equipamento }}
                {% if form.equipamento.errors %}
                    <div class="text-danger small">{{ form.equipamento.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.data_abastecimento.id_for_label }}" class="form-label">
                    Data e Hora do Abastecimento <span class="text-danger">*</span>
                </label>
                {{ form.data_abastecimento }}
                {% if form.data_abastecimento.errors %}
                    <div class="text-danger small">{{ form.data_abastecimento.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.quantidade_litros.id_for_label }}" class="form-label">
                    Quantidade (Litros) <span class="text-danger">*</span>
                </label>
                {{ form.quantidade_litros }}
                {% if form.quantidade_litros.errors %}
                    <div class="text-danger small">{{ form.quantidade_litros.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_litro.id_for_label }}" class="form-label">
                    Valor por Litro (R$) <span class="text-danger">*</span>
                </label>
                {{ form.valor_litro }}
                {% if form.valor_litro.errors %}
                    <div class="text-danger small">{{ form.valor_litro.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_total.id_for_label }}" class="form-label">
                    Valor Total (R$) <span class="text-danger">*</span>
                </label>
                {{ form.valor_total }}
                {% if form.valor_total.errors %}
                    <div class="text-danger small">{{ form.valor_total.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_uso_abastecimento.id_for_label }}" class="form-label">
                    Horas de Uso no Abastecimento <span class="text-danger">*</span>
                </label>
                {{ form.horas_uso_abastecimento }}
                {% if form.horas_uso_abastecimento.errors %}
                    <div class="text-danger small">{{ form.horas_uso_abastecimento.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Horas de uso do equipamento no momento do abastecimento
                </small>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.tipo_combustivel.id_for_label }}" class="form-label">
                    Tipo de Combustível <span class="text-danger">*</span>
                </label>
                {{ form.tipo_combustivel }}
                {% if form.tipo_combustivel.errors %}
                    <div class="text-danger small">{{ form.tipo_combustivel.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.posto_fornecedor.id_for_label }}" class="form-label">
                    Posto/Fornecedor
                </label>
                {{ form.posto_fornecedor }}
                {% if form.posto_fornecedor.errors %}
                    <div class="text-danger small">{{ form.posto_fornecedor.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.com_aditivos }}
                    <label class="form-check-label" for="{{ form.com_aditivos.id_for_label }}">
                        Com Aditivos
                    </label>
                </div>
            </div>
        </div>
        
        <div id="aditivosSection" style="display: none;">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.tipo_aditivo.id_for_label }}" class="form-label">
                        Tipo de Aditivo
                    </label>
                    {{ form.tipo_aditivo }}
                    {% if form.tipo_aditivo.errors %}
                        <div class="text-danger small">{{ form.tipo_aditivo.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.quantidade_aditivo.id_for_label }}" class="form-label">
                        Quantidade de Aditivo
                    </label>
                    {{ form.quantidade_aditivo }}
                    {% if form.quantidade_aditivo.errors %}
                        <div class="text-danger small">{{ form.quantidade_aditivo.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.valor_unitario_aditivo.id_for_label }}" class="form-label">
                        Valor Unitário do Aditivo (R$)
                    </label>
                    {{ form.valor_unitario_aditivo }}
                    {% if form.valor_unitario_aditivo.errors %}
                        <div class="text-danger small">{{ form.valor_unitario_aditivo.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.valor_total_aditivo.id_for_label }}" class="form-label">
                        Valor Total do Aditivo (R$)
                    </label>
                    {{ form.valor_total_aditivo }}
                    {% if form.valor_total_aditivo.errors %}
                        <div class="text-danger small">{{ form.valor_total_aditivo.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.valor_total_nota.id_for_label }}" class="form-label">
                        Valor Total da Nota (R$)
                    </label>
                    {{ form.valor_total_nota }}
                    {% if form.valor_total_nota.errors %}
                        <div class="text-danger small">{{ form.valor_total_nota.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                    Responsável pelo Abastecimento
                </label>
                {{ form.responsavel }}
                {% if form.responsavel.errors %}
                    <div class="text-danger small">{{ form.responsavel.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                    {{ form.ativo }}
                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                        Ativo
                    </label>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    Observações
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="text-danger small">{{ form.observacoes.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Mostrar/ocultar seção de aditivos
    $('#{{ form.com_aditivos.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#aditivosSection').show();
        } else {
            $('#aditivosSection').hide();
        }
    });
    
    // Inicializar visibilidade da seção de aditivos
    if ($('#{{ form.com_aditivos.id_for_label }}').is(':checked')) {
        $('#aditivosSection').show();
    }
    
    // Calcular valor total automaticamente
    $('#{{ form.quantidade_litros.id_for_label }}, #{{ form.valor_litro.id_for_label }}').on('input', function() {
        calcularValorTotal();
    });
    
    // Calcular valor total do aditivo
    $('#{{ form.quantidade_aditivo.id_for_label }}, #{{ form.valor_unitario_aditivo.id_for_label }}').on('input', function() {
        calcularValorAditivo();
    });
    
    // Calcular valor total da nota
    $('#{{ form.valor_total.id_for_label }}, #{{ form.valor_total_aditivo.id_for_label }}').on('input', function() {
        calcularValorNota();
    });
    
    // Formatação de valores monetários
    $('#{{ form.valor_litro.id_for_label }}, #{{ form.valor_unitario_aditivo.id_for_label }}').on('blur', function() {
        formatarMoeda($(this));
    });
    
    // Submissão do formulário via AJAX
    $('#formAbastecimentoEquipamento').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var formData = form.serialize();
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (typeof response === 'object' && response.success) {
                    $('#abastecimentoModal').modal('hide');
                    location.reload();
                } else {
                    // Recarregar o formulário com erros
                    $('#abastecimentoModalBody').html(response);
                }
            },
            error: function(xhr) {
                if (xhr.status === 200) {
                    $('#abastecimentoModalBody').html(xhr.responseText);
                } else {
                    alert('Erro ao salvar abastecimento. Por favor, tente novamente.');
                }
            }
        });
    });
});

function calcularValorTotal() {
    var quantidade = parseFloat($('#{{ form.quantidade_litros.id_for_label }}').val()) || 0;
    var valorLitro = parseFloat($('#{{ form.valor_litro.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorTotal = quantidade * valorLitro;
    
    if (valorTotal > 0) {
        $('#{{ form.valor_total.id_for_label }}').val(valorTotal.toFixed(2).replace('.', ','));
    }
}

function calcularValorAditivo() {
    var quantidade = parseFloat($('#{{ form.quantidade_aditivo.id_for_label }}').val()) || 0;
    var valorUnitario = parseFloat($('#{{ form.valor_unitario_aditivo.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorTotal = quantidade * valorUnitario;
    
    if (valorTotal > 0) {
        $('#{{ form.valor_total_aditivo.id_for_label }}').val(valorTotal.toFixed(2).replace('.', ','));
    }
    calcularValorNota();
}

function calcularValorNota() {
    var valorCombustivel = parseFloat($('#{{ form.valor_total.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorAditivo = parseFloat($('#{{ form.valor_total_aditivo.id_for_label }}').val().replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    var valorNota = valorCombustivel + valorAditivo;
    
    if (valorNota > 0) {
        $('#{{ form.valor_total_nota.id_for_label }}').val(valorNota.toFixed(2).replace('.', ','));
    }
}

function formatarMoeda(input) {
    var valor = input.val().replace(/[^\d,]/g, '');
    if (valor) {
        valor = valor.replace(',', '.');
        input.val(parseFloat(valor).toFixed(2).replace('.', ','));
    }
}
</script>

