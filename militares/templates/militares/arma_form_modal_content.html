{% load static %}

<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarArmaModalLabel">
        <i class="fas fa-gun me-2"></i>
        {% if object %}Editar Arma{% else %}Nova Arma{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="formCriarArma" method="post" action="{% if object %}{% url 'militares:arma_update' object.pk %}{% else %}{% url 'militares:arma_create' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Configuração de Arma -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Dica:</strong> Selecione uma configuração de arma para preencher automaticamente os campos tipo, calibre, marca e modelo.
                    <a href="{% url 'militares:configuracao_arma_list' %}" target="_blank" class="ms-2">
                        <i class="fas fa-external-link-alt"></i> Gerenciar configurações
                    </a>
                </div>
            </div>
            <div class="col-md-12 mb-3">
                <label for="{{ form.configuracao_arma.id_for_label }}" class="form-label">
                    {{ form.configuracao_arma.label }}
                </label>
                {{ form.configuracao_arma }}
                {% if form.configuracao_arma.help_text %}
                    <small class="form-text text-muted">{{ form.configuracao_arma.help_text }}</small>
                {% endif %}
                {% if form.configuracao_arma.errors %}
                    <div class="invalid-feedback d-block">{{ form.configuracao_arma.errors }}</div>
                {% endif %}
                <div id="configuracao-imagem-preview" class="mt-2" style="display: none;">
                    <img id="configuracao-imagem" src="" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                </div>
            </div>
        </div>
        
        <!-- Identificação -->
        <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Identificação</h5>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                    Número de Série <span class="text-danger">*</span>
                </label>
                {{ form.numero_serie }}
                {% if form.numero_serie.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_serie.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                    Tipo <span class="text-danger">*</span>
                </label>
                {{ form.tipo }}
                {% if form.tipo.errors %}
                    <div class="invalid-feedback d-block">{{ form.tipo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.calibre.id_for_label }}" class="form-label">
                    Calibre <span class="text-danger">*</span>
                </label>
                {{ form.calibre }}
                {% if form.calibre.errors %}
                    <div class="invalid-feedback d-block">{{ form.calibre.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-2 mb-3">
                <label for="{{ form.situacao.id_for_label }}" class="form-label">
                    Situação <span class="text-danger">*</span>
                </label>
                {{ form.situacao }}
                {% if form.situacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.situacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.estado_conservacao.id_for_label }}" class="form-label">
                    Estado de Conservação
                </label>
                {{ form.estado_conservacao }}
                {% if form.estado_conservacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.estado_conservacao.errors }}</div>
                {% endif %}
                {% if form.estado_conservacao.help_text %}
                    <small class="form-text text-muted">{{ form.estado_conservacao.help_text }}</small>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.marca.id_for_label }}" class="form-label">
                    Marca <span class="text-danger">*</span>
                </label>
                {{ form.marca }}
                {% if form.marca.errors %}
                    <div class="invalid-feedback d-block">{{ form.marca.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.modelo.id_for_label }}" class="form-label">
                    Modelo <span class="text-danger">*</span>
                </label>
                {{ form.modelo }}
                {% if form.modelo.errors %}
                    <div class="invalid-feedback d-block">{{ form.modelo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-2 mb-3">
                <label for="{{ form.capacidade_carregador.id_for_label }}" class="form-label">
                    Capacidade
                </label>
                {{ form.capacidade_carregador }}
                {% if form.capacidade_carregador.errors %}
                    <div class="invalid-feedback d-block">{{ form.capacidade_carregador.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Alma Raiada -->
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.alma_raiada }}
                    <label class="form-check-label" for="{{ form.alma_raiada.id_for_label }}">
                        {{ form.alma_raiada.label }}
                    </label>
                    {% if form.alma_raiada.help_text %}
                        <small class="form-text text-muted d-block">{{ form.alma_raiada.help_text }}</small>
                    {% endif %}
                </div>
                {% if form.alma_raiada.errors %}
                    <div class="invalid-feedback d-block">{{ form.alma_raiada.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Campos de Raias -->
        <div class="row" id="raias-campos" style="display: none;">
            <div class="col-md-4 mb-3">
                <label for="{{ form.quantidade_raias.id_for_label }}" class="form-label">
                    Quantidade de Raias
                </label>
                {{ form.quantidade_raias }}
                {% if form.quantidade_raias.help_text %}
                    <small class="form-text text-muted">{{ form.quantidade_raias.help_text }}</small>
                {% endif %}
                {% if form.quantidade_raias.errors %}
                    <div class="invalid-feedback d-block">{{ form.quantidade_raias.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.direcao_raias.id_for_label }}" class="form-label">
                    Direção das Raias
                </label>
                {{ form.direcao_raias }}
                {% if form.direcao_raias.help_text %}
                    <small class="form-text text-muted">{{ form.direcao_raias.help_text }}</small>
                {% endif %}
                {% if form.direcao_raias.errors %}
                    <div class="invalid-feedback d-block">{{ form.direcao_raias.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Organização -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-building me-2"></i>Organização Responsável</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="organograma-select" class="form-label">
                    Organização (Onde a arma está na carga) <span class="text-danger">*</span>
                </label>
                <select name="organograma-select" id="organograma-select" class="form-select" required>
                    <option value="">Selecione uma organização do organograma...</option>
                </select>
                <small class="form-text text-muted">
                    Selecione a organização onde a arma está na carga (Órgão, Grande Comando, Unidade ou Sub-Unidade).
                </small>
            </div>
        </div>
        
        <!-- Campos ocultos -->
        {{ form.orgao.as_hidden }}
        {{ form.grande_comando.as_hidden }}
        {{ form.unidade.as_hidden }}
        {{ form.sub_unidade.as_hidden }}
        
        {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
        <div class="alert alert-danger">
            {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
            {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
            {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
            {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
        </div>
        {% endif %}
        
        <!-- Reserva de Armamento -->
        <div class="row" id="reserva-armamento-campos" style="display: none;">
            <div class="col-md-12 mb-3">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Responsável:</strong> Chefe da Organização onde a arma está na carga.
                    <br>
                    <small>A responsabilidade fica com o chefe da organização selecionada acima.</small>
                </div>
            </div>
        </div>
        
        <!-- Inquérito PM -->
        <div class="row" id="inquerito-pm-campos" style="display: none;">
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_inquerito_pm.id_for_label }}" class="form-label">
                    Nº Inquérito PM <span class="text-danger">*</span>
                </label>
                {{ form.numero_inquerito_pm }}
                {% if form.numero_inquerito_pm.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_inquerito_pm.errors }}</div>
                {% endif %}
                {% if form.numero_inquerito_pm.help_text %}
                    <small class="form-text text-muted">{{ form.numero_inquerito_pm.help_text }}</small>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.encarregado_inquerito_pm.id_for_label }}" class="form-label">
                    Encarregado do Inquérito PM <span class="text-danger">*</span>
                </label>
                {{ form.encarregado_inquerito_pm }}
                {% if form.encarregado_inquerito_pm.errors %}
                    <div class="invalid-feedback d-block">{{ form.encarregado_inquerito_pm.errors }}</div>
                {% endif %}
                {% if form.encarregado_inquerito_pm.help_text %}
                    <small class="form-text text-muted">{{ form.encarregado_inquerito_pm.help_text }}</small>
                {% endif %}
            </div>
        </div>
        
        <!-- Inquérito PC -->
        <div class="row" id="inquerito-pc-campos" style="display: none;">
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_inquerito_pc.id_for_label }}" class="form-label">
                    Nº Inquérito PC <span class="text-danger">*</span>
                </label>
                {{ form.numero_inquerito_pc }}
                {% if form.numero_inquerito_pc.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_inquerito_pc.errors }}</div>
                {% endif %}
                {% if form.numero_inquerito_pc.help_text %}
                    <small class="form-text text-muted">{{ form.numero_inquerito_pc.help_text }}</small>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.delegado_inquerito_pc.id_for_label }}" class="form-label">
                    Delegado Responsável <span class="text-danger">*</span>
                </label>
                {{ form.delegado_inquerito_pc }}
                {% if form.delegado_inquerito_pc.errors %}
                    <div class="invalid-feedback d-block">{{ form.delegado_inquerito_pc.errors }}</div>
                {% endif %}
                {% if form.delegado_inquerito_pc.help_text %}
                    <small class="form-text text-muted">{{ form.delegado_inquerito_pc.help_text }}</small>
                {% endif %}
            </div>
        </div>
        
        <!-- Informações de Tombamento -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Informações de Tombamento</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.nome_tombamento.id_for_label }}" class="form-label">
                    Nome do Tombamento
                </label>
                {{ form.nome_tombamento }}
                {% if form.nome_tombamento.errors %}
                    <div class="invalid-feedback d-block">{{ form.nome_tombamento.errors }}</div>
                {% endif %}
                {% if form.nome_tombamento.help_text %}
                    <small class="form-text text-muted">{{ form.nome_tombamento.help_text }}</small>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.numero_tombamento.id_for_label }}" class="form-label">
                    Nº Tombamento
                </label>
                {{ form.numero_tombamento }}
                {% if form.numero_tombamento.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_tombamento.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.cod_tombamento.id_for_label }}" class="form-label">
                    COD
                </label>
                {{ form.cod_tombamento }}
                {% if form.cod_tombamento.errors %}
                    <div class="invalid-feedback d-block">{{ form.cod_tombamento.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.local_tombamento.id_for_label }}" class="form-label">
                    Local
                </label>
                {{ form.local_tombamento }}
                {% if form.local_tombamento.errors %}
                    <div class="invalid-feedback d-block">{{ form.local_tombamento.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Documentação -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Documentação</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_registro_policia.id_for_label }}" class="form-label">
                    Nº Registro no Exército Brasileiro
                </label>
                {{ form.numero_registro_policia }}
                {% if form.numero_registro_policia.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_registro_policia.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_guia_transito.id_for_label }}" class="form-label">
                    Nº Guia de Trânsito
                </label>
                {{ form.numero_guia_transito }}
                {% if form.numero_guia_transito.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_guia_transito.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Aquisição -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-dollar-sign me-2"></i>Aquisição</h5>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="id_data_aquisicao" class="form-label">Data de Aquisição</label>
                {% comment %}
                Debug: object={{ object|default:"None" }}, 
                object.data_aquisicao={{ object.data_aquisicao|default:"None" }},
                form.data_aquisicao.value={{ form.data_aquisicao.value|default:"None" }}
                {% endcomment %}
                {% if form.data_aquisicao.value %}
                    {% with data_form=form.data_aquisicao.value|date:"Y-m-d" %}
                        <input type="date" 
                               name="data_aquisicao" 
                               id="id_data_aquisicao" 
                               class="form-control" 
                               value="{{ data_form }}"
                               data-data-original="{{ data_form }}"
                               data-source="form">
                    {% endwith %}
                {% elif object and object.data_aquisicao %}
                    {% with data_obj=object.data_aquisicao|date:"Y-m-d" %}
                        <input type="date" 
                               name="data_aquisicao" 
                               id="id_data_aquisicao" 
                               class="form-control" 
                               value="{{ data_obj }}"
                               data-data-original="{{ data_obj }}"
                               data-source="object">
                    {% endwith %}
                {% else %}
                    <input type="date" 
                           name="data_aquisicao" 
                           id="id_data_aquisicao" 
                           class="form-control" 
                           value=""
                           data-data-original=""
                           data-source="none">
                {% endif %}
                {% if form.data_aquisicao.errors %}
                    <div class="invalid-feedback d-block">{{ form.data_aquisicao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="id_valor_aquisicao" class="form-label">Valor de Aquisição (R$)</label>
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="text" name="valor_aquisicao" id="id_valor_aquisicao" class="form-control" value="" placeholder="0,00" autocomplete="off" data-valor-original="{% if object and object.valor_aquisicao %}{{ object.valor_aquisicao }}{% endif %}">
                </div>
                {% if form.valor_aquisicao.errors %}
                    <div class="invalid-feedback d-block">{{ form.valor_aquisicao.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Digite o valor - formatação automática em R$</small>
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.fornecedor.id_for_label }}" class="form-label">Fornecedor</label>
                {{ form.fornecedor }}
                {% if form.fornecedor.errors %}
                    <div class="invalid-feedback d-block">{{ form.fornecedor.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Observações -->
        <hr>
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Ativo -->
        <div class="mb-3 form-check">
            {{ form.ativo }}
            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                Arma ativa
            </label>
        </div>
        
        <div id="criarArmaErrors" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="criarArmaErrorMessage"></span>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>{% if object %}Atualizar{% else %}Salvar{% endif %} Arma
        </button>
    </div>
</form>

<script>
(function() {
    'use strict';
    
    // Funcionalidade de seleção hierárquica única do organograma
    const organogramaSelect = document.getElementById('organograma-select');
    const orgaoHidden = document.getElementById('id_orgao');
    const grandeComandoHidden = document.getElementById('id_grande_comando');
    const unidadeHidden = document.getElementById('id_unidade');
    const subUnidadeHidden = document.getElementById('id_sub_unidade');
    
    // Função para carregar toda a hierarquia do organograma
    async function carregarOrganogramaCompleto() {
        if (!organogramaSelect) return;
        
        try {
            const response = await fetch('{% url "militares:ajax_organograma_completo" %}');
            const data = await response.json();
            
            organogramaSelect.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                organogramaSelect.appendChild(option);
            });
            
            // Selecionar opção atual se estiver editando
            {% if object %}
            selecionarOpcaoAtual();
            {% elif organograma_selecionado %}
            organogramaSelect.value = '{{ organograma_selecionado }}';
            atualizarCamposOcultos();
            {% endif %}
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
        }
    }
    
    // Função para selecionar a opção atual baseada nos valores do objeto
    function selecionarOpcaoAtual() {
        {% if object %}
        const orgaoId = {% if object.orgao %}{{ object.orgao.id }}{% else %}null{% endif %};
        const grandeComandoId = {% if object.grande_comando %}{{ object.grande_comando.id }}{% else %}null{% endif %};
        const unidadeId = {% if object.unidade %}{{ object.unidade.id }}{% else %}null{% endif %};
        const subUnidadeId = {% if object.sub_unidade %}{{ object.sub_unidade.id }}{% else %}null{% endif %};
        
        // Encontrar a opção correspondente
        for (let option of organogramaSelect.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                if (subUnidadeId && valor.sub_unidade_id === subUnidadeId) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (unidadeId && !subUnidadeId && valor.unidade_id === unidadeId && !valor.sub_unidade_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (grandeComandoId && !unidadeId && valor.grande_comando_id === grandeComandoId && !valor.unidade_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                } else if (orgaoId && !grandeComandoId && valor.orgao_id === orgaoId && !valor.grande_comando_id) {
                    organogramaSelect.value = option.value;
                    atualizarCamposOcultos();
                    return;
                }
            }
        }
        {% endif %}
    }
    
    // Função para atualizar campos ocultos
    function atualizarCamposOcultos() {
        if (!organogramaSelect) return;
        
        const selectedOption = organogramaSelect.options[organogramaSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    if (organogramaSelect) {
        organogramaSelect.addEventListener('change', atualizarCamposOcultos);
        carregarOrganogramaCompleto();
    }
    
    // Formatação de moeda
    const valorAquisicaoInput = document.getElementById('id_valor_aquisicao');
    if (valorAquisicaoInput) {
        // Formatar valor inicial se existir
        const valorOriginal = valorAquisicaoInput.getAttribute('data-valor-original');
        if (valorOriginal && valorOriginal !== '') {
            const valorFloat = parseFloat(valorOriginal);
            if (!isNaN(valorFloat)) {
                const partes = valorFloat.toFixed(2).split('.');
                const parteInteira = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                valorAquisicaoInput.value = parteInteira + ',' + partes[1];
            }
        }
        
        valorAquisicaoInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^\d,]/g, '');
            let partes = valor.split(',');
            if (partes.length > 2) {
                valor = partes[0] + ',' + partes.slice(1).join('');
            }
            if (partes.length === 2 && partes[1].length > 2) {
                valor = partes[0] + ',' + partes[1].substring(0, 2);
            }
            e.target.value = valor;
        });
        
        valorAquisicaoInput.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor) {
                e.target.value = '';
                return;
            }
            
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                    parteDecimal += '0';
                }
                if (parteDecimal === '') parteDecimal = '00';
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = parteInteira + ',' + parteDecimal;
            } else {
                let numeroLimpo = valor.replace(/[^\d]/g, '');
                if (numeroLimpo !== '') {
                    numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = numeroLimpo + ',00';
                } else {
                    e.target.value = '';
                }
            }
        });
        
        const form = valorAquisicaoInput.closest('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let valor = valorAquisicaoInput.value;
                if (valor) {
                    valorAquisicaoInput.value = valor.replace(/\./g, '').replace(',', '.');
                }
            });
        }
    }
    
    // Mostrar/ocultar campos de raias
    const almaRaiadaCheckbox = document.getElementById('id_alma_raiada');
    const raiasCampos = document.getElementById('raias-campos');
    const quantidadeRaiasInput = document.getElementById('id_quantidade_raias');
    const direcaoRaiasSelect = document.getElementById('id_direcao_raias');
    
    function toggleRaiasCampos() {
        if (almaRaiadaCheckbox && raiasCampos) {
            if (almaRaiadaCheckbox.checked) {
                raiasCampos.style.display = 'block';
                if (quantidadeRaiasInput) quantidadeRaiasInput.required = true;
                if (direcaoRaiasSelect) direcaoRaiasSelect.required = true;
            } else {
                raiasCampos.style.display = 'none';
                if (quantidadeRaiasInput) {
                    quantidadeRaiasInput.required = false;
                    quantidadeRaiasInput.value = '';
                }
                if (direcaoRaiasSelect) {
                    direcaoRaiasSelect.required = false;
                    direcaoRaiasSelect.value = '';
                }
            }
        }
    }
    
    if (almaRaiadaCheckbox) {
        almaRaiadaCheckbox.addEventListener('change', toggleRaiasCampos);
        toggleRaiasCampos();
    }
    
    // Mostrar/ocultar campos de responsável
    const situacaoSelect = document.getElementById('id_situacao');
    const reservaArmamentoCampos = document.getElementById('reserva-armamento-campos');
    const inqueritoPmCampos = document.getElementById('inquerito-pm-campos');
    const inqueritoPcCampos = document.getElementById('inquerito-pc-campos');
    const numeroInqueritoPmInput = document.getElementById('id_numero_inquerito_pm');
    const encarregadoInqueritoPmSelect = document.getElementById('id_encarregado_inquerito_pm');
    const numeroInqueritoPcInput = document.getElementById('id_numero_inquerito_pc');
    const delegadoInqueritoPcInput = document.getElementById('id_delegado_inquerito_pc');
    
    function toggleCamposResponsavel() {
        const situacao = situacaoSelect ? situacaoSelect.value : '';
        
        if (reservaArmamentoCampos) reservaArmamentoCampos.style.display = 'none';
        if (inqueritoPmCampos) inqueritoPmCampos.style.display = 'none';
        if (inqueritoPcCampos) inqueritoPcCampos.style.display = 'none';
        
        if (numeroInqueritoPmInput) {
            numeroInqueritoPmInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PM') numeroInqueritoPmInput.value = '';
        }
        if (encarregadoInqueritoPmSelect) {
            encarregadoInqueritoPmSelect.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PM') encarregadoInqueritoPmSelect.value = '';
        }
        if (numeroInqueritoPcInput) {
            numeroInqueritoPcInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PC') numeroInqueritoPcInput.value = '';
        }
        if (delegadoInqueritoPcInput) {
            delegadoInqueritoPcInput.required = false;
            if (situacao !== 'ANEXADO_INQUERITO_PC') delegadoInqueritoPcInput.value = '';
        }
        
        if (situacao === 'RESERVA_ARMAMENTO') {
            if (reservaArmamentoCampos) reservaArmamentoCampos.style.display = 'block';
        } else if (situacao === 'ANEXADO_INQUERITO_PM') {
            if (inqueritoPmCampos) inqueritoPmCampos.style.display = 'block';
            if (numeroInqueritoPmInput) numeroInqueritoPmInput.required = true;
            if (encarregadoInqueritoPmSelect) encarregadoInqueritoPmSelect.required = true;
        } else if (situacao === 'ANEXADO_INQUERITO_PC') {
            if (inqueritoPcCampos) inqueritoPcCampos.style.display = 'block';
            if (numeroInqueritoPcInput) numeroInqueritoPcInput.required = true;
            if (delegadoInqueritoPcInput) delegadoInqueritoPcInput.required = true;
        }
    }
    
    if (situacaoSelect) {
        situacaoSelect.addEventListener('change', toggleCamposResponsavel);
        toggleCamposResponsavel();
    }
    
    // Garantir que a data de aquisição seja carregada corretamente
    const dataAquisicaoInput = document.getElementById('id_data_aquisicao');
    if (dataAquisicaoInput) {
        const objectExists = dataAquisicaoInput.getAttribute('data-object-exists') === 'true';
        const hasData = dataAquisicaoInput.getAttribute('data-has-data') === 'true';
        const dataOriginal = dataAquisicaoInput.getAttribute('data-data-original');
        
        console.log('=== DEBUG Data de Aquisição ===');
        console.log('Objeto existe:', objectExists);
        console.log('Tem data:', hasData);
        console.log('Valor original (atributo):', dataOriginal);
        console.log('Valor atual (campo):', dataAquisicaoInput.value);
        
        // Se não tiver valor, tentar buscar do atributo data-data-original
        if (!dataAquisicaoInput.value && dataOriginal && dataOriginal !== '' && dataOriginal !== 'None') {
            console.log('Preenchendo campo com valor do atributo:', dataOriginal);
            dataAquisicaoInput.value = dataOriginal;
        }
        
        // Se ainda não tiver valor e o objeto existe, tentar usar o valor do formulário
        if (!dataAquisicaoInput.value && objectExists) {
            // Tentar buscar do campo hidden do formulário se existir
            const formDataInput = document.querySelector('input[name="data_aquisicao"][type="hidden"]');
            if (formDataInput && formDataInput.value) {
                console.log('Preenchendo campo com valor do formulário:', formDataInput.value);
                dataAquisicaoInput.value = formDataInput.value;
            }
        }
        
        console.log('Valor final:', dataAquisicaoInput.value);
        console.log('=== FIM DEBUG ===');
    }
    
    // Preencher campos automaticamente quando uma configuração de arma for selecionada
    const configuracaoSelect = document.getElementById('id_configuracao_arma') || document.querySelector('select[name="configuracao_arma"]');
    const tipoSelect = document.getElementById('id_tipo');
    const calibreSelect = document.getElementById('id_calibre');
    const marcaInput = document.getElementById('id_marca');
    const modeloInput = document.getElementById('id_modelo');
    const imagemPreview = document.getElementById('configuracao-imagem-preview');
    const imagemPreviewImg = document.getElementById('configuracao-imagem');
    
    if (configuracaoSelect) {
        configuracaoSelect.addEventListener('change', function() {
            const configuracaoId = this.value;
            if (imagemPreview) imagemPreview.style.display = 'none';
            
            if (!configuracaoId) return;
            
            const url = '{% url "militares:configuracao_arma_dados" 999 %}'.replace('999', configuracaoId);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (tipoSelect) {
                            tipoSelect.value = data.tipo;
                            tipoSelect.dispatchEvent(new Event('change'));
                        }
                        if (calibreSelect) {
                            calibreSelect.value = data.calibre;
                            calibreSelect.dispatchEvent(new Event('change'));
                        }
                        if (marcaInput) marcaInput.value = data.marca || '';
                        if (modeloInput) modeloInput.value = data.modelo || '';
                        
                        if (data.imagem_url && imagemPreviewImg) {
                            imagemPreviewImg.src = data.imagem_url;
                            if (imagemPreview) imagemPreview.style.display = 'block';
                        }
                    }
                })
                .catch(error => console.error('Erro na requisição:', error));
        });
        
        // Se estiver editando, tentar encontrar e selecionar a configuração correspondente
        {% if object %}
        setTimeout(function() {
            const armaTipo = tipoSelect ? tipoSelect.value : '';
            const armaCalibre = calibreSelect ? calibreSelect.value : '';
            const armaMarca = marcaInput ? marcaInput.value.trim() : '';
            const armaModelo = modeloInput ? modeloInput.value.trim() : '';
            
            if (armaTipo && armaCalibre && armaMarca && armaModelo) {
                // Buscar configuração que corresponda aos dados da arma
                const url = '{% url "militares:configuracao_arma_buscar" %}?tipo=' + encodeURIComponent(armaTipo) + 
                           '&calibre=' + encodeURIComponent(armaCalibre) + 
                           '&marca=' + encodeURIComponent(armaMarca) + 
                           '&modelo=' + encodeURIComponent(armaModelo);
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.id) {
                            // Configuração encontrada!
                            configuracaoSelect.value = data.id;
                            
                            // Carregar imagem se existir
                            if (data.imagem_url && imagemPreviewImg) {
                                imagemPreviewImg.src = data.imagem_url;
                                if (imagemPreview) imagemPreview.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => console.error('Erro ao buscar configuração:', error));
            }
        }, 300); // Aguardar um pouco para garantir que os campos estão carregados
        {% endif %}
    }
    
    // Submissão do formulário via AJAX
    const form = document.getElementById('formCriarArma');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            // Limpar mensagens de erro anteriores
            const errorDiv = document.getElementById('criarArmaErrors');
            const errorMessage = document.getElementById('criarArmaErrorMessage');
            if (errorDiv) errorDiv.classList.add('d-none');
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Verificar se a resposta é JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Se não for JSON, pode ser um erro HTML
                    return response.text().then(text => {
                        throw new Error('Resposta não é JSON');
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    // Sucesso - redirecionar
                    window.location.href = data.redirect_url || '{% url "militares:arma_list" %}';
                } else {
                    // Erro - mostrar mensagens
                    let errorMsg = data.message || 'Erro ao salvar arma';
                    
                    // Se houver erros de validação, adicionar detalhes
                    if (data.errors) {
                        const errorsList = [];
                        for (const field in data.errors) {
                            errorsList.push(`${field}: ${data.errors[field].join(', ')}`);
                        }
                        if (errorsList.length > 0) {
                            errorMsg += '\n' + errorsList.join('\n');
                        }
                    }
                    
                    if (errorDiv && errorMessage) {
                        errorMessage.textContent = errorMsg;
                        errorDiv.classList.remove('d-none');
                        // Scroll para o erro
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                if (errorDiv && errorMessage) {
                    errorMessage.textContent = 'Erro ao processar formulário. Verifique os campos obrigatórios.';
                    errorDiv.classList.remove('d-none');
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        });
    }
})();
</script>

