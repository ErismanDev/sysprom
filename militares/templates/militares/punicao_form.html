{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Punição{% endblock %}

{% block extra_css %}
<style>
.select2-container {
    width: 100% !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                        {% if object %}Editar Punição{% else %}Nova Punição{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando punição de {{ object.militar.nome_guerra }}{% else %}Registrar nova punição{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:punicao_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar para Lista
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados da Punição
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.militar.id_for_label }}" class="form-label">
                                            Militar <span class="text-danger">*</span>
                                        </label>
                                        {{ form.militar }}
                                        {% if form.militar.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.militar.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                            Tipo de Punição <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.tipo.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_punicao.id_for_label }}" class="form-label">
                                            Data da Punição <span class="text-danger">*</span>
                                        </label>
                                        {{ form.data_punicao }}
                                        {% if form.data_punicao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.data_punicao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                                            Número do Documento
                                        </label>
                                        {{ form.numero_documento }}
                                        {% if form.numero_documento.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.numero_documento.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.autoridade_puniu.id_for_label }}" class="form-label">
                                            Autoridade que Puniu <span class="text-danger">*</span>
                                        </label>
                                        {{ form.autoridade_puniu }}
                                        {% if form.autoridade_puniu.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.autoridade_puniu.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.periodo_punicao.id_for_label }}" class="form-label">
                                            Período da Punição
                                        </label>
                                        {{ form.periodo_punicao }}
                                        {% if form.periodo_punicao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.periodo_punicao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                            Descrição da Punição <span class="text-danger">*</span>
                                        </label>
                                        {{ form.descricao }}
                                        {% if form.descricao.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.descricao.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {% for error in form.non_field_errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{% url 'militares:punicao_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar Select2 para o campo de militar
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um militar já selecionado (na edição), carregar os dados
        {% if object and object.militar %}
        const militarId = {{ object.militar.id }};
        const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
        if (militarId) {
            const option = new Option(militarText, militarId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% elif militar %}
        const militarId = {{ militar.id }};
        const militarText = "{{ militar.get_posto_graduacao_display }} {{ militar.nome_completo }} - Mat: {{ militar.matricula }}";
        if (militarId) {
            const option = new Option(militarText, militarId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
    }
});
</script>
{% endblock %}

