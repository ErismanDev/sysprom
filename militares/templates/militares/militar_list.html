{% extends 'base.html' %}
{% load militar_permissions %}
{% load militares_extras %}
{% load permissoes_tags %}
{% load permissoes_granulares %}
{% load militar_filters %}

{% block title %}Bombeiros Militares{% endblock %}

{% block extra_css %}
<style>
    /* Busca Discreta */
    .search-discreet {
        position: relative;
        margin: 20px 0;
        transition: all 0.3s ease;
    }
    
    .search-input-discreet {
        width: 100%;
        max-width: 400px;
        padding: 12px 45px 12px 45px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        background: white;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .search-input-discreet:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
    }
    
    .search-icon-discreet {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 16px;
        z-index: 2;
        transition: color 0.3s ease;
    }
    
    .search-input-discreet:focus + .search-icon-discreet {
        color: #667eea;
    }
    
    .search-clear-discreet {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        font-size: 14px;
        display: none;
        transition: color 0.3s ease;
    }
    
    .search-clear-discreet:hover {
        color: #dc3545;
    }
    
    /* Autocomplete */
    .autocomplete-container {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-width: 400px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .lotacao-autocomplete-container {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-width: 400px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .estrutura-autocomplete-container {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-width: 400px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        margin-top: 2px;
    }
    
    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .autocomplete-item:hover {
        background-color: #f8f9fa;
    }
    
    .autocomplete-item.selected {
        background-color: #667eea;
        color: white;
    }
    
    /* Seletor de itens por p√°gina */
    .itens-por-pagina-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .itens-por-pagina-container label {
        margin: 0;
        font-weight: 500;
        color: #495057;
    }
    
    .itens-por-pagina-container select {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        font-size: 14px;
        min-width: 80px;
    }
    
    .itens-por-pagina-container select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    /* Pagina√ß√£o */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .pagination-info {
        font-size: 14px;
        color: #6c757d;
    }
    
    .pagination {
        margin: 0;
    }
    
    .pagination .page-link {
        color: #667eea;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        margin: 0 2px;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .pagination .page-link:hover {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        background-color: #fff;
        border-color: #dee2e6;
    }
    
    .autocomplete-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #6c757d;
        font-weight: 600;
    }
    
    .autocomplete-info {
        flex: 1;
    }
    
    .autocomplete-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
    }
    
    .autocomplete-details {
        font-size: 12px;
        color: #6c757d;
    }
    
    .autocomplete-posto {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        background: #e9ecef;
        color: #495057;
    }
    
    /* Filtros discretos */
    .filters-discreet {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }
    
    .filters-discreet:hover {
        opacity: 1;
    }
    
    .filter-select-discreet {
        padding: 6px 12px;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        font-size: 12px;
        background: white;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-select-discreet:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    /* Anima√ß√µes */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .highlight {
        background-color: #fff3cd !important;
        transition: background-color 0.3s ease;
    }
    
    /* Transi√ß√µes para cabe√ßalhos de grupos */
    .table-group-divider {
        transition: all 0.3s ease;
    }
    
    .table-group-divider.fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    /* Responsivo */
    @media (max-width: 768px) {
        .search-input-discreet {
            max-width: 100%;
            font-size: 16px; /* Evita zoom no iOS */
        }
        
        .autocomplete-container {
            max-width: 100%;
        }
        
        .filters-discreet {
            flex-direction: column;
        }
    }
    
    /* Estilo para destacar a se√ß√£o NVRR */
    .linha-nvrr {
        background-color: rgba(13, 202, 240, 0.05) !important;
    }
    
    .linha-nvrr:hover {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }
    
    .nvrr-header {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%) !important;
        color: white !important;
    }
    
    .nvrr-header h6 {
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="fas fa-users me-2"></i>
            Bombeiros Militares
        </h1>
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Total: {{ militares|length }} militares 
            {% if militares %}
                {% with nvrr_count=0 %}
                    {% for militar in militares %}
                        {% if militar.posto_graduacao == 'NVRR' or militar.quadro == 'NVRR' %}
                            {% with nvrr_count=nvrr_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {% if nvrr_count > 0 %}
                        ({{ nvrr_count }} NVRR n√£o computados no efetivo)
                    {% endif %}
                {% endwith %}
            {% endif %}
        </small>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            {% if user|pode_criar_militares %}
            <a href="{% url 'militares:militar_create' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i>Novo Militar
            </a>
            {% endif %}
            {% if menu_permissions.MILITARES_DASHBOARD %}
            <a href="{% url 'militares:militar_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
            {% endif %}
            {% if menu_permissions.MILITARES_EXPORTAR %}
            <a href="{% url 'militares:exportar_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-sm btn-success" title="Exportar lista de militares para Excel (CSV)">
                <i class="fas fa-file-excel me-1"></i>Exportar Excel
            </a>
            {% endif %}
            {% if user.is_superuser %}
            <form method="post" action="{% url 'militares:sincronizar_situacoes_militares' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-info" title="Sincronizar situa√ß√µes dos militares baseado em afastamentos, f√©rias e licen√ßas ativas">
                    <i class="fas fa-sync-alt me-1"></i>Sincronizar Situa√ß√µes
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

{% if menu_permissions.MILITARES_REORDENAR %}
<div class="mb-3 d-inline-block">
    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#reordenarModal">
        <i class="fas fa-sort-numeric-up-alt me-1"></i> Reordenar Antiguidade
    </button>
</div>
{% endif %}



<!-- Modal para Reordenar Antiguidade -->
<div class="modal fade" id="reordenarModal" tabindex="-1" aria-labelledby="reordenarModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reordenarModalLabel">
                    <i class="fas fa-sort-numeric-up-alt me-2"></i>Reordenar Antiguidade
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'militares:militares_reordenar' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Selecione o posto para corrigir repeti√ß√µes e gaps na numera√ß√£o de antiguidade.
                    </div>
                    <div class="mb-3">
                        <label for="posto_reordenar" class="form-label">Posto/Gradua√ß√£o:</label>
                        <select name="posto" id="posto_reordenar" class="form-select" required>
                            <option value="">Selecione um posto...</option>
                            <option value="CB">Coronel</option>
                            <option value="TC">Tenente Coronel</option>
                            <option value="MJ">Major</option>
                            <option value="CP">Capit√£o</option>
                            <option value="1T">1¬∫ Tenente</option>
                            <option value="2T">2¬∫ Tenente</option>
                            <option value="ST">Subtenente</option>
                            <option value="1S">1¬∫ Sargento</option>
                            <option value="2S">2¬∫ Sargento</option>
                            <option value="3S">3¬∫ Sargento</option>
                            <option value="CAB">Cabo</option>
                            <option value="SD">Soldado</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aten√ß√£o:</strong> Esta a√ß√£o ir√° corrigir apenas repeti√ß√µes e gaps na numera√ß√£o, mantendo a ordem atual dos demais militares. Apenas os militares com problemas de numera√ß√£o ser√£o alterados.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-sort-numeric-up-alt me-1"></i> Reordenar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Busca Discreta -->
<div class="search-discreet">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="position-relative">
                    <input type="text" 
                           id="pesquisaMilitares" 
                           class="search-input-discreet" 
                           placeholder="üîç Digite o nome, posto ou matr√≠cula..."
                           autocomplete="off">
                    <i class="fas fa-search search-icon-discreet"></i>
                    <button class="search-clear-discreet" id="searchClear" title="Limpar busca">
                            <i class="fas fa-times"></i>
                        </button>

                    
                    <!-- Autocomplete -->
                    <div class="autocomplete-container" id="autocompleteContainer">
                        <!-- Itens do autocomplete ser√£o inseridos aqui -->
                    </div>
                </div>
                
                <!-- Indicador de n√≠vel hier√°rquico -->
                {% if nivel_usuario %}
                <div class="alert alert-info mb-3" style="font-size: 0.9em;">
                    <i class="fas fa-shield-alt"></i>
                    <strong>N√≠vel Hier√°rquico:</strong> 
                    {% if nivel_usuario.acesso == 'TOTAL' %}
                        <span class="badge badge-success">Acesso Total - N√≠vel {{ nivel_usuario.nivel }}</span>
                    {% elif nivel_usuario.acesso == 'ORGAO' %}
                        <span class="badge badge-primary">Acesso √ìrg√£o - N√≠vel {{ nivel_usuario.nivel }}</span>
                    {% elif nivel_usuario.acesso == 'GRANDE_COMANDO' %}
                        <span class="badge badge-info">Acesso Grande Comando - N√≠vel {{ nivel_usuario.nivel }}</span>
                    {% elif nivel_usuario.acesso == 'UNIDADE' %}
                        <span class="badge badge-warning">Acesso Unidade - N√≠vel {{ nivel_usuario.nivel }}</span>
                    {% elif nivel_usuario.acesso == 'SUBUNIDADE' %}
                        <span class="badge badge-secondary">Acesso Sub-Unidade - N√≠vel {{ nivel_usuario.nivel }}</span>
                    {% else %}
                        <span class="badge badge-danger">Acesso Limitado</span>
                    {% endif %}
                    <br>
                    <small class="text-muted">
                        {% if nivel_usuario.nivel >= 3 %}
                            <i class="fas fa-check text-success"></i> Pode gerenciar militares
                        {% endif %}
                        {% if nivel_usuario.nivel >= 4 %}
                            <i class="fas fa-check text-success"></i> Pode editar militares
                        {% endif %}
                        {% if nivel_usuario.nivel >= 5 %}
                            <i class="fas fa-check text-success"></i> Pode excluir militares
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                
                <!-- Filtros Discretos -->
                <form id="filtrosForm" method="get" class="filters-discreet">
                    <div style="position: relative; display: inline-block; margin-right: 10px;">
                        <input type="text" 
                               id="pesquisaEstrutura" 
                               name="estrutura_search" 
                               class="filter-select-discreet" 
                               placeholder="Buscar estrutura organizacional..."
                               value="{{ nome_estrutura_pre_selecionada|default:'' }}"
                               autocomplete="off"
                               style="width: 250px; display: block; visibility: visible;">
                        <input type="hidden" id="filterEstrutura" name="estrutura" value="{{ estrutura_filtro|default:'' }}">
                        <div class="estrutura-autocomplete-container" id="estruturaAutocompleteContainer" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;">
                            <!-- Itens do autocomplete ser√£o inseridos aqui -->
                        </div>
                    </div>
                    <select name="posto" id="filterPosto" class="filter-select-discreet">
                        <option value="">Todos os Postos</option>
                        <option value="cb">Coronel</option>
                        <option value="tc">Tenente Coronel</option>
                        <option value="mj">Major</option>
                        <option value="cp">Capit√£o</option>
                        <option value="1t">1¬∫ Tenente</option>
                        <option value="2t">2¬∫ Tenente</option>
                        <option value="st">Subtenente</option>
                        <option value="1s">1¬∫ Sargento</option>
                        <option value="2s">2¬∫ Sargento</option>
                        <option value="3s">3¬∫ Sargento</option>
                        <option value="cab">Cabo</option>
                        <option value="sd">Soldado</option>
                        <option value="nvrr">NVRR</option>
                    </select>
                    <select name="situacao" id="filterSituacao" class="filter-select-discreet">
                        <option value="">Todas as Classifica√ß√µes</option>
                        <option value="at">Ativo</option>
                        <option value="in">Inativo</option>
                    </select>
                    <select name="quadro" id="filterQuadro" class="filter-select-discreet">
                        <option value="">Todos os Quadros</option>
                        <option value="COMB">Combatente</option>
                        <option value="ENG">Engenheiro</option>
                        <option value="COMP">Complementar</option>
                        <option value="PRACAS">Pra√ßas</option>
                    </select>
                    <button type="button" id="limparFiltros" class="btn btn-outline-secondary btn-sm" title="Limpar todos os filtros">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resultados -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-list me-2"></i>
            Lista de Militares 
            {% if query or posto_filtro or situacao_filtro or quadro_filtro %}
                <span class="text-primary">({{ total_militares }} filtrados de {{ total_geral|default:total_militares }} total)</span>
            {% else %}
                <span class="text-muted">({{ total_militares }} total)</span>
            {% endif %}
        </h6>
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            {% if page_obj.paginator.num_pages > 1 %}
                P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            {% else %}
                {% if query or posto_filtro or situacao_filtro or quadro_filtro %}
                    <span class="text-primary">Filtros aplicados</span>
                {% else %}
                    Todos os militares
                {% endif %}
            {% endif %}
        </small>
    </div>
    
    <!-- Resumo dos Filtros Aplicados -->
    {% if query or posto_filtro or situacao_filtro or quadro_filtro or lotacao_filtro %}
        <div class="card-body py-2 border-bottom bg-light">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <small class="text-muted me-2">
                    <i class="fas fa-filter me-1"></i>Filtros ativos:
                </small>
                {% if query %}
                    <span class="badge bg-primary">
                        <i class="fas fa-search me-1"></i>Busca: "{{ query }}"
                    </span>
                {% endif %}
                {% if posto_filtro %}
                    <span class="badge bg-info">
                        <i class="fas fa-star me-1"></i>Posto: {{ posto_filtro|upper }}
                    </span>
                {% endif %}
                {% if situacao_filtro %}
                    <span class="badge bg-warning">
                        <i class="fas fa-circle me-1"></i>Classifica√ß√£o: {{ situacao_filtro|upper }}
                    </span>
                {% endif %}
                {% if quadro_filtro %}
                    <span class="badge bg-success">
                        <i class="fas fa-layer-group me-1"></i>Quadro: {{ quadro_filtro }}
                    </span>
                {% endif %}
                {% if lotacao_filtro %}
                    {% for orgao, grandes_comandos in lotacoes_por_estrutura.items %}
                        {% for gc, unidades in grandes_comandos.items %}
                            {% for unidade, sub_unidades in unidades.items %}
                                {% for item in sub_unidades %}
                                    {% for lotacao in item.lotacoes %}
                                        {% if lotacao.id|stringformat:"s" == lotacao_filtro %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-building me-1"></i>Lota√ß√£o: {{ lotacao.lotacao }}
                                                <small class="ms-1">({{ item.sub_unidade.nome_completo }})</small>
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                    {% for lotacao in lotacoes_sem_estrutura %}
                        {% if lotacao.id|stringformat:"s" == lotacao_filtro %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-building me-1"></i>Lota√ß√£o: {{ lotacao.lotacao }}
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                <a href="{% url 'militares:militar_list' %}" class="btn btn-outline-secondary btn-sm ms-auto">
                    <i class="fas fa-times me-1"></i>Limpar Filtros
                </a>
            </div>
        </div>
    {% else %}
        <!-- Estat√≠sticas R√°pidas quando n√£o h√° filtros -->
        <div class="card-body py-2 border-bottom bg-light">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <small class="text-muted me-2">
                    <i class="fas fa-chart-pie me-1"></i>Distribui√ß√£o por Quadro:
                </small>
                <span class="badge bg-primary">
                    <i class="fas fa-shield-alt me-1"></i>COMB: {{ total_comb|default:0 }}
                </span>
                <span class="badge bg-info">
                    <i class="fas fa-hard-hat me-1"></i>ENG: {{ total_eng|default:0 }}
                </span>
                <span class="badge bg-warning">
                    <i class="fas fa-plus-circle me-1"></i>COMP: {{ total_comp|default:0 }}
                </span>
                <span class="badge bg-success">
                    <i class="fas fa-users me-1"></i>PRACAS: {{ total_pracas|default:0 }}
                </span>
            </div>
        </div>
    {% endif %}
    
                <!-- Seletor de itens por p√°gina -->
            <div class="itens-por-pagina-container">
                <label for="itensPorPagina">
                    <i class="fas fa-list-ol me-1"></i>
                    Itens por p√°gina:
                </label>
                <form method="get" id="itensForm">
                    {% if query %}
                        <input type="hidden" name="q" value="{{ query }}">
                    {% endif %}
                    {% if posto_filtro %}
                        <input type="hidden" name="posto" value="{{ posto_filtro }}">
                    {% endif %}
                    {% if situacao_filtro %}
                        <input type="hidden" name="situacao" value="{{ situacao_filtro }}">
                    {% endif %}
                    {% if quadro_filtro %}
                        <input type="hidden" name="quadro" value="{{ quadro_filtro }}">
                    {% endif %}
                    {% if lotacao_filtro %}
                        <input type="hidden" name="lotacao" value="{{ lotacao_filtro }}">
                    {% endif %}
                    <select id="itensPorPagina" name="itens_por_pagina" onchange="document.getElementById('itensForm').submit()">
                        <option value="20" {% if itens_por_pagina == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if itens_por_pagina == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if itens_por_pagina == 100 %}selected{% endif %}>100</option>
                    </select>
                </form>
            </div>
            

    <div class="card-body" id="militares-lista">
        {% if militares %}
            <!-- Contador de registros vis√≠veis -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted">
                    <i class="fas fa-eye me-1"></i>
                    Exibindo {{ militares|length }} de {{ total_militares }} registros
                    {% if total_geral != total_militares %}
                        <span class="text-primary">(filtrados de {{ total_geral }} total)</span>
                    {% endif %}
                </small>
                {% if total_militares > 0 %}
                    <small class="text-muted">
                        <i class="fas fa-percentage me-1"></i>
                        {% widthratio total_militares total_geral 100 %}% do total
                    </small>
                {% endif %}
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllMilitares" title="Selecionar todos os militares">
                                    <label class="form-check-label" for="selectAllMilitares">
                                        <i class="fas fa-check-square text-primary"></i>
                                    </label>
                                </div>
                            </th>
                            <th>Foto</th>
                            <th>Quadro</th>
                            <th>Nome</th>
                            <th>Posto/Gradua√ß√£o</th>
                            <th>Antiguidade</th>
                            <th>√öltima Promo√ß√£o</th>
                            <th>Situa√ß√£o</th>
                            <th>Lota√ß√£o Atual</th>
                            <th>Idade</th>
                            <th>Tempo de Servi√ßo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if nvrr_only %}
                            <!-- Se√ß√£o: NVRR (Apenas NVRR) -->
                            <tr class="table-group-divider">
                                <td colspan="11" class="nvrr-header">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="fas fa-users fa-lg me-1"></i>
                                        <span class="ms-2">NVRR</span>
                                        <small class="ms-2 opacity-75">(N√£o computado no efetivo)</small>
                                    </h6>
                                </td>
                            </tr>
                            
                            <!-- Lista de Militares do NVRR -->
                            {% for militar in militares %}
                                <tr class="linha-militar linha-nvrr" data-nome="{{ militar.nome_completo|lower }}" data-posto="{{ militar.get_posto_graduacao_display|lower }}" data-matricula="{{ militar.matricula|lower }}" data-situacao="{{ militar.get_situacao_display|lower }}">
                                    <td class="text-center align-middle">
                                        <div class="form-check">
                                            <input class="form-check-input militar-checkbox" type="checkbox" value="{{ militar.pk }}">
                                        </div>
                                    </td>
                                    <td class="text-center align-middle">
                                        {% if militar.foto %}
                                            <img src="{{ militar.foto.url }}" alt="Foto" class="rounded" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light border rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-user text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ militar.get_quadro_display }}</span>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ militar.nome_completo }}</strong>
                                            {% if militar.nome_guerra %}
                                                <br><small class="text-muted">{{ militar.nome_guerra }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ militar.get_posto_graduacao_display }}</span>
                                    </td>
                                    <td>
                                        <span class="text-muted fst-italic">NVRR</span>
                                    </td>
                                    <td>
                                        {% if militar.data_promocao_atual %}
                                            <small class="text-muted">{{ militar.data_promocao_atual|date:"d/m/Y" }}</small>
                                        {% else %}
                                            <span class="text-muted fst-italic">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            <span class="badge bg-{% if militar.situacao == 'PRONTO' %}success{% elif 'AFASTAMENTO' in militar.situacao %}warning{% elif 'AGUARDANDO' in militar.situacao %}info{% elif 'DESLIGAMENTO' in militar.situacao or 'LICENCIADO' in militar.situacao %}danger{% else %}secondary{% endif %}">{{ militar.get_situacao_display }}</span>
                                            <span class="badge bg-{% if militar.classificacao == 'ATIVO' %}success{% elif militar.classificacao == 'INATIVO' %}warning{% else %}secondary{% endif %}" style="font-size: 0.75rem;">{{ militar.get_classificacao_display }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if militar.lotacao_atual_obj %}
                                            <div class="d-flex flex-column">
                                                <strong class="text-primary" 
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top" 
                                                        title="{{ militar.lotacao_atual_obj.lotacao }}">
                                                    {{ militar.lotacao_atual_obj.lotacao|lotacao_resumida }}
                                                </strong>
                                                {% if militar.lotacao_atual_obj.nivel_organograma != "Sem vincula√ß√£o" %}
                                                    <small class="text-muted">{{ militar.lotacao_atual_obj.nivel_organograma }}</small>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted fst-italic">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ militar.idade }} anos</td>
                                    <td>{{ militar.tempo_servico }} anos</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'militares:militar_detail' militar.pk %}" 
                                               class="btn btn-outline-primary" title="Visualizar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if menu_permissions.MILITARES_TRANSFERIR %}
                                            <button type="button" 
                                                    class="btn btn-outline-info" 
                                                    title="Transferir Militar"
                                                    onclick="abrirModalTransferencia({{ militar.pk }}, '{{ militar.nome_guerra|default:""|escapejs }}', '{{ militar.lotacao_atual.lotacao|default:"Sem lota√ß√£o"|escapejs }}')">
                                                <i class="fas fa-exchange-alt"></i>
                                            </button>
                                            {% endif %}
                                            {% if menu_permissions.MILITARES_EDITAR %}
                                            <a href="{% url 'militares:militar_edit' militar.pk %}" 
                                               class="btn btn-outline-warning" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                            {% if menu_permissions.MILITARES_EXCLUIR %}
                                            <a href="{% url 'militares:militar_delete' militar.pk %}" 
                                               class="btn btn-outline-danger" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                            {% endif %}
                                            {% if menu_permissions.MILITARES_INATIVAR %}
                                            <a href="{% url 'militares:militar_transferir_inativo' militar.pk %}" 
                                               class="btn btn-outline-warning" title="Transferir para Inativo">
                                                <i class="fas fa-user-times"></i>
                                            </a>
                                            {% if menu_permissions.MILITARES_FICHA_CONCEITO %}
                                            {% if militar.fichaconceitooficiais %}
                                                <a href="{% url 'militares:ficha_conceito_edit' militar.fichaconceitooficiais.pk %}" 
                                                   class="btn btn-outline-info" title="Editar Ficha de Conceito">
                                                    <i class="fas fa-clipboard-list"></i>
                                                </a>
                                            {% else %}
                                                <a href="{% url 'militares:ficha_conceito_create' %}" 
                                                   class="btn btn-outline-success" title="Criar Ficha de Conceito">
                                                    <i class="fas fa-plus"></i>
                                                </a>
                                            {% endif %}
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Se√ß√£o: Militares Gerais (excluindo NVRR) -->
                        {% if not nvrr_only %}
                        {% regroup militares by posto_graduacao as militares_por_posto %}
                        {% for grupo in militares_por_posto %}
                            {% if grupo.grouper != 'NVRR' %}
                                <!-- Tarja do Posto -->
                                <tr class="table-group-divider">
                                    <td colspan="11" class="bg-primary bg-opacity-25">
                                        <h6 class="mb-0 text-dark fw-bold">
                                            {% if grupo.grouper == 'CB' %}
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <span class="ms-2">Coron√©is</span>
                                            {% elif grupo.grouper == 'TC' %}
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <span class="ms-2">Tenentes-Coron√©is</span>
                                            {% elif grupo.grouper == 'MJ' %}
                                                <i class="fas fa-star text-warning fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <span class="ms-2">Majores</span>
                                            {% elif grupo.grouper == 'CP' %}
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <span class="ms-2">Capit√£es</span>
                                            {% elif grupo.grouper == '1T' %}
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <span class="ms-2">1¬∫ Tenentes</span>
                                            {% elif grupo.grouper == '2T' %}
                                                <i class="fas fa-star text-light fa-lg me-1"></i>
                                                <span class="ms-2">2¬∫ Tenentes</span>
                                            {% elif grupo.grouper == 'AS' %}
                                                <span class="ms-2">Aspirantes a Oficial</span>
                                            {% elif grupo.grouper == 'AA' %}
                                                <span class="ms-2">Alunos de Adapta√ß√£o</span>
                                            {% elif grupo.grouper == 'ST' %}
                                                <span class="ms-2">Subtenentes</span>
                                            {% elif grupo.grouper == '1S' %}
                                                <span class="ms-2">1¬∫ Sargentos</span>
                                            {% elif grupo.grouper == '2S' %}
                                                <span class="ms-2">2¬∫ Sargentos</span>
                                            {% elif grupo.grouper == '3S' %}
                                                <span class="ms-2">3¬∫ Sargentos</span>
                                            {% elif grupo.grouper == 'CAB' %}
                                                <span class="ms-2">Cabos</span>
                                            {% elif grupo.grouper == 'SD' %}
                                                <span class="ms-2">Soldados</span>
                                            {% else %}
                                                <span class="ms-2">{{ grupo.list.0.get_posto_graduacao_display }}s</span>
                                            {% endif %}
                                        </h6>
                                    </td>
                                </tr>
                                
                                <!-- Lista de Militares do Posto -->
                                {% for militar in grupo.list %}
                                    {% if militar.quadro != 'NVRR' %}
                                    <tr class="linha-militar" data-nome="{{ militar.nome_completo|lower }}" data-posto="{{ militar.get_posto_graduacao_display|lower }}" data-matricula="{{ militar.matricula|lower }}" data-situacao="{{ militar.get_situacao_display|lower }}">
                                        <td class="text-center align-middle">
                                            <div class="form-check">
                                                <input class="form-check-input militar-checkbox" type="checkbox" value="{{ militar.pk }}">
                                            </div>
                                        </td>
                                        <td class="text-center align-middle">
                                            {% if militar.foto %}
                                                <img src="{{ militar.foto.url }}" alt="Foto" class="rounded" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light border rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                    <i class="fas fa-user text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ militar.get_quadro_display }}</span>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ militar.nome_completo }}</strong>
                                                {% if militar.nome_guerra %}
                                                    <br><small class="text-muted">{{ militar.nome_guerra }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if militar.posto_graduacao == 'CB' %}
                                                <span class="badge bg-danger">{{ militar.get_posto_graduacao_display }}</span>
                                            {% elif militar.posto_graduacao == 'TC' %}
                                                <span class="badge bg-warning text-dark">{{ militar.get_posto_graduacao_display }}</span>
                                            {% elif militar.posto_graduacao == 'MJ' %}
                                                <span class="badge bg-info">{{ militar.get_posto_graduacao_display }}</span>
                                            {% elif militar.posto_graduacao == 'CP' %}
                                                <span class="badge bg-success">{{ militar.get_posto_graduacao_display }}</span>
                                            {% elif militar.posto_graduacao == '1T' %}
                                                <span class="badge bg-primary">{{ militar.get_posto_graduacao_display }}</span>
                                            {% elif militar.posto_graduacao == '2T' %}
                                                <span class="badge bg-secondary">{{ militar.get_posto_graduacao_display }}</span>
                                            {% else %}
                                                <span class="badge bg-dark">{{ militar.get_posto_graduacao_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if militar.numeracao_antiguidade %}
                                                <span class="badge bg-warning text-dark fw-bold">{{ militar.numeracao_antiguidade }}¬∫</span>
                                            {% else %}
                                                <span class="text-muted fst-italic">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if militar.data_promocao_atual %}
                                                <small class="text-muted">{{ militar.data_promocao_atual|date:"d/m/Y" }}</small>
                                            {% else %}
                                                <span class="text-muted fst-italic">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-1">
                                                <span class="badge bg-{% if militar.situacao == 'PRONTO' %}success{% elif 'AFASTAMENTO' in militar.situacao %}warning{% elif 'AGUARDANDO' in militar.situacao %}info{% elif 'DESLIGAMENTO' in militar.situacao or 'LICENCIADO' in militar.situacao %}danger{% else %}secondary{% endif %}">{{ militar.get_situacao_display }}</span>
                                                <span class="badge bg-{% if militar.classificacao == 'ATIVO' %}success{% elif militar.classificacao == 'INATIVO' %}warning{% else %}secondary{% endif %}" style="font-size: 0.75rem;">{{ militar.get_classificacao_display }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if militar.lotacao_atual_obj %}
                                                <div class="d-flex flex-column">
                                                    <strong class="text-primary" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="{{ militar.lotacao_atual_obj.lotacao }}">
                                                        {{ militar.lotacao_atual_obj.lotacao|lotacao_resumida }}
                                                    </strong>
                                                    {% if militar.lotacao_atual_obj.nivel_organograma != "Sem vincula√ß√£o" %}
                                                        <small class="text-muted">{{ militar.lotacao_atual_obj.nivel_organograma }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted fst-italic">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ militar.idade }} anos</td>
                                        <td>{{ militar.tempo_servico }} anos</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{% url 'militares:militar_detail' militar.pk %}" 
                                                   class="btn btn-outline-primary" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if menu_permissions.MILITARES_TRANSFERIR %}
                                                <button type="button" 
                                                        class="btn btn-outline-info" 
                                                        title="Transferir Militar"
                                                        onclick="abrirModalTransferencia({{ militar.pk }}, '{{ militar.nome_guerra|default:""|escapejs }}', '{{ militar.lotacao_atual.lotacao|default:"Sem lota√ß√£o"|escapejs }}')">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </button>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_EDITAR %}
                                                <a href="{% url 'militares:militar_edit' militar.pk %}" 
                                                   class="btn btn-outline-warning" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_EXCLUIR %}
                                                <a href="{% url 'militares:militar_delete' militar.pk %}" 
                                                   class="btn btn-outline-danger" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_PROMOVER %}
                                                <a href="{% url 'militares:promocao_create' %}?militar={{ militar.pk }}" 
                                                   class="btn btn-outline-success" title="Promover Militar">
                                                    <i class="fas fa-arrow-up"></i>
                                                </a>
                                                {% endif %}
                                                {% if menu_permissions.MILITARES_INATIVAR %}
                                                <a href="{% url 'militares:militar_transferir_inativo' militar.pk %}" 
                                                   class="btn btn-outline-warning" title="Transferir para Inativo">
                                                    <i class="fas fa-user-times"></i>
                                                </a>
                                                {% if menu_permissions.MILITARES_FICHA_CONCEITO %}
                                                {% if militar.fichaconceitooficiais %}
                                                    <a href="{% url 'militares:ficha_conceito_edit' militar.fichaconceitooficiais.pk %}" 
                                                       class="btn btn-outline-info" title="Editar Ficha de Conceito">
                                                        <i class="fas fa-clipboard-list"></i>
                                                    </a>
                                                {% else %}
                                                    <a href="{% url 'militares:ficha_conceito_create' %}" 
                                                       class="btn btn-outline-success" title="Criar Ficha de Conceito">
                                                        <i class="fas fa-plus"></i>
                                                    </a>
                                                {% endif %}
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        {% endif %}
                        
                        <!-- Linha para mensagem de nenhum resultado -->
                        <tr id="noResultsRow" style="display:none;">
                                                            <td colspan="11" class="text-center text-muted py-5">
                                <i class="fas fa-users fa-2x mb-2"></i><br>
                                <span>Nenhum militar encontrado</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagina√ß√£o -->
            {% if page_obj.paginator.num_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ total_militares }} militares
                </div>
                
                <nav aria-label="Navega√ß√£o de p√°ginas">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1&itens_por_pagina={{ itens_por_pagina }}{% if query %}&q={{ query }}{% endif %}{% if posto_filtro %}&posto={{ posto_filtro }}{% endif %}{% if situacao_filtro %}&situacao={{ situacao_filtro }}{% endif %}{% if quadro_filtro %}&quadro={{ quadro_filtro }}{% endif %}{% if estrutura_filtro %}&estrutura={{ estrutura_filtro }}{% endif %}" title="Primeira p√°gina">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&itens_por_pagina={{ itens_por_pagina }}{% if query %}&q={{ query }}{% endif %}{% if posto_filtro %}&posto={{ posto_filtro }}{% endif %}{% if situacao_filtro %}&situacao={{ situacao_filtro }}{% endif %}{% if quadro_filtro %}&quadro={{ quadro_filtro }}{% endif %}{% if estrutura_filtro %}&estrutura={{ estrutura_filtro }}{% endif %}" title="P√°gina anterior">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}&itens_por_pagina={{ itens_por_pagina }}{% if query %}&q={{ query }}{% endif %}{% if posto_filtro %}&posto={{ posto_filtro }}{% endif %}{% if situacao_filtro %}&situacao={{ situacao_filtro }}{% endif %}{% if quadro_filtro %}&quadro={{ quadro_filtro }}{% endif %}{% if estrutura_filtro %}&estrutura={{ estrutura_filtro }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&itens_por_pagina={{ itens_por_pagina }}{% if query %}&q={{ query }}{% endif %}{% if posto_filtro %}&posto={{ posto_filtro }}{% endif %}{% if situacao_filtro %}&situacao={{ situacao_filtro }}{% endif %}{% if quadro_filtro %}&quadro={{ quadro_filtro }}{% endif %}{% if estrutura_filtro %}&estrutura={{ estrutura_filtro }}{% endif %}" title="Pr√≥xima p√°gina">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&itens_por_pagina={{ itens_por_pagina }}{% if query %}&q={{ query }}{% endif %}{% if posto_filtro %}&posto={{ posto_filtro }}{% endif %}{% if situacao_filtro %}&situacao={{ situacao_filtro }}{% endif %}{% if quadro_filtro %}&quadro={{ quadro_filtro }}{% endif %}{% if estrutura_filtro %}&estrutura={{ estrutura_filtro }}{% endif %}" title="√öltima p√°gina">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhum militar encontrado</h5>
                <p class="text-muted">
                    Comece cadastrando o primeiro militar.
                </p>
                <a href="{% url 'militares:militar_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Cadastrar Militar
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pesquisaInput = document.getElementById('pesquisaMilitares');
    const searchClear = document.getElementById('searchClear');
    const autocompleteContainer = document.getElementById('autocompleteContainer');
    const filterPosto = document.getElementById('filterPosto');
    const filterSituacao = document.getElementById('filterSituacao');
    const filterQuadro = document.getElementById('filterQuadro');
    const filterEstrutura = document.getElementById('filterEstrutura');
    const pesquisaEstrutura = document.getElementById('pesquisaEstrutura');
    const estruturaAutocompleteContainer = document.getElementById('estruturaAutocompleteContainer');
    const linhas = document.querySelectorAll('.linha-militar');
    
    // Sincronizar filtros com par√¢metros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlPosto = urlParams.get('posto');
    const urlSituacao = urlParams.get('situacao');
    const urlQuadro = urlParams.get('quadro');
    const urlEstrutura = urlParams.get('estrutura');
    
    if (urlPosto && filterPosto) {
        filterPosto.value = urlPosto;
    }
    if (urlSituacao && filterSituacao) {
        filterSituacao.value = urlSituacao;
    }
    if (urlQuadro && filterQuadro) {
        filterQuadro.value = urlQuadro;
    }
    if (urlEstrutura && filterEstrutura) {
        filterEstrutura.value = urlEstrutura;
        // Buscar e exibir o nome da estrutura selecionada
        fetch(`/militares/lotacao-autocomplete/?q=${encodeURIComponent(urlEstrutura)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const estrutura = data.results[0];
                    pesquisaEstrutura.value = estrutura.nome_hierarquico;
                }
            })
            .catch(error => console.error('Erro ao buscar estrutura:', error));
    } else if (pesquisaEstrutura.value && filterEstrutura.value) {
        // Se h√° estrutura pr√©-selecionada, aplicar filtro automaticamente
        // Aplicar filtros via GET request
        const params = new URLSearchParams();
        if (pesquisaInput.value.trim()) {
            params.append('q', pesquisaInput.value.trim());
        }
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    }
    
    let searchTimeout;
    let selectedIndex = -1;
    let estruturaSearchTimeout;
    let estruturaSelectedIndex = -1;
    
    // Fun√ß√£o para mostrar o autocomplete
    function showAutocomplete(results) {
        autocompleteContainer.innerHTML = '';
        
        if (!pesquisaInput.value.trim()) {
            autocompleteContainer.style.display = 'none';
            return;
        }
        
        if (results.length === 0) {
            autocompleteContainer.style.display = 'block';
            const noResultsItem = document.createElement('div');
            noResultsItem.classList.add('autocomplete-item');
            noResultsItem.style.textAlign = 'center';
            noResultsItem.style.color = '#6c757d';
            noResultsItem.style.fontStyle = 'italic';
            noResultsItem.innerHTML = '<i class="fas fa-search me-2"></i>Nenhum militar encontrado';
            autocompleteContainer.appendChild(noResultsItem);
            return;
        }
        
        // Limitar a 8 resultados para melhor UX
        const limitedResults = results.slice(0, 8);
        
        autocompleteContainer.style.display = 'block';
        
        limitedResults.forEach((result, index) => {
            const autocompleteItem = document.createElement('div');
            autocompleteItem.classList.add('autocomplete-item');
            autocompleteItem.setAttribute('data-index', index);
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.classList.add('autocomplete-avatar');
            avatar.textContent = result.nome.charAt(0).toUpperCase();
            autocompleteItem.appendChild(avatar);
            
            // Informa√ß√µes
            const info = document.createElement('div');
            info.classList.add('autocomplete-info');
            
            const name = document.createElement('div');
            name.classList.add('autocomplete-name');
            name.textContent = result.nome;
            info.appendChild(name);
            
            const details = document.createElement('div');
            details.classList.add('autocomplete-details');
            details.textContent = `${result.posto} ‚Ä¢ ${result.matricula}`;
            info.appendChild(details);
            
            autocompleteItem.appendChild(info);
            autocompleteContainer.appendChild(autocompleteItem);
            
            // Adicionar evento de clique
            autocompleteItem.addEventListener('click', function() {
                // Primeiro, tentar encontrar e destacar o militar na lista atual
                const linhas = document.querySelectorAll('.linha-militar');
                let militarEncontrado = null;
                
                // Buscar o militar na lista atual
                for (let linha of linhas) {
                    const nomeElement = linha.querySelector('td:nth-child(4) strong'); // Coluna do nome
                    if (nomeElement && nomeElement.textContent.trim() === result.nome) {
                        militarEncontrado = linha;
                        break;
                    }
                }
                
                if (militarEncontrado) {
                    // Se encontrou o militar na lista atual, destacar e rolar at√© ele
                    selectMilitar(militarEncontrado);
                    hideAutocomplete();
                    return;
                }
                
                // Se n√£o encontrou, aplicar busca via GET request
                const params = new URLSearchParams();
                params.append('q', result.nome);
                if (filterPosto.value) {
                    params.append('posto', filterPosto.value);
                }
                if (filterSituacao.value) {
                    params.append('situacao', filterSituacao.value);
                }
                if (filterQuadro.value) {
                    params.append('quadro', filterQuadro.value);
                }
                if (filterEstrutura.value) {
                    params.append('estrutura', filterEstrutura.value);
                }
                
                const url = window.location.pathname + '?' + params.toString();
                window.location.href = url;
            });
        });
    }
    
    // Fun√ß√£o para buscar militares via AJAX
    async function buscarMilitaresAJAX(termo) {
        try {
            const url = `{% url 'militares:militar_search_ajax' %}?q=${encodeURIComponent(termo)}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.results || [];
        } catch (error) {
            console.error('Erro ao buscar militares:', error);
            return [];
        }
    }
    
    // Fun√ß√£o para selecionar um militar
    function selectMilitar(linha) {
        const nomeElement = linha.querySelector('td:nth-child(4) strong'); // Coluna do nome
        const nome = nomeElement ? nomeElement.textContent.trim() : '';
        
        pesquisaInput.value = nome;
        hideAutocomplete();
        
        // Destacar a linha selecionada
        const todasLinhas = document.querySelectorAll('.linha-militar');
        todasLinhas.forEach(l => l.classList.remove('highlight'));
        linha.classList.add('highlight');
        
        // Scroll para a linha
        linha.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Remover destaque ap√≥s 3 segundos
        setTimeout(() => {
            linha.classList.remove('highlight');
        }, 3000);
    }
    
    // Fun√ß√£o para esconder o autocomplete
    function hideAutocomplete() {
        autocompleteContainer.style.display = 'none';
        selectedIndex = -1;
    }
    
    // Fun√ß√£o para mostrar o autocomplete de estrutura
    function showEstruturaAutocomplete(results) {
        estruturaAutocompleteContainer.innerHTML = '';
        
        if (results.length === 0) {
            estruturaAutocompleteContainer.style.display = 'none';
            return;
        }
        
        results.forEach((result, index) => {
            const autocompleteItem = document.createElement('div');
            autocompleteItem.className = 'autocomplete-item';
            autocompleteItem.style.padding = '12px 15px';
            autocompleteItem.style.cursor = 'pointer';
            autocompleteItem.style.borderBottom = '1px solid #f8f9fa';
            
            const info = document.createElement('div');
            info.style.display = 'flex';
            info.style.flexDirection = 'column';
            
            const nome = document.createElement('div');
            nome.style.fontWeight = '600';
            nome.style.color = '#495057';
            nome.textContent = result.nome;
            
            const hierarquia = document.createElement('div');
            hierarquia.style.fontSize = '12px';
            hierarquia.style.color = '#6c757d';
            hierarquia.style.marginTop = '2px';
            hierarquia.textContent = result.nome_hierarquico;
            
            info.appendChild(nome);
            info.appendChild(hierarquia);
            autocompleteItem.appendChild(info);
            estruturaAutocompleteContainer.appendChild(autocompleteItem);
            
            // Adicionar evento de clique
            autocompleteItem.addEventListener('click', function() {
                // Aplicar filtro de estrutura via GET request
                const params = new URLSearchParams();
                if (pesquisaInput.value.trim()) {
                    params.append('q', pesquisaInput.value.trim());
                }
                if (filterPosto.value) {
                    params.append('posto', filterPosto.value);
                }
                if (filterSituacao.value) {
                    params.append('situacao', filterSituacao.value);
                }
                if (filterQuadro.value) {
                    params.append('quadro', filterQuadro.value);
                }
                params.append('estrutura', result.id);
                
                const url = window.location.pathname + '?' + params.toString();
                window.location.href = url;
            });
        });
        
        estruturaAutocompleteContainer.style.display = 'block';
        estruturaSelectedIndex = -1;
    }
    
    // Fun√ß√£o para esconder o autocomplete de estrutura
    function hideEstruturaAutocomplete() {
        estruturaAutocompleteContainer.style.display = 'none';
        estruturaSelectedIndex = -1;
    }
    

    
    // Atualizar contador de resultados
    function updateResultCount(count) {
        const header = document.querySelector('.card-header h6');
        if (header) {
            const termo = pesquisaInput.value.trim();
            if (termo) {
            header.innerHTML = `<i class="fas fa-list me-2"></i>Militares Encontrados (${count})`;
            } else {
                header.innerHTML = `<i class="fas fa-list me-2"></i>Lista Completa de Militares (${count})`;
            }
        }
    }
    
    // Mostrar/ocultar bot√£o limpar baseado na URL
    function updateClearButton() {
        const urlParams = new URLSearchParams(window.location.search);
        const hasQuery = urlParams.get('q');
        searchClear.style.display = hasQuery ? 'block' : 'none';
    }
    
    // Inicializar bot√£o limpar
    updateClearButton();
    
    // Destacar militar se houver busca na URL
    const query = urlParams.get('q');
    if (query && query.trim()) {
        // Destacar o primeiro militar que corresponde √† busca
        const linhas = document.querySelectorAll('.linha-militar');
        for (let linha of linhas) {
            const nomeElement = linha.querySelector('td:nth-child(4) strong');
            if (nomeElement && nomeElement.textContent.toLowerCase().includes(query.toLowerCase())) {
                selectMilitar(linha);
                break;
            }
        }
    }
    
    // Event listeners
    pesquisaInput.addEventListener('input', function() {
        const termo = this.value.trim();
        
        // Limpar timeout anterior
        clearTimeout(searchTimeout);
        
        // Mostrar dica se o usu√°rio digitou apenas 1 caractere
        if (termo.length === 1) {
            const hintItem = document.createElement('div');
            hintItem.classList.add('autocomplete-item');
            hintItem.style.textAlign = 'center';
            hintItem.style.color = '#6c757d';
            hintItem.style.fontSize = '12px';
            hintItem.innerHTML = '<i class="fas fa-info-circle me-2"></i>Continue digitando para buscar...';
            autocompleteContainer.innerHTML = '';
            autocompleteContainer.appendChild(hintItem);
            autocompleteContainer.style.display = 'block';
        } else if (termo.length === 0) {
            hideAutocomplete();
        } else if (termo.length >= 2) {
            // Buscar via AJAX ap√≥s 300ms de delay
            searchTimeout = setTimeout(async function() {
                const results = await buscarMilitaresAJAX(termo);
                showAutocomplete(results);
            }, 300);
        }
    });
    
    // Event listener para o campo de pesquisa de estrutura
    pesquisaEstrutura.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Limpar timeout anterior
        clearTimeout(estruturaSearchTimeout);
        
        if (query.length < 2) {
            hideEstruturaAutocomplete();
            return;
        }
        
        // Mostrar loading
        showEstruturaAutocomplete([{ nome: 'Buscando...', nome_hierarquico: '' }]);
        
        // Debounce da busca
        estruturaSearchTimeout = setTimeout(() => {
            fetch(`/militares/lotacao-autocomplete/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        showEstruturaAutocomplete(data.results);
                    } else {
                        showEstruturaAutocomplete([{ nome: 'Nenhuma estrutura encontrada', nome_hierarquico: '' }]);
                    }
                })
                .catch(error => {
                    console.error('Erro na busca de estrutura:', error);
                    hideEstruturaAutocomplete();
                });
        }, 300);
    });
    
    // Navega√ß√£o com teclado no autocomplete
    pesquisaInput.addEventListener('keydown', function(e) {
        const autocompleteItems = autocompleteContainer.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, autocompleteItems.length - 1);
            updateSelectedItem(autocompleteItems);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelectedItem(autocompleteItems);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            if (autocompleteItems[selectedIndex]) {
                autocompleteItems[selectedIndex].click();
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            // Aplicar busca via GET request
            const params = new URLSearchParams();
            if (pesquisaInput.value.trim()) {
                params.append('q', pesquisaInput.value.trim());
            }
            if (filterPosto.value) {
                params.append('posto', filterPosto.value);
            }
            if (filterSituacao.value) {
                params.append('situacao', filterSituacao.value);
            }
            if (filterQuadro.value) {
                params.append('quadro', filterQuadro.value);
            }
            if (filterEstrutura.value) {
                params.append('estrutura', filterEstrutura.value);
            }
            
            const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.location.href = url;
        } else if (e.key === 'Escape') {
            // Limpar URL e recarregar p√°gina
            window.location.href = window.location.pathname;
        }
    });
    
    function updateSelectedItem(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    // Quando o usu√°rio clica fora, esconde o autocomplete
    document.addEventListener('click', function(event) {
        if (!pesquisaInput.contains(event.target) && !autocompleteContainer.contains(event.target)) {
            hideAutocomplete();
        }
        if (!pesquisaEstrutura.contains(event.target) && !estruturaAutocompleteContainer.contains(event.target)) {
            hideEstruturaAutocomplete();
        }
    });
    
    // Bot√£o limpar
    searchClear.addEventListener('click', function() {
        // Aplicar filtros via GET request (sem a busca)
        const params = new URLSearchParams();
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    });
    
    filterPosto.addEventListener('change', () => {
        // Aplicar filtros via GET request
        const params = new URLSearchParams();
        if (pesquisaInput.value.trim()) {
            params.append('q', pesquisaInput.value.trim());
        }
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    });
    
    filterSituacao.addEventListener('change', () => {
        // Aplicar filtros via GET request
        const params = new URLSearchParams();
        if (pesquisaInput.value.trim()) {
            params.append('q', pesquisaInput.value.trim());
        }
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    });

    filterQuadro.addEventListener('change', () => {
        // Aplicar filtros via GET request
        const params = new URLSearchParams();
        if (pesquisaInput.value.trim()) {
            params.append('q', pesquisaInput.value.trim());
        }
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    });

    // Remover refer√™ncia a filterLotacao que n√£o existe
    /*
    filterLotacao.addEventListener('change', () => {
        // Aplicar filtros via GET request
        const params = new URLSearchParams();
        if (pesquisaInput.value.trim()) {
            params.append('q', pesquisaInput.value.trim());
        }
        if (filterPosto.value) {
            params.append('posto', filterPosto.value);
        }
        if (filterSituacao.value) {
            params.append('situacao', filterSituacao.value);
        }
        if (filterQuadro.value) {
            params.append('quadro', filterQuadro.value);
        }
        if (filterEstrutura.value) {
            params.append('estrutura', filterEstrutura.value);
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    });
    */
    
    // Bot√£o limpar filtros
    const limparFiltros = document.getElementById('limparFiltros');
    if (limparFiltros) {
        limparFiltros.addEventListener('click', function() {
            // Limpar URL e recarregar p√°gina
            window.location.href = window.location.pathname;
        });
    }
    

    
    // Anima√ß√µes de entrada
    linhas.forEach((linha, index) => {
        linha.style.animationDelay = `${index * 0.05}s`;
        linha.classList.add('fade-in');
    });
});

// Fun√ß√£o para abrir modal de transfer√™ncia
function abrirModalTransferencia(militarId, nomeMilitar, lotacaoAtual) {
    document.getElementById('militarId').value = militarId;
    document.getElementById('nomeMilitar').textContent = nomeMilitar;
    document.getElementById('lotacaoAtual').textContent = lotacaoAtual;
    
    // Carregar estruturas organizacionais
    carregarEstruturasOrganizacionais();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalTransferencia'));
    modal.show();
    
    // Focar no campo de busca ap√≥s o modal ser exibido
    modal._element.addEventListener('shown.bs.modal', function() {
        const campoBusca = document.getElementById('buscaLotacao');
        campoBusca.focus();
        // Garantir que o campo seja acess√≠vel
        campoBusca.setAttribute('aria-expanded', 'false');
    });
    
    // Limpar foco quando o modal for fechado
    modal._element.addEventListener('hidden.bs.modal', function() {
        // Remover foco de qualquer elemento dentro do modal
        const elementosFocaveis = modal._element.querySelectorAll('button, input, textarea, select');
        elementosFocaveis.forEach(elemento => {
            elemento.blur();
        });
    });
}

// Vari√°vel global para armazenar todas as estruturas
let todasEstruturas = [];

// Fun√ß√£o para carregar estruturas organizacionais
function carregarEstruturasOrganizacionais() {
    fetch('/militares/ajax/estruturas-organizacionais/')
        .then(response => response.json())
        .then(data => {
            todasEstruturas = data.estruturas;
            
            // Configurar busca em tempo real
            configurarBuscaEmTempoReal();
        })
        .catch(error => {
            console.error('Erro ao carregar estruturas:', error);
            alert('Erro ao carregar estruturas organizacionais');
        });
}

// Fun√ß√£o para configurar busca em tempo real
function configurarBuscaEmTempoReal() {
    const campoBusca = document.getElementById('buscaLotacao');
    const resultados = document.getElementById('resultadosBusca');
    
    // Mostrar toda a estrutura quando o campo recebe foco
    campoBusca.addEventListener('focus', function() {
        mostrarEstruturaCompleta();
    });
    
    campoBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase().trim();
        
        // Sincronizar com o campo hidden (removendo emojis se houver)
        let valorLimpo = this.value.trim();
        // Remover emojis do valor se existirem
        valorLimpo = valorLimpo.replace(/^[üèóÔ∏è]\s*/, '');
        document.getElementById('novaLotacao').value = valorLimpo;
        
        if (termo.length === 0) {
            // Mostrar toda a estrutura quando n√£o h√° busca
            mostrarEstruturaCompleta();
            return;
        }
        
        // Mostrar resultados da busca
        resultados.style.display = 'block';
        
        // Filtrar estruturas que cont√™m o termo
        const estruturasFiltradas = todasEstruturas.filter(estrutura => {
            const nomeCompleto = (estrutura.nome_completo || estrutura.nome).toLowerCase();
            const nomeSimples = estrutura.nome.toLowerCase();
            return nomeCompleto.includes(termo) || nomeSimples.includes(termo);
        });
        
        // Limpar resultados anteriores
        resultados.innerHTML = '';
        
        if (estruturasFiltradas.length === 0) {
            resultados.innerHTML = `
                <div class="list-group-item text-muted text-center">
                    <i class="fas fa-search me-2"></i>
                    Nenhuma estrutura encontrada para "${termo}"
                </div>
            `;
            return;
        }
        
        // Agrupar resultados por n√≠vel
        const grupos = {
            1: [], // √ìrg√£os
            2: [], // Grandes Comandos
            3: [], // Unidades
            4: []  // Sub-unidades
        };
        
        estruturasFiltradas.forEach(estrutura => {
            grupos[estrutura.nivel].push(estrutura);
        });
        
        // Adicionar resultados agrupados
        Object.keys(grupos).forEach(nivel => {
            const estruturasNivel = grupos[nivel];
            if (estruturasNivel.length > 0) {
                // Adicionar cabe√ßalho do grupo
                const header = document.createElement('div');
                header.className = 'list-group-item bg-light fw-bold text-primary';
                let label = '';
                switch(parseInt(nivel)) {
                    case 1: label = 'üèõÔ∏è √ìRG√ÉOS'; break;
                    case 2: label = 'üè¢ GRANDES COMANDOS'; break;
                    case 3: label = 'üè¨ UNIDADES'; break;
                    case 4: label = 'üèóÔ∏è SUB-UNIDADES'; break;
                }
                header.textContent = label;
                resultados.appendChild(header);
                
                // Adicionar itens do grupo
                estruturasNivel.forEach(estrutura => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    
                    const nomeExibicao = estrutura.nome_completo || estrutura.nome;
                    const nomeLimpo = estrutura.nome; // Usar apenas o nome simples para sele√ß√£o
                    
                    // Adicionar indenta√ß√£o visual baseada no n√≠vel
                    let textoExibicao = nomeExibicao;
                    if (estrutura.nivel > 1) {
                        const indentacao = '  '.repeat(estrutura.nivel - 1);
                        textoExibicao = indentacao + '‚îî‚îÄ ' + nomeExibicao;
                    }
                    
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${textoExibicao}</h6>
                            <small class="text-muted">N√≠vel ${estrutura.nivel}</small>
                        </div>
                        <small class="text-muted">${nomeLimpo}</small>
                    `;
                    
                    item.addEventListener('click', function() {
                        // Preencher o campo de busca com o nome limpo (sem emojis)
                        campoBusca.value = nomeLimpo;
                        // Sincronizar com o campo hidden (sem emojis)
                        document.getElementById('novaLotacao').value = nomeLimpo;
                        // Esconder resultados
                        resultados.style.display = 'none';
                        // Focar no campo de busca
                        campoBusca.focus();
                    });
                    
                    resultados.appendChild(item);
                });
            }
        });
    });
    
    // Limpar busca quando o campo perde o foco
    campoBusca.addEventListener('blur', function() {
        setTimeout(() => {
            if (this.value.trim() === '') {
                resultados.style.display = 'none';
                document.getElementById('novaLotacao').value = '';
            }
        }, 200);
    });
}

// Fun√ß√£o para mostrar toda a estrutura organizacional
function mostrarEstruturaCompleta() {
    const resultados = document.getElementById('resultadosBusca');
    resultados.style.display = 'block';
    resultados.innerHTML = '';
    
    // Agrupar estruturas por n√≠vel
    const grupos = {
        1: [], // √ìrg√£os
        2: [], // Grandes Comandos
        3: [], // Unidades
        4: []  // Sub-unidades
    };
    
    todasEstruturas.forEach(estrutura => {
        grupos[estrutura.nivel].push(estrutura);
    });
    
    // Adicionar estrutura completa agrupada
    Object.keys(grupos).forEach(nivel => {
        const estruturasNivel = grupos[nivel];
        if (estruturasNivel.length > 0) {
            // Adicionar cabe√ßalho do grupo
            const header = document.createElement('div');
            header.className = 'list-group-item bg-light fw-bold text-primary';
            let label = '';
            switch(parseInt(nivel)) {
                case 1: label = 'üèõÔ∏è √ìRG√ÉOS'; break;
                case 2: label = 'üè¢ GRANDES COMANDOS'; break;
                case 3: label = 'üè¨ UNIDADES'; break;
                case 4: label = 'üèóÔ∏è SUB-UNIDADES'; break;
            }
            header.textContent = label;
            resultados.appendChild(header);
            
            // Adicionar itens do grupo
            estruturasNivel.forEach(estrutura => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                
                const nomeExibicao = estrutura.nome_completo || estrutura.nome;
                const nomeLimpo = estrutura.nome; // Usar apenas o nome simples para sele√ß√£o
                
                // Adicionar indenta√ß√£o visual baseada no n√≠vel
                let textoExibicao = nomeExibicao;
                if (estrutura.nivel > 1) {
                    const indentacao = '  '.repeat(estrutura.nivel - 1);
                    textoExibicao = indentacao + '‚îî‚îÄ ' + nomeExibicao;
                }
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${textoExibicao}</h6>
                        <small class="text-muted">N√≠vel ${estrutura.nivel}</small>
                    </div>
                    <small class="text-muted">${nomeLimpo}</small>
                `;
                
                item.addEventListener('click', function() {
                    // Preencher o campo de busca com o nome limpo (sem emojis)
                    const campoBusca = document.getElementById('buscaLotacao');
                    campoBusca.value = nomeLimpo;
                    // Sincronizar com o campo hidden (sem emojis)
                    document.getElementById('novaLotacao').value = nomeLimpo;
                    // Esconder resultados
                    resultados.style.display = 'none';
                    // Focar no campo de busca
                    campoBusca.focus();
                });
                
                resultados.appendChild(item);
            });
        }
    });
}

// Fun√ß√£o para transferir militar
function transferirMilitar() {
    const militarId = document.getElementById('militarId').value;
    console.log('DEBUG: militarId =', militarId);
    const campoBusca = document.getElementById('buscaLotacao');
    let novaLotacao = campoBusca.value.trim();
    // Remover emojis do valor antes de enviar
    novaLotacao = novaLotacao.replace(/^[üèóÔ∏è]\s*/, '');
    const observacoes = document.getElementById('observacoes').value;
    
    if (!novaLotacao) {
        alert('Por favor, digite ou selecione a nova lota√ß√£o');
        campoBusca.focus();
        return;
    }
    
    if (!confirm(`Confirma a transfer√™ncia do militar para "${novaLotacao}"?`)) {
        return;
    }
    
    // Desabilitar bot√£o
    const btnTransferir = document.getElementById('btnTransferir');
    btnTransferir.disabled = true;
    btnTransferir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transferindo...';
    
    // Enviar requisi√ß√£o
    fetch(`/militares/militar/${militarId}/transferir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            nova_lotacao: novaLotacao,
            observacoes: observacoes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalTransferencia'));
            modal.hide();
            // Recarregar p√°gina
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao transferir militar');
    })
    .finally(() => {
        // Reabilitar bot√£o
        btnTransferir.disabled = false;
        btnTransferir.innerHTML = '<i class="fas fa-exchange-alt"></i> Transferir';
    });
}
</script>

<!-- Modal de Transfer√™ncia de Militar -->
<div class="modal fade" id="modalTransferencia" tabindex="-1" aria-labelledby="modalTransferenciaLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTransferenciaLabel">
                    <i class="fas fa-exchange-alt me-2"></i>Transferir Militar
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formTransferencia">
                    {% csrf_token %}
                    <input type="hidden" id="militarId" name="militar_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Militar:</label>
                            <p class="form-control-plaintext" id="nomeMilitar"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Lota√ß√£o Atual:</label>
                            <p class="form-control-plaintext" id="lotacaoAtual"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="buscaLotacao" class="form-label fw-bold">Nova Lota√ß√£o <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="buscaLotacao" placeholder="Clique para ver toda a estrutura organizacional ou digite para buscar..." autocomplete="off">
                            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                <i class="fas fa-search text-muted"></i>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Dica:</strong> Clique no campo acima para ver toda a estrutura organizacional hier√°rquica, ou digite para buscar uma estrutura espec√≠fica.
                        </div>
                        <div id="resultadosBusca" class="list-group mt-2" style="max-height: 300px; overflow-y: auto; display: none;"></div>
                        <!-- Campo hidden para manter compatibilidade com o backend -->
                        <input type="hidden" id="novaLotacao" name="nova_lotacao" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label fw-bold">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3" 
                                  placeholder="Informa√ß√µes adicionais sobre a transfer√™ncia (opcional)"></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> A lota√ß√£o atual ser√° finalizada automaticamente e uma nova lota√ß√£o ser√° criada com a data de hoje.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnTransferir" onclick="transferirMilitar()">
                    <i class="fas fa-exchange-alt me-1"></i>Transferir
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

 