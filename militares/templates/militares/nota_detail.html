{% extends 'base.html' %}
{% load static %}

{% block title %}Nota: {{ nota.titulo }}{% endblock %}

{% block extra_css %}
<style>
    .nota-detail {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .nota-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 15px 15px 0 0;
        text-align: center;
    }
    
    .nota-body {
        background: white;
        padding: 40px;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .nota-meta {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .meta-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .meta-item:last-child {
        border-bottom: none;
    }
    
    .meta-label {
        font-weight: 600;
        color: #495057;
    }
    
    .meta-value {
        color: #6c757d;
    }
    
    .tipo-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
    }
    
    .tipo-nota {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .status-rascunho {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-publicado {
        background-color: #d4edda;
        color: #155724;
    }
    
    .conteudo {
        line-height: 1.8;
        font-size: 1.1em;
        color: #333;
    }
    
    .btn-custom {
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="nota-detail">
        <div class="nota-header">
            <h1 class="h2 mb-3">{{ nota.titulo }}</h1>
            <div class="d-flex justify-content-center gap-3 mb-3">
                <span class="tipo-badge tipo-nota">
                    Nota
                </span>
                <span class="status-badge status-{{ nota.status|lower }}">
                    {{ nota.get_status_display }}
                </span>
            </div>
            <p class="mb-0">
                <strong>{{ nota.numero }}</strong> • 
                Criado em {{ nota.data_criacao|date:"d/m/Y H:i" }}
                {% if nota.data_publicacao %}
                    • Publicado em {{ nota.data_publicacao|date:"d/m/Y H:i" }}
                {% endif %}
            </p>
        </div>
        
        <div class="nota-body">
            <!-- Metadados -->
            <div class="nota-meta">
                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações da Nota</h5>
                <div class="meta-item">
                    <span class="meta-label">Número:</span>
                    <span class="meta-value">{{ nota.numero }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Tipo:</span>
                    <span class="meta-value">Nota</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Status:</span>
                    <span class="meta-value">
                        <span class="status-badge status-{{ nota.status|lower }}">
                            {{ nota.get_status_display }}
                        </span>
                    </span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Origem:</span>
                    <span class="meta-value">{{ nota.origem_publicacao|default:"-" }}</span>
                </div>
                {% if nota.tipo_publicacao %}
                <div class="meta-item">
                    <span class="meta-label">Tipo de Publicação:</span>
                    <span class="meta-value">{{ nota.tipo_publicacao }}</span>
                </div>
                {% endif %}
                {% if nota.topicos %}
                <div class="meta-item">
                    <span class="meta-label">Tópicos:</span>
                    <span class="meta-value">{{ nota.topicos }}</span>
                </div>
                {% endif %}
                <div class="meta-item">
                    <span class="meta-label">Criado por:</span>
                    <span class="meta-value">{{ nota.criado_por.get_full_name|default:nota.criado_por.username }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Data de Criação:</span>
                    <span class="meta-value">{{ nota.data_criacao|date:"d/m/Y H:i" }}</span>
                </div>
                {% if nota.data_publicacao and nota.publicado_por %}
                <div class="meta-item">
                    <span class="meta-label">Publicado por:</span>
                    <span class="meta-value">{{ nota.publicado_por.get_full_name|default:nota.publicado_por.username }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Data de Publicação:</span>
                    <span class="meta-value">{{ nota.data_publicacao|date:"d/m/Y H:i" }}</span>
                </div>
                {% endif %}
                <div class="meta-item">
                    <span class="meta-label">Última Atualização:</span>
                    <span class="meta-value">{{ nota.data_atualizacao|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
            
            <!-- Conteúdo -->
            <div class="conteudo">
                {{ nota.conteudo|safe }}
            </div>
            
            <!-- Assinaturas -->
            <div class="assinaturas">
                <h5 class="mb-3"><i class="fas fa-signature me-2"></i>Assinaturas</h5>
                {% if nota.assinaturas.exists %}
                    <div class="row">
                        {% for assinatura in nota.assinaturas.all %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-{% if assinatura.tipo_assinatura == 'APROVACAO' %}success{% elif assinatura.tipo_assinatura == 'REVISAO' %}info{% elif assinatura.tipo_assinatura == 'EDICAO' %}warning{% else %}secondary{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-{% if assinatura.tipo_assinatura == 'APROVACAO' %}check-circle{% elif assinatura.tipo_assinatura == 'REVISAO' %}search{% elif assinatura.tipo_assinatura == 'EDICAO' %}edit{% else %}signature{% endif %} me-2"></i>
                                        {{ assinatura.get_tipo_assinatura_display }}
                                    </h6>
                                    <p class="card-text">
                                        <strong>Assinado por:</strong> {{ assinatura.assinado_por.get_full_name }}<br>
                                        <strong>Data:</strong> {{ assinatura.data_assinatura|date:"d/m/Y H:i" }}<br>
                                        {% if assinatura.funcao_assinatura %}
                                            <strong>Função:</strong> {{ assinatura.funcao_assinatura }}<br>
                                        {% endif %}
                                        {% if assinatura.observacoes %}
                                            <strong>Observações:</strong> {{ assinatura.observacoes }}
                                        {% endif %}
                                    </p>
                                    {% if assinatura.assinado_por == user or user.is_superuser %}
                                    <a href="{% url 'militares:retirar_assinatura_nota' nota.pk assinatura.pk %}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Tem certeza que deseja retirar esta assinatura?')">
                                        <i class="fas fa-times me-1"></i>
                                        Retirar Assinatura
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhuma assinatura registrada para esta nota.
                    </div>
                {% endif %}
            </div>
            
            <!-- Ações -->
            <div class="acoes">
                <h5 class="mb-3"><i class="fas fa-cogs me-2"></i>Ações</h5>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <a href="{% url 'militares:notas_list' %}" class="btn btn-secondary btn-custom">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar à Lista de Notas
                    </a>
                    
                    <button type="button" class="btn btn-primary btn-custom" onclick="copiarLinkPDF()">
                        <i class="fas fa-copy me-2"></i>
                        Copiar Link PDF
                    </button>
                    
                    <a href="{% url 'militares:nota_gerar_pdf' nota.pk %}" class="btn btn-success btn-custom" target="_blank">
                        <i class="fas fa-file-pdf me-2"></i>
                        Abrir PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Adicionar animação
        $('.nota-detail').addClass('fade-in');
        
        // Adicionar efeito de hover nos botões
        $('.btn-custom').hover(
            function() {
                $(this).addClass('shadow-lg');
            },
            function() {
                $(this).removeClass('shadow-lg');
            }
        );
    });
    
    // Função para copiar link do PDF
    function copiarLinkPDF() {
        const linkPDF = window.location.origin + "{% url 'militares:nota_gerar_pdf' nota.pk %}";
        
        // Usar a API moderna de clipboard
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(linkPDF).then(function() {
                mostrarMensagemSucesso('Link do PDF copiado para a área de transferência!');
            }).catch(function(err) {
                console.error('Erro ao copiar: ', err);
                copiarFallback(linkPDF);
            });
        } else {
            // Fallback para navegadores mais antigos
            copiarFallback(linkPDF);
        }
    }
    
    // Função fallback para copiar
    function copiarFallback(texto) {
        const textArea = document.createElement('textarea');
        textArea.value = texto;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            mostrarMensagemSucesso('Link do PDF copiado para a área de transferência!');
        } catch (err) {
            console.error('Erro ao copiar: ', err);
            mostrarMensagemErro('Erro ao copiar link. Tente novamente.');
        }
        
        document.body.removeChild(textArea);
    }
    
    // Função para mostrar mensagem de sucesso - DESABILITADA
    function mostrarMensagemSucesso(mensagem) {
        // Sistema de toast desabilitado - usando modais modernos
        return;
    }
    
    // Função para mostrar mensagem de erro - DESABILITADA
    function mostrarMensagemErro(mensagem) {
        // Sistema de toast desabilitado - usando modais modernos
        return;
    }
</script>

<style>
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}
