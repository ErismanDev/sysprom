{% load static %}

<div class="modal-header bg-primary text-white">
    <h5 class="modal-title" id="criarArmaParticularModalLabel">
        <i class="fas fa-user-shield me-2"></i>
        {% if object %}Editar Arma Particular{% else %}Nova Arma Particular{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="formCriarArmaParticular" method="post" action="{% if object %}{% url 'militares:arma_particular_update' object.pk %}{% else %}{% url 'militares:arma_particular_create' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Militar e Arma -->
        <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Militar e Arma</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.militar.id_for_label }}" class="form-label">
                    Militar <span class="text-danger">*</span>
                </label>
                {{ form.militar }}
                {% if form.militar.errors %}
                    <div class="invalid-feedback d-block">{{ form.militar.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_serie.id_for_label }}" class="form-label">
                    Número de Série <span class="text-danger">*</span>
                </label>
                {{ form.numero_serie }}
                {% if form.numero_serie.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_serie.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                    Tipo <span class="text-danger">*</span>
                </label>
                {{ form.tipo }}
                {% if form.tipo.errors %}
                    <div class="invalid-feedback d-block">{{ form.tipo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.calibre.id_for_label }}" class="form-label">
                    Calibre <span class="text-danger">*</span>
                </label>
                {{ form.calibre }}
                {% if form.calibre.errors %}
                    <div class="invalid-feedback d-block">{{ form.calibre.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Status <span class="text-danger">*</span>
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="{{ form.capacidade_carregador.id_for_label }}" class="form-label">
                    Capacidade
                </label>
                {{ form.capacidade_carregador }}
                {% if form.capacidade_carregador.errors %}
                    <div class="invalid-feedback d-block">{{ form.capacidade_carregador.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.marca.id_for_label }}" class="form-label">
                    Marca <span class="text-danger">*</span>
                </label>
                {{ form.marca }}
                {% if form.marca.errors %}
                    <div class="invalid-feedback d-block">{{ form.marca.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.modelo.id_for_label }}" class="form-label">
                    Modelo <span class="text-danger">*</span>
                </label>
                {{ form.modelo }}
                {% if form.modelo.errors %}
                    <div class="invalid-feedback d-block">{{ form.modelo.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.numero_canhao.id_for_label }}" class="form-label">
                    Nº Canhão
                </label>
                {{ form.numero_canhao }}
                {% if form.numero_canhao.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_canhao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Alma Raiada -->
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.alma_raiada }}
                    <label class="form-check-label" for="{{ form.alma_raiada.id_for_label }}">
                        {{ form.alma_raiada.label }}
                    </label>
                    {% if form.alma_raiada.help_text %}
                        <small class="form-text text-muted d-block">{{ form.alma_raiada.help_text }}</small>
                    {% endif %}
                </div>
                {% if form.alma_raiada.errors %}
                    <div class="invalid-feedback d-block">{{ form.alma_raiada.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Campos de Raias -->
        <div class="row" id="raias-campos" style="display: none;">
            <div class="col-md-6 mb-3">
                <label for="{{ form.quantidade_raias.id_for_label }}" class="form-label">
                    Quantidade de Raias
                </label>
                {{ form.quantidade_raias }}
                {% if form.quantidade_raias.help_text %}
                    <small class="form-text text-muted">{{ form.quantidade_raias.help_text }}</small>
                {% endif %}
                {% if form.quantidade_raias.errors %}
                    <div class="invalid-feedback d-block">{{ form.quantidade_raias.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.direcao_raias.id_for_label }}" class="form-label">
                    Direção das Raias
                </label>
                {{ form.direcao_raias }}
                {% if form.direcao_raias.help_text %}
                    <small class="form-text text-muted">{{ form.direcao_raias.help_text }}</small>
                {% endif %}
                {% if form.direcao_raias.errors %}
                    <div class="invalid-feedback d-block">{{ form.direcao_raias.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Documentação -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Documentação</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_registro_policia.id_for_label }}" class="form-label">
                    Nº Registro SIGMA <span class="text-danger">*</span>
                </label>
                {{ form.numero_registro_policia }}
                {% if form.numero_registro_policia.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_registro_policia.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.data_validade_registro.id_for_label }}" class="form-label">
                    Data de Validade do Registro
                </label>
                {{ form.data_validade_registro }}
                {% if form.data_validade_registro.errors %}
                    <div class="invalid-feedback d-block">{{ form.data_validade_registro.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.numero_guia_transito.id_for_label }}" class="form-label">
                    Nº Guia de Trânsito
                </label>
                {{ form.numero_guia_transito }}
                {% if form.numero_guia_transito.errors %}
                    <div class="invalid-feedback d-block">{{ form.numero_guia_transito.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.data_validade_guia.id_for_label }}" class="form-label">
                    Data de Validade da Guia
                </label>
                {{ form.data_validade_guia }}
                {% if form.data_validade_guia.errors %}
                    <div class="invalid-feedback d-block">{{ form.data_validade_guia.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Autorizado a Portar a Arma -->
        <hr>
        <h5 class="mb-3"><i class="fas fa-shield-check me-2"></i>Autorizado a Portar a Arma</h5>
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    {{ form.autorizado_uso_servico }}
                    <label class="form-check-label" for="{{ form.autorizado_uso_servico.id_for_label }}">
                        Autorizado a portar a arma
                    </label>
                </div>
            </div>
            <div class="col-md-6 mb-3" id="data-autorizacao-campo" style="display: none;">
                <label for="{{ form.data_autorizacao.id_for_label }}" class="form-label">
                    Data de Autorização
                </label>
                {{ form.data_autorizacao }}
                {% if form.data_autorizacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.data_autorizacao.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3" id="data-vencimento-autorizacao-campo" style="display: none;">
                <label for="{{ form.data_vencimento_autorizacao.id_for_label }}" class="form-label">
                    Data de Vencimento da Autorização
                </label>
                {{ form.data_vencimento_autorizacao }}
                {% if form.data_vencimento_autorizacao.errors %}
                    <div class="invalid-feedback d-block">{{ form.data_vencimento_autorizacao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Observações -->
        <hr>
        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
                <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Ativo -->
        <div class="mb-3 form-check">
            {{ form.ativo }}
            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                Arma ativa
            </label>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
(function() {
    // Executar imediatamente quando o script for carregado (não esperar DOMContentLoaded)
    // Usar setTimeout para garantir que o DOM foi atualizado
    // Aumentar delay para garantir que o conteúdo foi inserido no modal
    setTimeout(function() {
        // Mostrar/ocultar campos de autorização baseado no checkbox
        const autorizadoCheckbox = document.getElementById('{{ form.autorizado_uso_servico.id_for_label }}');
        const dataAutorizacaoDiv = document.getElementById('data-autorizacao-campo');
        const dataVencimentoDiv = document.getElementById('data-vencimento-autorizacao-campo');
        
        function toggleAutorizacaoFields() {
            if (autorizadoCheckbox) {
                // Verificar se há dados de autorização (na edição)
                {% if object %}
                const temDataAutorizacao = {% if object.data_autorizacao %}true{% else %}false{% endif %};
                const temDataVencimento = {% if object.data_vencimento_autorizacao %}true{% else %}false{% endif %};
                
                if (autorizadoCheckbox.checked || temDataAutorizacao || temDataVencimento) {
                    if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'block';
                    if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'block';
                } else {
                    if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'none';
                    if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'none';
                }
                {% else %}
                if (autorizadoCheckbox.checked) {
                    if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'block';
                    if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'block';
                } else {
                    if (dataAutorizacaoDiv) dataAutorizacaoDiv.style.display = 'none';
                    if (dataVencimentoDiv) dataVencimentoDiv.style.display = 'none';
                }
                {% endif %}
            }
        }
        
        if (autorizadoCheckbox) {
            autorizadoCheckbox.addEventListener('change', toggleAutorizacaoFields);
            // Aguardar um pouco para garantir que as datas foram carregadas
            setTimeout(function() {
                toggleAutorizacaoFields();
            }, 150);
        }
        
        // Garantir que as datas sejam carregadas corretamente na edição
        // Usar o valor do formulário primeiro, depois tentar do objeto
        function carregarDatas() {
            {% if object %}
            // Data de Validade do Registro
            const dataValidadeRegistroInput = document.getElementById('{{ form.data_validade_registro.id_for_label }}');
            if (dataValidadeRegistroInput) {
                // Tentar primeiro o valor do formulário
                let valor = dataValidadeRegistroInput.value;
                if (!valor || valor === '') {
                    // Se não tiver valor, tentar do objeto
                    {% if object.data_validade_registro %}
                    valor = '{{ object.data_validade_registro|date:"Y-m-d" }}';
                    {% endif %}
                }
                if (valor && valor !== '' && valor !== 'None') {
                    dataValidadeRegistroInput.value = valor;
                }
            }
            
            // Data de Validade da Guia
            const dataValidadeGuiaInput = document.getElementById('{{ form.data_validade_guia.id_for_label }}');
            if (dataValidadeGuiaInput) {
                let valor = dataValidadeGuiaInput.value;
                if (!valor || valor === '') {
                    {% if object.data_validade_guia %}
                    valor = '{{ object.data_validade_guia|date:"Y-m-d" }}';
                    {% endif %}
                }
                if (valor && valor !== '' && valor !== 'None') {
                    dataValidadeGuiaInput.value = valor;
                }
            }
            
            // Data de Autorização
            const dataAutorizacaoInput = document.getElementById('{{ form.data_autorizacao.id_for_label }}');
            if (dataAutorizacaoInput) {
                let valor = dataAutorizacaoInput.value;
                if (!valor || valor === '') {
                    {% if object.data_autorizacao %}
                    valor = '{{ object.data_autorizacao|date:"Y-m-d" }}';
                    {% endif %}
                }
                if (valor && valor !== '' && valor !== 'None') {
                    dataAutorizacaoInput.value = valor;
                }
            }
            
            // Data de Vencimento da Autorização
            const dataVencimentoInput = document.getElementById('{{ form.data_vencimento_autorizacao.id_for_label }}');
            if (dataVencimentoInput) {
                let valor = dataVencimentoInput.value;
                if (!valor || valor === '') {
                    {% if object.data_vencimento_autorizacao %}
                    valor = '{{ object.data_vencimento_autorizacao|date:"Y-m-d" }}';
                    {% endif %}
                }
                if (valor && valor !== '' && valor !== 'None') {
                    dataVencimentoInput.value = valor;
                }
            }
            {% endif %}
        }
        
        // Carregar datas imediatamente e depois com delay
        carregarDatas();
        setTimeout(carregarDatas, 200);
        setTimeout(carregarDatas, 500);
        
        // Mostrar/ocultar campos de raias baseado no checkbox
        function toggleRaiasCampos() {
            const almaRaiadaCheckbox = document.getElementById('id_alma_raiada');
            const raiasCampos = document.getElementById('raias-campos');
            const quantidadeRaiasInput = document.getElementById('id_quantidade_raias');
            const direcaoRaiasSelect = document.getElementById('id_direcao_raias');
            
            if (almaRaiadaCheckbox && raiasCampos) {
                if (almaRaiadaCheckbox.checked) {
                    raiasCampos.style.display = 'block';
                    if (quantidadeRaiasInput) {
                        quantidadeRaiasInput.required = true;
                    }
                    if (direcaoRaiasSelect) {
                        direcaoRaiasSelect.required = true;
                    }
                } else {
                    raiasCampos.style.display = 'none';
                    if (quantidadeRaiasInput) {
                        quantidadeRaiasInput.required = false;
                        quantidadeRaiasInput.value = '';
                    }
                    if (direcaoRaiasSelect) {
                        direcaoRaiasSelect.required = false;
                        direcaoRaiasSelect.value = '';
                    }
                }
            }
        }
        
        const almaRaiadaCheckbox = document.getElementById('id_alma_raiada');
        const raiasCampos = document.getElementById('raias-campos');
        
        if (almaRaiadaCheckbox) {
            // Adicionar listener para mudanças
            almaRaiadaCheckbox.addEventListener('change', toggleRaiasCampos);
            // Adicionar listener para clique também (para garantir que funcione)
            almaRaiadaCheckbox.addEventListener('click', function() {
                setTimeout(toggleRaiasCampos, 10);
            });
            
            // Verificar estado inicial imediatamente
            toggleRaiasCampos();
            
            // Verificar novamente após um pequeno delay para garantir
            setTimeout(toggleRaiasCampos, 50);
            
            // Se estiver editando e já houver valores, mostrar os campos
            {% if object and object.alma_raiada %}
            if (almaRaiadaCheckbox.checked) {
                if (raiasCampos) {
                    raiasCampos.style.display = 'block';
                }
            }
            {% endif %}
        } else {
            // Se o checkbox não foi encontrado, tentar novamente após um delay maior
            setTimeout(function() {
                const retryCheckbox = document.getElementById('id_alma_raiada');
                const retryRaiasCampos = document.getElementById('raias-campos');
                if (retryCheckbox && retryRaiasCampos) {
                    retryCheckbox.addEventListener('change', toggleRaiasCampos);
                    retryCheckbox.addEventListener('click', function() {
                        setTimeout(toggleRaiasCampos, 10);
                    });
                    toggleRaiasCampos();
                }
            }, 300);
        }
    
    // Inicializar Select2 para o campo de militar
    function inicializarSelect2Militar() {
        if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
            const militarSelect = $('.militar-select2');
            
            // Verificar se o Select2 já foi inicializado
            if (militarSelect.length && !militarSelect.hasClass('select2-hidden-accessible')) {
                militarSelect.select2({
                    placeholder: 'Digite o nome, matrícula ou posto do militar...',
                    allowClear: true,
                    minimumInputLength: 2,
                    dropdownParent: $('#criarArmaParticularModal'),
                    ajax: {
                        url: '{% url "militares:militar-autocomplete" %}',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term || ''
                            };
                        },
                        processResults: function (data) {
                            return {
                                results: data.results || []
                            };
                        },
                        cache: true
                    },
                    language: {
                        inputTooShort: function () {
                            return 'Digite pelo menos 2 caracteres...';
                        },
                        noResults: function () {
                            return 'Nenhum militar encontrado';
                        },
                        searching: function () {
                            return 'Buscando...';
                        }
                    }
                });
                
                // Se há um militar já selecionado (na edição), carregar os dados
                {% if object and object.militar %}
                const militarId = {{ object.militar.id }};
                const militarText = "{{ object.militar.get_posto_graduacao_display }} {{ object.militar.nome_completo }} - Mat: {{ object.militar.matricula }}";
                if (militarId) {
                    const option = new Option(militarText, militarId, true, true);
                    militarSelect.append(option).trigger('change');
                }
                {% endif %}
            }
        }
    }
    
    // Tentar inicializar imediatamente
    inicializarSelect2Militar();
    
    // Se não funcionou, tentar novamente após um pequeno delay
    setTimeout(function() {
        inicializarSelect2Militar();
    }, 100);
    
    // Submeter formulário via AJAX
    const formCriarArmaParticular = document.getElementById('formCriarArmaParticular');
    if (formCriarArmaParticular) {
        formCriarArmaParticular.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(formCriarArmaParticular);
            const submitButton = formCriarArmaParticular.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Desabilitar botão e mostrar loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            fetch(formCriarArmaParticular.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                // Verificar se a resposta é JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Se não for JSON, pode ser um erro HTML
                    return response.text().then(text => {
                        throw new Error('Resposta não é JSON');
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    if (typeof showToast === 'function') {
                        showToast('success', data.message || 'Arma particular salva com sucesso!');
                    } else {
                        alert(data.message || 'Arma particular salva com sucesso!');
                    }
                    
                    // Fechar modal
                    const modalElement = document.getElementById('criarArmaParticularModal');
                    if (modalElement) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    }
                    
                    // Recarregar página após um pequeno delay
                    setTimeout(function() {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.reload();
                        }
                    }, 300);
                } else {
                    // Mostrar erros
                    let errorMessage = data.message || 'Erro ao salvar arma particular.';
                    if (data.errors) {
                        errorMessage += '\n\nErros:\n';
                        for (const field in data.errors) {
                            errorMessage += field + ': ' + data.errors[field].join(', ') + '\n';
                        }
                    }
                    alert(errorMessage);
                    
                    // Reabilitar botão
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar arma particular. Tente novamente.');
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        });
    }
    }, 200); // Delay inicial para garantir que o DOM foi atualizado e o modal está pronto
})(); // Fechar IIFE
</script>

