<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-wrench me-2"></i>{% if manutencao %}Editar Manutenção{% else %}Nova Manutenção{% endif %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="formManutencaoEquipamento" method="post" action="{% if manutencao %}{% url 'militares:equipamento_manutencao_update' manutencao.pk %}{% else %}{% url 'militares:equipamento_manutencao_create' %}{% endif %}">
    {% csrf_token %}
    <div class="modal-body">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.equipamento.id_for_label }}" class="form-label">
                    Equipamento <span class="text-danger">*</span>
                </label>
                {{ form.equipamento }}
                {% if form.equipamento.errors %}
                    <div class="text-danger small">{{ form.equipamento.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.data_manutencao.id_for_label }}" class="form-label">
                    Data e Hora da Manutenção <span class="text-danger">*</span>
                </label>
                {{ form.data_manutencao }}
                {% if form.data_manutencao.errors %}
                    <div class="text-danger small">{{ form.data_manutencao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.tipo_manutencao.id_for_label }}" class="form-label">
                    Tipo de Manutenção <span class="text-danger">*</span>
                </label>
                {{ form.tipo_manutencao }}
                {% if form.tipo_manutencao.errors %}
                    <div class="text-danger small">{{ form.tipo_manutencao.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.horas_uso_manutencao.id_for_label }}" class="form-label">
                    Horas de Uso na Manutenção <span class="text-danger">*</span>
                </label>
                {{ form.horas_uso_manutencao }}
                {% if form.horas_uso_manutencao.errors %}
                    <div class="text-danger small">{{ form.horas_uso_manutencao.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Horas de uso do equipamento no momento da manutenção
                </small>
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="{{ form.valor_manutencao.id_for_label }}" class="form-label">
                    Valor da Manutenção (R$) <span class="text-danger">*</span>
                </label>
                {{ form.valor_manutencao }}
                {% if form.valor_manutencao.errors %}
                    <div class="text-danger small">{{ form.valor_manutencao.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.fornecedor_oficina.id_for_label }}" class="form-label">
                    Oficina
                </label>
                {{ form.fornecedor_oficina }}
                {% if form.fornecedor_oficina.errors %}
                    <div class="text-danger small">{{ form.fornecedor_oficina.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="{{ form.proximas_horas_revisao.id_for_label }}" class="form-label">
                    Horas para Próxima Revisão
                </label>
                {{ form.proximas_horas_revisao }}
                {% if form.proximas_horas_revisao.errors %}
                    <div class="text-danger small">{{ form.proximas_horas_revisao.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle"></i> Apenas para tipo Revisão
                </small>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.descricao_servico.id_for_label }}" class="form-label">
                    Descrição do Serviço <span class="text-danger">*</span>
                </label>
                {{ form.descricao_servico }}
                {% if form.descricao_servico.errors %}
                    <div class="text-danger small">{{ form.descricao_servico.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.pecas_trocadas.id_for_label }}" class="form-label">
                    Peças Trocadas
                </label>
                {{ form.pecas_trocadas }}
                {% if form.pecas_trocadas.errors %}
                    <div class="text-danger small">{{ form.pecas_trocadas.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                    Responsável pela Manutenção
                </label>
                {{ form.responsavel }}
                {% if form.responsavel.errors %}
                    <div class="text-danger small">{{ form.responsavel.errors }}</div>
                {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                    {{ form.ativo }}
                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                        Ativo
                    </label>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                    Observações
                </label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="text-danger small">{{ form.observacoes.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salvar
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Formatação de valores monetários
    $('#{{ form.valor_manutencao.id_for_label }}').on('blur', function() {
        formatarMoeda($(this));
    });
    
    // Submissão do formulário via AJAX
    $('#formManutencaoEquipamento').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var formData = form.serialize();
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (typeof response === 'object' && response.success) {
                    $('#manutencaoModal').modal('hide');
                    location.reload();
                } else {
                    $('#manutencaoModalBody').html(response);
                }
            },
            error: function(xhr) {
                if (xhr.status === 200) {
                    $('#manutencaoModalBody').html(xhr.responseText);
                } else {
                    alert('Erro ao salvar manutenção. Por favor, tente novamente.');
                }
            }
        });
    });
});

function formatarMoeda(input) {
    var valor = input.val().replace(/[^\d,]/g, '');
    if (valor) {
        valor = valor.replace(',', '.');
        input.val(parseFloat(valor).toFixed(2).replace('.', ','));
    }
}
</script>

