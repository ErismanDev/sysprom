{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Viatura{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-car me-2 text-primary"></i>
                        {% if object %}Editar Viatura{% else %}Nova Viatura{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando viatura {{ object.placa }}{% else %}Cadastrar nova viatura{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:viatura_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>Dados da Viatura
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}
                                
                                <!-- Identificação -->
                                <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Identificação</h5>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.prefixo.id_for_label }}" class="form-label">
                                            Prefixo
                                        </label>
                                        {{ form.prefixo }}
                                        {% if form.prefixo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.prefixo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.placa.id_for_label }}" class="form-label">
                                            Placa <span class="text-danger">*</span>
                                        </label>
                                        {{ form.placa }}
                                        {% if form.placa.errors %}
                                            <div class="invalid-feedback d-block">{{ form.placa.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                            Tipo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.tipo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            Status <span class="text-danger">*</span>
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.marca.id_for_label }}" class="form-label">
                                            Marca <span class="text-danger">*</span>
                                        </label>
                                        {{ form.marca }}
                                        {% if form.marca.errors %}
                                            <div class="invalid-feedback d-block">{{ form.marca.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.modelo.id_for_label }}" class="form-label">
                                            Modelo <span class="text-danger">*</span>
                                        </label>
                                        {{ form.modelo }}
                                        {% if form.modelo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.modelo.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.ano_fabricacao.id_for_label }}" class="form-label">
                                            Ano Fab. <span class="text-danger">*</span>
                                        </label>
                                        {{ form.ano_fabricacao }}
                                        {% if form.ano_fabricacao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.ano_fabricacao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ form.ano_modelo.id_for_label }}" class="form-label">
                                            Ano Mod. <span class="text-danger">*</span>
                                        </label>
                                        {{ form.ano_modelo }}
                                        {% if form.ano_modelo.errors %}
                                            <div class="invalid-feedback d-block">{{ form.ano_modelo.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Documentação -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Documentação</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.chassi.id_for_label }}" class="form-label">Chassi</label>
                                        {{ form.chassi }}
                                        {% if form.chassi.errors %}
                                            <div class="invalid-feedback d-block">{{ form.chassi.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.renavam.id_for_label }}" class="form-label">RENAVAM</label>
                                        {{ form.renavam }}
                                        {% if form.renavam.errors %}
                                            <div class="invalid-feedback d-block">{{ form.renavam.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.cor.id_for_label }}" class="form-label">Cor</label>
                                        {{ form.cor }}
                                        {% if form.cor.errors %}
                                            <div class="invalid-feedback d-block">{{ form.cor.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Uso e Manutenção -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-wrench me-2"></i>Uso e Manutenção</h5>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.km_atual.id_for_label }}" class="form-label">KM Atual</label>
                                        {{ form.km_atual }}
                                        {% if form.km_atual.errors %}
                                            <div class="invalid-feedback d-block">{{ form.km_atual.errors }}</div>
                                        {% endif %}
                                        {% if object and not user.is_superuser %}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-lock me-1"></i>O KM atual não pode ser alterado manualmente. Apenas superusuários podem modificar este campo.
                                            </small>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.combustivel.id_for_label }}" class="form-label">Combustível</label>
                                        {{ form.combustivel }}
                                        {% if form.combustivel.errors %}
                                            <div class="invalid-feedback d-block">{{ form.combustivel.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.capacidade_tanque.id_for_label }}" class="form-label">Capacidade Tanque (L)</label>
                                        {{ form.capacidade_tanque }}
                                        {% if form.capacidade_tanque.errors %}
                                            <div class="invalid-feedback d-block">{{ form.capacidade_tanque.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ form.cartao_abastecimento.id_for_label }}" class="form-label">Cartão de Abastecimento</label>
                                        {{ form.cartao_abastecimento }}
                                        {% if form.cartao_abastecimento.errors %}
                                            <div class="invalid-feedback d-block">{{ form.cartao_abastecimento.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Número do cartão utilizado para abastecimento</small>
                                    </div>
                                </div>
                                
                                <!-- Organização -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-building me-2"></i>Organização Responsável</h5>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="organograma-select" class="form-label">
                                            Organização <span class="text-danger">*</span>
                                        </label>
                                        <select name="organograma-select" id="organograma-select" class="form-select" required>
                                            <option value="">Selecione uma opção do organograma...</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Selecione a organização responsável pela viatura na hierarquia do organograma.
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Campos ocultos para armazenar os valores da organização -->
                                {{ form.orgao }}
                                {{ form.grande_comando }}
                                {{ form.unidade }}
                                {{ form.sub_unidade }}
                                
                                {% if form.orgao.errors or form.grande_comando.errors or form.unidade.errors or form.sub_unidade.errors %}
                                <div class="alert alert-danger">
                                    {% if form.orgao.errors %}{{ form.orgao.errors }}{% endif %}
                                    {% if form.grande_comando.errors %}{{ form.grande_comando.errors }}{% endif %}
                                    {% if form.unidade.errors %}{{ form.unidade.errors }}{% endif %}
                                    {% if form.sub_unidade.errors %}{{ form.sub_unidade.errors }}{% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Aquisição -->
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-dollar-sign me-2"></i>Aquisição</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="id_data_aquisicao" class="form-label">Data de Aquisição</label>
                                        {{ form.data_aquisicao }}
                                        {% if form.data_aquisicao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_aquisicao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="id_valor_aquisicao" class="form-label">Valor de Aquisição (R$)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" 
                                                   name="valor_aquisicao" 
                                                   id="id_valor_aquisicao" 
                                                   class="form-control" 
                                                   value=""
                                                   placeholder="0,00"
                                                   autocomplete="off">
                                        </div>
                                        {% if form.valor_aquisicao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_aquisicao.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Digite o valor - formatação automática em R$</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.fornecedor.id_for_label }}" class="form-label">Fornecedor</label>
                                        {{ form.fornecedor }}
                                        {% if form.fornecedor.errors %}
                                            <div class="invalid-feedback d-block">{{ form.fornecedor.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Observações -->
                                <hr>
                                <div class="mb-3">
                                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
                                    {{ form.observacoes }}
                                    {% if form.observacoes.errors %}
                                        <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Ativo -->
                                <div class="mb-3 form-check">
                                    {{ form.ativo }}
                                    <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                        Viatura ativa
                                    </label>
                                </div>
                                
                                <!-- Informações do Sistema (apenas na edição) -->
                                {% if object %}
                                <hr>
                                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações do Sistema</h5>
                                <div class="row">
                                    {% if object.criado_por %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Criado por</label>
                                        <input type="text" class="form-control" value="{{ object.criado_por.get_full_name|default:object.criado_por.username }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_criacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Data de Criação</label>
                                        <input type="text" class="form-control" value="{{ object.data_criacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                    {% if object.data_atualizacao %}
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Última Atualização</label>
                                        <input type="text" class="form-control" value="{{ object.data_atualizacao|date:'d/m/Y H:i' }}" readonly>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                    <a href="{% url 'militares:viatura_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidade de seleção hierárquica única do organograma
    const organogramaSelect = document.getElementById('organograma-select');
    const orgaoHidden = document.getElementById('id_orgao');
    const grandeComandoHidden = document.getElementById('id_grande_comando');
    const unidadeHidden = document.getElementById('id_unidade');
    const subUnidadeHidden = document.getElementById('id_sub_unidade');
    
    // Função para carregar toda a hierarquia do organograma
    async function carregarOrganogramaCompleto() {
        try {
            const response = await fetch('{% url "militares:ajax_organograma_completo" %}');
            const data = await response.json();
            
            // Limpar opções existentes (exceto a primeira)
            organogramaSelect.innerHTML = '<option value="">Selecione uma opção do organograma...</option>';
            
            // Adicionar opções da hierarquia
            data.hierarquia.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.texto;
                option.dataset.tipo = item.tipo;
                option.dataset.valor = JSON.stringify(item.valor);
                
                // Adicionar estilo baseado no nível
                if (item.nivel === 1) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#0d6efd';
                } else if (item.nivel === 2) {
                    option.style.fontWeight = '600';
                    option.style.color = '#198754';
                } else if (item.nivel === 3) {
                    option.style.color = '#fd7e14';
                } else if (item.nivel === 4) {
                    option.style.color = '#6f42c1';
                }
                
                organogramaSelect.appendChild(option);
            });
            
            // Selecionar opção atual se estiver editando
            {% if object %}
            selecionarOpcaoAtual();
            {% elif organograma_selecionado %}
            organogramaSelect.value = '{{ organograma_selecionado }}';
            atualizarCamposOcultos();
            {% endif %}
            
        } catch (error) {
            console.error('Erro ao carregar organograma:', error);
        }
    }
    
    // Função para selecionar a opção atual baseada nos valores do objeto
    function selecionarOpcaoAtual() {
        {% if object %}
        const orgaoId = {% if object.orgao %}{{ object.orgao.id }}{% else %}null{% endif %};
        const grandeComandoId = {% if object.grande_comando %}{{ object.grande_comando.id }}{% else %}null{% endif %};
        const unidadeId = {% if object.unidade %}{{ object.unidade.id }}{% else %}null{% endif %};
        const subUnidadeId = {% if object.sub_unidade %}{{ object.sub_unidade.id }}{% else %}null{% endif %};
        
        // Encontrar a opção correspondente
        for (let option of organogramaSelect.options) {
            if (option.value && option.dataset.valor) {
                const valor = JSON.parse(option.dataset.valor);
                
                // Verificar se corresponde aos valores atuais
                if (valor.orgao_id === orgaoId && 
                    valor.grande_comando_id === grandeComandoId && 
                    valor.unidade_id === unidadeId && 
                    valor.sub_unidade_id === subUnidadeId) {
                    
                    option.selected = true;
                    break;
                }
            }
        }
        {% endif %}
    }
    
    // Função para atualizar campos ocultos quando uma opção é selecionada
    function atualizarCamposOcultos() {
        const selectedOption = organogramaSelect.options[organogramaSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.valor) {
            const valor = JSON.parse(selectedOption.dataset.valor);
            
            // Atualizar campos do organograma
            if (orgaoHidden) orgaoHidden.value = valor.orgao_id || '';
            if (grandeComandoHidden) grandeComandoHidden.value = valor.grande_comando_id || '';
            if (unidadeHidden) unidadeHidden.value = valor.unidade_id || '';
            if (subUnidadeHidden) subUnidadeHidden.value = valor.sub_unidade_id || '';
        } else {
            // Limpar todos os campos se nenhuma opção estiver selecionada
            if (orgaoHidden) orgaoHidden.value = '';
            if (grandeComandoHidden) grandeComandoHidden.value = '';
            if (unidadeHidden) unidadeHidden.value = '';
            if (subUnidadeHidden) subUnidadeHidden.value = '';
        }
    }
    
    // Event listener para o select do organograma
    if (organogramaSelect) {
        organogramaSelect.addEventListener('change', atualizarCamposOcultos);
        
        // Carregar organograma completo
        carregarOrganogramaCompleto();
    }
    
    // Função para formatar número como moeda BRL (formato brasileiro: 1.234,56)
    // Aceita valores até trilhões
    function formatarMoedaBRL(valor) {
        if (!valor || valor === '') return '';
        
        // Converter string para número (remover formatação brasileira)
        let numeroString = valor.toString();
        
        // Remover pontos (separadores de milhar) e substituir vírgula por ponto
        numeroString = numeroString.replace(/\./g, '').replace(',', '.');
        
        // Remover caracteres não numéricos exceto ponto
        numeroString = numeroString.replace(/[^\d.]/g, '');
        
        let numero = parseFloat(numeroString);
        
        if (isNaN(numero) || numero < 0) return '';
        
        // Separar parte inteira e decimal manualmente
        let numeroStr = numero.toString();
        let partesStr = numeroStr.split('.');
        let parteInteiraStr = partesStr[0];
        let parteDecimalStr = partesStr[1] || '';
        
        // Limitar a 2 casas decimais
        if (parteDecimalStr.length > 2) {
            parteDecimalStr = parteDecimalStr.substring(0, 2);
        }
        
        // Garantir 2 casas decimais
        while (parteDecimalStr.length < 2) {
            parteDecimalStr += '0';
        }
        
        // Adicionar pontos a cada 3 dígitos da parte inteira
        parteInteiraStr = parteInteiraStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Retornar no formato brasileiro: "1.500.000,50"
        return parteInteiraStr + ',' + parteDecimalStr;
    }
    
    // Função para obter valor numérico limpo (sem formatação) para envio ao servidor
    function obterValorNumerico(valor) {
        if (!valor || valor === '') return '';
        // Remove pontos (milhar) e substitui vírgula por ponto (decimal)
        // Exemplo: "150.000,50" -> "150000.50"
        let numero = valor.toString().replace(/\./g, '').replace(',', '.');
        // Remove qualquer caractere não numérico exceto ponto
        numero = numero.replace(/[^\d.]/g, '');
        return numero;
    }
    
    // Formatação automática do campo Valor de Aquisição (BRL)
    const valorAquisicaoInput = document.getElementById('id_valor_aquisicao');
    
    if (valorAquisicaoInput) {
        // Garantir que o campo seja editável e comece vazio
        valorAquisicaoInput.readOnly = false;
        valorAquisicaoInput.disabled = false;
        
        // Carregar valor inicial apenas na edição
        {% if object and object.valor_aquisicao %}
        const valorInicial = parseFloat('{{ object.valor_aquisicao }}');
        if (!isNaN(valorInicial) && valorInicial > 0) {
            valorAquisicaoInput.value = formatarMoedaBRL(valorInicial.toString());
        }
        {% else %}
        valorAquisicaoInput.value = '';
        {% endif %}
        
        valorAquisicaoInput.addEventListener('input', function(e) {
            // Permitir entrada livre, apenas limpar caracteres inválidos
            let valor = e.target.value;
            // Remover apenas caracteres não numéricos, exceto vírgula (não permitir pontos durante digitação)
            let valorLimpo = valor.replace(/[^\d,]/g, '');
            
            // Garantir apenas uma vírgula como separador decimal
            let partes = valorLimpo.split(',');
            if (partes.length > 2) {
                // Manter apenas a primeira vírgula
                valorLimpo = partes[0] + ',' + partes.slice(1).join('');
            }
            // Garantir máximo de 2 casas decimais
            if (partes.length === 2 && partes[1].length > 2) {
                valorLimpo = partes[0] + ',' + partes[1].substring(0, 2);
            }
            
            if (valorLimpo !== valor) {
                let cursorPos = e.target.selectionStart;
                e.target.value = valorLimpo;
                setTimeout(() => {
                    let newCursorPos = Math.max(0, cursorPos - (valor.length - valorLimpo.length));
                    e.target.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            }
        });
        
        // Não formatar durante keyup - deixar usuário digitar livremente
        // A formatação será aplicada apenas no blur
        
        // Formatar apenas no blur para preservar o que o usuário digita
        valorAquisicaoInput.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor || valor === '') {
                e.target.value = '';
                return;
            }
            
            // Se já tem vírgula, preservar formato brasileiro EXATAMENTE como digitado
            if (valor.includes(',')) {
                let partes = valor.split(',');
                // Parte inteira: remover tudo exceto números
                let parteInteira = partes[0].replace(/[^\d]/g, '') || '0';
                // Parte decimal: apenas números, máximo 2 dígitos
                let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
                
                // Completar decimais com zeros APENAS se necessário (não forçar)
                while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                    parteDecimal += '0';
                }
                // Se não tinha decimal, adicionar ',00'
                if (parteDecimal === '') {
                    parteDecimal = '00';
                }
                
                // Adicionar pontos de milhar APENAS na parte inteira (se tiver mais de 3 dígitos)
                parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                e.target.value = parteInteira + ',' + parteDecimal;
            } else {
                // Se não tem vírgula e tem números, pode ser inteiro - adicionar ',00'
                let numeroLimpo = valor.replace(/[^\d]/g, '');
                if (numeroLimpo !== '') {
                    // Adicionar pontos de milhar se necessário
                    numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    e.target.value = numeroLimpo + ',00';
                } else {
                    e.target.value = '';
                }
            }
        });
        
        // Antes de enviar o formulário, converter para formato numérico (ponto como separador decimal)
        const form = valorAquisicaoInput.closest('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let valor = valorAquisicaoInput.value;
                if (valor) {
                    // Converter formato brasileiro para formato numérico (ex: 150.000,50 -> 150000.50)
                    let valorLimpo = valor.replace(/\./g, '').replace(',', '.');
                    valorAquisicaoInput.value = valorLimpo;
                }
            });
        }
    }
    
    // Garantir que a data de aquisição seja carregada corretamente na edição
    {% if object and object.data_aquisicao %}
    const dataAquisicaoInput = document.getElementById('id_data_aquisicao');
    if (dataAquisicaoInput) {
        const dataObj = '{{ object.data_aquisicao|date:"Y-m-d" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataAquisicaoInput.value = dataObj;
        }
    }
    {% endif %}
});
</script>
{% endblock %}


