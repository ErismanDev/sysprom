{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* Estilos para mensagens de erro */
.error-details {
    margin: 15px 0;
}

.error-item {
    padding: 10px;
    background-color: #f8f9fa;
    border-left: 4px solid #dc3545;
    border-radius: 4px;
}

.error-item strong {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
}

.error-message {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 5px 0;
    font-size: 13px;
}

.alert-heading {
    color: #721c24;
    font-weight: 600;
}

.alert.alert-danger {
    border-left: 5px solid #dc3545;
}

/* Campo com erro */
.field-error {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.field-error:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Mensagem de erro abaixo do campo */
.field-error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

/* Garantir que campos importantes sejam sempre visíveis */
.field-important {
    display: block !important;
}
</style>

<div class="container mt-4">
    <h4>Outorga de Medalha para Externo</h4>
    <form method="post">
        {% csrf_token %}
        <div class="card">
            <div class="card-body">
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Formulário com Erros</strong>
                        </h6>
                        <hr>
                        <div class="error-details">
                            {% for field, errors in form.errors.items %}
                                <div class="error-item mb-2">
                                    <strong class="text-danger">
                                        {% if field == 'medalha' %}
                                            Medalha:
                                        {% elif field == 'categoria_externa' %}
                                            Categoria:
                                        {% elif field == 'nome_externo' %}
                                            Nome:
                                        {% elif field == 'documento_externo' %}
                                            CPF:
                                        {% elif field == 'forca_externa' %}
                                            Força:
                                        {% elif field == 'uf_externa' %}
                                            UF:
                                        {% elif field == 'posto_graduacao_externo' %}
                                            Posto/Graduação:
                                        {% elif field == 'funcao_externa' %}
                                            Função:
                                        {% elif field == 'orgao_externo' %}
                                            Órgão:
                                        {% elif field == 'data_concessao' %}
                                            Data da Concessão:
                                        {% elif field == 'documento_tipo' %}
                                            Tipo de Documento:
                                        {% elif field == 'portaria_numero' %}
                                            Número da Portaria:
                                        {% elif field == 'portaria_data' %}
                                            Data da Portaria:
                                        {% elif field == 'indicado_por_nome' %}
                                            Nome de Quem Indicou:
                                        {% elif field == 'indicado_por_funcao' %}
                                            Função de Quem Indicou:
                                        {% elif field == 'observacoes' %}
                                            Observações:
                                        {% else %}
                                            {{ field|title }}:
                                        {% endif %}
                                    </strong>
                                    {% for error in errors %}
                                        <div class="error-message">
                                            {% if error == 'This field is required.' %}
                                                Este campo é obrigatório.
                                            {% elif error == 'Enter a valid date.' %}
                                                Digite uma data válida.
                                            {% elif error == 'Enter a valid email address.' %}
                                                Digite um endereço de e-mail válido.
                                            {% elif error == 'Enter a valid URL.' %}
                                                Digite uma URL válida.
                                            {% elif error == 'Enter a valid integer.' %}
                                                Digite um número inteiro válido.
                                            {% elif error == 'Enter a valid number.' %}
                                                Digite um número válido.
                                            {% else %}
                                                {{ error }}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Dica:</strong> Verifique os campos marcados com asterisco (*) e corrija os erros acima.
                        </small>
                    </div>
                {% endif %}
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {% if message.tags == 'error' %}
                                <i class="fas fa-exclamation-circle me-2"></i>
                            {% elif message.tags == 'success' %}
                                <i class="fas fa-check-circle me-2"></i>
                            {% elif message.tags == 'warning' %}
                                <i class="fas fa-exclamation-triangle me-2"></i>
                            {% elif message.tags == 'info' %}
                                <i class="fas fa-info-circle me-2"></i>
                            {% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <div class="row g-2">
                    <div class="col-md-6">
                        {{ form.medalha.label_tag }}
                        {{ form.medalha }}
                        {% if form.errors.medalha %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.medalha %}
                                    {% if error == 'This field is required.' %}
                                        Medalha é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.categoria_externa.label_tag }}
                        {{ form.categoria_externa }}
                        {% if form.errors.categoria_externa %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.categoria_externa %}
                                    {% if error == 'This field is required.' %}
                                        Categoria é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        {{ form.nome_externo.label_tag }}
                        {{ form.nome_externo }}
                        {% if form.errors.nome_externo %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.nome_externo %}
                                    {% if error == 'This field is required.' %}
                                        Nome é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 field-important">
                        {{ form.documento_externo.label_tag }}
                        {{ form.documento_externo }}
                        {% if form.errors.documento_externo %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.documento_externo %}
                                    {% if error == 'This field is required.' %}
                                        CPF é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ form.funcao_externa.label_tag }}
                        {{ form.funcao_externa }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Exemplos:</strong> Sargento, 123, Capitão, 456, etc. Aceita texto e números.
                        </small>
                        {% if form.errors.funcao_externa %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.funcao_externa %}
                                    {% if error == 'This field is required.' %}
                                        Função é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        {{ form.forca_externa.label_tag }}
                        {{ form.forca_externa }}
                        {% if form.errors.forca_externa %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.forca_externa %}
                                    {% if error == 'This field is required.' %}
                                        Força é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-2">
                        {{ form.uf_externa.label_tag }}
                        {{ form.uf_externa }}
                        {% if form.errors.uf_externa %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.uf_externa %}
                                    {% if error == 'This field is required.' %}
                                        UF é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.posto_graduacao_externo.label_tag }}
                        {{ form.posto_graduacao_externo }}
                        <datalist id="datalist_postos"></datalist>
                        {% if form.errors.posto_graduacao_externo %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.posto_graduacao_externo %}
                                    {% if error == 'This field is required.' %}
                                        Posto/Graduação é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        {{ form.orgao_externo.label_tag }}
                        {{ form.orgao_externo }}
                        {% if form.errors.orgao_externo %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.orgao_externo %}
                                    {% if error == 'This field is required.' %}
                                        Órgão é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        {{ form.data_concessao.label_tag }}
                        {{ form.data_concessao }}
                        {% if form.errors.data_concessao %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.data_concessao %}
                                    {% if error == 'This field is required.' %}
                                        Data da concessão é obrigatória.
                                    {% elif error == 'Enter a valid date.' %}
                                        Digite uma data válida.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        {{ form.documento_tipo.label_tag }}
                        {{ form.documento_tipo }}
                        {% if form.errors.documento_tipo %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.documento_tipo %}
                                    {% if error == 'This field is required.' %}
                                        Tipo de documento é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        {{ form.portaria_numero.label_tag }}
                        {{ form.portaria_numero }}
                        {% if form.errors.portaria_numero %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.portaria_numero %}
                                    {% if error == 'This field is required.' %}
                                        Número da portaria é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.portaria_data.label_tag }}
                        {{ form.portaria_data }}
                        {% if form.errors.portaria_data %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.portaria_data %}
                                    {% if error == 'This field is required.' %}
                                        Data da portaria é obrigatória.
                                    {% elif error == 'Enter a valid date.' %}
                                        Digite uma data válida.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        {{ form.indicado_por_nome.label_tag }}
                        {{ form.indicado_por_nome }}
                        {% if form.errors.indicado_por_nome %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.indicado_por_nome %}
                                    {% if error == 'This field is required.' %}
                                        Nome de quem indicou é obrigatório.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.indicado_por_funcao.label_tag }}
                        {{ form.indicado_por_funcao }}
                        {% if form.errors.indicado_por_funcao %}
                            <div class="field-error-message">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {% for error in form.errors.indicado_por_funcao %}
                                    {% if error == 'This field is required.' %}
                                        Função de quem indicou é obrigatória.
                                    {% else %}
                                        {{ error }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-2">
                    {{ form.observacoes.label_tag }}
                    {{ form.observacoes }}
                    {% if form.errors.observacoes %}
                        <div class="field-error-message">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            {% for error in form.errors.observacoes %}
                                {% if error == 'This field is required.' %}
                                    Observações são obrigatórias.
                                {% else %}
                                    {{ error }}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="alert alert-info mt-2">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Regras:</strong> FFAA exigem Força (FAB/EB/MB) e Posto/Graduação. Coirmãs (PM/CBM) exigem UF e Posto/Graduação. Função é opcional para todos; Instituição é opcional.
                    </small>
                </div>
                
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const categoria = document.getElementById('id_categoria_externa');
                    const forca = document.getElementById('id_forca_externa');
                    const uf = document.getElementById('id_uf_externa');
                    const posto = document.getElementById('id_posto_graduacao_externo');
                    const funcao = document.getElementById('id_funcao_externa');
                    const orgao = document.getElementById('id_orgao_externo');
                    const datalist = document.getElementById('datalist_postos');
                    
                    // Garantir que o campo CPF seja sempre editável
                    const cpfField = document.getElementById('id_documento_externo');
                    if (cpfField) {
                        cpfField.removeAttribute('readonly');
                        cpfField.removeAttribute('disabled');
                        cpfField.classList.add('field-important');
                    }
                    
                    if (posto) posto.setAttribute('list', 'datalist_postos');

                    const POSTOS = {
                        EB: [
                            'Soldado','Cabo','3º Sargento','2º Sargento','1º Sargento','Subtenente',
                            'Aspirante','2º Tenente','1º Tenente','Capitão','Major','Tenente-Coronel','Coronel',
                            'General de Brigada','General de Divisão','General de Exército'
                        ],
                        FAB: [
                            'Soldado','Cabo','3º Sargento','2º Sargento','1º Sargento','Suboficial',
                            'Aspirante','2º Tenente','1º Tenente','Capitão','Major','Tenente-Coronel','Coronel',
                            'Brigadeiro','Major-Brigadeiro','Tenente-Brigadeiro'
                        ],
                        MB: [
                            'Marinheiro','Cabo','3º Sargento','2º Sargento','1º Sargento','Suboficial',
                            'Guarda-Marinha','2º Tenente','1º Tenente','Capitão-Tenente',
                            'Capitão de Corveta','Capitão de Fragata','Capitão de Mar e Guerra',
                            'Contra-Almirante','Vice-Almirante','Almirante'
                        ],
                        PM: [
                            'Soldado','Cabo','3º Sargento','2º Sargento','1º Sargento','Subtenente',
                            'Aspirante','2º Tenente','1º Tenente','Capitão','Major','Tenente-Coronel','Coronel'
                        ],
                        CBM: [
                            'Soldado','Cabo','3º Sargento','2º Sargento','1º Sargento','Subtenente',
                            'Aspirante','2º Tenente','1º Tenente','Capitão','Major','Tenente-Coronel','Coronel'
                        ]
                    };

                    function preencherPostos() {
                        if (!datalist) return;
                        datalist.innerHTML = '';
                        const f = forca ? forca.value : '';
                        const lista = POSTOS[f] || [];
                        lista.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p;
                            datalist.appendChild(opt);
                        });
                    }

                    function aplicarRegras() {
                        const cat = categoria ? categoria.value : '';
                        function toggle(el, show) { 
                            if (!el) return; 
                            const col = el.closest('.col-md-2, .col-md-4, .col-md-6');
                            if (col && !col.classList.contains('field-important')) {
                                col.classList.toggle('d-none', !show);
                            }
                        }
                        
                        // Reset
                        toggle(forca, true); 
                        toggle(uf, true); 
                        toggle(posto, true); 
                        toggle(orgao, true);
                        
                        // FFAA
                        if (cat === 'MILITAR_FFAA') {
                            toggle(forca, true); 
                            toggle(uf, false); 
                            toggle(posto, true); 
                            toggle(orgao, false);
                        } else if (cat === 'MILITAR_COIRMA') {
                            toggle(forca, true); 
                            toggle(uf, true); 
                            toggle(posto, true); 
                            toggle(orgao, false);
                        } else if (cat === 'CIVIL') {
                            toggle(forca, false); 
                            toggle(uf, false); 
                            toggle(posto, false); 
                            toggle(orgao, true);
                        } else {
                            toggle(forca, false); 
                            toggle(uf, false); 
                            toggle(posto, false); 
                            toggle(orgao, false);
                        }
                        
                        // Se selecionar Polícia Civil ou Outra Instituição, ocultar Posto/Graduação
                        const f = forca ? forca.value : '';
                        if (f === 'PC' || f === 'OUTRA') {
                            toggle(posto, false);
                        }
                        preencherPostos();
                    }
                    
                    aplicarRegras();
                    if (categoria) categoria.addEventListener('change', aplicarRegras);
                    if (forca) forca.addEventListener('change', function(){ preencherPostos(); aplicarRegras(); });
                    
                    // Garantir que o campo CPF seja sempre editável
                    if (cpfField) {
                        cpfField.addEventListener('focus', function() {
                            this.removeAttribute('readonly');
                            this.removeAttribute('disabled');
                        });
                        
                        cpfField.addEventListener('input', function() {
                            this.removeAttribute('readonly');
                            this.removeAttribute('disabled');
                        });
                    }
                    
                    // Melhorar o campo de função para aceitar números e texto
                    const funcaoField = document.getElementById('id_funcao_externa');
                    if (funcaoField) {
                        // Garantir que aceite qualquer caractere (texto e números)
                        funcaoField.addEventListener('input', function() {
                            // Permitir qualquer entrada (texto, números, símbolos)
                            this.value = this.value;
                        });
                        
                        // Adicionar dica visual quando o campo recebe foco
                        funcaoField.addEventListener('focus', function() {
                            const helpText = this.parentNode.querySelector('.form-text');
                            if (helpText) {
                                helpText.style.color = '#0d6efd';
                                helpText.style.fontWeight = '500';
                            }
                        });
                        
                        // Restaurar estilo quando perde o foco
                        funcaoField.addEventListener('blur', function() {
                            const helpText = this.parentNode.querySelector('.form-text');
                            if (helpText) {
                                helpText.style.color = '#6c757d';
                                helpText.style.fontWeight = '400';
                            }
                        });
                    }
                });
                </script>
                
                <button class="btn btn-success" type="submit">Salvar</button>
                <a href="{% url 'militares:concessoes_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}


