{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard da Turma - {{ turma.identificacao }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Dashboard da Turma
                    </h1>
                    <p class="text-muted mb-0">{{ turma.identificacao }} - {{ turma.curso.nome }}</p>
                </div>
                <div>
                    <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="btn btn-secondary">
                        <i class="fas fa-list me-2"></i>
                        Ver Detalhes
                    </a>
                    <a href="{% url 'militares:ensino_turmas_listar' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Estatísticas Principais -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total de Alunos</h6>
                            <h3 class="mb-0 text-primary">{{ total_alunos }}</h3>
                            <small class="text-muted">{{ total_alunos_ativos }} ativo(s)</small>
                        </div>
                        <div class="text-primary" style="font-size: 3rem;">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Aulas Realizadas</h6>
                            <h3 class="mb-0 text-success">{{ aulas_realizadas }}</h3>
                            <small class="text-muted">de {{ total_aulas }} total</small>
                        </div>
                        <div class="text-success" style="font-size: 3rem;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Frequência Geral</h6>
                            <h3 class="mb-0 text-info">{{ percentual_frequencia_geral }}%</h3>
                            <small class="text-muted">{{ frequencias_presentes }}/{{ total_frequencias }} presentes</small>
                        </div>
                        <div class="text-info" style="font-size: 3rem;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Média Geral</h6>
                            <h3 class="mb-0 text-warning">
                                {% if media_geral_turma %}
                                    {{ media_geral_turma|floatformat:3 }}
                                {% else %}
                                    -
                                {% endif %}
                            </h3>
                            <small class="text-muted">{{ total_avaliacoes }} avaliações</small>
                        </div>
                        <div class="text-warning" style="font-size: 3rem;">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progresso do Curso -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Progresso do Curso
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Período do Curso</h6>
                            <p class="mb-2">
                                <strong>Início:</strong> {{ turma.data_inicio|date:"d/m/Y" }}<br>
                                <strong>Término:</strong> {{ turma.data_fim|date:"d/m/Y" }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Progresso</h6>
                            <div class="progress" style="height: 30px; background-color: #28a745; display: flex; flex-direction: row-reverse;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-light" 
                                     role="progressbar" 
                                     style="width: {{ percentual_conclusao }}%; color: #000; font-weight: bold;"
                                     aria-valuenow="{{ percentual_conclusao }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ percentual_conclusao|floatformat:1 }}%
                                </div>
                            </div>
                            <small class="text-muted">
                                {% if percentual_conclusao < 100 %}
                                    Faltam {{ percentual_restante|floatformat:1 }}% para conclusão
                                {% else %}
                                    Curso concluído
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações da Turma -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações da Turma
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Curso:</dt>
                        <dd class="col-sm-7">
                            <a href="{% url 'militares:ensino_curso_detalhes' pk=turma.curso.pk %}" class="text-decoration-none">
                                {{ turma.curso.nome }}
                            </a>
                        </dd>
                        
                        <dt class="col-sm-5">Supervisor do Curso:</dt>
                        <dd class="col-sm-7">
                            {% if turma.supervisor_curso %}
                                {{ turma.supervisor_curso.get_posto_graduacao_display }} {{ turma.supervisor_curso.nome_completo }}
                            {% else %}
                                <span class="text-muted">Não definido</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Coordenador do Curso:</dt>
                        <dd class="col-sm-7">
                            {% if turma.coordenador_curso %}
                                {{ turma.coordenador_curso.get_posto_graduacao_display }} {{ turma.coordenador_curso.nome_completo }}
                            {% else %}
                                <span class="text-muted">Não definido</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Supervisor de Turma:</dt>
                        <dd class="col-sm-7">
                            {% if turma.supervisor_turma %}
                                {{ turma.supervisor_turma.get_posto_graduacao_display }} {{ turma.supervisor_turma.nome_completo }}
                            {% else %}
                                <span class="text-muted">Não definido</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Coordenador de Turma:</dt>
                        <dd class="col-sm-7">
                            {% if turma.coordenador_turma %}
                                {{ turma.coordenador_turma.get_posto_graduacao_display }} {{ turma.coordenador_turma.nome_completo }}
                            {% else %}
                                <span class="text-muted">Não definido</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Status:</dt>
                        <dd class="col-sm-7">
                            {% if turma.ativa %}
                                <span class="badge bg-success">Ativa</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativa</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Disciplinas:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-primary">{{ total_disciplinas }}</span>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Estatísticas Gerais
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Total de Aulas:</dt>
                        <dd class="col-sm-6"><strong>{{ total_aulas }}</strong></dd>
                        
                        <dt class="col-sm-6">Aulas Previstas:</dt>
                        <dd class="col-sm-6"><strong>{{ aulas_previstas }}</strong></dd>
                        
                        <dt class="col-sm-6">Avaliações:</dt>
                        <dd class="col-sm-6"><strong>{{ total_avaliacoes }}</strong></dd>
                        
                        <dt class="col-sm-6">Ocorrências:</dt>
                        <dd class="col-sm-6">
                            <strong>{{ total_ocorrencias }}</strong>
                            {% if total_ocorrencias > 0 %}
                                <span class="badge bg-warning text-dark ms-2">Atenção</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-6">Certificados:</dt>
                        <dd class="col-sm-6"><strong>{{ total_certificados }}</strong></dd>
                        
                        <dt class="col-sm-6">Cautelas Pendentes:</dt>
                        <dd class="col-sm-6">
                            <strong>{{ cautelas_pendentes }}</strong>
                            {% if cautelas_pendentes > 0 %}
                                <span class="badge bg-danger ms-2">Pendente</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Notas por Disciplina -->
    {% if notas_por_disciplina %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>
                        Desempenho por Disciplina
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="disciplinasAccordion">
                        {% for disciplina_id, dados_disciplina in notas_por_disciplina.items %}
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="headingDisciplina{{ disciplina_id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDisciplina{{ disciplina_id }}">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <div>
                                            <strong>{{ dados_disciplina.disciplina.nome }}</strong>
                                            {% if dados_disciplina.disciplina.codigo %}
                                                <small class="text-muted ms-2">({{ dados_disciplina.disciplina.codigo }})</small>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-primary me-2">Média: {{ dados_disciplina.media_geral|floatformat:3 }}</span>
                                            <span class="badge bg-success me-2">Aprovados: {{ dados_disciplina.aprovados }}</span>
                                            <span class="badge bg-warning text-dark me-2">Recuperação: {{ dados_disciplina.recuperacao }}</span>
                                            <span class="badge bg-danger">Reprovados: {{ dados_disciplina.reprovados }}</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapseDisciplina{{ disciplina_id }}" class="accordion-collapse collapse" data-bs-parent="#disciplinasAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Matrícula</th>
                                                    <th>Aluno</th>
                                                    <th class="text-center">1ª</th>
                                                    <th class="text-center">2ª</th>
                                                    <th class="text-center">3ª</th>
                                                    <th class="text-center">4ª</th>
                                                    <th class="text-center"><strong>Média</strong></th>
                                                    <th class="text-center"><strong>Status</strong></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for aluno_id, dados_aluno in dados_disciplina.alunos.items %}
                                                <tr>
                                                    <td><strong>{{ dados_aluno.aluno.matricula|default:"-" }}</strong></td>
                                                    <td>
                                                        {% if dados_aluno.aluno.militar %}
                                                            {{ dados_aluno.aluno.militar.get_posto_graduacao_display }} {{ dados_aluno.aluno.militar.nome_completo }}
                                                        {% elif dados_aluno.aluno.pessoa_externa %}
                                                            {{ dados_aluno.aluno.pessoa_externa.nome_completo }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.0 is not None %}
                                                            {{ dados_aluno.notas.0|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.1 is not None %}
                                                            {{ dados_aluno.notas.1|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.2 is not None %}
                                                            {{ dados_aluno.notas.2|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.3 is not None %}
                                                            {{ dados_aluno.notas.3|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.media_final is not None %}
                                                            <strong class="{% if dados_aluno.status == 'APROVADO' %}text-success{% elif dados_aluno.status == 'RECUPERACAO' %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ dados_aluno.media_final|floatformat:2 }}
                                                            </strong>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.status %}
                                                            {% if dados_aluno.status == 'APROVADO' %}
                                                                <span class="badge bg-success">Aprovado</span>
                                                            {% elif dados_aluno.status == 'RECUPERACAO' %}
                                                                <span class="badge bg-warning text-dark">Recuperação</span>
                                                            {% elif dados_aluno.status == 'REPROVADO' %}
                                                                <span class="badge bg-danger">Reprovado</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Últimas Aulas -->
    {% if aulas %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Últimas Aulas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Data</th>
                                    <th>Disciplina</th>
                                    <th>Instrutor</th>
                                    <th>Horário</th>
                                    <th>Local</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aula in aulas|slice:":10" %}
                                <tr>
                                    <td>{{ aula.data_aula|date:"d/m/Y" }}</td>
                                    <td>{{ aula.disciplina.nome }}</td>
                                    <td>
                                        {% if aula.instrutor %}
                                            {{ aula.instrutor.get_posto_graduacao_display }} {{ aula.instrutor.nome_completo }}
                                        {% else %}
                                            <span class="text-muted">Não definido</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aula.hora_inicio and aula.hora_fim %}
                                            {{ aula.hora_inicio|time:"H:i" }} - {{ aula.hora_fim|time:"H:i" }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ aula.local|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ocorrências Disciplinares -->
    {% if ocorrencias %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Ocorrências Disciplinares
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Data</th>
                                    <th>Aluno</th>
                                    <th>Tipo</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ocorrencia in ocorrencias|slice:":10" %}
                                <tr>
                                    <td>{{ ocorrencia.data_ocorrencia|date:"d/m/Y" }}</td>
                                    <td>
                                        {% if ocorrencia.aluno.militar %}
                                            {{ ocorrencia.aluno.militar.get_posto_graduacao_display }} {{ ocorrencia.aluno.militar.nome_completo }}
                                        {% elif ocorrencia.aluno.pessoa_externa %}
                                            {{ ocorrencia.aluno.pessoa_externa.nome_completo }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark">{{ ocorrencia.get_tipo_ocorrencia_display }}</span>
                                    </td>
                                    <td>{{ ocorrencia.descricao|truncatewords:20 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.accordion-button {
    font-weight: 500;
}

.table th {
    font-weight: 600;
}
</style>
{% endblock %}

