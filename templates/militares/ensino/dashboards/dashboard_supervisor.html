{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Supervisor{% endblock %}

{% block content %}
<style>
    #mainSidebar { display: none !important; }
    .sidebar-toggle-btn, .sidebar-overlay { display: none !important; }
    main { width: 100% !important; max-width: 100% !important; margin-left: 0 !important; padding-left: 0 !important; padding-right: 0 !important; }
    .container-fluid { padding-left: 12px; padding-right: 12px; }
</style>
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="fas fa-user-tie me-2"></i>
                Dashboard do Supervisor
            </h1>
            <p class="text-muted">Visão geral das turmas supervisionadas</p>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-3"></i>
                    <h3>{{ total_turmas }}</h3>
                    <p class="text-muted mb-0">Total de Turmas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                    <h3>{{ turmas_ativas }}</h3>
                    <p class="text-muted mb-0">Turmas Ativas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-user-graduate fa-2x text-info mb-3"></i>
                    <h3>{{ total_alunos }}</h3>
                    <p class="text-muted mb-0">Total de Alunos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-warning mb-3"></i>
                    <h3>{{ percentual_frequencia }}%</h3>
                    <p class="text-muted mb-0">Frequência Média</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-book fa-2x text-primary mb-3"></i>
                    <h3>{{ total_aulas }}</h3>
                    <p class="text-muted mb-0">Total de Aulas</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-calendar-check fa-2x text-success mb-3"></i>
                    <h3>{{ aulas_este_mes }}</h3>
                    <p class="text-muted mb-0">Aulas Este Mês</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-clipboard-list fa-2x text-info mb-3"></i>
                    <h3>{{ quadros_trabalho|length }}</h3>
                    <p class="text-muted mb-0">Quadros de Trabalho</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pedidos de Revisão para Despacho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Pedidos de Revisão (Despacho)</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-2 mb-3">
                        <div class="col-md-4">
                            <select name="curso_id" class="form-select" onchange="this.form.submit()">
                                <option value="">Todos os cursos</option>
                                {% for c in cursos_opcoes %}
                                    <option value="{{ c.curso_id }}" {% if curso_id == c.curso_id|stringformat:'s' %}selected{% endif %}>{{ c.curso__nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="disciplina_id" class="form-select" onchange="this.form.submit()">
                                <option value="">Todas as disciplinas</option>
                                {% for d in disciplinas_opcoes %}
                                    <option value="{{ d.disciplina_id }}" {% if disciplina_id == d.disciplina_id|stringformat:'s' %}selected{% endif %}>{{ d.disciplina__nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-inline-block">
                                <span class="badge bg-secondary me-1">Solicitadas: {{ revisoes_contagem.ALUNO_SOLICITOU }}</span>
                                <span class="badge bg-info me-1">Despachadas: {{ revisoes_contagem.DESPACHADA_INSTRUTOR }}</span>
                                <span class="badge bg-warning text-dark me-1">Em análise: {{ revisoes_contagem.PARECER_INSTRUTOR }}</span>
                                <span class="badge bg-primary me-1">Recurso: {{ revisoes_contagem.RECURSO_DIRETORIA }}</span>
                                <span class="badge bg-dark me-1">Comissão: {{ revisoes_contagem.COMISSAO_NOMEADA }}</span>
                                <span class="badge bg-success">Finalizadas: {{ revisoes_contagem.PARECER_FINAL }}</span>
                            </div>
                        </div>
                    </form>
                    <div class="mt-2">
                        {% if revisoes_alertas.instrutor_vencendo_24h or revisoes_alertas.comissao_vencendo_24h %}
                        <div class="alert alert-warning py-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Prazos próximos de expirar:
                            {% if revisoes_alertas.instrutor_vencendo_24h %}
                                <span class="badge bg-danger ms-2">Instrutor: {{ revisoes_alertas.instrutor_vencendo_24h }}</span>
                            {% endif %}
                            {% if revisoes_alertas.comissao_vencendo_24h %}
                                <span class="badge bg-danger ms-2">Comissão: {{ revisoes_alertas.comissao_vencendo_24h }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% if pedidos_revisao_para_despacho %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Disciplina</th>
                                    <th>Avaliação</th>
                                    <th>Etapa</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in pedidos_revisao_para_despacho %}
                                <tr>
                                    <td>
                                        {% if p.aluno.militar %}
                                            {{ p.aluno.militar.get_posto_graduacao_display }} {{ p.aluno.militar.nome_completo }}
                                        {% elif p.aluno.pessoa_externa %}
                                            {{ p.aluno.pessoa_externa.get_nome_completo }}
                                        {% else %}Aluno{% endif %}
                                    </td>
                                    <td>{{ p.nota_avaliacao.avaliacao.disciplina.nome }}</td>
                                    <td>{{ p.nota_avaliacao.avaliacao.nome }}</td>
                                    <td>{{ p.get_etapa_display }}</td>
                                    <td>
                                        <a href="{% url 'militares:ensino_despachar_revisao_instrutor' pedido_id=p.id %}?next={{ request.get_full_path }}" class="btn btn-sm btn-primary js-open-despacho-modal">Despachar ao Instrutor</a>
                                        <a href="{% url 'militares:ensino_nomear_comissao_revisao' pedido_id=p.id %}?next={{ request.get_full_path }}" class="btn btn-sm btn-outline-secondary ms-1">Nomear Comissão</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Nenhum pedido de revisão aguardando despacho.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Turmas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Turmas Supervisionadas</h5>
                </div>
                <div class="card-body">
                    {% if turmas %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Curso</th>
                                    <th>Turma</th>
                                    <th>Data Início</th>
                                    <th>Data Fim</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for turma in turmas %}
                                <tr>
                                    <td>{{ turma.curso.nome }}</td>
                                    <td>{{ turma.identificacao }}</td>
                                    <td>{{ turma.data_inicio|date:"d/m/Y" }}</td>
                                    <td>{{ turma.data_fim|date:"d/m/Y" }}</td>
                                    <td>
                                        {% if turma.ativa %}
                                        <span class="badge bg-success">Ativa</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inativa</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-eye"></i> Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhuma turma supervisionada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Próximas Aulas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Próximas Aulas (7 dias)</h5>
                </div>
                <div class="card-body">
                    {% if proximas_aulas %}
                    <div class="list-group">
                        {% for aula in proximas_aulas %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ aula.disciplina.nome }}</h6>
                                    <p class="mb-1"><small>{{ aula.turma.identificacao }} - {{ aula.data_aula|date:"d/m/Y" }} - {{ aula.hora_inicio|time:"H:i" }}</small></p>
                                </div>
                                <span class="badge bg-primary">{{ aula.get_tipo_aula_display }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhuma aula agendada para os próximos dias.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quadros de Trabalho -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Quadros de Trabalho Semanal</h5>
                </div>
                <div class="card-body">
                    {% if quadros_trabalho %}
                    <div class="list-group">
                        {% for quadro in quadros_trabalho %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Quadro Nº {{ quadro.numero_quadro }}</h6>
                                    <p class="mb-1"><small>{{ quadro.turma.identificacao }} - {{ quadro.data_inicio_semana|date:"d/m/Y" }} a {{ quadro.data_fim_semana|date:"d/m/Y" }}</small></p>
                                </div>
                                <a href="{% url 'militares:ensino_quadro_trabalho_semanal_visualizar' pk=quadro.pk %}?next={{ request.get_full_path }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhum quadro de trabalho semanal disponível.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  function initEditors(root){
    try {
      if (typeof ClassicEditor === 'undefined') return;
      window._despachoEditors = window._despachoEditors || [];
      var areas = root.querySelectorAll('textarea');
      areas.forEach(function(el){
        if (el.dataset.ckInitialized === '1') return;
        ClassicEditor.create(el).then(function(editor){
          el.dataset.ckInitialized = '1';
          window._despachoEditors.push({el: el, editor: editor});
        }).catch(function(err){ console.error('CKEditor init error:', err); });
      });
      var forms = root.querySelectorAll('form');
      forms.forEach(function(f){
        if (f.dataset.ckHooked === '1') return;
        f.addEventListener('submit', function(){
          (window._despachoEditors || []).forEach(function(pair){ try { pair.el.value = pair.editor.getData(); } catch(e){} });
        });
        f.dataset.ckHooked = '1';
      });
    } catch(e){ console.error(e); }
  }
  function openDespachoModal(url){
    var modalEl = document.getElementById('despachoInstrutorModal');
    var contentEl = document.getElementById('modalDespachoContent');
    if (!modalEl || !contentEl) return window.location.href = url;
    contentEl.innerHTML = '<div class="py-5 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3 text-muted">Carregando formulário...</p></div>';
    try {
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        var instance = bootstrap.Modal.getOrCreateInstance(modalEl);
        instance.show();
      }
    } catch(e) {}
    fetch(url, {credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'}})
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(function(html){ contentEl.innerHTML = html; initEditors(contentEl); attachAjaxSubmit(); })
      .catch(function(err){ contentEl.innerHTML = '<div class="alert alert-danger m-3">Erro ao carregar formulário: '+err.message+'</div>'; });
  }
  function attachAjaxSubmit(){
    var contentEl = document.getElementById('modalDespachoContent');
    var form = contentEl ? contentEl.querySelector('form') : null;
    if (!form) return;
    if (form.dataset.ajaxBound === '1') return;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      (window._despachoEditors || []).forEach(function(pair){ try { pair.el.value = pair.editor.getData(); } catch(e){} });
      var fd = new FormData(form);
      var action = form.getAttribute('action') || window.location.href;
      fetch(action, {method:'POST', body: fd, credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(function(r){
          var ct = r.headers.get('content-type')||'';
          if (ct.indexOf('application/json')>=0) return r.json();
          return r.text().then(function(t){ return {html:t}; });
        })
        .then(function(data){
          if (data && data.success){
            var modalEl = document.getElementById('despachoInstrutorModal');
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal){
              var instance = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);
              instance.hide();
            }
            window.location.href = data.redirect || window.location.href;
          } else if (data && data.html){
            var contentEl = document.getElementById('modalDespachoContent');
            contentEl.innerHTML = data.html;
            initEditors(contentEl);
            attachAjaxSubmit();
          }
        })
        .catch(function(err){
          var contentEl = document.getElementById('modalDespachoContent');
          contentEl.innerHTML = '<div class="alert alert-danger m-3">Erro ao enviar: '+err.message+'</div>';
        });
    });
    form.dataset.ajaxBound = '1';
  }
  document.addEventListener('click', function(e){
    var a = e.target.closest('a.js-open-despacho-modal');
    if (a){
      e.preventDefault();
      var url = a.getAttribute('href');
      openDespachoModal(url);
    }
  });
})();
</script>

<!-- Modal para Despacho ao Instrutor -->
<div class="modal fade" id="despachoInstrutorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-share-square me-2"></i>Despachar ao Instrutor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalDespachoContent"></div>
    </div>
  </div>
</div>
{% endblock %}

