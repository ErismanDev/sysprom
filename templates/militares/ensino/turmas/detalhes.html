{% extends 'base.html' %}
{% load static %}
{% load militares_extras %}

{% block title %}Detalhes da Turma - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Detalhes da Turma
                </h1>
                {% if is_apk or request.GET.apk %}
                <div class="d-grid gap-2 ms-3" style="max-width: 300px;">
                    <a href="{% url 'militares:ensino_turma_dashboard' pk=turma.pk %}?apk=1" class="btn btn-primary">
                        <i class="fas fa-chart-line me-2"></i>
                        Dashboard
                    </a>
                    <a href="{% url 'militares:ensino_turmas_listar' %}?apk=1" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% else %}
                <div>
                    <a href="{% url 'militares:ensino_turma_dashboard' pk=turma.pk %}" class="btn btn-primary">
                        <i class="fas fa-chart-line me-2"></i>
                        Dashboard
                    </a>
                    <a href="{% url 'militares:ensino_turmas_listar' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Informações Básicas -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Identificação:</dt>
                                <dd class="col-sm-8"><strong>{{ turma.identificacao }}</strong></dd>
                                
                                <dt class="col-sm-4">Curso:</dt>
                                <dd class="col-sm-8">
                                    <a href="{% url 'militares:ensino_curso_detalhes' pk=turma.curso.pk %}" class="text-decoration-none">
                                        {{ turma.curso.nome }}
                                    </a>
                                </dd>
                                
                                <dt class="col-sm-4">Data de Início:</dt>
                                <dd class="col-sm-8">{{ turma.data_inicio|date:"d/m/Y"|default:"Não informado" }}</dd>
                                
                                <dt class="col-sm-4">Data de Término:</dt>
                                <dd class="col-sm-8">{{ turma.data_fim|date:"d/m/Y"|default:"Não informado" }}</dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    {% if turma.ativa %}
                                        <span class="badge bg-success">Ativa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inativa</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Supervisor do Curso:</dt>
                                <dd class="col-sm-8">
                                    {% if turma.supervisor_curso %}
                                        {{ turma.supervisor_curso.get_posto_graduacao_display }} {{ turma.supervisor_curso.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Coordenador do Curso:</dt>
                                <dd class="col-sm-8">
                                    {% if turma.coordenador_curso %}
                                        {{ turma.coordenador_curso.get_posto_graduacao_display }} {{ turma.coordenador_curso.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Supervisor de Turma:</dt>
                                <dd class="col-sm-8">
                                    {% if turma.supervisor_turma %}
                                        {{ turma.supervisor_turma.get_posto_graduacao_display }} {{ turma.supervisor_turma.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Coordenador de Turma:</dt>
                                <dd class="col-sm-8">
                                    {% if turma.coordenador_turma %}
                                        {{ turma.coordenador_turma.get_posto_graduacao_display }} {{ turma.coordenador_turma.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Data de Criação:</dt>
                                <dd class="col-sm-8">{{ turma.data_criacao|date:"d/m/Y H:i" }}</dd>
                                
                                <dt class="col-sm-4">Última Atualização:</dt>
                                <dd class="col-sm-8">{{ turma.data_atualizacao|date:"d/m/Y H:i" }}</dd>
                            </dl>
                        </div>
                    </div>
                    
                    {% if turma.observacoes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Observações:</h6>
                            <p>{{ turma.observacoes|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Acordeão de Seções -->
    <div class="row">
        <div class="col-12">
            <div class="accordion mb-4" id="turmaAccordion">
                
    <!-- Disciplinas -->
    {% if turma.disciplinas.all %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingDisciplinas">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDisciplinas" aria-expanded="false" aria-controls="collapseDisciplinas">
                            <i class="fas fa-list-ul me-2"></i>
                            Disciplinas da Turma
                            <span class="badge bg-light text-dark ms-2">{{ turma.disciplinas.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseDisciplinas" class="accordion-collapse collapse" aria-labelledby="headingDisciplinas" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Disciplina</th>
                                    <th>Instrutor</th>
                                    <th>Monitores</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for disciplina in turma.disciplinas.all %}
                                <tr>
                                    <td><strong>{{ disciplina.codigo }}</strong></td>
                                    <td>
                                        <a href="{% url 'militares:ensino_disciplina_detalhes' pk=disciplina.pk %}" class="text-decoration-none">
                                            {{ disciplina.nome }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if disciplina.instrutor_responsavel_militar %}
                                            {{ disciplina.instrutor_responsavel_militar.get_posto_graduacao_display }} {{ disciplina.instrutor_responsavel_militar.nome_completo }}
                                        {% elif disciplina.instrutor_responsavel_externo %}
                                            {{ disciplina.instrutor_responsavel_externo.get_nome_completo }}
                                        {% else %}
                                            <span class="text-muted">Não definido</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if disciplina.monitores_militares.all or disciplina.monitores_externos.all %}
                                            {% if disciplina.monitores_militares.all %}
                                                {% for monitor in disciplina.monitores_militares.all %}
                                                    {{ monitor.get_posto_graduacao_display }} {{ monitor.nome_completo }}{% if not forloop.last or disciplina.monitores_externos.all %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            {% if disciplina.monitores_externos.all %}
                                                {% for monitor in disciplina.monitores_externos.all %}
                                                    {{ monitor.get_nome_completo }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Nenhum</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'militares:ensino_caderneta_frequencia_disciplina' turma_id=turma.pk disciplina_id=disciplina.pk %}" 
                                               class="btn btn-sm btn-info" 
                                               title="Caderneta de Frequência">
                                                <i class="fas fa-clipboard-list"></i>
                                            </a>
                                            {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                            <button type="button" class="btn btn-sm btn-warning btn-trocar-instrutor-monitor" 
                                                    data-disciplina-id="{{ disciplina.pk }}" 
                                                    data-turma-id="{{ turma.pk }}"
                                                    data-disciplina-nome="{{ disciplina.nome }}"
                                                    title="Trocar Instrutor/Monitor">
                                                <i class="fas fa-exchange-alt"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Monitores da Turma -->
    {% if turma.monitores_militares.all or turma.monitores_externos.all %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingMonitores">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMonitores" aria-expanded="false" aria-controls="collapseMonitores">
                            <i class="fas fa-user-tie me-2"></i>
                            Monitores da Turma
                        </button>
                    </h2>
                    <div id="collapseMonitores" class="accordion-collapse collapse" aria-labelledby="headingMonitores" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    {% if turma.monitores_militares.all %}
                    <div class="mb-3">
                        <h6>Monitores Militares:</h6>
                        <ul class="list-unstyled">
                            {% for monitor in turma.monitores_militares.all %}
                            <li>
                                {{ monitor.get_posto_graduacao_display }} {{ monitor.nome_completo }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if turma.monitores_externos.all %}
                    <div>
                        <h6>Monitores Externos:</h6>
                        <ul class="list-unstyled">
                            {% for monitor in turma.monitores_externos.all %}
                            <li>
                                {{ monitor.get_nome_completo }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Alunos -->
    {% if alunos %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingAlunos">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAlunos" aria-expanded="false" aria-controls="collapseAlunos">
                            <i class="fas fa-user-graduate me-2"></i>
                            Alunos
                            <span class="badge bg-light text-dark ms-2">{{ total_alunos }}</span>
                            <small class="ms-2">({{ alunos_ativos }} ativo(s))</small>
                        </button>
                    </h2>
                    <div id="collapseAlunos" class="accordion-collapse collapse" aria-labelledby="headingAlunos" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Matrícula</th>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Situação</th>
                                    <th>Data Matrícula</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aluno in alunos %}
                                <tr>
                                    <td class="text-center">{{ forloop.counter }}</td>
                                    <td><strong>{{ aluno.matricula }}</strong></td>
                                    <td>
                                        {% if aluno.militar %}
                                            <strong>{{ aluno.militar.get_posto_graduacao_display }} {{ aluno.militar.nome_completo }}</strong>
                                        {% elif aluno.pessoa_externa %}
                                            <strong>{{ aluno.pessoa_externa.nome_completo }}</strong>
                                        {% else %}
                                            <strong>N/A</strong>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aluno.militar %}
                                            {{ aluno.militar.cpf|default:"-" }}
                                        {% elif aluno.pessoa_externa %}
                                            {{ aluno.pessoa_externa.cpf|default:"-" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if aluno.situacao == 'ATIVO' %}bg-success{% elif aluno.situacao == 'CONCLUIDO' %}bg-primary{% elif aluno.situacao == 'DESLIGADO' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ aluno.get_situacao_display }}
                                        </span>
                                    </td>
                                    <td>{{ aluno.data_matricula|date:"d/m/Y" }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'militares:ensino_aluno_detalhes' pk=aluno.pk %}" class="btn btn-sm btn-info" title="Ver detalhes">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if aluno.situacao == 'ATIVO' %}
                                                {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                                <button type="button" class="btn btn-sm btn-danger btn-desligar-aluno" 
                                                        data-aluno-id="{{ aluno.pk }}"
                                                        data-aluno-nome="{% if aluno.militar %}{{ aluno.militar.nome_completo }}{% elif aluno.pessoa_externa %}{{ aluno.pessoa_externa.nome_completo }}{% endif %}"
                                                        title="Desligar Aluno">
                                                    <i class="fas fa-user-times"></i>
                                                </button>
                                                {% endif %}
                                            {% elif aluno.situacao == 'DESLIGADO' %}
                                                {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                                <button type="button" class="btn btn-sm btn-success btn-reativar-aluno" 
                                                    data-aluno-id="{{ aluno.pk }}"
                                                    data-aluno-nome="{% if aluno.militar %}{{ aluno.militar.nome_completo }}{% elif aluno.pessoa_externa %}{{ aluno.pessoa_externa.nome_completo }}{% elif aluno.nome_outra_forca %}{{ aluno.nome_outra_forca }}{% elif aluno.nome_civil %}{{ aluno.nome_civil }}{% else %}Aluno {{ aluno.pk }}{% endif %}"
                                                    title="Reativar Aluno">
                                                    <i class="fas fa-user-check"></i>
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Aulas -->
    {% if aulas %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingAulas">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAulas" aria-expanded="false" aria-controls="collapseAulas">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Aulas
                            <span class="badge bg-light text-dark ms-2">{{ aulas.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseAulas" class="accordion-collapse collapse" aria-labelledby="headingAulas" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Disciplina</th>
                                    <th>Instrutor</th>
                                    <th>Horário</th>
                                    <th>Local</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aula in aulas %}
                                <tr>
                                    <td>{{ aula.data_aula|date:"d/m/Y" }}</td>
                                    <td>{{ aula.disciplina.nome }}</td>
                                    <td>
                                        {% if aula.instrutor %}
                                            {{ aula.instrutor.get_posto_graduacao_display }} {{ aula.instrutor.nome_completo }}
                                        {% else %}
                                            <span class="text-muted">Não definido</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aula.hora_inicio and aula.hora_fim %}
                                            {{ aula.hora_inicio|time:"H:i" }} - {{ aula.hora_fim|time:"H:i" }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ aula.local|default:"-" }}</td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-info" title="Ver detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Avaliações -->
    {% if avaliacoes %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingAvaliacoes">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvaliacoes" aria-expanded="false" aria-controls="collapseAvaliacoes">
                            <i class="fas fa-clipboard-check me-2"></i>
                            <span>Avaliações</span>
                            <span class="badge bg-light text-dark ms-2">{{ avaliacoes.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseAvaliacoes" class="accordion-collapse collapse" aria-labelledby="headingAvaliacoes" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Disciplina</th>
                                    <th>Tipo de Verificação</th>
                                    <th>Tipo</th>
                                    <th>Data</th>
                                    <th>Peso</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for avaliacao in avaliacoes %}
                                <tr>
                                    <td><strong>{{ avaliacao.nome|default:"-" }}</strong></td>
                                    <td>{{ avaliacao.disciplina.nome }}</td>
                                    <td>{{ avaliacao.get_tipo_verificacao_display|default:"-" }}</td>
                                    <td>{{ avaliacao.get_tipo_display }}</td>
                                    <td>{{ avaliacao.data_avaliacao|date:"d/m/Y" }}</td>
                                    <td>{{ avaliacao.peso|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Notas por Disciplina -->
    {% if notas_por_disciplina %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingNotas">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotas" aria-expanded="false" aria-controls="collapseNotas">
                            <i class="fas fa-chart-line me-2"></i>
                            Notas por Disciplina
                        </button>
                    </h2>
                    <div id="collapseNotas" class="accordion-collapse collapse" aria-labelledby="headingNotas" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="accordion" id="disciplinasAccordion">
                        {% for disciplina_id, dados_disciplina in notas_por_disciplina.items %}
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="headingDisciplina{{ disciplina_id }}">
                                <button class="accordion-button collapsed" style="background-color: #17a2b8; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDisciplina{{ disciplina_id }}" aria-expanded="false" aria-controls="collapseDisciplina{{ disciplina_id }}">
                                    <i class="fas fa-book me-2"></i>
                                    <strong>{{ dados_disciplina.disciplina.nome }}</strong>
                                    {% if dados_disciplina.disciplina.codigo %}
                                        <small class="ms-2">({{ dados_disciplina.disciplina.codigo }})</small>
                                    {% endif %}
                                    <span class="badge bg-light text-dark ms-2">
                                        Média Mínima: {{ dados_disciplina.disciplina.media_minima_aprovacao }}
                                    </span>
                                    <span class="badge bg-light text-dark ms-2">
                                        {{ dados_disciplina.alunos|length }} aluno(s)
                                    </span>
                                    {% if dados_disciplina.avaliacoes_criadas %}
                                    <span class="badge bg-info text-white ms-2" title="Avaliações já criadas para esta disciplina">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Criadas: 
                                        {% for pos in dados_disciplina.avaliacoes_criadas %}
                                            {{ pos }}ª{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </span>
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="collapseDisciplina{{ disciplina_id }}" class="accordion-collapse collapse" aria-labelledby="headingDisciplina{{ disciplina_id }}" data-bs-parent="#disciplinasAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex justify-content-end mb-3">
                                        {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                                        <a href="{% url 'militares:ensino_inserir_notas_disciplina' turma_id=turma.pk disciplina_id=dados_disciplina.disciplina.pk %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit me-2"></i>
                                            Inserir/Editar Notas
                                        </a>
                                        {% endif %}
                                    </div>
                                    <div class="table-responsive">
                                        {% with numero_avaliacoes=dados_disciplina.disciplina.calcular_numero_avaliacoes_obrigatorio %}
                                        <table class="table table-striped table-bordered">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Matrícula</th>
                                                    <th>Aluno</th>
                                                    {% if numero_avaliacoes >= 1 %}
                                                    <th class="text-center">1ª</th>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 2 %}
                                                    <th class="text-center">2ª</th>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 3 %}
                                                    <th class="text-center">3ª</th>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 4 %}
                                                    <th class="text-center">4ª</th>
                                                    {% endif %}
                                                    <th class="text-center"><strong>Média Final</strong><br><small>(Média das VCs)</small></th>
                                                    {% if dados_disciplina.tem_nota_recuperacao %}
                                                    <th class="text-center"><strong>Nota Recuperação</strong></th>
                                                    {% endif %}
                                                    <th class="text-center"><strong>Média Geral da Matéria</strong><br><small>(MGM)</small></th>
                                                    <th class="text-center"><strong>Status</strong></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for aluno_id, dados_aluno in dados_disciplina.alunos.items %}
                                                <tr>
                                                    <td><strong>{{ dados_aluno.aluno.matricula|default:"-" }}</strong></td>
                                                    <td>
                                                        {% if dados_aluno.aluno.militar %}
                                                            {{ dados_aluno.aluno.militar.get_posto_graduacao_display }} {{ dados_aluno.aluno.militar.nome_completo }}
                                                        {% elif dados_aluno.aluno.pessoa_externa %}
                                                            {{ dados_aluno.aluno.pessoa_externa.get_nome_completo }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    {% if numero_avaliacoes >= 1 %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.0 is not None %}
                                                            {{ dados_aluno.notas.0|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 2 %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.1 is not None %}
                                                            {{ dados_aluno.notas.1|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 3 %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.2 is not None %}
                                                            {{ dados_aluno.notas.2|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    {% if numero_avaliacoes >= 4 %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.notas.3 is not None %}
                                                            {{ dados_aluno.notas.3|floatformat:2 }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.media_final is not None %}
                                                            <strong class="{% if dados_aluno.foi_para_recuperacao %}text-danger{% elif dados_aluno.status == 'APROVADO_DIRETO' or dados_aluno.status == 'APROVADO_2_EPOCA' %}text-success{% else %}text-danger{% endif %}">
                                                                {{ dados_aluno.media_final|floatformat:2 }}
                                                                {% if dados_aluno.foi_para_recuperacao %}
                                                                    <br><small class="text-danger">→ Recuperação</small>
                                                                {% endif %}
                                                            </strong>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% if dados_disciplina.tem_nota_recuperacao %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.nota_recuperacao is not None %}
                                                            <strong class="text-info">
                                                                {{ dados_aluno.nota_recuperacao|floatformat:2 }}
                                                            </strong>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    <td class="text-center">
                                                        {% if dados_aluno.mgm is not None %}
                                                            <strong class="text-primary">
                                                                {{ dados_aluno.mgm|floatformat:2 }}
                                                            </strong>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if dados_aluno.status %}
                                                            {% if dados_aluno.status == 'APROVADO_DIRETO' %}
                                                                <span class="badge bg-success">Aprovado Direto</span>
                                                            {% elif dados_aluno.status == 'APROVADO_2_EPOCA' %}
                                                                <span class="badge bg-info text-white">Aprovado 2ª Época</span>
                                                            {% elif dados_aluno.status == 'RECUPERACAO' %}
                                                                <span class="badge bg-warning text-dark">Recuperação</span>
                                                            {% elif dados_aluno.status == 'REPROVADO' %}
                                                                <span class="badge bg-danger">Reprovado</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Frequência -->
    {% if frequencias_por_disciplina_turma %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingFrequencia">
                        <button class="accordion-button collapsed" style="background-color: #6c757d; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFrequencia" aria-expanded="false" aria-controls="collapseFrequencia">
                            <i class="fas fa-calendar-check me-2"></i>
                            Frequência
                        </button>
                    </h2>
                    <div id="collapseFrequencia" class="accordion-collapse collapse" aria-labelledby="headingFrequencia" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <!-- Frequência por Disciplina -->
                                {% for disciplina_id, dados_freq_disc in frequencias_por_disciplina_turma.items %}
                                    <div class="card mb-3">
                                        <div class="card-header bg-secondary text-white">
                                            <strong>{{ dados_freq_disc.disciplina.nome }}</strong>
                                            {% if dados_freq_disc.disciplina.codigo %}
                                                <small class="ms-2">({{ dados_freq_disc.disciplina.codigo }})</small>
                                            {% endif %}
                                            <span class="badge bg-light text-dark ms-2">{{ dados_freq_disc.total_aulas }} aula(s)</span>
                                            <span class="badge bg-info ms-2">{{ dados_freq_disc.total_horas_aula_programadas|floatformat:2 }}h/A (100%)</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th style="text-align: center;">Matrícula</th>
                                                            <th>Aluno</th>
                                                            <th class="text-center">Total Aulas</th>
                                                            <th class="text-center">Horas Programadas</th>
                                                            <th class="text-center">Horas Presentes</th>
                                                            <th class="text-center">Faltas Não Justif.</th>
                                                            <th class="text-center">Faltas Justif.</th>
                                                            <th class="text-center">% Faltas Não Justif.</th>
                                                            <th class="text-center">% Faltas Justif.</th>
                                                            <th class="text-center">% Total Faltas</th>
                                                            <th class="text-center">Frequência (%)</th>
                                                            <th class="text-center">Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for aluno in alunos %}
                                                            {% if aluno.situacao == 'ATIVO' and aluno.pk in dados_freq_disc.alunos %}
                                                                {% with freq_disc=dados_freq_disc.alunos|lookup:aluno.pk %}
                                                                <tr>
                                                                    <td class="text-center">
                                                                        <strong>{{ aluno.matricula|default:"-" }}</strong>
                                                                    </td>
                                                                    <td>
                                                                        {% if aluno.militar %}
                                                                            {{ aluno.militar.get_posto_graduacao_display }} {{ aluno.militar.nome_completo }}
                                                                        {% elif aluno.pessoa_externa %}
                                                                            {{ aluno.pessoa_externa.get_nome_completo }}
                                                                        {% else %}
                                                                            {{ aluno.get_nome_completo }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="text-center">{{ freq_disc.total_aulas }}</td>
                                                                    <td class="text-center">
                                                                        <strong>{{ freq_disc.total_horas_aula_programadas|floatformat:2 }}h</strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-success">{{ freq_disc.horas_presentes|floatformat:2 }}h</span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-danger">{{ freq_disc.faltas }} ({{ freq_disc.horas_perdidas_nao_justificadas|floatformat:2 }}h)</span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-warning text-dark">{{ freq_disc.faltas_justificadas }} ({{ freq_disc.horas_perdidas_justificadas|floatformat:2 }}h)</span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="{% if freq_disc.percentual_faltas_nao_justificadas > 20 %}text-danger{% else %}text-success{% endif %}">
                                                                            {{ freq_disc.percentual_faltas_nao_justificadas|floatformat:2 }}%
                                                                        </strong>
                                                                        <br><small class="text-muted">(limite: 20%)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="{% if freq_disc.percentual_faltas_justificadas > 30 %}text-danger{% else %}text-success{% endif %}">
                                                                            {{ freq_disc.percentual_faltas_justificadas|floatformat:2 }}%
                                                                        </strong>
                                                                        <br><small class="text-muted">(limite: 30%)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="{% if freq_disc.percentual_total_faltas > 40 %}text-danger{% else %}text-success{% endif %}">
                                                                            {{ freq_disc.percentual_total_faltas|floatformat:2 }}%
                                                                        </strong>
                                                                        <br><small class="text-muted">(limite: 40%)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="{% if freq_disc.aprovado_frequencia %}text-success{% else %}text-danger{% endif %}">
                                                                            {{ freq_disc.percentual|floatformat:2 }}%
                                                                        </strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        {% if freq_disc.aprovado_frequencia %}
                                                                            <span class="badge bg-success">
                                                                                <i class="fas fa-check-circle me-1"></i>Aprovado
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="fas fa-times-circle me-1"></i>Reprovado
                                                                            </span>
                                                                            {% if freq_disc.motivo_reprovacao %}
                                                                                <br><small class="text-danger">
                                                                                    {% for motivo in freq_disc.motivo_reprovacao %}
                                                                                        {{ motivo }}{% if not forloop.last %}<br>{% endif %}
                                                                                    {% endfor %}
                                                                                </small>
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Média Geral de Todas as Disciplinas -->
    {% if alunos_medias_gerais and disciplinas_ordenadas %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingMediaGeral">
                        <button class="accordion-button collapsed" style="background-color: #28a745; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMediaGeral" aria-expanded="false" aria-controls="collapseMediaGeral">
                            <i class="fas fa-chart-bar me-2"></i>
                            Média Geral de Todas as Disciplinas
                            <span class="badge bg-light text-dark ms-2">{{ alunos_medias_gerais|length }} aluno(s)</span>
                        </button>
                    </h2>
                    <div id="collapseMediaGeral" class="accordion-collapse collapse" aria-labelledby="headingMediaGeral" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th rowspan="2" style="vertical-align: middle; text-align: center;">Matrícula</th>
                                            <th rowspan="2" style="vertical-align: middle;">Aluno</th>
                                            {% for disciplina in disciplinas_ordenadas %}
                                            <th class="text-center" style="min-width: 120px;">
                                                {{ disciplina.nome }}
                                                {% if disciplina.codigo %}
                                                    <br><small class="text-muted">({{ disciplina.codigo }})</small>
                                                {% endif %}
                                            </th>
                                            {% endfor %}
                                            <th class="text-center bg-primary" style="min-width: 120px;">
                                                <strong>Média Geral</strong>
                                            </th>
                                        </tr>
                                        <tr>
                                            {% for disciplina in disciplinas_ordenadas %}
                                            <th class="text-center">
                                                <small>Média</small>
                                            </th>
                                            {% endfor %}
                                            <th class="text-center bg-primary">
                                                <small>Geral</small>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dados_aluno in alunos_medias_gerais %}
                                        <tr>
                                            <td class="text-center">
                                                <strong>{{ dados_aluno.aluno.matricula|default:"-" }}</strong>
                                            </td>
                                            <td>
                                                {% if dados_aluno.aluno.militar %}
                                                    {{ dados_aluno.aluno.militar.get_posto_graduacao_display }} {{ dados_aluno.aluno.militar.nome_completo }}
                                                {% elif dados_aluno.aluno.pessoa_externa %}
                                                    {{ dados_aluno.aluno.pessoa_externa.get_nome_completo }}
                                                {% else %}
                                                    {{ dados_aluno.aluno.get_nome_completo }}
                                                {% endif %}
                                            </td>
                                            {% for disciplina in disciplinas_ordenadas %}
                                            <td class="text-center">
                                                {% with media_disc=dados_aluno.medias_por_disciplina|lookup:disciplina.pk %}
                                                    {% if media_disc %}
                                                        {% if media_disc.media is not None %}
                                                            <strong class="{% if media_disc.status == 'APROVADO' or media_disc.status == 'APROVADO_DIRETO' or media_disc.status == 'APROVADO_2_EPOCA' %}text-success{% elif media_disc.status == 'RECUPERACAO' %}text-warning{% elif media_disc.status == 'REPROVADO' %}text-danger{% else %}text-muted{% endif %}">
                                                                {{ media_disc.media|floatformat:2 }}
                                                            </strong>
                                                            {% if media_disc.status %}
                                                            <br>
                                                            <small>
                                                                {% if media_disc.status == 'APROVADO' or media_disc.status == 'APROVADO_DIRETO' %}
                                                                    <span class="badge bg-success">Aprovado</span>
                                                                {% elif media_disc.status == 'APROVADO_2_EPOCA' %}
                                                                    <span class="badge bg-info text-white">Aprovado 2ª Época</span>
                                                                {% elif media_disc.status == 'RECUPERACAO' %}
                                                                    <span class="badge bg-warning text-dark">Recuperação</span>
                                                                {% elif media_disc.status == 'REPROVADO' %}
                                                                    <span class="badge bg-danger">Reprovado</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">{{ media_disc.status }}</span>
                                                                {% endif %}
                                                            </small>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">0.00</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                            {% endfor %}
                                            <td class="text-center bg-light">
                                                <strong class="fs-5 {% if dados_aluno.reprovado_em_alguma_disciplina %}text-danger{% endif %}">
                                                    {% if dados_aluno.reprovado_em_alguma_disciplina %}
                                                        <del>{{ dados_aluno.media_geral|floatformat:3 }}</del>
                                                    {% else %}
                                                        {{ dados_aluno.media_geral|floatformat:3 }}
                                                    {% endif %}
                                                </strong>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Recuperações -->
    {% if alunos_recuperacao %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingRecuperacoes">
                        <button class="accordion-button collapsed" style="background-color: #ffc107; color: #000;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecuperacoes" aria-expanded="false" aria-controls="collapseRecuperacoes">
                            <i class="fas fa-redo me-2"></i>
                            Recuperações
                            <span class="badge bg-light text-dark ms-2">{{ alunos_recuperacao|length }} aluno(s)</span>
                        </button>
                    </h2>
                    <div id="collapseRecuperacoes" class="accordion-collapse collapse" aria-labelledby="headingRecuperacoes" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th style="vertical-align: middle; text-align: center;">Matrícula</th>
                                            <th style="vertical-align: middle;">Aluno</th>
                                            <th style="vertical-align: middle;">Disciplina</th>
                                            <th class="text-center" style="vertical-align: middle;">Média Final</th>
                                            <th class="text-center" style="vertical-align: middle;">Média Mínima Recuperação</th>
                                            <th class="text-center" style="vertical-align: middle;">Nota Recuperação</th>
                                            <th class="text-center" style="vertical-align: middle;">Status Após Recuperação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rec in alunos_recuperacao %}
                                        <tr>
                                            <td class="text-center">
                                                <strong>{{ rec.aluno.matricula|default:"-" }}</strong>
                                            </td>
                                            <td>
                                                {% if rec.aluno.militar %}
                                                    {{ rec.aluno.militar.get_posto_graduacao_display }} {{ rec.aluno.militar.nome_completo }}
                                                {% elif rec.aluno.pessoa_externa %}
                                                    {{ rec.aluno.pessoa_externa.get_nome_completo }}
                                                {% elif rec.aluno.nome_outra_forca %}
                                                    {{ rec.aluno.nome_outra_forca }}
                                                {% elif rec.aluno.nome_civil %}
                                                    {{ rec.aluno.nome_civil }}
                                                {% else %}
                                                    Aluno #{{ rec.aluno.pk }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ rec.disciplina.nome }}</strong>
                                                {% if rec.disciplina.codigo %}
                                                    <br><small class="text-muted">({{ rec.disciplina.codigo }})</small>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if rec.media_final is not None %}
                                                    <strong class="text-warning">{{ rec.media_final|floatformat:2 }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ rec.media_minima_recuperacao|floatformat:2 }}</strong>
                                                <br><small class="text-muted">(Mín. Recuperação)</small>
                                            </td>
                                            <td class="text-center">
                                                {% if rec.nota_recuperacao is not None %}
                                                    <strong class="{% if rec.nota_recuperacao >= rec.media_minima_recuperacao %}text-success{% else %}text-danger{% endif %}">
                                                        {{ rec.nota_recuperacao|floatformat:2 }}
                                                    </strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        Mín: {{ rec.media_minima_recuperacao|floatformat:2 }}
                                                    </small>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if rec.nota_recuperacao is not None %}
                                                    {% if rec.nota_recuperacao >= rec.media_minima_recuperacao %}
                                                        <span class="badge bg-success">Aprovado</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Reprovado</span>
                                                    {% endif %}
                                                {% elif rec.status_apos_recuperacao %}
                                                    {% if rec.status_apos_recuperacao == 'APROVADO' %}
                                                        <span class="badge bg-success">Aprovado</span>
                                                    {% elif rec.status_apos_recuperacao == 'REPROVADO' %}
                                                        <span class="badge bg-danger">Reprovado</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ rec.status_apos_recuperacao }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Recuperações por Aluno -->
    {% if recuperacoes_por_aluno_lista and disciplinas_recuperacao_ordenadas %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingRecuperacoesPorAluno">
                        <button class="accordion-button collapsed" style="background-color: #ffc107; color: #000;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecuperacoesPorAluno" aria-expanded="false" aria-controls="collapseRecuperacoesPorAluno">
                            <i class="fas fa-user-graduate me-2"></i>
                            Recuperações por Aluno
                            <span class="badge bg-light text-dark ms-2">{{ recuperacoes_por_aluno_lista|length }} aluno(s)</span>
                        </button>
                    </h2>
                    <div id="collapseRecuperacoesPorAluno" class="accordion-collapse collapse" aria-labelledby="headingRecuperacoesPorAluno" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th rowspan="2" style="vertical-align: middle; text-align: center;">Matrícula</th>
                                            <th rowspan="2" style="vertical-align: middle;">Aluno</th>
                                            {% for disciplina in disciplinas_recuperacao_ordenadas %}
                                            <th class="text-center" style="min-width: 150px;">
                                                {{ disciplina.nome }}
                                                {% if disciplina.codigo %}
                                                    <br><small class="text-muted">({{ disciplina.codigo }})</small>
                                                {% endif %}
                                            </th>
                                            {% endfor %}
                                        </tr>
                                        <tr>
                                            {% for disciplina in disciplinas_recuperacao_ordenadas %}
                                            <th class="text-center">
                                                <small>Nota / Status</small>
                                            </th>
                                            {% endfor %}
                                            <th rowspan="2" class="text-center bg-warning" style="vertical-align: middle; min-width: 120px;">
                                                <strong>Média Recuperações</strong>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dados_aluno in recuperacoes_por_aluno_lista %}
                                        <tr>
                                            <td class="text-center">
                                                <strong>{{ dados_aluno.aluno.matricula|default:"-" }}</strong>
                                            </td>
                                            <td>
                                                {% if dados_aluno.aluno.militar %}
                                                    {{ dados_aluno.aluno.militar.get_posto_graduacao_display }} {{ dados_aluno.aluno.militar.nome_completo }}
                                                {% elif dados_aluno.aluno.pessoa_externa %}
                                                    {{ dados_aluno.aluno.pessoa_externa.get_nome_completo }}
                                                {% elif dados_aluno.aluno.nome_outra_forca %}
                                                    {{ dados_aluno.aluno.nome_outra_forca }}
                                                {% elif dados_aluno.aluno.nome_civil %}
                                                    {{ dados_aluno.aluno.nome_civil }}
                                                {% else %}
                                                    {{ dados_aluno.aluno.get_nome_completo }}
                                                {% endif %}
                                            </td>
                                            {% for disciplina in disciplinas_recuperacao_ordenadas %}
                                            <td class="text-center">
                                                {% with rec=dados_aluno.recuperacoes_por_disciplina|lookup:disciplina.pk %}
                                                    {% if rec %}
                                                        {% if rec.nota_recuperacao is not None %}
                                                            <strong class="{% if rec.nota_recuperacao >= rec.media_minima_recuperacao %}text-success{% else %}text-danger{% endif %}">
                                                                {{ rec.nota_recuperacao|floatformat:2 }}
                                                            </strong>
                                                            <br>
                                                            <small>
                                                                {% if rec.nota_recuperacao >= rec.media_minima_recuperacao %}
                                                                    <span class="badge bg-success">Aprovado</span>
                                                                {% else %}
                                                                    <span class="badge bg-danger">Reprovado</span>
                                                                {% endif %}
                                                            </small>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                            <br>
                                                            <small>
                                                                <span class="badge bg-warning text-dark">Em Recuperação</span>
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                            {% endfor %}
                                            <td class="text-center bg-light">
                                                {% if dados_aluno.media_recuperacoes is not None %}
                                                    <strong class="fs-5">{{ dados_aluno.media_recuperacoes|floatformat:2 }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Resultado Final da Turma -->
    {% if resultado_final_turma %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingResultadoFinal">
                        <button class="accordion-button collapsed" style="background-color: #17a2b8; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResultadoFinal" aria-expanded="false" aria-controls="collapseResultadoFinal">
                            <i class="fas fa-clipboard-check me-2"></i>
                            Resultado Final da Turma
                            <span class="badge bg-light text-dark ms-2">{{ resultado_final_turma|length }} aluno(s)</span>
                        </button>
                    </h2>
                    <div id="collapseResultadoFinal" class="accordion-collapse collapse" aria-labelledby="headingResultadoFinal" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <!-- Resumo Estatístico -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center border-success">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">
                                                <i class="fas fa-check-circle"></i> Aprovados Direto
                                            </h5>
                                            <h3 class="mb-0">{{ total_aprovados_diretos }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center border-info">
                                        <div class="card-body">
                                            <h5 class="card-title text-info">
                                                <i class="fas fa-check-double"></i> Aprovados 2ª Época
                                            </h5>
                                            <h3 class="mb-0">{{ total_aprovados_2epoca }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center border-danger">
                                        <div class="card-body">
                                            <h5 class="card-title text-danger">
                                                <i class="fas fa-times-circle"></i> Reprovados
                                            </h5>
                                            <h3 class="mb-0">{{ total_reprovados }}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead class="table-info">
                                        <tr>
                                            <th style="vertical-align: middle; text-align: center;">Matrícula</th>
                                            <th style="vertical-align: middle;">Aluno</th>
                                            <th class="text-center" style="vertical-align: middle;">Média Geral</th>
                                            <th class="text-center" style="vertical-align: middle;">Aprovadas</th>
                                            <th class="text-center" style="vertical-align: middle;">Recuperação</th>
                                            <th class="text-center" style="vertical-align: middle;">Reprovadas</th>
                                            <th class="text-center" style="vertical-align: middle;">Sem Notas</th>
                                            <th class="text-center" style="vertical-align: middle;">Status Final</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for resultado in resultado_final_turma %}
                                        <tr>
                                            <td class="text-center">
                                                <strong>{{ resultado.aluno.matricula|default:"-" }}</strong>
                                            </td>
                                            <td>
                                                {% if resultado.aluno.militar %}
                                                    {{ resultado.aluno.militar.get_posto_graduacao_display }} {{ resultado.aluno.militar.nome_completo }}
                                                {% elif resultado.aluno.pessoa_externa %}
                                                    {{ resultado.aluno.pessoa_externa.get_nome_completo }}
                                                {% elif resultado.aluno.nome_outra_forca %}
                                                    {{ resultado.aluno.nome_outra_forca }}
                                                {% elif resultado.aluno.nome_civil %}
                                                    {{ resultado.aluno.nome_civil }}
                                                {% else %}
                                                    Aluno #{{ resultado.aluno.pk }}
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.media_geral is not None %}
                                                    <strong class="text-dark">
                                                        {{ resultado.media_geral|floatformat:3 }}
                                                    </strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.disciplinas_aprovadas > 0 %}
                                                    <span class="badge bg-success">{{ resultado.disciplinas_aprovadas }}</span>
                                                {% else %}
                                                    <span class="text-muted">0</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.disciplinas_recuperacao > 0 %}
                                                    <span class="badge bg-warning text-dark">{{ resultado.disciplinas_recuperacao }}</span>
                                                {% else %}
                                                    <span class="text-muted">0</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.disciplinas_reprovadas > 0 %}
                                                    <span class="badge bg-danger">{{ resultado.disciplinas_reprovadas }}</span>
                                                {% else %}
                                                    <span class="text-muted">0</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.disciplinas_sem_notas > 0 %}
                                                    <span class="badge bg-secondary">{{ resultado.disciplinas_sem_notas }}</span>
                                                {% else %}
                                                    <span class="text-muted">0</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if resultado.status_final == 'APROVADO_DIRETO' %}
                                                    <span class="badge bg-success">Aprovado Direto</span>
                                                {% elif resultado.status_final == 'APROVADO_2_EPOCA' %}
                                                    <span class="badge bg-info text-white">Aprovado 2ª Época</span>
                                                {% elif resultado.status_final == 'REPROVADO_POR_FALTAS' %}
                                                    <span class="badge bg-danger">Reprovado por Faltas</span>
                                                    {% if resultado.motivos_reprovacao_frequencia %}
                                                        <br><small class="text-danger d-block mt-1" style="font-size: 0.75rem;">
                                                            {% for motivo in resultado.motivos_reprovacao_frequencia %}
                                                                {{ motivo }}{% if not forloop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        </small>
                                                    {% endif %}
                                                {% elif resultado.status_final == 'EM_RECUPERACAO' %}
                                                    <span class="badge bg-warning text-dark">Em Recuperação</span>
                                                {% elif resultado.status_final == 'REPROVADO' %}
                                                    <span class="badge bg-danger">Reprovado</span>
                                                {% elif resultado.status_final == 'SEM_NOTAS' %}
                                                    <span class="badge bg-secondary">Sem Notas</span>
                                                {% elif resultado.status_final == 'EM_ANDAMENTO' %}
                                                    <span class="badge bg-primary">Em Andamento</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ resultado.status_final }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Escalas -->
    {% if escalas %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingEscalas">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEscalas" aria-expanded="false" aria-controls="collapseEscalas">
                            <i class="fas fa-calendar-week me-2"></i>
                            Escalas de Instrução
                            <span class="badge bg-light text-dark ms-2">{{ escalas.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseEscalas" class="accordion-collapse collapse" aria-labelledby="headingEscalas" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Disciplina</th>
                                    <th>Instrutor</th>
                                    <th>Horário</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for escala in escalas %}
                                <tr>
                                    <td>{{ escala.data_escala|date:"d/m/Y" }}</td>
                                    <td>{{ escala.disciplina.nome }}</td>
                                    <td>
                                        {% if escala.instrutor %}
                                            {{ escala.instrutor.get_posto_graduacao_display }} {{ escala.instrutor.nome_completo }}
                                        {% else %}
                                            <span class="text-muted">Não definido</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if escala.hora_inicio and escala.hora_fim %}
                                            {{ escala.hora_inicio|time:"H:i" }} - {{ escala.hora_fim|time:"H:i" }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
                </div>
    {% endif %}
    
    <!-- Quadros de Trabalho Semanal -->
    {% if quadros_trabalho_semanal %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingQuadrosTrabalhoSemanal">
                        <button class="accordion-button collapsed" style="background-color: #ff9800; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuadrosTrabalhoSemanal" aria-expanded="false" aria-controls="collapseQuadrosTrabalhoSemanal">
                            <i class="fas fa-calendar-week me-2"></i>
                            Quadros de Trabalho Semanal
                            <span class="badge bg-light text-dark ms-2">{{ quadros_trabalho_semanal.count }}</span>
                        </button>
                    </h2>
                    <div id="collapseQuadrosTrabalhoSemanal" class="accordion-collapse collapse" aria-labelledby="headingQuadrosTrabalhoSemanal" data-bs-parent="#turmaAccordion">
                        <div class="accordion-body">
                            <div class="accordion" id="quadrosAccordion">
                                {% for quadro in quadros_trabalho_semanal %}
                                <div class="accordion-item mb-2">
                                    <h2 class="accordion-header d-flex align-items-center" id="headingQuadro{{ quadro.pk }}" style="background-color: #17a2b8; padding: 0;">
                                        <button class="accordion-button collapsed flex-grow-1" style="background-color: #17a2b8; color: white;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuadro{{ quadro.pk }}" aria-expanded="false" aria-controls="collapseQuadro{{ quadro.pk }}">
                                            <i class="fas fa-calendar me-2"></i>
                                            <strong>QTS {{ quadro.get_numero_completo }}</strong>
                                            <small class="ms-2">
                                                ({{ quadro.data_inicio_semana|date:"d/m/Y" }} a {{ quadro.data_fim_semana|date:"d/m/Y" }})
                                            </small>
                                            <span class="badge bg-light text-dark ms-2">
                                                {{ quadro.aulas.count }} aula(s)
                                            </span>
                                        </button>
                                        <a href="{% url 'militares:ensino_quadro_trabalho_semanal_pdf' pk=quadro.pk %}" 
                                           class="btn btn-sm btn-success me-2" 
                                           title="Gerar PDF" 
                                           target="_blank"
                                           style="z-index: 10; position: relative;">
                                            <i class="fas fa-file-pdf me-1"></i>
                                            PDF
                                        </a>
                                    </h2>
                                    <div id="collapseQuadro{{ quadro.pk }}" class="accordion-collapse collapse" aria-labelledby="headingQuadro{{ quadro.pk }}" data-bs-parent="#quadrosAccordion">
                                        <div class="accordion-body">
                                            <div class="d-flex justify-content-center">
                                                <a href="{% url 'militares:ensino_quadro_trabalho_semanal_pdf' pk=quadro.pk %}" class="btn btn-success" title="Gerar PDF" target="_blank">
                                                    <i class="fas fa-file-pdf me-2"></i>
                                                    Gerar PDF
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
    {% endif %}
                
            </div>
        </div>
    </div>
</div>

<!-- Modal Trocar Instrutor/Monitor -->
<div class="modal fade" id="trocarInstrutorMonitorModal" tabindex="-1" aria-labelledby="trocarInstrutorMonitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="trocarInstrutorMonitorModalContent">
            <!-- Conteúdo será carregado via AJAX -->
        </div>
    </div>
</div>

<!-- Modal Reativar Aluno -->
<div class="modal fade" id="reativarAlunoModal" tabindex="-1" aria-labelledby="reativarAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="reativarAlunoModalLabel">
                    <i class="fas fa-user-check me-2"></i>
                    Reativar Aluno
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="post" id="formReativarAluno" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Tem certeza que deseja reativar o aluno <strong id="aluno-nome-reativar"></strong>?</p>
                    <div class="mb-3">
                        <label for="data_reativacao" class="form-label">
                            Data de Reativação <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="data_reativacao" name="data_reativacao" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_reativacao" class="form-label">
                            Motivo/Justificativa da Reativação <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="motivo_reativacao" name="motivo_reativacao" rows="4" required placeholder="Informe o motivo da reativação do aluno..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-check me-2"></i>
                        Reativar Aluno
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Desligar Aluno -->
<div class="modal fade" id="desligarAlunoModal" tabindex="-1" aria-labelledby="desligarAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="desligarAlunoModalLabel">
                    <i class="fas fa-user-times me-2"></i>
                    Desligar Aluno
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="post" id="formDesligarAluno" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Tem certeza que deseja desligar o aluno <strong id="aluno-nome-desligar"></strong>?</p>
                    <div class="mb-3">
                        <label for="data_desligamento" class="form-label">
                            Data de Desligamento <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="data_desligamento" name="data_desligamento" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_desligamento" class="form-label">
                            Motivo do Desligamento <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="motivo_desligamento" name="motivo_desligamento" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-user-times me-2"></i>
                        Confirmar Desligamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Trocar Instrutor/Monitor
document.querySelectorAll('.btn-trocar-instrutor-monitor').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const disciplinaId = this.getAttribute('data-disciplina-id');
        const turmaId = this.getAttribute('data-turma-id');
        const disciplinaNome = this.getAttribute('data-disciplina-nome');
        
        const modal = document.getElementById('trocarInstrutorMonitorModal');
        const modalContent = document.getElementById('trocarInstrutorMonitorModalContent');
        
        modalContent.innerHTML = `
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando formulário...</p>
            </div>
        `;
        
        fetch('/militares/ensino/turmas/' + turmaId + '/disciplinas/' + disciplinaId + '/trocar-instrutor-monitor/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Erro HTTP: ' + response.status);
            }
            return response.text();
        })
        .then(function(html) {
            modalContent.innerHTML = html;
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        })
        .catch(function(error) {
            console.error('Erro ao carregar formulário:', error);
            modalContent.innerHTML = `
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Erro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">Erro ao carregar o formulário: ${error.message}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            `;
        });
    });
});

// Reativar Aluno
document.querySelectorAll('.btn-reativar-aluno').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const alunoId = this.getAttribute('data-aluno-id');
        const alunoNome = this.getAttribute('data-aluno-nome');
        
        document.getElementById('aluno-nome-reativar').textContent = alunoNome;
        document.getElementById('formReativarAluno').action = '/militares/ensino/alunos/' + alunoId + '/reativar/';
        
        // Definir data atual como padrão
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data_reativacao').value = hoje;
        
        // Limpar campo de motivo
        document.getElementById('motivo_reativacao').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('reativarAlunoModal'));
        modal.show();
    });
});

// Desligar Aluno
document.querySelectorAll('.btn-desligar-aluno').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const alunoId = this.getAttribute('data-aluno-id');
        const alunoNome = this.getAttribute('data-aluno-nome');
        
        document.getElementById('aluno-nome-desligar').textContent = alunoNome;
        document.getElementById('formDesligarAluno').action = '/militares/ensino/alunos/' + alunoId + '/desligar/';
        
        // Definir data atual como padrão
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data_desligamento').value = hoje;
        
        const modal = new bootstrap.Modal(document.getElementById('desligarAlunoModal'));
        modal.show();
    });
});

// Submissão do formulário de desligamento
document.getElementById('formDesligarAluno').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(function(response) {
        if (response.ok) {
            return response.json();
        }
        return response.json().then(function(data) {
            throw new Error(data.error || 'Erro ao desligar aluno');
        });
    })
    .then(function(data) {
        if (data.success) {
            location.reload();
        } else {
            throw new Error(data.error || 'Erro ao desligar aluno');
        }
    })
    .catch(function(error) {
        console.error('Erro:', error);
        alert('Erro ao desligar aluno: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

// Submissão do formulário de reativação
if (document.getElementById('formReativarAluno')) {
    document.getElementById('formReativarAluno').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Reativando...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(function(response) {
        if (response.ok) {
            return response.json();
        }
        return response.json().then(function(data) {
            throw new Error(data.error || 'Erro ao reativar aluno');
        });
    })
    .then(function(data) {
        if (data.success) {
            location.reload();
        } else {
            throw new Error(data.error || 'Erro ao reativar aluno');
        }
    })
    .catch(function(error) {
        console.error('Erro:', error);
        alert('Erro ao reativar aluno: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
    });
}
</script>
{% endblock %}
