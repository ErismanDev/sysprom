{% extends 'base.html' %}
{% load static %}

{% block title %}Cautela: {{ cautela.arma.numero_serie }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-shield-alt me-2 text-primary"></i>
                        Cautela de Arma
                    </h2>
                    <p class="text-muted mb-0">
                        Arma: {{ cautela.arma.numero_serie }} - {{ cautela.arma.marca }} {{ cautela.arma.modelo }}
                    </p>
                </div>
                <div>
                    {% if pode_crud_pdf %}
                    <a href="{% url 'militares:cautela_arma_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                    {% endif %}
                    {% if pode_crud_pdf %}
                    <a href="{% url 'militares:cautela_arma_pdf' cautela.pk %}" 
                       class="btn btn-danger" 
                       target="_blank"
                       title="Gerar PDF da Cautela">
                        <i class="fas fa-file-pdf me-2"></i>Gerar PDF
                    </a>
                    {% endif %}
                    {% if cautela.ativa and pode_crud_pdf %}
                        <button type="button" 
                                class="btn btn-warning btn-devolver-cautela" 
                                data-cautela-id="{{ cautela.pk }}"
                                data-bs-toggle="modal"
                                data-bs-target="#devolverCautelaModal">
                            <i class="fas fa-undo me-2"></i>Devolver Cautela
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Declaração Fixa - Sempre Visível -->
            <div class="card mb-4" style="position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-signature me-2"></i>Declaração de Responsabilidade
                    </h6>
                </div>
                <div class="card-body p-3" style="background-color: #fff3cd;">
                    <p class="mb-2 text-justify" style="font-size: 14px; line-height: 1.6;">
                        <strong>Declaro, sob minha inteira responsabilidade,</strong> que recebi a arma descrita neste documento, em perfeitas condições de conservação e funcionamento, e que a utilizarei conforme legislação vigente, normas internas e ordens superiores. <strong>Comprometo-me a:</strong>
                    </p>
                    <ul class="mb-0 ps-4" style="font-size: 14px; line-height: 1.8;">
                        <li>Zelar pela guarda, integridade e segurança da arma;</li>
                        <li>Comunicar imediatamente qualquer pane, avaria, extravio, furto ou uso indevido;</li>
                        <li>Devolver a arma no prazo e condições estabelecidos;</li>
                        <li>Responder disciplinar, civil e criminalmente por qualquer irregularidade decorrente do uso ou guarda.</li>
                    </ul>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Informações da Cautela
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <strong>Arma:</strong><br>
                                    <a href="{% url 'militares:arma_detail' cautela.arma.pk %}">
                                        {{ cautela.arma.numero_serie }}
                                    </a><br>
                                    <small class="text-muted">{{ cautela.arma.marca }} {{ cautela.arma.modelo }} - {{ cautela.arma.get_calibre_display }}</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Militar:</strong><br>
                                    {% if cautela.militar %}
                                        {{ cautela.militar.get_posto_graduacao_display }} {{ cautela.militar.nome_completo }}<br>
                                        <small class="text-muted">Mat: {{ cautela.militar.matricula }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Data de Entrega:</strong><br>
                                    {{ cautela.data_entrega|date:"d/m/Y H:i" }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Data de Devolução:</strong><br>
                                    {% if cautela.data_devolucao %}
                                        {{ cautela.data_devolucao|date:"d/m/Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Status:</strong><br>
                                    {% if cautela.ativa %}
                                        <span class="badge bg-success">Ativa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Devolvida</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Organização:</strong><br>
                                    {{ cautela.get_organizacao }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Entregue por:</strong><br>
                                    {% if cautela.entregue_por %}
                                        {{ cautela.entregue_por.get_full_name|default:cautela.entregue_por.username }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Devolvido por:</strong><br>
                                    {% if cautela.devolvido_por %}
                                        {{ cautela.devolvido_por.get_full_name|default:cautela.devolvido_por.username }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informação de Devolução -->
                    {% if not cautela.ativa and cautela.devolvido_por %}
                    <div class="alert alert-success mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Arma Devolvida</h5>
                                <p class="mb-0">
                                    A arma foi devolvida e recebida por 
                                    <strong>{{ cautela.devolvido_por.get_full_name|default:cautela.devolvido_por.username }}</strong>
                                    {% if cautela.data_devolucao %}
                                    em <strong>{{ cautela.data_devolucao|date:"d/m/Y H:i" }}</strong>.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Assinaturas Eletrônicas -->
                    {% if assinaturas %}
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-signature me-2"></i>Assinaturas Eletrônicas
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for assinatura in assinaturas %}
                                <div class="mb-3 p-3 border rounded" style="background-color: #fafafa;">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            {% if assinatura.tipo_assinatura == 'ENTREGANDO' %}
                                                <span class="badge bg-info">Recebimento da Arma</span>
                                            {% elif assinatura.tipo_assinatura == 'RECEBENDO' %}
                                                <span class="badge bg-primary">Entrega da Arma</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ assinatura.get_tipo_assinatura_display }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <img src="{% static 'assinasyspro.png' %}" alt="Logo AssinaSysPro" width="100" height="70" style="background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 4px; padding: 5px;">
                                        </div>
                                        <div class="flex-grow-1">
                                            <p class="mb-0 text-justify" style="font-size: 15px;">
                                                Documento assinado eletronicamente por <strong>{% if assinatura.militar %}{{ assinatura.militar.get_posto_graduacao_display }} {{ assinatura.militar.nome_completo }}{% else %}{{ assinatura.assinado_por.get_full_name|default:assinatura.assinado_por.username }}{% endif %}</strong>, em {{ assinatura.data_assinatura|date:"d/m/Y" }} {{ assinatura.data_assinatura|date:"H:i:s" }}, conforme Portaria GCG/ CBMEPI N 167 de 23 de novembro de 2021 e publicada no DOE PI N 253 de 26 de novembro de 2021.
                                            </p>
                                            {% if assinatura.tipo_assinatura == 'ENTREGANDO' %}
                                                <p class="mt-2 mb-0 text-success fw-bold">
                                                    <i class="fas fa-check-circle me-1"></i>Arma devolvida e recebida conforme registro acima.
                                                </p>
                                            {% endif %}
                                            {% if assinatura.observacoes %}
                                                <p class="mt-2 mb-0 text-muted small">
                                                    <strong>Observações:</strong> {{ assinatura.observacoes }}
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Material Acompanhando -->
                    {% if cautela.quantidade_carregadores or cautela.quantidade_municoes_catalogadas %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-box me-2"></i>Material Acompanhando
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% if cautela.quantidade_carregadores %}
                                <div class="col-md-6 mb-3">
                                    <strong>Quantidade de Carregadores:</strong><br>
                                    {{ cautela.quantidade_carregadores }}
                                </div>
                                {% endif %}
                                {% if cautela.numeracao_carregadores %}
                                <div class="col-md-6 mb-3">
                                    <strong>Numeração dos Carregadores:</strong><br>
                                    {{ cautela.numeracao_carregadores|linebreaks }}
                                </div>
                                {% endif %}
                                {% if cautela.quantidade_municoes_catalogadas %}
                                <div class="col-md-6 mb-3">
                                    <strong>Quantidade de Munições Catalogadas:</strong><br>
                                    {{ cautela.quantidade_municoes_catalogadas }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Observações -->
                    {% if cautela.observacoes %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-sticky-note me-2"></i>Observações
                            </h6>
                        </div>
                        <div class="card-body">
                            {{ cautela.observacoes|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Devolver Cautela -->
<div class="modal fade" id="devolverCautelaModal" tabindex="-1" aria-labelledby="devolverCautelaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="devolverCautelaModalContent">
            <!-- Conteúdo será carregado via AJAX -->
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando formulário...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const devolverCautelaModal = document.getElementById('devolverCautelaModal');
    const modalContent = document.getElementById('devolverCautelaModalContent');
    
    // Adicionar event listeners aos botões de devolução
    document.querySelectorAll('.btn-devolver-cautela').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const cautelaId = this.getAttribute('data-cautela-id');
            
            if (cautelaId && devolverCautelaModal) {
                devolverCautelaModal.setAttribute('data-cautela-id', cautelaId);
                const modal = new bootstrap.Modal(devolverCautelaModal);
                modal.show();
            }
        });
    });
    
    if (devolverCautelaModal && modalContent) {
        devolverCautelaModal.addEventListener('show.bs.modal', function(event) {
            let cautelaId = null;
            
            if (event.relatedTarget) {
                cautelaId = event.relatedTarget.getAttribute('data-cautela-id');
            }
            
            if (!cautelaId) {
                cautelaId = devolverCautelaModal.getAttribute('data-cautela-id');
            }
            
            if (!cautelaId) {
                console.error('ID da cautela não encontrado');
                return;
            }
            
            modalContent.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            `;
            
            fetch(`{% url 'militares:cautela_arma_devolver' 0 %}`.replace('0', cautelaId), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    modalContent.innerHTML = data.html;
                    
                    const form = document.getElementById('formDevolverCautela');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            
                            const formData = new FormData(form);
                            const submitButton = form.querySelector('button[type="submit"]');
                            const originalText = submitButton.innerHTML;
                            
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
                            
                            const errorDiv = document.getElementById('devolverCautelaErrors');
                            if (errorDiv) {
                                errorDiv.classList.add('d-none');
                            }
                            
                            fetch(form.action, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                },
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    modalContent.innerHTML = `
                                        <div class="modal-header bg-success text-white">
                                            <h5 class="modal-title">
                                                <i class="fas fa-check-circle me-2"></i>Sucesso!
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body text-center py-4">
                                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                            <h5>Devolução Registrada</h5>
                                            <p class="text-muted">${data.message}</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload();">
                                                <i class="fas fa-check me-2"></i>Fechar
                                            </button>
                                        </div>
                                    `;
                                    
                                    setTimeout(() => {
                                        const modal = bootstrap.Modal.getInstance(devolverCautelaModal);
                                        modal.hide();
                                        location.reload();
                                    }, 2000);
                                } else {
                                    const errorDiv = document.getElementById('devolverCautelaErrors');
                                    const errorMessage = document.getElementById('devolverCautelaErrorMessage');
                                    if (errorDiv && errorMessage) {
                                        errorMessage.textContent = data.message || 'Erro ao processar devolução.';
                                        errorDiv.classList.remove('d-none');
                                    }
                                    
                                    submitButton.disabled = false;
                                    submitButton.innerHTML = originalText;
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                const errorDiv = document.getElementById('devolverCautelaErrors');
                                const errorMessage = document.getElementById('devolverCautelaErrorMessage');
                                if (errorDiv && errorMessage) {
                                    errorMessage.textContent = 'Erro ao processar devolução. Tente novamente.';
                                    errorDiv.classList.remove('d-none');
                                }
                                
                                submitButton.disabled = false;
                                submitButton.innerHTML = originalText;
                            });
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar formulário:', error);
                modalContent.innerHTML = `
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Erro
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5>Erro ao Carregar</h5>
                        <p class="text-muted">Não foi possível carregar o formulário. Tente novamente.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                `;
            });
        });
        
        devolverCautelaModal.addEventListener('hidden.bs.modal', function() {
            modalContent.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            `;
        });
    }
});
</script>
{% endblock %}

