{% extends 'base.html' %}
{% load static %}

{% block title %}Detalhes do Curso - Módulo de Ensino{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-book me-2"></i>
                    Detalhes do Curso
                </h1>
                {% if is_apk or request.GET.apk %}
                <div class="d-grid gap-2 ms-3" style="max-width: 320px;">
                    {% if curso.tipo_curso == 'PERMANENTE' and menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                    <a href="{% url 'militares:ensino_edicao_criar' %}?curso={{ curso.pk }}&apk=1" class="btn btn-info">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Nova Edição
                    </a>
                    {% endif %}
                    {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                    <a href="{% url 'militares:ensino_curso_editar' pk=curso.pk %}?apk=1" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>
                        Editar
                    </a>
                    {% endif %}
                    <a href="{% url 'militares:ensino_cursos_listar' %}?apk=1" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% else %}
                <div class="btn-group">
                    {% if curso.tipo_curso == 'PERMANENTE' and menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                    <a href="{% url 'militares:ensino_edicao_criar' %}?curso={{ curso.pk }}" class="btn btn-info">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Nova Edição
                    </a>
                    {% endif %}
                    {% if menu_permissions.ENSINO_EDITAR or user.is_superuser %}
                    <a href="{% url 'militares:ensino_curso_editar' pk=curso.pk %}" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>
                        Editar
                    </a>
                    {% endif %}
                    <a href="{% url 'militares:ensino_cursos_listar' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Informações Básicas -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Código:</dt>
                                <dd class="col-sm-8"><strong>{{ curso.codigo|default:"Não informado" }}</strong></dd>
                                
                                <dt class="col-sm-4">Nome:</dt>
                                <dd class="col-sm-8">{{ curso.nome|default:"Não informado" }}</dd>
                                
                                <dt class="col-sm-4">Tipo de Curso:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.tipo_curso %}
                                        {{ curso.get_tipo_curso_display }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Modalidade:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.modalidade %}
                                        {{ curso.get_modalidade_display }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Público-Alvo:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.publico_alvo %}
                                        {{ curso.get_publico_alvo_display }}
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.status %}
                                        <span class="badge {% if curso.status == 'ATIVO' %}bg-success{% elif curso.status == 'INATIVO' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ curso.get_status_display }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Ativo:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.ativo %}
                                        <span class="badge bg-success">Sim</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Não</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Carga Horária:</dt>
                                <dd class="col-sm-8">
                                    {% if curso.carga_horaria %}
                                        {{ curso.carga_horaria }} horas
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">Unidade Responsável:</dt>
                                <dd class="col-sm-8">{{ curso.unidade_responsavel|default:"Não informado" }}</dd>
                                
                                <dt class="col-sm-4">Data de Criação:</dt>
                                <dd class="col-sm-8">{{ curso.data_criacao|date:"d/m/Y H:i" }}</dd>
                                
                                <dt class="col-sm-4">Última Atualização:</dt>
                                <dd class="col-sm-8">{{ curso.data_atualizacao|date:"d/m/Y H:i" }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Descrição e Objetivos -->
    {% if curso.finalidade or curso.descricao_resumida or curso.objetivos_especificos %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye me-2"></i>
                        Descrição e Objetivos
                    </h5>
                </div>
                <div class="card-body">
                    {% if curso.descricao_resumida %}
                    <div class="mb-3">
                        <h6>Descrição Resumida:</h6>
                        <p>{{ curso.descricao_resumida|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if curso.finalidade %}
                    <div class="mb-3">
                        <h6>Objetivo Geral / Finalidade:</h6>
                        <p>{{ curso.finalidade|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if curso.objetivos_especificos %}
                    <div class="mb-3">
                        <h6>Objetivos Específicos:</h6>
                        <p>{{ curso.objetivos_especificos|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if curso.competencias_habilidades %}
                    <div>
                        <h6>Competências e Habilidades:</h6>
                        <p>{{ curso.competencias_habilidades|linebreaks }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Disciplinas -->
    {% if disciplinas_curso %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ul me-2"></i>
                        Disciplinas do Curso
                        <span class="badge bg-light text-dark ms-2">{{ disciplinas_curso.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if is_apk or request.GET.apk %}
                    <div class="d-grid gap-3">
                        {% for disc_curso in disciplinas_curso %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="fw-bold">{{ disc_curso.disciplina.nome }}</div>
                                <div class="text-muted">Ordem {{ disc_curso.ordem }}</div>
                                <div class="mt-1">
                                    <span class="badge bg-info">{{ disc_curso.get_tipo_display }}</span>
                                    <span class="badge bg-secondary">{{ disc_curso.carga_horaria_curso|default:disc_curso.disciplina.carga_horaria }}h</span>
                                </div>
                                <div class="d-grid gap-2 mt-2">
                                    <a href="{% url 'militares:ensino_disciplina_detalhes' pk=disc_curso.disciplina.pk %}?apk=1" class="btn btn-outline-info">
                                        <i class="fas fa-eye me-1"></i>Ver Disciplina
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Ordem</th>
                                    <th>Disciplina</th>
                                    <th>Tipo</th>
                                    <th>Carga Horária</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for disc_curso in disciplinas_curso %}
                                <tr>
                                    <td>{{ disc_curso.ordem }}</td>
                                    <td>
                                        <a href="{% url 'militares:ensino_disciplina_detalhes' pk=disc_curso.disciplina.pk %}" class="text-decoration-none">
                                            {{ disc_curso.disciplina.nome }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ disc_curso.get_tipo_display }}</span>
                                    </td>
                                    <td>
                                        {% if disc_curso.carga_horaria_curso %}
                                            {{ disc_curso.carga_horaria_curso }}h
                                        {% else %}
                                            {{ disc_curso.disciplina.carga_horaria|default:"-" }}h
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Edições do Curso -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Edições do Curso
                            <span class="badge bg-light text-dark ms-2">{{ edicoes|length }}</span>
                        </h5>
                        {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                        <a href="{% url 'militares:ensino_edicao_criar' %}?curso={{ curso.pk }}" class="btn btn-sm btn-light">
                            <i class="fas fa-plus me-2"></i>
                            Nova Edição
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if edicoes %}
                    <div class="accordion" id="accordionEdicoes">
                        {% for edicao in edicoes %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ edicao.pk }}">
                                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ edicao.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse-{{ edicao.pk }}">
                                    <div class="w-100 d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ edicao.nome }}</strong>
                                            <span class="ms-2 badge {% if edicao.ativa %}bg-success{% else %}bg-secondary{% endif %}">{{ edicao.get_total_turmas }} turma(s)</span>
                                        </div>
                                        <div class="text-muted">
                                            {{ edicao.data_inicio|date:'d/m/Y' }}{% if edicao.data_fim %} - {{ edicao.data_fim|date:'d/m/Y' }}{% endif %}
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse-{{ edicao.pk }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading-{{ edicao.pk }}" data-bs-parent="#accordionEdicoes">
                                <div class="accordion-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="small text-muted">Ano {{ edicao.ano }} • Nº {{ edicao.numero_edicao }}</div>
                                        <div>
                                            <a href="{% url 'militares:ensino_edicao_detalhes' pk=edicao.pk %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'militares:ensino_edicao_resultado_final' pk=edicao.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-trophy"></i>
                                            </a>
                                            {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                                            <a href="{% url 'militares:ensino_turma_criar' %}?curso_id={{ curso.id }}&edicao_id={{ edicao.id }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-plus me-1"></i>Nova Turma
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if edicao.turmas.all %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Identificação</th>
                                                    <th>Período</th>
                                                    <th>Alunos</th>
                                                    <th>Status</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for turma in edicao.turmas.all %}
                                                <tr>
                                                    <td>{{ turma.identificacao }}</td>
                                                    <td>{{ turma.data_inicio|date:'d/m/Y' }}{% if turma.data_fim %} - {{ turma.data_fim|date:'d/m/Y' }}{% endif %}</td>
                                                    <td><span class="badge bg-light text-dark">{{ turma.total_alunos|default:0 }}</span></td>
                                                    <td>
                                                        {% if turma.ativa %}
                                                            <span class="badge bg-success">Ativa</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">Inativa</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                        <p class="text-muted mb-0">Nenhuma turma cadastrada nesta edição.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhuma edição cadastrada para este curso.
                        {% if menu_permissions.ENSINO_CRIAR or user.is_superuser %}
                        <a href="{% url 'militares:ensino_edicao_criar' %}?curso={{ curso.pk }}" class="btn btn-sm btn-info ms-2">
                            <i class="fas fa-plus me-2"></i>
                            Criar Primeira Edição
                        </a>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Turmas -->
    {% if turmas %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Turmas
                        <span class="badge bg-light text-dark ms-2">{{ turmas.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if is_apk or request.GET.apk %}
                    <div class="d-grid gap-3">
                        {% for turma in turmas %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="fw-bold">{{ turma.identificacao }}</div>
                                <div class="text-muted">{{ turma.data_inicio|date:"d/m/Y"|default:"-" }}{% if turma.data_fim %} - {{ turma.data_fim|date:"d/m/Y" }}{% endif %}</div>
                                <div class="mt-1">
                                    {% if turma.ativa %}
                                        <span class="badge bg-success">Ativa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inativa</span>
                                    {% endif %}
                                </div>
                                <div class="d-grid gap-2 mt-2">
                                    <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}?apk=1" class="btn btn-outline-info">
                                        <i class="fas fa-eye me-1"></i>Detalhes
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Identificação</th>
                                    <th>Data Início</th>
                                    <th>Data Fim</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for turma in turmas %}
                                <tr>
                                    <td>{{ turma.identificacao }}</td>
                                    <td>{{ turma.data_inicio|date:"d/m/Y"|default:"-" }}</td>
                                    <td>{{ turma.data_fim|date:"d/m/Y"|default:"-" }}</td>
                                    <td>
                                        {% if turma.ativa %}
                                            <span class="badge bg-success">Ativa</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inativa</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'militares:ensino_turma_detalhes' pk=turma.pk %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Documentos -->
    {% if curso.documentos.all %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Documentos
                        <span class="badge bg-light text-dark ms-2">{{ curso.documentos.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Título</th>
                                    <th>Data Upload</th>
                                    <th>Upload por</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in curso.documentos.all %}
                                <tr>
                                    <td>{{ doc.get_tipo_display }}</td>
                                    <td>{{ doc.titulo }}</td>
                                    <td>{{ doc.data_upload|date:"d/m/Y H:i" }}</td>
                                    <td>{{ doc.upload_por.get_full_name|default:doc.upload_por.username }}</td>
                                    <td>
                                        <a href="{{ doc.arquivo.url }}" target="_blank" class="btn btn-sm btn-info">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Arquivos Legados -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-pdf me-2"></i>
                        Arquivos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if curso.ementa %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Ementa</h6>
                                    <a href="{{ curso.ementa.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if curso.plano_curso %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Plano de Curso</h6>
                                    <a href="{{ curso.plano_curso.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if curso.plano_pedagogico %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Plano Pedagógico</h6>
                                    <a href="{{ curso.plano_pedagogico.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if curso.matriz_curricular %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Matriz Curricular</h6>
                                    <a href="{{ curso.matriz_curricular.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

