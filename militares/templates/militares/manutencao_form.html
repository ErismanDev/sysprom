{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Manutenção{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-wrench me-2 text-primary"></i>
                        {% if object %}Editar Manutenção{% else %}Nova Manutenção{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if object %}Editando manutenção da viatura {{ object.viatura.placa }}{% else %}Registrar nova manutenção{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'militares:manutencao_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Informações da Manutenção
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" id="manutencaoForm">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.viatura.id_for_label }}" class="form-label">
                                            Viatura <span class="text-danger">*</span>
                                        </label>
                                        {{ form.viatura }}
                                        {% if form.viatura.errors %}
                                            <div class="invalid-feedback d-block">{{ form.viatura.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.data_manutencao.id_for_label }}" class="form-label">
                                            Data e Hora da Manutenção <span class="text-danger">*</span>
                                        </label>
                                        <input type="datetime-local" 
                                               name="data_manutencao" 
                                               id="id_data_manutencao" 
                                               class="form-control"
                                               value="{% if object and object.data_manutencao %}{{ object.data_manutencao|date:'Y-m-d\TH:i' }}{% endif %}"
                                               required>
                                        {% if form.data_manutencao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.data_manutencao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.tipo_manutencao.id_for_label }}" class="form-label">
                                            Tipo de Manutenção <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tipo_manutencao }}
                                        {% if form.tipo_manutencao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.tipo_manutencao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.km_manutencao.id_for_label }}" class="form-label">
                                            KM na Manutenção <span class="text-danger">*</span>
                                        </label>
                                        {{ form.km_manutencao }}
                                        {% if form.km_manutencao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.km_manutencao.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.valor_manutencao.id_for_label }}" class="form-label">
                                            Valor da Manutenção (R$) <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" 
                                                   name="valor_manutencao" 
                                                   id="id_valor_manutencao" 
                                                   class="form-control" 
                                                   value="{% if object and object.valor_manutencao %}{{ object.valor_manutencao|floatformat:2 }}{% endif %}"
                                                   placeholder="0,00"
                                                   autocomplete="off"
                                                   required>
                                        </div>
                                        {% if form.valor_manutencao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.valor_manutencao.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Digite o valor - formatação automática em R$</small>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.fornecedor_oficina.id_for_label }}" class="form-label">
                                            Oficina
                                        </label>
                                        {{ form.fornecedor_oficina }}
                                        {% if form.fornecedor_oficina.errors %}
                                            <div class="invalid-feedback d-block">{{ form.fornecedor_oficina.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.responsavel.id_for_label }}" class="form-label">
                                            Responsável pela Manutenção
                                        </label>
                                        {{ form.responsavel }}
                                        {% if form.responsavel.errors %}
                                            <div class="invalid-feedback d-block">{{ form.responsavel.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.descricao_servico.id_for_label }}" class="form-label">
                                            Descrição do Serviço <span class="text-danger">*</span>
                                        </label>
                                        {{ form.descricao_servico }}
                                        {% if form.descricao_servico.errors %}
                                            <div class="invalid-feedback d-block">{{ form.descricao_servico.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.pecas_trocadas.id_for_label }}" class="form-label">
                                            Peças Trocadas
                                        </label>
                                        {{ form.pecas_trocadas }}
                                        {% if form.pecas_trocadas.errors %}
                                            <div class="invalid-feedback d-block">{{ form.pecas_trocadas.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3" id="proximo_km_revisao_field" style="display: none;">
                                        <label for="{{ form.proximo_km_revisao.id_for_label }}" class="form-label">
                                            KM para Próxima Revisão
                                        </label>
                                        {{ form.proximo_km_revisao }}
                                        {% if form.proximo_km_revisao.errors %}
                                            <div class="invalid-feedback d-block">{{ form.proximo_km_revisao.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">Informe o KM previsto para a próxima revisão desta viatura</small>
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                            Observações
                                        </label>
                                        {{ form.observacoes }}
                                        {% if form.observacoes.errors %}
                                            <div class="invalid-feedback d-block">{{ form.observacoes.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <div class="form-check">
                                            {{ form.ativo }}
                                            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                                Ativo
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <a href="{% url 'militares:manutencao_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar número como moeda BRL
    function formatarMoedaBRL(valor) {
        if (!valor || valor === '') return '';
        let numeroString = valor.toString().trim().replace(/[^\d,]/g, '');
        if (numeroString.includes(',')) {
            let partes = numeroString.split(',');
            let parteInteira = partes[0].replace(/\./g, '').replace(/[^\d]/g, '') || '0';
            let parteDecimal = partes[1] ? partes[1].replace(/[^\d]/g, '').substring(0, 2) : '';
            while (parteDecimal.length < 2 && parteDecimal.length > 0) {
                parteDecimal += '0';
            }
            if (parteDecimal === '') {
                parteDecimal = '00';
            }
            parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return parteInteira + ',' + parteDecimal;
        } else {
            let numeroLimpo = numeroString.replace(/[^\d]/g, '');
            if (numeroLimpo === '') return '';
            numeroLimpo = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return numeroLimpo + ',00';
        }
    }
    
    function obterValorNumerico(valor) {
        if (!valor || valor === '') return '';
        return valor.toString().replace(/\./g, '').replace(',', '.').replace(/[^\d.]/g, '');
    }
    
    const valorManutencaoInput = document.getElementById('id_valor_manutencao');
    if (valorManutencaoInput) {
        {% if object and object.valor_manutencao %}
        const valorInicial = parseFloat('{{ object.valor_manutencao }}');
        if (!isNaN(valorInicial) && valorInicial > 0) {
            valorManutencaoInput.value = formatarMoedaBRL(valorInicial.toString());
        }
        {% endif %}
        
        valorManutencaoInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^\d,]/g, '');
            let partes = valor.split(',');
            if (partes.length > 2) {
                valor = partes[0] + ',' + partes.slice(1).join('');
            }
            if (partes.length === 2 && partes[1].length > 2) {
                valor = partes[0] + ',' + partes[1].substring(0, 2);
            }
            e.target.value = valor;
        });
        
        valorManutencaoInput.addEventListener('blur', function(e) {
            let valor = e.target.value.trim();
            if (!valor || valor === '') {
                e.target.value = '';
                return;
            }
            e.target.value = formatarMoedaBRL(valor);
        });
    }
    
    const form = document.getElementById('manutencaoForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (valorManutencaoInput && valorManutencaoInput.value) {
                valorManutencaoInput.value = obterValorNumerico(valorManutencaoInput.value);
            }
        });
    }
    
    {% if object and object.data_manutencao %}
    const dataManutencaoInput = document.getElementById('id_data_manutencao');
    if (dataManutencaoInput) {
        const dataObj = '{{ object.data_manutencao|date:"Y-m-d\TH:i" }}';
        if (dataObj && dataObj !== '' && dataObj !== 'None') {
            dataManutencaoInput.value = dataObj;
        }
    }
    {% endif %}
    
    // Mostrar/ocultar campo de próximo KM revisão baseado no tipo de manutenção
    const tipoManutencaoSelect = document.getElementById('id_tipo_manutencao');
    const proximoKmRevisaoField = document.getElementById('proximo_km_revisao_field');
    const proximoKmRevisaoInput = document.getElementById('id_proximo_km_revisao');
    
    function toggleProximoKmRevisao() {
        if (tipoManutencaoSelect && proximoKmRevisaoField) {
            if (tipoManutencaoSelect.value === 'REVISAO') {
                proximoKmRevisaoField.style.display = 'block';
                if (proximoKmRevisaoInput) {
                    proximoKmRevisaoInput.required = false; // Opcional mas visível
                }
            } else {
                proximoKmRevisaoField.style.display = 'none';
                if (proximoKmRevisaoInput) {
                    proximoKmRevisaoInput.value = '';
                    proximoKmRevisaoInput.required = false;
                }
            }
        }
    }
    
    if (tipoManutencaoSelect) {
        // Verificar valor inicial
        toggleProximoKmRevisao();
        
        // Adicionar listener para mudanças
        tipoManutencaoSelect.addEventListener('change', toggleProximoKmRevisao);
    }
    
    // Inicializar Select2 para o campo de responsável (militar)
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
        $('.militar-select2').select2({
            placeholder: 'Digite o nome, matrícula ou posto do militar...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "militares:militar-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function () {
                    return 'Digite pelo menos 2 caracteres...';
                },
                noResults: function () {
                    return 'Nenhum militar encontrado';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
        
        // Se há um responsável já selecionado (na edição), carregar os dados
        {% if object and object.responsavel %}
        const responsavelId = {{ object.responsavel.id }};
        const responsavelText = "{{ object.responsavel.get_posto_graduacao_display }} {{ object.responsavel.nome_completo }} - Mat: {{ object.responsavel.matricula }}";
        if (responsavelId) {
            const option = new Option(responsavelText, responsavelId, true, true);
            $('.militar-select2').append(option).trigger('change');
        }
        {% endif %}
    }
});
</script>
{% endblock %}

