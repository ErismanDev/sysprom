{% extends 'base.html' %}
{% load static %}

{% block title %}Estatísticas dos Logs - SysProm{% endblock %}

{% block extra_css %}
<style>
    .stats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .metric-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .metric-card.info { border-left-color: #17a2b8; }
    .metric-card.warning { border-left-color: #ffc107; }
    .metric-card.error { border-left-color: #dc3545; }
    .metric-card.critical { border-left-color: #721c24; }
    .metric-card.success { border-left-color: #28a745; }
    
    .trend-indicator {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .trend-up { background: #d4edda; color: #155724; }
    .trend-down { background: #f8d7da; color: #721c24; }
    .trend-stable { background: #e2e3e5; color: #383d41; }
    
    .activity-timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .timeline-item {
        padding: 10px 0;
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 15px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6c757d;
    }
    
    .timeline-item.info::before { background: #17a2b8; }
    .timeline-item.warning::before { background: #ffc107; }
    .timeline-item.error::before { background: #dc3545; }
    .timeline-item.critical::before { background: #721c24; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="stats-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">
                    <i class="fas fa-chart-bar"></i>
                    Estatísticas dos Logs
                </h1>
                <p class="mb-0">Análise detalhada das atividades e performance do sistema</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{% url 'militares:logs_sistema_list' %}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Voltar aos Logs
                </a>
            </div>
        </div>
    </div>

    <!-- Métricas Principais -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                                Total de Logs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-white">{{ total_logs }}</div>
                            <div class="text-xs text-white-50">
                                {% if crescimento_total > 0 %}
                                    <i class="fas fa-arrow-up"></i> +{{ crescimento_total }}% vs período anterior
                                {% elif crescimento_total < 0 %}
                                    <i class="fas fa-arrow-down"></i> {{ crescimento_total }}% vs período anterior
                                {% else %}
                                    <i class="fas fa-minus"></i> Sem alteração
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Erros (24h)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ erros_24h }}</div>
                            <div class="text-xs text-muted">
                                {% if erros_24h > 0 %}
                                    <span class="trend-indicator trend-up">
                                        <i class="fas fa-exclamation-triangle"></i> Requer atenção
                                    </span>
                                {% else %}
                                    <span class="trend-indicator trend-stable">
                                        <i class="fas fa-check"></i> Sistema estável
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Taxa de Processamento
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ taxa_processamento }}%</div>
                            <div class="text-xs text-muted">
                                {{ processados }} de {{ total_logs }} logs processados
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tempo Médio Execução
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ tempo_medio_execucao }}s</div>
                            <div class="text-xs text-muted">
                                {% if tempo_medio_execucao < 1 %}
                                    <span class="trend-indicator trend-up">Excelente performance</span>
                                {% elif tempo_medio_execucao < 3 %}
                                    <span class="trend-indicator trend-stable">Performance adequada</span>
                                {% else %}
                                    <span class="trend-indicator trend-down">Performance lenta</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gráficos -->
        <div class="col-lg-8">
            <!-- Distribuição por Nível -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Distribuição por Nível
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="nivelChart"></canvas>
                    </div>
                    <div class="row mt-3">
                        {% for nivel, dados in distribuicao_nivel.items %}
                        <div class="col-md-3 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="badge bg-{{ dados.cor }} me-2" style="width: 20px; height: 20px;"></div>
                                <div>
                                    <small class="text-muted">{{ dados.nome }}</small>
                                    <br>
                                    <strong>{{ dados.quantidade }}</strong> ({{ dados.percentual }}%)
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Atividade por Módulo -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Atividade por Módulo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="moduloChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tendência Temporal -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Tendência Temporal (Últimos 30 dias)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="tendenciaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar com Métricas Detalhadas -->
        <div class="col-lg-4">
            <!-- Top Usuários -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Top Usuários
                    </h5>
                </div>
                <div class="card-body">
                    {% for usuario in top_usuarios %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>{{ usuario.nome }}</strong>
                            <br>
                            <small class="text-muted">{{ usuario.username }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary">{{ usuario.total_logs }}</span>
                            <br>
                            <small class="text-muted">{{ usuario.ultima_atividade|date:"d/m H:i" }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted small">Nenhum usuário encontrado.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top IPs -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-network-wired"></i> Top IPs
                    </h5>
                </div>
                <div class="card-body">
                    {% for ip in top_ips %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <code>{{ ip.endereco }}</code>
                            <br>
                            <small class="text-muted">{{ ip.pais|default:"Local" }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">{{ ip.total_logs }}</span>
                            <br>
                            <small class="text-muted">{{ ip.ultima_atividade|date:"d/m H:i" }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted small">Nenhum IP encontrado.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Erros Mais Frequentes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Erros Mais Frequentes
                    </h5>
                </div>
                <div class="card-body">
                    {% for erro in erros_frequentes %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-danger">{{ erro.descricao|truncatechars:50 }}</small>
                            <span class="badge bg-danger">{{ erro.quantidade }}</span>
                        </div>
                        <small class="text-muted">{{ erro.ultima_ocorrencia|date:"d/m H:i" }}</small>
                    </div>
                    {% empty %}
                    <p class="text-muted small">Nenhum erro frequente encontrado.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Performance -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tachometer-alt"></i> Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Tempo de Execução</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: {{ percentual_rapido }}%">
                                < 1s ({{ percentual_rapido }}%)
                            </div>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-warning" style="width: {{ percentual_medio }}%">
                                1-3s ({{ percentual_medio }}%)
                            </div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-danger" style="width: {{ percentual_lento }}%">
                                > 3s ({{ percentual_lento }}%)
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h5 text-success">{{ logs_rapidos }}</div>
                            <small class="text-muted">Rápidos</small>
                        </div>
                        <div class="col-6">
                            <div class="h5 text-danger">{{ logs_lentos }}</div>
                            <small class="text-muted">Lentos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Atividade Recente -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock"></i> Atividade Recente (Últimas 24h)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for log in atividade_recente %}
                        <div class="timeline-item {{ log.nivel|lower }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge bg-{{ log.get_nivel_color }} me-2">{{ log.get_nivel_display }}</span>
                                        <span class="badge bg-secondary me-2">{{ log.get_modulo_display }}</span>
                                        <small class="text-muted">{{ log.timestamp|date:"H:i:s" }}</small>
                                    </div>
                                    <p class="mb-1">{{ log.descricao }}</p>
                                    <small class="text-muted">
                                        {% if log.usuario %}
                                            {{ log.usuario.get_full_name|default:log.usuario.username }}
                                        {% else %}
                                            Sistema
                                        {% endif %}
                                        {% if log.ip_address %}
                                            • {{ log.ip_address }}
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="ms-3">
                                    <a href="{% url 'militares:logs_sistema_detail' log.pk %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-4">Nenhuma atividade recente encontrada.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Configuração dos gráficos
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.font.size = 12;
    
    // Gráfico de Pizza - Distribuição por Nível
    const nivelCtx = document.getElementById('nivelChart').getContext('2d');
    new Chart(nivelCtx, {
        type: 'doughnut',
        data: {
            labels: {{ labels_nivel|safe }},
            datasets: [{
                data: {{ data_nivel|safe }},
                backgroundColor: {{ cores_nivel|safe }},
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Gráfico de Barras - Atividade por Módulo
    const moduloCtx = document.getElementById('moduloChart').getContext('2d');
    new Chart(moduloCtx, {
        type: 'bar',
        data: {
            labels: {{ labels_modulo|safe }},
            datasets: [{
                label: 'Logs',
                data: {{ data_modulo|safe }},
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Gráfico de Linha - Tendência Temporal
    const tendenciaCtx = document.getElementById('tendenciaChart').getContext('2d');
    new Chart(tendenciaCtx, {
        type: 'line',
        data: {
            labels: {{ labels_tendencia|safe }},
            datasets: [{
                label: 'Total',
                data: {{ data_tendencia_total|safe }},
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true
            }, {
                label: 'Erros',
                data: {{ data_tendencia_erros|safe }},
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
    
    // Auto-refresh das estatísticas a cada 5 minutos
    setTimeout(function() {
        location.reload();
    }, 300000); // 5 minutos
</script>
{% endblock %} 